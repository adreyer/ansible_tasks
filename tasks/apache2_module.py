#!/usr/bin/python
# -*- coding: utf-8 -*-
ANSIBALLZ_WRAPPER = True # For test-module script to tell this is a ANSIBALLZ_WRAPPER
import os
import os.path
import sys
import __main__
scriptdir = None
try:
    scriptdir = os.path.dirname(os.path.abspath(__main__.__file__))
except (AttributeError, OSError):
    pass
if scriptdir is not None:
    sys.path = [p for p in sys.path if p != scriptdir]
import base64
import json
import shutil
import zipfile
import tempfile
import subprocess
if sys.version_info < (3,):
    bytes = str
    PY3 = False
else:
    unicode = str
    PY3 = True
try:
    from io import BytesIO as IOStream
except ImportError:
    from StringIO import StringIO as IOStream
ZIPDATA = """UEsDBBQAAAAAAPO7K0uPp/FSdwAAAHcAAAATAAAAYW5zaWJsZS9fX2luaXRfXy5weWZyb20gcGtndXRpbCBpbXBvcnQgZXh0ZW5kX3BhdGgKX19wYXRoX189ZXh0ZW5kX3BhdGgoX19wYXRoX18sX19uYW1lX18pCl9fdmVyc2lvbl9fPSIyLjQuMCIKX19hdXRob3JfXz0iQW5zaWJsZSwgSW5jLiIKUEsDBBQAAAAAAPO7K0udxfFrSAAAAEgAAAAgAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX19pbml0X18ucHlmcm9tIHBrZ3V0aWwgaW1wb3J0IGV4dGVuZF9wYXRoCl9fcGF0aF9fPWV4dGVuZF9wYXRoKF9fcGF0aF9fLF9fbmFtZV9fKQpQSwMEFAAAAAAA87srSzQXIAhqHQAAah0AACAAAABhbnNpYmxlX21vZHVsZV9hcGFjaGUyX21vZHVsZS5weSMhL3Vzci9iaW4vcHl0aG9uCiMgY29kaW5nOiB1dGYtOCAtKi0KCiMgKGMpIDIwMTMtMjAxNCwgQ2hyaXN0aWFuIEJlcmVuZHQgPGJlcmVuZHRAYjEtc3lzdGVtcy5kZT4KIwojIFRoaXMgbW9kdWxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIFRoaXMgc29mdHdhcmUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIHRoaXMgc29mdHdhcmUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpBTlNJQkxFX01FVEFEQVRBID0geydtZXRhZGF0YV92ZXJzaW9uJzogJzEuMCcsCiAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cyc6IFsncHJldmlldyddLAogICAgICAgICAgICAgICAgICAgICdzdXBwb3J0ZWRfYnknOiAnY29tbXVuaXR5J30KCgpET0NVTUVOVEFUSU9OID0gJycnCi0tLQptb2R1bGU6IGFwYWNoZTJfbW9kdWxlCnZlcnNpb25fYWRkZWQ6IDEuNgphdXRob3I6CiAgICAtIENocmlzdGlhbiBCZXJlbmR0IChAYmVyZW5kdCkKICAgIC0gUmFsZiBIZXJ0ZWwgKEBuMHRyYXgpCiAgICAtIFJvYmluIFJvdGggKEByb2JpbnJvKQpzaG9ydF9kZXNjcmlwdGlvbjogZW5hYmxlcy9kaXNhYmxlcyBhIG1vZHVsZSBvZiB0aGUgQXBhY2hlMiB3ZWJzZXJ2ZXIKZGVzY3JpcHRpb246CiAgIC0gRW5hYmxlcyBvciBkaXNhYmxlcyBhIHNwZWNpZmllZCBtb2R1bGUgb2YgdGhlIEFwYWNoZTIgd2Vic2VydmVyLgpvcHRpb25zOgogICBuYW1lOgogICAgIGRlc2NyaXB0aW9uOgogICAgICAgIC0gbmFtZSBvZiB0aGUgbW9kdWxlIHRvIGVuYWJsZS9kaXNhYmxlCiAgICAgcmVxdWlyZWQ6IHRydWUKICAgZm9yY2U6CiAgICAgZGVzY3JpcHRpb246CiAgICAgICAgLSBmb3JjZSBkaXNhYmxpbmcgb2YgZGVmYXVsdCBtb2R1bGVzIGFuZCBvdmVycmlkZSBEZWJpYW4gd2FybmluZ3MKICAgICByZXF1aXJlZDogZmFsc2UKICAgICBjaG9pY2VzOiBbJ1RydWUnLCAnRmFsc2UnXQogICAgIGRlZmF1bHQ6IEZhbHNlCiAgICAgdmVyc2lvbl9hZGRlZDogIjIuMSIKICAgc3RhdGU6CiAgICAgZGVzY3JpcHRpb246CiAgICAgICAgLSBpbmRpY2F0ZSB0aGUgZGVzaXJlZCBzdGF0ZSBvZiB0aGUgcmVzb3VyY2UKICAgICBjaG9pY2VzOiBbJ3ByZXNlbnQnLCAnYWJzZW50J10KICAgICBkZWZhdWx0OiBwcmVzZW50CiAgIGlnbm9yZV9jb25maWdjaGVjazoKICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAtIElnbm9yZSBjb25maWd1cmF0aW9uIGNoZWNrcyBhYm91dCBpbmNvbnNpc3RlbnQgbW9kdWxlIGNvbmZpZ3VyYXRpb24uIEVzcGVjaWFsbHkgZm9yIG1wbV8qIG1vZHVsZXMuCiAgICAgY2hvaWNlczogWydUcnVlJywgJ0ZhbHNlJ10KICAgICBkZWZhdWx0OiBGYWxzZQogICAgIHZlcnNpb25fYWRkZWQ6ICIyLjMiCnJlcXVpcmVtZW50czogWyJhMmVubW9kIiwiYTJkaXNtb2QiXQonJycKCkVYQU1QTEVTID0gJycnCiMgZW5hYmxlcyB0aGUgQXBhY2hlMiBtb2R1bGUgIndzZ2kiCi0gYXBhY2hlMl9tb2R1bGU6CiAgICBzdGF0ZTogcHJlc2VudAogICAgbmFtZTogd3NnaQojIGRpc2FibGVzIHRoZSBBcGFjaGUyIG1vZHVsZSAid3NnaSIKLSBhcGFjaGUyX21vZHVsZToKICAgIHN0YXRlOiBhYnNlbnQKICAgIG5hbWU6IHdzZ2kKIyBkaXNhYmxlIGRlZmF1bHQgbW9kdWxlcyBmb3IgRGViaWFuCi0gYXBhY2hlMl9tb2R1bGU6CiAgICBzdGF0ZTogYWJzZW50CiAgICBuYW1lOiBhdXRvaW5kZXgKICAgIGZvcmNlOiBUcnVlCiMgZGlzYWJsZSBtcG1fd29ya2VyIGFuZCBpZ25vcmUgd2FybmluZ3MgYWJvdXQgbWlzc2luZyBtcG0gbW9kdWxlCi0gYXBhY2hlMl9tb2R1bGU6CiAgICBzdGF0ZTogYWJzZW50CiAgICBuYW1lOiBtcG1fd29ya2VyCiAgICBpZ25vcmVfY29uZmlnY2hlY2s6IFRydWUKJycnCgpSRVRVUk4gPSAnJycKcmVzdWx0OgogICAgZGVzY3JpcHRpb246IG1lc3NhZ2UgYWJvdXQgYWN0aW9uIHRha2VuCiAgICByZXR1cm5lZDogYWx3YXlzCiAgICB0eXBlOiBzdHJpbmcKd2FybmluZ3M6CiAgICBkZXNjcmlwdGlvbjogbGlzdCBvZiB3YXJuaW5nIG1lc3NhZ2VzCiAgICByZXR1cm5lZDogd2hlbiBuZWVkZWQKICAgIHR5cGU6IGxpc3QKcmM6CiAgICBkZXNjcmlwdGlvbjogcmV0dXJuIGNvZGUgb2YgdW5kZXJseWluZyBjb21tYW5kCiAgICByZXR1cm5lZDogZmFpbGVkCiAgICB0eXBlOiBpbnQKc3Rkb3V0OgogICAgZGVzY3JpcHRpb246IHN0ZG91dCBvZiB1bmRlcmx5aW5nIGNvbW1hbmQKICAgIHJldHVybmVkOiBmYWlsZWQKICAgIHR5cGU6IHN0cmluZwpzdGRlcnI6CiAgICBkZXNjcmlwdGlvbjogc3RkZXJyIG9mIHVuZGVybHlpbmcgY29tbWFuZAogICAgcmV0dXJuZWQ6IGZhaWxlZAogICAgdHlwZTogc3RyaW5nCicnJwoKaW1wb3J0IHJlCgoKZGVmIF9ydW5fdGhyZWFkZWQobW9kdWxlKToKICAgIGNvbnRyb2xfYmluYXJ5ID0gX2dldF9jdGxfYmluYXJ5KG1vZHVsZSkKCiAgICByZXN1bHQsIHN0ZG91dCwgc3RkZXJyID0gbW9kdWxlLnJ1bl9jb21tYW5kKCIlcyAtViIgJSBjb250cm9sX2JpbmFyeSkKCiAgICByZXR1cm4gYm9vbChyZS5zZWFyY2gocid0aHJlYWRlZDpbIF0qeWVzJywgc3Rkb3V0KSkKCgpkZWYgX2dldF9jdGxfYmluYXJ5KG1vZHVsZSk6CiAgICBmb3IgY29tbWFuZCBpbiBbJ2FwYWNoZTJjdGwnLCAnYXBhY2hlY3RsJ106CiAgICAgICAgY3RsX2JpbmFyeSA9IG1vZHVsZS5nZXRfYmluX3BhdGgoY29tbWFuZCkKICAgICAgICBpZiBjdGxfYmluYXJ5IGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXR1cm4gY3RsX2JpbmFyeQoKICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgbXNnPSJOZWl0aGVyIG9mIGFwYWNoZTJjdGwgbm9yIGFwYWNoY3RsIGZvdW5kLiIKICAgICAgICAgICAgIiBBdCBsZWFzdCBvbmUgYXBhY2hlIGNvbnRyb2wgYmluYXJ5IGlzIG5lY2Vzc2FyeS4iCiAgICApCgoKZGVmIF9tb2R1bGVfaXNfZW5hYmxlZChtb2R1bGUpOgogICAgY29udHJvbF9iaW5hcnkgPSBfZ2V0X2N0bF9iaW5hcnkobW9kdWxlKQogICAgbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ25hbWUnXQogICAgaWdub3JlX2NvbmZpZ2NoZWNrID0gbW9kdWxlLnBhcmFtc1snaWdub3JlX2NvbmZpZ2NoZWNrJ10KCiAgICByZXN1bHQsIHN0ZG91dCwgc3RkZXJyID0gbW9kdWxlLnJ1bl9jb21tYW5kKCIlcyAtTSIgJSBjb250cm9sX2JpbmFyeSkKCiAgICBpZiByZXN1bHQgIT0gMDoKICAgICAgICBlcnJvcl9tc2cgPSAiRXJyb3IgZXhlY3V0aW5nICVzOiAlcyIgJSAoY29udHJvbF9iaW5hcnksIHN0ZGVycikKICAgICAgICBpZiBpZ25vcmVfY29uZmlnY2hlY2s6CiAgICAgICAgICAgIGlmICdBSDAwNTM0JyBpbiBzdGRlcnIgYW5kICdtcG1fJyBpbiBuYW1lOgogICAgICAgICAgICAgICAgbW9kdWxlLndhcm5pbmdzLmFwcGVuZCgKICAgICAgICAgICAgICAgICAgICAiTm8gTVBNIG1vZHVsZSBsb2FkZWQhIGFwYWNoZTIgcmVsb2FkIEFORCBvdGhlciBtb2R1bGUgYWN0aW9ucyIKICAgICAgICAgICAgICAgICAgICAiIHdpbGwgZmFpbCBpZiBubyBNUE0gbW9kdWxlIGlzIGxvYWRlZCBpbW1lZGlhdGVseS4iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBtb2R1bGUud2FybmluZ3MuYXBwZW5kKGVycm9yX21zZykKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9ZXJyb3JfbXNnKQoKICAgIHNlYXJjaHN0cmluZyA9ICcgJyArIGNyZWF0ZV9hcGFjaGVfaWRlbnRpZmllcihuYW1lKQogICAgcmV0dXJuIHNlYXJjaHN0cmluZyBpbiBzdGRvdXQKCgpkZWYgY3JlYXRlX2FwYWNoZV9pZGVudGlmaWVyKG5hbWUpOgogICAgIiIiCiAgICBCeSBjb252ZW50aW9uIGlmIGEgbW9kdWxlIGlzIGxvYWRlZCB2aWEgbmFtZSwgaXQgYXBwZWFycyBpbiBhcGFjaGUyY3RsIC1NIGFzCiAgICBuYW1lX21vZHVsZS4KCiAgICBTb21lIG1vZHVsZXMgZG9uJ3QgZm9sbG93IHRoaXMgY29udmVudGlvbiBhbmQgd2UgdXNlIHJlcGxhY2VtZW50cyBmb3IgdGhvc2UuIiIiCgogICAgIyBhMmVubW9kIG5hbWUgcmVwbGFjZW1lbnQgdG8gYXBhY2hlMmN0bCAtTSBuYW1lcwogICAgdGV4dF93b3JrYXJvdW5kcyA9IFsKICAgICAgICAoJ3NoaWIyJywgJ21vZF9zaGliJyksCiAgICAgICAgKCdldmFzaXZlJywgJ2V2YXNpdmUyMF9tb2R1bGUnKSwKICAgIF0KCiAgICAjIHJlIGV4cHJlc3Npb25zIHRvIGV4dHJhY3Qgc3VicGFydHMgb2YgbmFtZXMKICAgIHJlX3dvcmthcm91bmRzID0gWwogICAgICAgICgncGhwJywgcideKHBocFxkKVwuJyksCiAgICBdCgogICAgZm9yIGEyZW5tb2Rfc3BlbGxpbmcsIG1vZHVsZV9uYW1lIGluIHRleHRfd29ya2Fyb3VuZHM6CiAgICAgICAgaWYgYTJlbm1vZF9zcGVsbGluZyBpbiBuYW1lOgogICAgICAgICAgICByZXR1cm4gbW9kdWxlX25hbWUKCiAgICBmb3Igc2VhcmNoLCByZWV4cHIgaW4gcmVfd29ya2Fyb3VuZHM6CiAgICAgICAgaWYgc2VhcmNoIGluIG5hbWU6CiAgICAgICAgICAgIHJlbWF0Y2ggPSByZS5zZWFyY2gocmVleHByLCBuYW1lKQogICAgICAgICAgICByZXR1cm4gcmVtYXRjaC5ncm91cCgxKSArICdfbW9kdWxlJwoKICAgIHJldHVybiBuYW1lICsgJ19tb2R1bGUnCgoKZGVmIF9zZXRfc3RhdGUobW9kdWxlLCBzdGF0ZSk6CiAgICBuYW1lID0gbW9kdWxlLnBhcmFtc1snbmFtZSddCiAgICBmb3JjZSA9IG1vZHVsZS5wYXJhbXNbJ2ZvcmNlJ10KCiAgICB3YW50X2VuYWJsZWQgPSBzdGF0ZSA9PSAncHJlc2VudCcKICAgIHN0YXRlX3N0cmluZyA9IHsncHJlc2VudCc6ICdlbmFibGVkJywgJ2Fic2VudCc6ICdkaXNhYmxlZCd9W3N0YXRlXQogICAgYTJtb2RfYmluYXJ5ID0geydwcmVzZW50JzogJ2EyZW5tb2QnLCAnYWJzZW50JzogJ2EyZGlzbW9kJ31bc3RhdGVdCiAgICBzdWNjZXNzX21zZyA9ICJNb2R1bGUgJXMgJXMiICUgKG5hbWUsIHN0YXRlX3N0cmluZykKCiAgICBpZiBfbW9kdWxlX2lzX2VuYWJsZWQobW9kdWxlKSAhPSB3YW50X2VuYWJsZWQ6CiAgICAgICAgaWYgbW9kdWxlLmNoZWNrX21vZGU6CiAgICAgICAgICAgIG1vZHVsZS5leGl0X2pzb24oY2hhbmdlZD1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdD1zdWNjZXNzX21zZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXJuaW5ncz1tb2R1bGUud2FybmluZ3MpCgogICAgICAgIGEybW9kX2JpbmFyeSA9IG1vZHVsZS5nZXRfYmluX3BhdGgoYTJtb2RfYmluYXJ5KQogICAgICAgIGlmIGEybW9kX2JpbmFyeSBpcyBOb25lOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG1zZz0iJXMgbm90IGZvdW5kLiBQZXJoYXBzIHRoaXMgc3lzdGVtIGRvZXMgbm90IHVzZSAlcyB0byBtYW5hZ2UgYXBhY2hlIiAlIChhMm1vZF9iaW5hcnksIGEybW9kX2JpbmFyeSkpCgogICAgICAgIGlmIG5vdCB3YW50X2VuYWJsZWQgYW5kIGZvcmNlOgogICAgICAgICAgICAjIGZvcmNlIGV4aXN0cyBvbmx5IGZvciBhMmRpc21vZCBvbiBkZWJpYW4KICAgICAgICAgICAgYTJtb2RfYmluYXJ5ICs9ICcgLWYnCgogICAgICAgIHJlc3VsdCwgc3Rkb3V0LCBzdGRlcnIgPSBtb2R1bGUucnVuX2NvbW1hbmQoIiVzICVzIiAlIChhMm1vZF9iaW5hcnksIG5hbWUpKQoKICAgICAgICBpZiBfbW9kdWxlX2lzX2VuYWJsZWQobW9kdWxlKSA9PSB3YW50X2VuYWJsZWQ6CiAgICAgICAgICAgIG1vZHVsZS5leGl0X2pzb24oY2hhbmdlZD1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdD1zdWNjZXNzX21zZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXJuaW5ncz1tb2R1bGUud2FybmluZ3MpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9IkZhaWxlZCB0byBzZXQgbW9kdWxlICVzIHRvICVzOiAlcyIgJSAobmFtZSwgc3RhdGVfc3RyaW5nLCBzdGRvdXQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJjPXJlc3VsdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQ9c3Rkb3V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZGVycj1zdGRlcnIpCiAgICBlbHNlOgogICAgICAgIG1vZHVsZS5leGl0X2pzb24oY2hhbmdlZD1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdD1zdWNjZXNzX21zZywKICAgICAgICAgICAgICAgICAgICAgICAgIHdhcm5pbmdzPW1vZHVsZS53YXJuaW5ncykKCgpkZWYgbWFpbigpOgogICAgbW9kdWxlID0gQW5zaWJsZU1vZHVsZSgKICAgICAgICBhcmd1bWVudF9zcGVjPWRpY3QoCiAgICAgICAgICAgIG5hbWU9ZGljdChyZXF1aXJlZD1UcnVlKSwKICAgICAgICAgICAgZm9yY2U9ZGljdChyZXF1aXJlZD1GYWxzZSwgdHlwZT0nYm9vbCcsIGRlZmF1bHQ9RmFsc2UpLAogICAgICAgICAgICBzdGF0ZT1kaWN0KGRlZmF1bHQ9J3ByZXNlbnQnLCBjaG9pY2VzPVsnYWJzZW50JywgJ3ByZXNlbnQnXSksCiAgICAgICAgICAgIGlnbm9yZV9jb25maWdjaGVjaz1kaWN0KHJlcXVpcmVkPUZhbHNlLCB0eXBlPSdib29sJywgZGVmYXVsdD1GYWxzZSksCiAgICAgICAgKSwKICAgICAgICBzdXBwb3J0c19jaGVja19tb2RlPVRydWUsCiAgICApCgogICAgbW9kdWxlLndhcm5pbmdzID0gW10KCiAgICBuYW1lID0gbW9kdWxlLnBhcmFtc1snbmFtZSddCiAgICBpZiBuYW1lID09ICdjZ2knIGFuZCBfcnVuX3RocmVhZGVkKG1vZHVsZSk6CiAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9IllvdXIgTVBNIHNlZW1zIHRvIGJlIHRocmVhZGVkLiBObyBhdXRvbWF0aWMgYWN0aW9ucyBvbiBtb2R1bGUgJXMgcG9zc2libGUuIiAlIG5hbWUpCgogICAgaWYgbW9kdWxlLnBhcmFtc1snc3RhdGUnXSBpbiBbJ3ByZXNlbnQnLCAnYWJzZW50J106CiAgICAgICAgX3NldF9zdGF0ZShtb2R1bGUsIG1vZHVsZS5wYXJhbXNbJ3N0YXRlJ10pCgojIGltcG9ydCBtb2R1bGUgc25pcHBldHMKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5iYXNpYyBpbXBvcnQgQW5zaWJsZU1vZHVsZQppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgbWFpbigpClBLAwQUAAAAAADzuytLO985lTCKAQAwigEAHQAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5IyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojIFRoaXMgcGFydGljdWxhciBmaWxlIHNuaXBwZXQsIGFuZCB0aGlzIGZpbGUgc25pcHBldCBvbmx5LCBpcyBCU0QgbGljZW5zZWQuCiMgTW9kdWxlcyB5b3Ugd3JpdGUgdXNpbmcgdGhpcyBzbmlwcGV0LCB3aGljaCBpcyBlbWJlZGRlZCBkeW5hbWljYWxseSBieSBBbnNpYmxlCiMgc3RpbGwgYmVsb25nIHRvIHRoZSBhdXRob3Igb2YgdGhlIG1vZHVsZSwgYW5kIG1heSBhc3NpZ24gdGhlaXIgb3duIGxpY2Vuc2UKIyB0byB0aGUgY29tcGxldGUgd29yay4KIwojIENvcHlyaWdodCAoYyksIE1pY2hhZWwgRGVIYWFuIDxtaWNoYWVsLmRlaGFhbkBnbWFpbC5jb20+LCAyMDEyLTIwMTMKIyBDb3B5cmlnaHQgKGMpLCBUb3NoaW8gS3VyYXRvbWkgPHRrdXJhdG9taUBhbnNpYmxlLmNvbT4gMjAxNgojIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiMKIyBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQgbW9kaWZpY2F0aW9uLAojIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKIwojICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKIyAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwKIyAgICAgIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24KIyAgICAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORAojIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVECiMgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRSBESVNDTEFJTUVELgojIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULAojIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywKIyBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MKIyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUCiMgTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFCiMgVVNFIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiMKCkJPT0xFQU5TX1RSVUUgPSBbJ3knLCAneWVzJywgJ29uJywgJzEnLCAndHJ1ZScsIDEsIFRydWVdCkJPT0xFQU5TX0ZBTFNFID0gWyduJywgJ25vJywgJ29mZicsICcwJywgJ2ZhbHNlJywgMCwgRmFsc2VdCkJPT0xFQU5TID0gQk9PTEVBTlNfVFJVRSArIEJPT0xFQU5TX0ZBTFNFCgpTSVpFX1JBTkdFUyA9IHsgJ1knOiAxPDw4MCwgJ1onOiAxPDw3MCwgJ0UnOiAxPDw2MCwgJ1AnOiAxPDw1MCwgJ1QnOiAxPDw0MCwgJ0cnOiAxPDwzMCwgJ00nOiAxPDwyMCwgJ0snOiAxPDwxMCwgJ0InOiAxIH0KCkZJTEVfQVRUUklCVVRFUyA9IHsKICAgICdBJzogJ25vYXRpbWUnLAogICAgJ2EnOiAnYXBwZW5kJywKICAgICdjJzogJ2NvbXByZXNzZWQnLAogICAgJ0MnOiAnbm9jb3cnLAogICAgJ2QnOiAnbm9kdW1wJywKICAgICdEJzogJ2RpcnN5bmMnLAogICAgJ2UnOiAnZXh0ZW50cycsCiAgICAnRSc6ICdlbmNyeXB0ZWQnLAogICAgJ2gnOiAnYmxvY2tzaXplJywKICAgICdpJzogJ2ltbXV0YWJsZScsCiAgICAnSSc6ICdpbmRleGVkJywKICAgICdqJzogJ2pvdXJuYWxsZWQnLAogICAgJ04nOiAnaW5saW5lJywKICAgICdzJzogJ3plcm8nLAogICAgJ1MnOiAnc3luY2hyb25vdXMnLAogICAgJ3QnOiAnbm90YWlsJywKICAgICdUJzogJ2Jsb2Nrcm9vdCcsCiAgICAndSc6ICd1bmRlbGV0ZScsCiAgICAnWCc6ICdjb21wcmVzc2VkcmF3JywKICAgICdaJzogJ2NvbXByZXNzZWRkaXJ0eScsCn0KCiMgYW5zaWJsZSBtb2R1bGVzIGNhbiBiZSB3cml0dGVuIGluIGFueSBsYW5ndWFnZS4gIFRvIHNpbXBsaWZ5CiMgZGV2ZWxvcG1lbnQgb2YgUHl0aG9uIG1vZHVsZXMsIHRoZSBmdW5jdGlvbnMgYXZhaWxhYmxlIGhlcmUgY2FuCiMgYmUgdXNlZCB0byBkbyBtYW55IGNvbW1vbiB0YXNrcwoKaW1wb3J0IGxvY2FsZQppbXBvcnQgb3MKaW1wb3J0IHJlCmltcG9ydCBzaGxleAppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgc3lzCmltcG9ydCB0eXBlcwppbXBvcnQgdGltZQppbXBvcnQgc2VsZWN0CmltcG9ydCBzaHV0aWwKaW1wb3J0IHN0YXQKaW1wb3J0IHRlbXBmaWxlCmltcG9ydCB0cmFjZWJhY2sKaW1wb3J0IGdycAppbXBvcnQgcHdkCmltcG9ydCBwbGF0Zm9ybQppbXBvcnQgZXJybm8KaW1wb3J0IGRhdGV0aW1lCmZyb20gaXRlcnRvb2xzIGltcG9ydCByZXBlYXQsIGNoYWluCgp0cnk6CiAgICBpbXBvcnQgc3lzbG9nCiAgICBIQVNfU1lTTE9HPVRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgSEFTX1NZU0xPRz1GYWxzZQoKdHJ5OgogICAgZnJvbSBzeXN0ZW1kIGltcG9ydCBqb3VybmFsCiAgICBoYXNfam91cm5hbCA9IFRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaGFzX2pvdXJuYWwgPSBGYWxzZQoKSEFWRV9TRUxJTlVYPUZhbHNlCnRyeToKICAgIGltcG9ydCBzZWxpbnV4CiAgICBIQVZFX1NFTElOVVg9VHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBwYXNzCgojIFB5dGhvbjIgJiAzIHdheSB0byBnZXQgTm9uZVR5cGUKTm9uZVR5cGUgPSB0eXBlKE5vbmUpCgp0cnk6CiAgICBmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBTZXF1ZW5jZSwgTWFwcGluZwpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAjIHB5dGhvbjIuNQogICAgU2VxdWVuY2UgPSAobGlzdCwgdHVwbGUpCiAgICBNYXBwaW5nID0gKGRpY3QsKQoKIyBOb3RlOiBXaGVuIGdldHRpbmcgU2VxdWVuY2UgZnJvbSBjb2xsZWN0aW9ucywgaXQgbWF0Y2hlcyB3aXRoIHN0cmluZ3MuICBJZgojIHRoaXMgbWF0dGVycywgbWFrZSBzdXJlIHRvIGNoZWNrIGZvciBzdHJpbmdzIGJlZm9yZSBjaGVja2luZyBmb3Igc2VxdWVuY2V0eXBlCnRyeToKICAgIGZyb20gY29sbGVjdGlvbnMuYWJjIGltcG9ydCBLZXlzVmlldwogICAgU0VRVUVOQ0VUWVBFID0gKFNlcXVlbmNlLCBLZXlzVmlldykKZXhjZXB0OgogICAgU0VRVUVOQ0VUWVBFID0gU2VxdWVuY2UKCnRyeToKICAgIGltcG9ydCBqc29uCiAgICAjIERldGVjdCB0aGUgcHl0aG9uLWpzb24gbGlicmFyeSB3aGljaCBpcyBpbmNvbXBhdGlibGUKICAgICMgTG9vayBmb3Igc2ltcGxlanNvbiBpZiB0aGF0J3MgdGhlIGNhc2UKICAgIHRyeToKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShqc29uLmxvYWRzLCB0eXBlcy5GdW5jdGlvblR5cGUpIG9yIG5vdCBpc2luc3RhbmNlKGpzb24uZHVtcHMsIHR5cGVzLkZ1bmN0aW9uVHlwZSk6CiAgICAgICAgICAgIHJhaXNlIEltcG9ydEVycm9yCiAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IKZXhjZXB0IEltcG9ydEVycm9yOgogICAgdHJ5OgogICAgICAgIGltcG9ydCBzaW1wbGVqc29uIGFzIGpzb24KICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICBwcmludCgnXG57Im1zZyI6ICJFcnJvcjogYW5zaWJsZSByZXF1aXJlcyB0aGUgc3RkbGliIGpzb24gb3Igc2ltcGxlanNvbiBtb2R1bGUsIG5laXRoZXIgd2FzIGZvdW5kISIsICJmYWlsZWQiOiB0cnVlfScpCiAgICAgICAgc3lzLmV4aXQoMSkKICAgIGV4Y2VwdCBTeW50YXhFcnJvcjoKICAgICAgICBwcmludCgnXG57Im1zZyI6ICJTeW50YXhFcnJvcjogcHJvYmFibHkgZHVlIHRvIGluc3RhbGxlZCBzaW1wbGVqc29uIGJlaW5nIGZvciBhIGRpZmZlcmVudCBweXRob24gdmVyc2lvbiIsICJmYWlsZWQiOiB0cnVlfScpCiAgICAgICAgc3lzLmV4aXQoMSkKCkFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVMgPSBkaWN0KCkKdHJ5OgogICAgaW1wb3J0IGhhc2hsaWIKCiAgICAjIHB5dGhvbiAyLjcuOSsgYW5kIDIuNy4wKwogICAgZm9yIGF0dHJpYnV0ZSBpbiAoJ2F2YWlsYWJsZV9hbGdvcml0aG1zJywgJ2FsZ29yaXRobXMnKToKICAgICAgICBhbGdvcml0aG1zID0gZ2V0YXR0cihoYXNobGliLCBhdHRyaWJ1dGUsIE5vbmUpCiAgICAgICAgaWYgYWxnb3JpdGhtczoKICAgICAgICAgICAgYnJlYWsKICAgIGlmIGFsZ29yaXRobXMgaXMgTm9uZToKICAgICAgICAjIHB5dGhvbiAyLjUrCiAgICAgICAgYWxnb3JpdGhtcyA9ICgnbWQ1JywgJ3NoYTEnLCAnc2hhMjI0JywgJ3NoYTI1NicsICdzaGEzODQnLCAnc2hhNTEyJykKICAgIGZvciBhbGdvcml0aG0gaW4gYWxnb3JpdGhtczoKICAgICAgICBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TW2FsZ29yaXRobV0gPSBnZXRhdHRyKGhhc2hsaWIsIGFsZ29yaXRobSkKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaW1wb3J0IHNoYQogICAgQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNUyA9IHsnc2hhMSc6IHNoYS5zaGF9CiAgICB0cnk6CiAgICAgICAgaW1wb3J0IG1kNQogICAgICAgIEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVNbJ21kNSddID0gbWQ1Lm1kNQogICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgIHBhc3MKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMucHljb21wYXQyNCBpbXBvcnQgZ2V0X2V4Y2VwdGlvbiwgbGl0ZXJhbF9ldmFsCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGltcG9ydCAoUFkyLCBQWTMsIGIsIGJpbmFyeV90eXBlLCBpbnRlZ2VyX3R5cGVzLAogICAgICAgIGl0ZXJpdGVtcywgdGV4dF90eXBlLCBzdHJpbmdfdHlwZXMpCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Lm1vdmVzIGltcG9ydCBtYXAsIHJlZHVjZSwgc2hsZXhfcXVvdGUKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5fdGV4dCBpbXBvcnQgdG9fbmF0aXZlLCB0b19ieXRlcywgdG9fdGV4dAoKUEFTU1dPUkRfTUFUQ0ggPSByZS5jb21waWxlKHInXig/Oi4rWy1fXHNdKT9wYXNzKD86Wy1fXHNdPyg/OndvcmR8cGhyYXNlfHdyZHx3ZCk/KSg/OlstX1xzXS4rKT8kJywgcmUuSSkKCl9OVU1CRVJUWVBFUyA9IHR1cGxlKGxpc3QoaW50ZWdlcl90eXBlcykgKyBbZmxvYXRdKQoKIyBEZXByZWNhdGVkIGNvbXBhdC4gIE9ubHkga2VwdCBpbiBjYXNlIGFub3RoZXIgbW9kdWxlIHVzZWQgdGhlc2UgbmFtZXMgIFVzaW5nCiMgYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGlzIHByZWZlcnJlZAoKTlVNQkVSVFlQRVMgPSBfTlVNQkVSVFlQRVMKCmltYXAgPSBtYXAKCnRyeToKICAgICMgUHl0aG9uIDIKICAgIHVuaWNvZGUKZXhjZXB0IE5hbWVFcnJvcjoKICAgICMgUHl0aG9uIDMKICAgIHVuaWNvZGUgPSB0ZXh0X3R5cGUKCnRyeToKICAgICMgUHl0aG9uIDIuNisKICAgIGJ5dGVzCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICAjIFB5dGhvbiAyLjQKICAgIGJ5dGVzID0gYmluYXJ5X3R5cGUKCnRyeToKICAgICMgUHl0aG9uIDIKICAgIGJhc2VzdHJpbmcKZXhjZXB0IE5hbWVFcnJvcjoKICAgICMgUHl0aG9uIDMKICAgIGJhc2VzdHJpbmcgPSBzdHJpbmdfdHlwZXMKCl9saXRlcmFsX2V2YWwgPSBsaXRlcmFsX2V2YWwKCiMgRW5kIG9mIGRlcHJlY2F0ZWQgbmFtZXMKCiMgSW50ZXJuYWwgZ2xvYmFsIGhvbGRpbmcgcGFzc2VkIGluIHBhcmFtcy4gIFRoaXMgaXMgY29uc3VsdGVkIGluIGNhc2UKIyBtdWx0aXBsZSBBbnNpYmxlTW9kdWxlcyBhcmUgY3JlYXRlZC4gIE90aGVyd2lzZSBlYWNoIEFuc2libGVNb2R1bGUgd291bGQKIyBhdHRlbXB0IHRvIHJlYWQgZnJvbSBzdGRpbi4gIE90aGVyIGNvZGUgc2hvdWxkIG5vdCB1c2UgdGhpcyBkaXJlY3RseSBhcyBpdAojIGlzIGFuIGludGVybmFsIGltcGxlbWVudGF0aW9uIGRldGFpbApfQU5TSUJMRV9BUkdTID0gTm9uZQoKRklMRV9DT01NT05fQVJHVU1FTlRTPWRpY3QoCiAgICBzcmMgPSBkaWN0KCksCiAgICBtb2RlID0gZGljdCh0eXBlPSdyYXcnKSwKICAgIG93bmVyID0gZGljdCgpLAogICAgZ3JvdXAgPSBkaWN0KCksCiAgICBzZXVzZXIgPSBkaWN0KCksCiAgICBzZXJvbGUgPSBkaWN0KCksCiAgICBzZWxldmVsID0gZGljdCgpLAogICAgc2V0eXBlID0gZGljdCgpLAogICAgZm9sbG93ID0gZGljdCh0eXBlPSdib29sJywgZGVmYXVsdD1GYWxzZSksCiAgICAjIG5vdCB0YWtlbiBieSB0aGUgZmlsZSBtb2R1bGUsIGJ1dCBvdGhlciBtb2R1bGVzIGNhbGwgZmlsZSBzbyBpdCBtdXN0IGlnbm9yZSB0aGVtLgogICAgY29udGVudCA9IGRpY3Qobm9fbG9nPVRydWUpLAogICAgYmFja3VwID0gZGljdCgpLAogICAgZm9yY2UgPSBkaWN0KCksCiAgICByZW1vdGVfc3JjID0gZGljdCgpLCAjIHVzZWQgYnkgYXNzZW1ibGUKICAgIHJlZ2V4cCA9IGRpY3QoKSwgIyB1c2VkIGJ5IGFzc2VtYmxlCiAgICBkZWxpbWl0ZXIgPSBkaWN0KCksICMgdXNlZCBieSBhc3NlbWJsZQogICAgZGlyZWN0b3J5X21vZGUgPSBkaWN0KCksICMgdXNlZCBieSBjb3B5CiAgICB1bnNhZmVfd3JpdGVzICA9IGRpY3QodHlwZT0nYm9vbCcpLCAjIHNob3VsZCBiZSBhdmFpbGFibGUgdG8gYW55IG1vZHVsZSB1c2luZyBhdG9taWNfbW92ZQogICAgYXR0cmlidXRlcyA9IGRpY3QoYWxpYXNlcz1bJ2F0dHInXSksCikKClBBU1NXRF9BUkdfUkUgPSByZS5jb21waWxlKHInXlstXXswLDJ9cGFzc1stXT8od29yZHx3ZCk/JykKCiMgQ2FuJ3QgdXNlIDA3Nzc3IG9uIFB5dGhvbiAzLCBjYW4ndCB1c2UgMG83Nzc3IG9uIFB5dGhvbiAyLjQKUEVSTV9CSVRTID0gaW50KCcwNzc3NycsIDgpICAgICAgIyBmaWxlIG1vZGUgcGVybWlzc2lvbiBiaXRzCkVYRUNfUEVSTV9CSVRTID0gaW50KCcwMDExMScsIDgpICMgZXhlY3V0ZSBwZXJtaXNzaW9uIGJpdHMKREVGQVVMVF9QRVJNID0gaW50KCcwNjY2JywgOCkgICAgIyBkZWZhdWx0IGZpbGUgcGVybWlzc2lvbiBiaXRzCgoKZGVmIGdldF9wbGF0Zm9ybSgpOgogICAgJycnIHdoYXQncyB0aGUgcGxhdGZvcm0/ICBleGFtcGxlOiBMaW51eCBpcyBhIHBsYXRmb3JtLiAnJycKICAgIHJldHVybiBwbGF0Zm9ybS5zeXN0ZW0oKQoKZGVmIGdldF9kaXN0cmlidXRpb24oKToKICAgICcnJyByZXR1cm4gdGhlIGRpc3RyaWJ1dGlvbiBuYW1lICcnJwogICAgaWYgcGxhdGZvcm0uc3lzdGVtKCkgPT0gJ0xpbnV4JzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN1cHBvcnRlZF9kaXN0cyA9IHBsYXRmb3JtLl9zdXBwb3J0ZWRfZGlzdHMgKyAoJ2FyY2gnLCdhbHBpbmUnKQogICAgICAgICAgICBkaXN0cmlidXRpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oc3VwcG9ydGVkX2Rpc3RzPXN1cHBvcnRlZF9kaXN0cylbMF0uY2FwaXRhbGl6ZSgpCiAgICAgICAgICAgIGlmIG5vdCBkaXN0cmlidXRpb24gYW5kIG9zLnBhdGguaXNmaWxlKCcvZXRjL3N5c3RlbS1yZWxlYXNlJyk6CiAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oc3VwcG9ydGVkX2Rpc3RzPVsnc3lzdGVtJ10pWzBdLmNhcGl0YWxpemUoKQogICAgICAgICAgICAgICAgaWYgJ0FtYXpvbicgaW4gZGlzdHJpYnV0aW9uOgogICAgICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9ICdBbWF6b24nCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9ICdPdGhlckxpbnV4JwogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgIyBGSVhNRTogTWV0aG9kTWlzc2luZywgSSBhc3N1bWU/CiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9IHBsYXRmb3JtLmRpc3QoKVswXS5jYXBpdGFsaXplKCkKICAgIGVsc2U6CiAgICAgICAgZGlzdHJpYnV0aW9uID0gTm9uZQogICAgcmV0dXJuIGRpc3RyaWJ1dGlvbgoKZGVmIGdldF9kaXN0cmlidXRpb25fdmVyc2lvbigpOgogICAgJycnIHJldHVybiB0aGUgZGlzdHJpYnV0aW9uIHZlcnNpb24gJycnCiAgICBpZiBwbGF0Zm9ybS5zeXN0ZW0oKSA9PSAnTGludXgnOgogICAgICAgIHRyeToKICAgICAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oKVsxXQogICAgICAgICAgICBpZiBub3QgZGlzdHJpYnV0aW9uX3ZlcnNpb24gYW5kIG9zLnBhdGguaXNmaWxlKCcvZXRjL3N5c3RlbS1yZWxlYXNlJyk6CiAgICAgICAgICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IHBsYXRmb3JtLmxpbnV4X2Rpc3RyaWJ1dGlvbihzdXBwb3J0ZWRfZGlzdHM9WydzeXN0ZW0nXSlbMV0KICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICMgRklYTUU6IE1ldGhvZE1pc3NpbmcsIEkgYXNzdW1lPwogICAgICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IHBsYXRmb3JtLmRpc3QoKVsxXQogICAgZWxzZToKICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IE5vbmUKICAgIHJldHVybiBkaXN0cmlidXRpb25fdmVyc2lvbgoKZGVmIGdldF9hbGxfc3ViY2xhc3NlcyhjbHMpOgogICAgJycnCiAgICB1c2VkIGJ5IG1vZHVsZXMgbGlrZSBIYXJkd2FyZSBvciBOZXR3b3JrIGZhY3QgY2xhc3NlcyB0byByZXRyaWV2ZSBhbGwgc3ViY2xhc3NlcyBvZiBhIGdpdmVuIGNsYXNzLgogICAgX19zdWJjbGFzc2VzX18gcmV0dXJuIG9ubHkgZGlyZWN0IHN1YiBjbGFzc2VzLiBUaGlzIG9uZSBnbyBkb3duIGludG8gdGhlIGNsYXNzIHRyZWUuCiAgICAnJycKICAgICMgUmV0cmlldmUgZGlyZWN0IHN1YmNsYXNzZXMKICAgIHN1YmNsYXNzZXMgPSBjbHMuX19zdWJjbGFzc2VzX18oKQogICAgdG9fdmlzaXQgPSBsaXN0KHN1YmNsYXNzZXMpCiAgICAjIFRoZW4gdmlzaXQgYWxsIHN1YmNsYXNzZXMKICAgIHdoaWxlIHRvX3Zpc2l0OgogICAgICAgIGZvciBzYyBpbiB0b192aXNpdDoKICAgICAgICAgICAgIyBUaGUgY3VycmVudCBjbGFzcyBpcyBub3cgdmlzaXRlZCwgc28gcmVtb3ZlIGl0IGZyb20gbGlzdAogICAgICAgICAgICB0b192aXNpdC5yZW1vdmUoc2MpCiAgICAgICAgICAgICMgQXBwZW5kaW5nIGFsbCBzdWJjbGFzc2VzIHRvIHZpc2l0IGFuZCBrZWVwIGEgcmVmZXJlbmNlIG9mIGF2YWlsYWJsZSBjbGFzcwogICAgICAgICAgICBmb3Igc3NjIGluIHNjLl9fc3ViY2xhc3Nlc19fKCk6CiAgICAgICAgICAgICAgICBzdWJjbGFzc2VzLmFwcGVuZChzc2MpCiAgICAgICAgICAgICAgICB0b192aXNpdC5hcHBlbmQoc3NjKQogICAgcmV0dXJuIHN1YmNsYXNzZXMKCgpkZWYgbG9hZF9wbGF0Zm9ybV9zdWJjbGFzcyhjbHMsICphcmdzLCAqKmt3YXJncyk6CiAgICAnJycKICAgIHVzZWQgYnkgbW9kdWxlcyBsaWtlIFVzZXIgdG8gaGF2ZSBkaWZmZXJlbnQgaW1wbGVtZW50YXRpb25zIGJhc2VkIG9uIGRldGVjdGVkIHBsYXRmb3JtLiAgU2VlIFVzZXIKICAgIG1vZHVsZSBmb3IgYW4gZXhhbXBsZS4KICAgICcnJwoKICAgIHRoaXNfcGxhdGZvcm0gPSBnZXRfcGxhdGZvcm0oKQogICAgZGlzdHJpYnV0aW9uID0gZ2V0X2Rpc3RyaWJ1dGlvbigpCiAgICBzdWJjbGFzcyA9IE5vbmUKCiAgICAjIGdldCB0aGUgbW9zdCBzcGVjaWZpYyBzdXBlcmNsYXNzIGZvciB0aGlzIHBsYXRmb3JtCiAgICBpZiBkaXN0cmlidXRpb24gaXMgbm90IE5vbmU6CiAgICAgICAgZm9yIHNjIGluIGdldF9hbGxfc3ViY2xhc3NlcyhjbHMpOgogICAgICAgICAgICBpZiBzYy5kaXN0cmlidXRpb24gaXMgbm90IE5vbmUgYW5kIHNjLmRpc3RyaWJ1dGlvbiA9PSBkaXN0cmlidXRpb24gYW5kIHNjLnBsYXRmb3JtID09IHRoaXNfcGxhdGZvcm06CiAgICAgICAgICAgICAgICBzdWJjbGFzcyA9IHNjCiAgICBpZiBzdWJjbGFzcyBpcyBOb25lOgogICAgICAgIGZvciBzYyBpbiBnZXRfYWxsX3N1YmNsYXNzZXMoY2xzKToKICAgICAgICAgICAgaWYgc2MucGxhdGZvcm0gPT0gdGhpc19wbGF0Zm9ybSBhbmQgc2MuZGlzdHJpYnV0aW9uIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzdWJjbGFzcyA9IHNjCiAgICBpZiBzdWJjbGFzcyBpcyBOb25lOgogICAgICAgIHN1YmNsYXNzID0gY2xzCgogICAgcmV0dXJuIHN1cGVyKGNscywgc3ViY2xhc3MpLl9fbmV3X18oc3ViY2xhc3MpCgoKZGVmIGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzKGQsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpOgogICAgJycnIFJlY3Vyc2l2ZWx5IGNvbnZlcnQgZGljdCBrZXlzIGFuZCB2YWx1ZXMgdG8gYnl0ZSBzdHIKCiAgICAgICAgU3BlY2lhbGl6ZWQgZm9yIGpzb24gcmV0dXJuIGJlY2F1c2UgdGhpcyBvbmx5IGhhbmRsZXMsIGxpc3RzLCB0dXBsZXMsCiAgICAgICAgYW5kIGRpY3QgY29udGFpbmVyIHR5cGVzICh0aGUgY29udGFpbmVycyB0aGF0IHRoZSBqc29uIG1vZHVsZSByZXR1cm5zKQogICAgJycnCgogICAgaWYgaXNpbnN0YW5jZShkLCB0ZXh0X3R5cGUpOgogICAgICAgIHJldHVybiB0b19ieXRlcyhkLCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycykKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBkaWN0KToKICAgICAgICByZXR1cm4gZGljdChtYXAoanNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMsIGl0ZXJpdGVtcyhkKSwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIGxpc3QpOgogICAgICAgIHJldHVybiBsaXN0KG1hcChqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcywgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIHR1cGxlKToKICAgICAgICByZXR1cm4gdHVwbGUobWFwKGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzLCBkLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbHNlOgogICAgICAgIHJldHVybiBkCgpkZWYganNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUoZCwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0Jyk6CiAgICAnJycgUmVjdXJzaXZlbHkgY29udmVydCBkaWN0IGtleXMgYW5kIHZhbHVlcyB0byBieXRlIHN0cgoKICAgICAgICBTcGVjaWFsaXplZCBmb3IganNvbiByZXR1cm4gYmVjYXVzZSB0aGlzIG9ubHkgaGFuZGxlcywgbGlzdHMsIHR1cGxlcywKICAgICAgICBhbmQgZGljdCBjb250YWluZXIgdHlwZXMgKHRoZSBjb250YWluZXJzIHRoYXQgdGhlIGpzb24gbW9kdWxlIHJldHVybnMpCiAgICAnJycKCiAgICBpZiBpc2luc3RhbmNlKGQsIGJpbmFyeV90eXBlKToKICAgICAgICAjIFdhcm5pbmcsIGNhbiB0cmFjZWJhY2sKICAgICAgICByZXR1cm4gdG9fdGV4dChkLCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycykKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBkaWN0KToKICAgICAgICByZXR1cm4gZGljdChtYXAoanNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUsIGl0ZXJpdGVtcyhkKSwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIGxpc3QpOgogICAgICAgIHJldHVybiBsaXN0KG1hcChqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZSwgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIHR1cGxlKToKICAgICAgICByZXR1cm4gdHVwbGUobWFwKGpzb25fZGljdF9ieXRlc190b191bmljb2RlLCBkLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbHNlOgogICAgICAgIHJldHVybiBkCgpkZWYgcmV0dXJuX3ZhbHVlcyhvYmopOgogICAgIiIiIFJldHVybiBuYXRpdmUgc3RyaW5naWZpZWQgdmFsdWVzIGZyb20gZGF0YXN0cnVjdHVyZXMuCgogICAgRm9yIHVzZSB3aXRoIHJlbW92aW5nIHNlbnNpdGl2ZSB2YWx1ZXMgcHJlLWpzb25pZmljYXRpb24uIiIiCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICBpZiBvYmo6CiAgICAgICAgICAgIHlpZWxkIHRvX25hdGl2ZShvYmosIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgcmV0dXJuCiAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCBTRVFVRU5DRVRZUEUpOgogICAgICAgIGZvciBlbGVtZW50IGluIG9iajoKICAgICAgICAgICAgZm9yIHN1YmVsZW1lbnQgaW4gcmV0dXJuX3ZhbHVlcyhlbGVtZW50KToKICAgICAgICAgICAgICAgIHlpZWxkIHN1YmVsZW1lbnQKICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIE1hcHBpbmcpOgogICAgICAgIGZvciBlbGVtZW50IGluIG9iai5pdGVtcygpOgogICAgICAgICAgICBmb3Igc3ViZWxlbWVudCBpbiByZXR1cm5fdmFsdWVzKGVsZW1lbnRbMV0pOgogICAgICAgICAgICAgICAgeWllbGQgc3ViZWxlbWVudAogICAgZWxpZiBpc2luc3RhbmNlKG9iaiwgKGJvb2wsIE5vbmVUeXBlKSk6CiAgICAgICAgIyBUaGlzIG11c3QgY29tZSBiZWZvcmUgaW50IGJlY2F1c2UgYm9vbHMgYXJlIGFsc28gaW50cwogICAgICAgIHJldHVybgogICAgZWxpZiBpc2luc3RhbmNlKG9iaiwgTlVNQkVSVFlQRVMpOgogICAgICAgIHlpZWxkIHRvX25hdGl2ZShvYmosIG5vbnN0cmluZz0nc2ltcGxlcmVwcicpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignVW5rbm93biBwYXJhbWV0ZXIgdHlwZTogJXMsICVzJyAlICh0eXBlKG9iaiksIG9iaikpCgpkZWYgcmVtb3ZlX3ZhbHVlcyh2YWx1ZSwgbm9fbG9nX3N0cmluZ3MpOgogICAgIiIiIFJlbW92ZSBzdHJpbmdzIGluIG5vX2xvZ19zdHJpbmdzIGZyb20gdmFsdWUuICBJZiB2YWx1ZSBpcyBhIGNvbnRhaW5lcgogICAgdHlwZSwgdGhlbiByZW1vdmUgYSBsb3QgbW9yZSIiIgogICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICAjIE5lZWQgbmF0aXZlIHN0ciB0eXBlCiAgICAgICAgbmF0aXZlX3N0cl92YWx1ZSA9IHZhbHVlCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgdGV4dF90eXBlKToKICAgICAgICAgICAgdmFsdWVfaXNfdGV4dCA9IFRydWUKICAgICAgICAgICAgaWYgUFkyOgogICAgICAgICAgICAgICAgbmF0aXZlX3N0cl92YWx1ZSA9IHRvX2J5dGVzKHZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICB2YWx1ZV9pc190ZXh0ID0gRmFsc2UKICAgICAgICAgICAgaWYgUFkzOgogICAgICAgICAgICAgICAgbmF0aXZlX3N0cl92YWx1ZSA9IHRvX3RleHQodmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCgogICAgICAgIGlmIG5hdGl2ZV9zdHJfdmFsdWUgaW4gbm9fbG9nX3N0cmluZ3M6CiAgICAgICAgICAgIHJldHVybiAnVkFMVUVfU1BFQ0lGSUVEX0lOX05PX0xPR19QQVJBTUVURVInCiAgICAgICAgZm9yIG9taXRfbWUgaW4gbm9fbG9nX3N0cmluZ3M6CiAgICAgICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSBuYXRpdmVfc3RyX3ZhbHVlLnJlcGxhY2Uob21pdF9tZSwgJyonICogOCkKCiAgICAgICAgaWYgdmFsdWVfaXNfdGV4dCBhbmQgaXNpbnN0YW5jZShuYXRpdmVfc3RyX3ZhbHVlLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgIHZhbHVlID0gdG9fdGV4dChuYXRpdmVfc3RyX3ZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKQogICAgICAgIGVsaWYgbm90IHZhbHVlX2lzX3RleHQgYW5kIGlzaW5zdGFuY2UobmF0aXZlX3N0cl92YWx1ZSwgdGV4dF90eXBlKToKICAgICAgICAgICAgdmFsdWUgPSB0b19ieXRlcyhuYXRpdmVfc3RyX3ZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHZhbHVlID0gbmF0aXZlX3N0cl92YWx1ZQogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBTRVFVRU5DRVRZUEUpOgogICAgICAgIHJldHVybiBbcmVtb3ZlX3ZhbHVlcyhlbGVtLCBub19sb2dfc3RyaW5ncykgZm9yIGVsZW0gaW4gdmFsdWVdCiAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIE1hcHBpbmcpOgogICAgICAgIHJldHVybiBkaWN0KChrLCByZW1vdmVfdmFsdWVzKHYsIG5vX2xvZ19zdHJpbmdzKSkgZm9yIGssIHYgaW4gdmFsdWUuaXRlbXMoKSkKICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgdHVwbGUoY2hhaW4oTlVNQkVSVFlQRVMsIChib29sLCBOb25lVHlwZSkpKSk6CiAgICAgICAgc3RyaW5neV92YWx1ZSA9IHRvX25hdGl2ZSh2YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBpZiBzdHJpbmd5X3ZhbHVlIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICByZXR1cm4gJ1ZBTFVFX1NQRUNJRklFRF9JTl9OT19MT0dfUEFSQU1FVEVSJwogICAgICAgIGZvciBvbWl0X21lIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICBpZiBvbWl0X21lIGluIHN0cmluZ3lfdmFsdWU6CiAgICAgICAgICAgICAgICByZXR1cm4gJ1ZBTFVFX1NQRUNJRklFRF9JTl9OT19MT0dfUEFSQU1FVEVSJwogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBkYXRldGltZS5kYXRldGltZSk6CiAgICAgICAgdmFsdWUgPSB2YWx1ZS5pc29mb3JtYXQoKQogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ1ZhbHVlIG9mIHVua25vd24gdHlwZTogJXMsICVzJyAlICh0eXBlKHZhbHVlKSwgdmFsdWUpKQogICAgcmV0dXJuIHZhbHVlCgoKZGVmIGhldXJpc3RpY19sb2dfc2FuaXRpemUoZGF0YSwgbm9fbG9nX3ZhbHVlcz1Ob25lKToKICAgICcnJyBSZW1vdmUgc3RyaW5ncyB0aGF0IGxvb2sgbGlrZSBwYXNzd29yZHMgZnJvbSBsb2cgbWVzc2FnZXMgJycnCiAgICAjIEN1cnJlbnRseSBmaWx0ZXJzOgogICAgIyB1c2VyOnBhc3NAZm9vL3doYXRldmVyIGFuZCBodHRwOi8vdXNlcm5hbWU6cGFzc0B3aGVyZXZlci9mb28KICAgICMgVGhpcyBjb2RlIGhhcyBmYWxzZSBwb3NpdGl2ZXMgYW5kIGNvbnN1bWVzIHBhcnRzIG9mIGxvZ3MgdGhhdCBhcmUKICAgICMgbm90IHBhc3N3ZHMKCiAgICAjIGJlZ2luOiBzdGFydCBvZiBhIHBhc3N3ZCBjb250YWluaW5nIHN0cmluZwogICAgIyBlbmQ6IGVuZCBvZiBhIHBhc3N3ZCBjb250YWluaW5nIHN0cmluZwogICAgIyBzZXA6IGNoYXIgYmV0d2VlbiB1c2VyIGFuZCBwYXNzd2QKICAgICMgcHJldl9iZWdpbjogd2hlcmUgaW4gdGhlIG92ZXJhbGwgc3RyaW5nIHRvIHN0YXJ0IGEgc2VhcmNoIGZvcgogICAgIyAgIGEgcGFzc3dkCiAgICAjIHNlcF9zZWFyY2hfZW5kOiB3aGVyZSBpbiB0aGUgc3RyaW5nIHRvIGVuZCBhIHNlYXJjaCBmb3IgdGhlIHNlcAogICAgZGF0YSA9IHRvX25hdGl2ZShkYXRhKQoKICAgIG91dHB1dCA9IFtdCiAgICBiZWdpbiA9IGxlbihkYXRhKQogICAgcHJldl9iZWdpbiA9IGJlZ2luCiAgICBzZXAgPSAxCiAgICB3aGlsZSBzZXA6CiAgICAgICAgIyBGaW5kIHRoZSBwb3RlbnRpYWwgZW5kIG9mIGEgcGFzc3dkCiAgICAgICAgdHJ5OgogICAgICAgICAgICBlbmQgPSBkYXRhLnJpbmRleCgnQCcsIDAsIGJlZ2luKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAjIE5vIHBhc3N3ZCBpbiB0aGUgcmVzdCBvZiB0aGUgZGF0YQogICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsIGRhdGFbMDpiZWdpbl0pCiAgICAgICAgICAgIGJyZWFrCgogICAgICAgICMgU2VhcmNoIGZvciB0aGUgYmVnaW5uaW5nIG9mIGEgcGFzc3dkCiAgICAgICAgc2VwID0gTm9uZQogICAgICAgIHNlcF9zZWFyY2hfZW5kID0gZW5kCiAgICAgICAgd2hpbGUgbm90IHNlcDoKICAgICAgICAgICAgIyBVUkwtc3R5bGUgdXNlcm5hbWUrcGFzc3dvcmQKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYmVnaW4gPSBkYXRhLnJpbmRleCgnOi8vJywgMCwgc2VwX3NlYXJjaF9lbmQpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgIyBObyB1cmwgc3R5bGUgaW4gdGhlIGRhdGEsIGNoZWNrIGZvciBzc2ggc3R5bGUgaW4gdGhlCiAgICAgICAgICAgICAgICAjIHJlc3Qgb2YgdGhlIHN0cmluZwogICAgICAgICAgICAgICAgYmVnaW4gPSAwCiAgICAgICAgICAgICMgU2VhcmNoIGZvciBzZXBhcmF0b3IKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VwID0gZGF0YS5pbmRleCgnOicsIGJlZ2luICsgMywgZW5kKQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICMgTm8gc2VwYXJhdG9yOyBjaG9pY2VzOgogICAgICAgICAgICAgICAgaWYgYmVnaW4gPT0gMDoKICAgICAgICAgICAgICAgICAgICAjIFNlYXJjaGVkIHRoZSB3aG9sZSBzdHJpbmcgc28gdGhlcmUncyBubyBwYXNzd29yZAogICAgICAgICAgICAgICAgICAgICMgaGVyZS4gIFJldHVybiB0aGUgcmVtYWluaW5nIGRhdGEKICAgICAgICAgICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsIGRhdGFbMDpiZWdpbl0pCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICMgU2VhcmNoIGZvciBhIGRpZmZlcmVudCBiZWdpbm5pbmcgb2YgdGhlIHBhc3N3b3JkIGZpZWxkLgogICAgICAgICAgICAgICAgc2VwX3NlYXJjaF9lbmQgPSBiZWdpbgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICBpZiBzZXA6CiAgICAgICAgICAgICMgUGFzc3dvcmQgd2FzIGZvdW5kOyByZW1vdmUgaXQuCiAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgZGF0YVtlbmQ6cHJldl9iZWdpbl0pCiAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgJyoqKioqKioqJykKICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCBkYXRhW2JlZ2luOnNlcCArIDFdKQogICAgICAgICAgICBwcmV2X2JlZ2luID0gYmVnaW4KCiAgICBvdXRwdXQgPSAnJy5qb2luKG91dHB1dCkKICAgIGlmIG5vX2xvZ192YWx1ZXM6CiAgICAgICAgb3V0cHV0ID0gcmVtb3ZlX3ZhbHVlcyhvdXRwdXQsIG5vX2xvZ192YWx1ZXMpCiAgICByZXR1cm4gb3V0cHV0CgpkZWYgYnl0ZXNfdG9faHVtYW4oc2l6ZSwgaXNiaXRzPUZhbHNlLCB1bml0PU5vbmUpOgoKICAgIGJhc2UgPSAnQnl0ZXMnCiAgICBpZiBpc2JpdHM6CiAgICAgICAgYmFzZSA9ICdiaXRzJwogICAgc3VmZml4ID0gJycKCiAgICBmb3Igc3VmZml4LCBsaW1pdCBpbiBzb3J0ZWQoaXRlcml0ZW1zKFNJWkVfUkFOR0VTKSwga2V5PWxhbWJkYSBpdGVtOiAtaXRlbVsxXSk6CiAgICAgICAgaWYgKHVuaXQgaXMgTm9uZSBhbmQgc2l6ZSA+PSBsaW1pdCkgb3IgdW5pdCBpcyBub3QgTm9uZSBhbmQgdW5pdC51cHBlcigpID09IHN1ZmZpeFswXToKICAgICAgICAgICAgYnJlYWsKCiAgICBpZiBsaW1pdCAhPSAxOgogICAgICAgIHN1ZmZpeCArPSBiYXNlWzBdCiAgICBlbHNlOgogICAgICAgIHN1ZmZpeCA9IGJhc2UKCiAgICByZXR1cm4gJyUuMmYgJXMnICUgKGZsb2F0KHNpemUpLyBsaW1pdCwgc3VmZml4KQoKZGVmIGh1bWFuX3RvX2J5dGVzKG51bWJlciwgZGVmYXVsdF91bml0PU5vbmUsIGlzYml0cz1GYWxzZSk6CgogICAgJycnCiAgICBDb252ZXJ0IG51bWJlciBpbiBzdHJpbmcgZm9ybWF0IGludG8gYnl0ZXMgKGV4OiAnMksnID0+IDIwNDgpIG9yIHVzaW5nIHVuaXQgYXJndW1lbnQKICAgIGV4OgogICAgICBodW1hbl90b19ieXRlcygnMTBNJykgPD0+IGh1bWFuX3RvX2J5dGVzKDEwLCAnTScpCiAgICAnJycKICAgIG0gPSByZS5zZWFyY2goJ15ccyooXGQqXC4/XGQqKVxzKihbQS1aYS16XSspPycsIHN0cihudW1iZXIpLCBmbGFncz1yZS5JR05PUkVDQVNFKQogICAgaWYgbSBpcyBOb25lOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgY2FuJ3QgaW50ZXJwcmV0IGZvbGxvd2luZyBzdHJpbmc6ICVzIiAlIHN0cihudW1iZXIpKQogICAgdHJ5OgogICAgICAgIG51bSA9IGZsb2F0KG0uZ3JvdXAoMSkpCiAgICBleGNlcHQ6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaHVtYW5fdG9fYnl0ZXMoKSBjYW4ndCBpbnRlcnByZXQgZm9sbG93aW5nIG51bWJlcjogJXMgKG9yaWdpbmFsIGlucHV0IHN0cmluZzogJXMpIiAlIChtLmdyb3VwKDEpLCBudW1iZXIpKQoKICAgIHVuaXQgPSBtLmdyb3VwKDIpCiAgICBpZiB1bml0IGlzIE5vbmU6CiAgICAgICAgdW5pdCA9IGRlZmF1bHRfdW5pdAoKICAgIGlmIHVuaXQgaXMgTm9uZToKICAgICAgICAnJycgTm8gdW5pdCBnaXZlbiwgcmV0dXJuaW5nIHJhdyBudW1iZXIgJycnCiAgICAgICAgcmV0dXJuIGludChyb3VuZChudW0pKQogICAgcmFuZ2Vfa2V5ID0gdW5pdFswXS51cHBlcigpCiAgICB0cnk6CiAgICAgICAgbGltaXQgPSBTSVpFX1JBTkdFU1tyYW5nZV9rZXldCiAgICBleGNlcHQ6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaHVtYW5fdG9fYnl0ZXMoKSBmYWlsZWQgdG8gY29udmVydCAlcyAodW5pdCA9ICVzKS4gVGhlIHN1ZmZpeCBtdXN0IGJlIG9uZSBvZiAlcyIgJSAobnVtYmVyLCB1bml0LCAiLCAiLmpvaW4oU0laRV9SQU5HRVMua2V5cygpKSkpCgogICAgIyBkZWZhdWx0IHZhbHVlCiAgICB1bml0X2NsYXNzID0gJ0InCiAgICB1bml0X2NsYXNzX25hbWUgPSAnYnl0ZScKICAgICMgaGFuZGxpbmcgYml0cyBjYXNlCiAgICBpZiBpc2JpdHM6CiAgICAgICAgdW5pdF9jbGFzcyA9ICdiJwogICAgICAgIHVuaXRfY2xhc3NfbmFtZSA9ICdiaXQnCiAgICAjIGNoZWNrIHVuaXQgdmFsdWUgaWYgbW9yZSB0aGFuIG9uZSBjaGFyYWN0ZXIgKEtCLCBNQikKICAgIGlmIGxlbih1bml0KSA+IDE6CiAgICAgICAgZXhwZWN0X21lc3NhZ2UgPSAnZXhwZWN0ICVzJXMgb3IgJXMnICUgKHJhbmdlX2tleSwgdW5pdF9jbGFzcywgcmFuZ2Vfa2V5KQogICAgICAgIGlmIHJhbmdlX2tleSA9PSAnQic6CiAgICAgICAgICAgIGV4cGVjdF9tZXNzYWdlID0gJ2V4cGVjdCAlcyBvciAlcycgJSAodW5pdF9jbGFzcywgdW5pdF9jbGFzc19uYW1lKQoKICAgICAgICBpZiB1bml0X2NsYXNzX25hbWUgaW4gdW5pdC5sb3dlcigpOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxpZiB1bml0WzFdICE9IHVuaXRfY2xhc3M6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgZmFpbGVkIHRvIGNvbnZlcnQgJXMuIFZhbHVlIGlzIG5vdCBhIHZhbGlkIHN0cmluZyAoJXMpIiAlIChudW1iZXIsIGV4cGVjdF9tZXNzYWdlKSkKCiAgICByZXR1cm4gaW50KHJvdW5kKG51bSAqIGxpbWl0KSkKCmRlZiBpc19leGVjdXRhYmxlKHBhdGgpOgogICAgJycnaXMgdGhlIGdpdmVuIHBhdGggZXhlY3V0YWJsZT8KCiAgICBMaW1pdGF0aW9uczoKICAgICogRG9lcyBub3QgYWNjb3VudCBmb3IgRlNBQ0xzLgogICAgKiBNb3N0IHRpbWVzIHdlIHJlYWxseSB3YW50IHRvIGtub3cgIkNhbiB0aGUgY3VycmVudCB1c2VyIGV4ZWN1dGUgdGhpcwogICAgICBmaWxlIiAgVGhpcyBmdW5jdGlvbiBkb2VzIG5vdCB0ZWxsIHVzIHRoYXQsIG9ubHkgaWYgYW4gZXhlY3V0ZSBiaXQgaXMgc2V0LgogICAgJycnCiAgICAjIFRoZXNlIGFyZSBhbGwgYml0ZmllbGRzIHNvIGZpcnN0IGJpdHdpc2Utb3IgYWxsIHRoZSBwZXJtaXNzaW9ucyB3ZSdyZQogICAgIyBsb29raW5nIGZvciwgdGhlbiBiaXR3aXNlLWFuZCB3aXRoIHRoZSBmaWxlJ3MgbW9kZSB0byBkZXRlcm1pbmUgaWYgYW55CiAgICAjIGV4ZWN1dGUgYml0cyBhcmUgc2V0LgogICAgcmV0dXJuICgoc3RhdC5TX0lYVVNSIHwgc3RhdC5TX0lYR1JQIHwgc3RhdC5TX0lYT1RIKSAmIG9zLnN0YXQocGF0aClbc3RhdC5TVF9NT0RFXSkKCmRlZiBfbG9hZF9wYXJhbXMoKToKICAgICcnJyByZWFkIHRoZSBtb2R1bGVzIHBhcmFtZXRlcnMgYW5kIHN0b3JlIHRoZW0gZ2xvYmFsbHkuCgogICAgVGhpcyBmdW5jdGlvbiBtYXkgYmUgbmVlZGVkIGZvciBjZXJ0YWluIHZlcnkgZHluYW1pYyBjdXN0b20gbW9kdWxlcyB3aGljaAogICAgd2FudCB0byBwcm9jZXNzIHRoZSBwYXJhbWV0ZXJzIHRoYXQgYXJlIGJlaW5nIGhhbmRlZCB0aGUgbW9kdWxlLiAgU2luY2UKICAgIHRoaXMgaXMgc28gY2xvc2VseSB0aWVkIHRvIHRoZSBpbXBsZW1lbnRhdGlvbiBvZiBtb2R1bGVzIHdlIGNhbm5vdAogICAgZ3VhcmFudGVlIEFQSSBzdGFiaWxpdHkgZm9yIGl0IChpdCBtYXkgY2hhbmdlIGJldHdlZW4gdmVyc2lvbnMpIGhvd2V2ZXIgd2UKICAgIHdpbGwgdHJ5IG5vdCB0byBicmVhayBpdCBncmF0dWl0b3VzbHkuICBJdCBpcyBjZXJ0YWlubHkgbW9yZSBmdXR1cmUtcHJvb2YKICAgIHRvIGNhbGwgdGhpcyBmdW5jdGlvbiBhbmQgY29uc3VtZSBpdHMgb3V0cHV0cyB0aGFuIHRvIGltcGxlbWVudCB0aGUgbG9naWMKICAgIGluc2lkZSBpdCBhcyBhIGNvcHkgaW4geW91ciBvd24gY29kZS4KICAgICcnJwogICAgZ2xvYmFsIF9BTlNJQkxFX0FSR1MKICAgIGlmIF9BTlNJQkxFX0FSR1MgaXMgbm90IE5vbmU6CiAgICAgICAgYnVmZmVyID0gX0FOU0lCTEVfQVJHUwogICAgZWxzZToKICAgICAgICAjIGRlYnVnIG92ZXJyaWRlcyB0byByZWFkIGFyZ3MgZnJvbSBmaWxlIG9yIGNtZGxpbmUKCiAgICAgICAgIyBBdm9pZCB0cmFjZWJhY2tzIHdoZW4gbG9jYWxlIGlzIG5vbi11dGY4CiAgICAgICAgIyBXZSBjb250cm9sIHRoZSBhcmdzIGFuZCB3ZSBwYXNzIHRoZW0gYXMgdXRmOAogICAgICAgIGlmIGxlbihzeXMuYXJndikgPiAxOgogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShzeXMuYXJndlsxXSk6CiAgICAgICAgICAgICAgICBmZCA9IG9wZW4oc3lzLmFyZ3ZbMV0sICdyYicpCiAgICAgICAgICAgICAgICBidWZmZXIgPSBmZC5yZWFkKCkKICAgICAgICAgICAgICAgIGZkLmNsb3NlKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHN5cy5hcmd2WzFdCiAgICAgICAgICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gYnVmZmVyLmVuY29kZSgndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZWVzY2FwZScpCiAgICAgICAgIyBkZWZhdWx0IGNhc2UsIHJlYWQgZnJvbSBzdGRpbgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHN5cy5zdGRpbi5yZWFkKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHN5cy5zdGRpbi5idWZmZXIucmVhZCgpCiAgICAgICAgX0FOU0lCTEVfQVJHUyA9IGJ1ZmZlcgoKICAgIHRyeToKICAgICAgICBwYXJhbXMgPSBqc29uLmxvYWRzKGJ1ZmZlci5kZWNvZGUoJ3V0Zi04JykpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAjIFRoaXMgaGVscGVyIHVzZWQgdG9vIGVhcmx5IGZvciBmYWlsX2pzb24gdG8gd29yay4KICAgICAgICBwcmludCgnXG57Im1zZyI6ICJFcnJvcjogTW9kdWxlIHVuYWJsZSB0byBkZWNvZGUgdmFsaWQgSlNPTiBvbiBzdGRpbi4gIFVuYWJsZSB0byBmaWd1cmUgb3V0IHdoYXQgcGFyYW1ldGVycyB3ZXJlIHBhc3NlZCIsICJmYWlsZWQiOiB0cnVlfScpCiAgICAgICAgc3lzLmV4aXQoMSkKCiAgICBpZiBQWTI6CiAgICAgICAgcGFyYW1zID0ganNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMocGFyYW1zKQoKICAgIHRyeToKICAgICAgICByZXR1cm4gcGFyYW1zWydBTlNJQkxFX01PRFVMRV9BUkdTJ10KICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAjIFRoaXMgaGVscGVyIGRvZXMgbm90IGhhdmUgYWNjZXNzIHRvIGZhaWxfanNvbiBzbyB3ZSBoYXZlIHRvIHByaW50CiAgICAgICAgIyBqc29uIG91dHB1dCBvbiBvdXIgb3duLgogICAgICAgIHByaW50KCdcbnsibXNnIjogIkVycm9yOiBNb2R1bGUgdW5hYmxlIHRvIGxvY2F0ZSBBTlNJQkxFX01PRFVMRV9BUkdTIGluIGpzb24gZGF0YSBmcm9tIHN0ZGluLiAgVW5hYmxlIHRvIGZpZ3VyZSBvdXQgd2hhdCBwYXJhbWV0ZXJzIHdlcmUgcGFzc2VkIiwgJwogICAgICAgICAgICAgICciZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCgpkZWYgZW52X2ZhbGxiYWNrKCphcmdzLCAqKmt3YXJncyk6CiAgICAnJycgTG9hZCB2YWx1ZSBmcm9tIGVudmlyb25tZW50ICcnJwogICAgZm9yIGFyZyBpbiBhcmdzOgogICAgICAgIGlmIGFyZyBpbiBvcy5lbnZpcm9uOgogICAgICAgICAgICByZXR1cm4gb3MuZW52aXJvblthcmddCiAgICBlbHNlOgogICAgICAgIHJhaXNlIEFuc2libGVGYWxsYmFja05vdEZvdW5kCgpkZWYgX2xlbmllbnRfbG93ZXJjYXNlKGxzdCk6CiAgICAiIiJMb3dlcmNhc2UgZWxlbWVudHMgb2YgYSBsaXN0LgoKICAgIElmIGFuIGVsZW1lbnQgaXMgbm90IGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggdW50b3VjaGVkLgogICAgIiIiCiAgICBsb3dlcmVkID0gW10KICAgIGZvciB2YWx1ZSBpbiBsc3Q6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb3dlcmVkLmFwcGVuZCh2YWx1ZS5sb3dlcigpKQogICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgbG93ZXJlZC5hcHBlbmQodmFsdWUpCiAgICByZXR1cm4gbG93ZXJlZAoKZGVmIGZvcm1hdF9hdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpOgogICAgYXR0cmlidXRlX2xpc3QgPSBbXQogICAgZm9yIGF0dHIgaW4gYXR0cmlidXRlczoKICAgICAgICBpZiBhdHRyIGluIEZJTEVfQVRUUklCVVRFUzoKICAgICAgICAgICAgYXR0cmlidXRlX2xpc3QuYXBwZW5kKEZJTEVfQVRUUklCVVRFU1thdHRyXSkKICAgIHJldHVybiBhdHRyaWJ1dGVfbGlzdAoKZGVmIGdldF9mbGFnc19mcm9tX2F0dHJpYnV0ZXMoYXR0cmlidXRlcyk6CiAgICBmbGFncyA9IFtdCiAgICBmb3Iga2V5LGF0dHIgaW4gRklMRV9BVFRSSUJVVEVTLml0ZW1zKCk6CiAgICAgICAgaWYgYXR0ciBpbiBhdHRyaWJ1dGVzOgogICAgICAgICAgICBmbGFncy5hcHBlbmQoa2V5KQogICAgcmV0dXJuICcnLmpvaW4oZmxhZ3MpCgpjbGFzcyBBbnNpYmxlRmFsbGJhY2tOb3RGb3VuZChFeGNlcHRpb24pOgogICAgcGFzcwoKCmNsYXNzIEFuc2libGVNb2R1bGUob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhcmd1bWVudF9zcGVjLCBieXBhc3NfY2hlY2tzPUZhbHNlLCBub19sb2c9RmFsc2UsCiAgICAgICAgICAgICAgICAgY2hlY2tfaW52YWxpZF9hcmd1bWVudHM9VHJ1ZSwgbXV0dWFsbHlfZXhjbHVzaXZlPU5vbmUsIHJlcXVpcmVkX3RvZ2V0aGVyPU5vbmUsCiAgICAgICAgICAgICAgICAgcmVxdWlyZWRfb25lX29mPU5vbmUsIGFkZF9maWxlX2NvbW1vbl9hcmdzPUZhbHNlLCBzdXBwb3J0c19jaGVja19tb2RlPUZhbHNlLAogICAgICAgICAgICAgICAgIHJlcXVpcmVkX2lmPU5vbmUpOgoKICAgICAgICAnJycKICAgICAgICBjb21tb24gY29kZSBmb3IgcXVpY2tseSBidWlsZGluZyBhbiBhbnNpYmxlIG1vZHVsZSBpbiBQeXRob24KICAgICAgICAoYWx0aG91Z2ggeW91IGNhbiB3cml0ZSBtb2R1bGVzIGluIGFueXRoaW5nIHRoYXQgY2FuIHJldHVybiBKU09OKQogICAgICAgIHNlZSBsaWJyYXJ5LyogZm9yIGV4YW1wbGVzCiAgICAgICAgJycnCgogICAgICAgIHNlbGYuX25hbWUgPSBvcy5wYXRoLmJhc2VuYW1lKF9fZmlsZV9fKSAjaW5pdGlhbGl6ZSBuYW1lIHVudGlsIHdlIGNhbiBwYXJzZSBmcm9tIG9wdGlvbnMKICAgICAgICBzZWxmLmFyZ3VtZW50X3NwZWMgPSBhcmd1bWVudF9zcGVjCiAgICAgICAgc2VsZi5zdXBwb3J0c19jaGVja19tb2RlID0gc3VwcG9ydHNfY2hlY2tfbW9kZQogICAgICAgIHNlbGYuY2hlY2tfbW9kZSA9IEZhbHNlCiAgICAgICAgc2VsZi5ub19sb2cgPSBub19sb2cKICAgICAgICBzZWxmLmNsZWFudXBfZmlsZXMgPSBbXQogICAgICAgIHNlbGYuX2RlYnVnID0gRmFsc2UKICAgICAgICBzZWxmLl9kaWZmID0gRmFsc2UKICAgICAgICBzZWxmLl9zb2NrZXRfcGF0aCA9IE5vbmUKICAgICAgICBzZWxmLl92ZXJib3NpdHkgPSAwCiAgICAgICAgIyBNYXkgYmUgdXNlZCB0byBzZXQgbW9kaWZpY2F0aW9ucyB0byB0aGUgZW52aXJvbm1lbnQgZm9yIGFueQogICAgICAgICMgcnVuX2NvbW1hbmQgaW52b2NhdGlvbgogICAgICAgIHNlbGYucnVuX2NvbW1hbmRfZW52aXJvbl91cGRhdGUgPSB7fQogICAgICAgIHNlbGYuX3dhcm5pbmdzID0gW10KICAgICAgICBzZWxmLl9kZXByZWNhdGlvbnMgPSBbXQoKICAgICAgICBzZWxmLmFsaWFzZXMgPSB7fQogICAgICAgIHNlbGYuX2xlZ2FsX2lucHV0cyA9IFsnX2Fuc2libGVfY2hlY2tfbW9kZScsICdfYW5zaWJsZV9ub19sb2cnLCAnX2Fuc2libGVfZGVidWcnLCAnX2Fuc2libGVfZGlmZicsICdfYW5zaWJsZV92ZXJib3NpdHknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnX2Fuc2libGVfc2VsaW51eF9zcGVjaWFsX2ZzJywgJ19hbnNpYmxlX21vZHVsZV9uYW1lJywgJ19hbnNpYmxlX3ZlcnNpb24nLCAnX2Fuc2libGVfc3lzbG9nX2ZhY2lsaXR5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ19hbnNpYmxlX3NvY2tldCddCgogICAgICAgIGlmIGFkZF9maWxlX2NvbW1vbl9hcmdzOgogICAgICAgICAgICBmb3IgaywgdiBpbiBGSUxFX0NPTU1PTl9BUkdVTUVOVFMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGsgbm90IGluIHNlbGYuYXJndW1lbnRfc3BlYzoKICAgICAgICAgICAgICAgICAgICBzZWxmLmFyZ3VtZW50X3NwZWNba10gPSB2CgogICAgICAgIHNlbGYuX2xvYWRfcGFyYW1zKCkKICAgICAgICBzZWxmLl9zZXRfZmFsbGJhY2tzKCkKCiAgICAgICAgIyBhcHBlbmQgdG8gbGVnYWxfaW5wdXRzIGFuZCB0aGVuIHBvc3NpYmx5IGNoZWNrIGFnYWluc3QgdGhlbQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5hbGlhc2VzID0gc2VsZi5faGFuZGxlX2FsaWFzZXMoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgIyBVc2UgZXhjZXB0aW9ucyBoZXJlIGJlY2F1c2UgaXQgaXNuJ3Qgc2FmZSB0byBjYWxsIGZhaWxfanNvbiB1bnRpbCBub19sb2cgaXMgcHJvY2Vzc2VkCiAgICAgICAgICAgIHByaW50KCdcbnsiZmFpbGVkIjogdHJ1ZSwgIm1zZyI6ICJNb2R1bGUgYWxpYXMgZXJyb3I6ICVzIn0nICUgc3RyKGUpKQogICAgICAgICAgICBzeXMuZXhpdCgxKQoKICAgICAgICAjIFNhdmUgcGFyYW1ldGVyIHZhbHVlcyB0aGF0IHNob3VsZCBuZXZlciBiZSBsb2dnZWQKICAgICAgICBzZWxmLm5vX2xvZ192YWx1ZXMgPSBzZXQoKQogICAgICAgICMgVXNlIHRoZSBhcmdzcGVjIHRvIGRldGVybWluZSB3aGljaCBhcmdzIGFyZSBub19sb2cKICAgICAgICBmb3IgYXJnX25hbWUsIGFyZ19vcHRzIGluIHNlbGYuYXJndW1lbnRfc3BlYy5pdGVtcygpOgogICAgICAgICAgICBpZiBhcmdfb3B0cy5nZXQoJ25vX2xvZycsIEZhbHNlKToKICAgICAgICAgICAgICAgICMgRmluZCB0aGUgdmFsdWUgZm9yIHRoZSBub19sb2cnZCBwYXJhbQogICAgICAgICAgICAgICAgbm9fbG9nX29iamVjdCA9IHNlbGYucGFyYW1zLmdldChhcmdfbmFtZSwgTm9uZSkKICAgICAgICAgICAgICAgIGlmIG5vX2xvZ19vYmplY3Q6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5ub19sb2dfdmFsdWVzLnVwZGF0ZShyZXR1cm5fdmFsdWVzKG5vX2xvZ19vYmplY3QpKQoKICAgICAgICAgICAgaWYgYXJnX29wdHMuZ2V0KCdyZW1vdmVkX2luX3ZlcnNpb24nKSBpcyBub3QgTm9uZSBhbmQgYXJnX25hbWUgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICBzZWxmLl9kZXByZWNhdGlvbnMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAnbXNnJzogIlBhcmFtICclcycgaXMgZGVwcmVjYXRlZC4gU2VlIHRoZSBtb2R1bGUgZG9jcyBmb3IgbW9yZSBpbmZvcm1hdGlvbiIgJSBhcmdfbmFtZSwKICAgICAgICAgICAgICAgICAgICAndmVyc2lvbic6IGFyZ19vcHRzLmdldCgncmVtb3ZlZF9pbl92ZXJzaW9uJykKICAgICAgICAgICAgICAgIH0pCgogICAgICAgICMgY2hlY2sgdGhlIGxvY2FsZSBhcyBzZXQgYnkgdGhlIGN1cnJlbnQgZW52aXJvbm1lbnQsIGFuZCByZXNldCB0bwogICAgICAgICMgYSBrbm93biB2YWxpZCAoTEFORz1DKSBpZiBpdCdzIGFuIGludmFsaWQvdW5hdmFpbGFibGUgbG9jYWxlCiAgICAgICAgc2VsZi5fY2hlY2tfbG9jYWxlKCkKCiAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRzKGNoZWNrX2ludmFsaWRfYXJndW1lbnRzKQoKICAgICAgICAjIGNoZWNrIGV4Y2x1c2l2ZSBlYXJseQogICAgICAgIGlmIG5vdCBieXBhc3NfY2hlY2tzOgogICAgICAgICAgICBzZWxmLl9jaGVja19tdXR1YWxseV9leGNsdXNpdmUobXV0dWFsbHlfZXhjbHVzaXZlKQoKICAgICAgICBzZWxmLl9zZXRfZGVmYXVsdHMocHJlPVRydWUpCgogICAgICAgIHNlbGYuX0NIRUNLX0FSR1VNRU5UX1RZUEVTX0RJU1BBVENIRVIgPSB7CiAgICAgICAgICAgICdzdHInOiBzZWxmLl9jaGVja190eXBlX3N0ciwKICAgICAgICAgICAgJ2xpc3QnOiBzZWxmLl9jaGVja190eXBlX2xpc3QsCiAgICAgICAgICAgICdkaWN0Jzogc2VsZi5fY2hlY2tfdHlwZV9kaWN0LAogICAgICAgICAgICAnYm9vbCc6IHNlbGYuX2NoZWNrX3R5cGVfYm9vbCwKICAgICAgICAgICAgJ2ludCc6IHNlbGYuX2NoZWNrX3R5cGVfaW50LAogICAgICAgICAgICAnZmxvYXQnOiBzZWxmLl9jaGVja190eXBlX2Zsb2F0LAogICAgICAgICAgICAncGF0aCc6IHNlbGYuX2NoZWNrX3R5cGVfcGF0aCwKICAgICAgICAgICAgJ3Jhdyc6IHNlbGYuX2NoZWNrX3R5cGVfcmF3LAogICAgICAgICAgICAnanNvbmFyZyc6IHNlbGYuX2NoZWNrX3R5cGVfanNvbmFyZywKICAgICAgICAgICAgJ2pzb24nOiBzZWxmLl9jaGVja190eXBlX2pzb25hcmcsCiAgICAgICAgICAgICdieXRlcyc6IHNlbGYuX2NoZWNrX3R5cGVfYnl0ZXMsCiAgICAgICAgICAgICdiaXRzJzogc2VsZi5fY2hlY2tfdHlwZV9iaXRzLAogICAgICAgIH0KICAgICAgICBpZiBub3QgYnlwYXNzX2NoZWNrczoKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfYXJndW1lbnRzKCkKICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdHlwZXMoKQogICAgICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudF92YWx1ZXMoKQogICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF90b2dldGhlcihyZXF1aXJlZF90b2dldGhlcikKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfb25lX29mKHJlcXVpcmVkX29uZV9vZikKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfaWYocmVxdWlyZWRfaWYpCgogICAgICAgIHNlbGYuX3NldF9kZWZhdWx0cyhwcmU9RmFsc2UpCgogICAgICAgIGlmIG5vdCBzZWxmLm5vX2xvZzoKICAgICAgICAgICAgc2VsZi5fbG9nX2ludm9jYXRpb24oKQoKICAgICAgICAjIGZpbmFsbHksIG1ha2Ugc3VyZSB3ZSdyZSBpbiBhIHNhbmUgd29ya2luZyBkaXIKICAgICAgICBzZWxmLl9zZXRfY3dkKCkKCiAgICBkZWYgd2FybihzZWxmLCB3YXJuaW5nKToKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh3YXJuaW5nLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBzZWxmLl93YXJuaW5ncy5hcHBlbmQod2FybmluZykKICAgICAgICAgICAgc2VsZi5sb2coJ1tXQVJOSU5HXSAlcycgJSB3YXJuaW5nKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigid2FybiByZXF1aXJlcyBhIHN0cmluZyBub3QgYSAlcyIgJSB0eXBlKHdhcm5pbmcpKQoKICAgIGRlZiBkZXByZWNhdGUoc2VsZiwgbXNnLCB2ZXJzaW9uPU5vbmUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UobXNnLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBzZWxmLl9kZXByZWNhdGlvbnMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICdtc2cnOiBtc2csCiAgICAgICAgICAgICAgICAndmVyc2lvbic6IHZlcnNpb24KICAgICAgICAgICAgfSkKICAgICAgICAgICAgc2VsZi5sb2coJ1tERVBSRUNBVElPTiBXQVJOSU5HXSAlcyAlcycgJSAobXNnLCB2ZXJzaW9uKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoImRlcHJlY2F0ZSByZXF1aXJlcyBhIHN0cmluZyBub3QgYSAlcyIgJSB0eXBlKG1zZykpCgogICAgZGVmIGxvYWRfZmlsZV9jb21tb25fYXJndW1lbnRzKHNlbGYsIHBhcmFtcyk6CiAgICAgICAgJycnCiAgICAgICAgbWFueSBtb2R1bGVzIGRlYWwgd2l0aCBmaWxlcywgdGhpcyBlbmNhcHN1bGF0ZXMgY29tbW9uCiAgICAgICAgb3B0aW9ucyB0aGF0IHRoZSBmaWxlIG1vZHVsZSBhY2NlcHRzIHN1Y2ggdGhhdCBpdCBpcyBkaXJlY3RseQogICAgICAgIGF2YWlsYWJsZSB0byBhbGwgbW9kdWxlcyBhbmQgdGhleSBjYW4gc2hhcmUgY29kZS4KICAgICAgICAnJycKCiAgICAgICAgcGF0aCA9IHBhcmFtcy5nZXQoJ3BhdGgnLCBwYXJhbXMuZ2V0KCdkZXN0JywgTm9uZSkpCiAgICAgICAgaWYgcGF0aCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4ge30KICAgICAgICBlbHNlOgogICAgICAgICAgICBwYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhwYXRoKSkKCiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICAjIGlmIHRoZSBwYXRoIGlzIGEgc3ltbGluaywgYW5kIHdlJ3JlIGZvbGxvd2luZyBsaW5rcywgZ2V0CiAgICAgICAgIyB0aGUgdGFyZ2V0IG9mIHRoZSBsaW5rIGluc3RlYWQgZm9yIHRlc3RpbmcKICAgICAgICBpZiBwYXJhbXMuZ2V0KCdmb2xsb3cnLCBGYWxzZSkgYW5kIG9zLnBhdGguaXNsaW5rKGJfcGF0aCk6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGgucmVhbHBhdGgoYl9wYXRoKQogICAgICAgICAgICBwYXRoID0gdG9fbmF0aXZlKGJfcGF0aCkKCiAgICAgICAgbW9kZSAgID0gcGFyYW1zLmdldCgnbW9kZScsIE5vbmUpCiAgICAgICAgb3duZXIgID0gcGFyYW1zLmdldCgnb3duZXInLCBOb25lKQogICAgICAgIGdyb3VwICA9IHBhcmFtcy5nZXQoJ2dyb3VwJywgTm9uZSkKCiAgICAgICAgIyBzZWxpbnV4IHJlbGF0ZWQgb3B0aW9ucwogICAgICAgIHNldXNlciAgICA9IHBhcmFtcy5nZXQoJ3NldXNlcicsIE5vbmUpCiAgICAgICAgc2Vyb2xlICAgID0gcGFyYW1zLmdldCgnc2Vyb2xlJywgTm9uZSkKICAgICAgICBzZXR5cGUgICAgPSBwYXJhbXMuZ2V0KCdzZXR5cGUnLCBOb25lKQogICAgICAgIHNlbGV2ZWwgICA9IHBhcmFtcy5nZXQoJ3NlbGV2ZWwnLCBOb25lKQogICAgICAgIHNlY29udGV4dCA9IFtzZXVzZXIsIHNlcm9sZSwgc2V0eXBlXQoKICAgICAgICBpZiBzZWxmLnNlbGludXhfbWxzX2VuYWJsZWQoKToKICAgICAgICAgICAgc2Vjb250ZXh0LmFwcGVuZChzZWxldmVsKQoKICAgICAgICBkZWZhdWx0X3NlY29udGV4dCA9IHNlbGYuc2VsaW51eF9kZWZhdWx0X2NvbnRleHQocGF0aCkKICAgICAgICBmb3IgaSBpbiByYW5nZShsZW4oZGVmYXVsdF9zZWNvbnRleHQpKToKICAgICAgICAgICAgaWYgaSBpcyBub3QgTm9uZSBhbmQgc2Vjb250ZXh0W2ldID09ICdfZGVmYXVsdCc6CiAgICAgICAgICAgICAgICBzZWNvbnRleHRbaV0gPSBkZWZhdWx0X3NlY29udGV4dFtpXQoKICAgICAgICBhdHRyaWJ1dGVzID0gcGFyYW1zLmdldCgnYXR0cmlidXRlcycsIE5vbmUpCiAgICAgICAgcmV0dXJuIGRpY3QoCiAgICAgICAgICAgIHBhdGg9cGF0aCwgbW9kZT1tb2RlLCBvd25lcj1vd25lciwgZ3JvdXA9Z3JvdXAsCiAgICAgICAgICAgIHNldXNlcj1zZXVzZXIsIHNlcm9sZT1zZXJvbGUsIHNldHlwZT1zZXR5cGUsCiAgICAgICAgICAgIHNlbGV2ZWw9c2VsZXZlbCwgc2Vjb250ZXh0PXNlY29udGV4dCwgYXR0cmlidXRlcz1hdHRyaWJ1dGVzLAogICAgICAgICkKCgogICAgIyBEZXRlY3Qgd2hldGhlciB1c2luZyBzZWxpbnV4IHRoYXQgaXMgTUxTLWF3YXJlLgogICAgIyBXaGlsZSB0aGlzIG1lYW5zIHlvdSBjYW4gc2V0IHRoZSBsZXZlbC9yYW5nZSB3aXRoCiAgICAjIHNlbGludXgubHNldGZpbGVjb24oKSwgaXQgbWF5IG9yIG1heSBub3QgbWVhbiB0aGF0IHlvdQogICAgIyB3aWxsIGdldCB0aGUgc2VsZXZlbCBhcyBwYXJ0IG9mIHRoZSBjb250ZXh0IHJldHVybmVkCiAgICAjIGJ5IHNlbGludXgubGdldGZpbGVjb24oKS4KCiAgICBkZWYgc2VsaW51eF9tbHNfZW5hYmxlZChzZWxmKToKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBpZiBzZWxpbnV4LmlzX3NlbGludXhfbWxzX2VuYWJsZWQoKSA9PSAxOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBzZWxpbnV4X2VuYWJsZWQoc2VsZik6CiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWDoKICAgICAgICAgICAgc2VlbmFibGVkID0gc2VsZi5nZXRfYmluX3BhdGgoJ3NlbGludXhlbmFibGVkJykKICAgICAgICAgICAgaWYgc2VlbmFibGVkIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgKHJjLG91dCxlcnIpID0gc2VsZi5ydW5fY29tbWFuZChzZWVuYWJsZWQpCiAgICAgICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iQWJvcnRpbmcsIHRhcmdldCB1c2VzIHNlbGludXggYnV0IHB5dGhvbiBiaW5kaW5ncyAobGlic2VsaW51eC1weXRob24pIGFyZW4ndCBpbnN0YWxsZWQhIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgaWYgc2VsaW51eC5pc19zZWxpbnV4X2VuYWJsZWQoKSA9PSAxOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICMgRGV0ZXJtaW5lIHdoZXRoZXIgd2UgbmVlZCBhIHBsYWNlaG9sZGVyIGZvciBzZWxldmVsL21scwogICAgZGVmIHNlbGludXhfaW5pdGlhbF9jb250ZXh0KHNlbGYpOgogICAgICAgIGNvbnRleHQgPSBbTm9uZSwgTm9uZSwgTm9uZV0KICAgICAgICBpZiBzZWxmLnNlbGludXhfbWxzX2VuYWJsZWQoKToKICAgICAgICAgICAgY29udGV4dC5hcHBlbmQoTm9uZSkKICAgICAgICByZXR1cm4gY29udGV4dAoKICAgICMgSWYgc2VsaW51eCBmYWlscyB0byBmaW5kIGEgZGVmYXVsdCwgcmV0dXJuIGFuIGFycmF5IG9mIE5vbmUKICAgIGRlZiBzZWxpbnV4X2RlZmF1bHRfY29udGV4dChzZWxmLCBwYXRoLCBtb2RlPTApOgogICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfaW5pdGlhbF9jb250ZXh0KCkKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYIG9yIG5vdCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0ID0gc2VsaW51eC5tYXRjaHBhdGhjb24odG9fbmF0aXZlKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpLCBtb2RlKQogICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgIGlmIHJldFswXSA9PSAtMToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICAjIExpbWl0IHNwbGl0IHRvIDQgYmVjYXVzZSB0aGUgc2VsZXZlbCwgdGhlIGxhc3QgaW4gdGhlIGxpc3QsCiAgICAgICAgIyBtYXkgY29udGFpbiAnOicgY2hhcmFjdGVycwogICAgICAgIGNvbnRleHQgPSByZXRbMV0uc3BsaXQoJzonLCAzKQogICAgICAgIHJldHVybiBjb250ZXh0CgogICAgZGVmIHNlbGludXhfY29udGV4dChzZWxmLCBwYXRoKToKICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2luaXRpYWxfY29udGV4dCgpCiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldCA9IHNlbGludXgubGdldGZpbGVjb25fcmF3KHRvX25hdGl2ZShwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKSkKICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBpZiBlLmVycm5vID09IGVycm5vLkVOT0VOVDoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdwYXRoICVzIGRvZXMgbm90IGV4aXN0JyAlIHBhdGgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nZmFpbGVkIHRvIHJldHJpZXZlIHNlbGludXggY29udGV4dCcpCiAgICAgICAgaWYgcmV0WzBdID09IC0xOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgICMgTGltaXQgc3BsaXQgdG8gNCBiZWNhdXNlIHRoZSBzZWxldmVsLCB0aGUgbGFzdCBpbiB0aGUgbGlzdCwKICAgICAgICAjIG1heSBjb250YWluICc6JyBjaGFyYWN0ZXJzCiAgICAgICAgY29udGV4dCA9IHJldFsxXS5zcGxpdCgnOicsIDMpCiAgICAgICAgcmV0dXJuIGNvbnRleHQKCiAgICBkZWYgdXNlcl9hbmRfZ3JvdXAoc2VsZiwgcGF0aCwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBzdCA9IG9zLmxzdGF0KGJfcGF0aCkKICAgICAgICB1aWQgPSBzdC5zdF91aWQKICAgICAgICBnaWQgPSBzdC5zdF9naWQKICAgICAgICByZXR1cm4gKHVpZCwgZ2lkKQoKICAgIGRlZiBmaW5kX21vdW50X3BvaW50KHNlbGYsIHBhdGgpOgogICAgICAgIHBhdGhfaXNfYnl0ZXMgPSBGYWxzZQogICAgICAgIGlmIGlzaW5zdGFuY2UocGF0aCwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICBwYXRoX2lzX2J5dGVzID0gVHJ1ZQoKICAgICAgICBiX3BhdGggPSBvcy5wYXRoLnJlYWxwYXRoKHRvX2J5dGVzKG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMocGF0aCkpLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKSkKICAgICAgICB3aGlsZSBub3Qgb3MucGF0aC5pc21vdW50KGJfcGF0aCk6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZGlybmFtZShiX3BhdGgpCgogICAgICAgIGlmIHBhdGhfaXNfYnl0ZXM6CiAgICAgICAgICAgIHJldHVybiBiX3BhdGgKCiAgICAgICAgcmV0dXJuIHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQoKICAgIGRlZiBpc19zcGVjaWFsX3NlbGludXhfcGF0aChzZWxmLCBwYXRoKToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm5zIGEgdHVwbGUgY29udGFpbmluZyAoVHJ1ZSwgc2VsaW51eF9jb250ZXh0KSBpZiB0aGUgZ2l2ZW4gcGF0aCBpcyBvbiBhCiAgICAgICAgTkZTIG9yIG90aGVyICdzcGVjaWFsJyBmcyAgbW91bnQgcG9pbnQsIG90aGVyd2lzZSB0aGUgcmV0dXJuIHdpbGwgYmUgKEZhbHNlLCBOb25lKS4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGYgPSBvcGVuKCcvcHJvYy9tb3VudHMnLCAncicpCiAgICAgICAgICAgIG1vdW50X2RhdGEgPSBmLnJlYWRsaW5lcygpCiAgICAgICAgICAgIGYuY2xvc2UoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcmV0dXJuIChGYWxzZSwgTm9uZSkKICAgICAgICBwYXRoX21vdW50X3BvaW50ID0gc2VsZi5maW5kX21vdW50X3BvaW50KHBhdGgpCiAgICAgICAgZm9yIGxpbmUgaW4gbW91bnRfZGF0YToKICAgICAgICAgICAgKGRldmljZSwgbW91bnRfcG9pbnQsIGZzdHlwZSwgb3B0aW9ucywgcmVzdCkgPSBsaW5lLnNwbGl0KCcgJywgNCkKCiAgICAgICAgICAgIGlmIHBhdGhfbW91bnRfcG9pbnQgPT0gbW91bnRfcG9pbnQ6CiAgICAgICAgICAgICAgICBmb3IgZnMgaW4gc2VsZi5fc2VsaW51eF9zcGVjaWFsX2ZzOgogICAgICAgICAgICAgICAgICAgIGlmIGZzIGluIGZzdHlwZToKICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lhbF9jb250ZXh0ID0gc2VsZi5zZWxpbnV4X2NvbnRleHQocGF0aF9tb3VudF9wb2ludCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChUcnVlLCBzcGVjaWFsX2NvbnRleHQpCgogICAgICAgIHJldHVybiAoRmFsc2UsIE5vbmUpCgogICAgZGVmIHNldF9kZWZhdWx0X3NlbGludXhfY29udGV4dChzZWxmLCBwYXRoLCBjaGFuZ2VkKToKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYIG9yIG5vdCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAogICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfZGVmYXVsdF9jb250ZXh0KHBhdGgpCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KHBhdGgsIGNvbnRleHQsIEZhbHNlKQoKICAgIGRlZiBzZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgY29udGV4dCwgY2hhbmdlZCwgZGlmZj1Ob25lKToKCiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKICAgICAgICBjdXJfY29udGV4dCA9IHNlbGYuc2VsaW51eF9jb250ZXh0KHBhdGgpCiAgICAgICAgbmV3X2NvbnRleHQgPSBsaXN0KGN1cl9jb250ZXh0KQogICAgICAgICMgSXRlcmF0ZSBvdmVyIHRoZSBjdXJyZW50IGNvbnRleHQgaW5zdGVhZCBvZiB0aGUKICAgICAgICAjIGFyZ3VtZW50IGNvbnRleHQsIHdoaWNoIG1heSBoYXZlIHNlbGV2ZWwuCgogICAgICAgIChpc19zcGVjaWFsX3NlLCBzcF9jb250ZXh0KSA9IHNlbGYuaXNfc3BlY2lhbF9zZWxpbnV4X3BhdGgocGF0aCkKICAgICAgICBpZiBpc19zcGVjaWFsX3NlOgogICAgICAgICAgICBuZXdfY29udGV4dCA9IHNwX2NvbnRleHQKICAgICAgICBlbHNlOgogICAgICAgICAgICBmb3IgaSBpbiByYW5nZShsZW4oY3VyX2NvbnRleHQpKToKICAgICAgICAgICAgICAgIGlmIGxlbihjb250ZXh0KSA+IGk6CiAgICAgICAgICAgICAgICAgICAgaWYgY29udGV4dFtpXSBpcyBub3QgTm9uZSBhbmQgY29udGV4dFtpXSAhPSBjdXJfY29udGV4dFtpXToKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2NvbnRleHRbaV0gPSBjb250ZXh0W2ldCiAgICAgICAgICAgICAgICAgICAgZWxpZiBjb250ZXh0W2ldIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld19jb250ZXh0W2ldID0gY3VyX2NvbnRleHRbaV0KCiAgICAgICAgaWYgY3VyX2NvbnRleHQgIT0gbmV3X2NvbnRleHQ6CiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnc2Vjb250ZXh0J10gPSBjdXJfY29udGV4dAogICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ3NlY29udGV4dCddID0gbmV3X2NvbnRleHQKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgcmMgPSBzZWxpbnV4LmxzZXRmaWxlY29uKHRvX25hdGl2ZShwYXRoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHIoJzonLmpvaW4obmV3X2NvbnRleHQpKSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0naW52YWxpZCBzZWxpbnV4IGNvbnRleHQ6ICVzJyAlIHN0cihlKSwgbmV3X2NvbnRleHQ9bmV3X2NvbnRleHQsIGN1cl9jb250ZXh0PWN1cl9jb250ZXh0LCBpbnB1dF93YXM9Y29udGV4dCkKICAgICAgICAgICAgaWYgcmMgIT0gMDoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdzZXQgc2VsaW51eCBjb250ZXh0IGZhaWxlZCcpCiAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X293bmVyX2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBvd25lciwgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHBhdGggPSB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIG93bmVyIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCiAgICAgICAgb3JpZ191aWQsIG9yaWdfZ2lkID0gc2VsZi51c2VyX2FuZF9ncm91cChwYXRoLCBleHBhbmQpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB1aWQgPSBpbnQob3duZXIpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHVpZCA9IHB3ZC5nZXRwd25hbShvd25lcikucHdfdWlkCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaG93biBmYWlsZWQ6IGZhaWxlZCB0byBsb29rIHVwIHVzZXIgJXMnICUgb3duZXIpCiAgICAgICAgaWYgb3JpZ191aWQgIT0gdWlkOgoKICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmICdiZWZvcmUnIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydvd25lciddID0gb3JpZ191aWQKICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydvd25lciddID0gdWlkCgogICAgICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5sY2hvd24oYl9wYXRoLCB1aWQsIC0xKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaG93biBmYWlsZWQnKQogICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9ncm91cF9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgZ3JvdXAsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBwYXRoID0gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBncm91cCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAogICAgICAgIG9yaWdfdWlkLCBvcmlnX2dpZCA9IHNlbGYudXNlcl9hbmRfZ3JvdXAoYl9wYXRoLCBleHBhbmQpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBnaWQgPSBpbnQoZ3JvdXApCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGdpZCA9IGdycC5nZXRncm5hbShncm91cCkuZ3JfZ2lkCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaGdycCBmYWlsZWQ6IGZhaWxlZCB0byBsb29rIHVwIGdyb3VwICVzJyAlIGdyb3VwKQogICAgICAgIGlmIG9yaWdfZ2lkICE9IGdpZDoKCiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnZ3JvdXAnXSA9IG9yaWdfZ2lkCiAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnZ3JvdXAnXSA9IGdpZAoKICAgICAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MubGNob3duKGJfcGF0aCwgLTEsIGdpZCkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hncnAgZmFpbGVkJykKICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfbW9kZV9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgbW9kZSwgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHBhdGggPSB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIHBhdGhfc3RhdCA9IG9zLmxzdGF0KGJfcGF0aCkKCiAgICAgICAgaWYgbW9kZSBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShtb2RlLCBpbnQpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBtb2RlID0gaW50KG1vZGUsIDgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbW9kZSA9IHNlbGYuX3N5bWJvbGljX21vZGVfdG9fb2N0YWwocGF0aF9zdGF0LCBtb2RlKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZz0ibW9kZSBtdXN0IGJlIGluIG9jdGFsIG9yIHN5bWJvbGljIGZvcm0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldGFpbHM9c3RyKGUpKQoKICAgICAgICAgICAgICAgIGlmIG1vZGUgIT0gc3RhdC5TX0lNT0RFKG1vZGUpOgogICAgICAgICAgICAgICAgICAgICMgcHJldmVudCBtb2RlIGZyb20gaGF2aW5nIGV4dHJhIGluZm8gb3JiZWluZyBpbnZhbGlkIGxvbmcgbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9IkludmFsaWQgbW9kZSBzdXBwbGllZCwgb25seSBwZXJtaXNzaW9uIGluZm8gaXMgYWxsb3dlZCIsIGRldGFpbHM9bW9kZSkKCiAgICAgICAgcHJldl9tb2RlID0gc3RhdC5TX0lNT0RFKHBhdGhfc3RhdC5zdF9tb2RlKQoKICAgICAgICBpZiBwcmV2X21vZGUgIT0gbW9kZToKCiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnbW9kZSddID0gJzAlMDNvJyAlIHByZXZfbW9kZQogICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ21vZGUnXSA9ICcwJTAzbycgJSBtb2RlCgogICAgICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAjIEZJWE1FOiBjb21wYXJpc29uIGFnYWluc3Qgc3RyaW5nIGFib3ZlIHdpbGwgY2F1c2UgdGhpcyB0byBiZSBleGVjdXRlZAogICAgICAgICAgICAjIGV2ZXJ5IHRpbWUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihvcywgJ2xjaG1vZCcpOgogICAgICAgICAgICAgICAgICAgIG9zLmxjaG1vZChiX3BhdGgsIG1vZGUpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzbGluayhiX3BhdGgpOgogICAgICAgICAgICAgICAgICAgICAgICBvcy5jaG1vZChiX3BhdGgsIG1vZGUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBBdHRlbXB0IHRvIHNldCB0aGUgcGVybXMgb2YgdGhlIHN5bWxpbmsgYnV0IGJlCiAgICAgICAgICAgICAgICAgICAgICAgICMgY2FyZWZ1bCBub3QgdG8gY2hhbmdlIHRoZSBwZXJtcyBvZiB0aGUgdW5kZXJseWluZwogICAgICAgICAgICAgICAgICAgICAgICAjIGZpbGUgd2hpbGUgdHJ5aW5nCiAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVybHlpbmdfc3RhdCA9IG9zLnN0YXQoYl9wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICBvcy5jaG1vZChiX3BhdGgsIG1vZGUpCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld191bmRlcmx5aW5nX3N0YXQgPSBvcy5zdGF0KGJfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdW5kZXJseWluZ19zdGF0LnN0X21vZGUgIT0gbmV3X3VuZGVybHlpbmdfc3RhdC5zdF9tb2RlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2htb2QoYl9wYXRoLCBzdGF0LlNfSU1PREUodW5kZXJseWluZ19zdGF0LnN0X21vZGUpKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguaXNsaW5rKGJfcGF0aCkgYW5kIGUuZXJybm8gPT0gZXJybm8uRVBFUk06ICAjIENhbid0IHNldCBtb2RlIG9uIHN5bWJvbGljIGxpbmtzCiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgZWxpZiBlLmVycm5vIGluIChlcnJuby5FTk9FTlQsIGVycm5vLkVMT09QKTogIyBDYW4ndCBzZXQgbW9kZSBvbiBicm9rZW4gc3ltYm9saWMgbGlua3MKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIGUKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaG1vZCBmYWlsZWQnLCBkZXRhaWxzPXN0cihlKSkKCiAgICAgICAgICAgIHBhdGhfc3RhdCA9IG9zLmxzdGF0KGJfcGF0aCkKICAgICAgICAgICAgbmV3X21vZGUgPSBzdGF0LlNfSU1PREUocGF0aF9zdGF0LnN0X21vZGUpCgogICAgICAgICAgICBpZiBuZXdfbW9kZSAhPSBwcmV2X21vZGU6CiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBhdHRyaWJ1dGVzLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKCiAgICAgICAgaWYgYXR0cmlidXRlcyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgcGF0aCA9IHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCgogICAgICAgIGV4aXN0aW5nID0gc2VsZi5nZXRfZmlsZV9hdHRyaWJ1dGVzKGJfcGF0aCkKCiAgICAgICAgaWYgZXhpc3RpbmcuZ2V0KCdhdHRyX2ZsYWdzJywnJykgIT0gYXR0cmlidXRlczoKICAgICAgICAgICAgYXR0cmNtZCA9IHNlbGYuZ2V0X2Jpbl9wYXRoKCdjaGF0dHInKQogICAgICAgICAgICBpZiBhdHRyY21kOgogICAgICAgICAgICAgICAgYXR0cmNtZCA9IFthdHRyY21kLCAnPSVzJyAlIGF0dHJpYnV0ZXMsIGJfcGF0aF0KICAgICAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCgogICAgICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydhdHRyaWJ1dGVzJ10gPSBleGlzdGluZy5nZXQoJ2F0dHJfZmxhZ3MnKQogICAgICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ2F0dHJpYnV0ZXMnXSA9IGF0dHJpYnV0ZXMKCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5ydW5fY29tbWFuZChhdHRyY21kKQogICAgICAgICAgICAgICAgICAgICAgICBpZiByYyAhPSAwIG9yIGVycjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiRXJyb3Igd2hpbGUgc2V0dGluZyBhdHRyaWJ1dGVzOiAlcyIgJSAob3V0ICsgZXJyKSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2NoYXR0ciBmYWlsZWQnLCBkZXRhaWxzPXN0cihlKSkKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBnZXRfZmlsZV9hdHRyaWJ1dGVzKHNlbGYsIHBhdGgpOgogICAgICAgIG91dHB1dCA9IHt9CiAgICAgICAgYXR0cmNtZCA9IHNlbGYuZ2V0X2Jpbl9wYXRoKCdsc2F0dHInLCBGYWxzZSkKICAgICAgICBpZiBhdHRyY21kOgogICAgICAgICAgICBhdHRyY21kID0gW2F0dHJjbWQsICctdmQnLCBwYXRoXQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLnJ1bl9jb21tYW5kKGF0dHJjbWQpCiAgICAgICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgICAgIHJlcyA9IG91dC5zcGxpdCgnICcpWzA6Ml0KICAgICAgICAgICAgICAgICAgICBvdXRwdXRbJ2F0dHJfZmxhZ3MnXSA9ICByZXNbMV0ucmVwbGFjZSgnLScsJycpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBvdXRwdXRbJ3ZlcnNpb24nXSA9IHJlc1swXS5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0WydhdHRyaWJ1dGVzJ10gPSBmb3JtYXRfYXR0cmlidXRlcyhvdXRwdXRbJ2F0dHJfZmxhZ3MnXSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBvdXRwdXQKCgogICAgZGVmIF9zeW1ib2xpY19tb2RlX3RvX29jdGFsKHNlbGYsIHBhdGhfc3RhdCwgc3ltYm9saWNfbW9kZSk6CiAgICAgICAgbmV3X21vZGUgPSBzdGF0LlNfSU1PREUocGF0aF9zdGF0LnN0X21vZGUpCgogICAgICAgIG1vZGVfcmUgPSByZS5jb21waWxlKHInXig/UDx1c2Vycz5bdWdvYV0rKSg/UDxvcGVyYXRvcj5bLSs9XSkoP1A8cGVybXM+W3J3eFhzdC1dKnxbdWdvXSkkJykKICAgICAgICBmb3IgbW9kZSBpbiBzeW1ib2xpY19tb2RlLnNwbGl0KCcsJyk6CiAgICAgICAgICAgIG1hdGNoID0gbW9kZV9yZS5tYXRjaChtb2RlKQogICAgICAgICAgICBpZiBtYXRjaDoKICAgICAgICAgICAgICAgIHVzZXJzID0gbWF0Y2guZ3JvdXAoJ3VzZXJzJykKICAgICAgICAgICAgICAgIG9wZXJhdG9yID0gbWF0Y2guZ3JvdXAoJ29wZXJhdG9yJykKICAgICAgICAgICAgICAgIHBlcm1zID0gbWF0Y2guZ3JvdXAoJ3Blcm1zJykKCiAgICAgICAgICAgICAgICBpZiB1c2VycyA9PSAnYSc6CiAgICAgICAgICAgICAgICAgICAgdXNlcnMgPSAndWdvJwoKICAgICAgICAgICAgICAgIGZvciB1c2VyIGluIHVzZXJzOgogICAgICAgICAgICAgICAgICAgIG1vZGVfdG9fYXBwbHkgPSBzZWxmLl9nZXRfb2N0YWxfbW9kZV9mcm9tX3N5bWJvbGljX3Blcm1zKHBhdGhfc3RhdCwgdXNlciwgcGVybXMpCiAgICAgICAgICAgICAgICAgICAgbmV3X21vZGUgPSBzZWxmLl9hcHBseV9vcGVyYXRpb25fdG9fbW9kZSh1c2VyLCBvcGVyYXRvciwgbW9kZV90b19hcHBseSwgbmV3X21vZGUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJiYWQgc3ltYm9saWMgcGVybWlzc2lvbiBmb3IgbW9kZTogJXMiICUgbW9kZSkKICAgICAgICByZXR1cm4gbmV3X21vZGUKCiAgICBkZWYgX2FwcGx5X29wZXJhdGlvbl90b19tb2RlKHNlbGYsIHVzZXIsIG9wZXJhdG9yLCBtb2RlX3RvX2FwcGx5LCBjdXJyZW50X21vZGUpOgogICAgICAgIGlmIG9wZXJhdG9yICA9PSAgJz0nOgogICAgICAgICAgICBpZiB1c2VyID09ICd1JzoKICAgICAgICAgICAgICAgIG1hc2sgPSBzdGF0LlNfSVJXWFUgfCBzdGF0LlNfSVNVSUQKICAgICAgICAgICAgZWxpZiB1c2VyID09ICdnJzoKICAgICAgICAgICAgICAgIG1hc2sgPSBzdGF0LlNfSVJXWEcgfCBzdGF0LlNfSVNHSUQKICAgICAgICAgICAgZWxpZiB1c2VyID09ICdvJzoKICAgICAgICAgICAgICAgIG1hc2sgPSBzdGF0LlNfSVJXWE8gfCBzdGF0LlNfSVNWVFgKCiAgICAgICAgICAgICMgbWFzayBvdXQgdSwgZywgb3IgbyBwZXJtaXNzaW9ucyBmcm9tIGN1cnJlbnRfbW9kZSBhbmQgYXBwbHkgbmV3IHBlcm1pc3Npb25zCiAgICAgICAgICAgIGludmVyc2VfbWFzayA9IG1hc2sgXiBQRVJNX0JJVFMKICAgICAgICAgICAgbmV3X21vZGUgPSAoY3VycmVudF9tb2RlICYgaW52ZXJzZV9tYXNrKSB8IG1vZGVfdG9fYXBwbHkKICAgICAgICBlbGlmIG9wZXJhdG9yID09ICcrJzoKICAgICAgICAgICAgbmV3X21vZGUgPSBjdXJyZW50X21vZGUgfCBtb2RlX3RvX2FwcGx5CiAgICAgICAgZWxpZiBvcGVyYXRvciA9PSAnLSc6CiAgICAgICAgICAgIG5ld19tb2RlID0gY3VycmVudF9tb2RlIC0gKGN1cnJlbnRfbW9kZSAmIG1vZGVfdG9fYXBwbHkpCiAgICAgICAgcmV0dXJuIG5ld19tb2RlCgogICAgZGVmIF9nZXRfb2N0YWxfbW9kZV9mcm9tX3N5bWJvbGljX3Blcm1zKHNlbGYsIHBhdGhfc3RhdCwgdXNlciwgcGVybXMpOgogICAgICAgIHByZXZfbW9kZSA9IHN0YXQuU19JTU9ERShwYXRoX3N0YXQuc3RfbW9kZSkKCiAgICAgICAgaXNfZGlyZWN0b3J5ID0gc3RhdC5TX0lTRElSKHBhdGhfc3RhdC5zdF9tb2RlKQogICAgICAgIGhhc194X3Blcm1pc3Npb25zID0gKHByZXZfbW9kZSAmIEVYRUNfUEVSTV9CSVRTKSA+IDAKICAgICAgICBhcHBseV9YX3Blcm1pc3Npb24gPSBpc19kaXJlY3Rvcnkgb3IgaGFzX3hfcGVybWlzc2lvbnMKCiAgICAgICAgIyBQZXJtaXNzaW9uIGJpdHMgY29uc3RhbnRzIGRvY3VtZW50ZWQgYXQ6CiAgICAgICAgIyBodHRwOi8vZG9jcy5weXRob24ub3JnLzIvbGlicmFyeS9zdGF0Lmh0bWwjc3RhdC5TX0lTVUlECiAgICAgICAgaWYgYXBwbHlfWF9wZXJtaXNzaW9uOgogICAgICAgICAgICBYX3Blcm1zID0gewogICAgICAgICAgICAgICAgJ3UnOiB7J1gnOiBzdGF0LlNfSVhVU1J9LAogICAgICAgICAgICAgICAgJ2cnOiB7J1gnOiBzdGF0LlNfSVhHUlB9LAogICAgICAgICAgICAgICAgJ28nOiB7J1gnOiBzdGF0LlNfSVhPVEh9CiAgICAgICAgICAgIH0KICAgICAgICBlbHNlOgogICAgICAgICAgICBYX3Blcm1zID0gewogICAgICAgICAgICAgICAgJ3UnOiB7J1gnOiAwfSwKICAgICAgICAgICAgICAgICdnJzogeydYJzogMH0sCiAgICAgICAgICAgICAgICAnbyc6IHsnWCc6IDB9CiAgICAgICAgICAgIH0KCiAgICAgICAgdXNlcl9wZXJtc190b19tb2RlcyA9IHsKICAgICAgICAgICAgJ3UnOiB7CiAgICAgICAgICAgICAgICAncic6IHN0YXQuU19JUlVTUiwKICAgICAgICAgICAgICAgICd3Jzogc3RhdC5TX0lXVVNSLAogICAgICAgICAgICAgICAgJ3gnOiBzdGF0LlNfSVhVU1IsCiAgICAgICAgICAgICAgICAncyc6IHN0YXQuU19JU1VJRCwKICAgICAgICAgICAgICAgICd0JzogMCwKICAgICAgICAgICAgICAgICd1JzogcHJldl9tb2RlICYgc3RhdC5TX0lSV1hVLAogICAgICAgICAgICAgICAgJ2cnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hHKSA8PCAzLAogICAgICAgICAgICAgICAgJ28nOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hPKSA8PCA2IH0sCiAgICAgICAgICAgICdnJzogewogICAgICAgICAgICAgICAgJ3InOiBzdGF0LlNfSVJHUlAsCiAgICAgICAgICAgICAgICAndyc6IHN0YXQuU19JV0dSUCwKICAgICAgICAgICAgICAgICd4Jzogc3RhdC5TX0lYR1JQLAogICAgICAgICAgICAgICAgJ3MnOiBzdGF0LlNfSVNHSUQsCiAgICAgICAgICAgICAgICAndCc6IDAsCiAgICAgICAgICAgICAgICAndSc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWFUpID4+IDMsCiAgICAgICAgICAgICAgICAnZyc6IHByZXZfbW9kZSAmIHN0YXQuU19JUldYRywKICAgICAgICAgICAgICAgICdvJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYTykgPDwgMyB9LAogICAgICAgICAgICAnbyc6IHsKICAgICAgICAgICAgICAgICdyJzogc3RhdC5TX0lST1RILAogICAgICAgICAgICAgICAgJ3cnOiBzdGF0LlNfSVdPVEgsCiAgICAgICAgICAgICAgICAneCc6IHN0YXQuU19JWE9USCwKICAgICAgICAgICAgICAgICdzJzogMCwKICAgICAgICAgICAgICAgICd0Jzogc3RhdC5TX0lTVlRYLAogICAgICAgICAgICAgICAgJ3UnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hVKSA+PiA2LAogICAgICAgICAgICAgICAgJ2cnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hHKSA+PiAzLAogICAgICAgICAgICAgICAgJ28nOiBwcmV2X21vZGUgJiBzdGF0LlNfSVJXWE8gfQogICAgICAgIH0KCiAgICAgICAgIyBJbnNlcnQgWF9wZXJtcyBpbnRvIHVzZXJfcGVybXNfdG9fbW9kZXMKICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBYX3Blcm1zLml0ZW1zKCk6CiAgICAgICAgICAgIHVzZXJfcGVybXNfdG9fbW9kZXNba2V5XS51cGRhdGUodmFsdWUpCgogICAgICAgIG9yX3JlZHVjZSA9IGxhbWJkYSBtb2RlLCBwZXJtOiBtb2RlIHwgdXNlcl9wZXJtc190b19tb2Rlc1t1c2VyXVtwZXJtXQogICAgICAgIHJldHVybiByZWR1Y2Uob3JfcmVkdWNlLCBwZXJtcywgMCkKCiAgICBkZWYgc2V0X2ZzX2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KHNlbGYsIGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgIyBzZXQgbW9kZXMgb3duZXJzIGFuZCBjb250ZXh0IGFzIG5lZWRlZAogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snc2Vjb250ZXh0J10sIGNoYW5nZWQsIGRpZmYKICAgICAgICApCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X293bmVyX2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snb3duZXInXSwgY2hhbmdlZCwgZGlmZiwgZXhwYW5kCiAgICAgICAgKQogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9ncm91cF9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ2dyb3VwJ10sIGNoYW5nZWQsIGRpZmYsIGV4cGFuZAogICAgICAgICkKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfbW9kZV9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ21vZGUnXSwgY2hhbmdlZCwgZGlmZiwgZXhwYW5kCiAgICAgICAgKQogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snYXR0cmlidXRlcyddLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQKICAgICAgICApCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X2RpcmVjdG9yeV9hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChzZWxmLCBmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIHJldHVybiBzZWxmLnNldF9mc19hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmYsIGV4cGFuZCkKCiAgICBkZWYgc2V0X2ZpbGVfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoc2VsZiwgZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICByZXR1cm4gc2VsZi5zZXRfZnNfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQpCgogICAgZGVmIGFkZF9wYXRoX2luZm8oc2VsZiwga3dhcmdzKToKICAgICAgICAnJycKICAgICAgICBmb3IgcmVzdWx0cyB0aGF0IGFyZSBmaWxlcywgc3VwcGxlbWVudCB0aGUgaW5mbyBhYm91dCB0aGUgZmlsZQogICAgICAgIGluIHRoZSByZXR1cm4gcGF0aCB3aXRoIHN0YXRzIGFib3V0IHRoZSBmaWxlIHBhdGguCiAgICAgICAgJycnCgogICAgICAgIHBhdGggPSBrd2FyZ3MuZ2V0KCdwYXRoJywga3dhcmdzLmdldCgnZGVzdCcsIE5vbmUpKQogICAgICAgIGlmIHBhdGggaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGt3YXJncwogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoYl9wYXRoKToKICAgICAgICAgICAgKHVpZCwgZ2lkKSA9IHNlbGYudXNlcl9hbmRfZ3JvdXAocGF0aCkKICAgICAgICAgICAga3dhcmdzWyd1aWQnXSA9IHVpZAogICAgICAgICAgICBrd2FyZ3NbJ2dpZCddID0gZ2lkCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHVzZXIgPSBwd2QuZ2V0cHd1aWQodWlkKVswXQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICB1c2VyID0gc3RyKHVpZCkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZ3JvdXAgPSBncnAuZ2V0Z3JnaWQoZ2lkKVswXQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBncm91cCA9IHN0cihnaWQpCiAgICAgICAgICAgIGt3YXJnc1snb3duZXInXSA9IHVzZXIKICAgICAgICAgICAga3dhcmdzWydncm91cCddID0gZ3JvdXAKICAgICAgICAgICAgc3QgPSBvcy5sc3RhdChiX3BhdGgpCiAgICAgICAgICAgIGt3YXJnc1snbW9kZSddID0gJzAlMDNvJyAlIHN0YXQuU19JTU9ERShzdFtzdGF0LlNUX01PREVdKQogICAgICAgICAgICAjIHNlY29udGV4dCBub3QgeWV0IHN1cHBvcnRlZAogICAgICAgICAgICBpZiBvcy5wYXRoLmlzbGluayhiX3BhdGgpOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2xpbmsnCiAgICAgICAgICAgIGVsaWYgb3MucGF0aC5pc2RpcihiX3BhdGgpOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2RpcmVjdG9yeScKICAgICAgICAgICAgZWxpZiBvcy5zdGF0KGJfcGF0aCkuc3RfbmxpbmsgPiAxOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2hhcmQnCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnZmlsZScKICAgICAgICAgICAgaWYgSEFWRV9TRUxJTlVYIGFuZCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAga3dhcmdzWydzZWNvbnRleHQnXSA9ICc6Jy5qb2luKHNlbGYuc2VsaW51eF9jb250ZXh0KHBhdGgpKQogICAgICAgICAgICBrd2FyZ3NbJ3NpemUnXSA9IHN0W3N0YXQuU1RfU0laRV0KICAgICAgICBlbHNlOgogICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnYWJzZW50JwogICAgICAgIHJldHVybiBrd2FyZ3MKCiAgICBkZWYgX2NoZWNrX2xvY2FsZShzZWxmKToKICAgICAgICAnJycKICAgICAgICBVc2VzIHRoZSBsb2NhbGUgbW9kdWxlIHRvIHRlc3QgdGhlIGN1cnJlbnRseSBzZXQgbG9jYWxlCiAgICAgICAgKHBlciB0aGUgTEFORyBhbmQgTENfQ1RZUEUgZW52aXJvbm1lbnQgc2V0dGluZ3MpCiAgICAgICAgJycnCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIHNldHRpbmcgdGhlIGxvY2FsZSB0byAnJyB1c2VzIHRoZSBkZWZhdWx0IGxvY2FsZQogICAgICAgICAgICAjIGFzIGl0IHdvdWxkIGJlIHJldHVybmVkIGJ5IGxvY2FsZS5nZXRkZWZhdWx0bG9jYWxlKCkKICAgICAgICAgICAgbG9jYWxlLnNldGxvY2FsZShsb2NhbGUuTENfQUxMLCAnJykKICAgICAgICBleGNlcHQgbG9jYWxlLkVycm9yOgogICAgICAgICAgICAjIGZhbGxiYWNrIHRvIHRoZSAnQycgbG9jYWxlLCB3aGljaCBtYXkgY2F1c2UgdW5pY29kZQogICAgICAgICAgICAjIGlzc3VlcyBidXQgaXMgcHJlZmVyYWJsZSB0byBzaW1wbHkgZmFpbGluZyBiZWNhdXNlCiAgICAgICAgICAgICMgb2YgYW4gdW5rbm93biBsb2NhbGUKICAgICAgICAgICAgbG9jYWxlLnNldGxvY2FsZShsb2NhbGUuTENfQUxMLCAnQycpCiAgICAgICAgICAgIG9zLmVudmlyb25bJ0xBTkcnXSA9ICdDJwogICAgICAgICAgICBvcy5lbnZpcm9uWydMQ19BTEwnXSA9ICdDJwogICAgICAgICAgICBvcy5lbnZpcm9uWydMQ19NRVNTQUdFUyddID0gJ0MnCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IkFuIHVua25vd24gZXJyb3Igd2FzIGVuY291bnRlcmVkIHdoaWxlIGF0dGVtcHRpbmcgdG8gdmFsaWRhdGUgdGhlIGxvY2FsZTogJXMiICUgZSkKCiAgICBkZWYgX2hhbmRsZV9hbGlhc2VzKHNlbGYsIHNwZWM9Tm9uZSk6CiAgICAgICAgIyB0aGlzIHVzZXMgZXhjZXB0aW9ucyBhcyBpdCBoYXBwZW5zIGJlZm9yZSB3ZSBjYW4gc2FmZWx5IGNhbGwgZmFpbF9qc29uCiAgICAgICAgYWxpYXNlc19yZXN1bHRzID0ge30gI2FsaWFzOmNhbm9uCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICBzcGVjID0gc2VsZi5hcmd1bWVudF9zcGVjCiAgICAgICAgZm9yIChrLHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgc2VsZi5fbGVnYWxfaW5wdXRzLmFwcGVuZChrKQogICAgICAgICAgICBhbGlhc2VzID0gdi5nZXQoJ2FsaWFzZXMnLCBOb25lKQogICAgICAgICAgICBkZWZhdWx0ID0gdi5nZXQoJ2RlZmF1bHQnLCBOb25lKQogICAgICAgICAgICByZXF1aXJlZCA9IHYuZ2V0KCdyZXF1aXJlZCcsIEZhbHNlKQogICAgICAgICAgICBpZiBkZWZhdWx0IGlzIG5vdCBOb25lIGFuZCByZXF1aXJlZDoKICAgICAgICAgICAgICAgICMgbm90IGFsaWFzIHNwZWNpZmljIGJ1dCB0aGlzIGlzIGEgZ29vZCBwbGFjZSB0byBjaGVjayB0aGlzCiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oImludGVybmFsIGVycm9yOiByZXF1aXJlZCBhbmQgZGVmYXVsdCBhcmUgbXV0dWFsbHkgZXhjbHVzaXZlIGZvciAlcyIgJSBrKQogICAgICAgICAgICBpZiBhbGlhc2VzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShhbGlhc2VzLCBTRVFVRU5DRVRZUEUpIG9yIGlzaW5zdGFuY2UoYWxpYXNlcywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKToKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbignaW50ZXJuYWwgZXJyb3I6IGFsaWFzZXMgbXVzdCBiZSBhIGxpc3Qgb3IgdHVwbGUnKQogICAgICAgICAgICBmb3IgYWxpYXMgaW4gYWxpYXNlczoKICAgICAgICAgICAgICAgIHNlbGYuX2xlZ2FsX2lucHV0cy5hcHBlbmQoYWxpYXMpCiAgICAgICAgICAgICAgICBhbGlhc2VzX3Jlc3VsdHNbYWxpYXNdID0gawogICAgICAgICAgICAgICAgaWYgYWxpYXMgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBzZWxmLnBhcmFtc1thbGlhc10KCiAgICAgICAgcmV0dXJuIGFsaWFzZXNfcmVzdWx0cwoKICAgIGRlZiBfY2hlY2tfYXJndW1lbnRzKHNlbGYsIGNoZWNrX2ludmFsaWRfYXJndW1lbnRzKToKICAgICAgICBzZWxmLl9zeXNsb2dfZmFjaWxpdHkgPSAnTE9HX1VTRVInCiAgICAgICAgdW5zdXBwb3J0ZWRfcGFyYW1ldGVycyA9IHNldCgpCiAgICAgICAgZm9yIChrLHYpIGluIGxpc3Qoc2VsZi5wYXJhbXMuaXRlbXMoKSk6CgogICAgICAgICAgICBpZiBrID09ICdfYW5zaWJsZV9jaGVja19tb2RlJyBhbmQgdjoKICAgICAgICAgICAgICAgIHNlbGYuY2hlY2tfbW9kZSA9IFRydWUKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfbm9fbG9nJzoKICAgICAgICAgICAgICAgIHNlbGYubm9fbG9nID0gc2VsZi5ib29sZWFuKHYpCgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX2RlYnVnJzoKICAgICAgICAgICAgICAgIHNlbGYuX2RlYnVnID0gc2VsZi5ib29sZWFuKHYpCgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX2RpZmYnOgogICAgICAgICAgICAgICAgc2VsZi5fZGlmZiA9IHNlbGYuYm9vbGVhbih2KQoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV92ZXJib3NpdHknOgogICAgICAgICAgICAgICAgc2VsZi5fdmVyYm9zaXR5ID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9zZWxpbnV4X3NwZWNpYWxfZnMnOgogICAgICAgICAgICAgICAgc2VsZi5fc2VsaW51eF9zcGVjaWFsX2ZzID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9zeXNsb2dfZmFjaWxpdHknOgogICAgICAgICAgICAgICAgc2VsZi5fc3lzbG9nX2ZhY2lsaXR5ID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV92ZXJzaW9uJzoKICAgICAgICAgICAgICAgIHNlbGYuYW5zaWJsZV92ZXJzaW9uID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9tb2R1bGVfbmFtZSc6CiAgICAgICAgICAgICAgICBzZWxmLl9uYW1lID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9zb2NrZXQnOgogICAgICAgICAgICAgICAgc2VsZi5fc29ja2V0X3BhdGggPSB2CgogICAgICAgICAgICBlbGlmIGNoZWNrX2ludmFsaWRfYXJndW1lbnRzIGFuZCBrIG5vdCBpbiBzZWxmLl9sZWdhbF9pbnB1dHM6CiAgICAgICAgICAgICAgICB1bnN1cHBvcnRlZF9wYXJhbWV0ZXJzLmFkZChrKQoKICAgICAgICAgICAgI2NsZWFuIHVwIGludGVybmFsIHBhcmFtczoKICAgICAgICAgICAgaWYgay5zdGFydHN3aXRoKCdfYW5zaWJsZV8nKToKICAgICAgICAgICAgICAgIGRlbCBzZWxmLnBhcmFtc1trXQoKICAgICAgICBpZiB1bnN1cHBvcnRlZF9wYXJhbWV0ZXJzOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IlVuc3VwcG9ydGVkIHBhcmFtZXRlcnMgZm9yICglcykgbW9kdWxlOiAlcy4gU3VwcG9ydGVkIHBhcmFtZXRlcnMgaW5jbHVkZTogJXMiICUgKHNlbGYuX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJywnLmpvaW4oc29ydGVkKGxpc3QodW5zdXBwb3J0ZWRfcGFyYW1ldGVycykpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLCcuam9pbihzb3J0ZWQoc2VsZi5hcmd1bWVudF9zcGVjLmtleXMoKSkpKSkKICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGUgYW5kIG5vdCBzZWxmLnN1cHBvcnRzX2NoZWNrX21vZGU6CiAgICAgICAgICAgIHNlbGYuZXhpdF9qc29uKHNraXBwZWQ9VHJ1ZSwgbXNnPSJyZW1vdGUgbW9kdWxlICglcykgZG9lcyBub3Qgc3VwcG9ydCBjaGVjayBtb2RlIiAlIHNlbGYuX25hbWUpCgogICAgZGVmIF9jb3VudF90ZXJtcyhzZWxmLCBjaGVjayk6CiAgICAgICAgY291bnQgPSAwCiAgICAgICAgZm9yIHRlcm0gaW4gY2hlY2s6CiAgICAgICAgICAgIGlmIHRlcm0gaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICBjb3VudCArPSAxCiAgICAgICAgcmV0dXJuIGNvdW50CgogICAgZGVmIF9jaGVja19tdXR1YWxseV9leGNsdXNpdmUoc2VsZiwgc3BlYyk6CiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3IgY2hlY2sgaW4gc3BlYzoKICAgICAgICAgICAgY291bnQgPSBzZWxmLl9jb3VudF90ZXJtcyhjaGVjaykKICAgICAgICAgICAgaWYgY291bnQgPiAxOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJwYXJhbWV0ZXJzIGFyZSBtdXR1YWxseSBleGNsdXNpdmU6ICVzIiAlIChjaGVjaywpKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfb25lX29mKHNlbGYsIHNwZWMpOgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZm9yIGNoZWNrIGluIHNwZWM6CiAgICAgICAgICAgIGNvdW50ID0gc2VsZi5fY291bnRfdGVybXMoY2hlY2spCiAgICAgICAgICAgIGlmIGNvdW50ID09IDA6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9Im9uZSBvZiB0aGUgZm9sbG93aW5nIGlzIHJlcXVpcmVkOiAlcyIgJSAnLCcuam9pbihjaGVjaykpCgogICAgZGVmIF9jaGVja19yZXF1aXJlZF90b2dldGhlcihzZWxmLCBzcGVjKToKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciBjaGVjayBpbiBzcGVjOgogICAgICAgICAgICBjb3VudHMgPSBbIHNlbGYuX2NvdW50X3Rlcm1zKFtmaWVsZF0pIGZvciBmaWVsZCBpbiBjaGVjayBdCiAgICAgICAgICAgIG5vbl96ZXJvID0gWyBjIGZvciBjIGluIGNvdW50cyBpZiBjID4gMCBdCiAgICAgICAgICAgIGlmIGxlbihub25femVybykgPiAwOgogICAgICAgICAgICAgICAgaWYgMCBpbiBjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJwYXJhbWV0ZXJzIGFyZSByZXF1aXJlZCB0b2dldGhlcjogJXMiICUgKGNoZWNrLCkpCgogICAgZGVmIF9jaGVja19yZXF1aXJlZF9hcmd1bWVudHMoc2VsZiwgc3BlYz1Ob25lLCBwYXJhbT1Ob25lICk6CiAgICAgICAgJycnIGVuc3VyZSBhbGwgcmVxdWlyZWQgYXJndW1lbnRzIGFyZSBwcmVzZW50ICcnJwogICAgICAgIG1pc3NpbmcgPSBbXQogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgc3BlYyA9IHNlbGYuYXJndW1lbnRfc3BlYwogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAgICAgIHBhcmFtID0gc2VsZi5wYXJhbXMKICAgICAgICBmb3IgKGssdikgaW4gc3BlYy5pdGVtcygpOgogICAgICAgICAgICByZXF1aXJlZCA9IHYuZ2V0KCdyZXF1aXJlZCcsIEZhbHNlKQogICAgICAgICAgICBpZiByZXF1aXJlZCBhbmQgayBub3QgaW4gcGFyYW06CiAgICAgICAgICAgICAgICBtaXNzaW5nLmFwcGVuZChrKQogICAgICAgIGlmIGxlbihtaXNzaW5nKSA+IDA6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0ibWlzc2luZyByZXF1aXJlZCBhcmd1bWVudHM6ICVzIiAlICIsIi5qb2luKG1pc3NpbmcpKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfaWYoc2VsZiwgc3BlYyk6CiAgICAgICAgJycnIGVuc3VyZSB0aGF0IHBhcmFtZXRlcnMgd2hpY2ggY29uZGl0aW9uYWxseSByZXF1aXJlZCBhcmUgcHJlc2VudCAnJycKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciBzcCBpbiBzcGVjOgogICAgICAgICAgICBtaXNzaW5nID0gW10KICAgICAgICAgICAgbWF4X21pc3NpbmdfY291bnQgPSAwCiAgICAgICAgICAgIGlzX29uZV9vZiA9IEZhbHNlCiAgICAgICAgICAgIGlmIGxlbihzcCkgPT0gNDoKICAgICAgICAgICAgICAgIGtleSwgdmFsLCByZXF1aXJlbWVudHMsIGlzX29uZV9vZiA9IHNwCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBrZXksIHZhbCwgcmVxdWlyZW1lbnRzID0gc3AKCiAgICAgICAgICAgICMgaXNfb25lX29mIGlzIFRydWUgYXQgbGVhc3Qgb25lIHJlcXVpcmVtZW50IHNob3VsZCBiZQogICAgICAgICAgICAjIHByZXNlbnQsIGVsc2UgYWxsIHJlcXVpcmVtZW50cyBzaG91bGQgYmUgcHJlc2VudC4KICAgICAgICAgICAgaWYgaXNfb25lX29mOgogICAgICAgICAgICAgICAgbWF4X21pc3NpbmdfY291bnQgPSBsZW4ocmVxdWlyZW1lbnRzKQoKICAgICAgICAgICAgaWYga2V5IGluIHNlbGYucGFyYW1zIGFuZCBzZWxmLnBhcmFtc1trZXldID09IHZhbDoKICAgICAgICAgICAgICAgIGZvciBjaGVjayBpbiByZXF1aXJlbWVudHM6CiAgICAgICAgICAgICAgICAgICAgY291bnQgPSBzZWxmLl9jb3VudF90ZXJtcygoY2hlY2ssKSkKICAgICAgICAgICAgICAgICAgICBpZiBjb3VudCA9PSAwOgogICAgICAgICAgICAgICAgICAgICAgICBtaXNzaW5nLmFwcGVuZChjaGVjaykKICAgICAgICAgICAgaWYgbGVuKG1pc3NpbmcpIGFuZCBsZW4obWlzc2luZykgPj0gbWF4X21pc3NpbmdfY291bnQ6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IiVzIGlzICVzIGJ1dCB0aGUgZm9sbG93aW5nIGFyZSBtaXNzaW5nOiAlcyIgJSAoa2V5LCB2YWwsICcsJy5qb2luKG1pc3NpbmcpKSkKCiAgICBkZWYgX2NoZWNrX2FyZ3VtZW50X3ZhbHVlcyhzZWxmLCBzcGVjPU5vbmUsIHBhcmFtPU5vbmUpOgogICAgICAgICcnJyBlbnN1cmUgYWxsIGFyZ3VtZW50cyBoYXZlIHRoZSByZXF1ZXN0ZWQgdmFsdWVzLCBhbmQgdGhlcmUgYXJlIG5vIHN0cmF5IGFyZ3VtZW50cyAnJycKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHNwZWMgPSBzZWxmLmFyZ3VtZW50X3NwZWMKICAgICAgICBpZiBwYXJhbSBpcyBOb25lOgogICAgICAgICAgICBwYXJhbSA9IHNlbGYucGFyYW1zCiAgICAgICAgZm9yIChrLHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgY2hvaWNlcyA9IHYuZ2V0KCdjaG9pY2VzJyxOb25lKQogICAgICAgICAgICBpZiBjaG9pY2VzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGNob2ljZXMsIFNFUVVFTkNFVFlQRSkgYW5kIG5vdCBpc2luc3RhbmNlKGNob2ljZXMsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgICAgICBpZiBrIGluIHBhcmFtOgogICAgICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdIG5vdCBpbiBjaG9pY2VzOgogICAgICAgICAgICAgICAgICAgICAgICAjIFB5WWFtbCBjb252ZXJ0cyBjZXJ0YWluIHN0cmluZ3MgdG8gYm9vbHMuICBJZiB3ZSBjYW4gdW5hbWJpZ3VvdXNseSBjb252ZXJ0IGJhY2ssIGRvIHNvIGJlZm9yZSBjaGVja2luZwogICAgICAgICAgICAgICAgICAgICAgICAjIHRoZSB2YWx1ZS4gIElmIHdlIGNhbid0IGZpZ3VyZSB0aGlzIG91dCwgbW9kdWxlIGF1dGhvciBpcyByZXNwb25zaWJsZS4KICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJlZF9jaG9pY2VzID0gTm9uZQogICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSA9PSAnRmFsc2UnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJlZF9jaG9pY2VzID0gX2xlbmllbnRfbG93ZXJjYXNlKGNob2ljZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGQUxTRVkgPSBmcm96ZW5zZXQoQk9PTEVBTlNfRkFMU0UpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdmVybGFwID0gRkFMU0VZLmludGVyc2VjdGlvbihjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKG92ZXJsYXApID09IDE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBFeHRyYWN0IGZyb20gYSBzZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAocGFyYW1ba10sKSA9IG92ZXJsYXAKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdID09ICdUcnVlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxvd2VyZWRfY2hvaWNlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvd2VyZWRfY2hvaWNlcyA9IF9sZW5pZW50X2xvd2VyY2FzZShjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgVFJVVEhZID0gZnJvemVuc2V0KEJPT0xFQU5TX1RSVUUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdmVybGFwID0gVFJVVEhZLmludGVyc2VjdGlvbihjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKG92ZXJsYXApID09IDE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHBhcmFtW2tdLCkgPSBvdmVybGFwCgogICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSBub3QgaW4gY2hvaWNlczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXNfc3RyPSIsIi5qb2luKFt0b19uYXRpdmUoYykgZm9yIGMgaW4gY2hvaWNlc10pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2c9InZhbHVlIG9mICVzIG11c3QgYmUgb25lIG9mOiAlcywgZ290OiAlcyIgJSAoaywgY2hvaWNlc19zdHIsIHBhcmFtW2tdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPW1zZykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iaW50ZXJuYWwgZXJyb3I6IGNob2ljZXMgZm9yIGFyZ3VtZW50ICVzIGFyZSBub3QgaXRlcmFibGU6ICVzIiAlIChrLCBjaG9pY2VzKSkKCiAgICBkZWYgc2FmZV9ldmFsKHNlbGYsIHZhbHVlLCBsb2NhbHM9Tm9uZSwgaW5jbHVkZV9leGNlcHRpb25zPUZhbHNlKToKCiAgICAgICAgIyBkbyBub3QgYWxsb3cgbWV0aG9kIGNhbGxzIHRvIG1vZHVsZXMKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgIyBhbHJlYWR5IHRlbXBsYXRlZCB0byBhIGRhdGF2YWx1ZXN0cnVjdHVyZSwgcGVyaGFwcz8KICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgTm9uZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgaWYgcmUuc2VhcmNoKHInXHdcLlx3K1woJywgdmFsdWUpOgogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHZhbHVlLCBOb25lKQogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICAjIGRvIG5vdCBhbGxvdyBpbXBvcnRzCiAgICAgICAgaWYgcmUuc2VhcmNoKHInaW1wb3J0IFx3KycsIHZhbHVlKToKICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgTm9uZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXN1bHQgPSBsaXRlcmFsX2V2YWwodmFsdWUpCiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAocmVzdWx0LCBOb25lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgZGVmIF9jaGVja190eXBlX3N0cihzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgIyBOb3RlOiBUaGlzIGNvdWxkIHRocm93IGEgdW5pY29kZSBlcnJvciBpZiB2YWx1ZSdzIF9fc3RyX18oKSBtZXRob2QKICAgICAgICAjIHJldHVybnMgbm9uLWFzY2lpLiAgSGF2ZSB0byBwb3J0IHV0aWxzLnRvX2J5dGVzKCkgaWYgdGhhdCBoYXBwZW5zCiAgICAgICAgcmV0dXJuIHN0cih2YWx1ZSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfbGlzdChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgbGlzdCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUuc3BsaXQoIiwiKQogICAgICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgaW50KSBvciBpc2luc3RhbmNlKHZhbHVlLCBmbG9hdCk6CiAgICAgICAgICAgIHJldHVybiBbIHN0cih2YWx1ZSkgXQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBsaXN0JyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9kaWN0KHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBkaWN0KToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIGlmIHZhbHVlLnN0YXJ0c3dpdGgoInsiKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5sb2Fkcyh2YWx1ZSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAocmVzdWx0LCBleGMpID0gc2VsZi5zYWZlX2V2YWwodmFsdWUsIGRpY3QoKSwgaW5jbHVkZV9leGNlcHRpb25zPVRydWUpCiAgICAgICAgICAgICAgICAgICAgaWYgZXhjIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ3VuYWJsZSB0byBldmFsdWF0ZSBzdHJpbmcgYXMgZGljdGlvbmFyeScpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICAgICAgICBlbGlmICc9JyBpbiB2YWx1ZToKICAgICAgICAgICAgICAgIGZpZWxkcyA9IFtdCiAgICAgICAgICAgICAgICBmaWVsZF9idWZmZXIgPSBbXQogICAgICAgICAgICAgICAgaW5fcXVvdGUgPSBGYWxzZQogICAgICAgICAgICAgICAgaW5fZXNjYXBlID0gRmFsc2UKICAgICAgICAgICAgICAgIGZvciBjIGluIHZhbHVlLnN0cmlwKCk6CiAgICAgICAgICAgICAgICAgICAgaWYgaW5fZXNjYXBlOgogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZF9idWZmZXIuYXBwZW5kKGMpCiAgICAgICAgICAgICAgICAgICAgICAgIGluX2VzY2FwZSA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgZWxpZiBjID09ICdcXCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGluX2VzY2FwZSA9IFRydWUKICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBpbl9xdW90ZSBhbmQgYyBpbiAoJ1wnJywgJyInKToKICAgICAgICAgICAgICAgICAgICAgICAgaW5fcXVvdGUgPSBjCiAgICAgICAgICAgICAgICAgICAgZWxpZiBpbl9xdW90ZSBhbmQgaW5fcXVvdGUgPT0gYzoKICAgICAgICAgICAgICAgICAgICAgICAgaW5fcXVvdGUgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsaWYgbm90IGluX3F1b3RlIGFuZCBjIGluICgnLCcsICcgJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkID0gJycuam9pbihmaWVsZF9idWZmZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGZpZWxkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzLmFwcGVuZChmaWVsZCkKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyID0gW10KICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZF9idWZmZXIuYXBwZW5kKGMpCgogICAgICAgICAgICAgICAgZmllbGQgPSAnJy5qb2luKGZpZWxkX2J1ZmZlcikKICAgICAgICAgICAgICAgIGlmIGZpZWxkOgogICAgICAgICAgICAgICAgICAgIGZpZWxkcy5hcHBlbmQoZmllbGQpCiAgICAgICAgICAgICAgICByZXR1cm4gZGljdCh4LnNwbGl0KCI9IiwgMSkgZm9yIHggaW4gZmllbGRzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJkaWN0aW9uYXJ5IHJlcXVlc3RlZCwgY291bGQgbm90IHBhcnNlIEpTT04gb3Iga2V5PXZhbHVlIikKCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgZGljdCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfYm9vbChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgYm9vbCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpIG9yIGlzaW5zdGFuY2UodmFsdWUsIGludCk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmJvb2xlYW4odmFsdWUpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGJvb2wnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2ludChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgaW50KToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHJldHVybiBpbnQodmFsdWUpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhbiBpbnQnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2Zsb2F0KHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBmbG9hdCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSwgaW50KSk6CiAgICAgICAgICAgIHJldHVybiBmbG9hdCh2YWx1ZSkKCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgZmxvYXQnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX3BhdGgoc2VsZiwgdmFsdWUpOgogICAgICAgIHZhbHVlID0gc2VsZi5fY2hlY2tfdHlwZV9zdHIodmFsdWUpCiAgICAgICAgcmV0dXJuIG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnModmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9qc29uYXJnKHNlbGYsIHZhbHVlKToKICAgICAgICAjIFJldHVybiBhIGpzb25pZmllZCBzdHJpbmcuICBTb21ldGltZXMgdGhlIGNvbnRyb2xsZXIgdHVybnMgYSBqc29uCiAgICAgICAgIyBzdHJpbmcgaW50byBhIGRpY3QvbGlzdCBzbyB0cmFuc2Zvcm0gaXQgYmFjayBpbnRvIGpzb24gaGVyZQogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5zdHJpcCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgKGxpc3QsIHR1cGxlLCBkaWN0KSk6CiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5kdW1wcyh2YWx1ZSkKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBqc29uIHN0cmluZycgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfcmF3KHNlbGYsIHZhbHVlKToKICAgICAgICByZXR1cm4gdmFsdWUKCgogICAgZGVmIF9jaGVja190eXBlX2J5dGVzKHNlbGYsIHZhbHVlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuaHVtYW5fdG9fYnl0ZXModmFsdWUpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIEJ5dGUgdmFsdWUnICUgdHlwZSh2YWx1ZSkpCgoKICAgIGRlZiBfY2hlY2tfdHlwZV9iaXRzKHNlbGYsIHZhbHVlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuaHVtYW5fdG9fYnl0ZXModmFsdWUsIGlzYml0cz1UcnVlKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBCaXQgdmFsdWUnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja19hcmd1bWVudF90eXBlcyhzZWxmLCBzcGVjPU5vbmUsIHBhcmFtPU5vbmUpOgogICAgICAgICcnJyBlbnN1cmUgYWxsIGFyZ3VtZW50cyBoYXZlIHRoZSByZXF1ZXN0ZWQgdHlwZSAnJycKCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICBzcGVjID0gc2VsZi5hcmd1bWVudF9zcGVjCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToKICAgICAgICAgICAgcGFyYW0gPSBzZWxmLnBhcmFtcwoKICAgICAgICBmb3IgKGssIHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgd2FudGVkID0gdi5nZXQoJ3R5cGUnLCBOb25lKQogICAgICAgICAgICBpZiBrIG5vdCBpbiBwYXJhbToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIHdhbnRlZCBpcyBOb25lOgogICAgICAgICAgICAgICAgIyBNb3N0bHkgd2Ugd2FudCB0byBkZWZhdWx0IHRvIHN0ci4KICAgICAgICAgICAgICAgICMgRm9yIHZhbHVlcyBzZXQgdG8gTm9uZSBleHBsaWNpdGx5LCByZXR1cm4gTm9uZSBpbnN0ZWFkIGFzCiAgICAgICAgICAgICAgICAjIHRoYXQgYWxsb3dzIGEgdXNlciB0byB1bnNldCBhIHBhcmFtZXRlcgogICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgd2FudGVkID0gJ3N0cicKCiAgICAgICAgICAgIHZhbHVlID0gcGFyYW1ba10KICAgICAgICAgICAgaWYgdmFsdWUgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB0eXBlX2NoZWNrZXIgPSBzZWxmLl9DSEVDS19BUkdVTUVOVF9UWVBFU19ESVNQQVRDSEVSW3dhbnRlZF0KICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJpbXBsZW1lbnRhdGlvbiBlcnJvcjogdW5rbm93biB0eXBlICVzIHJlcXVlc3RlZCBmb3IgJXMiICUgKHdhbnRlZCwgaykpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHBhcmFtW2tdID0gdHlwZV9jaGVja2VyKHZhbHVlKQogICAgICAgICAgICBleGNlcHQgKFR5cGVFcnJvciwgVmFsdWVFcnJvcik6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImFyZ3VtZW50ICVzIGlzIG9mIHR5cGUgJXMgYW5kIHdlIHdlcmUgdW5hYmxlIHRvIGNvbnZlcnQgdG8gJXM6ICVzIiAlIChrLCB0eXBlKHZhbHVlKSwgd2FudGVkLCBlKSkKCiAgICAgICAgICAgICMgZGVhbCB3aXRoIHN1YiBvcHRpb25zIHRvIGNyZWF0ZSBzdWIgc3BlYwogICAgICAgICAgICBzcGVjID0gTm9uZQogICAgICAgICAgICBpZiB3YW50ZWQgPT0gJ2RpY3QnIG9yICh3YW50ZWQgPT0gJ2xpc3QnIGFuZCB2LmdldCgnZWxlbWVudHMnLCAnJykgPT0gJ2RpY3QnKToKICAgICAgICAgICAgICAgIHNwZWMgPSB2LmdldCgnb3B0aW9ucycsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBzcGVjOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX2FyZ3VtZW50cyhzcGVjLCBwYXJhbVtrXSkKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudF90eXBlcyhzcGVjLCBwYXJhbVtrXSkKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudF92YWx1ZXMoc3BlYywgcGFyYW1ba10pCgogICAgZGVmIF9zZXRfZGVmYXVsdHMoc2VsZiwgcHJlPVRydWUpOgogICAgICAgIGZvciAoayx2KSBpbiBzZWxmLmFyZ3VtZW50X3NwZWMuaXRlbXMoKToKICAgICAgICAgICAgZGVmYXVsdCA9IHYuZ2V0KCdkZWZhdWx0JywgTm9uZSkKICAgICAgICAgICAgaWYgcHJlIGlzIFRydWU6CiAgICAgICAgICAgICAgICAjIHRoaXMgcHJldmVudHMgc2V0dGluZyBkZWZhdWx0cyBvbiByZXF1aXJlZCBpdGVtcwogICAgICAgICAgICAgICAgaWYgZGVmYXVsdCBpcyBub3QgTm9uZSBhbmQgayBub3QgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBkZWZhdWx0CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIG1ha2Ugc3VyZSB0aGluZ3Mgd2l0aG91dCBhIGRlZmF1bHQgc3RpbGwgZ2V0IHNldCBOb25lCiAgICAgICAgICAgICAgICBpZiBrIG5vdCBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcmFtc1trXSA9IGRlZmF1bHQKCiAgICBkZWYgX3NldF9mYWxsYmFja3Moc2VsZik6CiAgICAgICAgZm9yIGssdiBpbiBzZWxmLmFyZ3VtZW50X3NwZWMuaXRlbXMoKToKICAgICAgICAgICAgZmFsbGJhY2sgPSB2LmdldCgnZmFsbGJhY2snLCAoTm9uZSwpKQogICAgICAgICAgICBmYWxsYmFja19zdHJhdGVneSA9IGZhbGxiYWNrWzBdCiAgICAgICAgICAgIGZhbGxiYWNrX2FyZ3MgPSBbXQogICAgICAgICAgICBmYWxsYmFja19rd2FyZ3MgPSB7fQogICAgICAgICAgICBpZiBrIG5vdCBpbiBzZWxmLnBhcmFtcyBhbmQgZmFsbGJhY2tfc3RyYXRlZ3kgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBmb3IgaXRlbSBpbiBmYWxsYmFja1sxOl06CiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShpdGVtLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tfa3dhcmdzID0gaXRlbQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrX2FyZ3MgPSBpdGVtCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBmYWxsYmFja19zdHJhdGVneSgqZmFsbGJhY2tfYXJncywgKipmYWxsYmFja19rd2FyZ3MpCiAgICAgICAgICAgICAgICBleGNlcHQgQW5zaWJsZUZhbGxiYWNrTm90Rm91bmQ6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICBkZWYgX2xvYWRfcGFyYW1zKHNlbGYpOgogICAgICAgICcnJyByZWFkIHRoZSBpbnB1dCBhbmQgc2V0IHRoZSBwYXJhbXMgYXR0cmlidXRlLgoKICAgICAgICBUaGlzIG1ldGhvZCBpcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuICBUaGUgZ3V0cyBvZiB0aGUgZnVuY3Rpb24KICAgICAgICB3ZXJlIG1vdmVkIG91dCBpbiAyLjEgc28gdGhhdCBjdXN0b20gbW9kdWxlcyBjb3VsZCByZWFkIHRoZSBwYXJhbWV0ZXJzLgogICAgICAgICcnJwogICAgICAgICMgZGVidWcgb3ZlcnJpZGVzIHRvIHJlYWQgYXJncyBmcm9tIGZpbGUgb3IgY21kbGluZQogICAgICAgIHNlbGYucGFyYW1zID0gX2xvYWRfcGFyYW1zKCkKCiAgICBkZWYgX2xvZ190b19zeXNsb2coc2VsZiwgbXNnKToKICAgICAgICBpZiBIQVNfU1lTTE9HOgogICAgICAgICAgICBtb2R1bGUgPSAnYW5zaWJsZS0lcycgJSBzZWxmLl9uYW1lCiAgICAgICAgICAgIGZhY2lsaXR5ID0gZ2V0YXR0cihzeXNsb2csIHNlbGYuX3N5c2xvZ19mYWNpbGl0eSwgc3lzbG9nLkxPR19VU0VSKQogICAgICAgICAgICBzeXNsb2cub3BlbmxvZyhzdHIobW9kdWxlKSwgMCwgZmFjaWxpdHkpCiAgICAgICAgICAgIHN5c2xvZy5zeXNsb2coc3lzbG9nLkxPR19JTkZPLCBtc2cpCgogICAgZGVmIGRlYnVnKHNlbGYsIG1zZyk6CiAgICAgICAgaWYgc2VsZi5fZGVidWc6CiAgICAgICAgICAgIHNlbGYubG9nKCdbZGVidWddICVzJyAlIG1zZykKCiAgICBkZWYgbG9nKHNlbGYsIG1zZywgbG9nX2FyZ3M9Tm9uZSk6CgogICAgICAgIGlmIG5vdCBzZWxmLm5vX2xvZzoKCiAgICAgICAgICAgIGlmIGxvZ19hcmdzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBsb2dfYXJncyA9IGRpY3QoKQoKICAgICAgICAgICAgbW9kdWxlID0gJ2Fuc2libGUtJXMnICUgc2VsZi5fbmFtZQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKG1vZHVsZSwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICAgICAgbW9kdWxlID0gbW9kdWxlLmRlY29kZSgndXRmLTgnLCAncmVwbGFjZScpCgogICAgICAgICAgICAjIDY2NTUgLSBhbGxvdyBmb3IgYWNjZW50ZWQgY2hhcmFjdGVycwogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShtc2csIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoIm1zZyBzaG91bGQgYmUgYSBzdHJpbmcgKGdvdCAlcykiICUgdHlwZShtc2cpKQoKICAgICAgICAgICAgIyBXZSB3YW50IGpvdXJuYWwgdG8gYWx3YXlzIHRha2UgdGV4dCB0eXBlCiAgICAgICAgICAgICMgc3lzbG9nIHRha2VzIGJ5dGVzIG9uIHB5MiwgdGV4dCB0eXBlIG9uIHB5MwogICAgICAgICAgICBpZiBpc2luc3RhbmNlKG1zZywgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICAgICAgam91cm5hbF9tc2cgPSByZW1vdmVfdmFsdWVzKG1zZy5kZWNvZGUoJ3V0Zi04JywgJ3JlcGxhY2UnKSwgc2VsZi5ub19sb2dfdmFsdWVzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBUT0RPOiBzdXJyb2dhdGVlc2NhcGUgaXMgYSBkYW5nZXIgaGVyZSBvbiBQeTMKICAgICAgICAgICAgICAgIGpvdXJuYWxfbXNnID0gcmVtb3ZlX3ZhbHVlcyhtc2csIHNlbGYubm9fbG9nX3ZhbHVlcykKCiAgICAgICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgICAgIHN5c2xvZ19tc2cgPSBqb3VybmFsX21zZwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc3lzbG9nX21zZyA9IGpvdXJuYWxfbXNnLmVuY29kZSgndXRmLTgnLCAncmVwbGFjZScpCgogICAgICAgICAgICBpZiBoYXNfam91cm5hbDoKICAgICAgICAgICAgICAgIGpvdXJuYWxfYXJncyA9IFsoIk1PRFVMRSIsIG9zLnBhdGguYmFzZW5hbWUoX19maWxlX18pKV0KICAgICAgICAgICAgICAgIGZvciBhcmcgaW4gbG9nX2FyZ3M6CiAgICAgICAgICAgICAgICAgICAgam91cm5hbF9hcmdzLmFwcGVuZCgoYXJnLnVwcGVyKCksIHN0cihsb2dfYXJnc1thcmddKSkpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgam91cm5hbC5zZW5kKHUiJXMgJXMiICUgKG1vZHVsZSwgam91cm5hbF9tc2cpLCAqKmRpY3Qoam91cm5hbF9hcmdzKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBJT0Vycm9yOgogICAgICAgICAgICAgICAgICAgICMgZmFsbCBiYWNrIHRvIHN5c2xvZyBzaW5jZSBsb2dnaW5nIHRvIGpvdXJuYWwgZmFpbGVkCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fbG9nX3RvX3N5c2xvZyhzeXNsb2dfbXNnKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5fbG9nX3RvX3N5c2xvZyhzeXNsb2dfbXNnKQoKICAgIGRlZiBfbG9nX2ludm9jYXRpb24oc2VsZik6CiAgICAgICAgJycnIGxvZyB0aGF0IGFuc2libGUgcmFuIHRoZSBtb2R1bGUgJycnCiAgICAgICAgIyBUT0RPOiBnZW5lcmFsaXplIGEgc2VwYXJhdGUgbG9nIGZ1bmN0aW9uIGFuZCBtYWtlIGxvZ19pbnZvY2F0aW9uIHVzZSBpdAogICAgICAgICMgU2FuaXRpemUgcG9zc2libGUgcGFzc3dvcmQgYXJndW1lbnQgd2hlbiBsb2dnaW5nLgogICAgICAgIGxvZ19hcmdzID0gZGljdCgpCgogICAgICAgIGZvciBwYXJhbSBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgY2Fub24gID0gc2VsZi5hbGlhc2VzLmdldChwYXJhbSwgcGFyYW0pCiAgICAgICAgICAgIGFyZ19vcHRzID0gc2VsZi5hcmd1bWVudF9zcGVjLmdldChjYW5vbiwge30pCiAgICAgICAgICAgIG5vX2xvZyA9IGFyZ19vcHRzLmdldCgnbm9fbG9nJywgRmFsc2UpCgogICAgICAgICAgICBpZiBzZWxmLmJvb2xlYW4obm9fbG9nKToKICAgICAgICAgICAgICAgIGxvZ19hcmdzW3BhcmFtXSA9ICdOT1RfTE9HR0lOR19QQVJBTUVURVInCiAgICAgICAgICAgICMgdHJ5IHRvIGNhcHR1cmUgYWxsIHBhc3N3b3Jkcy9wYXNzcGhyYXNlIG5hbWVkIGZpZWxkcyBtaXNzZWQgYnkgbm9fbG9nCiAgICAgICAgICAgIGVsaWYgUEFTU1dPUkRfTUFUQ0guc2VhcmNoKHBhcmFtKSBhbmQgXAogICAgICAgICAgICAgIGFyZ19vcHRzLmdldCgndHlwZScsICdzdHInKSAhPSAnYm9vbCcgYW5kIFwKICAgICAgICAgICAgICBub3QgYXJnX29wdHMuZ2V0KCdjaG9pY2VzJywgRmFsc2UpOgogICAgICAgICAgICAgICAgIyBza2lwIGJvb2xlYW4gYW5kIGVudW1zIGFzIHRoZXkgYXJlIGFib3V0ICdwYXNzd29yZCcgc3RhdGUKICAgICAgICAgICAgICAgIGxvZ19hcmdzW3BhcmFtXSA9ICdOT1RfTE9HR0lOR19QQVNTV09SRCcKICAgICAgICAgICAgICAgIHNlbGYud2FybignTW9kdWxlIGRpZCBub3Qgc2V0IG5vX2xvZyBmb3IgJXMnICUgcGFyYW0pCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwYXJhbV92YWwgPSBzZWxmLnBhcmFtc1twYXJhbV0KICAgICAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHBhcmFtX3ZhbCwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICAgICAgICAgICAgICBwYXJhbV92YWwgPSBzdHIocGFyYW1fdmFsKQogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKHBhcmFtX3ZhbCwgdGV4dF90eXBlKToKICAgICAgICAgICAgICAgICAgICBwYXJhbV92YWwgPSBwYXJhbV92YWwuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgICAgICBsb2dfYXJnc1twYXJhbV0gPSBoZXVyaXN0aWNfbG9nX3Nhbml0aXplKHBhcmFtX3ZhbCwgc2VsZi5ub19sb2dfdmFsdWVzKQoKICAgICAgICBtc2cgPSBbJyVzPSVzJyAlICh0b19uYXRpdmUoYXJnKSwgdG9fbmF0aXZlKHZhbCkpIGZvciBhcmcsIHZhbCBpbiBsb2dfYXJncy5pdGVtcygpXQogICAgICAgIGlmIG1zZzoKICAgICAgICAgICAgbXNnID0gJ0ludm9rZWQgd2l0aCAlcycgJSAnICcuam9pbihtc2cpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbXNnID0gJ0ludm9rZWQnCgogICAgICAgIHNlbGYubG9nKG1zZywgbG9nX2FyZ3M9bG9nX2FyZ3MpCgoKICAgIGRlZiBfc2V0X2N3ZChzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN3ZCA9IG9zLmdldGN3ZCgpCiAgICAgICAgICAgIGlmIG5vdCBvcy5hY2Nlc3MoY3dkLCBvcy5GX09LfG9zLlJfT0spOgogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCkKICAgICAgICAgICAgcmV0dXJuIGN3ZAogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgIyB3ZSBkb24ndCBoYXZlIGFjY2VzcyB0byB0aGUgY3dkLCBwcm9iYWJseSBiZWNhdXNlIG9mIHN1ZG8uCiAgICAgICAgICAgICMgVHJ5IGFuZCBtb3ZlIHRvIGEgbmV1dHJhbCBsb2NhdGlvbiB0byBwcmV2ZW50IGVycm9ycwogICAgICAgICAgICBmb3IgY3dkIGluIFtvcy5wYXRoLmV4cGFuZHZhcnMoJyRIT01FJyksIHRlbXBmaWxlLmdldHRlbXBkaXIoKV06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgb3MuYWNjZXNzKGN3ZCwgb3MuRl9PS3xvcy5SX09LKToKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2hkaXIoY3dkKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3dkCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICMgd2Ugd29uJ3QgZXJyb3IgaGVyZSwgYXMgaXQgbWF5ICpub3QqIGJlIGEgcHJvYmxlbSwKICAgICAgICAjIGFuZCB3ZSBkb24ndCB3YW50IHRvIGJyZWFrIG1vZHVsZXMgdW5uZWNlc3NhcmlseQogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGdldF9iaW5fcGF0aChzZWxmLCBhcmcsIHJlcXVpcmVkPUZhbHNlLCBvcHRfZGlycz1bXSk6CiAgICAgICAgJycnCiAgICAgICAgZmluZCBzeXN0ZW0gZXhlY3V0YWJsZSBpbiBQQVRILgogICAgICAgIE9wdGlvbmFsIGFyZ3VtZW50czoKICAgICAgICAgICAtIHJlcXVpcmVkOiAgaWYgZXhlY3V0YWJsZSBpcyBub3QgZm91bmQgYW5kIHJlcXVpcmVkIGlzIHRydWUsIGZhaWxfanNvbgogICAgICAgICAgIC0gb3B0X2RpcnM6ICBvcHRpb25hbCBsaXN0IG9mIGRpcmVjdG9yaWVzIHRvIHNlYXJjaCBpbiBhZGRpdGlvbiB0byBQQVRICiAgICAgICAgaWYgZm91bmQgcmV0dXJuIGZ1bGwgcGF0aDsgb3RoZXJ3aXNlIHJldHVybiBOb25lCiAgICAgICAgJycnCiAgICAgICAgc2Jpbl9wYXRocyA9IFsnL3NiaW4nLCAnL3Vzci9zYmluJywgJy91c3IvbG9jYWwvc2JpbiddCiAgICAgICAgcGF0aHMgPSBbXQogICAgICAgIGZvciBkIGluIG9wdF9kaXJzOgogICAgICAgICAgICBpZiBkIGlzIG5vdCBOb25lIGFuZCBvcy5wYXRoLmV4aXN0cyhkKToKICAgICAgICAgICAgICAgIHBhdGhzLmFwcGVuZChkKQogICAgICAgIHBhdGhzICs9IG9zLmVudmlyb24uZ2V0KCdQQVRIJywgJycpLnNwbGl0KG9zLnBhdGhzZXApCiAgICAgICAgYmluX3BhdGggPSBOb25lCiAgICAgICAgIyBtYW5nbGUgUEFUSCB0byBpbmNsdWRlIC9zYmluIGRpcnMKICAgICAgICBmb3IgcCBpbiBzYmluX3BhdGhzOgogICAgICAgICAgICBpZiBwIG5vdCBpbiBwYXRocyBhbmQgb3MucGF0aC5leGlzdHMocCk6CiAgICAgICAgICAgICAgICBwYXRocy5hcHBlbmQocCkKICAgICAgICBmb3IgZCBpbiBwYXRoczoKICAgICAgICAgICAgaWYgbm90IGQ6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBwYXRoID0gb3MucGF0aC5qb2luKGQsIGFyZykKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocGF0aCkgYW5kIG5vdCBvcy5wYXRoLmlzZGlyKHBhdGgpIGFuZCBpc19leGVjdXRhYmxlKHBhdGgpOgogICAgICAgICAgICAgICAgYmluX3BhdGggPSBwYXRoCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGlmIHJlcXVpcmVkIGFuZCBiaW5fcGF0aCBpcyBOb25lOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0ZhaWxlZCB0byBmaW5kIHJlcXVpcmVkIGV4ZWN1dGFibGUgJXMgaW4gcGF0aHM6ICVzJyAlIChhcmcsIG9zLnBhdGhzZXAuam9pbihwYXRocykpKQogICAgICAgIHJldHVybiBiaW5fcGF0aAoKICAgIGRlZiBib29sZWFuKHNlbGYsIGFyZyk6CiAgICAgICAgJycnIHJldHVybiBhIGJvb2wgZm9yIHRoZSBhcmcgJycnCiAgICAgICAgaWYgYXJnIGlzIE5vbmUgb3IgaXNpbnN0YW5jZShhcmcsIGJvb2wpOgogICAgICAgICAgICByZXR1cm4gYXJnCiAgICAgICAgaWYgaXNpbnN0YW5jZShhcmcsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIGFyZyA9IGFyZy5sb3dlcigpCiAgICAgICAgaWYgYXJnIGluIEJPT0xFQU5TX1RSVUU6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxpZiBhcmcgaW4gQk9PTEVBTlNfRkFMU0U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nJXMgaXMgbm90IGEgdmFsaWQgYm9vbGVhbi4gVmFsaWQgYm9vbGVhbnMgaW5jbHVkZTogJXMnICUgKHRvX3RleHQoYXJnKSwgJywnLmpvaW4oWyclcycgJSB4IGZvciB4IGluIEJPT0xFQU5TXSkpKQoKICAgIGRlZiBqc29uaWZ5KHNlbGYsIGRhdGEpOgogICAgICAgIGZvciBlbmNvZGluZyBpbiAoInV0Zi04IiwgImxhdGluLTEiKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24uZHVtcHMoZGF0YSwgZW5jb2Rpbmc9ZW5jb2RpbmcpCiAgICAgICAgICAgICMgT2xkIHN5c3RlbXMgdXNpbmcgb2xkIHNpbXBsZWpzb24gbW9kdWxlIGRvZXMgbm90IHN1cHBvcnQgZW5jb2Rpbmcga2V5d29yZC4KICAgICAgICAgICAgZXhjZXB0IFR5cGVFcnJvcjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBuZXdfZGF0YSA9IGpzb25fZGljdF9ieXRlc190b191bmljb2RlKGRhdGEsIGVuY29kaW5nPWVuY29kaW5nKQogICAgICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVEZWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24uZHVtcHMobmV3X2RhdGEpCiAgICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRGVjb2RlRXJyb3I6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nSW52YWxpZCB1bmljb2RlIGVuY29kaW5nIGVuY291bnRlcmVkJykKCiAgICBkZWYgZnJvbV9qc29uKHNlbGYsIGRhdGEpOgogICAgICAgIHJldHVybiBqc29uLmxvYWRzKGRhdGEpCgogICAgZGVmIGFkZF9jbGVhbnVwX2ZpbGUoc2VsZiwgcGF0aCk6CiAgICAgICAgaWYgcGF0aCBub3QgaW4gc2VsZi5jbGVhbnVwX2ZpbGVzOgogICAgICAgICAgICBzZWxmLmNsZWFudXBfZmlsZXMuYXBwZW5kKHBhdGgpCgogICAgZGVmIGRvX2NsZWFudXBfZmlsZXMoc2VsZik6CiAgICAgICAgZm9yIHBhdGggaW4gc2VsZi5jbGVhbnVwX2ZpbGVzOgogICAgICAgICAgICBzZWxmLmNsZWFudXAocGF0aCkKCiAgICBkZWYgX3JldHVybl9mb3JtYXR0ZWQoc2VsZiwga3dhcmdzKToKCiAgICAgICAgc2VsZi5hZGRfcGF0aF9pbmZvKGt3YXJncykKCiAgICAgICAgaWYgJ2ludm9jYXRpb24nIG5vdCBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGt3YXJnc1snaW52b2NhdGlvbiddID0geydtb2R1bGVfYXJncyc6IHNlbGYucGFyYW1zfQoKICAgICAgICBpZiAnd2FybmluZ3MnIGluIGt3YXJnczoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShrd2FyZ3NbJ3dhcm5pbmdzJ10sIGxpc3QpOgogICAgICAgICAgICAgICAgZm9yIHcgaW4ga3dhcmdzWyd3YXJuaW5ncyddOgogICAgICAgICAgICAgICAgICAgIHNlbGYud2Fybih3KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi53YXJuKGt3YXJnc1snd2FybmluZ3MnXSkKCiAgICAgICAgaWYgc2VsZi5fd2FybmluZ3M6CiAgICAgICAgICAgIGt3YXJnc1snd2FybmluZ3MnXSA9IHNlbGYuX3dhcm5pbmdzCgogICAgICAgIGlmICdkZXByZWNhdGlvbnMnIGluIGt3YXJnczoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddLCBsaXN0KToKICAgICAgICAgICAgICAgIGZvciBkIGluIGt3YXJnc1snZGVwcmVjYXRpb25zJ106CiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkLCBTRVFVRU5DRVRZUEUpIGFuZCBsZW4oZCkgPT0gMjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kZXByZWNhdGUoZFswXSwgdmVyc2lvbj1kWzFdKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGVwcmVjYXRlKGQpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmRlcHJlY2F0ZShrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddKQoKICAgICAgICBpZiBzZWxmLl9kZXByZWNhdGlvbnM6CiAgICAgICAgICAgIGt3YXJnc1snZGVwcmVjYXRpb25zJ10gPSBzZWxmLl9kZXByZWNhdGlvbnMKCiAgICAgICAga3dhcmdzID0gcmVtb3ZlX3ZhbHVlcyhrd2FyZ3MsIHNlbGYubm9fbG9nX3ZhbHVlcykKICAgICAgICBwcmludCgnXG4lcycgJSBzZWxmLmpzb25pZnkoa3dhcmdzKSkKCiAgICBkZWYgZXhpdF9qc29uKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAnJycgcmV0dXJuIGZyb20gdGhlIG1vZHVsZSwgd2l0aG91dCBlcnJvciAnJycKCiAgICAgICAgaWYgbm90ICdjaGFuZ2VkJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGt3YXJnc1snY2hhbmdlZCddID0gRmFsc2UKCiAgICAgICAgc2VsZi5kb19jbGVhbnVwX2ZpbGVzKCkKICAgICAgICBzZWxmLl9yZXR1cm5fZm9ybWF0dGVkKGt3YXJncykKICAgICAgICBzeXMuZXhpdCgwKQoKICAgIGRlZiBmYWlsX2pzb24oc2VsZiwgKiprd2FyZ3MpOgogICAgICAgICcnJyByZXR1cm4gZnJvbSB0aGUgbW9kdWxlLCB3aXRoIGFuIGVycm9yIG1lc3NhZ2UgJycnCgogICAgICAgIGFzc2VydCAnbXNnJyBpbiBrd2FyZ3MsICJpbXBsZW1lbnRhdGlvbiBlcnJvciAtLSBtc2cgdG8gZXhwbGFpbiB0aGUgZXJyb3IgaXMgcmVxdWlyZWQiCiAgICAgICAga3dhcmdzWydmYWlsZWQnXSA9IFRydWUKCiAgICAgICAgaWYgbm90ICdjaGFuZ2VkJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGt3YXJnc1snY2hhbmdlZCddID0gRmFsc2UKCiAgICAgICAgc2VsZi5kb19jbGVhbnVwX2ZpbGVzKCkKICAgICAgICBzZWxmLl9yZXR1cm5fZm9ybWF0dGVkKGt3YXJncykKICAgICAgICBzeXMuZXhpdCgxKQoKICAgIGRlZiBmYWlsX29uX21pc3NpbmdfcGFyYW1zKHNlbGYsIHJlcXVpcmVkX3BhcmFtcz1Ob25lKToKICAgICAgICAnJycgVGhpcyBpcyBmb3IgY2hlY2tpbmcgZm9yIHJlcXVpcmVkIHBhcmFtcyB3aGVuIHdlIGNhbiBub3QgY2hlY2sgdmlhIGFyZ3NwZWMgYmVjYXVzZSB3ZQogICAgICAgIG5lZWQgbW9yZSBpbmZvcm1hdGlvbiB0aGFuIGlzIHNpbXBseSBnaXZlbiBpbiB0aGUgYXJnc3BlYy4KICAgICAgICAnJycKICAgICAgICBpZiBub3QgcmVxdWlyZWRfcGFyYW1zOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBtaXNzaW5nX3BhcmFtcyA9IFtdCiAgICAgICAgZm9yIHJlcXVpcmVkX3BhcmFtIGluIHJlcXVpcmVkX3BhcmFtczoKICAgICAgICAgICAgaWYgbm90IHNlbGYucGFyYW1zLmdldChyZXF1aXJlZF9wYXJhbSk6CiAgICAgICAgICAgICAgICBtaXNzaW5nX3BhcmFtcy5hcHBlbmQocmVxdWlyZWRfcGFyYW0pCiAgICAgICAgaWYgbWlzc2luZ19wYXJhbXM6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0ibWlzc2luZyByZXF1aXJlZCBhcmd1bWVudHM6ICVzIiAlICcsJy5qb2luKG1pc3NpbmdfcGFyYW1zKSkKCiAgICBkZWYgZGlnZXN0X2Zyb21fZmlsZShzZWxmLCBmaWxlbmFtZSwgYWxnb3JpdGhtKToKICAgICAgICAnJycgUmV0dXJuIGhleCBkaWdlc3Qgb2YgbG9jYWwgZmlsZSBmb3IgYSBkaWdlc3RfbWV0aG9kIHNwZWNpZmllZCBieSBuYW1lLCBvciBOb25lIGlmIGZpbGUgaXMgbm90IHByZXNlbnQuICcnJwogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlbmFtZSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgaWYgb3MucGF0aC5pc2RpcihmaWxlbmFtZSk6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iYXR0ZW1wdGVkIHRvIHRha2UgY2hlY2tzdW0gb2YgZGlyZWN0b3J5OiAlcyIgJSBmaWxlbmFtZSkKCiAgICAgICAgIyBwcmVzZXJ2ZSBvbGQgYmVoYXZpb3VyIHdoZXJlIHRoZSB0aGlyZCBwYXJhbWV0ZXIgd2FzIGEgaGFzaCBhbGdvcml0aG0gb2JqZWN0CiAgICAgICAgaWYgaGFzYXR0cihhbGdvcml0aG0sICdoZXhkaWdlc3QnKToKICAgICAgICAgICAgZGlnZXN0X21ldGhvZCA9IGFsZ29yaXRobQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRpZ2VzdF9tZXRob2QgPSBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TW2FsZ29yaXRobV0oKQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IkNvdWxkIG5vdCBoYXNoIGZpbGUgJyVzJyB3aXRoIGFsZ29yaXRobSAnJXMnLiBBdmFpbGFibGUgYWxnb3JpdGhtczogJXMiICUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZmlsZW5hbWUsIGFsZ29yaXRobSwgJywgJy5qb2luKEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVMpKSkKCiAgICAgICAgYmxvY2tzaXplID0gNjQgKiAxMDI0CiAgICAgICAgaW5maWxlID0gb3Blbihvcy5wYXRoLnJlYWxwYXRoKGZpbGVuYW1lKSwgJ3JiJykKICAgICAgICBibG9jayA9IGluZmlsZS5yZWFkKGJsb2Nrc2l6ZSkKICAgICAgICB3aGlsZSBibG9jazoKICAgICAgICAgICAgZGlnZXN0X21ldGhvZC51cGRhdGUoYmxvY2spCiAgICAgICAgICAgIGJsb2NrID0gaW5maWxlLnJlYWQoYmxvY2tzaXplKQogICAgICAgIGluZmlsZS5jbG9zZSgpCiAgICAgICAgcmV0dXJuIGRpZ2VzdF9tZXRob2QuaGV4ZGlnZXN0KCkKCiAgICBkZWYgbWQ1KHNlbGYsIGZpbGVuYW1lKToKICAgICAgICAnJycgUmV0dXJuIE1ENSBoZXggZGlnZXN0IG9mIGxvY2FsIGZpbGUgdXNpbmcgZGlnZXN0X2Zyb21fZmlsZSgpLgoKICAgICAgICBEbyBub3QgdXNlIHRoaXMgZnVuY3Rpb24gdW5sZXNzIHlvdSBoYXZlIG5vIG90aGVyIGNob2ljZSBmb3I6CiAgICAgICAgICAgIDEpIE9wdGlvbmFsIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CiAgICAgICAgICAgIDIpIENvbXBhdGliaWxpdHkgd2l0aCBhIHRoaXJkIHBhcnR5IHByb3RvY29sCgogICAgICAgIFRoaXMgZnVuY3Rpb24gd2lsbCBub3Qgd29yayBvbiBzeXN0ZW1zIGNvbXBseWluZyB3aXRoIEZJUFMtMTQwLTIuCgogICAgICAgIE1vc3QgdXNlcyBvZiB0aGlzIGZ1bmN0aW9uIGNhbiB1c2UgdGhlIG1vZHVsZS5zaGExIGZ1bmN0aW9uIGluc3RlYWQuCiAgICAgICAgJycnCiAgICAgICAgaWYgJ21kNScgbm90IGluIEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVM6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ01ENSBub3QgYXZhaWxhYmxlLiAgUG9zc2libHkgcnVubmluZyBpbiBGSVBTIG1vZGUnKQogICAgICAgIHJldHVybiBzZWxmLmRpZ2VzdF9mcm9tX2ZpbGUoZmlsZW5hbWUsICdtZDUnKQoKICAgIGRlZiBzaGExKHNlbGYsIGZpbGVuYW1lKToKICAgICAgICAnJycgUmV0dXJuIFNIQTEgaGV4IGRpZ2VzdCBvZiBsb2NhbCBmaWxlIHVzaW5nIGRpZ2VzdF9mcm9tX2ZpbGUoKS4gJycnCiAgICAgICAgcmV0dXJuIHNlbGYuZGlnZXN0X2Zyb21fZmlsZShmaWxlbmFtZSwgJ3NoYTEnKQoKICAgIGRlZiBzaGEyNTYoc2VsZiwgZmlsZW5hbWUpOgogICAgICAgICcnJyBSZXR1cm4gU0hBLTI1NiBoZXggZGlnZXN0IG9mIGxvY2FsIGZpbGUgdXNpbmcgZGlnZXN0X2Zyb21fZmlsZSgpLiAnJycKICAgICAgICByZXR1cm4gc2VsZi5kaWdlc3RfZnJvbV9maWxlKGZpbGVuYW1lLCAnc2hhMjU2JykKCiAgICBkZWYgYmFja3VwX2xvY2FsKHNlbGYsIGZuKToKICAgICAgICAnJydtYWtlIGEgZGF0ZS1tYXJrZWQgYmFja3VwIG9mIHRoZSBzcGVjaWZpZWQgZmlsZSwgcmV0dXJuIFRydWUgb3IgRmFsc2Ugb24gc3VjY2VzcyBvciBmYWlsdXJlJycnCgogICAgICAgIGJhY2t1cGRlc3QgPSAnJwogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGZuKToKICAgICAgICAgICAgIyBiYWNrdXBzIG5hbWVkIGJhc2VuYW1lLlBJRC5ZWVlZLU1NLUREQEhIOk1NOlNTfgogICAgICAgICAgICBleHQgPSB0aW1lLnN0cmZ0aW1lKCIlWS0lbS0lZEAlSDolTTolU34iLCB0aW1lLmxvY2FsdGltZSh0aW1lLnRpbWUoKSkpCiAgICAgICAgICAgIGJhY2t1cGRlc3QgPSAnJXMuJXMuJXMnICUgKGZuLCBvcy5nZXRwaWQoKSwgZXh0KQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHkyKGZuLCBiYWNrdXBkZXN0KQogICAgICAgICAgICBleGNlcHQgKHNodXRpbC5FcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0NvdWxkIG5vdCBtYWtlIGJhY2t1cCBvZiAlcyB0byAlczogJXMnICUgKGZuLCBiYWNrdXBkZXN0LCBlKSkKCiAgICAgICAgcmV0dXJuIGJhY2t1cGRlc3QKCiAgICBkZWYgY2xlYW51cChzZWxmLCB0bXBmaWxlKToKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh0bXBmaWxlKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MudW5saW5rKHRtcGZpbGUpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc3lzLnN0ZGVyci53cml0ZSgiY291bGQgbm90IGNsZWFudXAgJXM6ICVzIiAlICh0bXBmaWxlLCBlKSkKCiAgICBkZWYgYXRvbWljX21vdmUoc2VsZiwgc3JjLCBkZXN0LCB1bnNhZmVfd3JpdGVzPUZhbHNlKToKICAgICAgICAnJydhdG9taWNhbGx5IG1vdmUgc3JjIHRvIGRlc3QsIGNvcHlpbmcgYXR0cmlidXRlcyBmcm9tIGRlc3QsIHJldHVybnMgdHJ1ZSBvbiBzdWNjZXNzCiAgICAgICAgaXQgdXNlcyBvcy5yZW5hbWUgdG8gZW5zdXJlIHRoaXMgYXMgaXQgaXMgYW4gYXRvbWljIG9wZXJhdGlvbiwgcmVzdCBvZiB0aGUgZnVuY3Rpb24gaXMKICAgICAgICB0byB3b3JrIGFyb3VuZCBsaW1pdGF0aW9ucywgY29ybmVyIGNhc2VzIGFuZCBlbnN1cmUgc2VsaW51eCBjb250ZXh0IGlzIHNhdmVkIGlmIHBvc3NpYmxlJycnCiAgICAgICAgY29udGV4dCA9IE5vbmUKICAgICAgICBkZXN0X3N0YXQgPSBOb25lCiAgICAgICAgYl9zcmMgPSB0b19ieXRlcyhzcmMsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgYl9kZXN0ID0gdG9fYnl0ZXMoZGVzdCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhiX2Rlc3QpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZXN0X3N0YXQgPSBvcy5zdGF0KGJfZGVzdCkKCiAgICAgICAgICAgICAgICAjIGNvcHkgbW9kZSBhbmQgb3duZXJzaGlwCiAgICAgICAgICAgICAgICBvcy5jaG1vZChiX3NyYywgZGVzdF9zdGF0LnN0X21vZGUgJiBQRVJNX0JJVFMpCiAgICAgICAgICAgICAgICBvcy5jaG93bihiX3NyYywgZGVzdF9zdGF0LnN0X3VpZCwgZGVzdF9zdGF0LnN0X2dpZCkKCiAgICAgICAgICAgICAgICAjIHRyeSB0byBjb3B5IGZsYWdzIGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKG9zLCAnY2hmbGFncycpIGFuZCBoYXNhdHRyKGRlc3Rfc3RhdCwgJ3N0X2ZsYWdzJyk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBvcy5jaGZsYWdzKGJfc3JjLCBkZXN0X3N0YXQuc3RfZmxhZ3MpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGVyciBpbiAnRU9QTk9UU1VQUCcsICdFTk9UU1VQJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoZXJybm8sIGVycikgYW5kIGUuZXJybm8gPT0gZ2V0YXR0cihlcnJubywgZXJyKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBpZiBlLmVycm5vICE9IGVycm5vLkVQRVJNOgogICAgICAgICAgICAgICAgICAgIHJhaXNlCiAgICAgICAgICAgIGlmIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2NvbnRleHQoZGVzdCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9kZWZhdWx0X2NvbnRleHQoZGVzdCkKCiAgICAgICAgY3JlYXRpbmcgPSBub3Qgb3MucGF0aC5leGlzdHMoYl9kZXN0KQoKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgT3B0aW1pc3RpY2FsbHkgdHJ5IGEgcmVuYW1lLCBzb2x2ZXMgc29tZSBjb3JuZXIgY2FzZXMgYW5kIGNhbiBhdm9pZCB1c2VsZXNzIHdvcmssIHRocm93cyBleGNlcHRpb24gaWYgbm90IGF0b21pYy4KICAgICAgICAgICAgb3MucmVuYW1lKGJfc3JjLCBiX2Rlc3QpCiAgICAgICAgZXhjZXB0IChJT0Vycm9yLCBPU0Vycm9yKToKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBpZiBlLmVycm5vIG5vdCBpbiBbZXJybm8uRVBFUk0sIGVycm5vLkVYREVWLCBlcnJuby5FQUNDRVMsIGVycm5vLkVUWFRCU1ksIGVycm5vLkVCVVNZXToKICAgICAgICAgICAgICAgICMgb25seSB0cnkgd29ya2Fyb3VuZHMgZm9yIGVycm5vIDE4IChjcm9zcyBkZXZpY2UpLCAxIChub3QgcGVybWl0dGVkKSwgIDEzIChwZXJtaXNzaW9uIGRlbmllZCkKICAgICAgICAgICAgICAgICMgYW5kIDI2ICh0ZXh0IGZpbGUgYnVzeSkgd2hpY2ggaGFwcGVucyBvbiB2YWdyYW50IHN5bmNlZCBmb2xkZXJzIGFuZCBvdGhlciAnZXhvdGljJyBub24gcG9zaXggZmlsZSBzeXN0ZW1zCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0NvdWxkIG5vdCByZXBsYWNlIGZpbGU6ICVzIHRvICVzOiAlcycgJSAoc3JjLCBkZXN0LCBlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBiX2Rlc3RfZGlyID0gb3MucGF0aC5kaXJuYW1lKGJfZGVzdCkKICAgICAgICAgICAgICAgICMgVXNlIGJ5dGVzIGhlcmUuICBJbiB0aGUgc2hpcHBhYmxlIENJLCB0aGlzIGZhaWxzIHdpdGgKICAgICAgICAgICAgICAgICMgYSBVbmljb2RlRXJyb3Igd2l0aCBzdXJyb2dhdGVlc2NhcGUnZCBzdHJpbmdzIGZvciBhbiB1bmtub3duCiAgICAgICAgICAgICAgICAjIHJlYXNvbiAoZG9lc24ndCBoYXBwZW4gaW4gYSBsb2NhbCBVYnVudHUxNi4wNCBWTSkKICAgICAgICAgICAgICAgIG5hdGl2ZV9kZXN0X2RpciA9IGJfZGVzdF9kaXIKICAgICAgICAgICAgICAgIG5hdGl2ZV9zdWZmaXggPSBvcy5wYXRoLmJhc2VuYW1lKGJfZGVzdCkKICAgICAgICAgICAgICAgIG5hdGl2ZV9wcmVmaXggPSBiKCcuYW5zaWJsZV90bXAnKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHRtcF9kZXN0X2ZkLCB0bXBfZGVzdF9uYW1lID0gdGVtcGZpbGUubWtzdGVtcCggcHJlZml4PW5hdGl2ZV9wcmVmaXgsIGRpcj1uYXRpdmVfZGVzdF9kaXIsIHN1ZmZpeD1uYXRpdmVfc3VmZml4KQogICAgICAgICAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdUaGUgZGVzdGluYXRpb24gZGlyZWN0b3J5ICglcykgaXMgbm90IHdyaXRhYmxlIGJ5IHRoZSBjdXJyZW50IHVzZXIuIEVycm9yIHdhczogJXMnICUgKG9zLnBhdGguZGlybmFtZShkZXN0KSwgZSkpCiAgICAgICAgICAgICAgICBleGNlcHQgVHlwZUVycm9yOgogICAgICAgICAgICAgICAgICAgICMgV2UgZXhwZWN0IHRoYXQgdGhpcyBpcyBoYXBwZW5pbmcgYmVjYXVzZSBweXRob24zLjQueCBhbmQKICAgICAgICAgICAgICAgICAgICAjIGJlbG93IGNhbid0IGhhbmRsZSBieXRlIHN0cmluZ3MgaW4gbWtzdGVtcCgpLiAgVHJhY2ViYWNrCiAgICAgICAgICAgICAgICAgICAgIyB3b3VsZCBlbmQgaW4gc29tZXRoaW5nIGxpa2U6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgZmlsZSA9IF9vcy5wYXRoLmpvaW4oZGlyLCBwcmUgKyBuYW1lICsgc3VmKQogICAgICAgICAgICAgICAgICAgICMgVHlwZUVycm9yOiBjYW4ndCBjb25jYXQgYnl0ZXMgdG8gc3RyCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdGYWlsZWQgY3JlYXRpbmcgdGVtcCBmaWxlIGZvciBhdG9taWMgbW92ZS4gIFRoaXMgdXN1YWxseSBoYXBwZW5zIHdoZW4gdXNpbmcgUHl0aG9uMyBsZXNzIHRoYW4gUHl0aG9uMy41LiAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdQbGVhc2UgdXNlIFB5dGhvbjIueCBvciBQeXRob24zLjUgb3IgZ3JlYXRlci4nLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKCiAgICAgICAgICAgICAgICBiX3RtcF9kZXN0X25hbWUgPSB0b19ieXRlcyh0bXBfZGVzdF9uYW1lLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgY2xvc2UgdG1wIGZpbGUgaGFuZGxlIGJlZm9yZSBmaWxlIG9wZXJhdGlvbnMgdG8gcHJldmVudCB0ZXh0IGZpbGUgYnVzeSBlcnJvcnMgb24gdmJveGZzIHN5bmNlZCBmb2xkZXJzICh3aW5kb3dzIGhvc3QpCiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNsb3NlKHRtcF9kZXN0X2ZkKQogICAgICAgICAgICAgICAgICAgICAgICAjIGxlYXZlcyB0bXAgZmlsZSBiZWhpbmQgd2hlbiBzdWRvIGFuZCBub3Qgcm9vdAogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaHV0aWwubW92ZShiX3NyYywgYl90bXBfZGVzdF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgY2xlYW51cCB3aWxsIGhhcHBlbiBieSAncm0nIG9mIHRlbXBkaXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgY29weTIgd2lsbCBwcmVzZXJ2ZSBzb21lIG1ldGFkYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaHV0aWwuY29weTIoYl9zcmMsIGJfdG1wX2Rlc3RfbmFtZSkKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiX3RtcF9kZXN0X25hbWUsIGNvbnRleHQsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBfc3RhdCA9IG9zLnN0YXQoYl90bXBfZGVzdF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZGVzdF9zdGF0IGFuZCAodG1wX3N0YXQuc3RfdWlkICE9IGRlc3Rfc3RhdC5zdF91aWQgb3IgdG1wX3N0YXQuc3RfZ2lkICE9IGRlc3Rfc3RhdC5zdF9naWQpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNob3duKGJfdG1wX2Rlc3RfbmFtZSwgZGVzdF9zdGF0LnN0X3VpZCwgZGVzdF9zdGF0LnN0X2dpZCkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBlLmVycm5vICE9IGVycm5vLkVQRVJNOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLnJlbmFtZShiX3RtcF9kZXN0X25hbWUsIGJfZGVzdCkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdW5zYWZlX3dyaXRlcyBhbmQgZS5lcnJubyA9PSBlcnJuby5FQlVTWToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91bnNhZmVfd3JpdGVzKGJfdG1wX2Rlc3RfbmFtZSwgYl9kZXN0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J1VuYWJsZSB0byByZW5hbWUgZmlsZTogJXMgdG8gJXM6ICVzJyAlIChzcmMsIGRlc3QsIGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgKHNodXRpbC5FcnJvciwgT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdGYWlsZWQgdG8gcmVwbGFjZSBmaWxlOiAlcyB0byAlczogJXMnICUgKHNyYywgZGVzdCwgZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQogICAgICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgICAgICBzZWxmLmNsZWFudXAoYl90bXBfZGVzdF9uYW1lKQoKICAgICAgICBpZiBjcmVhdGluZzoKICAgICAgICAgICAgIyBtYWtlIHN1cmUgdGhlIGZpbGUgaGFzIHRoZSBjb3JyZWN0IHBlcm1pc3Npb25zCiAgICAgICAgICAgICMgYmFzZWQgb24gdGhlIGN1cnJlbnQgdmFsdWUgb2YgdW1hc2sKICAgICAgICAgICAgdW1hc2sgPSBvcy51bWFzaygwKQogICAgICAgICAgICBvcy51bWFzayh1bWFzaykKICAgICAgICAgICAgb3MuY2htb2QoYl9kZXN0LCBERUZBVUxUX1BFUk0gJiB+dW1hc2spCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLmNob3duKGJfZGVzdCwgb3MuZ2V0ZXVpZCgpLCBvcy5nZXRlZ2lkKCkpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgIyBXZSdyZSBva2F5IHdpdGggdHJ5aW5nIG91ciBiZXN0IGhlcmUuICBJZiB0aGUgdXNlciBpcyBub3QKICAgICAgICAgICAgICAgICMgcm9vdCAob3Igb2xkIFVuaWNlcykgdGhleSB3b24ndCBiZSBhYmxlIHRvIGNob3duLgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAjIHJlbmFtZSBtaWdodCBub3QgcHJlc2VydmUgY29udGV4dAogICAgICAgICAgICBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudChkZXN0LCBjb250ZXh0LCBGYWxzZSkKCiAgICBkZWYgX3Vuc2FmZV93cml0ZXMoc2VsZiwgc3JjLCBkZXN0KToKICAgICAgICAjIHNhZGx5IHRoZXJlIGFyZSBzb21lIHNpdHVhdGlvbnMgd2hlcmUgd2UgY2Fubm90IGVuc3VyZSBhdG9taWNpdHksIGJ1dCBvbmx5IGlmCiAgICAgICAgIyB0aGUgdXNlciBpbnNpc3RzIGFuZCB3ZSBnZXQgdGhlIGFwcHJvcHJpYXRlIGVycm9yIHdlIHVwZGF0ZSB0aGUgZmlsZSB1bnNhZmVseQogICAgICAgIHRyeToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3V0X2Rlc3QgPSBvcGVuKGRlc3QsICd3YicpCiAgICAgICAgICAgICAgICBpbl9zcmMgPSBvcGVuKHNyYywgJ3JiJykKICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5ZmlsZW9iaihpbl9zcmMsIG91dF9kZXN0KQogICAgICAgICAgICBmaW5hbGx5OiAgIyBhc3N1cmluZyBjbG9zZWQgZmlsZXMgaW4gMi40IGNvbXBhdGlibGUgd2F5CiAgICAgICAgICAgICAgICBpZiBvdXRfZGVzdDoKICAgICAgICAgICAgICAgICAgICBvdXRfZGVzdC5jbG9zZSgpCiAgICAgICAgICAgICAgICBpZiBpbl9zcmM6CiAgICAgICAgICAgICAgICAgICAgaW5fc3JjLmNsb3NlKCkKICAgICAgICBleGNlcHQgKHNodXRpbC5FcnJvciwgT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdDb3VsZCBub3Qgd3JpdGUgZGF0YSB0byBmaWxlICglcykgZnJvbSAoJXMpOiAlcycgJSAoZGVzdCwgc3JjLCBlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCgoKICAgIGRlZiBfcmVhZF9mcm9tX3BpcGVzKHNlbGYsIHJwaXBlcywgcmZkcywgZmlsZV9kZXNjcmlwdG9yKToKICAgICAgICBkYXRhID0gYignJykKICAgICAgICBpZiBmaWxlX2Rlc2NyaXB0b3IgaW4gcmZkczoKICAgICAgICAgICAgZGF0YSA9IG9zLnJlYWQoZmlsZV9kZXNjcmlwdG9yLmZpbGVubygpLCA5MDAwKQogICAgICAgICAgICBpZiBkYXRhID09IGIoJycpOgogICAgICAgICAgICAgICAgcnBpcGVzLnJlbW92ZShmaWxlX2Rlc2NyaXB0b3IpCgogICAgICAgIHJldHVybiBkYXRhCgogICAgZGVmIHJ1bl9jb21tYW5kKHNlbGYsIGFyZ3MsIGNoZWNrX3JjPUZhbHNlLCBjbG9zZV9mZHM9VHJ1ZSwgZXhlY3V0YWJsZT1Ob25lLCBkYXRhPU5vbmUsIGJpbmFyeV9kYXRhPUZhbHNlLCBwYXRoX3ByZWZpeD1Ob25lLCBjd2Q9Tm9uZSwKICAgICAgICAgICAgICAgICAgICB1c2VfdW5zYWZlX3NoZWxsPUZhbHNlLCBwcm9tcHRfcmVnZXg9Tm9uZSwgZW52aXJvbl91cGRhdGU9Tm9uZSwgdW1hc2s9Tm9uZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0Jyk6CiAgICAgICAgJycnCiAgICAgICAgRXhlY3V0ZSBhIGNvbW1hbmQsIHJldHVybnMgcmMsIHN0ZG91dCwgYW5kIHN0ZGVyci4KCiAgICAgICAgOmFyZyBhcmdzOiBpcyB0aGUgY29tbWFuZCB0byBydW4KICAgICAgICAgICAgKiBJZiBhcmdzIGlzIGEgbGlzdCwgdGhlIGNvbW1hbmQgd2lsbCBiZSBydW4gd2l0aCBzaGVsbD1GYWxzZS4KICAgICAgICAgICAgKiBJZiBhcmdzIGlzIGEgc3RyaW5nIGFuZCB1c2VfdW5zYWZlX3NoZWxsPUZhbHNlIGl0IHdpbGwgc3BsaXQgYXJncyB0byBhIGxpc3QgYW5kIHJ1biB3aXRoIHNoZWxsPUZhbHNlCiAgICAgICAgICAgICogSWYgYXJncyBpcyBhIHN0cmluZyBhbmQgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlIGl0IHJ1bnMgd2l0aCBzaGVsbD1UcnVlLgogICAgICAgIDprdyBjaGVja19yYzogV2hldGhlciB0byBjYWxsIGZhaWxfanNvbiBpbiBjYXNlIG9mIG5vbiB6ZXJvIFJDLgogICAgICAgICAgICBEZWZhdWx0IEZhbHNlCiAgICAgICAgOmt3IGNsb3NlX2ZkczogU2VlIGRvY3VtZW50YXRpb24gZm9yIHN1YnByb2Nlc3MuUG9wZW4oKS4gRGVmYXVsdCBUcnVlCiAgICAgICAgOmt3IGV4ZWN1dGFibGU6IFNlZSBkb2N1bWVudGF0aW9uIGZvciBzdWJwcm9jZXNzLlBvcGVuKCkuIERlZmF1bHQgTm9uZQogICAgICAgIDprdyBkYXRhOiBJZiBnaXZlbiwgaW5mb3JtYXRpb24gdG8gd3JpdGUgdG8gdGhlIHN0ZGluIG9mIHRoZSBjb21tYW5kCiAgICAgICAgOmt3IGJpbmFyeV9kYXRhOiBJZiBGYWxzZSwgYXBwZW5kIGEgbmV3bGluZSB0byB0aGUgZGF0YS4gIERlZmF1bHQgRmFsc2UKICAgICAgICA6a3cgcGF0aF9wcmVmaXg6IElmIGdpdmVuLCBhZGRpdGlvbmFsIHBhdGggdG8gZmluZCB0aGUgY29tbWFuZCBpbi4KICAgICAgICAgICAgVGhpcyBhZGRzIHRvIHRoZSBQQVRIIGVudmlyb25tZW50IHZhaXJhYmxlIHNvIGhlbHBlciBjb21tYW5kcyBpbgogICAgICAgICAgICB0aGUgc2FtZSBkaXJlY3RvcnkgY2FuIGFsc28gYmUgZm91bmQKICAgICAgICA6a3cgY3dkOiBJZiBnaXZlbiwgd29ya2luZyBkaXJlY3RvcnkgdG8gcnVuIHRoZSBjb21tYW5kIGluc2lkZQogICAgICAgIDprdyB1c2VfdW5zYWZlX3NoZWxsOiBTZWUgYGFyZ3NgIHBhcmFtZXRlci4gIERlZmF1bHQgRmFsc2UKICAgICAgICA6a3cgcHJvbXB0X3JlZ2V4OiBSZWdleCBzdHJpbmcgKG5vdCBhIGNvbXBpbGVkIHJlZ2V4KSB3aGljaCBjYW4gYmUKICAgICAgICAgICAgdXNlZCB0byBkZXRlY3QgcHJvbXB0cyBpbiB0aGUgc3Rkb3V0IHdoaWNoIHdvdWxkIG90aGVyd2lzZSBjYXVzZQogICAgICAgICAgICB0aGUgZXhlY3V0aW9uIHRvIGhhbmcgKGVzcGVjaWFsbHkgaWYgbm8gaW5wdXQgZGF0YSBpcyBzcGVjaWZpZWQpCiAgICAgICAgOmt3IGVudmlyb25fdXBkYXRlOiBkaWN0aW9uYXJ5IHRvICp1cGRhdGUqIG9zLmVudmlyb24gd2l0aAogICAgICAgIDprdyB1bWFzazogVW1hc2sgdG8gYmUgdXNlZCB3aGVuIHJ1bm5pbmcgdGhlIGNvbW1hbmQuIERlZmF1bHQgTm9uZQogICAgICAgIDprdyBlbmNvZGluZzogU2luY2Ugd2UgcmV0dXJuIG5hdGl2ZSBzdHJpbmdzLCBvbiBweXRob24zIHdlIG5lZWQgdG8KICAgICAgICAgICAga25vdyB0aGUgZW5jb2RpbmcgdG8gdXNlIHRvIHRyYW5zZm9ybSBmcm9tIGJ5dGVzIHRvIHRleHQuICBJZiB5b3UKICAgICAgICAgICAgd2FudCB0byBhbHdheXMgZ2V0IGJ5dGVzIGJhY2ssIHVzZSBlbmNvZGluZz1Ob25lLiAgVGhlIGRlZmF1bHQgaXMKICAgICAgICAgICAgInV0Zi04Ii4gIFRoaXMgZG9lcyBub3QgYWZmZWN0IHRyYW5zZm9ybWF0aW9uIG9mIHN0cmluZ3MgZ2l2ZW4gYXMKICAgICAgICAgICAgYXJncy4KICAgICAgICA6a3cgZXJyb3JzOiBTaW5jZSB3ZSByZXR1cm4gbmF0aXZlIHN0cmluZ3MsIG9uIHB5dGhvbjMgd2UgbmVlZCB0bwogICAgICAgICAgICB0cmFuc2Zvcm0gc3Rkb3V0IGFuZCBzdGRlcnIgZnJvbSBieXRlcyB0byB0ZXh0LiAgSWYgdGhlIGJ5dGVzIGFyZQogICAgICAgICAgICB1bmRlY29kYWJsZSBpbiB0aGUgYGBlbmNvZGluZ2BgIHNwZWNpZmllZCwgdGhlbiB1c2UgdGhpcyBlcnJvcgogICAgICAgICAgICBoYW5kbGVyIHRvIGRlYWwgd2l0aCB0aGVtLiAgVGhlIGRlZmF1bHQgaXMgYGBzdXJyb2dhdGVfb3Jfc3RyaWN0YGAKICAgICAgICAgICAgd2hpY2ggbWVhbnMgdGhhdCB0aGUgYnl0ZXMgd2lsbCBiZSBkZWNvZGVkIHVzaW5nIHRoZQogICAgICAgICAgICBzdXJyb2dhdGVlc2NhcGUgZXJyb3IgaGFuZGxlciBpZiBhdmFpbGFibGUgKGF2YWlsYWJsZSBvbiBhbGwKICAgICAgICAgICAgcHl0aG9uMyB2ZXJzaW9ucyB3ZSBzdXBwb3J0KSBvdGhlcndpc2UgYSBVbmljb2RlRXJyb3IgdHJhY2ViYWNrCiAgICAgICAgICAgIHdpbGwgYmUgcmFpc2VkLiAgVGhpcyBkb2VzIG5vdCBhZmZlY3QgdHJhbnNmb3JtYXRpb25zIG9mIHN0cmluZ3MKICAgICAgICAgICAgZ2l2ZW4gYXMgYXJncy4KICAgICAgICA6cmV0dXJuczogQSAzLXR1cGxlIG9mIHJldHVybiBjb2RlIChpbnRlZ2VyKSwgc3Rkb3V0IChuYXRpdmUgc3RyaW5nKSwKICAgICAgICAgICAgYW5kIHN0ZGVyciAobmF0aXZlIHN0cmluZykuICBPbiBweXRob24yLCBzdGRvdXQgYW5kIHN0ZGVyciBhcmUgYm90aAogICAgICAgICAgICBieXRlIHN0cmluZ3MuICBPbiBweXRob24zLCBzdGRvdXQgYW5kIHN0ZGVyciBhcmUgdGV4dCBzdHJpbmdzIGNvbnZlcnRlZAogICAgICAgICAgICBhY2NvcmRpbmcgdG8gdGhlIGVuY29kaW5nIGFuZCBlcnJvcnMgcGFyYW1ldGVycy4gIElmIHlvdSB3YW50IGJ5dGUKICAgICAgICAgICAgc3RyaW5ncyBvbiBweXRob24zLCB1c2UgZW5jb2Rpbmc9Tm9uZSB0byB0dXJuIGRlY29kaW5nIHRvIHRleHQgb2ZmLgogICAgICAgICcnJwoKICAgICAgICBpZiBpc2luc3RhbmNlKGFyZ3MsIGxpc3QpOgogICAgICAgICAgICBpZiB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICAgICAgYXJncyA9ICIgIi5qb2luKFtzaGxleF9xdW90ZSh4KSBmb3IgeCBpbiBhcmdzXSkKICAgICAgICAgICAgICAgIHNoZWxsID0gVHJ1ZQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShhcmdzLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpIGFuZCB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICBzaGVsbCA9IFRydWUKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoYXJncywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKToKICAgICAgICAgICAgaWYgbm90IHVzZV91bnNhZmVfc2hlbGw6CiAgICAgICAgICAgICAgICAjIE9uIHB5dGhvbjIuNiBhbmQgYmVsb3csIHNobGV4IGhhcyBwcm9ibGVtcyB3aXRoIHRleHQgdHlwZQogICAgICAgICAgICAgICAgIyBPbiBweXRob24zLCBzaGxleCBuZWVkcyBhIHRleHQgdHlwZS4KICAgICAgICAgICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgICAgICAgICBhcmdzID0gdG9fYnl0ZXMoYXJncywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICAgICAgICAgIGVsaWYgUFkzOgogICAgICAgICAgICAgICAgICAgIGFyZ3MgPSB0b190ZXh0KGFyZ3MsIGVycm9ycz0nc3Vycm9nYXRlZXNjYXBlJykKICAgICAgICAgICAgICAgIGFyZ3MgPSBzaGxleC5zcGxpdChhcmdzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1zZyA9ICJBcmd1bWVudCAnYXJncycgdG8gcnVuX2NvbW1hbmQgbXVzdCBiZSBsaXN0IG9yIHN0cmluZyIKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocmM9MjU3LCBjbWQ9YXJncywgbXNnPW1zZykKCiAgICAgICAgc2hlbGwgPSBGYWxzZQogICAgICAgIGlmIHVzZV91bnNhZmVfc2hlbGw6CiAgICAgICAgICAgIGlmIGV4ZWN1dGFibGUgaXMgTm9uZToKICAgICAgICAgICAgICAgIGV4ZWN1dGFibGUgPSBvcy5lbnZpcm9uLmdldCgnU0hFTEwnKQogICAgICAgICAgICBpZiBleGVjdXRhYmxlOgogICAgICAgICAgICAgICAgYXJncyA9IFtleGVjdXRhYmxlLCAnLWMnLCBhcmdzXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2hlbGwgPSBUcnVlCgogICAgICAgIHByb21wdF9yZSA9IE5vbmUKICAgICAgICBpZiBwcm9tcHRfcmVnZXg6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocHJvbXB0X3JlZ2V4LCB0ZXh0X3R5cGUpOgogICAgICAgICAgICAgICAgaWYgUFkzOgogICAgICAgICAgICAgICAgICAgIHByb21wdF9yZWdleCA9IHRvX2J5dGVzKHByb21wdF9yZWdleCwgZXJyb3JzPSdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICAgICAgICAgZWxpZiBQWTI6CiAgICAgICAgICAgICAgICAgICAgcHJvbXB0X3JlZ2V4ID0gdG9fYnl0ZXMocHJvbXB0X3JlZ2V4LCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwcm9tcHRfcmUgPSByZS5jb21waWxlKHByb21wdF9yZWdleCwgcmUuTVVMVElMSU5FKQogICAgICAgICAgICBleGNlcHQgcmUuZXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImludmFsaWQgcHJvbXB0IHJlZ3VsYXIgZXhwcmVzc2lvbiBnaXZlbiB0byBydW5fY29tbWFuZCIpCgogICAgICAgICMgZXhwYW5kIHRoaW5ncyBsaWtlICRIT01FIGFuZCB+CiAgICAgICAgaWYgbm90IHNoZWxsOgogICAgICAgICAgICBhcmdzID0gWyBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKHgpKSBmb3IgeCBpbiBhcmdzIGlmIHggaXMgbm90IE5vbmUgXQoKICAgICAgICByYyA9IDAKICAgICAgICBtc2cgPSBOb25lCiAgICAgICAgc3RfaW4gPSBOb25lCgogICAgICAgICMgTWFuaXB1bGF0ZSB0aGUgZW52aXJvbiB3ZSdsbCBzZW5kIHRvIHRoZSBuZXcgcHJvY2VzcwogICAgICAgIG9sZF9lbnZfdmFscyA9IHt9CiAgICAgICAgIyBXZSBjYW4gc2V0IHRoaXMgZnJvbSBib3RoIGFuIGF0dHJpYnV0ZSBhbmQgcGVyIGNhbGwKICAgICAgICBmb3Iga2V5LCB2YWwgaW4gc2VsZi5ydW5fY29tbWFuZF9lbnZpcm9uX3VwZGF0ZS5pdGVtcygpOgogICAgICAgICAgICBvbGRfZW52X3ZhbHNba2V5XSA9IG9zLmVudmlyb24uZ2V0KGtleSwgTm9uZSkKICAgICAgICAgICAgb3MuZW52aXJvbltrZXldID0gdmFsCiAgICAgICAgaWYgZW52aXJvbl91cGRhdGU6CiAgICAgICAgICAgIGZvciBrZXksIHZhbCBpbiBlbnZpcm9uX3VwZGF0ZS5pdGVtcygpOgogICAgICAgICAgICAgICAgb2xkX2Vudl92YWxzW2tleV0gPSBvcy5lbnZpcm9uLmdldChrZXksIE5vbmUpCiAgICAgICAgICAgICAgICBvcy5lbnZpcm9uW2tleV0gPSB2YWwKICAgICAgICBpZiBwYXRoX3ByZWZpeDoKICAgICAgICAgICAgb2xkX2Vudl92YWxzWydQQVRIJ10gPSBvcy5lbnZpcm9uWydQQVRIJ10KICAgICAgICAgICAgb3MuZW52aXJvblsnUEFUSCddID0gIiVzOiVzIiAlIChwYXRoX3ByZWZpeCwgb3MuZW52aXJvblsnUEFUSCddKQoKICAgICAgICAjIElmIHVzaW5nIHRlc3QtbW9kdWxlIGFuZCBleHBsb2RlLCB0aGUgcmVtb3RlIGxpYiBwYXRoIHdpbGwgcmVzZW1ibGUgLi4uCiAgICAgICAgIyAgIC90bXAvdGVzdF9tb2R1bGVfc2NyYXRjaC9kZWJ1Z19kaXIvYW5zaWJsZS9tb2R1bGVfdXRpbHMvYmFzaWMucHkKICAgICAgICAjIElmIHVzaW5nIGFuc2libGUgb3IgYW5zaWJsZS1wbGF5Ym9vayB3aXRoIGEgcmVtb3RlIHN5c3RlbSAuLi4KICAgICAgICAjICAgL3RtcC9hbnNpYmxlX3Ztd2VMUS9hbnNpYmxlX21vZGxpYi56aXAvYW5zaWJsZS9tb2R1bGVfdXRpbHMvYmFzaWMucHkKCiAgICAgICAgIyBDbGVhbiBvdXQgcHl0aG9uIHBhdGhzIHNldCBieSBhbnNpYmFsbHoKICAgICAgICBpZiAnUFlUSE9OUEFUSCcgaW4gb3MuZW52aXJvbjoKICAgICAgICAgICAgcHlwYXRocyA9IG9zLmVudmlyb25bJ1BZVEhPTlBBVEgnXS5zcGxpdCgnOicpCiAgICAgICAgICAgIHB5cGF0aHMgPSBbeCBmb3IgeCBpbiBweXBhdGhzIFwKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHguZW5kc3dpdGgoJy9hbnNpYmxlX21vZGxpYi56aXAnKSBcCiAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBub3QgeC5lbmRzd2l0aCgnL2RlYnVnX2RpcicpXQogICAgICAgICAgICBvcy5lbnZpcm9uWydQWVRIT05QQVRIJ10gPSAnOicuam9pbihweXBhdGhzKQogICAgICAgICAgICBpZiBub3Qgb3MuZW52aXJvblsnUFlUSE9OUEFUSCddOgogICAgICAgICAgICAgICAgZGVsIG9zLmVudmlyb25bJ1BZVEhPTlBBVEgnXQoKICAgICAgICAjIGNyZWF0ZSBhIHByaW50YWJsZSB2ZXJzaW9uIG9mIHRoZSBjb21tYW5kIGZvciB1c2UKICAgICAgICAjIGluIHJlcG9ydGluZyBsYXRlciwgd2hpY2ggc3RyaXBzIG91dCB0aGluZ3MgbGlrZQogICAgICAgICMgcGFzc3dvcmRzIGZyb20gdGhlIGFyZ3MgbGlzdAogICAgICAgIHRvX2NsZWFuX2FyZ3MgPSBhcmdzCiAgICAgICAgaWYgUFkyOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGFyZ3MsIHRleHRfdHlwZSk6CiAgICAgICAgICAgICAgICB0b19jbGVhbl9hcmdzID0gdG9fYnl0ZXMoYXJncykKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGFyZ3MsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgICAgIHRvX2NsZWFuX2FyZ3MgPSB0b190ZXh0KGFyZ3MpCiAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgICAgICB0b19jbGVhbl9hcmdzID0gc2hsZXguc3BsaXQodG9fY2xlYW5fYXJncykKCiAgICAgICAgY2xlYW5fYXJncyA9IFtdCiAgICAgICAgaXNfcGFzc3dkID0gRmFsc2UKICAgICAgICBmb3IgYXJnIGluIHRvX2NsZWFuX2FyZ3M6CiAgICAgICAgICAgIGlmIGlzX3Bhc3N3ZDoKICAgICAgICAgICAgICAgIGlzX3Bhc3N3ZCA9IEZhbHNlCiAgICAgICAgICAgICAgICBjbGVhbl9hcmdzLmFwcGVuZCgnKioqKioqKionKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgUEFTU1dEX0FSR19SRS5tYXRjaChhcmcpOgogICAgICAgICAgICAgICAgc2VwX2lkeCA9IGFyZy5maW5kKCc9JykKICAgICAgICAgICAgICAgIGlmIHNlcF9pZHggPiAtMToKICAgICAgICAgICAgICAgICAgICBjbGVhbl9hcmdzLmFwcGVuZCgnJXM9KioqKioqKionICUgYXJnWzpzZXBfaWR4XSkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBpc19wYXNzd2QgPSBUcnVlCiAgICAgICAgICAgIGFyZyA9IGhldXJpc3RpY19sb2dfc2FuaXRpemUoYXJnLCBzZWxmLm5vX2xvZ192YWx1ZXMpCiAgICAgICAgICAgIGNsZWFuX2FyZ3MuYXBwZW5kKGFyZykKICAgICAgICBjbGVhbl9hcmdzID0gJyAnLmpvaW4oc2hsZXhfcXVvdGUoYXJnKSBmb3IgYXJnIGluIGNsZWFuX2FyZ3MpCgogICAgICAgIGlmIGRhdGE6CiAgICAgICAgICAgIHN0X2luID0gc3VicHJvY2Vzcy5QSVBFCgogICAgICAgIGt3YXJncyA9IGRpY3QoCiAgICAgICAgICAgIGV4ZWN1dGFibGU9ZXhlY3V0YWJsZSwKICAgICAgICAgICAgc2hlbGw9c2hlbGwsCiAgICAgICAgICAgIGNsb3NlX2Zkcz1jbG9zZV9mZHMsCiAgICAgICAgICAgIHN0ZGluPXN0X2luLAogICAgICAgICAgICBzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICkKCiAgICAgICAgIyBzdG9yZSB0aGUgcHdkCiAgICAgICAgcHJldl9kaXIgPSBvcy5nZXRjd2QoKQoKICAgICAgICAjIG1ha2Ugc3VyZSB3ZSdyZSBpbiB0aGUgcmlnaHQgd29ya2luZyBkaXJlY3RvcnkKICAgICAgICBpZiBjd2QgYW5kIG9zLnBhdGguaXNkaXIoY3dkKToKICAgICAgICAgICAgY3dkID0gb3MucGF0aC5hYnNwYXRoKG9zLnBhdGguZXhwYW5kdXNlcihjd2QpKQogICAgICAgICAgICBrd2FyZ3NbJ2N3ZCddID0gY3dkCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLmNoZGlyKGN3ZCkKICAgICAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPWUuZXJybm8sIG1zZz0iQ291bGQgbm90IG9wZW4gJXMsICVzIiAlIChjd2QsIHN0cihlKSkpCgogICAgICAgIG9sZF91bWFzayA9IE5vbmUKICAgICAgICBpZiB1bWFzazoKICAgICAgICAgICAgb2xkX3VtYXNrID0gb3MudW1hc2sodW1hc2spCgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5fZGVidWc6CiAgICAgICAgICAgICAgICBzZWxmLmxvZygnRXhlY3V0aW5nOiAnICsgY2xlYW5fYXJncykKICAgICAgICAgICAgY21kID0gc3VicHJvY2Vzcy5Qb3BlbihhcmdzLCAqKmt3YXJncykKCiAgICAgICAgICAgICMgdGhlIGNvbW11bmljYXRpb24gbG9naWMgaGVyZSBpcyBlc3NlbnRpYWxseSB0YWtlbiBmcm9tIHRoYXQKICAgICAgICAgICAgIyBvZiB0aGUgX2NvbW11bmljYXRlKCkgZnVuY3Rpb24gaW4gc3NoLnB5CgogICAgICAgICAgICBzdGRvdXQgPSBiKCcnKQogICAgICAgICAgICBzdGRlcnIgPSBiKCcnKQogICAgICAgICAgICBycGlwZXMgPSBbY21kLnN0ZG91dCwgY21kLnN0ZGVycl0KCiAgICAgICAgICAgIGlmIGRhdGE6CiAgICAgICAgICAgICAgICBpZiBub3QgYmluYXJ5X2RhdGE6CiAgICAgICAgICAgICAgICAgICAgZGF0YSArPSAnXG4nCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGRhdGEsIHRleHRfdHlwZSk6CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHRvX2J5dGVzKGRhdGEpCiAgICAgICAgICAgICAgICBjbWQuc3RkaW4ud3JpdGUoZGF0YSkKICAgICAgICAgICAgICAgIGNtZC5zdGRpbi5jbG9zZSgpCgogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgcmZkcywgd2ZkcywgZWZkcyA9IHNlbGVjdC5zZWxlY3QocnBpcGVzLCBbXSwgcnBpcGVzLCAxKQogICAgICAgICAgICAgICAgc3Rkb3V0ICs9IHNlbGYuX3JlYWRfZnJvbV9waXBlcyhycGlwZXMsIHJmZHMsIGNtZC5zdGRvdXQpCiAgICAgICAgICAgICAgICBzdGRlcnIgKz0gc2VsZi5fcmVhZF9mcm9tX3BpcGVzKHJwaXBlcywgcmZkcywgY21kLnN0ZGVycikKICAgICAgICAgICAgICAgICMgaWYgd2UncmUgY2hlY2tpbmcgZm9yIHByb21wdHMsIGRvIGl0IG5vdwogICAgICAgICAgICAgICAgaWYgcHJvbXB0X3JlOgogICAgICAgICAgICAgICAgICAgIGlmIHByb21wdF9yZS5zZWFyY2goc3Rkb3V0KSBhbmQgbm90IGRhdGE6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGVuY29kaW5nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Rkb3V0ID0gdG9fbmF0aXZlKHN0ZG91dCwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQgPSBzdGRvdXQKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgyNTcsIHN0ZG91dCwgIkEgcHJvbXB0IHdhcyBlbmNvdW50ZXJlZCB3aGlsZSBydW5uaW5nIGEgY29tbWFuZCwgYnV0IG5vIGlucHV0IGRhdGEgd2FzIHNwZWNpZmllZCIpCiAgICAgICAgICAgICAgICAjIG9ubHkgYnJlYWsgb3V0IGlmIG5vIHBpcGVzIGFyZSBsZWZ0IHRvIHJlYWQgb3IKICAgICAgICAgICAgICAgICMgdGhlIHBpcGVzIGFyZSBjb21wbGV0ZWx5IHJlYWQgYW5kCiAgICAgICAgICAgICAgICAjIHRoZSBwcm9jZXNzIGlzIHRlcm1pbmF0ZWQKICAgICAgICAgICAgICAgIGlmIChub3QgcnBpcGVzIG9yIG5vdCByZmRzKSBhbmQgY21kLnBvbGwoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgIyBObyBwaXBlcyBhcmUgbGVmdCB0byByZWFkIGJ1dCBwcm9jZXNzIGlzIG5vdCB5ZXQgdGVybWluYXRlZAogICAgICAgICAgICAgICAgIyBPbmx5IHRoZW4gaXQgaXMgc2FmZSB0byB3YWl0IGZvciB0aGUgcHJvY2VzcyB0byBiZSBmaW5pc2hlZAogICAgICAgICAgICAgICAgIyBOT1RFOiBBY3R1YWxseSBjbWQucG9sbCgpIGlzIGFsd2F5cyBOb25lIGhlcmUgaWYgcnBpcGVzIGlzIGVtcHR5CiAgICAgICAgICAgICAgICBlbGlmIG5vdCBycGlwZXMgYW5kIGNtZC5wb2xsKCkgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBjbWQud2FpdCgpCiAgICAgICAgICAgICAgICAgICAgIyBUaGUgcHJvY2VzcyBpcyB0ZXJtaW5hdGVkLiBTaW5jZSBubyBwaXBlcyB0byByZWFkIGZyb20gYXJlCiAgICAgICAgICAgICAgICAgICAgIyBsZWZ0LCB0aGVyZSBpcyBubyBuZWVkIHRvIGNhbGwgc2VsZWN0KCkgYWdhaW4uCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIGNtZC5zdGRvdXQuY2xvc2UoKQogICAgICAgICAgICBjbWQuc3RkZXJyLmNsb3NlKCkKCiAgICAgICAgICAgIHJjID0gY21kLnJldHVybmNvZGUKICAgICAgICBleGNlcHQgKE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYubG9nKCJFcnJvciBFeGVjdXRpbmcgQ01EOiVzIEV4Y2VwdGlvbjolcyIgJSAoY2xlYW5fYXJncywgdG9fbmF0aXZlKGUpKSkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocmM9ZS5lcnJubywgbXNnPXRvX25hdGl2ZShlKSwgY21kPWNsZWFuX2FyZ3MpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLmxvZygiRXJyb3IgRXhlY3V0aW5nIENNRDolcyBFeGNlcHRpb246JXMiICUgKGNsZWFuX2FyZ3MsdG9fbmF0aXZlKHRyYWNlYmFjay5mb3JtYXRfZXhjKCkpKSkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocmM9MjU3LCBtc2c9dG9fbmF0aXZlKGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSwgY21kPWNsZWFuX2FyZ3MpCgogICAgICAgICMgUmVzdG9yZSBlbnYgc2V0dGluZ3MKICAgICAgICBmb3Iga2V5LCB2YWwgaW4gb2xkX2Vudl92YWxzLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIHZhbCBpcyBOb25lOgogICAgICAgICAgICAgICAgZGVsIG9zLmVudmlyb25ba2V5XQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb3MuZW52aXJvbltrZXldID0gdmFsCgogICAgICAgIGlmIG9sZF91bWFzazoKICAgICAgICAgICAgb3MudW1hc2sob2xkX3VtYXNrKQoKICAgICAgICBpZiByYyAhPSAwIGFuZCBjaGVja19yYzoKICAgICAgICAgICAgbXNnID0gaGV1cmlzdGljX2xvZ19zYW5pdGl6ZShzdGRlcnIucnN0cmlwKCksIHNlbGYubm9fbG9nX3ZhbHVlcykKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24oY21kPWNsZWFuX2FyZ3MsIHJjPXJjLCBzdGRvdXQ9c3Rkb3V0LCBzdGRlcnI9c3RkZXJyLCBtc2c9bXNnKQoKICAgICAgICAjIHJlc2V0IHRoZSBwd2QKICAgICAgICBvcy5jaGRpcihwcmV2X2RpcikKCiAgICAgICAgaWYgZW5jb2RpbmcgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldHVybiAocmMsIHRvX25hdGl2ZShzdGRvdXQsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKSwKICAgICAgICAgICAgICAgICAgICB0b19uYXRpdmUoc3RkZXJyLCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycykpCiAgICAgICAgcmV0dXJuIChyYywgc3Rkb3V0LCBzdGRlcnIpCgogICAgZGVmIGFwcGVuZF90b19maWxlKHNlbGYsIGZpbGVuYW1lLCBzdHIpOgogICAgICAgIGZpbGVuYW1lID0gb3MucGF0aC5leHBhbmR2YXJzKG9zLnBhdGguZXhwYW5kdXNlcihmaWxlbmFtZSkpCiAgICAgICAgZmggPSBvcGVuKGZpbGVuYW1lLCAnYScpCiAgICAgICAgZmgud3JpdGUoc3RyKQogICAgICAgIGZoLmNsb3NlKCkKCiAgICBkZWYgYnl0ZXNfdG9faHVtYW4oc2VsZiwgc2l6ZSk6CiAgICAgICAgcmV0dXJuIGJ5dGVzX3RvX2h1bWFuKHNpemUpCgogICAgIyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkKICAgIHByZXR0eV9ieXRlcyA9IGJ5dGVzX3RvX2h1bWFuCgogICAgZGVmIGh1bWFuX3RvX2J5dGVzKHNlbGYsIG51bWJlciwgaXNiaXRzPUZhbHNlKToKICAgICAgICByZXR1cm4gaHVtYW5fdG9fYnl0ZXMobnVtYmVyLCBpc2JpdHMpCgogICAgIwogICAgIyBCYWNrd2FyZHMgY29tcGF0CiAgICAjCgogICAgIyBJbiAyLjAsIG1vdmVkIGZyb20gaW5zaWRlIHRoZSBtb2R1bGUgdG8gdGhlIHRvcGxldmVsCiAgICBpc19leGVjdXRhYmxlID0gaXNfZXhlY3V0YWJsZQoKCmRlZiBnZXRfbW9kdWxlX3BhdGgoKToKICAgIHJldHVybiBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5yZWFscGF0aChfX2ZpbGVfXykpClBLAwQUAAAAAADzuytLtdgEBiUwAAAlMAAAHQAAAGFuc2libGUvbW9kdWxlX3V0aWxzL190ZXh0LnB5IyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojIFRoaXMgcGFydGljdWxhciBmaWxlIHNuaXBwZXQsIGFuZCB0aGlzIGZpbGUgc25pcHBldCBvbmx5LCBpcyBCU0QgbGljZW5zZWQuCiMgTW9kdWxlcyB5b3Ugd3JpdGUgdXNpbmcgdGhpcyBzbmlwcGV0LCB3aGljaCBpcyBlbWJlZGRlZCBkeW5hbWljYWxseSBieSBBbnNpYmxlCiMgc3RpbGwgYmVsb25nIHRvIHRoZSBhdXRob3Igb2YgdGhlIG1vZHVsZSwgYW5kIG1heSBhc3NpZ24gdGhlaXIgb3duIGxpY2Vuc2UKIyB0byB0aGUgY29tcGxldGUgd29yay4KIwojIENvcHlyaWdodCAoYyksIFRvc2hpbyBLdXJhdG9taSA8YS5iYWRnZXJAZ21haWwuY29tPiwgMjAxNgojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwKIyBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiMgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICAgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICAgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKIyBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAojIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4KIyBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwKIyBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sCiMgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCiMgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVAojIExJQUJJTElUWSwgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRQojIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCgoiIiIKLi4gd2Fybjo6IFRoaXMgbW9kdWxlX3V0aWwgaXMgY3VycmVudGx5IGludGVybmFsIGltcGxlbWVudGF0aW9uLgogICAgV2Ugd2FudCB0byBldmFsdWF0ZSB0aGlzIGNvZGUgZm9yIHN0YWJpbGl0eSBhbmQgQVBJIHN1aXRhYmlsaXR5IGJlZm9yZQogICAgbWFraW5nIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGd1YXJhbnRlZXMuICBUaGUgQVBJIG1heSBjaGFuZ2UgYmV0d2VlbgogICAgcmVsZWFzZXMuICBEbyBub3QgdXNlIHRoaXMgdW5sZXNzIHlvdSBhcmUgd2lsbGluZyB0byBwb3J0IHlvdXIgbW9kdWxlIGNvZGUuCiIiIgppbXBvcnQgY29kZWNzCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpbXBvcnQgUFkzLCB0ZXh0X3R5cGUsIGJpbmFyeV90eXBlCgoKdHJ5OgogICAgY29kZWNzLmxvb2t1cF9lcnJvcignc3Vycm9nYXRlZXNjYXBlJykKICAgIEhBU19TVVJST0dBVEVFU0NBUEUgPSBUcnVlCmV4Y2VwdCBMb29rdXBFcnJvcjoKICAgIEhBU19TVVJST0dBVEVFU0NBUEUgPSBGYWxzZQoKCl9DT01QT1NFRF9FUlJPUl9IQU5ETEVSUyA9IGZyb3plbnNldCgoTm9uZSwgJ3N1cnJvZ2F0ZV9vcl9lc2NhcGUnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1cnJvZ2F0ZV9vcl9zdHJpY3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKSkKCgpkZWYgdG9fYnl0ZXMob2JqLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9Tm9uZSwgbm9uc3RyaW5nPSdzaW1wbGVyZXByJyk6CiAgICAiIiJNYWtlIHN1cmUgdGhhdCBhIHN0cmluZyBpcyBhIGJ5dGUgc3RyaW5nCgogICAgOmFyZyBvYmo6IEFuIG9iamVjdCB0byBtYWtlIHN1cmUgaXMgYSBieXRlIHN0cmluZy4gIEluIG1vc3QgY2FzZXMgdGhpcwogICAgICAgIHdpbGwgYmUgZWl0aGVyIGEgdGV4dCBzdHJpbmcgb3IgYSBieXRlIHN0cmluZy4gIEhvd2V2ZXIsIHdpdGgKICAgICAgICBgYG5vbnN0cmluZz0nc2ltcGxlcmVwcidgYCwgdGhpcyBjYW4gYmUgdXNlZCBhcyBhIHRyYWNlYmFjay1mcmVlCiAgICAgICAgdmVyc2lvbiBvZiBgYHN0cihvYmopYGAuCiAgICA6a3dhcmcgZW5jb2Rpbmc6IFRoZSBlbmNvZGluZyB0byB1c2UgdG8gdHJhbnNmb3JtIGZyb20gYSB0ZXh0IHN0cmluZyB0bwogICAgICAgIGEgYnl0ZSBzdHJpbmcuICBEZWZhdWx0cyB0byB1c2luZyAndXRmLTgnLgogICAgOmt3YXJnIGVycm9yczogVGhlIGVycm9yIGhhbmRsZXIgdG8gdXNlIGlmIHRoZSB0ZXh0IHN0cmluZyBpcyBub3QKICAgICAgICBlbmNvZGFibGUgdXNpbmcgdGhlIHNwZWNpZmllZCBlbmNvZGluZy4gIEFueSB2YWxpZCBgY29kZWNzIGVycm9yCiAgICAgICAgaGFuZGxlciA8aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMi9saWJyYXJ5L2NvZGVjcy5odG1sI2NvZGVjLWJhc2UtY2xhc3Nlcz5gXwogICAgICAgIG1heSBiZSBzcGVjaWZpZWQuIFRoZXJlIGFyZSB0aHJlZSBhZGRpdGlvbmFsIGVycm9yIHN0cmF0ZWdpZXMKICAgICAgICBzcGVjaWZpY2FsbHkgYWltZWQgYXQgaGVscGluZyBwZW9wbGUgdG8gcG9ydCBjb2RlLiAgVGhlIGZpcnN0IHR3byBhcmU6CgogICAgICAgICAgICA6c3Vycm9nYXRlX29yX3N0cmljdDogV2lsbCB1c2UgYGBzdXJyb2dhdGVlc2NhcGVgYCBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLCBvdGhlcndpc2UgaXQgd2lsbCB1c2UgYGBzdHJpY3RgYAogICAgICAgICAgICA6c3Vycm9nYXRlX29yX3JlcGxhY2U6IFdpbGwgdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlciwgb3RoZXJ3aXNlIGl0IHdpbGwgdXNlIGBgcmVwbGFjZWBgLgoKICAgICAgICBCZWNhdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgd2FzIGFkZGVkIGluIFB5dGhvbjMgdGhpcyB1c3VhbGx5IG1lYW5zIHRoYXQKICAgICAgICBQeXRob24zIHdpbGwgdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgYW5kIFB5dGhvbjIgd2lsbCB1c2UgdGhlIGZhbGxiYWNrCiAgICAgICAgZXJyb3IgaGFuZGxlci4gTm90ZSB0aGF0IHRoZSBjb2RlIGNoZWNrcyBmb3IgYGBzdXJyb2dhdGVlc2NhcGVgYCB3aGVuIHRoZQogICAgICAgIG1vZHVsZSBpcyBpbXBvcnRlZC4gIElmIHlvdSBoYXZlIGEgYmFja3BvcnQgb2YgYGBzdXJyb2dhdGVlc2NhcGVgYCBmb3IKICAgICAgICBQeXRob24yLCBiZSBzdXJlIHRvIHJlZ2lzdGVyIHRoZSBlcnJvciBoYW5kbGVyIHByaW9yIHRvIGltcG9ydGluZyB0aGlzCiAgICAgICAgbW9kdWxlLgoKICAgICAgICBUaGUgbGFzdCBlcnJvciBoYW5kbGVyIGlzOgoKICAgICAgICAgICAgOnN1cnJvZ2F0ZV90aGVuX3JlcGxhY2U6IFdpbGwgdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlci4gIElmIGVuY29kaW5nIHdpdGggYGBzdXJyb2dhdGVlc2NhcGVgYCB3b3VsZCB0cmFjZWJhY2ssCiAgICAgICAgICAgICAgICBzdXJyb2dhdGVzIGFyZSBmaXJzdCByZXBsYWNlZCB3aXRoIGEgcmVwbGFjZW1lbnQgY2hhcmFjdGVycwogICAgICAgICAgICAgICAgYW5kIHRoZW4gdGhlIHN0cmluZyBpcyBlbmNvZGVkIHVzaW5nIGBgcmVwbGFjZWBgICh3aGljaCByZXBsYWNlcwogICAgICAgICAgICAgICAgdGhlIHJlc3Qgb2YgdGhlIG5vbmVuY29kYWJsZSBieXRlcykuICBJZiBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlzCiAgICAgICAgICAgICAgICBub3QgcHJlc2VudCBpdCB3aWxsIHNpbXBseSB1c2UgYGByZXBsYWNlYGAuICAoQWRkZWQgaW4gQW5zaWJsZSAyLjMpCiAgICAgICAgICAgICAgICBUaGlzIHN0cmF0ZWd5IGlzIGRlc2lnbmVkIHRvIG5ldmVyIHRyYWNlYmFjayB3aGVuIGl0IGF0dGVtcHRzCiAgICAgICAgICAgICAgICB0byBlbmNvZGUgYSBzdHJpbmcuCgogICAgICAgIFRoZSBkZWZhdWx0IHVudGlsIEFuc2libGUtMi4yIHdhcyBgYHN1cnJvZ2F0ZV9vcl9yZXBsYWNlYGAKICAgICAgICBGcm9tIEFuc2libGUtMi4zIG9ud2FyZHMsIHRoZSBkZWZhdWx0IGlzIGBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWBgLgoKICAgIDprd2FyZyBub25zdHJpbmc6IFRoZSBzdHJhdGVneSB0byB1c2UgaWYgYSBub25zdHJpbmcgaXMgc3BlY2lmaWVkIGluCiAgICAgICAgYGBvYmpgYC4gIERlZmF1bHQgaXMgJ3NpbXBsZXJlcHInLiAgVmFsaWQgdmFsdWVzIGFyZToKCiAgICAgICAgOnNpbXBsZXJlcHI6IFRoZSBkZWZhdWx0LiAgVGhpcyB0YWtlcyB0aGUgYGBzdHJgYCBvZiB0aGUgb2JqZWN0IGFuZAogICAgICAgICAgICB0aGVuIHJldHVybnMgdGhlIGJ5dGVzIHZlcnNpb24gb2YgdGhhdCBzdHJpbmcuCiAgICAgICAgOmVtcHR5OiBSZXR1cm4gYW4gZW1wdHkgYnl0ZSBzdHJpbmcKICAgICAgICA6cGFzc3RocnU6IFJldHVybiB0aGUgb2JqZWN0IHBhc3NlZCBpbgogICAgICAgIDpzdHJpY3Q6IFJhaXNlIGEgOmV4YzpgVHlwZUVycm9yYAoKICAgIDpyZXR1cm5zOiBUeXBpY2FsbHkgdGhpcyByZXR1cm5zIGEgYnl0ZSBzdHJpbmcuICBJZiBhIG5vbnN0cmluZyBvYmplY3QgaXMKICAgICAgICBwYXNzZWQgaW4gdGhpcyBtYXkgYmUgYSBkaWZmZXJlbnQgdHlwZSBkZXBlbmRpbmcgb24gdGhlIHN0cmF0ZWd5CiAgICAgICAgc3BlY2lmaWVkIGJ5IG5vbnN0cmluZy4gIFRoaXMgd2lsbCBuZXZlciByZXR1cm4gYSB0ZXh0IHN0cmluZy4KCiAgICAuLiBub3RlOjogSWYgcGFzc2VkIGEgYnl0ZSBzdHJpbmcsIHRoaXMgZnVuY3Rpb24gZG9lcyBub3QgY2hlY2sgdGhhdCB0aGUKICAgICAgICBzdHJpbmcgaXMgdmFsaWQgaW4gdGhlIHNwZWNpZmllZCBlbmNvZGluZy4gIElmIGl0J3MgaW1wb3J0YW50IHRoYXQgdGhlCiAgICAgICAgYnl0ZSBzdHJpbmcgaXMgaW4gdGhlIHNwZWNpZmllZCBlbmNvZGluZyBkbzo6CgogICAgICAgICAgICBlbmNvZGVkX3N0cmluZyA9IHRvX2J5dGVzKHRvX3RleHQoaW5wdXRfc3RyaW5nLCAnbGF0aW4tMScpLCAndXRmLTgnKQoKICAgIC4uIHZlcnNpb25fY2hhbmdlZDo6IDIuMwoKICAgICAgICBBZGRlZCB0aGUgYGBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlYGAgZXJyb3IgaGFuZGxlciBhbmQgbWFkZSBpdCB0aGUgZGVmYXVsdCBlcnJvciBoYW5kbGVyLgogICAgIiIiCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgYmluYXJ5X3R5cGUpOgogICAgICAgIHJldHVybiBvYmoKCiAgICAjIFdlJ3JlIGdpdmVuIGEgdGV4dCBzdHJpbmcKICAgICMgSWYgaXQgaGFzIHN1cnJvZ2F0ZXMsIHdlIGtub3cgYmVjYXVzZSBpdCB3aWxsIGRlY29kZQogICAgb3JpZ2luYWxfZXJyb3JzID0gZXJyb3JzCiAgICBpZiBlcnJvcnMgaW4gX0NPTVBPU0VEX0VSUk9SX0hBTkRMRVJTOgogICAgICAgIGlmIEhBU19TVVJST0dBVEVFU0NBUEU6CiAgICAgICAgICAgIGVycm9ycyA9ICdzdXJyb2dhdGVlc2NhcGUnCiAgICAgICAgZWxpZiBlcnJvcnMgPT0gJ3N1cnJvZ2F0ZV9vcl9zdHJpY3QnOgogICAgICAgICAgICBlcnJvcnMgPSAnc3RyaWN0JwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVycm9ycyA9ICdyZXBsYWNlJwoKICAgIGlmIGlzaW5zdGFuY2Uob2JqLCB0ZXh0X3R5cGUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBUcnkgdGhpcyBmaXJzdCBhcyBpdCdzIHRoZSBmYXN0ZXN0CiAgICAgICAgICAgIHJldHVybiBvYmouZW5jb2RlKGVuY29kaW5nLCBlcnJvcnMpCiAgICAgICAgZXhjZXB0IFVuaWNvZGVFbmNvZGVFcnJvcjoKICAgICAgICAgICAgaWYgb3JpZ2luYWxfZXJyb3JzIGluIChOb25lLCAnc3Vycm9nYXRlX3RoZW5fcmVwbGFjZScpOgogICAgICAgICAgICAgICAgIyBTbG93IGJ1dCB3b3JrcwogICAgICAgICAgICAgICAgcmV0dXJuX3N0cmluZyA9IG9iai5lbmNvZGUoJ3V0Zi04JywgJ3N1cnJvZ2F0ZWVzY2FwZScpCiAgICAgICAgICAgICAgICByZXR1cm5fc3RyaW5nID0gcmV0dXJuX3N0cmluZy5kZWNvZGUoJ3V0Zi04JywgJ3JlcGxhY2UnKQogICAgICAgICAgICAgICAgcmV0dXJuIHJldHVybl9zdHJpbmcuZW5jb2RlKGVuY29kaW5nLCAncmVwbGFjZScpCiAgICAgICAgICAgIHJhaXNlCgogICAgIyBOb3RlOiBXZSBkbyB0aGVzZSBsYXN0IGV2ZW4gdGhvdWdoIHdlIGhhdmUgdG8gY2FsbCB0b19ieXRlcyBhZ2FpbiBvbiB0aGUKICAgICMgdmFsdWUgYmVjYXVzZSB3ZSdyZSBvcHRpbWl6aW5nIHRoZSBjb21tb24gY2FzZQogICAgaWYgbm9uc3RyaW5nID09ICdzaW1wbGVyZXByJzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHZhbHVlID0gc3RyKG9iaikKICAgICAgICBleGNlcHQgVW5pY29kZUVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlcHIob2JqKQogICAgICAgICAgICBleGNlcHQgVW5pY29kZUVycm9yOgogICAgICAgICAgICAgICAgIyBHaXZpbmcgdXAKICAgICAgICAgICAgICAgIHJldHVybiB0b19ieXRlcygnJykKICAgIGVsaWYgbm9uc3RyaW5nID09ICdwYXNzdGhydSc6CiAgICAgICAgcmV0dXJuIG9iagogICAgZWxpZiBub25zdHJpbmcgPT0gJ2VtcHR5JzoKICAgICAgICAjIHB5dGhvbjIuNCBkb2Vzbid0IGhhdmUgYicnCiAgICAgICAgcmV0dXJuIHRvX2J5dGVzKCcnKQogICAgZWxpZiBub25zdHJpbmcgPT0gJ3N0cmljdCc6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdvYmogbXVzdCBiZSBhIHN0cmluZyB0eXBlJykKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdJbnZhbGlkIHZhbHVlICVzIGZvciB0b19ieXRlc1wnIG5vbnN0cmluZyBwYXJhbWV0ZXInICUgbm9uc3RyaW5nKQoKICAgIHJldHVybiB0b19ieXRlcyh2YWx1ZSwgZW5jb2RpbmcsIGVycm9ycykKCgpkZWYgdG9fdGV4dChvYmosIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz1Ob25lLCBub25zdHJpbmc9J3NpbXBsZXJlcHInKToKICAgICIiIk1ha2Ugc3VyZSB0aGF0IGEgc3RyaW5nIGlzIGEgdGV4dCBzdHJpbmcKCiAgICA6YXJnIG9iajogQW4gb2JqZWN0IHRvIG1ha2Ugc3VyZSBpcyBhIHRleHQgc3RyaW5nLiAgSW4gbW9zdCBjYXNlcyB0aGlzCiAgICAgICAgd2lsbCBiZSBlaXRoZXIgYSB0ZXh0IHN0cmluZyBvciBhIGJ5dGUgc3RyaW5nLiAgSG93ZXZlciwgd2l0aAogICAgICAgIGBgbm9uc3RyaW5nPSdzaW1wbGVyZXByJ2BgLCB0aGlzIGNhbiBiZSB1c2VkIGFzIGEgdHJhY2ViYWNrLWZyZWUKICAgICAgICB2ZXJzaW9uIG9mIGBgc3RyKG9iailgYC4KICAgIDprd2FyZyBlbmNvZGluZzogVGhlIGVuY29kaW5nIHRvIHVzZSB0byB0cmFuc2Zvcm0gZnJvbSBhIGJ5dGUgc3RyaW5nIHRvCiAgICAgICAgYSB0ZXh0IHN0cmluZy4gIERlZmF1bHRzIHRvIHVzaW5nICd1dGYtOCcuCiAgICA6a3dhcmcgZXJyb3JzOiBUaGUgZXJyb3IgaGFuZGxlciB0byB1c2UgaWYgdGhlIGJ5dGUgc3RyaW5nIGlzIG5vdAogICAgICAgIGRlY29kYWJsZSB1c2luZyB0aGUgc3BlY2lmaWVkIGVuY29kaW5nLiAgQW55IHZhbGlkIGBjb2RlY3MgZXJyb3IKICAgICAgICBoYW5kbGVyIDxodHRwczovL2RvY3MucHl0aG9uLm9yZy8yL2xpYnJhcnkvY29kZWNzLmh0bWwjY29kZWMtYmFzZS1jbGFzc2VzPmBfCiAgICAgICAgbWF5IGJlIHNwZWNpZmllZC4gICBXZSBzdXBwb3J0IHRocmVlIGFkZGl0aW9uYWwgZXJyb3Igc3RyYXRlZ2llcwogICAgICAgIHNwZWNpZmljYWxseSBhaW1lZCBhdCBoZWxwaW5nIHBlb3BsZSB0byBwb3J0IGNvZGU6CgogICAgICAgICAgICA6c3Vycm9nYXRlX29yX3N0cmljdDogV2lsbCB1c2Ugc3Vycm9nYXRlZXNjYXBlIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSBzdHJpY3QKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9yZXBsYWNlOiBXaWxsIHVzZSBzdXJyb2dhdGVlc2NhcGUgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlciwgb3RoZXJ3aXNlIGl0IHdpbGwgdXNlIHJlcGxhY2UuCiAgICAgICAgICAgIDpzdXJyb2dhdGVfdGhlbl9yZXBsYWNlOiBEb2VzIHRoZSBzYW1lIGFzIHN1cnJvZ2F0ZV9vcl9yZXBsYWNlIGJ1dAogICAgICAgICAgICAgICAgYHdhcyBhZGRlZCBmb3Igc3ltbWV0cnkgd2l0aCB0aGUgZXJyb3IgaGFuZGxlcnMgaW4KICAgICAgICAgICAgICAgIDpmdW5jOmBhbnNpYmxlLm1vZHVsZV91dGlscy5fdGV4dC50b19ieXRlc2AgKEFkZGVkIGluIEFuc2libGUgMi4zKQoKICAgICAgICBCZWNhdXNlIHN1cnJvZ2F0ZWVzY2FwZSB3YXMgYWRkZWQgaW4gUHl0aG9uMyB0aGlzIHVzdWFsbHkgbWVhbnMgdGhhdAogICAgICAgIFB5dGhvbjMgd2lsbCB1c2UgYHN1cnJvZ2F0ZWVzY2FwZWAgYW5kIFB5dGhvbjIgd2lsbCB1c2UgdGhlIGZhbGxiYWNrCiAgICAgICAgZXJyb3IgaGFuZGxlci4gTm90ZSB0aGF0IHRoZSBjb2RlIGNoZWNrcyBmb3Igc3Vycm9nYXRlZXNjYXBlIHdoZW4gdGhlCiAgICAgICAgbW9kdWxlIGlzIGltcG9ydGVkLiAgSWYgeW91IGhhdmUgYSBiYWNrcG9ydCBvZiBgc3Vycm9nYXRlZXNjYXBlYCBmb3IKICAgICAgICBweXRob24yLCBiZSBzdXJlIHRvIHJlZ2lzdGVyIHRoZSBlcnJvciBoYW5kbGVyIHByaW9yIHRvIGltcG9ydGluZyB0aGlzCiAgICAgICAgbW9kdWxlLgoKICAgICAgICBUaGUgZGVmYXVsdCB1bnRpbCBBbnNpYmxlLTIuMiB3YXMgYHN1cnJvZ2F0ZV9vcl9yZXBsYWNlYAogICAgICAgIEluIEFuc2libGUtMi4zIHRoaXMgZGVmYXVsdHMgdG8gYHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2VgIGZvciBzeW1tZXRyeQogICAgICAgIHdpdGggOmZ1bmM6YGFuc2libGUubW9kdWxlX3V0aWxzLl90ZXh0LnRvX2J5dGVzYCAuCiAgICA6a3dhcmcgbm9uc3RyaW5nOiBUaGUgc3RyYXRlZ3kgdG8gdXNlIGlmIGEgbm9uc3RyaW5nIGlzIHNwZWNpZmllZCBpbgogICAgICAgIGBgb2JqYGAuICBEZWZhdWx0IGlzICdzaW1wbGVyZXByJy4gIFZhbGlkIHZhbHVlcyBhcmU6CgogICAgICAgIDpzaW1wbGVyZXByOiBUaGUgZGVmYXVsdC4gIFRoaXMgdGFrZXMgdGhlIGBgc3RyYGAgb2YgdGhlIG9iamVjdCBhbmQKICAgICAgICAgICAgdGhlbiByZXR1cm5zIHRoZSB0ZXh0IHZlcnNpb24gb2YgdGhhdCBzdHJpbmcuCiAgICAgICAgOmVtcHR5OiBSZXR1cm4gYW4gZW1wdHkgdGV4dCBzdHJpbmcKICAgICAgICA6cGFzc3RocnU6IFJldHVybiB0aGUgb2JqZWN0IHBhc3NlZCBpbgogICAgICAgIDpzdHJpY3Q6IFJhaXNlIGEgOmV4YzpgVHlwZUVycm9yYAoKICAgIDpyZXR1cm5zOiBUeXBpY2FsbHkgdGhpcyByZXR1cm5zIGEgdGV4dCBzdHJpbmcuICBJZiBhIG5vbnN0cmluZyBvYmplY3QgaXMKICAgICAgICBwYXNzZWQgaW4gdGhpcyBtYXkgYmUgYSBkaWZmZXJlbnQgdHlwZSBkZXBlbmRpbmcgb24gdGhlIHN0cmF0ZWd5CiAgICAgICAgc3BlY2lmaWVkIGJ5IG5vbnN0cmluZy4gIFRoaXMgd2lsbCBuZXZlciByZXR1cm4gYSBieXRlIHN0cmluZy4KICAgICAgICBGcm9tIEFuc2libGUtMi4zIG9ud2FyZHMsIHRoZSBkZWZhdWx0IGlzIGBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlYC4KCiAgICAuLiB2ZXJzaW9uX2NoYW5nZWQ6OiAyLjMKCiAgICAgICAgQWRkZWQgdGhlIHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2UgZXJyb3IgaGFuZGxlciBhbmQgbWFkZSBpdCB0aGUgZGVmYXVsdCBlcnJvciBoYW5kbGVyLgogICAgIiIiCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgdGV4dF90eXBlKToKICAgICAgICByZXR1cm4gb2JqCgogICAgaWYgZXJyb3JzIGluIF9DT01QT1NFRF9FUlJPUl9IQU5ETEVSUzoKICAgICAgICBpZiBIQVNfU1VSUk9HQVRFRVNDQVBFOgogICAgICAgICAgICBlcnJvcnMgPSAnc3Vycm9nYXRlZXNjYXBlJwogICAgICAgIGVsaWYgZXJyb3JzID09ICdzdXJyb2dhdGVfb3Jfc3RyaWN0JzoKICAgICAgICAgICAgZXJyb3JzID0gJ3N0cmljdCcKICAgICAgICBlbHNlOgogICAgICAgICAgICBlcnJvcnMgPSAncmVwbGFjZScKCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgYmluYXJ5X3R5cGUpOgogICAgICAgICMgTm90ZTogV2UgZG9uJ3QgbmVlZCBzcGVjaWFsIGhhbmRsaW5nIGZvciBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlCiAgICAgICAgIyBiZWNhdXNlIGFsbCBieXRlcyB3aWxsIGVpdGhlciBiZSBtYWRlIGludG8gc3Vycm9nYXRlcyBvciBhcmUgdmFsaWQKICAgICAgICAjIHRvIGRlY29kZS4KICAgICAgICByZXR1cm4gb2JqLmRlY29kZShlbmNvZGluZywgZXJyb3JzKQoKICAgICMgTm90ZTogV2UgZG8gdGhlc2UgbGFzdCBldmVuIHRob3VnaCB3ZSBoYXZlIHRvIGNhbGwgdG9fdGV4dCBhZ2FpbiBvbiB0aGUKICAgICMgdmFsdWUgYmVjYXVzZSB3ZSdyZSBvcHRpbWl6aW5nIHRoZSBjb21tb24gY2FzZQogICAgaWYgbm9uc3RyaW5nID09ICdzaW1wbGVyZXByJzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHZhbHVlID0gc3RyKG9iaikKICAgICAgICBleGNlcHQgVW5pY29kZUVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlcHIob2JqKQogICAgICAgICAgICBleGNlcHQgVW5pY29kZUVycm9yOgogICAgICAgICAgICAgICAgIyBHaXZpbmcgdXAKICAgICAgICAgICAgICAgIHJldHVybiB1JycKICAgIGVsaWYgbm9uc3RyaW5nID09ICdwYXNzdGhydSc6CiAgICAgICAgcmV0dXJuIG9iagogICAgZWxpZiBub25zdHJpbmcgPT0gJ2VtcHR5JzoKICAgICAgICByZXR1cm4gdScnCiAgICBlbGlmIG5vbnN0cmluZyA9PSAnc3RyaWN0JzoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ29iaiBtdXN0IGJlIGEgc3RyaW5nIHR5cGUnKQogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ0ludmFsaWQgdmFsdWUgJXMgZm9yIHRvX3RleHRcJ3Mgbm9uc3RyaW5nIHBhcmFtZXRlcicgJSBub25zdHJpbmcpCgogICAgcmV0dXJuIHRvX3RleHQodmFsdWUsIGVuY29kaW5nLCBlcnJvcnMpCgoKIzogOnB5OmZ1bmM6YHRvX25hdGl2ZWAKIzogICAgICBUcmFuc2Zvcm0gYSB2YXJpYWJsZSBpbnRvIHRoZSBuYXRpdmUgc3RyIHR5cGUgZm9yIHRoZSBweXRob24gdmVyc2lvbgojOgojOiAgICAgIE9uIFB5dGhvbjIsIHRoaXMgaXMgYW4gYWxpYXMgZm9yCiM6ICAgICAgOmZ1bmM6YH5hbnNpYmxlLm1vZHVsZV91dGlscy50b19ieXRlc2AuICBPbiBQeXRob24zIGl0IGlzIGFuIGFsaWFzIGZvcgojOiAgICAgIDpmdW5jOmB+YW5zaWJsZS5tb2R1bGVfdXRpbHMudG9fdGV4dGAuICBJdCBtYWtlcyBpdCBlYXNpZXIgdG8KIzogICAgICB0cmFuc2Zvcm0gYSB2YXJpYWJsZSBpbnRvIHRoZSBuYXRpdmUgc3RyIHR5cGUgZm9yIHRoZSBweXRob24gdmVyc2lvbgojOiAgICAgIHRoZSBjb2RlIGlzIHJ1bm5pbmcgb24uICBVc2UgdGhpcyB3aGVuIGNvbnN0cnVjdGluZyB0aGUgbWVzc2FnZSB0bwojOiAgICAgIHNlbmQgdG8gZXhjZXB0aW9ucyBvciB3aGVuIGRlYWxpbmcgd2l0aCBhbiBBUEkgdGhhdCBuZWVkcyB0byB0YWtlCiM6ICAgICAgYSBuYXRpdmUgc3RyaW5nLiAgRXhhbXBsZTo6CiM6CiM6ICAgICAgICAgIHRyeToKIzogICAgICAgICAgICAgIDEvLzAKIzogICAgICAgICAgZXhjZXB0IFplcm9EaXZpc2lvbkVycm9yIGFzIGU6CiM6ICAgICAgICAgICAgICByYWlzZSBNeUV4Y2VwdGlvbignRW5jb3VudGVyZWQgYW5kIGVycm9yOiAlcycgJSB0b19uYXRpdmUoZSkpCmlmIFBZMzoKICAgIHRvX25hdGl2ZSA9IHRvX3RleHQKZWxzZToKICAgIHRvX25hdGl2ZSA9IHRvX2J5dGVzClBLAwQUAAAAAADzuytLJdy0fhMQAAATEAAAIgAAAGFuc2libGUvbW9kdWxlX3V0aWxzL3B5Y29tcGF0MjQucHkjIFRoaXMgY29kZSBpcyBwYXJ0IG9mIEFuc2libGUsIGJ1dCBpcyBhbiBpbmRlcGVuZGVudCBjb21wb25lbnQuCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBUb3NoaW8gS3VyYXRvbWkgPHRrdXJhdG9taUBhbnNpYmxlLmNvbT4KIyBDb3B5cmlnaHQgKGMpIDIwMTUsIE1hcml1cyBHZWRtaW5hcwojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwKIyBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiMgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICAgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICAgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKIyBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAojIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4KIyBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwKIyBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sCiMgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCiMgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVAojIExJQUJJTElUWSwgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRQojIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCgppbXBvcnQgc3lzCgpkZWYgZ2V0X2V4Y2VwdGlvbigpOgogICAgIiIiR2V0IHRoZSBjdXJyZW50IGV4Y2VwdGlvbi4KCiAgICBUaGlzIGNvZGUgbmVlZHMgdG8gd29yayBvbiBQeXRob24gMi40IHRocm91Z2ggMy54LCBzbyB3ZSBjYW5ub3QgdXNlCiAgICAiZXhjZXB0IEV4Y2VwdGlvbiwgZToiIChTeW50YXhFcnJvciBvbiBQeXRob24gMy54KSBub3IKICAgICJleGNlcHQgRXhjZXB0aW9uIGFzIGU6IiAoU3ludGF4RXJyb3Igb24gUHl0aG9uIDIuNC0yLjUpLgogICAgSW5zdGVhZCB3ZSBtdXN0IHVzZSA6OgoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCgogICAgIiIiCiAgICByZXR1cm4gc3lzLmV4Y19pbmZvKClbMV0KCnRyeToKICAgICMgUHl0aG9uIDIuNisKICAgIGZyb20gYXN0IGltcG9ydCBsaXRlcmFsX2V2YWwKZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyBhIHJlcGxhY2VtZW50IGZvciBsaXRlcmFsX2V2YWwgdGhhdCB3b3JrcyB3aXRoIHB5dGhvbiAyLjQuIGZyb206CiAgICAjIGh0dHBzOi8vbWFpbC5weXRob24ub3JnL3BpcGVybWFpbC9weXRob24tbGlzdC8yMDA5LVNlcHRlbWJlci81NTE4ODAuaHRtbAogICAgIyB3aGljaCBpcyBlc3NlbnRpYWxseSBhIGN1dC9wYXN0ZSBmcm9tIGFuIGVhcmxpZXIgKDIuNikgdmVyc2lvbiBvZiBweXRob24ncwogICAgIyBhc3QucHkKICAgIGZyb20gY29tcGlsZXIgaW1wb3J0IGFzdCwgcGFyc2UKICAgIGZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGltcG9ydCBiaW5hcnlfdHlwZSwgc3RyaW5nX3R5cGVzLCB0ZXh0X3R5cGUKCiAgICBkZWYgbGl0ZXJhbF9ldmFsKG5vZGVfb3Jfc3RyaW5nKToKICAgICAgICAiIiIKICAgICAgICBTYWZlbHkgZXZhbHVhdGUgYW4gZXhwcmVzc2lvbiBub2RlIG9yIGEgc3RyaW5nIGNvbnRhaW5pbmcgYSBQeXRob24KICAgICAgICBleHByZXNzaW9uLiAgVGhlIHN0cmluZyBvciBub2RlIHByb3ZpZGVkIG1heSBvbmx5IGNvbnNpc3Qgb2YgdGhlICBmb2xsb3dpbmcKICAgICAgICBQeXRob24gbGl0ZXJhbCBzdHJ1Y3R1cmVzOiBzdHJpbmdzLCBudW1iZXJzLCB0dXBsZXMsIGxpc3RzLCBkaWN0cywgIGJvb2xlYW5zLAogICAgICAgIGFuZCBOb25lLgogICAgICAgICIiIgogICAgICAgIF9zYWZlX25hbWVzID0geydOb25lJzogTm9uZSwgJ1RydWUnOiBUcnVlLCAnRmFsc2UnOiBGYWxzZX0KICAgICAgICBpZiBpc2luc3RhbmNlKG5vZGVfb3Jfc3RyaW5nLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBub2RlX29yX3N0cmluZyA9IHBhcnNlKG5vZGVfb3Jfc3RyaW5nLCBtb2RlPSdldmFsJykKICAgICAgICBpZiBpc2luc3RhbmNlKG5vZGVfb3Jfc3RyaW5nLCBhc3QuRXhwcmVzc2lvbik6CiAgICAgICAgICAgIG5vZGVfb3Jfc3RyaW5nID0gbm9kZV9vcl9zdHJpbmcubm9kZQoKICAgICAgICBkZWYgX2NvbnZlcnQobm9kZSk6CiAgICAgICAgICAgICMgT2theSB0byB1c2UgbG9uZyBoZXJlIGJlY2F1c2UgdGhpcyBpcyBvbmx5IGZvciBweXRob24gMi40IGFuZCAyLjUKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuQ29uc3QpIGFuZCBpc2luc3RhbmNlKG5vZGUudmFsdWUsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlLCBpbnQsIGZsb2F0LCBsb25nLCBjb21wbGV4KSk6CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0LlR1cGxlKToKICAgICAgICAgICAgICAgIHJldHVybiB0dXBsZShtYXAoX2NvbnZlcnQsIG5vZGUubm9kZXMpKQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0Lkxpc3QpOgogICAgICAgICAgICAgICAgcmV0dXJuIGxpc3QobWFwKF9jb252ZXJ0LCBub2RlLm5vZGVzKSkKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5EaWN0KToKICAgICAgICAgICAgICAgIHJldHVybiBkaWN0KChfY29udmVydChrKSwgX2NvbnZlcnQodikpIGZvciBrLCB2IGluIG5vZGUuaXRlbXMoKSkKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5OYW1lKToKICAgICAgICAgICAgICAgIGlmIG5vZGUubmFtZSBpbiBfc2FmZV9uYW1lczoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3NhZmVfbmFtZXNbbm9kZS5uYW1lXQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0LlVuYXJ5U3ViKToKICAgICAgICAgICAgICAgIHJldHVybiAtX2NvbnZlcnQobm9kZS5leHByKQogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdtYWxmb3JtZWQgc3RyaW5nJykKICAgICAgICByZXR1cm4gX2NvbnZlcnQobm9kZV9vcl9zdHJpbmcpCgpfX2FsbF9fID0gKCdnZXRfZXhjZXB0aW9uJywgJ2xpdGVyYWxfZXZhbCcpClBLAwQUAAAAAADzuytLGBdy9QERAAABEQAAJAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fX2luaXRfXy5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpIDIwMTcsIFRvc2hpbyBLdXJhdG9taSA8dGt1cmF0b21pQGFuc2libGUuY29tPgojCiMgVGhpcyBjb2RlIGlzIGJhc2VkIG9uIGNvZGUgZnJvbSBBc3Ryb3B5IGFuZCByZXRhaW5zIHRoZWlyIDMtY2xhdXNlIEJTRCBsaWNlbnNlCiMgcmVwcm9kdWNlZCBiZWxvdzoKIwojIENvcHlyaWdodCAoYykgMjAxMS0yMDE2LCBBc3Ryb3B5IERldmVsb3BlcnMKIwojIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiMKIyBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQKIyBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKIwojICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLCB0aGlzCiMgICBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KIyAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwKIyAgIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24KIyAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgojICogTmVpdGhlciB0aGUgbmFtZSBvZiB0aGUgQXN0cm9weSBUZWFtIG5vciB0aGUgbmFtZXMgb2YgaXRzIGNvbnRyaWJ1dG9ycyBtYXkKIyAgIGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzIGRlcml2ZWQgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQKIyAgIHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIgojIEFORCBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUKIyBJTVBMSUVEIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUKIyBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFCiMgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwKIyBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUgojIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSCiMgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwKIyBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRQojIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiMKIyBBc3Ryb3B5IExpY2Vuc2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9hc3Ryb3B5L2FzdHJvcHkvYmxvYi9jZjMyNjVlNDJhMGRiOGUwMGJiOTA2NDRkYjM3YzgxNTBmNWFjMDBjL2xpY2Vuc2VzL0xJQ0VOU0UucnN0CiMgQXN0cm9weSBDb2RlOiBodHRwczovL2dpdGh1Yi5jb20vYXN0cm9weS9hc3Ryb3B5L2Jsb2IvY2YzMjY1ZTQyYTBkYjhlMDBiYjkwNjQ0ZGIzN2M4MTUwZjVhYzAwYy9hc3Ryb3B5L2V4dGVybi9zaXgucHkKCiIiIgpIYW5kbGUgbG9hZGluZyBzaXggcGFja2FnZSBmcm9tIHN5c3RlbSBvciBmcm9tIHRoZSBidW5kbGVkIGNvcHkKIiIiCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgYWJzb2x1dGVfaW1wb3J0CgppbXBvcnQgaW1wIGFzIF9pbXAKaW1wb3J0IHN5cyBhcyBfc3lzCgp0cnk6CiAgICBmcm9tIGRpc3R1dGlscy52ZXJzaW9uIGltcG9ydCBMb29zZVZlcnNpb24gYXMgX0xvb3NlVmVyc2lvbgpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAjIFNvbWUgcGxhdGZvcm1zICpjb3VnaCpTb2xhcmlzKmNvdWdoKiBkb24ndCBzaGlwIHRoZSB3aG9sZSBzdGRsaWIKICAgIF9Mb29zZVZlcnNpb24gPSBOb25lCgp0cnk6CiAgICBpbXBvcnQgc2l4IGFzIF9zeXN0ZW1fc2l4CmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIF9zeXN0ZW1fc2l4ID0gTm9uZQoKZnJvbSAuIGltcG9ydCBfc2l4IGFzIF9idW5kbGVkX3NpeAoKCmRlZiBfZmluZF9tb2R1bGUobmFtZSwgcGF0aD1Ob25lKToKICAgICIiIkFsdGVybmF0aXZlIHRvIGBpbXAuZmluZF9tb2R1bGVgIHRoYXQgY2FuIGFsc28gc2VhcmNoIGluIHN1YnBhY2thZ2VzIiIiCiAgICBwYXJ0cyA9IG5hbWUuc3BsaXQoJy4nKQoKICAgIGZvciBwYXJ0IGluIHBhcnRzOgogICAgICAgIGlmIHBhdGggaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHBhdGggPSBbcGF0aF0KICAgICAgICBmaCwgcGF0aCwgZGVzY3IgPSBfaW1wLmZpbmRfbW9kdWxlKHBhcnQsIHBhdGgpCiAgICByZXR1cm4gZmgsIHBhdGgsIGRlc2NyCgoKZGVmIF9nZXRfYnVuZGxlZF9zaXhfc291cmNlKCk6CiAgICAjIFNwZWNpYWwgaW1wb3J0IGxvYWRlciAoemlwaW1wb3J0IGZvciBpbnN0YW5jZSkKICAgIGZvdW5kID0gRmFsc2UKICAgIGZvciBwYXRoIGluIF9zeXMucGF0aDoKICAgICAgICBpbXBvcnRlciA9IF9zeXMucGF0aF9pbXBvcnRlcl9jYWNoZS5nZXQocGF0aCkKICAgICAgICBpZiBpbXBvcnRlcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZm91bmQgPSBpbXBvcnRlci5maW5kX21vZHVsZSgnYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19zaXgnKQogICAgICAgICAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBmb3VuZDoKICAgICAgICAgICAgICAgIGJyZWFrCiAgICBlbHNlOgogICAgICAgIHJhaXNlIEltcG9ydEVycm9yKCJDb3VsZCBub3QgZmluZCBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXguX3NpeCIpCgogICAgbW9kdWxlX3NvdXJjZSA9IGltcG9ydGVyLmdldF9zb3VyY2UoJ2Fuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fc2l4JykKICAgIHJldHVybiBtb2R1bGVfc291cmNlCgoKZGVmIF9nZXRfc2l4X3NvdXJjZSgpOgogICAgIiIiSW1wb3J0IHRoZSBuZXdlc3QgdmVyc2lvbiBvZiB0aGUgc2l4IGxpYnJhcnkgdGhhdCdzIGF2YWlsYWJsZSIiIgogICAgbW9kX2luZm8gPSBOb25lCiAgICB0cnk6CiAgICAgICAgaWYgX3N5c3RlbV9zaXggYW5kIF9Mb29zZVZlcnNpb24gYW5kIFwKICAgICAgICAgICAgICAgIF9Mb29zZVZlcnNpb24oX3N5c3RlbV9zaXguX192ZXJzaW9uX18pID49IF9Mb29zZVZlcnNpb24oX2J1bmRsZWRfc2l4Ll9fdmVyc2lvbl9fKToKICAgICAgICAgICAgbW9kX2luZm8gPSBfZmluZF9tb2R1bGUoJ3NpeCcpCiAgICBleGNlcHQ6CiAgICAgICAgIyBBbnkgZXJyb3JzIGZpbmRpbmcgdGhlIHN5c3RlbSBsaWJyYXJ5LCB1c2Ugb3VyIGJ1bmRsZWQgbGliIGluc3RlYWQKICAgICAgICBwYXNzCgogICAgaWYgbm90IG1vZF9pbmZvOgogICAgICAgIHRyeToKICAgICAgICAgICAgbW9kX2luZm8gPSBfZmluZF9tb2R1bGUoJ2Fuc2libGUubW9kdWxlX3V0aWxzLnNpeC5fc2l4JykKICAgICAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgICAgICMgemlwaW1wb3J0CiAgICAgICAgICAgIG1vZHVsZV9zb3VyY2UgPSBfZ2V0X2J1bmRsZWRfc2l4X3NvdXJjZSgpCiAgICAgICAgICAgIHJldHVybiBtb2R1bGVfc291cmNlCgogICAgcmV0dXJuIG1vZF9pbmZvWzBdLnJlYWQoKQoKc291cmNlID0gX2dldF9zaXhfc291cmNlKCkKZXhlYyhzb3VyY2UpClBLAwQUAAAAAADzuytLOOLH0ZF1AACRdQAAIAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fc2l4LnB5IiIiVXRpbGl0aWVzIGZvciB3cml0aW5nIGNvZGUgdGhhdCBydW5zIG9uIFB5dGhvbiAyIGFuZCAzIiIiCgojIENvcHlyaWdodCAoYykgMjAxMC0yMDE1IEJlbmphbWluIFBldGVyc29uCiMKIyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiMgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKIyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAojIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwojIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiMKIyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGwKIyBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgojCiMgVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKIyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKIyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKIyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiMgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKIyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRQojIFNPRlRXQVJFLgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCBhYnNvbHV0ZV9pbXBvcnQKCmltcG9ydCBmdW5jdG9vbHMKaW1wb3J0IGl0ZXJ0b29scwppbXBvcnQgb3BlcmF0b3IKaW1wb3J0IHN5cwppbXBvcnQgdHlwZXMKCl9fYXV0aG9yX18gPSAiQmVuamFtaW4gUGV0ZXJzb24gPGJlbmphbWluQHB5dGhvbi5vcmc+IgpfX3ZlcnNpb25fXyA9ICIxLjEwLjAiCgoKIyBVc2VmdWwgZm9yIHZlcnkgY29hcnNlIHZlcnNpb24gZGlmZmVyZW50aWF0aW9uLgpQWTIgPSBzeXMudmVyc2lvbl9pbmZvWzBdID09IDIKUFkzID0gc3lzLnZlcnNpb25faW5mb1swXSA9PSAzClBZMzQgPSBzeXMudmVyc2lvbl9pbmZvWzA6Ml0gPj0gKDMsIDQpCgppZiBQWTM6CiAgICBzdHJpbmdfdHlwZXMgPSBzdHIsCiAgICBpbnRlZ2VyX3R5cGVzID0gaW50LAogICAgY2xhc3NfdHlwZXMgPSB0eXBlLAogICAgdGV4dF90eXBlID0gc3RyCiAgICBiaW5hcnlfdHlwZSA9IGJ5dGVzCiAgICBNQVhTSVpFID0gc3lzLm1heHNpemUKZWxzZToKICAgIHN0cmluZ190eXBlcyA9IGJhc2VzdHJpbmcsCiAgICBpbnRlZ2VyX3R5cGVzID0gKGludCwgbG9uZykKICAgIGNsYXNzX3R5cGVzID0gKHR5cGUsIHR5cGVzLkNsYXNzVHlwZSkKICAgIHRleHRfdHlwZSA9IHVuaWNvZGUKICAgIGJpbmFyeV90eXBlID0gc3RyCgogICAgaWYgc3lzLnBsYXRmb3JtLnN0YXJ0c3dpdGgoImphdmEiKToKICAgICAgICAjIEp5dGhvbiBhbHdheXMgdXNlcyAzMiBiaXRzLgogICAgICAgIE1BWFNJWkUgPSBpbnQoKDEgPDwgMzEpIC0gMSkKICAgIGVsc2U6CiAgICAgICAgIyBJdCdzIHBvc3NpYmxlIHRvIGhhdmUgc2l6ZW9mKGxvbmcpICE9IHNpemVvZihQeV9zc2l6ZV90KS4KICAgICAgICBjbGFzcyBYKG9iamVjdCk6CgogICAgICAgICAgICBkZWYgX19sZW5fXyhzZWxmKToKICAgICAgICAgICAgICAgIHJldHVybiAxIDw8IDMxCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsZW4oWCgpKQogICAgICAgIGV4Y2VwdCBPdmVyZmxvd0Vycm9yOgogICAgICAgICAgICAjIDMyLWJpdAogICAgICAgICAgICBNQVhTSVpFID0gaW50KCgxIDw8IDMxKSAtIDEpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyA2NC1iaXQKICAgICAgICAgICAgTUFYU0laRSA9IGludCgoMSA8PCA2MykgLSAxKQogICAgICAgIGRlbCBYCgoKZGVmIF9hZGRfZG9jKGZ1bmMsIGRvYyk6CiAgICAiIiJBZGQgZG9jdW1lbnRhdGlvbiB0byBhIGZ1bmN0aW9uLiIiIgogICAgZnVuYy5fX2RvY19fID0gZG9jCgoKZGVmIF9pbXBvcnRfbW9kdWxlKG5hbWUpOgogICAgIiIiSW1wb3J0IG1vZHVsZSwgcmV0dXJuaW5nIHRoZSBtb2R1bGUgYWZ0ZXIgdGhlIGxhc3QgZG90LiIiIgogICAgX19pbXBvcnRfXyhuYW1lKQogICAgcmV0dXJuIHN5cy5tb2R1bGVzW25hbWVdCgoKY2xhc3MgX0xhenlEZXNjcihvYmplY3QpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuYW1lKToKICAgICAgICBzZWxmLm5hbWUgPSBuYW1lCgogICAgZGVmIF9fZ2V0X18oc2VsZiwgb2JqLCB0cCk6CiAgICAgICAgcmVzdWx0ID0gc2VsZi5fcmVzb2x2ZSgpCiAgICAgICAgc2V0YXR0cihvYmosIHNlbGYubmFtZSwgcmVzdWx0KSAgIyBJbnZva2VzIF9fc2V0X18uCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFRoaXMgaXMgYSBiaXQgdWdseSwgYnV0IGl0IGF2b2lkcyBydW5uaW5nIHRoaXMgYWdhaW4gYnkKICAgICAgICAgICAgIyByZW1vdmluZyB0aGlzIGRlc2NyaXB0b3IuCiAgICAgICAgICAgIGRlbGF0dHIob2JqLl9fY2xhc3NfXywgc2VsZi5uYW1lKQogICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiByZXN1bHQKCgpjbGFzcyBNb3ZlZE1vZHVsZShfTGF6eURlc2NyKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSwgb2xkLCBuZXc9Tm9uZSk6CiAgICAgICAgc3VwZXIoTW92ZWRNb2R1bGUsIHNlbGYpLl9faW5pdF9fKG5hbWUpCiAgICAgICAgaWYgUFkzOgogICAgICAgICAgICBpZiBuZXcgaXMgTm9uZToKICAgICAgICAgICAgICAgIG5ldyA9IG5hbWUKICAgICAgICAgICAgc2VsZi5tb2QgPSBuZXcKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLm1vZCA9IG9sZAoKICAgIGRlZiBfcmVzb2x2ZShzZWxmKToKICAgICAgICByZXR1cm4gX2ltcG9ydF9tb2R1bGUoc2VsZi5tb2QpCgogICAgZGVmIF9fZ2V0YXR0cl9fKHNlbGYsIGF0dHIpOgogICAgICAgIF9tb2R1bGUgPSBzZWxmLl9yZXNvbHZlKCkKICAgICAgICB2YWx1ZSA9IGdldGF0dHIoX21vZHVsZSwgYXR0cikKICAgICAgICBzZXRhdHRyKHNlbGYsIGF0dHIsIHZhbHVlKQogICAgICAgIHJldHVybiB2YWx1ZQoKCmNsYXNzIF9MYXp5TW9kdWxlKHR5cGVzLk1vZHVsZVR5cGUpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuYW1lKToKICAgICAgICBzdXBlcihfTGF6eU1vZHVsZSwgc2VsZikuX19pbml0X18obmFtZSkKICAgICAgICBzZWxmLl9fZG9jX18gPSBzZWxmLl9fY2xhc3NfXy5fX2RvY19fCgogICAgZGVmIF9fZGlyX18oc2VsZik6CiAgICAgICAgYXR0cnMgPSBbIl9fZG9jX18iLCAiX19uYW1lX18iXQogICAgICAgIGF0dHJzICs9IFthdHRyLm5hbWUgZm9yIGF0dHIgaW4gc2VsZi5fbW92ZWRfYXR0cmlidXRlc10KICAgICAgICByZXR1cm4gYXR0cnMKCiAgICAjIFN1YmNsYXNzZXMgc2hvdWxkIG92ZXJyaWRlIHRoaXMKICAgIF9tb3ZlZF9hdHRyaWJ1dGVzID0gW10KCgpjbGFzcyBNb3ZlZEF0dHJpYnV0ZShfTGF6eURlc2NyKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSwgb2xkX21vZCwgbmV3X21vZCwgb2xkX2F0dHI9Tm9uZSwgbmV3X2F0dHI9Tm9uZSk6CiAgICAgICAgc3VwZXIoTW92ZWRBdHRyaWJ1dGUsIHNlbGYpLl9faW5pdF9fKG5hbWUpCiAgICAgICAgaWYgUFkzOgogICAgICAgICAgICBpZiBuZXdfbW9kIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBuZXdfbW9kID0gbmFtZQogICAgICAgICAgICBzZWxmLm1vZCA9IG5ld19tb2QKICAgICAgICAgICAgaWYgbmV3X2F0dHIgaXMgTm9uZToKICAgICAgICAgICAgICAgIGlmIG9sZF9hdHRyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgbmV3X2F0dHIgPSBuYW1lCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIG5ld19hdHRyID0gb2xkX2F0dHIKICAgICAgICAgICAgc2VsZi5hdHRyID0gbmV3X2F0dHIKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLm1vZCA9IG9sZF9tb2QKICAgICAgICAgICAgaWYgb2xkX2F0dHIgaXMgTm9uZToKICAgICAgICAgICAgICAgIG9sZF9hdHRyID0gbmFtZQogICAgICAgICAgICBzZWxmLmF0dHIgPSBvbGRfYXR0cgoKICAgIGRlZiBfcmVzb2x2ZShzZWxmKToKICAgICAgICBtb2R1bGUgPSBfaW1wb3J0X21vZHVsZShzZWxmLm1vZCkKICAgICAgICByZXR1cm4gZ2V0YXR0cihtb2R1bGUsIHNlbGYuYXR0cikKCgpjbGFzcyBfU2l4TWV0YVBhdGhJbXBvcnRlcihvYmplY3QpOgoKICAgICIiIgogICAgQSBtZXRhIHBhdGggaW1wb3J0ZXIgdG8gaW1wb3J0IHNpeC5tb3ZlcyBhbmQgaXRzIHN1Ym1vZHVsZXMuCgogICAgVGhpcyBjbGFzcyBpbXBsZW1lbnRzIGEgUEVQMzAyIGZpbmRlciBhbmQgbG9hZGVyLiBJdCBzaG91bGQgYmUgY29tcGF0aWJsZQogICAgd2l0aCBQeXRob24gMi41IGFuZCBhbGwgZXhpc3RpbmcgdmVyc2lvbnMgb2YgUHl0aG9uMwogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHNpeF9tb2R1bGVfbmFtZSk6CiAgICAgICAgc2VsZi5uYW1lID0gc2l4X21vZHVsZV9uYW1lCiAgICAgICAgc2VsZi5rbm93bl9tb2R1bGVzID0ge30KCiAgICBkZWYgX2FkZF9tb2R1bGUoc2VsZiwgbW9kLCAqZnVsbG5hbWVzKToKICAgICAgICBmb3IgZnVsbG5hbWUgaW4gZnVsbG5hbWVzOgogICAgICAgICAgICBzZWxmLmtub3duX21vZHVsZXNbc2VsZi5uYW1lICsgIi4iICsgZnVsbG5hbWVdID0gbW9kCgogICAgZGVmIF9nZXRfbW9kdWxlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICByZXR1cm4gc2VsZi5rbm93bl9tb2R1bGVzW3NlbGYubmFtZSArICIuIiArIGZ1bGxuYW1lXQoKICAgIGRlZiBmaW5kX21vZHVsZShzZWxmLCBmdWxsbmFtZSwgcGF0aD1Ob25lKToKICAgICAgICBpZiBmdWxsbmFtZSBpbiBzZWxmLmtub3duX21vZHVsZXM6CiAgICAgICAgICAgIHJldHVybiBzZWxmCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgX19nZXRfbW9kdWxlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmtub3duX21vZHVsZXNbZnVsbG5hbWVdCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigiVGhpcyBsb2FkZXIgZG9lcyBub3Qga25vdyBtb2R1bGUgIiArIGZ1bGxuYW1lKQoKICAgIGRlZiBsb2FkX21vZHVsZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIGluIGNhc2Ugb2YgYSByZWxvYWQKICAgICAgICAgICAgcmV0dXJuIHN5cy5tb2R1bGVzW2Z1bGxuYW1lXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgICAgIG1vZCA9IHNlbGYuX19nZXRfbW9kdWxlKGZ1bGxuYW1lKQogICAgICAgIGlmIGlzaW5zdGFuY2UobW9kLCBNb3ZlZE1vZHVsZSk6CiAgICAgICAgICAgIG1vZCA9IG1vZC5fcmVzb2x2ZSgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbW9kLl9fbG9hZGVyX18gPSBzZWxmCiAgICAgICAgc3lzLm1vZHVsZXNbZnVsbG5hbWVdID0gbW9kCiAgICAgICAgcmV0dXJuIG1vZAoKICAgIGRlZiBpc19wYWNrYWdlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm4gdHJ1ZSwgaWYgdGhlIG5hbWVkIG1vZHVsZSBpcyBhIHBhY2thZ2UuCgogICAgICAgIFdlIG5lZWQgdGhpcyBtZXRob2QgdG8gZ2V0IGNvcnJlY3Qgc3BlYyBvYmplY3RzIHdpdGgKICAgICAgICBQeXRob24gMy40IChzZWUgUEVQNDUxKQogICAgICAgICIiIgogICAgICAgIHJldHVybiBoYXNhdHRyKHNlbGYuX19nZXRfbW9kdWxlKGZ1bGxuYW1lKSwgIl9fcGF0aF9fIikKCiAgICBkZWYgZ2V0X2NvZGUoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgICIiIlJldHVybiBOb25lCgogICAgICAgIFJlcXVpcmVkLCBpZiBpc19wYWNrYWdlIGlzIGltcGxlbWVudGVkIiIiCiAgICAgICAgc2VsZi5fX2dldF9tb2R1bGUoZnVsbG5hbWUpICAjIGV2ZW50dWFsbHkgcmFpc2VzIEltcG9ydEVycm9yCiAgICAgICAgcmV0dXJuIE5vbmUKICAgIGdldF9zb3VyY2UgPSBnZXRfY29kZSAgIyBzYW1lIGFzIGdldF9jb2RlCgpfaW1wb3J0ZXIgPSBfU2l4TWV0YVBhdGhJbXBvcnRlcihfX25hbWVfXykKCgpjbGFzcyBfTW92ZWRJdGVtcyhfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMiIiIKICAgIF9fcGF0aF9fID0gW10gICMgbWFyayBhcyBwYWNrYWdlCgoKX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiY1N0cmluZ0lPIiwgImNTdHJpbmdJTyIsICJpbyIsICJTdHJpbmdJTyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImZpbHRlciIsICJpdGVydG9vbHMiLCAiYnVpbHRpbnMiLCAiaWZpbHRlciIsICJmaWx0ZXIiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJmaWx0ZXJmYWxzZSIsICJpdGVydG9vbHMiLCAiaXRlcnRvb2xzIiwgImlmaWx0ZXJmYWxzZSIsICJmaWx0ZXJmYWxzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImlucHV0IiwgIl9fYnVpbHRpbl9fIiwgImJ1aWx0aW5zIiwgInJhd19pbnB1dCIsICJpbnB1dCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImludGVybiIsICJfX2J1aWx0aW5fXyIsICJzeXMiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJtYXAiLCAiaXRlcnRvb2xzIiwgImJ1aWx0aW5zIiwgImltYXAiLCAibWFwIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZ2V0Y3dkIiwgIm9zIiwgIm9zIiwgImdldGN3ZHUiLCAiZ2V0Y3dkIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZ2V0Y3dkYiIsICJvcyIsICJvcyIsICJnZXRjd2QiLCAiZ2V0Y3dkYiIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInJhbmdlIiwgIl9fYnVpbHRpbl9fIiwgImJ1aWx0aW5zIiwgInhyYW5nZSIsICJyYW5nZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInJlbG9hZF9tb2R1bGUiLCAiX19idWlsdGluX18iLCAiaW1wb3J0bGliIiBpZiBQWTM0IGVsc2UgImltcCIsICJyZWxvYWQiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJyZWR1Y2UiLCAiX19idWlsdGluX18iLCAiZnVuY3Rvb2xzIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgic2hsZXhfcXVvdGUiLCAicGlwZXMiLCAic2hsZXgiLCAicXVvdGUiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJTdHJpbmdJTyIsICJTdHJpbmdJTyIsICJpbyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVzZXJEaWN0IiwgIlVzZXJEaWN0IiwgImNvbGxlY3Rpb25zIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVXNlckxpc3QiLCAiVXNlckxpc3QiLCAiY29sbGVjdGlvbnMiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVc2VyU3RyaW5nIiwgIlVzZXJTdHJpbmciLCAiY29sbGVjdGlvbnMiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ4cmFuZ2UiLCAiX19idWlsdGluX18iLCAiYnVpbHRpbnMiLCAieHJhbmdlIiwgInJhbmdlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiemlwIiwgIml0ZXJ0b29scyIsICJidWlsdGlucyIsICJpemlwIiwgInppcCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInppcF9sb25nZXN0IiwgIml0ZXJ0b29scyIsICJpdGVydG9vbHMiLCAiaXppcF9sb25nZXN0IiwgInppcF9sb25nZXN0IiksCiAgICBNb3ZlZE1vZHVsZSgiYnVpbHRpbnMiLCAiX19idWlsdGluX18iKSwKICAgIE1vdmVkTW9kdWxlKCJjb25maWdwYXJzZXIiLCAiQ29uZmlnUGFyc2VyIiksCiAgICBNb3ZlZE1vZHVsZSgiY29weXJlZyIsICJjb3B5X3JlZyIpLAogICAgTW92ZWRNb2R1bGUoImRibV9nbnUiLCAiZ2RibSIsICJkYm0uZ251IiksCiAgICBNb3ZlZE1vZHVsZSgiX2R1bW15X3RocmVhZCIsICJkdW1teV90aHJlYWQiLCAiX2R1bW15X3RocmVhZCIpLAogICAgTW92ZWRNb2R1bGUoImh0dHBfY29va2llamFyIiwgImNvb2tpZWxpYiIsICJodHRwLmNvb2tpZWphciIpLAogICAgTW92ZWRNb2R1bGUoImh0dHBfY29va2llcyIsICJDb29raWUiLCAiaHR0cC5jb29raWVzIiksCiAgICBNb3ZlZE1vZHVsZSgiaHRtbF9lbnRpdGllcyIsICJodG1sZW50aXR5ZGVmcyIsICJodG1sLmVudGl0aWVzIiksCiAgICBNb3ZlZE1vZHVsZSgiaHRtbF9wYXJzZXIiLCAiSFRNTFBhcnNlciIsICJodG1sLnBhcnNlciIpLAogICAgTW92ZWRNb2R1bGUoImh0dHBfY2xpZW50IiwgImh0dHBsaWIiLCAiaHR0cC5jbGllbnQiKSwKICAgIE1vdmVkTW9kdWxlKCJlbWFpbF9taW1lX211bHRpcGFydCIsICJlbWFpbC5NSU1FTXVsdGlwYXJ0IiwgImVtYWlsLm1pbWUubXVsdGlwYXJ0IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV9ub25tdWx0aXBhcnQiLCAiZW1haWwuTUlNRU5vbk11bHRpcGFydCIsICJlbWFpbC5taW1lLm5vbm11bHRpcGFydCIpLAogICAgTW92ZWRNb2R1bGUoImVtYWlsX21pbWVfdGV4dCIsICJlbWFpbC5NSU1FVGV4dCIsICJlbWFpbC5taW1lLnRleHQiKSwKICAgIE1vdmVkTW9kdWxlKCJlbWFpbF9taW1lX2Jhc2UiLCAiZW1haWwuTUlNRUJhc2UiLCAiZW1haWwubWltZS5iYXNlIiksCiAgICBNb3ZlZE1vZHVsZSgiQmFzZUhUVFBTZXJ2ZXIiLCAiQmFzZUhUVFBTZXJ2ZXIiLCAiaHR0cC5zZXJ2ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJDR0lIVFRQU2VydmVyIiwgIkNHSUhUVFBTZXJ2ZXIiLCAiaHR0cC5zZXJ2ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJTaW1wbGVIVFRQU2VydmVyIiwgIlNpbXBsZUhUVFBTZXJ2ZXIiLCAiaHR0cC5zZXJ2ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJjUGlja2xlIiwgImNQaWNrbGUiLCAicGlja2xlIiksCiAgICBNb3ZlZE1vZHVsZSgicXVldWUiLCAiUXVldWUiKSwKICAgIE1vdmVkTW9kdWxlKCJyZXBybGliIiwgInJlcHIiKSwKICAgIE1vdmVkTW9kdWxlKCJzb2NrZXRzZXJ2ZXIiLCAiU29ja2V0U2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiX3RocmVhZCIsICJ0aHJlYWQiLCAiX3RocmVhZCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXIiLCAiVGtpbnRlciIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZGlhbG9nIiwgIkRpYWxvZyIsICJ0a2ludGVyLmRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZmlsZWRpYWxvZyIsICJGaWxlRGlhbG9nIiwgInRraW50ZXIuZmlsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfc2Nyb2xsZWR0ZXh0IiwgIlNjcm9sbGVkVGV4dCIsICJ0a2ludGVyLnNjcm9sbGVkdGV4dCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfc2ltcGxlZGlhbG9nIiwgIlNpbXBsZURpYWxvZyIsICJ0a2ludGVyLnNpbXBsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfdGl4IiwgIlRpeCIsICJ0a2ludGVyLnRpeCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfdHRrIiwgInR0ayIsICJ0a2ludGVyLnR0ayIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfY29uc3RhbnRzIiwgIlRrY29uc3RhbnRzIiwgInRraW50ZXIuY29uc3RhbnRzIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9kbmQiLCAiVGtkbmQiLCAidGtpbnRlci5kbmQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2NvbG9yY2hvb3NlciIsICJ0a0NvbG9yQ2hvb3NlciIsCiAgICAgICAgICAgICAgICAidGtpbnRlci5jb2xvcmNob29zZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2NvbW1vbmRpYWxvZyIsICJ0a0NvbW1vbkRpYWxvZyIsCiAgICAgICAgICAgICAgICAidGtpbnRlci5jb21tb25kaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3RrZmlsZWRpYWxvZyIsICJ0a0ZpbGVEaWFsb2ciLCAidGtpbnRlci5maWxlZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9mb250IiwgInRrRm9udCIsICJ0a2ludGVyLmZvbnQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX21lc3NhZ2Vib3giLCAidGtNZXNzYWdlQm94IiwgInRraW50ZXIubWVzc2FnZWJveCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfdGtzaW1wbGVkaWFsb2ciLCAidGtTaW1wbGVEaWFsb2ciLAogICAgICAgICAgICAgICAgInRraW50ZXIuc2ltcGxlZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidXJsbGliX3BhcnNlIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYl9wYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkTW9kdWxlKCJ1cmxsaWJfZXJyb3IiLCBfX25hbWVfXyArICIubW92ZXMudXJsbGliX2Vycm9yIiwgInVybGxpYi5lcnJvciIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYiIsIF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIiLCBfX25hbWVfXyArICIubW92ZXMudXJsbGliIiksCiAgICBNb3ZlZE1vZHVsZSgidXJsbGliX3JvYm90cGFyc2VyIiwgInJvYm90cGFyc2VyIiwgInVybGxpYi5yb2JvdHBhcnNlciIpLAogICAgTW92ZWRNb2R1bGUoInhtbHJwY19jbGllbnQiLCAieG1scnBjbGliIiwgInhtbHJwYy5jbGllbnQiKSwKICAgIE1vdmVkTW9kdWxlKCJ4bWxycGNfc2VydmVyIiwgIlNpbXBsZVhNTFJQQ1NlcnZlciIsICJ4bWxycGMuc2VydmVyIiksCl0KIyBBZGQgd2luZG93cyBzcGVjaWZpYyBtb2R1bGVzLgppZiBzeXMucGxhdGZvcm0gPT0gIndpbjMyIjoKICAgIF9tb3ZlZF9hdHRyaWJ1dGVzICs9IFsKICAgICAgICBNb3ZlZE1vZHVsZSgid2lucmVnIiwgIl93aW5yZWciKSwKICAgIF0KCmZvciBhdHRyIGluIF9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihfTW92ZWRJdGVtcywgYXR0ci5uYW1lLCBhdHRyKQogICAgaWYgaXNpbnN0YW5jZShhdHRyLCBNb3ZlZE1vZHVsZSk6CiAgICAgICAgX2ltcG9ydGVyLl9hZGRfbW9kdWxlKGF0dHIsICJtb3Zlcy4iICsgYXR0ci5uYW1lKQpkZWwgYXR0cgoKX01vdmVkSXRlbXMuX21vdmVkX2F0dHJpYnV0ZXMgPSBfbW92ZWRfYXR0cmlidXRlcwoKbW92ZXMgPSBfTW92ZWRJdGVtcyhfX25hbWVfXyArICIubW92ZXMiKQpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUobW92ZXMsICJtb3ZlcyIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcGFyc2UoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfcGFyc2UiIiIKCgpfdXJsbGliX3BhcnNlX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUGFyc2VSZXN1bHQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiU3BsaXRSZXN1bHQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicGFyc2VfcXMiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicGFyc2VfcXNsIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybGRlZnJhZyIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxqb2luIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHBhcnNlIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHNwbGl0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHVucGFyc2UiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsdW5zcGxpdCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJxdW90ZSIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicXVvdGVfcGx1cyIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidW5xdW90ZSIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidW5xdW90ZV9wbHVzIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxlbmNvZGUiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInNwbGl0cXVlcnkiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInNwbGl0dGFnIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzcGxpdHVzZXIiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfZnJhZ21lbnQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19uZXRsb2MiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19wYXJhbXMiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19xdWVyeSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX3JlbGF0aXZlIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfcGFyc2VfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcGFyc2UsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9wYXJzZV9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcGFyc2UoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYl9wYXJzZSIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9wYXJzZSIsICJtb3Zlcy51cmxsaWIucGFyc2UiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX2Vycm9yIiIiCgoKX3VybGxpYl9lcnJvcl9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoIlVSTEVycm9yIiwgInVybGxpYjIiLCAidXJsbGliLmVycm9yIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEVycm9yIiwgInVybGxpYjIiLCAidXJsbGliLmVycm9yIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQ29udGVudFRvb1Nob3J0RXJyb3IiLCAidXJsbGliIiwgInVybGxpYi5lcnJvciIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfZXJyb3JfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfZXJyb3IsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9lcnJvcl9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfZXJyb3IoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5lcnJvciIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9lcnJvciIsICJtb3Zlcy51cmxsaWIuZXJyb3IiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfcmVxdWVzdCIiIgoKCl91cmxsaWJfcmVxdWVzdF9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoInVybG9wZW4iLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImluc3RhbGxfb3BlbmVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJidWlsZF9vcGVuZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInBhdGhuYW1lMnVybCIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmwycGF0aG5hbWUiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZ2V0cHJveGllcyIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJSZXF1ZXN0IiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJPcGVuZXJEaXJlY3RvciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUERlZmF1bHRFcnJvckhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBSZWRpcmVjdEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBDb29raWVQcm9jZXNzb3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlByb3h5SGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQmFzZUhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBQYXNzd29yZE1nciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUFBhc3N3b3JkTWdyV2l0aERlZmF1bHRSZWFsbSIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQWJzdHJhY3RCYXNpY0F1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQQmFzaWNBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUHJveHlCYXNpY0F1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJBYnN0cmFjdERpZ2VzdEF1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQRGlnZXN0QXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlByb3h5RGlnZXN0QXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQU0hhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkZpbGVIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJGVFBIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJDYWNoZUZUUEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVua25vd25IYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQRXJyb3JQcm9jZXNzb3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHJldHJpZXZlIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybGNsZWFudXAiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVVJMb3BlbmVyIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkZhbmN5VVJMb3BlbmVyIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInByb3h5X2J5cGFzcyIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX3JlcXVlc3RfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVxdWVzdCwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVxdWVzdC5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfcmVxdWVzdF9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVxdWVzdChfX25hbWVfXyArICIubW92ZXMudXJsbGliLnJlcXVlc3QiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfcmVxdWVzdCIsICJtb3Zlcy51cmxsaWIucmVxdWVzdCIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVzcG9uc2UoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfcmVzcG9uc2UiIiIKCgpfdXJsbGliX3Jlc3BvbnNlX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkYmFzZSIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkY2xvc2Vob29rIiwgInVybGxpYiIsICJ1cmxsaWIucmVzcG9uc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJhZGRpbmZvIiwgInVybGxpYiIsICJ1cmxsaWIucmVzcG9uc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJhZGRpbmZvdXJsIiwgInVybGxpYiIsICJ1cmxsaWIucmVzcG9uc2UiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX3Jlc3BvbnNlX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3Jlc3BvbnNlLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZS5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfcmVzcG9uc2VfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3Jlc3BvbnNlKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIucmVzcG9uc2UiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfcmVzcG9uc2UiLCAibW92ZXMudXJsbGliLnJlc3BvbnNlIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yb2JvdHBhcnNlcihfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9yb2JvdHBhcnNlciIiIgoKCl91cmxsaWJfcm9ib3RwYXJzZXJfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJSb2JvdEZpbGVQYXJzZXIiLCAicm9ib3RwYXJzZXIiLCAidXJsbGliLnJvYm90cGFyc2VyIiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9yb2JvdHBhcnNlcl9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yb2JvdHBhcnNlciwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3JvYm90cGFyc2VyX21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yb2JvdHBhcnNlcihfX25hbWVfXyArICIubW92ZXMudXJsbGliLnJvYm90cGFyc2VyIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3JvYm90cGFyc2VyIiwgIm1vdmVzLnVybGxpYi5yb2JvdHBhcnNlciIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWIodHlwZXMuTW9kdWxlVHlwZSk6CgogICAgIiIiQ3JlYXRlIGEgc2l4Lm1vdmVzLnVybGxpYiBuYW1lc3BhY2UgdGhhdCByZXNlbWJsZXMgdGhlIFB5dGhvbiAzIG5hbWVzcGFjZSIiIgogICAgX19wYXRoX18gPSBbXSAgIyBtYXJrIGFzIHBhY2thZ2UKICAgIHBhcnNlID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfcGFyc2UiKQogICAgZXJyb3IgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9lcnJvciIpCiAgICByZXF1ZXN0ID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfcmVxdWVzdCIpCiAgICByZXNwb25zZSA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3Jlc3BvbnNlIikKICAgIHJvYm90cGFyc2VyID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfcm9ib3RwYXJzZXIiKQoKICAgIGRlZiBfX2Rpcl9fKHNlbGYpOgogICAgICAgIHJldHVybiBbJ3BhcnNlJywgJ2Vycm9yJywgJ3JlcXVlc3QnLCAncmVzcG9uc2UnLCAncm9ib3RwYXJzZXInXQoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWIiKQoKCmRlZiBhZGRfbW92ZShtb3ZlKToKICAgICIiIkFkZCBhbiBpdGVtIHRvIHNpeC5tb3Zlcy4iIiIKICAgIHNldGF0dHIoX01vdmVkSXRlbXMsIG1vdmUubmFtZSwgbW92ZSkKCgpkZWYgcmVtb3ZlX21vdmUobmFtZSk6CiAgICAiIiJSZW1vdmUgaXRlbSBmcm9tIHNpeC5tb3Zlcy4iIiIKICAgIHRyeToKICAgICAgICBkZWxhdHRyKF9Nb3ZlZEl0ZW1zLCBuYW1lKQogICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgIHRyeToKICAgICAgICAgICAgZGVsIG1vdmVzLl9fZGljdF9fW25hbWVdCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICByYWlzZSBBdHRyaWJ1dGVFcnJvcigibm8gc3VjaCBtb3ZlLCAlciIgJSAobmFtZSwpKQoKCmlmIFBZMzoKICAgIF9tZXRoX2Z1bmMgPSAiX19mdW5jX18iCiAgICBfbWV0aF9zZWxmID0gIl9fc2VsZl9fIgoKICAgIF9mdW5jX2Nsb3N1cmUgPSAiX19jbG9zdXJlX18iCiAgICBfZnVuY19jb2RlID0gIl9fY29kZV9fIgogICAgX2Z1bmNfZGVmYXVsdHMgPSAiX19kZWZhdWx0c19fIgogICAgX2Z1bmNfZ2xvYmFscyA9ICJfX2dsb2JhbHNfXyIKZWxzZToKICAgIF9tZXRoX2Z1bmMgPSAiaW1fZnVuYyIKICAgIF9tZXRoX3NlbGYgPSAiaW1fc2VsZiIKCiAgICBfZnVuY19jbG9zdXJlID0gImZ1bmNfY2xvc3VyZSIKICAgIF9mdW5jX2NvZGUgPSAiZnVuY19jb2RlIgogICAgX2Z1bmNfZGVmYXVsdHMgPSAiZnVuY19kZWZhdWx0cyIKICAgIF9mdW5jX2dsb2JhbHMgPSAiZnVuY19nbG9iYWxzIgoKCnRyeToKICAgIGFkdmFuY2VfaXRlcmF0b3IgPSBuZXh0CmV4Y2VwdCBOYW1lRXJyb3I6CiAgICBkZWYgYWR2YW5jZV9pdGVyYXRvcihpdCk6CiAgICAgICAgcmV0dXJuIGl0Lm5leHQoKQpuZXh0ID0gYWR2YW5jZV9pdGVyYXRvcgoKCnRyeToKICAgIGNhbGxhYmxlID0gY2FsbGFibGUKZXhjZXB0IE5hbWVFcnJvcjoKICAgIGRlZiBjYWxsYWJsZShvYmopOgogICAgICAgIHJldHVybiBhbnkoIl9fY2FsbF9fIiBpbiBrbGFzcy5fX2RpY3RfXyBmb3Iga2xhc3MgaW4gdHlwZShvYmopLl9fbXJvX18pCgoKaWYgUFkzOgogICAgZGVmIGdldF91bmJvdW5kX2Z1bmN0aW9uKHVuYm91bmQpOgogICAgICAgIHJldHVybiB1bmJvdW5kCgogICAgY3JlYXRlX2JvdW5kX21ldGhvZCA9IHR5cGVzLk1ldGhvZFR5cGUKCiAgICBkZWYgY3JlYXRlX3VuYm91bmRfbWV0aG9kKGZ1bmMsIGNscyk6CiAgICAgICAgcmV0dXJuIGZ1bmMKCiAgICBJdGVyYXRvciA9IG9iamVjdAplbHNlOgogICAgZGVmIGdldF91bmJvdW5kX2Z1bmN0aW9uKHVuYm91bmQpOgogICAgICAgIHJldHVybiB1bmJvdW5kLmltX2Z1bmMKCiAgICBkZWYgY3JlYXRlX2JvdW5kX21ldGhvZChmdW5jLCBvYmopOgogICAgICAgIHJldHVybiB0eXBlcy5NZXRob2RUeXBlKGZ1bmMsIG9iaiwgb2JqLl9fY2xhc3NfXykKCiAgICBkZWYgY3JlYXRlX3VuYm91bmRfbWV0aG9kKGZ1bmMsIGNscyk6CiAgICAgICAgcmV0dXJuIHR5cGVzLk1ldGhvZFR5cGUoZnVuYywgTm9uZSwgY2xzKQoKICAgIGNsYXNzIEl0ZXJhdG9yKG9iamVjdCk6CgogICAgICAgIGRlZiBuZXh0KHNlbGYpOgogICAgICAgICAgICByZXR1cm4gdHlwZShzZWxmKS5fX25leHRfXyhzZWxmKQoKICAgIGNhbGxhYmxlID0gY2FsbGFibGUKX2FkZF9kb2MoZ2V0X3VuYm91bmRfZnVuY3Rpb24sCiAgICAgICAgICIiIkdldCB0aGUgZnVuY3Rpb24gb3V0IG9mIGEgcG9zc2libHkgdW5ib3VuZCBmdW5jdGlvbiIiIikKCgpnZXRfbWV0aG9kX2Z1bmN0aW9uID0gb3BlcmF0b3IuYXR0cmdldHRlcihfbWV0aF9mdW5jKQpnZXRfbWV0aG9kX3NlbGYgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9tZXRoX3NlbGYpCmdldF9mdW5jdGlvbl9jbG9zdXJlID0gb3BlcmF0b3IuYXR0cmdldHRlcihfZnVuY19jbG9zdXJlKQpnZXRfZnVuY3Rpb25fY29kZSA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfY29kZSkKZ2V0X2Z1bmN0aW9uX2RlZmF1bHRzID0gb3BlcmF0b3IuYXR0cmdldHRlcihfZnVuY19kZWZhdWx0cykKZ2V0X2Z1bmN0aW9uX2dsb2JhbHMgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9mdW5jX2dsb2JhbHMpCgoKaWYgUFkzOgogICAgZGVmIGl0ZXJrZXlzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBpdGVyKGQua2V5cygqKmt3KSkKCiAgICBkZWYgaXRlcnZhbHVlcyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLnZhbHVlcygqKmt3KSkKCiAgICBkZWYgaXRlcml0ZW1zKGQsICoqa3cpOgogICAgICAgIHJldHVybiBpdGVyKGQuaXRlbXMoKiprdykpCgogICAgZGVmIGl0ZXJsaXN0cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLmxpc3RzKCoqa3cpKQoKICAgIHZpZXdrZXlzID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJrZXlzIikKCiAgICB2aWV3dmFsdWVzID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJ2YWx1ZXMiKQoKICAgIHZpZXdpdGVtcyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigiaXRlbXMiKQplbHNlOgogICAgZGVmIGl0ZXJrZXlzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJrZXlzKCoqa3cpCgogICAgZGVmIGl0ZXJ2YWx1ZXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGQuaXRlcnZhbHVlcygqKmt3KQoKICAgIGRlZiBpdGVyaXRlbXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGQuaXRlcml0ZW1zKCoqa3cpCgogICAgZGVmIGl0ZXJsaXN0cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gZC5pdGVybGlzdHMoKiprdykKCiAgICB2aWV3a2V5cyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigidmlld2tleXMiKQoKICAgIHZpZXd2YWx1ZXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZpZXd2YWx1ZXMiKQoKICAgIHZpZXdpdGVtcyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigidmlld2l0ZW1zIikKCl9hZGRfZG9jKGl0ZXJrZXlzLCAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIGtleXMgb2YgYSBkaWN0aW9uYXJ5LiIpCl9hZGRfZG9jKGl0ZXJ2YWx1ZXMsICJSZXR1cm4gYW4gaXRlcmF0b3Igb3ZlciB0aGUgdmFsdWVzIG9mIGEgZGljdGlvbmFyeS4iKQpfYWRkX2RvYyhpdGVyaXRlbXMsCiAgICAgICAgICJSZXR1cm4gYW4gaXRlcmF0b3Igb3ZlciB0aGUgKGtleSwgdmFsdWUpIHBhaXJzIG9mIGEgZGljdGlvbmFyeS4iKQpfYWRkX2RvYyhpdGVybGlzdHMsCiAgICAgICAgICJSZXR1cm4gYW4gaXRlcmF0b3Igb3ZlciB0aGUgKGtleSwgW3ZhbHVlc10pIHBhaXJzIG9mIGEgZGljdGlvbmFyeS4iKQoKCmlmIFBZMzoKICAgIGRlZiBiKHMpOgogICAgICAgIHJldHVybiBzLmVuY29kZSgibGF0aW4tMSIpCgogICAgZGVmIHUocyk6CiAgICAgICAgcmV0dXJuIHMKICAgIHVuaWNociA9IGNocgogICAgaW1wb3J0IHN0cnVjdAogICAgaW50MmJ5dGUgPSBzdHJ1Y3QuU3RydWN0KCI+QiIpLnBhY2sKICAgIGRlbCBzdHJ1Y3QKICAgIGJ5dGUyaW50ID0gb3BlcmF0b3IuaXRlbWdldHRlcigwKQogICAgaW5kZXhieXRlcyA9IG9wZXJhdG9yLmdldGl0ZW0KICAgIGl0ZXJieXRlcyA9IGl0ZXIKICAgIGltcG9ydCBpbwogICAgU3RyaW5nSU8gPSBpby5TdHJpbmdJTwogICAgQnl0ZXNJTyA9IGlvLkJ5dGVzSU8KICAgIF9hc3NlcnRDb3VudEVxdWFsID0gImFzc2VydENvdW50RXF1YWwiCiAgICBpZiBzeXMudmVyc2lvbl9pbmZvWzFdIDw9IDE6CiAgICAgICAgX2Fzc2VydFJhaXNlc1JlZ2V4ID0gImFzc2VydFJhaXNlc1JlZ2V4cCIKICAgICAgICBfYXNzZXJ0UmVnZXggPSAiYXNzZXJ0UmVnZXhwTWF0Y2hlcyIKICAgIGVsc2U6CiAgICAgICAgX2Fzc2VydFJhaXNlc1JlZ2V4ID0gImFzc2VydFJhaXNlc1JlZ2V4IgogICAgICAgIF9hc3NlcnRSZWdleCA9ICJhc3NlcnRSZWdleCIKZWxzZToKICAgIGRlZiBiKHMpOgogICAgICAgIHJldHVybiBzCiAgICAjIFdvcmthcm91bmQgZm9yIHN0YW5kYWxvbmUgYmFja3NsYXNoCgogICAgZGVmIHUocyk6CiAgICAgICAgcmV0dXJuIHVuaWNvZGUocy5yZXBsYWNlKHInXFwnLCByJ1xcXFwnKSwgInVuaWNvZGVfZXNjYXBlIikKICAgIHVuaWNociA9IHVuaWNocgogICAgaW50MmJ5dGUgPSBjaHIKCiAgICBkZWYgYnl0ZTJpbnQoYnMpOgogICAgICAgIHJldHVybiBvcmQoYnNbMF0pCgogICAgZGVmIGluZGV4Ynl0ZXMoYnVmLCBpKToKICAgICAgICByZXR1cm4gb3JkKGJ1ZltpXSkKICAgIGl0ZXJieXRlcyA9IGZ1bmN0b29scy5wYXJ0aWFsKGl0ZXJ0b29scy5pbWFwLCBvcmQpCiAgICBpbXBvcnQgU3RyaW5nSU8KICAgIFN0cmluZ0lPID0gQnl0ZXNJTyA9IFN0cmluZ0lPLlN0cmluZ0lPCiAgICBfYXNzZXJ0Q291bnRFcXVhbCA9ICJhc3NlcnRJdGVtc0VxdWFsIgogICAgX2Fzc2VydFJhaXNlc1JlZ2V4ID0gImFzc2VydFJhaXNlc1JlZ2V4cCIKICAgIF9hc3NlcnRSZWdleCA9ICJhc3NlcnRSZWdleHBNYXRjaGVzIgpfYWRkX2RvYyhiLCAiIiJCeXRlIGxpdGVyYWwiIiIpCl9hZGRfZG9jKHUsICIiIlRleHQgbGl0ZXJhbCIiIikKCgpkZWYgYXNzZXJ0Q291bnRFcXVhbChzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgcmV0dXJuIGdldGF0dHIoc2VsZiwgX2Fzc2VydENvdW50RXF1YWwpKCphcmdzLCAqKmt3YXJncykKCgpkZWYgYXNzZXJ0UmFpc2VzUmVnZXgoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgIHJldHVybiBnZXRhdHRyKHNlbGYsIF9hc3NlcnRSYWlzZXNSZWdleCkoKmFyZ3MsICoqa3dhcmdzKQoKCmRlZiBhc3NlcnRSZWdleChzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgcmV0dXJuIGdldGF0dHIoc2VsZiwgX2Fzc2VydFJlZ2V4KSgqYXJncywgKiprd2FyZ3MpCgoKaWYgUFkzOgogICAgZXhlY18gPSBnZXRhdHRyKG1vdmVzLmJ1aWx0aW5zLCAiZXhlYyIpCgogICAgZGVmIHJlcmFpc2UodHAsIHZhbHVlLCB0Yj1Ob25lKToKICAgICAgICBpZiB2YWx1ZSBpcyBOb25lOgogICAgICAgICAgICB2YWx1ZSA9IHRwKCkKICAgICAgICBpZiB2YWx1ZS5fX3RyYWNlYmFja19fIGlzIG5vdCB0YjoKICAgICAgICAgICAgcmFpc2UgdmFsdWUud2l0aF90cmFjZWJhY2sodGIpCiAgICAgICAgcmFpc2UgdmFsdWUKCmVsc2U6CiAgICBkZWYgZXhlY18oX2NvZGVfLCBfZ2xvYnNfPU5vbmUsIF9sb2NzXz1Ob25lKToKICAgICAgICAiIiJFeGVjdXRlIGNvZGUgaW4gYSBuYW1lc3BhY2UuIiIiCiAgICAgICAgaWYgX2dsb2JzXyBpcyBOb25lOgogICAgICAgICAgICBmcmFtZSA9IHN5cy5fZ2V0ZnJhbWUoMSkKICAgICAgICAgICAgX2dsb2JzXyA9IGZyYW1lLmZfZ2xvYmFscwogICAgICAgICAgICBpZiBfbG9jc18gaXMgTm9uZToKICAgICAgICAgICAgICAgIF9sb2NzXyA9IGZyYW1lLmZfbG9jYWxzCiAgICAgICAgICAgIGRlbCBmcmFtZQogICAgICAgIGVsaWYgX2xvY3NfIGlzIE5vbmU6CiAgICAgICAgICAgIF9sb2NzXyA9IF9nbG9ic18KICAgICAgICBleGVjKCIiImV4ZWMgX2NvZGVfIGluIF9nbG9ic18sIF9sb2NzXyIiIikKCiAgICBleGVjXygiIiJkZWYgcmVyYWlzZSh0cCwgdmFsdWUsIHRiPU5vbmUpOgogICAgcmFpc2UgdHAsIHZhbHVlLCB0YgoiIiIpCgoKaWYgc3lzLnZlcnNpb25faW5mb1s6Ml0gPT0gKDMsIDIpOgogICAgZXhlY18oIiIiZGVmIHJhaXNlX2Zyb20odmFsdWUsIGZyb21fdmFsdWUpOgogICAgaWYgZnJvbV92YWx1ZSBpcyBOb25lOgogICAgICAgIHJhaXNlIHZhbHVlCiAgICByYWlzZSB2YWx1ZSBmcm9tIGZyb21fdmFsdWUKIiIiKQplbGlmIHN5cy52ZXJzaW9uX2luZm9bOjJdID4gKDMsIDIpOgogICAgZXhlY18oIiIiZGVmIHJhaXNlX2Zyb20odmFsdWUsIGZyb21fdmFsdWUpOgogICAgcmFpc2UgdmFsdWUgZnJvbSBmcm9tX3ZhbHVlCiIiIikKZWxzZToKICAgIGRlZiByYWlzZV9mcm9tKHZhbHVlLCBmcm9tX3ZhbHVlKToKICAgICAgICByYWlzZSB2YWx1ZQoKCnByaW50XyA9IGdldGF0dHIobW92ZXMuYnVpbHRpbnMsICJwcmludCIsIE5vbmUpCmlmIHByaW50XyBpcyBOb25lOgogICAgZGVmIHByaW50XygqYXJncywgKiprd2FyZ3MpOgogICAgICAgICIiIlRoZSBuZXctc3R5bGUgcHJpbnQgZnVuY3Rpb24gZm9yIFB5dGhvbiAyLjQgYW5kIDIuNS4iIiIKICAgICAgICBmcCA9IGt3YXJncy5wb3AoImZpbGUiLCBzeXMuc3Rkb3V0KQogICAgICAgIGlmIGZwIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBkZWYgd3JpdGUoZGF0YSk6CiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGRhdGEsIGJhc2VzdHJpbmcpOgogICAgICAgICAgICAgICAgZGF0YSA9IHN0cihkYXRhKQogICAgICAgICAgICAjIElmIHRoZSBmaWxlIGhhcyBhbiBlbmNvZGluZywgZW5jb2RlIHVuaWNvZGUgd2l0aCBpdC4KICAgICAgICAgICAgaWYgKGlzaW5zdGFuY2UoZnAsIGZpbGUpIGFuZAogICAgICAgICAgICAgICAgICAgIGlzaW5zdGFuY2UoZGF0YSwgdW5pY29kZSkgYW5kCiAgICAgICAgICAgICAgICAgICAgZnAuZW5jb2RpbmcgaXMgbm90IE5vbmUpOgogICAgICAgICAgICAgICAgZXJyb3JzID0gZ2V0YXR0cihmcCwgImVycm9ycyIsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBlcnJvcnMgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBlcnJvcnMgPSAic3RyaWN0IgogICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEuZW5jb2RlKGZwLmVuY29kaW5nLCBlcnJvcnMpCiAgICAgICAgICAgIGZwLndyaXRlKGRhdGEpCiAgICAgICAgd2FudF91bmljb2RlID0gRmFsc2UKICAgICAgICBzZXAgPSBrd2FyZ3MucG9wKCJzZXAiLCBOb25lKQogICAgICAgIGlmIHNlcCBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzZXAsIHVuaWNvZGUpOgogICAgICAgICAgICAgICAgd2FudF91bmljb2RlID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5vdCBpc2luc3RhbmNlKHNlcCwgc3RyKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigic2VwIG11c3QgYmUgTm9uZSBvciBhIHN0cmluZyIpCiAgICAgICAgZW5kID0ga3dhcmdzLnBvcCgiZW5kIiwgTm9uZSkKICAgICAgICBpZiBlbmQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZW5kLCB1bmljb2RlKToKICAgICAgICAgICAgICAgIHdhbnRfdW5pY29kZSA9IFRydWUKICAgICAgICAgICAgZWxpZiBub3QgaXNpbnN0YW5jZShlbmQsIHN0cik6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoImVuZCBtdXN0IGJlIE5vbmUgb3IgYSBzdHJpbmciKQogICAgICAgIGlmIGt3YXJnczoKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJpbnZhbGlkIGtleXdvcmQgYXJndW1lbnRzIHRvIHByaW50KCkiKQogICAgICAgIGlmIG5vdCB3YW50X3VuaWNvZGU6CiAgICAgICAgICAgIGZvciBhcmcgaW4gYXJnczoKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYXJnLCB1bmljb2RlKToKICAgICAgICAgICAgICAgICAgICB3YW50X3VuaWNvZGUgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICBpZiB3YW50X3VuaWNvZGU6CiAgICAgICAgICAgIG5ld2xpbmUgPSB1bmljb2RlKCJcbiIpCiAgICAgICAgICAgIHNwYWNlID0gdW5pY29kZSgiICIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbmV3bGluZSA9ICJcbiIKICAgICAgICAgICAgc3BhY2UgPSAiICIKICAgICAgICBpZiBzZXAgaXMgTm9uZToKICAgICAgICAgICAgc2VwID0gc3BhY2UKICAgICAgICBpZiBlbmQgaXMgTm9uZToKICAgICAgICAgICAgZW5kID0gbmV3bGluZQogICAgICAgIGZvciBpLCBhcmcgaW4gZW51bWVyYXRlKGFyZ3MpOgogICAgICAgICAgICBpZiBpOgogICAgICAgICAgICAgICAgd3JpdGUoc2VwKQogICAgICAgICAgICB3cml0ZShhcmcpCiAgICAgICAgd3JpdGUoZW5kKQppZiBzeXMudmVyc2lvbl9pbmZvWzoyXSA8ICgzLCAzKToKICAgIF9wcmludCA9IHByaW50XwoKICAgIGRlZiBwcmludF8oKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBmcCA9IGt3YXJncy5nZXQoImZpbGUiLCBzeXMuc3Rkb3V0KQogICAgICAgIGZsdXNoID0ga3dhcmdzLnBvcCgiZmx1c2giLCBGYWxzZSkKICAgICAgICBfcHJpbnQoKmFyZ3MsICoqa3dhcmdzKQogICAgICAgIGlmIGZsdXNoIGFuZCBmcCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZnAuZmx1c2goKQoKX2FkZF9kb2MocmVyYWlzZSwgIiIiUmVyYWlzZSBhbiBleGNlcHRpb24uIiIiKQoKaWYgc3lzLnZlcnNpb25faW5mb1swOjJdIDwgKDMsIDQpOgogICAgZGVmIHdyYXBzKHdyYXBwZWQsIGFzc2lnbmVkPWZ1bmN0b29scy5XUkFQUEVSX0FTU0lHTk1FTlRTLAogICAgICAgICAgICAgIHVwZGF0ZWQ9ZnVuY3Rvb2xzLldSQVBQRVJfVVBEQVRFUyk6CiAgICAgICAgZGVmIHdyYXBwZXIoZik6CiAgICAgICAgICAgIGYgPSBmdW5jdG9vbHMud3JhcHMod3JhcHBlZCwgYXNzaWduZWQsIHVwZGF0ZWQpKGYpCiAgICAgICAgICAgIGYuX193cmFwcGVkX18gPSB3cmFwcGVkCiAgICAgICAgICAgIHJldHVybiBmCiAgICAgICAgcmV0dXJuIHdyYXBwZXIKZWxzZToKICAgIHdyYXBzID0gZnVuY3Rvb2xzLndyYXBzCgoKZGVmIHdpdGhfbWV0YWNsYXNzKG1ldGEsICpiYXNlcyk6CiAgICAiIiJDcmVhdGUgYSBiYXNlIGNsYXNzIHdpdGggYSBtZXRhY2xhc3MuIiIiCiAgICAjIFRoaXMgcmVxdWlyZXMgYSBiaXQgb2YgZXhwbGFuYXRpb246IHRoZSBiYXNpYyBpZGVhIGlzIHRvIG1ha2UgYSBkdW1teQogICAgIyBtZXRhY2xhc3MgZm9yIG9uZSBsZXZlbCBvZiBjbGFzcyBpbnN0YW50aWF0aW9uIHRoYXQgcmVwbGFjZXMgaXRzZWxmIHdpdGgKICAgICMgdGhlIGFjdHVhbCBtZXRhY2xhc3MuCiAgICBjbGFzcyBtZXRhY2xhc3MobWV0YSk6CgogICAgICAgIGRlZiBfX25ld19fKGNscywgbmFtZSwgdGhpc19iYXNlcywgZCk6CiAgICAgICAgICAgIHJldHVybiBtZXRhKG5hbWUsIGJhc2VzLCBkKQogICAgcmV0dXJuIHR5cGUuX19uZXdfXyhtZXRhY2xhc3MsICd0ZW1wb3JhcnlfY2xhc3MnLCAoKSwge30pCgoKZGVmIGFkZF9tZXRhY2xhc3MobWV0YWNsYXNzKToKICAgICIiIkNsYXNzIGRlY29yYXRvciBmb3IgY3JlYXRpbmcgYSBjbGFzcyB3aXRoIGEgbWV0YWNsYXNzLiIiIgogICAgZGVmIHdyYXBwZXIoY2xzKToKICAgICAgICBvcmlnX3ZhcnMgPSBjbHMuX19kaWN0X18uY29weSgpCiAgICAgICAgc2xvdHMgPSBvcmlnX3ZhcnMuZ2V0KCdfX3Nsb3RzX18nKQogICAgICAgIGlmIHNsb3RzIGlzIG5vdCBOb25lOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHNsb3RzLCBzdHIpOgogICAgICAgICAgICAgICAgc2xvdHMgPSBbc2xvdHNdCiAgICAgICAgICAgIGZvciBzbG90c192YXIgaW4gc2xvdHM6CiAgICAgICAgICAgICAgICBvcmlnX3ZhcnMucG9wKHNsb3RzX3ZhcikKICAgICAgICBvcmlnX3ZhcnMucG9wKCdfX2RpY3RfXycsIE5vbmUpCiAgICAgICAgb3JpZ192YXJzLnBvcCgnX193ZWFrcmVmX18nLCBOb25lKQogICAgICAgIHJldHVybiBtZXRhY2xhc3MoY2xzLl9fbmFtZV9fLCBjbHMuX19iYXNlc19fLCBvcmlnX3ZhcnMpCiAgICByZXR1cm4gd3JhcHBlcgoKCmRlZiBweXRob25fMl91bmljb2RlX2NvbXBhdGlibGUoa2xhc3MpOgogICAgIiIiCiAgICBBIGRlY29yYXRvciB0aGF0IGRlZmluZXMgX191bmljb2RlX18gYW5kIF9fc3RyX18gbWV0aG9kcyB1bmRlciBQeXRob24gMi4KICAgIFVuZGVyIFB5dGhvbiAzIGl0IGRvZXMgbm90aGluZy4KCiAgICBUbyBzdXBwb3J0IFB5dGhvbiAyIGFuZCAzIHdpdGggYSBzaW5nbGUgY29kZSBiYXNlLCBkZWZpbmUgYSBfX3N0cl9fIG1ldGhvZAogICAgcmV0dXJuaW5nIHRleHQgYW5kIGFwcGx5IHRoaXMgZGVjb3JhdG9yIHRvIHRoZSBjbGFzcy4KICAgICIiIgogICAgaWYgUFkyOgogICAgICAgIGlmICdfX3N0cl9fJyBub3QgaW4ga2xhc3MuX19kaWN0X186CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkBweXRob25fMl91bmljb2RlX2NvbXBhdGlibGUgY2Fubm90IGJlIGFwcGxpZWQgIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0byAlcyBiZWNhdXNlIGl0IGRvZXNuJ3QgZGVmaW5lIF9fc3RyX18oKS4iICUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrbGFzcy5fX25hbWVfXykKICAgICAgICBrbGFzcy5fX3VuaWNvZGVfXyA9IGtsYXNzLl9fc3RyX18KICAgICAgICBrbGFzcy5fX3N0cl9fID0gbGFtYmRhIHNlbGY6IHNlbGYuX191bmljb2RlX18oKS5lbmNvZGUoJ3V0Zi04JykKICAgIHJldHVybiBrbGFzcwoKCiMgQ29tcGxldGUgdGhlIG1vdmVzIGltcGxlbWVudGF0aW9uLgojIFRoaXMgY29kZSBpcyBhdCB0aGUgZW5kIG9mIHRoaXMgbW9kdWxlIHRvIHNwZWVkIHVwIG1vZHVsZSBsb2FkaW5nLgojIFR1cm4gdGhpcyBtb2R1bGUgaW50byBhIHBhY2thZ2UuCl9fcGF0aF9fID0gW10gICMgcmVxdWlyZWQgZm9yIFBFUCAzMDIgYW5kIFBFUCA0NTEKX19wYWNrYWdlX18gPSBfX25hbWVfXyAgIyBzZWUgUEVQIDM2NiBAUmVzZXJ2ZWRBc3NpZ25tZW50CmlmIGdsb2JhbHMoKS5nZXQoIl9fc3BlY19fIikgaXMgbm90IE5vbmU6CiAgICBfX3NwZWNfXy5zdWJtb2R1bGVfc2VhcmNoX2xvY2F0aW9ucyA9IFtdICAjIFBFUCA0NTEgQFVuZGVmaW5lZFZhcmlhYmxlCiMgUmVtb3ZlIG90aGVyIHNpeCBtZXRhIHBhdGggaW1wb3J0ZXJzLCBzaW5jZSB0aGV5IGNhdXNlIHByb2JsZW1zLiBUaGlzIGNhbgojIGhhcHBlbiBpZiBzaXggaXMgcmVtb3ZlZCBmcm9tIHN5cy5tb2R1bGVzIGFuZCB0aGVuIHJlbG9hZGVkLiAoU2V0dXB0b29scyBkb2VzCiMgdGhpcyBmb3Igc29tZSByZWFzb24uKQppZiBzeXMubWV0YV9wYXRoOgogICAgZm9yIGksIGltcG9ydGVyIGluIGVudW1lcmF0ZShzeXMubWV0YV9wYXRoKToKICAgICAgICAjIEhlcmUncyBzb21lIHJlYWwgbmFzdGluZXNzOiBBbm90aGVyICJpbnN0YW5jZSIgb2YgdGhlIHNpeCBtb2R1bGUgbWlnaHQKICAgICAgICAjIGJlIGZsb2F0aW5nIGFyb3VuZC4gVGhlcmVmb3JlLCB3ZSBjYW4ndCB1c2UgaXNpbnN0YW5jZSgpIHRvIGNoZWNrIGZvcgogICAgICAgICMgdGhlIHNpeCBtZXRhIHBhdGggaW1wb3J0ZXIsIHNpbmNlIHRoZSBvdGhlciBzaXggaW5zdGFuY2Ugd2lsbCBoYXZlCiAgICAgICAgIyBpbnNlcnRlZCBhbiBpbXBvcnRlciB3aXRoIGRpZmZlcmVudCBjbGFzcy4KICAgICAgICBpZiAodHlwZShpbXBvcnRlcikuX19uYW1lX18gPT0gIl9TaXhNZXRhUGF0aEltcG9ydGVyIiBhbmQKICAgICAgICAgICAgICAgIGltcG9ydGVyLm5hbWUgPT0gX19uYW1lX18pOgogICAgICAgICAgICBkZWwgc3lzLm1ldGFfcGF0aFtpXQogICAgICAgICAgICBicmVhawogICAgZGVsIGksIGltcG9ydGVyCiMgRmluYWxseSwgYWRkIHRoZSBpbXBvcnRlciB0byB0aGUgbWV0YSBwYXRoIGltcG9ydCBob29rLgpzeXMubWV0YV9wYXRoLmFwcGVuZChfaW1wb3J0ZXIpClBLAQIUAxQAAAAAAPO7K0uPp/FSdwAAAHcAAAATAAAAAAAAAAAAAACAAQAAAABhbnNpYmxlL19faW5pdF9fLnB5UEsBAhQDFAAAAAAA87srS53F8WtIAAAASAAAACAAAAAAAAAAAAAAAIABqAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL19faW5pdF9fLnB5UEsBAhQDFAAAAAAA87srSzQXIAhqHQAAah0AACAAAAAAAAAAAAAAAIABLgEAAGFuc2libGVfbW9kdWxlX2FwYWNoZTJfbW9kdWxlLnB5UEsBAhQDFAAAAAAA87srSzvfOZUwigEAMIoBAB0AAAAAAAAAAAAAAIAB1h4AAGFuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5UEsBAhQDFAAAAAAA87srS7XYBAYlMAAAJTAAAB0AAAAAAAAAAAAAAIABQakBAGFuc2libGUvbW9kdWxlX3V0aWxzL190ZXh0LnB5UEsBAhQDFAAAAAAA87srSyXctH4TEAAAExAAACIAAAAAAAAAAAAAAIABodkBAGFuc2libGUvbW9kdWxlX3V0aWxzL3B5Y29tcGF0MjQucHlQSwECFAMUAAAAAADzuytLGBdy9QERAAABEQAAJAAAAAAAAAAAAAAAgAH06QEAYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19faW5pdF9fLnB5UEsBAhQDFAAAAAAA87srSzjix9GRdQAAkXUAACAAAAAAAAAAAAAAAIABN/sBAGFuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fc2l4LnB5UEsFBgAAAAAIAAgAYwIAAAZxAgAAAA=="""
def invoke_module(module, modlib_path, json_params):
    pythonpath = os.environ.get('PYTHONPATH')
    if pythonpath:
        os.environ['PYTHONPATH'] = ':'.join((modlib_path, pythonpath))
    else:
        os.environ['PYTHONPATH'] = modlib_path
    p = subprocess.Popen(['/usr/bin/python', module], env=os.environ, shell=False, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
    (stdout, stderr) = p.communicate(json_params)
    if not isinstance(stderr, (bytes, unicode)):
        stderr = stderr.read()
    if not isinstance(stdout, (bytes, unicode)):
        stdout = stdout.read()
    if PY3:
        sys.stderr.buffer.write(stderr)
        sys.stdout.buffer.write(stdout)
    else:
        sys.stderr.write(stderr)
        sys.stdout.write(stdout)
    return p.returncode
def debug(command, zipped_mod, json_params):
    basedir = os.path.join(os.path.abspath(os.path.dirname(__file__)), 'debug_dir')
    args_path = os.path.join(basedir, 'args')
    script_path = os.path.join(basedir, 'ansible_module_apache2_module.py')
    if command == 'explode':
        z = zipfile.ZipFile(zipped_mod)
        for filename in z.namelist():
            if filename.startswith('/'):
                raise Exception('Something wrong with this module zip file: should not contain absolute paths')
            dest_filename = os.path.join(basedir, filename)
            if dest_filename.endswith(os.path.sep) and not os.path.exists(dest_filename):
                os.makedirs(dest_filename)
            else:
                directory = os.path.dirname(dest_filename)
                if not os.path.exists(directory):
                    os.makedirs(directory)
                f = open(dest_filename, 'wb')
                f.write(z.read(filename))
                f.close()
        f = open(args_path, 'wb')
        f.write(json_params)
        f.close()
        print('Module expanded into:')
        print('%s' % basedir)
        exitcode = 0
    elif command == 'execute':
        pythonpath = os.environ.get('PYTHONPATH')
        if pythonpath:
            os.environ['PYTHONPATH'] = ':'.join((basedir, pythonpath))
        else:
            os.environ['PYTHONPATH'] = basedir
        p = subprocess.Popen(['/usr/bin/python', script_path, args_path],
                env=os.environ, shell=False, stdout=subprocess.PIPE,
                stderr=subprocess.PIPE, stdin=subprocess.PIPE)
        (stdout, stderr) = p.communicate()
        if not isinstance(stderr, (bytes, unicode)):
            stderr = stderr.read()
        if not isinstance(stdout, (bytes, unicode)):
            stdout = stdout.read()
        if PY3:
            sys.stderr.buffer.write(stderr)
            sys.stdout.buffer.write(stdout)
        else:
            sys.stderr.write(stderr)
            sys.stdout.write(stdout)
        return p.returncode
    elif command == 'excommunicate':
        sys.argv = ['apache2_module', args_path]
        sys.path.insert(0, basedir)
        from ansible_module_apache2_module import main
        main()
        print('WARNING: Module returned to wrapper instead of exiting')
        sys.exit(1)
    else:
        print('WARNING: Unknown debug command.  Doing nothing.')
        exitcode = 0
    return exitcode
if __name__ == '__main__':
    ANSIBALLZ_PARAMS = json.dumps({"ANSIBLE_MODULE_ARGS": json.load(sys.stdin)})
    if PY3:
        ANSIBALLZ_PARAMS = ANSIBALLZ_PARAMS.encode('utf-8')
    try:
        temp_path = tempfile.mkdtemp(prefix='ansible_')
        zipped_mod = os.path.join(temp_path, 'ansible_modlib.zip')
        modlib = open(zipped_mod, 'wb')
        modlib.write(base64.b64decode(ZIPDATA))
        modlib.close()
        if len(sys.argv) == 2:
            exitcode = debug(sys.argv[1], zipped_mod, ANSIBALLZ_PARAMS)
        else:
            z = zipfile.ZipFile(zipped_mod, mode='r')
            module = os.path.join(temp_path, 'ansible_module_apache2_module.py')
            f = open(module, 'wb')
            f.write(z.read('ansible_module_apache2_module.py'))
            f.close()
            z = zipfile.ZipFile(zipped_mod, mode='a')
            sitecustomize = u'import sys\nsys.path.insert(0,"%s")\n' %  zipped_mod
            sitecustomize = sitecustomize.encode('utf-8')
            zinfo = zipfile.ZipInfo()
            zinfo.filename = 'sitecustomize.py'
            zinfo.date_time = ( 2017, 9, 11, 23, 31, 38)
            z.writestr(zinfo, sitecustomize)
            z.close()
            exitcode = invoke_module(module, zipped_mod, ANSIBALLZ_PARAMS)
    finally:
        try:
            shutil.rmtree(temp_path)
        except OSError:
            pass
    sys.exit(exitcode)