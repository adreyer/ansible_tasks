#!/usr/bin/python
# -*- coding: utf-8 -*-
ANSIBALLZ_WRAPPER = True # For test-module script to tell this is a ANSIBALLZ_WRAPPER
import os
import os.path
import sys
import __main__
scriptdir = None
try:
    scriptdir = os.path.dirname(os.path.abspath(__main__.__file__))
except (AttributeError, OSError):
    pass
if scriptdir is not None:
    sys.path = [p for p in sys.path if p != scriptdir]
import base64
import json
import shutil
import zipfile
import tempfile
import subprocess
if sys.version_info < (3,):
    bytes = str
    PY3 = False
else:
    unicode = str
    PY3 = True
try:
    from io import BytesIO as IOStream
except ImportError:
    from StringIO import StringIO as IOStream
ZIPDATA = """UEsDBBQAAAAAANS7K0uPp/FSdwAAAHcAAAATAAAAYW5zaWJsZS9fX2luaXRfXy5weWZyb20gcGtndXRpbCBpbXBvcnQgZXh0ZW5kX3BhdGgKX19wYXRoX189ZXh0ZW5kX3BhdGgoX19wYXRoX18sX19uYW1lX18pCl9fdmVyc2lvbl9fPSIyLjQuMCIKX19hdXRob3JfXz0iQW5zaWJsZSwgSW5jLiIKUEsDBBQAAAAAANS7K0udxfFrSAAAAEgAAAAgAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX19pbml0X18ucHlmcm9tIHBrZ3V0aWwgaW1wb3J0IGV4dGVuZF9wYXRoCl9fcGF0aF9fPWV4dGVuZF9wYXRoKF9fcGF0aF9fLF9fbmFtZV9fKQpQSwMEFAAAAAAA1LsrS95xgUU/8gAAP/IAAB0AAABhbnNpYmxlX21vZHVsZV9iaWdpcF9mYWN0cy5weSMhL3Vzci9iaW4vcHl0aG9uCiMgLSotIGNvZGluZzogdXRmLTggLSotCiMKIyAoYykgMjAxMywgTWF0dCBIaXRlIDxtaGl0ZUBob3RtYWlsLmNvbT4KIwojIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCkFOU0lCTEVfTUVUQURBVEEgPSB7J21ldGFkYXRhX3ZlcnNpb24nOiAnMS4wJywKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJzogWydwcmV2aWV3J10sCiAgICAgICAgICAgICAgICAgICAgJ3N1cHBvcnRlZF9ieSc6ICdjb21tdW5pdHknfQoKCkRPQ1VNRU5UQVRJT04gPSAnJycKLS0tCm1vZHVsZTogYmlnaXBfZmFjdHMKc2hvcnRfZGVzY3JpcHRpb246IENvbGxlY3QgZmFjdHMgZnJvbSBGNSBCSUctSVAgZGV2aWNlcwpkZXNjcmlwdGlvbjoKICAtIENvbGxlY3QgZmFjdHMgZnJvbSBGNSBCSUctSVAgZGV2aWNlcyB2aWEgaUNvbnRyb2wgU09BUCBBUEkKdmVyc2lvbl9hZGRlZDogIjEuNiIKYXV0aG9yOgogIC0gTWF0dCBIaXRlIChAbWhpdGUpCiAgLSBUaW0gUnVwcCAoQGNhcGhyaW0wMDcpCm5vdGVzOgogIC0gUmVxdWlyZXMgQklHLUlQIHNvZnR3YXJlIHZlcnNpb24gPj0gMTEuNAogIC0gRjUgZGV2ZWxvcGVkIG1vZHVsZSAnYmlnc3VkcycgcmVxdWlyZWQgKHNlZSBodHRwOi8vZGV2Y2VudHJhbC5mNS5jb20pCiAgLSBCZXN0IHJ1biBhcyBhIGxvY2FsX2FjdGlvbiBpbiB5b3VyIHBsYXlib29rCiAgLSBUZXN0ZWQgd2l0aCBtYW5hZ2VyIGFuZCBhYm92ZSBhY2NvdW50IHByaXZpbGVnZSBsZXZlbAogIC0gQyhwcm92aXNpb24pIGZhY3RzIHdlcmUgYWRkZWQgaW4gMi4yCnJlcXVpcmVtZW50czoKICAtIGJpZ3N1ZHMKb3B0aW9uczoKICBzZXNzaW9uOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gQklHLUlQIHNlc3Npb24gc3VwcG9ydDsgbWF5IGJlIHVzZWZ1bCB0byBhdm9pZCBjb25jdXJyZW5jeQogICAgICAgIGlzc3VlcyBpbiBjZXJ0YWluIGNpcmN1bXN0YW5jZXMuCiAgICByZXF1aXJlZDogZmFsc2UKICAgIGRlZmF1bHQ6IHRydWUKICAgIGNob2ljZXM6IFtdCiAgICBhbGlhc2VzOiBbXQogIGluY2x1ZGU6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBGYWN0IGNhdGVnb3J5IG9yIGxpc3Qgb2YgY2F0ZWdvcmllcyB0byBjb2xsZWN0CiAgICByZXF1aXJlZDogdHJ1ZQogICAgZGVmYXVsdDogbnVsbAogICAgY2hvaWNlczoKICAgICAgLSBhZGRyZXNzX2NsYXNzCiAgICAgIC0gY2VydGlmaWNhdGUKICAgICAgLSBjbGllbnRfc3NsX3Byb2ZpbGUKICAgICAgLSBkZXZpY2UKICAgICAgLSBkZXZpY2VfZ3JvdXAKICAgICAgLSBpbnRlcmZhY2UKICAgICAgLSBrZXkKICAgICAgLSBub2RlCiAgICAgIC0gcG9vbAogICAgICAtIHByb3Zpc2lvbgogICAgICAtIHJ1bGUKICAgICAgLSBzZWxmX2lwCiAgICAgIC0gc29mdHdhcmUKICAgICAgLSBzeXN0ZW1faW5mbwogICAgICAtIHRyYWZmaWNfZ3JvdXAKICAgICAgLSB0cnVuawogICAgICAtIHZpcnR1YWxfYWRkcmVzcwogICAgICAtIHZpcnR1YWxfc2VydmVyCiAgICAgIC0gdmxhbgogICAgYWxpYXNlczogW10KICBmaWx0ZXI6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBTaGVsbC1zdHlsZSBnbG9iIG1hdGNoaW5nIHN0cmluZyB1c2VkIHRvIGZpbHRlciBmYWN0IGtleXMuIE5vdAogICAgICAgIGFwcGxpY2FibGUgZm9yIHNvZnR3YXJlLCBwcm92aXNpb24sIGFuZCBzeXN0ZW1faW5mbyBmYWN0IGNhdGVnb3JpZXMuCiAgICByZXF1aXJlZDogZmFsc2UKICAgIGRlZmF1bHQ6IG51bGwKICAgIGNob2ljZXM6IFtdCiAgICBhbGlhc2VzOiBbXQpleHRlbmRzX2RvY3VtZW50YXRpb25fZnJhZ21lbnQ6IGY1CicnJwoKRVhBTVBMRVMgPSAnJycKLSBuYW1lOiBDb2xsZWN0IEJJRy1JUCBmYWN0cwogIGJpZ2lwX2ZhY3RzOgogICAgICBzZXJ2ZXI6ICJsYi5teWRvbWFpbi5jb20iCiAgICAgIHVzZXI6ICJhZG1pbiIKICAgICAgcGFzc3dvcmQ6ICJzZWNyZXQiCiAgICAgIGluY2x1ZGU6ICJpbnRlcmZhY2UsdmxhbiIKICBkZWxlZ2F0ZV90bzogbG9jYWxob3N0CicnJwoKdHJ5OgogICAgZnJvbSBzdWRzIGltcG9ydCBNZXRob2ROb3RGb3VuZCwgV2ViRmF1bHQKZXhjZXB0IEltcG9ydEVycm9yOgogICAgYmlnc3Vkc19mb3VuZCA9IEZhbHNlCmVsc2U6CiAgICBiaWdzdWRzX2ZvdW5kID0gVHJ1ZQoKaW1wb3J0IGZubWF0Y2gKaW1wb3J0IHJlCmltcG9ydCB0cmFjZWJhY2sKCgpjbGFzcyBGNShvYmplY3QpOgogICAgIiIiRjUgaUNvbnRyb2wgY2xhc3MuCgogICAgRjUgQklHLUlQIGlDb250cm9sIEFQSSBjbGFzcy4KCiAgICBBdHRyaWJ1dGVzOgogICAgICAgIGFwaTogaUNvbnRyb2wgQVBJIGluc3RhbmNlLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGhvc3QsIHVzZXIsIHBhc3N3b3JkLCBzZXNzaW9uPUZhbHNlLCB2YWxpZGF0ZV9jZXJ0cz1UcnVlLCBwb3J0PTQ0Myk6CiAgICAgICAgc2VsZi5hcGkgPSBiaWdpcF9hcGkoaG9zdCwgdXNlciwgcGFzc3dvcmQsIHZhbGlkYXRlX2NlcnRzLCBwb3J0KQogICAgICAgIGlmIHNlc3Npb246CiAgICAgICAgICAgIHNlbGYuc3RhcnRfc2Vzc2lvbigpCgogICAgZGVmIHN0YXJ0X3Nlc3Npb24oc2VsZik6CiAgICAgICAgc2VsZi5hcGkgPSBzZWxmLmFwaS53aXRoX3Nlc3Npb25faWQoKQoKICAgIGRlZiBnZXRfYXBpKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaQoKICAgIGRlZiBzZXRfcmVjdXJzaXZlX3F1ZXJ5X3N0YXRlKHNlbGYsIHN0YXRlKToKICAgICAgICBzZWxmLmFwaS5TeXN0ZW0uU2Vzc2lvbi5zZXRfcmVjdXJzaXZlX3F1ZXJ5X3N0YXRlKHN0YXRlKQoKICAgIGRlZiBnZXRfcmVjdXJzaXZlX3F1ZXJ5X3N0YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5TeXN0ZW0uU2Vzc2lvbi5nZXRfcmVjdXJzaXZlX3F1ZXJ5X3N0YXRlKCkKCiAgICBkZWYgZW5hYmxlX3JlY3Vyc2l2ZV9xdWVyeV9zdGF0ZShzZWxmKToKICAgICAgICBzZWxmLnNldF9yZWN1cnNpdmVfcXVlcnlfc3RhdGUoJ1NUQVRFX0VOQUJMRUQnKQoKICAgIGRlZiBkaXNhYmxlX3JlY3Vyc2l2ZV9xdWVyeV9zdGF0ZShzZWxmKToKICAgICAgICBzZWxmLnNldF9yZWN1cnNpdmVfcXVlcnlfc3RhdGUoJ1NUQVRFX0RJU0FCTEVEJykKCiAgICBkZWYgc2V0X2FjdGl2ZV9mb2xkZXIoc2VsZiwgZm9sZGVyKToKICAgICAgICBzZWxmLmFwaS5TeXN0ZW0uU2Vzc2lvbi5zZXRfYWN0aXZlX2ZvbGRlcihmb2xkZXI9Zm9sZGVyKQoKICAgIGRlZiBnZXRfYWN0aXZlX2ZvbGRlcihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuU3lzdGVtLlNlc3Npb24uZ2V0X2FjdGl2ZV9mb2xkZXIoKQoKCmNsYXNzIEludGVyZmFjZXMob2JqZWN0KToKICAgICIiIkludGVyZmFjZXMgY2xhc3MuCgogICAgRjUgQklHLUlQIGludGVyZmFjZXMgY2xhc3MuCgogICAgQXR0cmlidXRlczoKICAgICAgICBhcGk6IGlDb250cm9sIEFQSSBpbnN0YW5jZS4KICAgICAgICBpbnRlcmZhY2VzOiBBIGxpc3Qgb2YgQklHLUlQIGludGVyZmFjZSBuYW1lcy4KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhcGksIHJlZ2V4PU5vbmUpOgogICAgICAgIHNlbGYuYXBpID0gYXBpCiAgICAgICAgc2VsZi5pbnRlcmZhY2VzID0gYXBpLk5ldHdvcmtpbmcuSW50ZXJmYWNlcy5nZXRfbGlzdCgpCiAgICAgICAgaWYgcmVnZXg6CiAgICAgICAgICAgIHJlX2ZpbHRlciA9IHJlLmNvbXBpbGUocmVnZXgpCiAgICAgICAgICAgIHNlbGYuaW50ZXJmYWNlcyA9IGZpbHRlcihyZV9maWx0ZXIuc2VhcmNoLCBzZWxmLmludGVyZmFjZXMpCgogICAgZGVmIGdldF9saXN0KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmludGVyZmFjZXMKCiAgICBkZWYgZ2V0X2FjdGl2ZV9tZWRpYShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5JbnRlcmZhY2VzLmdldF9hY3RpdmVfbWVkaWEoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfYWN0dWFsX2Zsb3dfY29udHJvbChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5JbnRlcmZhY2VzLmdldF9hY3R1YWxfZmxvd19jb250cm9sKHNlbGYuaW50ZXJmYWNlcykKCiAgICBkZWYgZ2V0X2J1bmRsZV9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5JbnRlcmZhY2VzLmdldF9idW5kbGVfc3RhdGUoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfZGVzY3JpcHRpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuSW50ZXJmYWNlcy5nZXRfZGVzY3JpcHRpb24oc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfZHVhbF9tZWRpYV9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5JbnRlcmZhY2VzLmdldF9kdWFsX21lZGlhX3N0YXRlKHNlbGYuaW50ZXJmYWNlcykKCiAgICBkZWYgZ2V0X2VuYWJsZWRfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuSW50ZXJmYWNlcy5nZXRfZW5hYmxlZF9zdGF0ZShzZWxmLmludGVyZmFjZXMpCgogICAgZGVmIGdldF9pZl9pbmRleChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5JbnRlcmZhY2VzLmdldF9pZl9pbmRleChzZWxmLmludGVyZmFjZXMpCgogICAgZGVmIGdldF9sZWFybmluZ19tb2RlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLkludGVyZmFjZXMuZ2V0X2xlYXJuaW5nX21vZGUoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfbGxkcF9hZG1pbl9zdGF0dXMoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuSW50ZXJmYWNlcy5nZXRfbGxkcF9hZG1pbl9zdGF0dXMoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfbGxkcF90bHZtYXAoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuSW50ZXJmYWNlcy5nZXRfbGxkcF90bHZtYXAoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfbWFjX2FkZHJlc3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuSW50ZXJmYWNlcy5nZXRfbWFjX2FkZHJlc3Moc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfbWVkaWEoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuSW50ZXJmYWNlcy5nZXRfbWVkaWEoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfbWVkaWFfb3B0aW9uKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLkludGVyZmFjZXMuZ2V0X21lZGlhX29wdGlvbihzZWxmLmludGVyZmFjZXMpCgogICAgZGVmIGdldF9tZWRpYV9vcHRpb25fc2ZwKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLkludGVyZmFjZXMuZ2V0X21lZGlhX29wdGlvbl9zZnAoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfbWVkaWFfc2ZwKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLkludGVyZmFjZXMuZ2V0X21lZGlhX3NmcChzZWxmLmludGVyZmFjZXMpCgogICAgZGVmIGdldF9tZWRpYV9zcGVlZChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5JbnRlcmZhY2VzLmdldF9tZWRpYV9zcGVlZChzZWxmLmludGVyZmFjZXMpCgogICAgZGVmIGdldF9tZWRpYV9zdGF0dXMoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuSW50ZXJmYWNlcy5nZXRfbWVkaWFfc3RhdHVzKHNlbGYuaW50ZXJmYWNlcykKCiAgICBkZWYgZ2V0X210dShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5JbnRlcmZhY2VzLmdldF9tdHUoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfcGh5X21hc3Rlcl9zbGF2ZV9tb2RlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLkludGVyZmFjZXMuZ2V0X3BoeV9tYXN0ZXJfc2xhdmVfbW9kZShzZWxmLmludGVyZmFjZXMpCgogICAgZGVmIGdldF9wcmVmZXJfc2ZwX3N0YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLkludGVyZmFjZXMuZ2V0X3ByZWZlcl9zZnBfc3RhdGUoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfZmxvd19jb250cm9sKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLkludGVyZmFjZXMuZ2V0X3JlcXVlc3RlZF9mbG93X2NvbnRyb2woc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfc2Zsb3dfcG9sbF9pbnRlcnZhbChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5JbnRlcmZhY2VzLmdldF9zZmxvd19wb2xsX2ludGVydmFsKHNlbGYuaW50ZXJmYWNlcykKCiAgICBkZWYgZ2V0X3NmbG93X3BvbGxfaW50ZXJ2YWxfZ2xvYmFsKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLkludGVyZmFjZXMuZ2V0X3NmbG93X3BvbGxfaW50ZXJ2YWxfZ2xvYmFsKHNlbGYuaW50ZXJmYWNlcykKCiAgICBkZWYgZ2V0X3NmcF9tZWRpYV9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5JbnRlcmZhY2VzLmdldF9zZnBfbWVkaWFfc3RhdGUoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfc3RwX2FjdGl2ZV9lZGdlX3BvcnRfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuSW50ZXJmYWNlcy5nZXRfc3RwX2FjdGl2ZV9lZGdlX3BvcnRfc3RhdGUoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfc3RwX2VuYWJsZWRfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuSW50ZXJmYWNlcy5nZXRfc3RwX2VuYWJsZWRfc3RhdGUoc2VsZi5pbnRlcmZhY2VzKQoKICAgIGRlZiBnZXRfc3RwX2xpbmtfdHlwZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5JbnRlcmZhY2VzLmdldF9zdHBfbGlua190eXBlKHNlbGYuaW50ZXJmYWNlcykKCiAgICBkZWYgZ2V0X3N0cF9wcm90b2NvbF9kZXRlY3Rpb25fcmVzZXRfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuSW50ZXJmYWNlcy5nZXRfc3RwX3Byb3RvY29sX2RldGVjdGlvbl9yZXNldF9zdGF0ZShzZWxmLmludGVyZmFjZXMpCgoKY2xhc3MgU2VsZklQcyhvYmplY3QpOgogICAgIiIiU2VsZiBJUHMgY2xhc3MuCgogICAgRjUgQklHLUlQIFNlbGYgSVBzIGNsYXNzLgoKICAgIEF0dHJpYnV0ZXM6CiAgICAgICAgYXBpOiBpQ29udHJvbCBBUEkgaW5zdGFuY2UuCiAgICAgICAgc2VsZl9pcHM6IExpc3Qgb2Ygc2VsZiBJUHMuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgYXBpLCByZWdleD1Ob25lKToKICAgICAgICBzZWxmLmFwaSA9IGFwaQogICAgICAgIHNlbGYuc2VsZl9pcHMgPSBhcGkuTmV0d29ya2luZy5TZWxmSVBWMi5nZXRfbGlzdCgpCiAgICAgICAgaWYgcmVnZXg6CiAgICAgICAgICAgIHJlX2ZpbHRlciA9IHJlLmNvbXBpbGUocmVnZXgpCiAgICAgICAgICAgIHNlbGYuc2VsZl9pcHMgPSBmaWx0ZXIocmVfZmlsdGVyLnNlYXJjaCwgc2VsZi5zZWxmX2lwcykKCiAgICBkZWYgZ2V0X2xpc3Qoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuc2VsZl9pcHMKCiAgICBkZWYgZ2V0X2FkZHJlc3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuU2VsZklQVjIuZ2V0X2FkZHJlc3Moc2VsZi5zZWxmX2lwcykKCiAgICBkZWYgZ2V0X2FsbG93X2FjY2Vzc19saXN0KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLlNlbGZJUFYyLmdldF9hbGxvd19hY2Nlc3NfbGlzdChzZWxmLnNlbGZfaXBzKQoKICAgIGRlZiBnZXRfZGVzY3JpcHRpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuU2VsZklQVjIuZ2V0X2Rlc2NyaXB0aW9uKHNlbGYuc2VsZl9pcHMpCgogICAgZGVmIGdldF9lbmZvcmNlZF9maXJld2FsbF9wb2xpY3koc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuU2VsZklQVjIuZ2V0X2VuZm9yY2VkX2ZpcmV3YWxsX3BvbGljeShzZWxmLnNlbGZfaXBzKQoKICAgIGRlZiBnZXRfZmxvYXRpbmdfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuU2VsZklQVjIuZ2V0X2Zsb2F0aW5nX3N0YXRlKHNlbGYuc2VsZl9pcHMpCgogICAgZGVmIGdldF9md19ydWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLlNlbGZJUFYyLmdldF9md19ydWxlKHNlbGYuc2VsZl9pcHMpCgogICAgZGVmIGdldF9uZXRtYXNrKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLlNlbGZJUFYyLmdldF9uZXRtYXNrKHNlbGYuc2VsZl9pcHMpCgogICAgZGVmIGdldF9zdGFnZWRfZmlyZXdhbGxfcG9saWN5KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLlNlbGZJUFYyLmdldF9zdGFnZWRfZmlyZXdhbGxfcG9saWN5KHNlbGYuc2VsZl9pcHMpCgogICAgZGVmIGdldF90cmFmZmljX2dyb3VwKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLlNlbGZJUFYyLmdldF90cmFmZmljX2dyb3VwKHNlbGYuc2VsZl9pcHMpCgogICAgZGVmIGdldF92bGFuKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLlNlbGZJUFYyLmdldF92bGFuKHNlbGYuc2VsZl9pcHMpCgogICAgZGVmIGdldF9pc190cmFmZmljX2dyb3VwX2luaGVyaXRlZChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5TZWxmSVBWMi5pc190cmFmZmljX2dyb3VwX2luaGVyaXRlZChzZWxmLnNlbGZfaXBzKQoKCmNsYXNzIFRydW5rcyhvYmplY3QpOgogICAgIiIiVHJ1bmtzIGNsYXNzLgoKICAgIEY1IEJJRy1JUCB0cnVua3MgY2xhc3MuCgogICAgQXR0cmlidXRlczoKICAgICAgICBhcGk6IGlDb250cm9sIEFQSSBpbnN0YW5jZS4KICAgICAgICB0cnVua3M6IExpc3Qgb2YgdHJ1bmtzLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwaSwgcmVnZXg9Tm9uZSk6CiAgICAgICAgc2VsZi5hcGkgPSBhcGkKICAgICAgICBzZWxmLnRydW5rcyA9IGFwaS5OZXR3b3JraW5nLlRydW5rLmdldF9saXN0KCkKICAgICAgICBpZiByZWdleDoKICAgICAgICAgICAgcmVfZmlsdGVyID0gcmUuY29tcGlsZShyZWdleCkKICAgICAgICAgICAgc2VsZi50cnVua3MgPSBmaWx0ZXIocmVfZmlsdGVyLnNlYXJjaCwgc2VsZi50cnVua3MpCgogICAgZGVmIGdldF9saXN0KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnRydW5rcwoKICAgIGRlZiBnZXRfYWN0aXZlX2xhY3Bfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVHJ1bmsuZ2V0X2FjdGl2ZV9sYWNwX3N0YXRlKHNlbGYudHJ1bmtzKQoKICAgIGRlZiBnZXRfY29uZmlndXJlZF9tZW1iZXJfY291bnQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVHJ1bmsuZ2V0X2NvbmZpZ3VyZWRfbWVtYmVyX2NvdW50KHNlbGYudHJ1bmtzKQoKICAgIGRlZiBnZXRfZGVzY3JpcHRpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVHJ1bmsuZ2V0X2Rlc2NyaXB0aW9uKHNlbGYudHJ1bmtzKQoKICAgIGRlZiBnZXRfZGlzdHJpYnV0aW9uX2hhc2hfb3B0aW9uKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLlRydW5rLmdldF9kaXN0cmlidXRpb25faGFzaF9vcHRpb24oc2VsZi50cnVua3MpCgogICAgZGVmIGdldF9pbnRlcmZhY2Uoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVHJ1bmsuZ2V0X2ludGVyZmFjZShzZWxmLnRydW5rcykKCiAgICBkZWYgZ2V0X2xhY3BfZW5hYmxlZF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5UcnVuay5nZXRfbGFjcF9lbmFibGVkX3N0YXRlKHNlbGYudHJ1bmtzKQoKICAgIGRlZiBnZXRfbGFjcF90aW1lb3V0X29wdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5UcnVuay5nZXRfbGFjcF90aW1lb3V0X29wdGlvbihzZWxmLnRydW5rcykKCiAgICBkZWYgZ2V0X2xpbmtfc2VsZWN0aW9uX3BvbGljeShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5UcnVuay5nZXRfbGlua19zZWxlY3Rpb25fcG9saWN5KHNlbGYudHJ1bmtzKQoKICAgIGRlZiBnZXRfbWVkaWFfc3BlZWQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVHJ1bmsuZ2V0X21lZGlhX3NwZWVkKHNlbGYudHJ1bmtzKQoKICAgIGRlZiBnZXRfbWVkaWFfc3RhdHVzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLlRydW5rLmdldF9tZWRpYV9zdGF0dXMoc2VsZi50cnVua3MpCgogICAgZGVmIGdldF9vcGVyYXRpb25hbF9tZW1iZXJfY291bnQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVHJ1bmsuZ2V0X29wZXJhdGlvbmFsX21lbWJlcl9jb3VudChzZWxmLnRydW5rcykKCiAgICBkZWYgZ2V0X3N0cF9lbmFibGVkX3N0YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLlRydW5rLmdldF9zdHBfZW5hYmxlZF9zdGF0ZShzZWxmLnRydW5rcykKCiAgICBkZWYgZ2V0X3N0cF9wcm90b2NvbF9kZXRlY3Rpb25fcmVzZXRfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVHJ1bmsuZ2V0X3N0cF9wcm90b2NvbF9kZXRlY3Rpb25fcmVzZXRfc3RhdGUoc2VsZi50cnVua3MpCgoKY2xhc3MgVmxhbnMob2JqZWN0KToKICAgICIiIlZsYW5zIGNsYXNzLgoKICAgIEY1IEJJRy1JUCBWbGFucyBjbGFzcy4KCiAgICBBdHRyaWJ1dGVzOgogICAgICAgIGFwaTogaUNvbnRyb2wgQVBJIGluc3RhbmNlLgogICAgICAgIHZsYW5zOiBMaXN0IG9mIFZMQU5zLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwaSwgcmVnZXg9Tm9uZSk6CiAgICAgICAgc2VsZi5hcGkgPSBhcGkKICAgICAgICBzZWxmLnZsYW5zID0gYXBpLk5ldHdvcmtpbmcuVkxBTi5nZXRfbGlzdCgpCiAgICAgICAgaWYgcmVnZXg6CiAgICAgICAgICAgIHJlX2ZpbHRlciA9IHJlLmNvbXBpbGUocmVnZXgpCiAgICAgICAgICAgIHNlbGYudmxhbnMgPSBmaWx0ZXIocmVfZmlsdGVyLnNlYXJjaCwgc2VsZi52bGFucykKCiAgICBkZWYgZ2V0X2xpc3Qoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYudmxhbnMKCiAgICBkZWYgZ2V0X2F1dG9fbGFzdGhvcChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5WTEFOLmdldF9hdXRvX2xhc3Rob3Aoc2VsZi52bGFucykKCiAgICBkZWYgZ2V0X2NtcF9oYXNoX2FsZ29yaXRobShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5WTEFOLmdldF9jbXBfaGFzaF9hbGdvcml0aG0oc2VsZi52bGFucykKCiAgICBkZWYgZ2V0X2Rlc2NyaXB0aW9uKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLlZMQU4uZ2V0X2Rlc2NyaXB0aW9uKHNlbGYudmxhbnMpCgogICAgZGVmIGdldF9keW5hbWljX2ZvcndhcmRpbmcoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVkxBTi5nZXRfZHluYW1pY19mb3J3YXJkaW5nKHNlbGYudmxhbnMpCgogICAgZGVmIGdldF9mYWlsc2FmZV9hY3Rpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVkxBTi5nZXRfZmFpbHNhZmVfYWN0aW9uKHNlbGYudmxhbnMpCgogICAgZGVmIGdldF9mYWlsc2FmZV9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5WTEFOLmdldF9mYWlsc2FmZV9zdGF0ZShzZWxmLnZsYW5zKQoKICAgIGRlZiBnZXRfZmFpbHNhZmVfdGltZW91dChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5WTEFOLmdldF9mYWlsc2FmZV90aW1lb3V0KHNlbGYudmxhbnMpCgogICAgZGVmIGdldF9pZl9pbmRleChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5WTEFOLmdldF9pZl9pbmRleChzZWxmLnZsYW5zKQoKICAgIGRlZiBnZXRfbGVhcm5pbmdfbW9kZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5WTEFOLmdldF9sZWFybmluZ19tb2RlKHNlbGYudmxhbnMpCgogICAgZGVmIGdldF9tYWNfbWFzcXVlcmFkZV9hZGRyZXNzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5OZXR3b3JraW5nLlZMQU4uZ2V0X21hY19tYXNxdWVyYWRlX2FkZHJlc3Moc2VsZi52bGFucykKCiAgICBkZWYgZ2V0X21lbWJlcihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5WTEFOLmdldF9tZW1iZXIoc2VsZi52bGFucykKCiAgICBkZWYgZ2V0X210dShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5WTEFOLmdldF9tdHUoc2VsZi52bGFucykKCiAgICBkZWYgZ2V0X3NmbG93X3BvbGxfaW50ZXJ2YWwoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVkxBTi5nZXRfc2Zsb3dfcG9sbF9pbnRlcnZhbChzZWxmLnZsYW5zKQoKICAgIGRlZiBnZXRfc2Zsb3dfcG9sbF9pbnRlcnZhbF9nbG9iYWwoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVkxBTi5nZXRfc2Zsb3dfcG9sbF9pbnRlcnZhbF9nbG9iYWwoc2VsZi52bGFucykKCiAgICBkZWYgZ2V0X3NmbG93X3NhbXBsaW5nX3JhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVkxBTi5nZXRfc2Zsb3dfc2FtcGxpbmdfcmF0ZShzZWxmLnZsYW5zKQoKICAgIGRlZiBnZXRfc2Zsb3dfc2FtcGxpbmdfcmF0ZV9nbG9iYWwoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVkxBTi5nZXRfc2Zsb3dfc2FtcGxpbmdfcmF0ZV9nbG9iYWwoc2VsZi52bGFucykKCiAgICBkZWYgZ2V0X3NvdXJjZV9jaGVja19zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5WTEFOLmdldF9zb3VyY2VfY2hlY2tfc3RhdGUoc2VsZi52bGFucykKCiAgICBkZWYgZ2V0X3RydWVfbWFjX2FkZHJlc3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk5ldHdvcmtpbmcuVkxBTi5nZXRfdHJ1ZV9tYWNfYWRkcmVzcyhzZWxmLnZsYW5zKQoKICAgIGRlZiBnZXRfdmxhbl9pZChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTmV0d29ya2luZy5WTEFOLmdldF92bGFuX2lkKHNlbGYudmxhbnMpCgoKY2xhc3MgU29mdHdhcmUob2JqZWN0KToKICAgICIiIlNvZnR3YXJlIGNsYXNzLgoKICAgIEY1IEJJRy1JUCBzb2Z0d2FyZSBjbGFzcy4KCiAgICBBdHRyaWJ1dGVzOgogICAgICAgIGFwaTogaUNvbnRyb2wgQVBJIGluc3RhbmNlLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwaSk6CiAgICAgICAgc2VsZi5hcGkgPSBhcGkKCiAgICBkZWYgZ2V0X2FsbF9zb2Z0d2FyZV9zdGF0dXMoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLlN5c3RlbS5Tb2Z0d2FyZU1hbmFnZW1lbnQuZ2V0X2FsbF9zb2Z0d2FyZV9zdGF0dXMoKQoKCmNsYXNzIFZpcnR1YWxTZXJ2ZXJzKG9iamVjdCk6CiAgICAiIiJWaXJ0dWFsIHNlcnZlcnMgY2xhc3MuCgogICAgRjUgQklHLUlQIHZpcnR1YWwgc2VydmVycyBjbGFzcy4KCiAgICBBdHRyaWJ1dGVzOgogICAgICAgIGFwaTogaUNvbnRyb2wgQVBJIGluc3RhbmNlLgogICAgICAgIHZpcnR1YWxfc2VydmVyczogTGlzdCBvZiB2aXJ0dWFsIHNlcnZlcnMuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgYXBpLCByZWdleD1Ob25lKToKICAgICAgICBzZWxmLmFwaSA9IGFwaQogICAgICAgIHNlbGYudmlydHVhbF9zZXJ2ZXJzID0gYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfbGlzdCgpCiAgICAgICAgaWYgcmVnZXg6CiAgICAgICAgICAgIHJlX2ZpbHRlciA9IHJlLmNvbXBpbGUocmVnZXgpCiAgICAgICAgICAgIHNlbGYudmlydHVhbF9zZXJ2ZXJzID0gZmlsdGVyKHJlX2ZpbHRlci5zZWFyY2gsIHNlbGYudmlydHVhbF9zZXJ2ZXJzKQoKICAgIGRlZiBnZXRfbGlzdChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi52aXJ0dWFsX3NlcnZlcnMKCiAgICBkZWYgZ2V0X2FjdHVhbF9oYXJkd2FyZV9hY2NlbGVyYXRpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfYWN0dWFsX2hhcmR3YXJlX2FjY2VsZXJhdGlvbihzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X2F1dGhlbnRpY2F0aW9uX3Byb2ZpbGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfYXV0aGVudGljYXRpb25fcHJvZmlsZShzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X2F1dG9fbGFzdGhvcChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9hdXRvX2xhc3Rob3Aoc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9id19jb250cm9sbGVyX3BvbGljeShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9id19jb250cm9sbGVyX3BvbGljeShzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X2Nsb25lX3Bvb2woc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfY2xvbmVfcG9vbChzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X2NtcF9lbmFibGVfbW9kZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9jbXBfZW5hYmxlX21vZGUoc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9jb25uZWN0aW9uX2xpbWl0KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X2Nvbm5lY3Rpb25fbGltaXQoc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9jb25uZWN0aW9uX21pcnJvcl9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9jb25uZWN0aW9uX21pcnJvcl9zdGF0ZShzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X2RlZmF1bHRfcG9vbF9uYW1lKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X2RlZmF1bHRfcG9vbF9uYW1lKHNlbGYudmlydHVhbF9zZXJ2ZXJzKQoKICAgIGRlZiBnZXRfZGVzY3JpcHRpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfZGVzY3JpcHRpb24oc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9kZXN0aW5hdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9kZXN0aW5hdGlvbl92MihzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X2VuYWJsZWRfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfZW5hYmxlZF9zdGF0ZShzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X2VuZm9yY2VkX2ZpcmV3YWxsX3BvbGljeShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9lbmZvcmNlZF9maXJld2FsbF9wb2xpY3koc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9mYWxsYmFja19wZXJzaXN0ZW5jZV9wcm9maWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X2ZhbGxiYWNrX3BlcnNpc3RlbmNlX3Byb2ZpbGUoc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9md19ydWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X2Z3X3J1bGUoc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9ndG1fc2NvcmUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfZ3RtX3Njb3JlKHNlbGYudmlydHVhbF9zZXJ2ZXJzKQoKICAgIGRlZiBnZXRfbGFzdF9ob3BfcG9vbChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9sYXN0X2hvcF9wb29sKHNlbGYudmlydHVhbF9zZXJ2ZXJzKQoKICAgIGRlZiBnZXRfbmF0NjRfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfbmF0NjRfc3RhdGUoc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9vYmplY3Rfc3RhdHVzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X29iamVjdF9zdGF0dXMoc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9wZXJzaXN0ZW5jZV9wcm9maWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X3BlcnNpc3RlbmNlX3Byb2ZpbGUoc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9wcm9maWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X3Byb2ZpbGUoc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9wcm90b2NvbChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9wcm90b2NvbChzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3JhdGVfY2xhc3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfcmF0ZV9jbGFzcyhzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3JhdGVfbGltaXQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfcmF0ZV9saW1pdChzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3JhdGVfbGltaXRfZGVzdGluYXRpb25fbWFzayhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9yYXRlX2xpbWl0X2Rlc3RpbmF0aW9uX21hc2soc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9yYXRlX2xpbWl0X21vZGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfcmF0ZV9saW1pdF9tb2RlKHNlbGYudmlydHVhbF9zZXJ2ZXJzKQoKICAgIGRlZiBnZXRfcmF0ZV9saW1pdF9zb3VyY2VfbWFzayhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9yYXRlX2xpbWl0X3NvdXJjZV9tYXNrKHNlbGYudmlydHVhbF9zZXJ2ZXJzKQoKICAgIGRlZiBnZXRfcmVsYXRlZF9ydWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X3JlbGF0ZWRfcnVsZShzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3J1bGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfcnVsZShzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3NlY3VyaXR5X2xvZ19wcm9maWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X3NlY3VyaXR5X2xvZ19wcm9maWxlKHNlbGYudmlydHVhbF9zZXJ2ZXJzKQoKICAgIGRlZiBnZXRfc25hdF9wb29sKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X3NuYXRfcG9vbChzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3NuYXRfdHlwZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9zbmF0X3R5cGUoc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF9zb3VyY2VfYWRkcmVzcyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9zb3VyY2VfYWRkcmVzcyhzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3NvdXJjZV9hZGRyZXNzX3RyYW5zbGF0aW9uX2xzbl9wb29sKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X3NvdXJjZV9hZGRyZXNzX3RyYW5zbGF0aW9uX2xzbl9wb29sKHNlbGYudmlydHVhbF9zZXJ2ZXJzKQoKICAgIGRlZiBnZXRfc291cmNlX2FkZHJlc3NfdHJhbnNsYXRpb25fc25hdF9wb29sKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X3NvdXJjZV9hZGRyZXNzX3RyYW5zbGF0aW9uX3NuYXRfcG9vbChzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3NvdXJjZV9hZGRyZXNzX3RyYW5zbGF0aW9uX3R5cGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfc291cmNlX2FkZHJlc3NfdHJhbnNsYXRpb25fdHlwZShzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3NvdXJjZV9wb3J0X2JlaGF2aW9yKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X3NvdXJjZV9wb3J0X2JlaGF2aW9yKHNlbGYudmlydHVhbF9zZXJ2ZXJzKQoKICAgIGRlZiBnZXRfc3RhZ2VkX2ZpcmV3YWxsX3BvbGljeShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF9zdGFnZWRfZmlyZXdhbGxfcG9saWN5KHNlbGYudmlydHVhbF9zZXJ2ZXJzKQoKICAgIGRlZiBnZXRfdHJhbnNsYXRlX2FkZHJlc3Nfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfdHJhbnNsYXRlX2FkZHJlc3Nfc3RhdGUoc2VsZi52aXJ0dWFsX3NlcnZlcnMpCgogICAgZGVmIGdldF90cmFuc2xhdGVfcG9ydF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsU2VydmVyLmdldF90cmFuc2xhdGVfcG9ydF9zdGF0ZShzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3R5cGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfdHlwZShzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3ZsYW4oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbFNlcnZlci5nZXRfdmxhbihzZWxmLnZpcnR1YWxfc2VydmVycykKCiAgICBkZWYgZ2V0X3dpbGRtYXNrKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxTZXJ2ZXIuZ2V0X3dpbGRtYXNrKHNlbGYudmlydHVhbF9zZXJ2ZXJzKQoKCmNsYXNzIFBvb2xzKG9iamVjdCk6CiAgICAiIiJQb29scyBjbGFzcy4KCiAgICBGNSBCSUctSVAgcG9vbHMgY2xhc3MuCgogICAgQXR0cmlidXRlczoKICAgICAgICBhcGk6IGlDb250cm9sIEFQSSBpbnN0YW5jZS4KICAgICAgICBwb29sX25hbWVzOiBMaXN0IG9mIHBvb2wgbmFtZXMuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgYXBpLCByZWdleD1Ob25lKToKICAgICAgICBzZWxmLmFwaSA9IGFwaQogICAgICAgIHNlbGYucG9vbF9uYW1lcyA9IGFwaS5Mb2NhbExCLlBvb2wuZ2V0X2xpc3QoKQogICAgICAgIGlmIHJlZ2V4OgogICAgICAgICAgICByZV9maWx0ZXIgPSByZS5jb21waWxlKHJlZ2V4KQogICAgICAgICAgICBzZWxmLnBvb2xfbmFtZXMgPSBmaWx0ZXIocmVfZmlsdGVyLnNlYXJjaCwgc2VsZi5wb29sX25hbWVzKQoKICAgIGRlZiBnZXRfbGlzdChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5wb29sX25hbWVzCgogICAgZGVmIGdldF9hY3Rpb25fb25fc2VydmljZV9kb3duKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X2FjdGlvbl9vbl9zZXJ2aWNlX2Rvd24oc2VsZi5wb29sX25hbWVzKQoKICAgIGRlZiBnZXRfYWN0aXZlX21lbWJlcl9jb3VudChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qb29sLmdldF9hY3RpdmVfbWVtYmVyX2NvdW50KHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X2FnZ3JlZ2F0ZV9keW5hbWljX3JhdGlvKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X2FnZ3JlZ2F0ZV9keW5hbWljX3JhdGlvKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X2FsbG93X25hdF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qb29sLmdldF9hbGxvd19uYXRfc3RhdGUoc2VsZi5wb29sX25hbWVzKQoKICAgIGRlZiBnZXRfYWxsb3dfc25hdF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qb29sLmdldF9hbGxvd19zbmF0X3N0YXRlKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X2NsaWVudF9pcF90b3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUG9vbC5nZXRfY2xpZW50X2lwX3RvcyhzZWxmLnBvb2xfbmFtZXMpCgogICAgZGVmIGdldF9jbGllbnRfbGlua19xb3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUG9vbC5nZXRfY2xpZW50X2xpbmtfcW9zKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X2Rlc2NyaXB0aW9uKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X2Rlc2NyaXB0aW9uKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X2dhdGV3YXlfZmFpbHNhZmVfZGV2aWNlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X2dhdGV3YXlfZmFpbHNhZmVfZGV2aWNlKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X2lnbm9yZV9wZXJzaXN0ZWRfd2VpZ2h0X3N0YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X2lnbm9yZV9wZXJzaXN0ZWRfd2VpZ2h0X3N0YXRlKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X2xiX21ldGhvZChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qb29sLmdldF9sYl9tZXRob2Qoc2VsZi5wb29sX25hbWVzKQoKICAgIGRlZiBnZXRfbWVtYmVyKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X21lbWJlcl92MihzZWxmLnBvb2xfbmFtZXMpCgogICAgZGVmIGdldF9taW5pbXVtX2FjdGl2ZV9tZW1iZXIoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUG9vbC5nZXRfbWluaW11bV9hY3RpdmVfbWVtYmVyKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X21pbmltdW1fdXBfbWVtYmVyKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X21pbmltdW1fdXBfbWVtYmVyKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X21pbmltdW1fdXBfbWVtYmVyX2FjdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qb29sLmdldF9taW5pbXVtX3VwX21lbWJlcl9hY3Rpb24oc2VsZi5wb29sX25hbWVzKQoKICAgIGRlZiBnZXRfbWluaW11bV91cF9tZW1iZXJfZW5hYmxlZF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qb29sLmdldF9taW5pbXVtX3VwX21lbWJlcl9lbmFibGVkX3N0YXRlKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X21vbml0b3JfYXNzb2NpYXRpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUG9vbC5nZXRfbW9uaXRvcl9hc3NvY2lhdGlvbihzZWxmLnBvb2xfbmFtZXMpCgogICAgZGVmIGdldF9tb25pdG9yX2luc3RhbmNlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X21vbml0b3JfaW5zdGFuY2Uoc2VsZi5wb29sX25hbWVzKQoKICAgIGRlZiBnZXRfb2JqZWN0X3N0YXR1cyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qb29sLmdldF9vYmplY3Rfc3RhdHVzKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X3Byb2ZpbGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUG9vbC5nZXRfcHJvZmlsZShzZWxmLnBvb2xfbmFtZXMpCgogICAgZGVmIGdldF9xdWV1ZV9kZXB0aF9saW1pdChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qb29sLmdldF9xdWV1ZV9kZXB0aF9saW1pdChzZWxmLnBvb2xfbmFtZXMpCgogICAgZGVmIGdldF9xdWV1ZV9vbl9jb25uZWN0aW9uX2xpbWl0X3N0YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X3F1ZXVlX29uX2Nvbm5lY3Rpb25fbGltaXRfc3RhdGUoc2VsZi5wb29sX25hbWVzKQoKICAgIGRlZiBnZXRfcXVldWVfdGltZV9saW1pdChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qb29sLmdldF9xdWV1ZV90aW1lX2xpbWl0KHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X3Jlc2VsZWN0X3RyaWVzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X3Jlc2VsZWN0X3RyaWVzKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X3NlcnZlcl9pcF90b3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUG9vbC5nZXRfc2VydmVyX2lwX3RvcyhzZWxmLnBvb2xfbmFtZXMpCgogICAgZGVmIGdldF9zZXJ2ZXJfbGlua19xb3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUG9vbC5nZXRfc2VydmVyX2xpbmtfcW9zKHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X3NpbXBsZV90aW1lb3V0KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X3NpbXBsZV90aW1lb3V0KHNlbGYucG9vbF9uYW1lcykKCiAgICBkZWYgZ2V0X3Nsb3dfcmFtcF90aW1lKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlBvb2wuZ2V0X3Nsb3dfcmFtcF90aW1lKHNlbGYucG9vbF9uYW1lcykKCgpjbGFzcyBEZXZpY2VzKG9iamVjdCk6CiAgICAiIiJEZXZpY2VzIGNsYXNzLgoKICAgIEY1IEJJRy1JUCBkZXZpY2VzIGNsYXNzLgoKICAgIEF0dHJpYnV0ZXM6CiAgICAgICAgYXBpOiBpQ29udHJvbCBBUEkgaW5zdGFuY2UuCiAgICAgICAgZGV2aWNlczogTGlzdCBvZiBkZXZpY2VzLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwaSwgcmVnZXg9Tm9uZSk6CiAgICAgICAgc2VsZi5hcGkgPSBhcGkKICAgICAgICBzZWxmLmRldmljZXMgPSBhcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X2xpc3QoKQogICAgICAgIGlmIHJlZ2V4OgogICAgICAgICAgICByZV9maWx0ZXIgPSByZS5jb21waWxlKHJlZ2V4KQogICAgICAgICAgICBzZWxmLmRldmljZXMgPSBmaWx0ZXIocmVfZmlsdGVyLnNlYXJjaCwgc2VsZi5kZXZpY2VzKQoKICAgIGRlZiBnZXRfbGlzdChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5kZXZpY2VzCgogICAgZGVmIGdldF9hY3RpdmVfbW9kdWxlcyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X2FjdGl2ZV9tb2R1bGVzKHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X2Jhc2VfbWFjX2FkZHJlc3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk1hbmFnZW1lbnQuRGV2aWNlLmdldF9iYXNlX21hY19hZGRyZXNzKHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X2JsYWRlX2FkZHJlc3NlcyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X2JsYWRlX2FkZHJlc3NlcyhzZWxmLmRldmljZXMpCgogICAgZGVmIGdldF9idWlsZChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X2J1aWxkKHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X2NoYXNzaXNfaWQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk1hbmFnZW1lbnQuRGV2aWNlLmdldF9jaGFzc2lzX2lkKHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X2NoYXNzaXNfdHlwZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X2NoYXNzaXNfdHlwZShzZWxmLmRldmljZXMpCgogICAgZGVmIGdldF9jb21tZW50KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZS5nZXRfY29tbWVudChzZWxmLmRldmljZXMpCgogICAgZGVmIGdldF9jb25maWdzeW5jX2FkZHJlc3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk1hbmFnZW1lbnQuRGV2aWNlLmdldF9jb25maWdzeW5jX2FkZHJlc3Moc2VsZi5kZXZpY2VzKQoKICAgIGRlZiBnZXRfY29udGFjdChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X2NvbnRhY3Qoc2VsZi5kZXZpY2VzKQoKICAgIGRlZiBnZXRfZGVzY3JpcHRpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk1hbmFnZW1lbnQuRGV2aWNlLmdldF9kZXNjcmlwdGlvbihzZWxmLmRldmljZXMpCgogICAgZGVmIGdldF9lZGl0aW9uKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZS5nZXRfZWRpdGlvbihzZWxmLmRldmljZXMpCgogICAgZGVmIGdldF9mYWlsb3Zlcl9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X2ZhaWxvdmVyX3N0YXRlKHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X2xvY2FsX2RldmljZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X2xvY2FsX2RldmljZSgpCgogICAgZGVmIGdldF9ob3N0bmFtZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X2hvc3RuYW1lKHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X2luYWN0aXZlX21vZHVsZXMoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk1hbmFnZW1lbnQuRGV2aWNlLmdldF9pbmFjdGl2ZV9tb2R1bGVzKHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X2xvY2F0aW9uKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZS5nZXRfbG9jYXRpb24oc2VsZi5kZXZpY2VzKQoKICAgIGRlZiBnZXRfbWFuYWdlbWVudF9hZGRyZXNzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZS5nZXRfbWFuYWdlbWVudF9hZGRyZXNzKHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X21hcmtldGluZ19uYW1lKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZS5nZXRfbWFya2V0aW5nX25hbWUoc2VsZi5kZXZpY2VzKQoKICAgIGRlZiBnZXRfbXVsdGljYXN0X2FkZHJlc3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk1hbmFnZW1lbnQuRGV2aWNlLmdldF9tdWx0aWNhc3RfYWRkcmVzcyhzZWxmLmRldmljZXMpCgogICAgZGVmIGdldF9vcHRpb25hbF9tb2R1bGVzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZS5nZXRfb3B0aW9uYWxfbW9kdWxlcyhzZWxmLmRldmljZXMpCgogICAgZGVmIGdldF9wbGF0Zm9ybV9pZChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X3BsYXRmb3JtX2lkKHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X3ByaW1hcnlfbWlycm9yX2FkZHJlc3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk1hbmFnZW1lbnQuRGV2aWNlLmdldF9wcmltYXJ5X21pcnJvcl9hZGRyZXNzKHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X3Byb2R1Y3Qoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk1hbmFnZW1lbnQuRGV2aWNlLmdldF9wcm9kdWN0KHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X3NlY29uZGFyeV9taXJyb3JfYWRkcmVzcyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X3NlY29uZGFyeV9taXJyb3JfYWRkcmVzcyhzZWxmLmRldmljZXMpCgogICAgZGVmIGdldF9zb2Z0d2FyZV92ZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZS5nZXRfc29mdHdhcmVfdmVyc2lvbihzZWxmLmRldmljZXMpCgogICAgZGVmIGdldF90aW1lbGltaXRlZF9tb2R1bGVzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZS5nZXRfdGltZWxpbWl0ZWRfbW9kdWxlcyhzZWxmLmRldmljZXMpCgogICAgZGVmIGdldF90aW1lem9uZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2UuZ2V0X3RpbWV6b25lKHNlbGYuZGV2aWNlcykKCiAgICBkZWYgZ2V0X3VuaWNhc3RfYWRkcmVzc2VzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZS5nZXRfdW5pY2FzdF9hZGRyZXNzZXMoc2VsZi5kZXZpY2VzKQoKCmNsYXNzIERldmljZUdyb3VwcyhvYmplY3QpOgogICAgIiIiRGV2aWNlIGdyb3VwcyBjbGFzcy4KCiAgICBGNSBCSUctSVAgZGV2aWNlIGdyb3VwcyBjbGFzcy4KCiAgICBBdHRyaWJ1dGVzOgogICAgICAgIGFwaTogaUNvbnRyb2wgQVBJIGluc3RhbmNlLgogICAgICAgIGRldmljZV9ncm91cHM6IExpc3Qgb2YgZGV2aWNlIGdyb3Vwcy4KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhcGksIHJlZ2V4PU5vbmUpOgogICAgICAgIHNlbGYuYXBpID0gYXBpCiAgICAgICAgc2VsZi5kZXZpY2VfZ3JvdXBzID0gYXBpLk1hbmFnZW1lbnQuRGV2aWNlR3JvdXAuZ2V0X2xpc3QoKQogICAgICAgIGlmIHJlZ2V4OgogICAgICAgICAgICByZV9maWx0ZXIgPSByZS5jb21waWxlKHJlZ2V4KQogICAgICAgICAgICBzZWxmLmRldmljZV9ncm91cHMgPSBmaWx0ZXIocmVfZmlsdGVyLnNlYXJjaCwgc2VsZi5kZXZpY2VfZ3JvdXBzKQoKICAgIGRlZiBnZXRfbGlzdChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5kZXZpY2VfZ3JvdXBzCgogICAgZGVmIGdldF9hbGxfcHJlZmVycmVkX2FjdGl2ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2VHcm91cC5nZXRfYWxsX3ByZWZlcnJlZF9hY3RpdmUoc2VsZi5kZXZpY2VfZ3JvdXBzKQoKICAgIGRlZiBnZXRfYXV0b3N5bmNfZW5hYmxlZF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2VHcm91cC5nZXRfYXV0b3N5bmNfZW5hYmxlZF9zdGF0ZShzZWxmLmRldmljZV9ncm91cHMpCgogICAgZGVmIGdldF9kZXNjcmlwdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2VHcm91cC5nZXRfZGVzY3JpcHRpb24oc2VsZi5kZXZpY2VfZ3JvdXBzKQoKICAgIGRlZiBnZXRfZGV2aWNlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZUdyb3VwLmdldF9kZXZpY2Uoc2VsZi5kZXZpY2VfZ3JvdXBzKQoKICAgIGRlZiBnZXRfZnVsbF9sb2FkX29uX3N5bmNfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLk1hbmFnZW1lbnQuRGV2aWNlR3JvdXAuZ2V0X2Z1bGxfbG9hZF9vbl9zeW5jX3N0YXRlKHNlbGYuZGV2aWNlX2dyb3VwcykKCiAgICBkZWYgZ2V0X2luY3JlbWVudGFsX2NvbmZpZ19zeW5jX3NpemVfbWF4aW11bShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2VHcm91cC5nZXRfaW5jcmVtZW50YWxfY29uZmlnX3N5bmNfc2l6ZV9tYXhpbXVtKHNlbGYuZGV2aWNlX2dyb3VwcykKCiAgICBkZWYgZ2V0X25ldHdvcmtfZmFpbG92ZXJfZW5hYmxlZF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5EZXZpY2VHcm91cC5nZXRfbmV0d29ya19mYWlsb3Zlcl9lbmFibGVkX3N0YXRlKHNlbGYuZGV2aWNlX2dyb3VwcykKCiAgICBkZWYgZ2V0X3N5bmNfc3RhdHVzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZUdyb3VwLmdldF9zeW5jX3N0YXR1cyhzZWxmLmRldmljZV9ncm91cHMpCgogICAgZGVmIGdldF90eXBlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LkRldmljZUdyb3VwLmdldF90eXBlKHNlbGYuZGV2aWNlX2dyb3VwcykKCgpjbGFzcyBUcmFmZmljR3JvdXBzKG9iamVjdCk6CiAgICAiIiJUcmFmZmljIGdyb3VwcyBjbGFzcy4KCiAgICBGNSBCSUctSVAgdHJhZmZpYyBncm91cHMgY2xhc3MuCgogICAgQXR0cmlidXRlczoKICAgICAgICBhcGk6IGlDb250cm9sIEFQSSBpbnN0YW5jZS4KICAgICAgICB0cmFmZmljX2dyb3VwczogTGlzdCBvZiB0cmFmZmljIGdyb3Vwcy4KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhcGksIHJlZ2V4PU5vbmUpOgogICAgICAgIHNlbGYuYXBpID0gYXBpCiAgICAgICAgc2VsZi50cmFmZmljX2dyb3VwcyA9IGFwaS5NYW5hZ2VtZW50LlRyYWZmaWNHcm91cC5nZXRfbGlzdCgpCiAgICAgICAgaWYgcmVnZXg6CiAgICAgICAgICAgIHJlX2ZpbHRlciA9IHJlLmNvbXBpbGUocmVnZXgpCiAgICAgICAgICAgIHNlbGYudHJhZmZpY19ncm91cHMgPSBmaWx0ZXIocmVfZmlsdGVyLnNlYXJjaCwgc2VsZi50cmFmZmljX2dyb3VwcykKCiAgICBkZWYgZ2V0X2xpc3Qoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYudHJhZmZpY19ncm91cHMKCiAgICBkZWYgZ2V0X2F1dG9fZmFpbGJhY2tfZW5hYmxlZF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5UcmFmZmljR3JvdXAuZ2V0X2F1dG9fZmFpbGJhY2tfZW5hYmxlZF9zdGF0ZShzZWxmLnRyYWZmaWNfZ3JvdXBzKQoKICAgIGRlZiBnZXRfYXV0b19mYWlsYmFja190aW1lKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LlRyYWZmaWNHcm91cC5nZXRfYXV0b19mYWlsYmFja190aW1lKHNlbGYudHJhZmZpY19ncm91cHMpCgogICAgZGVmIGdldF9kZWZhdWx0X2RldmljZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5UcmFmZmljR3JvdXAuZ2V0X2RlZmF1bHRfZGV2aWNlKHNlbGYudHJhZmZpY19ncm91cHMpCgogICAgZGVmIGdldF9kZXNjcmlwdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5UcmFmZmljR3JvdXAuZ2V0X2Rlc2NyaXB0aW9uKHNlbGYudHJhZmZpY19ncm91cHMpCgogICAgZGVmIGdldF9oYV9sb2FkX2ZhY3RvcihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5UcmFmZmljR3JvdXAuZ2V0X2hhX2xvYWRfZmFjdG9yKHNlbGYudHJhZmZpY19ncm91cHMpCgogICAgZGVmIGdldF9oYV9vcmRlcihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5UcmFmZmljR3JvdXAuZ2V0X2hhX29yZGVyKHNlbGYudHJhZmZpY19ncm91cHMpCgogICAgZGVmIGdldF9pc19mbG9hdGluZyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5UcmFmZmljR3JvdXAuZ2V0X2lzX2Zsb2F0aW5nKHNlbGYudHJhZmZpY19ncm91cHMpCgogICAgZGVmIGdldF9tYWNfbWFzcXVlcmFkZV9hZGRyZXNzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5NYW5hZ2VtZW50LlRyYWZmaWNHcm91cC5nZXRfbWFjX21hc3F1ZXJhZGVfYWRkcmVzcyhzZWxmLnRyYWZmaWNfZ3JvdXBzKQoKICAgIGRlZiBnZXRfdW5pdF9pZChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTWFuYWdlbWVudC5UcmFmZmljR3JvdXAuZ2V0X3VuaXRfaWQoc2VsZi50cmFmZmljX2dyb3VwcykKCgpjbGFzcyBSdWxlcyhvYmplY3QpOgogICAgIiIiUnVsZXMgY2xhc3MuCgogICAgRjUgQklHLUlQIGlSdWxlcyBjbGFzcy4KCiAgICBBdHRyaWJ1dGVzOgogICAgICAgIGFwaTogaUNvbnRyb2wgQVBJIGluc3RhbmNlLgogICAgICAgIHJ1bGVzOiBMaXN0IG9mIGlSdWxlcy4KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhcGksIHJlZ2V4PU5vbmUpOgogICAgICAgIHNlbGYuYXBpID0gYXBpCiAgICAgICAgc2VsZi5ydWxlcyA9IGFwaS5Mb2NhbExCLlJ1bGUuZ2V0X2xpc3QoKQogICAgICAgIGlmIHJlZ2V4OgogICAgICAgICAgICByZV9maWx0ZXIgPSByZS5jb21waWxlKHJlZ2V4KQogICAgICAgICAgICBzZWxmLnRyYWZmaWNfZ3JvdXBzID0gZmlsdGVyKHJlX2ZpbHRlci5zZWFyY2gsIHNlbGYucnVsZXMpCgogICAgZGVmIGdldF9saXN0KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnJ1bGVzCgogICAgZGVmIGdldF9kZXNjcmlwdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5SdWxlLmdldF9kZXNjcmlwdGlvbihydWxlX25hbWVzPXNlbGYucnVsZXMpCgogICAgZGVmIGdldF9pZ25vcmVfdmVydGlmaWNhdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5SdWxlLmdldF9pZ25vcmVfdmVydGlmaWNhdGlvbihydWxlX25hbWVzPXNlbGYucnVsZXMpCgogICAgZGVmIGdldF92ZXJpZmljYXRpb25fc3RhdHVzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlJ1bGUuZ2V0X3ZlcmlmaWNhdGlvbl9zdGF0dXNfdjIocnVsZV9uYW1lcz1zZWxmLnJ1bGVzKQoKICAgIGRlZiBnZXRfZGVmaW5pdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gW3hbJ3J1bGVfZGVmaW5pdGlvbiddIGZvciB4IGluIHNlbGYuYXBpLkxvY2FsTEIuUnVsZS5xdWVyeV9ydWxlKHJ1bGVfbmFtZXM9c2VsZi5ydWxlcyldCgoKY2xhc3MgTm9kZXMob2JqZWN0KToKICAgICIiIk5vZGVzIGNsYXNzLgoKICAgIEY1IEJJRy1JUCBub2RlcyBjbGFzcy4KCiAgICBBdHRyaWJ1dGVzOgogICAgICAgIGFwaTogaUNvbnRyb2wgQVBJIGluc3RhbmNlLgogICAgICAgIG5vZGVzOiBMaXN0IG9mIG5vZGVzLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwaSwgcmVnZXg9Tm9uZSk6CiAgICAgICAgc2VsZi5hcGkgPSBhcGkKICAgICAgICBzZWxmLm5vZGVzID0gYXBpLkxvY2FsTEIuTm9kZUFkZHJlc3NWMi5nZXRfbGlzdCgpCiAgICAgICAgaWYgcmVnZXg6CiAgICAgICAgICAgIHJlX2ZpbHRlciA9IHJlLmNvbXBpbGUocmVnZXgpCiAgICAgICAgICAgIHNlbGYubm9kZXMgPSBmaWx0ZXIocmVfZmlsdGVyLnNlYXJjaCwgc2VsZi5ub2RlcykKCiAgICBkZWYgZ2V0X2xpc3Qoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYubm9kZXMKCiAgICBkZWYgZ2V0X2FkZHJlc3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuTm9kZUFkZHJlc3NWMi5nZXRfYWRkcmVzcyhub2Rlcz1zZWxmLm5vZGVzKQoKICAgIGRlZiBnZXRfY29ubmVjdGlvbl9saW1pdChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Ob2RlQWRkcmVzc1YyLmdldF9jb25uZWN0aW9uX2xpbWl0KG5vZGVzPXNlbGYubm9kZXMpCgogICAgZGVmIGdldF9kZXNjcmlwdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Ob2RlQWRkcmVzc1YyLmdldF9kZXNjcmlwdGlvbihub2Rlcz1zZWxmLm5vZGVzKQoKICAgIGRlZiBnZXRfZHluYW1pY19yYXRpbyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Ob2RlQWRkcmVzc1YyLmdldF9keW5hbWljX3JhdGlvX3YyKG5vZGVzPXNlbGYubm9kZXMpCgogICAgZGVmIGdldF9tb25pdG9yX2luc3RhbmNlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLk5vZGVBZGRyZXNzVjIuZ2V0X21vbml0b3JfaW5zdGFuY2Uobm9kZXM9c2VsZi5ub2RlcykKCiAgICBkZWYgZ2V0X21vbml0b3JfcnVsZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Ob2RlQWRkcmVzc1YyLmdldF9tb25pdG9yX3J1bGUobm9kZXM9c2VsZi5ub2RlcykKCiAgICBkZWYgZ2V0X21vbml0b3Jfc3RhdHVzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLk5vZGVBZGRyZXNzVjIuZ2V0X21vbml0b3Jfc3RhdHVzKG5vZGVzPXNlbGYubm9kZXMpCgogICAgZGVmIGdldF9vYmplY3Rfc3RhdHVzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLk5vZGVBZGRyZXNzVjIuZ2V0X29iamVjdF9zdGF0dXMobm9kZXM9c2VsZi5ub2RlcykKCiAgICBkZWYgZ2V0X3JhdGVfbGltaXQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuTm9kZUFkZHJlc3NWMi5nZXRfcmF0ZV9saW1pdChub2Rlcz1zZWxmLm5vZGVzKQoKICAgIGRlZiBnZXRfcmF0aW8oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuTm9kZUFkZHJlc3NWMi5nZXRfcmF0aW8obm9kZXM9c2VsZi5ub2RlcykKCiAgICBkZWYgZ2V0X3Nlc3Npb25fc3RhdHVzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLk5vZGVBZGRyZXNzVjIuZ2V0X3Nlc3Npb25fc3RhdHVzKG5vZGVzPXNlbGYubm9kZXMpCgoKY2xhc3MgVmlydHVhbEFkZHJlc3NlcyhvYmplY3QpOgogICAgIiIiVmlydHVhbCBhZGRyZXNzZXMgY2xhc3MuCgogICAgRjUgQklHLUlQIHZpcnR1YWwgYWRkcmVzc2VzIGNsYXNzLgoKICAgIEF0dHJpYnV0ZXM6CiAgICAgICAgYXBpOiBpQ29udHJvbCBBUEkgaW5zdGFuY2UuCiAgICAgICAgdmlydHVhbF9hZGRyZXNzZXM6IExpc3Qgb2YgdmlydHVhbCBhZGRyZXNzZXMuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgYXBpLCByZWdleD1Ob25lKToKICAgICAgICBzZWxmLmFwaSA9IGFwaQogICAgICAgIHNlbGYudmlydHVhbF9hZGRyZXNzZXMgPSBhcGkuTG9jYWxMQi5WaXJ0dWFsQWRkcmVzc1YyLmdldF9saXN0KCkKICAgICAgICBpZiByZWdleDoKICAgICAgICAgICAgcmVfZmlsdGVyID0gcmUuY29tcGlsZShyZWdleCkKICAgICAgICAgICAgc2VsZi52aXJ0dWFsX2FkZHJlc3NlcyA9IGZpbHRlcihyZV9maWx0ZXIuc2VhcmNoLCBzZWxmLnZpcnR1YWxfYWRkcmVzc2VzKQoKICAgIGRlZiBnZXRfbGlzdChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi52aXJ0dWFsX2FkZHJlc3NlcwoKICAgIGRlZiBnZXRfYWRkcmVzcyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsQWRkcmVzc1YyLmdldF9hZGRyZXNzKHNlbGYudmlydHVhbF9hZGRyZXNzZXMpCgogICAgZGVmIGdldF9hcnBfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbEFkZHJlc3NWMi5nZXRfYXJwX3N0YXRlKHNlbGYudmlydHVhbF9hZGRyZXNzZXMpCgogICAgZGVmIGdldF9hdXRvX2RlbGV0ZV9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsQWRkcmVzc1YyLmdldF9hdXRvX2RlbGV0ZV9zdGF0ZShzZWxmLnZpcnR1YWxfYWRkcmVzc2VzKQoKICAgIGRlZiBnZXRfY29ubmVjdGlvbl9saW1pdChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsQWRkcmVzc1YyLmdldF9jb25uZWN0aW9uX2xpbWl0KHNlbGYudmlydHVhbF9hZGRyZXNzZXMpCgogICAgZGVmIGdldF9kZXNjcmlwdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsQWRkcmVzc1YyLmdldF9kZXNjcmlwdGlvbihzZWxmLnZpcnR1YWxfYWRkcmVzc2VzKQoKICAgIGRlZiBnZXRfZW5hYmxlZF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsQWRkcmVzc1YyLmdldF9lbmFibGVkX3N0YXRlKHNlbGYudmlydHVhbF9hZGRyZXNzZXMpCgogICAgZGVmIGdldF9pY21wX2VjaG9fc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbEFkZHJlc3NWMi5nZXRfaWNtcF9lY2hvX3N0YXRlKHNlbGYudmlydHVhbF9hZGRyZXNzZXMpCgogICAgZGVmIGdldF9pc19mbG9hdGluZ19zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsQWRkcmVzc1YyLmdldF9pc19mbG9hdGluZ19zdGF0ZShzZWxmLnZpcnR1YWxfYWRkcmVzc2VzKQoKICAgIGRlZiBnZXRfbmV0bWFzayhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsQWRkcmVzc1YyLmdldF9uZXRtYXNrKHNlbGYudmlydHVhbF9hZGRyZXNzZXMpCgogICAgZGVmIGdldF9vYmplY3Rfc3RhdHVzKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlZpcnR1YWxBZGRyZXNzVjIuZ2V0X29iamVjdF9zdGF0dXMoc2VsZi52aXJ0dWFsX2FkZHJlc3NlcykKCiAgICBkZWYgZ2V0X3JvdXRlX2FkdmVydGlzZW1lbnRfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuVmlydHVhbEFkZHJlc3NWMi5nZXRfcm91dGVfYWR2ZXJ0aXNlbWVudF9zdGF0ZShzZWxmLnZpcnR1YWxfYWRkcmVzc2VzKQoKICAgIGRlZiBnZXRfdHJhZmZpY19ncm91cChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5WaXJ0dWFsQWRkcmVzc1YyLmdldF90cmFmZmljX2dyb3VwKHNlbGYudmlydHVhbF9hZGRyZXNzZXMpCgoKY2xhc3MgQWRkcmVzc0NsYXNzZXMob2JqZWN0KToKICAgICIiIkFkZHJlc3MgZ3JvdXAvY2xhc3MgY2xhc3MuCgogICAgRjUgQklHLUlQIGFkZHJlc3MgZ3JvdXAvY2xhc3MgY2xhc3MuCgogICAgQXR0cmlidXRlczoKICAgICAgICBhcGk6IGlDb250cm9sIEFQSSBpbnN0YW5jZS4KICAgICAgICBhZGRyZXNzX2NsYXNzZXM6IExpc3Qgb2YgYWRkcmVzcyBjbGFzc2VzLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwaSwgcmVnZXg9Tm9uZSk6CiAgICAgICAgc2VsZi5hcGkgPSBhcGkKICAgICAgICBzZWxmLmFkZHJlc3NfY2xhc3NlcyA9IGFwaS5Mb2NhbExCLkNsYXNzLmdldF9hZGRyZXNzX2NsYXNzX2xpc3QoKQogICAgICAgIGlmIHJlZ2V4OgogICAgICAgICAgICByZV9maWx0ZXIgPSByZS5jb21waWxlKHJlZ2V4KQogICAgICAgICAgICBzZWxmLmFkZHJlc3NfY2xhc3NlcyA9IGZpbHRlcihyZV9maWx0ZXIuc2VhcmNoLCBzZWxmLmFkZHJlc3NfY2xhc3NlcykKCiAgICBkZWYgZ2V0X2xpc3Qoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYWRkcmVzc19jbGFzc2VzCgogICAgZGVmIGdldF9hZGRyZXNzX2NsYXNzKHNlbGYpOgogICAgICAgIGtleSA9IHNlbGYuYXBpLkxvY2FsTEIuQ2xhc3MuZ2V0X2FkZHJlc3NfY2xhc3Moc2VsZi5hZGRyZXNzX2NsYXNzZXMpCiAgICAgICAgdmFsdWUgPSBzZWxmLmFwaS5Mb2NhbExCLkNsYXNzLmdldF9hZGRyZXNzX2NsYXNzX21lbWJlcl9kYXRhX3ZhbHVlKGtleSkKICAgICAgICByZXN1bHQgPSBsaXN0KG1hcCh6aXAsIFt4WydtZW1iZXJzJ10gZm9yIHggaW4ga2V5XSwgdmFsdWUpKQogICAgICAgIHJldHVybiByZXN1bHQKCiAgICBkZWYgZ2V0X2Rlc2NyaXB0aW9uKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLkNsYXNzLmdldF9kZXNjcmlwdGlvbihzZWxmLmFkZHJlc3NfY2xhc3NlcykKCgpjbGFzcyBDZXJ0aWZpY2F0ZXMob2JqZWN0KToKICAgICIiIkNlcnRpZmljYXRlcyBjbGFzcy4KCiAgICBGNSBCSUctSVAgY2VydGlmaWNhdGVzIGNsYXNzLgoKICAgIEF0dHJpYnV0ZXM6CiAgICAgICAgYXBpOiBpQ29udHJvbCBBUEkgaW5zdGFuY2UuCiAgICAgICAgY2VydGlmaWNhdGVzOiBMaXN0IG9mIGNlcnRpZmljYXRlIGlkZW50aWZpZXJzLgogICAgICAgIGNlcnRpZmljYXRlX2xpc3Q6IExpc3Qgb2YgY2VydGlmaWNhdGUgaW5mb3JtYXRpb24gc3RydWN0dXJlcy4KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhcGksIHJlZ2V4PU5vbmUsIG1vZGU9Ik1BTkFHRU1FTlRfTU9ERV9ERUZBVUxUIik6CiAgICAgICAgc2VsZi5hcGkgPSBhcGkKICAgICAgICBzZWxmLmNlcnRpZmljYXRlX2xpc3QgPSBhcGkuTWFuYWdlbWVudC5LZXlDZXJ0aWZpY2F0ZS5nZXRfY2VydGlmaWNhdGVfbGlzdChtb2RlPW1vZGUpCiAgICAgICAgc2VsZi5jZXJ0aWZpY2F0ZXMgPSBbeFsnY2VydGlmaWNhdGUnXVsnY2VydF9pbmZvJ11bJ2lkJ10gZm9yIHggaW4gc2VsZi5jZXJ0aWZpY2F0ZV9saXN0XQogICAgICAgIGlmIHJlZ2V4OgogICAgICAgICAgICByZV9maWx0ZXIgPSByZS5jb21waWxlKHJlZ2V4KQogICAgICAgICAgICBzZWxmLmNlcnRpZmljYXRlcyA9IGZpbHRlcihyZV9maWx0ZXIuc2VhcmNoLCBzZWxmLmNlcnRpZmljYXRlcykKICAgICAgICAgICAgc2VsZi5jZXJ0aWZpY2F0ZV9saXN0ID0gW3ggZm9yIHggaW4gc2VsZi5jZXJ0aWZpY2F0ZV9saXN0IGlmIHhbJ2NlcnRpZmljYXRlJ11bJ2NlcnRfaW5mbyddWydpZCddIGluIHNlbGYuY2VydGlmaWNhdGVzXQoKICAgIGRlZiBnZXRfbGlzdChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5jZXJ0aWZpY2F0ZXMKCiAgICBkZWYgZ2V0X2NlcnRpZmljYXRlX2xpc3Qoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuY2VydGlmaWNhdGVfbGlzdAoKCmNsYXNzIEtleXMob2JqZWN0KToKICAgICIiIktleXMgY2xhc3MuCgogICAgRjUgQklHLUlQIGtleXMgY2xhc3MuCgogICAgQXR0cmlidXRlczoKICAgICAgICBhcGk6IGlDb250cm9sIEFQSSBpbnN0YW5jZS4KICAgICAgICBrZXlzOiBMaXN0IG9mIGtleSBpZGVudGlmaWVycy4KICAgICAgICBrZXlfbGlzdDogTGlzdCBvZiBrZXkgaW5mb3JtYXRpb24gc3RydWN0dXJlcy4KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhcGksIHJlZ2V4PU5vbmUsIG1vZGU9Ik1BTkFHRU1FTlRfTU9ERV9ERUZBVUxUIik6CiAgICAgICAgc2VsZi5hcGkgPSBhcGkKICAgICAgICBzZWxmLmtleV9saXN0ID0gYXBpLk1hbmFnZW1lbnQuS2V5Q2VydGlmaWNhdGUuZ2V0X2tleV9saXN0KG1vZGU9bW9kZSkKICAgICAgICBzZWxmLmtleXMgPSBbeFsna2V5X2luZm8nXVsnaWQnXSBmb3IgeCBpbiBzZWxmLmtleV9saXN0XQogICAgICAgIGlmIHJlZ2V4OgogICAgICAgICAgICByZV9maWx0ZXIgPSByZS5jb21waWxlKHJlZ2V4KQogICAgICAgICAgICBzZWxmLmtleXMgPSBmaWx0ZXIocmVfZmlsdGVyLnNlYXJjaCwgc2VsZi5rZXlzKQogICAgICAgICAgICBzZWxmLmtleV9saXN0ID0gW3ggZm9yIHggaW4gc2VsZi5rZXlfbGlzdCBpZiB4WydrZXlfaW5mbyddWydpZCddIGluIHNlbGYua2V5c10KCiAgICBkZWYgZ2V0X2xpc3Qoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYua2V5cwoKICAgIGRlZiBnZXRfa2V5X2xpc3Qoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYua2V5X2xpc3QKCgpjbGFzcyBQcm9maWxlQ2xpZW50U1NMKG9iamVjdCk6CiAgICAiIiJDbGllbnQgU1NMIHByb2ZpbGVzIGNsYXNzLgoKICAgIEY1IEJJRy1JUCBjbGllbnQgU1NMIHByb2ZpbGVzIGNsYXNzLgoKICAgIEF0dHJpYnV0ZXM6CiAgICAgICAgYXBpOiBpQ29udHJvbCBBUEkgaW5zdGFuY2UuCiAgICAgICAgcHJvZmlsZXM6IExpc3Qgb2YgY2xpZW50IFNTTCBwcm9maWxlcy4KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhcGksIHJlZ2V4PU5vbmUpOgogICAgICAgIHNlbGYuYXBpID0gYXBpCiAgICAgICAgc2VsZi5wcm9maWxlcyA9IGFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X2xpc3QoKQogICAgICAgIGlmIHJlZ2V4OgogICAgICAgICAgICByZV9maWx0ZXIgPSByZS5jb21waWxlKHJlZ2V4KQogICAgICAgICAgICBzZWxmLnByb2ZpbGVzID0gZmlsdGVyKHJlX2ZpbHRlci5zZWFyY2gsIHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9saXN0KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnByb2ZpbGVzCgogICAgZGVmIGdldF9hbGVydF90aW1lb3V0KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X2FsZXJ0X3RpbWVvdXQoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X2FsbG93X25vbnNzbF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9hbGxvd19ub25zc2xfc3RhdGUoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X2F1dGhlbnRpY2F0ZV9kZXB0aChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9hdXRoZW50aWNhdGVfZGVwdGgoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X2F1dGhlbnRpY2F0ZV9vbmNlX3N0YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X2F1dGhlbnRpY2F0ZV9vbmNlX3N0YXRlKHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9jYV9maWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X2NhX2ZpbGVfdjIoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X2NhY2hlX3NpemUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5nZXRfY2FjaGVfc2l6ZShzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfY2FjaGVfdGltZW91dChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9jYWNoZV90aW1lb3V0KHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9jZXJ0aWZpY2F0ZV9maWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X2NlcnRpZmljYXRlX2ZpbGVfdjIoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X2NoYWluX2ZpbGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5nZXRfY2hhaW5fZmlsZV92MihzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfY2lwaGVyX2xpc3Qoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5nZXRfY2lwaGVyX2xpc3Qoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X2NsaWVudF9jZXJ0aWZpY2F0ZV9jYV9maWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X2NsaWVudF9jZXJ0aWZpY2F0ZV9jYV9maWxlX3YyKHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9jcmxfZmlsZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9jcmxfZmlsZV92MihzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfZGVmYXVsdF9wcm9maWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X2RlZmF1bHRfcHJvZmlsZShzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfZGVzY3JpcHRpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5nZXRfZGVzY3JpcHRpb24oc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X2ZvcndhcmRfcHJveHlfY2FfY2VydGlmaWNhdGVfZmlsZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9mb3J3YXJkX3Byb3h5X2NhX2NlcnRpZmljYXRlX2ZpbGUoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X2ZvcndhcmRfcHJveHlfY2Ffa2V5X2ZpbGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5nZXRfZm9yd2FyZF9wcm94eV9jYV9rZXlfZmlsZShzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfZm9yd2FyZF9wcm94eV9jYV9wYXNzcGhyYXNlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X2ZvcndhcmRfcHJveHlfY2FfcGFzc3BocmFzZShzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfZm9yd2FyZF9wcm94eV9jZXJ0aWZpY2F0ZV9leHRlbnNpb25faW5jbHVkZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9mb3J3YXJkX3Byb3h5X2NlcnRpZmljYXRlX2V4dGVuc2lvbl9pbmNsdWRlKHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9mb3J3YXJkX3Byb3h5X2NlcnRpZmljYXRlX2xpZmVzcGFuKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X2ZvcndhcmRfcHJveHlfY2VydGlmaWNhdGVfbGlmZXNwYW4oc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X2ZvcndhcmRfcHJveHlfZW5hYmxlZF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9mb3J3YXJkX3Byb3h5X2VuYWJsZWRfc3RhdGUoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X2ZvcndhcmRfcHJveHlfbG9va3VwX2J5X2lwYWRkcl9wb3J0X3N0YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X2ZvcndhcmRfcHJveHlfbG9va3VwX2J5X2lwYWRkcl9wb3J0X3N0YXRlKHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9oYW5kc2hha2VfdGltZW91dChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9oYW5kc2hha2VfdGltZW91dChzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfa2V5X2ZpbGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5nZXRfa2V5X2ZpbGVfdjIoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X21vZHNzbF9lbXVsYXRpb25fc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5nZXRfbW9kc3NsX2VtdWxhdGlvbl9zdGF0ZShzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfcGFzc3BocmFzZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9wYXNzcGhyYXNlKHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9wZWVyX2NlcnRpZmljYXRpb25fbW9kZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9wZWVyX2NlcnRpZmljYXRpb25fbW9kZShzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfcHJvZmlsZV9tb2RlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X3Byb2ZpbGVfbW9kZShzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfcmVuZWdvdGlhdGlvbl9tYXhpbXVtX3JlY29yZF9kZWxheShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9yZW5lZ290aWF0aW9uX21heGltdW1fcmVjb3JkX2RlbGF5KHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9yZW5lZ290aWF0aW9uX3BlcmlvZChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9yZW5lZ290aWF0aW9uX3BlcmlvZChzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfcmVuZWdvdGlhdGlvbl9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9yZW5lZ290aWF0aW9uX3N0YXRlKHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9yZW5lZ290aWF0aW9uX3Rocm91Z2hwdXQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5nZXRfcmVuZWdvdGlhdGlvbl90aHJvdWdocHV0KHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9yZXRhaW5fY2VydGlmaWNhdGVfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5nZXRfcmV0YWluX2NlcnRpZmljYXRlX3N0YXRlKHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9zZWN1cmVfcmVuZWdvdGlhdGlvbl9tb2RlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X3NlY3VyZV9yZW5lZ290aWF0aW9uX21vZGUoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X3NlcnZlcl9uYW1lKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X3NlcnZlcl9uYW1lKHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9zZXNzaW9uX3RpY2tldF9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF9zZXNzaW9uX3RpY2tldF9zdGF0ZShzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfc25pX2RlZmF1bHRfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5nZXRfc25pX2RlZmF1bHRfc3RhdGUoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X3NuaV9yZXF1aXJlX3N0YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X3NuaV9yZXF1aXJlX3N0YXRlKHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9zc2xfb3B0aW9uKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuZ2V0X3NzbF9vcHRpb24oc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X3N0cmljdF9yZXN1bWVfc3RhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5nZXRfc3RyaWN0X3Jlc3VtZV9zdGF0ZShzZWxmLnByb2ZpbGVzKQoKICAgIGRlZiBnZXRfdW5jbGVhbl9zaHV0ZG93bl9zdGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuTG9jYWxMQi5Qcm9maWxlQ2xpZW50U1NMLmdldF91bmNsZWFuX3NodXRkb3duX3N0YXRlKHNlbGYucHJvZmlsZXMpCgogICAgZGVmIGdldF9pc19iYXNlX3Byb2ZpbGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLkxvY2FsTEIuUHJvZmlsZUNsaWVudFNTTC5pc19iYXNlX3Byb2ZpbGUoc2VsZi5wcm9maWxlcykKCiAgICBkZWYgZ2V0X2lzX3N5c3RlbV9wcm9maWxlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5Mb2NhbExCLlByb2ZpbGVDbGllbnRTU0wuaXNfc3lzdGVtX3Byb2ZpbGUoc2VsZi5wcm9maWxlcykKCgpjbGFzcyBTeXN0ZW1JbmZvKG9iamVjdCk6CiAgICAiIiJTeXN0ZW0gaW5mb3JtYXRpb24gY2xhc3MuCgogICAgRjUgQklHLUlQIHN5c3RlbSBpbmZvcm1hdGlvbiBjbGFzcy4KCiAgICBBdHRyaWJ1dGVzOgogICAgICAgIGFwaTogaUNvbnRyb2wgQVBJIGluc3RhbmNlLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwaSk6CiAgICAgICAgc2VsZi5hcGkgPSBhcGkKCiAgICBkZWYgZ2V0X2Jhc2VfbWFjX2FkZHJlc3Moc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLlN5c3RlbS5TeXN0ZW1JbmZvLmdldF9iYXNlX21hY19hZGRyZXNzKCkKCiAgICBkZWYgZ2V0X2JsYWRlX3RlbXBlcmF0dXJlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5TeXN0ZW0uU3lzdGVtSW5mby5nZXRfYmxhZGVfdGVtcGVyYXR1cmUoKQoKICAgIGRlZiBnZXRfY2hhc3Npc19zbG90X2luZm9ybWF0aW9uKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5TeXN0ZW0uU3lzdGVtSW5mby5nZXRfY2hhc3Npc19zbG90X2luZm9ybWF0aW9uKCkKCiAgICBkZWYgZ2V0X2dsb2JhbGx5X3VuaXF1ZV9pZGVudGlmaWVyKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5TeXN0ZW0uU3lzdGVtSW5mby5nZXRfZ2xvYmFsbHlfdW5pcXVlX2lkZW50aWZpZXIoKQoKICAgIGRlZiBnZXRfZ3JvdXBfaWQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLlN5c3RlbS5TeXN0ZW1JbmZvLmdldF9ncm91cF9pZCgpCgogICAgZGVmIGdldF9oYXJkd2FyZV9pbmZvcm1hdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuU3lzdGVtLlN5c3RlbUluZm8uZ2V0X2hhcmR3YXJlX2luZm9ybWF0aW9uKCkKCiAgICBkZWYgZ2V0X21hcmtldGluZ19uYW1lKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5TeXN0ZW0uU3lzdGVtSW5mby5nZXRfbWFya2V0aW5nX25hbWUoKQoKICAgIGRlZiBnZXRfcHJvZHVjdF9pbmZvcm1hdGlvbihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuU3lzdGVtLlN5c3RlbUluZm8uZ2V0X3Byb2R1Y3RfaW5mb3JtYXRpb24oKQoKICAgIGRlZiBnZXRfcHZhX3ZlcnNpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLlN5c3RlbS5TeXN0ZW1JbmZvLmdldF9wdmFfdmVyc2lvbigpCgogICAgZGVmIGdldF9zeXN0ZW1faWQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLlN5c3RlbS5TeXN0ZW1JbmZvLmdldF9zeXN0ZW1faWQoKQoKICAgIGRlZiBnZXRfc3lzdGVtX2luZm9ybWF0aW9uKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmFwaS5TeXN0ZW0uU3lzdGVtSW5mby5nZXRfc3lzdGVtX2luZm9ybWF0aW9uKCkKCiAgICBkZWYgZ2V0X3RpbWUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLlN5c3RlbS5TeXN0ZW1JbmZvLmdldF90aW1lKCkKCiAgICBkZWYgZ2V0X3RpbWVfem9uZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5hcGkuU3lzdGVtLlN5c3RlbUluZm8uZ2V0X3RpbWVfem9uZSgpCgogICAgZGVmIGdldF91cHRpbWUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYXBpLlN5c3RlbS5TeXN0ZW1JbmZvLmdldF91cHRpbWUoKQoKCmNsYXNzIFByb3Zpc2lvbkluZm8ob2JqZWN0KToKICAgICIiIlByb3Zpc2lvbiBpbmZvcm1hdGlvbiBjbGFzcy4KCiAgICBGNSBCSUctSVAgcHJvdmlzaW9uIGluZm9ybWF0aW9uIGNsYXNzLgoKICAgIEF0dHJpYnV0ZXM6CiAgICAgICAgYXBpOiBpQ29udHJvbCBBUEkgaW5zdGFuY2UuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgYXBpKToKICAgICAgICBzZWxmLmFwaSA9IGFwaQoKICAgIGRlZiBnZXRfbGlzdChzZWxmKToKICAgICAgICByZXN1bHQgPSBbXQogICAgICAgIGxpc3QgPSBzZWxmLmFwaS5NYW5hZ2VtZW50LlByb3Zpc2lvbi5nZXRfbGlzdCgpCiAgICAgICAgZm9yIGl0ZW0gaW4gbGlzdDoKICAgICAgICAgICAgaXRlbSA9IGl0ZW0ubG93ZXIoKS5yZXBsYWNlKCd0bW9zX21vZHVsZV8nLCAnJykKICAgICAgICAgICAgcmVzdWx0LmFwcGVuZChpdGVtKQogICAgICAgIHJldHVybiByZXN1bHQKCiAgICBkZWYgZ2V0X3Byb3Zpc2lvbmVkX2xpc3Qoc2VsZik6CiAgICAgICAgcmVzdWx0ID0gW10KICAgICAgICBsaXN0ID0gc2VsZi5hcGkuTWFuYWdlbWVudC5Qcm92aXNpb24uZ2V0X3Byb3Zpc2lvbmVkX2xpc3QoKQogICAgICAgIGZvciBpdGVtIGluIGxpc3Q6CiAgICAgICAgICAgIGl0ZW0gPSBpdGVtLmxvd2VyKCkucmVwbGFjZSgndG1vc19tb2R1bGVfJywgJycpCiAgICAgICAgICAgIHJlc3VsdC5hcHBlbmQoaXRlbSkKICAgICAgICByZXR1cm4gcmVzdWx0CgoKZGVmIGdlbmVyYXRlX2RpY3QoYXBpX29iaiwgZmllbGRzKToKICAgIHJlc3VsdF9kaWN0ID0ge30KICAgIGxpc3RzID0gW10KICAgIHN1cHBvcnRlZF9maWVsZHMgPSBbXQogICAgaWYgYXBpX29iai5nZXRfbGlzdCgpOgogICAgICAgIGZvciBmaWVsZCBpbiBmaWVsZHM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGFwaV9yZXNwb25zZSA9IGdldGF0dHIoYXBpX29iaiwgImdldF8iICsgZmllbGQpKCkKICAgICAgICAgICAgZXhjZXB0IChNZXRob2ROb3RGb3VuZCwgV2ViRmF1bHQpOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbGlzdHMuYXBwZW5kKGFwaV9yZXNwb25zZSkKICAgICAgICAgICAgICAgIHN1cHBvcnRlZF9maWVsZHMuYXBwZW5kKGZpZWxkKQogICAgICAgIGZvciBpLCBqIGluIGVudW1lcmF0ZShhcGlfb2JqLmdldF9saXN0KCkpOgogICAgICAgICAgICB0ZW1wID0ge30KICAgICAgICAgICAgdGVtcC51cGRhdGUoWyhpdGVtWzBdLCBpdGVtWzFdW2ldKSBmb3IgaXRlbSBpbiB6aXAoc3VwcG9ydGVkX2ZpZWxkcywgbGlzdHMpXSkKICAgICAgICAgICAgcmVzdWx0X2RpY3Rbal0gPSB0ZW1wCiAgICByZXR1cm4gcmVzdWx0X2RpY3QKCgpkZWYgZ2VuZXJhdGVfc2ltcGxlX2RpY3QoYXBpX29iaiwgZmllbGRzKToKICAgIHJlc3VsdF9kaWN0ID0ge30KICAgIGZvciBmaWVsZCBpbiBmaWVsZHM6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcGlfcmVzcG9uc2UgPSBnZXRhdHRyKGFwaV9vYmosICJnZXRfIiArIGZpZWxkKSgpCiAgICAgICAgZXhjZXB0IChNZXRob2ROb3RGb3VuZCwgV2ViRmF1bHQpOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmVzdWx0X2RpY3RbZmllbGRdID0gYXBpX3Jlc3BvbnNlCiAgICByZXR1cm4gcmVzdWx0X2RpY3QKCgpkZWYgZ2VuZXJhdGVfaW50ZXJmYWNlX2RpY3QoZjUsIHJlZ2V4KToKICAgIGludGVyZmFjZXMgPSBJbnRlcmZhY2VzKGY1LmdldF9hcGkoKSwgcmVnZXgpCiAgICBmaWVsZHMgPSBbJ2FjdGl2ZV9tZWRpYScsICdhY3R1YWxfZmxvd19jb250cm9sJywgJ2J1bmRsZV9zdGF0ZScsCiAgICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJywgJ2R1YWxfbWVkaWFfc3RhdGUnLCAnZW5hYmxlZF9zdGF0ZScsICdpZl9pbmRleCcsCiAgICAgICAgICAgICAgJ2xlYXJuaW5nX21vZGUnLCAnbGxkcF9hZG1pbl9zdGF0dXMnLCAnbGxkcF90bHZtYXAnLAogICAgICAgICAgICAgICdtYWNfYWRkcmVzcycsICdtZWRpYScsICdtZWRpYV9vcHRpb24nLCAnbWVkaWFfb3B0aW9uX3NmcCcsCiAgICAgICAgICAgICAgJ21lZGlhX3NmcCcsICdtZWRpYV9zcGVlZCcsICdtZWRpYV9zdGF0dXMnLCAnbXR1JywKICAgICAgICAgICAgICAncGh5X21hc3Rlcl9zbGF2ZV9tb2RlJywgJ3ByZWZlcl9zZnBfc3RhdGUnLCAnZmxvd19jb250cm9sJywKICAgICAgICAgICAgICAnc2Zsb3dfcG9sbF9pbnRlcnZhbCcsICdzZmxvd19wb2xsX2ludGVydmFsX2dsb2JhbCcsCiAgICAgICAgICAgICAgJ3NmcF9tZWRpYV9zdGF0ZScsICdzdHBfYWN0aXZlX2VkZ2VfcG9ydF9zdGF0ZScsCiAgICAgICAgICAgICAgJ3N0cF9lbmFibGVkX3N0YXRlJywgJ3N0cF9saW5rX3R5cGUnLAogICAgICAgICAgICAgICdzdHBfcHJvdG9jb2xfZGV0ZWN0aW9uX3Jlc2V0X3N0YXRlJ10KICAgIHJldHVybiBnZW5lcmF0ZV9kaWN0KGludGVyZmFjZXMsIGZpZWxkcykKCgpkZWYgZ2VuZXJhdGVfc2VsZl9pcF9kaWN0KGY1LCByZWdleCk6CiAgICBzZWxmX2lwcyA9IFNlbGZJUHMoZjUuZ2V0X2FwaSgpLCByZWdleCkKICAgIGZpZWxkcyA9IFsnYWRkcmVzcycsICdhbGxvd19hY2Nlc3NfbGlzdCcsICdkZXNjcmlwdGlvbicsCiAgICAgICAgICAgICAgJ2VuZm9yY2VkX2ZpcmV3YWxsX3BvbGljeScsICdmbG9hdGluZ19zdGF0ZScsICdmd19ydWxlJywKICAgICAgICAgICAgICAnbmV0bWFzaycsICdzdGFnZWRfZmlyZXdhbGxfcG9saWN5JywgJ3RyYWZmaWNfZ3JvdXAnLAogICAgICAgICAgICAgICd2bGFuJywgJ2lzX3RyYWZmaWNfZ3JvdXBfaW5oZXJpdGVkJ10KICAgIHJldHVybiBnZW5lcmF0ZV9kaWN0KHNlbGZfaXBzLCBmaWVsZHMpCgoKZGVmIGdlbmVyYXRlX3RydW5rX2RpY3QoZjUsIHJlZ2V4KToKICAgIHRydW5rcyA9IFRydW5rcyhmNS5nZXRfYXBpKCksIHJlZ2V4KQogICAgZmllbGRzID0gWydhY3RpdmVfbGFjcF9zdGF0ZScsICdjb25maWd1cmVkX21lbWJlcl9jb3VudCcsICdkZXNjcmlwdGlvbicsCiAgICAgICAgICAgICAgJ2Rpc3RyaWJ1dGlvbl9oYXNoX29wdGlvbicsICdpbnRlcmZhY2UnLCAnbGFjcF9lbmFibGVkX3N0YXRlJywKICAgICAgICAgICAgICAnbGFjcF90aW1lb3V0X29wdGlvbicsICdsaW5rX3NlbGVjdGlvbl9wb2xpY3knLCAnbWVkaWFfc3BlZWQnLAogICAgICAgICAgICAgICdtZWRpYV9zdGF0dXMnLCAnb3BlcmF0aW9uYWxfbWVtYmVyX2NvdW50JywgJ3N0cF9lbmFibGVkX3N0YXRlJywKICAgICAgICAgICAgICAnc3RwX3Byb3RvY29sX2RldGVjdGlvbl9yZXNldF9zdGF0ZSddCiAgICByZXR1cm4gZ2VuZXJhdGVfZGljdCh0cnVua3MsIGZpZWxkcykKCgpkZWYgZ2VuZXJhdGVfdmxhbl9kaWN0KGY1LCByZWdleCk6CiAgICB2bGFucyA9IFZsYW5zKGY1LmdldF9hcGkoKSwgcmVnZXgpCiAgICBmaWVsZHMgPSBbJ2F1dG9fbGFzdGhvcCcsICdjbXBfaGFzaF9hbGdvcml0aG0nLCAnZGVzY3JpcHRpb24nLAogICAgICAgICAgICAgICdkeW5hbWljX2ZvcndhcmRpbmcnLCAnZmFpbHNhZmVfYWN0aW9uJywgJ2ZhaWxzYWZlX3N0YXRlJywKICAgICAgICAgICAgICAnZmFpbHNhZmVfdGltZW91dCcsICdpZl9pbmRleCcsICdsZWFybmluZ19tb2RlJywKICAgICAgICAgICAgICAnbWFjX21hc3F1ZXJhZGVfYWRkcmVzcycsICdtZW1iZXInLCAnbXR1JywKICAgICAgICAgICAgICAnc2Zsb3dfcG9sbF9pbnRlcnZhbCcsICdzZmxvd19wb2xsX2ludGVydmFsX2dsb2JhbCcsCiAgICAgICAgICAgICAgJ3NmbG93X3NhbXBsaW5nX3JhdGUnLCAnc2Zsb3dfc2FtcGxpbmdfcmF0ZV9nbG9iYWwnLAogICAgICAgICAgICAgICdzb3VyY2VfY2hlY2tfc3RhdGUnLCAndHJ1ZV9tYWNfYWRkcmVzcycsICd2bGFuX2lkJ10KICAgIHJldHVybiBnZW5lcmF0ZV9kaWN0KHZsYW5zLCBmaWVsZHMpCgoKZGVmIGdlbmVyYXRlX3ZzX2RpY3QoZjUsIHJlZ2V4KToKICAgIHZpcnR1YWxfc2VydmVycyA9IFZpcnR1YWxTZXJ2ZXJzKGY1LmdldF9hcGkoKSwgcmVnZXgpCiAgICBmaWVsZHMgPSBbJ2FjdHVhbF9oYXJkd2FyZV9hY2NlbGVyYXRpb24nLCAnYXV0aGVudGljYXRpb25fcHJvZmlsZScsCiAgICAgICAgICAgICAgJ2F1dG9fbGFzdGhvcCcsICdid19jb250cm9sbGVyX3BvbGljeScsICdjbG9uZV9wb29sJywKICAgICAgICAgICAgICAnY21wX2VuYWJsZV9tb2RlJywgJ2Nvbm5lY3Rpb25fbGltaXQnLCAnY29ubmVjdGlvbl9taXJyb3Jfc3RhdGUnLAogICAgICAgICAgICAgICdkZWZhdWx0X3Bvb2xfbmFtZScsICdkZXNjcmlwdGlvbicsICdkZXN0aW5hdGlvbicsCiAgICAgICAgICAgICAgJ2VuYWJsZWRfc3RhdGUnLCAnZW5mb3JjZWRfZmlyZXdhbGxfcG9saWN5JywKICAgICAgICAgICAgICAnZmFsbGJhY2tfcGVyc2lzdGVuY2VfcHJvZmlsZScsICdmd19ydWxlJywgJ2d0bV9zY29yZScsCiAgICAgICAgICAgICAgJ2xhc3RfaG9wX3Bvb2wnLCAnbmF0NjRfc3RhdGUnLCAnb2JqZWN0X3N0YXR1cycsCiAgICAgICAgICAgICAgJ3BlcnNpc3RlbmNlX3Byb2ZpbGUnLCAncHJvZmlsZScsICdwcm90b2NvbCcsCiAgICAgICAgICAgICAgJ3JhdGVfY2xhc3MnLCAncmF0ZV9saW1pdCcsICdyYXRlX2xpbWl0X2Rlc3RpbmF0aW9uX21hc2snLAogICAgICAgICAgICAgICdyYXRlX2xpbWl0X21vZGUnLCAncmF0ZV9saW1pdF9zb3VyY2VfbWFzaycsICdyZWxhdGVkX3J1bGUnLAogICAgICAgICAgICAgICdydWxlJywgJ3NlY3VyaXR5X2xvZ19wcm9maWxlJywgJ3NuYXRfcG9vbCcsICdzbmF0X3R5cGUnLAogICAgICAgICAgICAgICdzb3VyY2VfYWRkcmVzcycsICdzb3VyY2VfYWRkcmVzc190cmFuc2xhdGlvbl9sc25fcG9vbCcsCiAgICAgICAgICAgICAgJ3NvdXJjZV9hZGRyZXNzX3RyYW5zbGF0aW9uX3NuYXRfcG9vbCcsCiAgICAgICAgICAgICAgJ3NvdXJjZV9hZGRyZXNzX3RyYW5zbGF0aW9uX3R5cGUnLCAnc291cmNlX3BvcnRfYmVoYXZpb3InLAogICAgICAgICAgICAgICdzdGFnZWRfZmlyZXdhbGxfcG9saWN5JywgJ3RyYW5zbGF0ZV9hZGRyZXNzX3N0YXRlJywKICAgICAgICAgICAgICAndHJhbnNsYXRlX3BvcnRfc3RhdGUnLCAndHlwZScsICd2bGFuJywgJ3dpbGRtYXNrJ10KICAgIHJldHVybiBnZW5lcmF0ZV9kaWN0KHZpcnR1YWxfc2VydmVycywgZmllbGRzKQoKCmRlZiBnZW5lcmF0ZV9wb29sX2RpY3QoZjUsIHJlZ2V4KToKICAgIHBvb2xzID0gUG9vbHMoZjUuZ2V0X2FwaSgpLCByZWdleCkKICAgIGZpZWxkcyA9IFsnYWN0aW9uX29uX3NlcnZpY2VfZG93bicsICdhY3RpdmVfbWVtYmVyX2NvdW50JywKICAgICAgICAgICAgICAnYWdncmVnYXRlX2R5bmFtaWNfcmF0aW8nLCAnYWxsb3dfbmF0X3N0YXRlJywKICAgICAgICAgICAgICAnYWxsb3dfc25hdF9zdGF0ZScsICdjbGllbnRfaXBfdG9zJywgJ2NsaWVudF9saW5rX3FvcycsCiAgICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJywgJ2dhdGV3YXlfZmFpbHNhZmVfZGV2aWNlJywKICAgICAgICAgICAgICAnaWdub3JlX3BlcnNpc3RlZF93ZWlnaHRfc3RhdGUnLCAnbGJfbWV0aG9kJywgJ21lbWJlcicsCiAgICAgICAgICAgICAgJ21pbmltdW1fYWN0aXZlX21lbWJlcicsICdtaW5pbXVtX3VwX21lbWJlcicsCiAgICAgICAgICAgICAgJ21pbmltdW1fdXBfbWVtYmVyX2FjdGlvbicsICdtaW5pbXVtX3VwX21lbWJlcl9lbmFibGVkX3N0YXRlJywKICAgICAgICAgICAgICAnbW9uaXRvcl9hc3NvY2lhdGlvbicsICdtb25pdG9yX2luc3RhbmNlJywgJ29iamVjdF9zdGF0dXMnLAogICAgICAgICAgICAgICdwcm9maWxlJywgJ3F1ZXVlX2RlcHRoX2xpbWl0JywKICAgICAgICAgICAgICAncXVldWVfb25fY29ubmVjdGlvbl9saW1pdF9zdGF0ZScsICdxdWV1ZV90aW1lX2xpbWl0JywKICAgICAgICAgICAgICAncmVzZWxlY3RfdHJpZXMnLCAnc2VydmVyX2lwX3RvcycsICdzZXJ2ZXJfbGlua19xb3MnLAogICAgICAgICAgICAgICdzaW1wbGVfdGltZW91dCcsICdzbG93X3JhbXBfdGltZSddCiAgICByZXR1cm4gZ2VuZXJhdGVfZGljdChwb29scywgZmllbGRzKQoKCmRlZiBnZW5lcmF0ZV9kZXZpY2VfZGljdChmNSwgcmVnZXgpOgogICAgZGV2aWNlcyA9IERldmljZXMoZjUuZ2V0X2FwaSgpLCByZWdleCkKICAgIGZpZWxkcyA9IFsnYWN0aXZlX21vZHVsZXMnLCAnYmFzZV9tYWNfYWRkcmVzcycsICdibGFkZV9hZGRyZXNzZXMnLAogICAgICAgICAgICAgICdidWlsZCcsICdjaGFzc2lzX2lkJywgJ2NoYXNzaXNfdHlwZScsICdjb21tZW50JywKICAgICAgICAgICAgICAnY29uZmlnc3luY19hZGRyZXNzJywgJ2NvbnRhY3QnLCAnZGVzY3JpcHRpb24nLCAnZWRpdGlvbicsCiAgICAgICAgICAgICAgJ2ZhaWxvdmVyX3N0YXRlJywgJ2hvc3RuYW1lJywgJ2luYWN0aXZlX21vZHVsZXMnLCAnbG9jYXRpb24nLAogICAgICAgICAgICAgICdtYW5hZ2VtZW50X2FkZHJlc3MnLCAnbWFya2V0aW5nX25hbWUnLCAnbXVsdGljYXN0X2FkZHJlc3MnLAogICAgICAgICAgICAgICdvcHRpb25hbF9tb2R1bGVzJywgJ3BsYXRmb3JtX2lkJywgJ3ByaW1hcnlfbWlycm9yX2FkZHJlc3MnLAogICAgICAgICAgICAgICdwcm9kdWN0JywgJ3NlY29uZGFyeV9taXJyb3JfYWRkcmVzcycsICdzb2Z0d2FyZV92ZXJzaW9uJywKICAgICAgICAgICAgICAndGltZWxpbWl0ZWRfbW9kdWxlcycsICd0aW1lem9uZScsICd1bmljYXN0X2FkZHJlc3NlcyddCiAgICByZXR1cm4gZ2VuZXJhdGVfZGljdChkZXZpY2VzLCBmaWVsZHMpCgoKZGVmIGdlbmVyYXRlX2RldmljZV9ncm91cF9kaWN0KGY1LCByZWdleCk6CiAgICBkZXZpY2VfZ3JvdXBzID0gRGV2aWNlR3JvdXBzKGY1LmdldF9hcGkoKSwgcmVnZXgpCiAgICBmaWVsZHMgPSBbJ2FsbF9wcmVmZXJyZWRfYWN0aXZlJywgJ2F1dG9zeW5jX2VuYWJsZWRfc3RhdGUnLCAnZGVzY3JpcHRpb24nLAogICAgICAgICAgICAgICdkZXZpY2UnLCAnZnVsbF9sb2FkX29uX3N5bmNfc3RhdGUnLAogICAgICAgICAgICAgICdpbmNyZW1lbnRhbF9jb25maWdfc3luY19zaXplX21heGltdW0nLAogICAgICAgICAgICAgICduZXR3b3JrX2ZhaWxvdmVyX2VuYWJsZWRfc3RhdGUnLCAnc3luY19zdGF0dXMnLCAndHlwZSddCiAgICByZXR1cm4gZ2VuZXJhdGVfZGljdChkZXZpY2VfZ3JvdXBzLCBmaWVsZHMpCgoKZGVmIGdlbmVyYXRlX3RyYWZmaWNfZ3JvdXBfZGljdChmNSwgcmVnZXgpOgogICAgdHJhZmZpY19ncm91cHMgPSBUcmFmZmljR3JvdXBzKGY1LmdldF9hcGkoKSwgcmVnZXgpCiAgICBmaWVsZHMgPSBbJ2F1dG9fZmFpbGJhY2tfZW5hYmxlZF9zdGF0ZScsICdhdXRvX2ZhaWxiYWNrX3RpbWUnLAogICAgICAgICAgICAgICdkZWZhdWx0X2RldmljZScsICdkZXNjcmlwdGlvbicsICdoYV9sb2FkX2ZhY3RvcicsCiAgICAgICAgICAgICAgJ2hhX29yZGVyJywgJ2lzX2Zsb2F0aW5nJywgJ21hY19tYXNxdWVyYWRlX2FkZHJlc3MnLAogICAgICAgICAgICAgICd1bml0X2lkJ10KICAgIHJldHVybiBnZW5lcmF0ZV9kaWN0KHRyYWZmaWNfZ3JvdXBzLCBmaWVsZHMpCgoKZGVmIGdlbmVyYXRlX3J1bGVfZGljdChmNSwgcmVnZXgpOgogICAgcnVsZXMgPSBSdWxlcyhmNS5nZXRfYXBpKCksIHJlZ2V4KQogICAgZmllbGRzID0gWydkZWZpbml0aW9uJywgJ2Rlc2NyaXB0aW9uJywgJ2lnbm9yZV92ZXJ0aWZpY2F0aW9uJywKICAgICAgICAgICAgICAndmVyaWZpY2F0aW9uX3N0YXR1cyddCiAgICByZXR1cm4gZ2VuZXJhdGVfZGljdChydWxlcywgZmllbGRzKQoKCmRlZiBnZW5lcmF0ZV9ub2RlX2RpY3QoZjUsIHJlZ2V4KToKICAgIG5vZGVzID0gTm9kZXMoZjUuZ2V0X2FwaSgpLCByZWdleCkKICAgIGZpZWxkcyA9IFsnYWRkcmVzcycsICdjb25uZWN0aW9uX2xpbWl0JywgJ2Rlc2NyaXB0aW9uJywgJ2R5bmFtaWNfcmF0aW8nLAogICAgICAgICAgICAgICdtb25pdG9yX2luc3RhbmNlJywgJ21vbml0b3JfcnVsZScsICdtb25pdG9yX3N0YXR1cycsCiAgICAgICAgICAgICAgJ29iamVjdF9zdGF0dXMnLCAncmF0ZV9saW1pdCcsICdyYXRpbycsICdzZXNzaW9uX3N0YXR1cyddCiAgICByZXR1cm4gZ2VuZXJhdGVfZGljdChub2RlcywgZmllbGRzKQoKCmRlZiBnZW5lcmF0ZV92aXJ0dWFsX2FkZHJlc3NfZGljdChmNSwgcmVnZXgpOgogICAgdmlydHVhbF9hZGRyZXNzZXMgPSBWaXJ0dWFsQWRkcmVzc2VzKGY1LmdldF9hcGkoKSwgcmVnZXgpCiAgICBmaWVsZHMgPSBbJ2FkZHJlc3MnLCAnYXJwX3N0YXRlJywgJ2F1dG9fZGVsZXRlX3N0YXRlJywgJ2Nvbm5lY3Rpb25fbGltaXQnLAogICAgICAgICAgICAgICdkZXNjcmlwdGlvbicsICdlbmFibGVkX3N0YXRlJywgJ2ljbXBfZWNob19zdGF0ZScsCiAgICAgICAgICAgICAgJ2lzX2Zsb2F0aW5nX3N0YXRlJywgJ25ldG1hc2snLCAnb2JqZWN0X3N0YXR1cycsCiAgICAgICAgICAgICAgJ3JvdXRlX2FkdmVydGlzZW1lbnRfc3RhdGUnLCAndHJhZmZpY19ncm91cCddCiAgICByZXR1cm4gZ2VuZXJhdGVfZGljdCh2aXJ0dWFsX2FkZHJlc3NlcywgZmllbGRzKQoKCmRlZiBnZW5lcmF0ZV9hZGRyZXNzX2NsYXNzX2RpY3QoZjUsIHJlZ2V4KToKICAgIGFkZHJlc3NfY2xhc3NlcyA9IEFkZHJlc3NDbGFzc2VzKGY1LmdldF9hcGkoKSwgcmVnZXgpCiAgICBmaWVsZHMgPSBbJ2FkZHJlc3NfY2xhc3MnLCAnZGVzY3JpcHRpb24nXQogICAgcmV0dXJuIGdlbmVyYXRlX2RpY3QoYWRkcmVzc19jbGFzc2VzLCBmaWVsZHMpCgoKZGVmIGdlbmVyYXRlX2NlcnRpZmljYXRlX2RpY3QoZjUsIHJlZ2V4KToKICAgIGNlcnRpZmljYXRlcyA9IENlcnRpZmljYXRlcyhmNS5nZXRfYXBpKCksIHJlZ2V4KQogICAgcmV0dXJuIGRpY3QoemlwKGNlcnRpZmljYXRlcy5nZXRfbGlzdCgpLCBjZXJ0aWZpY2F0ZXMuZ2V0X2NlcnRpZmljYXRlX2xpc3QoKSkpCgoKZGVmIGdlbmVyYXRlX2tleV9kaWN0KGY1LCByZWdleCk6CiAgICBrZXlzID0gS2V5cyhmNS5nZXRfYXBpKCksIHJlZ2V4KQogICAgcmV0dXJuIGRpY3QoemlwKGtleXMuZ2V0X2xpc3QoKSwga2V5cy5nZXRfa2V5X2xpc3QoKSkpCgoKZGVmIGdlbmVyYXRlX2NsaWVudF9zc2xfcHJvZmlsZV9kaWN0KGY1LCByZWdleCk6CiAgICBwcm9maWxlcyA9IFByb2ZpbGVDbGllbnRTU0woZjUuZ2V0X2FwaSgpLCByZWdleCkKICAgIGZpZWxkcyA9IFsnYWxlcnRfdGltZW91dCcsICdhbGxvd19ub25zc2xfc3RhdGUnLCAnYXV0aGVudGljYXRlX2RlcHRoJywKICAgICAgICAgICAgICAnYXV0aGVudGljYXRlX29uY2Vfc3RhdGUnLCAnY2FfZmlsZScsICdjYWNoZV9zaXplJywKICAgICAgICAgICAgICAnY2FjaGVfdGltZW91dCcsICdjZXJ0aWZpY2F0ZV9maWxlJywgJ2NoYWluX2ZpbGUnLAogICAgICAgICAgICAgICdjaXBoZXJfbGlzdCcsICdjbGllbnRfY2VydGlmaWNhdGVfY2FfZmlsZScsICdjcmxfZmlsZScsCiAgICAgICAgICAgICAgJ2RlZmF1bHRfcHJvZmlsZScsICdkZXNjcmlwdGlvbicsCiAgICAgICAgICAgICAgJ2ZvcndhcmRfcHJveHlfY2FfY2VydGlmaWNhdGVfZmlsZScsICdmb3J3YXJkX3Byb3h5X2NhX2tleV9maWxlJywKICAgICAgICAgICAgICAnZm9yd2FyZF9wcm94eV9jYV9wYXNzcGhyYXNlJywKICAgICAgICAgICAgICAnZm9yd2FyZF9wcm94eV9jZXJ0aWZpY2F0ZV9leHRlbnNpb25faW5jbHVkZScsCiAgICAgICAgICAgICAgJ2ZvcndhcmRfcHJveHlfY2VydGlmaWNhdGVfbGlmZXNwYW4nLAogICAgICAgICAgICAgICdmb3J3YXJkX3Byb3h5X2VuYWJsZWRfc3RhdGUnLAogICAgICAgICAgICAgICdmb3J3YXJkX3Byb3h5X2xvb2t1cF9ieV9pcGFkZHJfcG9ydF9zdGF0ZScsICdoYW5kc2hha2VfdGltZW91dCcsCiAgICAgICAgICAgICAgJ2tleV9maWxlJywgJ21vZHNzbF9lbXVsYXRpb25fc3RhdGUnLCAncGFzc3BocmFzZScsCiAgICAgICAgICAgICAgJ3BlZXJfY2VydGlmaWNhdGlvbl9tb2RlJywgJ3Byb2ZpbGVfbW9kZScsCiAgICAgICAgICAgICAgJ3JlbmVnb3RpYXRpb25fbWF4aW11bV9yZWNvcmRfZGVsYXknLCAncmVuZWdvdGlhdGlvbl9wZXJpb2QnLAogICAgICAgICAgICAgICdyZW5lZ290aWF0aW9uX3N0YXRlJywgJ3JlbmVnb3RpYXRpb25fdGhyb3VnaHB1dCcsCiAgICAgICAgICAgICAgJ3JldGFpbl9jZXJ0aWZpY2F0ZV9zdGF0ZScsICdzZWN1cmVfcmVuZWdvdGlhdGlvbl9tb2RlJywKICAgICAgICAgICAgICAnc2VydmVyX25hbWUnLCAnc2Vzc2lvbl90aWNrZXRfc3RhdGUnLCAnc25pX2RlZmF1bHRfc3RhdGUnLAogICAgICAgICAgICAgICdzbmlfcmVxdWlyZV9zdGF0ZScsICdzc2xfb3B0aW9uJywgJ3N0cmljdF9yZXN1bWVfc3RhdGUnLAogICAgICAgICAgICAgICd1bmNsZWFuX3NodXRkb3duX3N0YXRlJywgJ2lzX2Jhc2VfcHJvZmlsZScsICdpc19zeXN0ZW1fcHJvZmlsZSddCiAgICByZXR1cm4gZ2VuZXJhdGVfZGljdChwcm9maWxlcywgZmllbGRzKQoKCmRlZiBnZW5lcmF0ZV9zeXN0ZW1faW5mb19kaWN0KGY1KToKICAgIHN5c3RlbV9pbmZvID0gU3lzdGVtSW5mbyhmNS5nZXRfYXBpKCkpCiAgICBmaWVsZHMgPSBbJ2Jhc2VfbWFjX2FkZHJlc3MnLAogICAgICAgICAgICAgICdibGFkZV90ZW1wZXJhdHVyZScsICdjaGFzc2lzX3Nsb3RfaW5mb3JtYXRpb24nLAogICAgICAgICAgICAgICdnbG9iYWxseV91bmlxdWVfaWRlbnRpZmllcicsICdncm91cF9pZCcsCiAgICAgICAgICAgICAgJ2hhcmR3YXJlX2luZm9ybWF0aW9uJywKICAgICAgICAgICAgICAnbWFya2V0aW5nX25hbWUnLAogICAgICAgICAgICAgICdwcm9kdWN0X2luZm9ybWF0aW9uJywgJ3B2YV92ZXJzaW9uJywgJ3N5c3RlbV9pZCcsCiAgICAgICAgICAgICAgJ3N5c3RlbV9pbmZvcm1hdGlvbicsICd0aW1lJywKICAgICAgICAgICAgICAndGltZV96b25lJywgJ3VwdGltZSddCiAgICByZXR1cm4gZ2VuZXJhdGVfc2ltcGxlX2RpY3Qoc3lzdGVtX2luZm8sIGZpZWxkcykKCgpkZWYgZ2VuZXJhdGVfc29mdHdhcmVfbGlzdChmNSk6CiAgICBzb2Z0d2FyZSA9IFNvZnR3YXJlKGY1LmdldF9hcGkoKSkKICAgIHNvZnR3YXJlX2xpc3QgPSBzb2Z0d2FyZS5nZXRfYWxsX3NvZnR3YXJlX3N0YXR1cygpCiAgICByZXR1cm4gc29mdHdhcmVfbGlzdAoKCmRlZiBnZW5lcmF0ZV9wcm92aXNpb25fZGljdChmNSk6CiAgICBwcm92aXNpb25lZCA9IFByb3Zpc2lvbkluZm8oZjUuZ2V0X2FwaSgpKQogICAgZmllbGRzID0gWydsaXN0JywgJ3Byb3Zpc2lvbmVkX2xpc3QnXQogICAgcmV0dXJuIGdlbmVyYXRlX3NpbXBsZV9kaWN0KHByb3Zpc2lvbmVkLCBmaWVsZHMpCgoKZGVmIG1haW4oKToKICAgIGFyZ3VtZW50X3NwZWMgPSBmNV9hcmd1bWVudF9zcGVjKCkKCiAgICBtZXRhX2FyZ3MgPSBkaWN0KAogICAgICAgIHNlc3Npb249ZGljdCh0eXBlPSdib29sJywgZGVmYXVsdD1GYWxzZSksCiAgICAgICAgaW5jbHVkZT1kaWN0KHR5cGU9J2xpc3QnLCByZXF1aXJlZD1UcnVlKSwKICAgICAgICBmaWx0ZXI9ZGljdCh0eXBlPSdzdHInLCByZXF1aXJlZD1GYWxzZSksCiAgICApCiAgICBhcmd1bWVudF9zcGVjLnVwZGF0ZShtZXRhX2FyZ3MpCgogICAgbW9kdWxlID0gQW5zaWJsZU1vZHVsZSgKICAgICAgICBhcmd1bWVudF9zcGVjPWFyZ3VtZW50X3NwZWMKICAgICkKCiAgICBpZiBub3QgYmlnc3Vkc19mb3VuZDoKICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG1zZz0idGhlIHB5dGhvbiBzdWRzIGFuZCBiaWdzdWRzIG1vZHVsZXMgYXJlIHJlcXVpcmVkIikKCiAgICBzZXJ2ZXIgPSBtb2R1bGUucGFyYW1zWydzZXJ2ZXInXQogICAgc2VydmVyX3BvcnQgPSBtb2R1bGUucGFyYW1zWydzZXJ2ZXJfcG9ydCddCiAgICB1c2VyID0gbW9kdWxlLnBhcmFtc1sndXNlciddCiAgICBwYXNzd29yZCA9IG1vZHVsZS5wYXJhbXNbJ3Bhc3N3b3JkJ10KICAgIHZhbGlkYXRlX2NlcnRzID0gbW9kdWxlLnBhcmFtc1sndmFsaWRhdGVfY2VydHMnXQogICAgc2Vzc2lvbiA9IG1vZHVsZS5wYXJhbXNbJ3Nlc3Npb24nXQogICAgZmFjdF9maWx0ZXIgPSBtb2R1bGUucGFyYW1zWydmaWx0ZXInXQoKICAgIGlmIHZhbGlkYXRlX2NlcnRzOgogICAgICAgIGltcG9ydCBzc2wKICAgICAgICBpZiBub3QgaGFzYXR0cihzc2wsICdTU0xDb250ZXh0Jyk6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgICAgICBtc2c9J2JpZ3N1ZHMgZG9lcyBub3Qgc3VwcG9ydCB2ZXJpZnlpbmcgY2VydGlmaWNhdGVzIHdpdGggcHl0aG9uIDwgMi43LjkuICBFaXRoZXIgdXBkYXRlIHB5dGhvbiBvciBzZXQgdmFsaWRhdGVfY2VydHM9RmFsc2Ugb24gdGhlIHRhc2snCiAgICAgICAgICAgICkKCiAgICBpZiBmYWN0X2ZpbHRlcjoKICAgICAgICByZWdleCA9IGZubWF0Y2gudHJhbnNsYXRlKGZhY3RfZmlsdGVyKQogICAgZWxzZToKICAgICAgICByZWdleCA9IE5vbmUKICAgIGluY2x1ZGUgPSBbeC5sb3dlcigpIGZvciB4IGluIG1vZHVsZS5wYXJhbXNbJ2luY2x1ZGUnXV0KICAgIHZhbGlkX2luY2x1ZGVzID0gKCdhZGRyZXNzX2NsYXNzJywgJ2NlcnRpZmljYXRlJywgJ2NsaWVudF9zc2xfcHJvZmlsZScsCiAgICAgICAgICAgICAgICAgICAgICAnZGV2aWNlJywgJ2RldmljZV9ncm91cCcsICdpbnRlcmZhY2UnLCAna2V5JywgJ25vZGUnLAogICAgICAgICAgICAgICAgICAgICAgJ3Bvb2wnLCAncHJvdmlzaW9uJywgJ3J1bGUnLCAnc2VsZl9pcCcsICdzb2Z0d2FyZScsCiAgICAgICAgICAgICAgICAgICAgICAnc3lzdGVtX2luZm8nLCAndHJhZmZpY19ncm91cCcsICd0cnVuaycsCiAgICAgICAgICAgICAgICAgICAgICAndmlydHVhbF9hZGRyZXNzJywgJ3ZpcnR1YWxfc2VydmVyJywgJ3ZsYW4nKQogICAgaW5jbHVkZV90ZXN0ID0gbWFwKGxhbWJkYSB4OiB4IGluIHZhbGlkX2luY2x1ZGVzLCBpbmNsdWRlKQogICAgaWYgbm90IGFsbChpbmNsdWRlX3Rlc3QpOgogICAgICAgIG1vZHVsZS5mYWlsX2pzb24obXNnPSJ2YWx1ZSBvZiBpbmNsdWRlIG11c3QgYmUgb25lIG9yIG1vcmUgb2Y6ICVzLCBnb3Q6ICVzIiAlICgiLCIuam9pbih2YWxpZF9pbmNsdWRlcyksICIsIi5qb2luKGluY2x1ZGUpKSkKCiAgICB0cnk6CiAgICAgICAgZmFjdHMgPSB7fQoKICAgICAgICBpZiBsZW4oaW5jbHVkZSkgPiAwOgogICAgICAgICAgICBmNSA9IEY1KHNlcnZlciwgdXNlciwgcGFzc3dvcmQsIHNlc3Npb24sIHZhbGlkYXRlX2NlcnRzLCBzZXJ2ZXJfcG9ydCkKICAgICAgICAgICAgc2F2ZWRfYWN0aXZlX2ZvbGRlciA9IGY1LmdldF9hY3RpdmVfZm9sZGVyKCkKICAgICAgICAgICAgc2F2ZWRfcmVjdXJzaXZlX3F1ZXJ5X3N0YXRlID0gZjUuZ2V0X3JlY3Vyc2l2ZV9xdWVyeV9zdGF0ZSgpCiAgICAgICAgICAgIGlmIHNhdmVkX2FjdGl2ZV9mb2xkZXIgIT0gIi8iOgogICAgICAgICAgICAgICAgZjUuc2V0X2FjdGl2ZV9mb2xkZXIoIi8iKQogICAgICAgICAgICBpZiBzYXZlZF9yZWN1cnNpdmVfcXVlcnlfc3RhdGUgIT0gIlNUQVRFX0VOQUJMRUQiOgogICAgICAgICAgICAgICAgZjUuZW5hYmxlX3JlY3Vyc2l2ZV9xdWVyeV9zdGF0ZSgpCgogICAgICAgICAgICBpZiAnaW50ZXJmYWNlJyBpbiBpbmNsdWRlOgogICAgICAgICAgICAgICAgZmFjdHNbJ2ludGVyZmFjZSddID0gZ2VuZXJhdGVfaW50ZXJmYWNlX2RpY3QoZjUsIHJlZ2V4KQogICAgICAgICAgICBpZiAnc2VsZl9pcCcgaW4gaW5jbHVkZToKICAgICAgICAgICAgICAgIGZhY3RzWydzZWxmX2lwJ10gPSBnZW5lcmF0ZV9zZWxmX2lwX2RpY3QoZjUsIHJlZ2V4KQogICAgICAgICAgICBpZiAndHJ1bmsnIGluIGluY2x1ZGU6CiAgICAgICAgICAgICAgICBmYWN0c1sndHJ1bmsnXSA9IGdlbmVyYXRlX3RydW5rX2RpY3QoZjUsIHJlZ2V4KQogICAgICAgICAgICBpZiAndmxhbicgaW4gaW5jbHVkZToKICAgICAgICAgICAgICAgIGZhY3RzWyd2bGFuJ10gPSBnZW5lcmF0ZV92bGFuX2RpY3QoZjUsIHJlZ2V4KQogICAgICAgICAgICBpZiAndmlydHVhbF9zZXJ2ZXInIGluIGluY2x1ZGU6CiAgICAgICAgICAgICAgICBmYWN0c1sndmlydHVhbF9zZXJ2ZXInXSA9IGdlbmVyYXRlX3ZzX2RpY3QoZjUsIHJlZ2V4KQogICAgICAgICAgICBpZiAncG9vbCcgaW4gaW5jbHVkZToKICAgICAgICAgICAgICAgIGZhY3RzWydwb29sJ10gPSBnZW5lcmF0ZV9wb29sX2RpY3QoZjUsIHJlZ2V4KQogICAgICAgICAgICBpZiAncHJvdmlzaW9uJyBpbiBpbmNsdWRlOgogICAgICAgICAgICAgICAgZmFjdHNbJ3Byb3Zpc2lvbiddID0gZ2VuZXJhdGVfcHJvdmlzaW9uX2RpY3QoZjUpCiAgICAgICAgICAgIGlmICdkZXZpY2UnIGluIGluY2x1ZGU6CiAgICAgICAgICAgICAgICBmYWN0c1snZGV2aWNlJ10gPSBnZW5lcmF0ZV9kZXZpY2VfZGljdChmNSwgcmVnZXgpCiAgICAgICAgICAgIGlmICdkZXZpY2VfZ3JvdXAnIGluIGluY2x1ZGU6CiAgICAgICAgICAgICAgICBmYWN0c1snZGV2aWNlX2dyb3VwJ10gPSBnZW5lcmF0ZV9kZXZpY2VfZ3JvdXBfZGljdChmNSwgcmVnZXgpCiAgICAgICAgICAgIGlmICd0cmFmZmljX2dyb3VwJyBpbiBpbmNsdWRlOgogICAgICAgICAgICAgICAgZmFjdHNbJ3RyYWZmaWNfZ3JvdXAnXSA9IGdlbmVyYXRlX3RyYWZmaWNfZ3JvdXBfZGljdChmNSwgcmVnZXgpCiAgICAgICAgICAgIGlmICdydWxlJyBpbiBpbmNsdWRlOgogICAgICAgICAgICAgICAgZmFjdHNbJ3J1bGUnXSA9IGdlbmVyYXRlX3J1bGVfZGljdChmNSwgcmVnZXgpCiAgICAgICAgICAgIGlmICdub2RlJyBpbiBpbmNsdWRlOgogICAgICAgICAgICAgICAgZmFjdHNbJ25vZGUnXSA9IGdlbmVyYXRlX25vZGVfZGljdChmNSwgcmVnZXgpCiAgICAgICAgICAgIGlmICd2aXJ0dWFsX2FkZHJlc3MnIGluIGluY2x1ZGU6CiAgICAgICAgICAgICAgICBmYWN0c1sndmlydHVhbF9hZGRyZXNzJ10gPSBnZW5lcmF0ZV92aXJ0dWFsX2FkZHJlc3NfZGljdChmNSwgcmVnZXgpCiAgICAgICAgICAgIGlmICdhZGRyZXNzX2NsYXNzJyBpbiBpbmNsdWRlOgogICAgICAgICAgICAgICAgZmFjdHNbJ2FkZHJlc3NfY2xhc3MnXSA9IGdlbmVyYXRlX2FkZHJlc3NfY2xhc3NfZGljdChmNSwgcmVnZXgpCiAgICAgICAgICAgIGlmICdzb2Z0d2FyZScgaW4gaW5jbHVkZToKICAgICAgICAgICAgICAgIGZhY3RzWydzb2Z0d2FyZSddID0gZ2VuZXJhdGVfc29mdHdhcmVfbGlzdChmNSkKICAgICAgICAgICAgaWYgJ2NlcnRpZmljYXRlJyBpbiBpbmNsdWRlOgogICAgICAgICAgICAgICAgZmFjdHNbJ2NlcnRpZmljYXRlJ10gPSBnZW5lcmF0ZV9jZXJ0aWZpY2F0ZV9kaWN0KGY1LCByZWdleCkKICAgICAgICAgICAgaWYgJ2tleScgaW4gaW5jbHVkZToKICAgICAgICAgICAgICAgIGZhY3RzWydrZXknXSA9IGdlbmVyYXRlX2tleV9kaWN0KGY1LCByZWdleCkKICAgICAgICAgICAgaWYgJ2NsaWVudF9zc2xfcHJvZmlsZScgaW4gaW5jbHVkZToKICAgICAgICAgICAgICAgIGZhY3RzWydjbGllbnRfc3NsX3Byb2ZpbGUnXSA9IGdlbmVyYXRlX2NsaWVudF9zc2xfcHJvZmlsZV9kaWN0KGY1LCByZWdleCkKICAgICAgICAgICAgaWYgJ3N5c3RlbV9pbmZvJyBpbiBpbmNsdWRlOgogICAgICAgICAgICAgICAgZmFjdHNbJ3N5c3RlbV9pbmZvJ10gPSBnZW5lcmF0ZV9zeXN0ZW1faW5mb19kaWN0KGY1KQoKICAgICAgICAgICAgIyByZXN0b3JlIHNhdmVkIHN0YXRlCiAgICAgICAgICAgIGlmIHNhdmVkX2FjdGl2ZV9mb2xkZXIgYW5kIHNhdmVkX2FjdGl2ZV9mb2xkZXIgIT0gIi8iOgogICAgICAgICAgICAgICAgZjUuc2V0X2FjdGl2ZV9mb2xkZXIoc2F2ZWRfYWN0aXZlX2ZvbGRlcikKICAgICAgICAgICAgaWYgc2F2ZWRfcmVjdXJzaXZlX3F1ZXJ5X3N0YXRlIGFuZCBcCiAgICAgICAgICAgICAgIHNhdmVkX3JlY3Vyc2l2ZV9xdWVyeV9zdGF0ZSAhPSAiU1RBVEVfRU5BQkxFRCI6CiAgICAgICAgICAgICAgICBmNS5zZXRfcmVjdXJzaXZlX3F1ZXJ5X3N0YXRlKHNhdmVkX3JlY3Vyc2l2ZV9xdWVyeV9zdGF0ZSkKCiAgICAgICAgcmVzdWx0ID0geydhbnNpYmxlX2ZhY3RzJzogZmFjdHN9CgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIG1vZHVsZS5mYWlsX2pzb24obXNnPSJyZWNlaXZlZCBleGNlcHRpb246ICVzXG50cmFjZWJhY2s6ICVzIiAlIChlLCB0cmFjZWJhY2suZm9ybWF0X2V4YygpKSkKCiAgICBtb2R1bGUuZXhpdF9qc29uKCoqcmVzdWx0KQoKIyBpbmNsdWRlIG1hZ2ljIGZyb20gbGliL2Fuc2libGUvbW9kdWxlX2NvbW1vbi5weQpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmJhc2ljIGltcG9ydCAqCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZjVfdXRpbHMgaW1wb3J0ICoKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICBtYWluKCkKUEsDBBQAAAAAANS7K0s73zmVMIoBADCKAQAdAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvYmFzaWMucHkjIFRoaXMgY29kZSBpcyBwYXJ0IG9mIEFuc2libGUsIGJ1dCBpcyBhbiBpbmRlcGVuZGVudCBjb21wb25lbnQuCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgQ29weXJpZ2h0IChjKSwgTWljaGFlbCBEZUhhYW4gPG1pY2hhZWwuZGVoYWFuQGdtYWlsLmNvbT4sIDIwMTItMjAxMwojIENvcHlyaWdodCAoYyksIFRvc2hpbyBLdXJhdG9taSA8dGt1cmF0b21pQGFuc2libGUuY29tPiAyMDE2CiMgQWxsIHJpZ2h0cyByZXNlcnZlZC4KIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dCBtb2RpZmljYXRpb24sCiMgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAojICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5ECiMgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRUQKIyBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuCiMgSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsCiMgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLAojIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUwojIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QKIyBMSUFCSUxJVFksIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUKIyBVU0UgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwoKQk9PTEVBTlNfVFJVRSA9IFsneScsICd5ZXMnLCAnb24nLCAnMScsICd0cnVlJywgMSwgVHJ1ZV0KQk9PTEVBTlNfRkFMU0UgPSBbJ24nLCAnbm8nLCAnb2ZmJywgJzAnLCAnZmFsc2UnLCAwLCBGYWxzZV0KQk9PTEVBTlMgPSBCT09MRUFOU19UUlVFICsgQk9PTEVBTlNfRkFMU0UKClNJWkVfUkFOR0VTID0geyAnWSc6IDE8PDgwLCAnWic6IDE8PDcwLCAnRSc6IDE8PDYwLCAnUCc6IDE8PDUwLCAnVCc6IDE8PDQwLCAnRyc6IDE8PDMwLCAnTSc6IDE8PDIwLCAnSyc6IDE8PDEwLCAnQic6IDEgfQoKRklMRV9BVFRSSUJVVEVTID0gewogICAgJ0EnOiAnbm9hdGltZScsCiAgICAnYSc6ICdhcHBlbmQnLAogICAgJ2MnOiAnY29tcHJlc3NlZCcsCiAgICAnQyc6ICdub2NvdycsCiAgICAnZCc6ICdub2R1bXAnLAogICAgJ0QnOiAnZGlyc3luYycsCiAgICAnZSc6ICdleHRlbnRzJywKICAgICdFJzogJ2VuY3J5cHRlZCcsCiAgICAnaCc6ICdibG9ja3NpemUnLAogICAgJ2knOiAnaW1tdXRhYmxlJywKICAgICdJJzogJ2luZGV4ZWQnLAogICAgJ2onOiAnam91cm5hbGxlZCcsCiAgICAnTic6ICdpbmxpbmUnLAogICAgJ3MnOiAnemVybycsCiAgICAnUyc6ICdzeW5jaHJvbm91cycsCiAgICAndCc6ICdub3RhaWwnLAogICAgJ1QnOiAnYmxvY2tyb290JywKICAgICd1JzogJ3VuZGVsZXRlJywKICAgICdYJzogJ2NvbXByZXNzZWRyYXcnLAogICAgJ1onOiAnY29tcHJlc3NlZGRpcnR5JywKfQoKIyBhbnNpYmxlIG1vZHVsZXMgY2FuIGJlIHdyaXR0ZW4gaW4gYW55IGxhbmd1YWdlLiAgVG8gc2ltcGxpZnkKIyBkZXZlbG9wbWVudCBvZiBQeXRob24gbW9kdWxlcywgdGhlIGZ1bmN0aW9ucyBhdmFpbGFibGUgaGVyZSBjYW4KIyBiZSB1c2VkIHRvIGRvIG1hbnkgY29tbW9uIHRhc2tzCgppbXBvcnQgbG9jYWxlCmltcG9ydCBvcwppbXBvcnQgcmUKaW1wb3J0IHNobGV4CmltcG9ydCBzdWJwcm9jZXNzCmltcG9ydCBzeXMKaW1wb3J0IHR5cGVzCmltcG9ydCB0aW1lCmltcG9ydCBzZWxlY3QKaW1wb3J0IHNodXRpbAppbXBvcnQgc3RhdAppbXBvcnQgdGVtcGZpbGUKaW1wb3J0IHRyYWNlYmFjawppbXBvcnQgZ3JwCmltcG9ydCBwd2QKaW1wb3J0IHBsYXRmb3JtCmltcG9ydCBlcnJubwppbXBvcnQgZGF0ZXRpbWUKZnJvbSBpdGVydG9vbHMgaW1wb3J0IHJlcGVhdCwgY2hhaW4KCnRyeToKICAgIGltcG9ydCBzeXNsb2cKICAgIEhBU19TWVNMT0c9VHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBIQVNfU1lTTE9HPUZhbHNlCgp0cnk6CiAgICBmcm9tIHN5c3RlbWQgaW1wb3J0IGpvdXJuYWwKICAgIGhhc19qb3VybmFsID0gVHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBoYXNfam91cm5hbCA9IEZhbHNlCgpIQVZFX1NFTElOVVg9RmFsc2UKdHJ5OgogICAgaW1wb3J0IHNlbGludXgKICAgIEhBVkVfU0VMSU5VWD1UcnVlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIHBhc3MKCiMgUHl0aG9uMiAmIDMgd2F5IHRvIGdldCBOb25lVHlwZQpOb25lVHlwZSA9IHR5cGUoTm9uZSkKCnRyeToKICAgIGZyb20gY29sbGVjdGlvbnMgaW1wb3J0IFNlcXVlbmNlLCBNYXBwaW5nCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICMgcHl0aG9uMi41CiAgICBTZXF1ZW5jZSA9IChsaXN0LCB0dXBsZSkKICAgIE1hcHBpbmcgPSAoZGljdCwpCgojIE5vdGU6IFdoZW4gZ2V0dGluZyBTZXF1ZW5jZSBmcm9tIGNvbGxlY3Rpb25zLCBpdCBtYXRjaGVzIHdpdGggc3RyaW5ncy4gIElmCiMgdGhpcyBtYXR0ZXJzLCBtYWtlIHN1cmUgdG8gY2hlY2sgZm9yIHN0cmluZ3MgYmVmb3JlIGNoZWNraW5nIGZvciBzZXF1ZW5jZXR5cGUKdHJ5OgogICAgZnJvbSBjb2xsZWN0aW9ucy5hYmMgaW1wb3J0IEtleXNWaWV3CiAgICBTRVFVRU5DRVRZUEUgPSAoU2VxdWVuY2UsIEtleXNWaWV3KQpleGNlcHQ6CiAgICBTRVFVRU5DRVRZUEUgPSBTZXF1ZW5jZQoKdHJ5OgogICAgaW1wb3J0IGpzb24KICAgICMgRGV0ZWN0IHRoZSBweXRob24tanNvbiBsaWJyYXJ5IHdoaWNoIGlzIGluY29tcGF0aWJsZQogICAgIyBMb29rIGZvciBzaW1wbGVqc29uIGlmIHRoYXQncyB0aGUgY2FzZQogICAgdHJ5OgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGpzb24ubG9hZHMsIHR5cGVzLkZ1bmN0aW9uVHlwZSkgb3Igbm90IGlzaW5zdGFuY2UoanNvbi5kdW1wcywgdHlwZXMuRnVuY3Rpb25UeXBlKToKICAgICAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IKICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICByYWlzZSBJbXBvcnRFcnJvcgpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICB0cnk6CiAgICAgICAgaW1wb3J0IHNpbXBsZWpzb24gYXMganNvbgogICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgIHByaW50KCdcbnsibXNnIjogIkVycm9yOiBhbnNpYmxlIHJlcXVpcmVzIHRoZSBzdGRsaWIganNvbiBvciBzaW1wbGVqc29uIG1vZHVsZSwgbmVpdGhlciB3YXMgZm91bmQhIiwgImZhaWxlZCI6IHRydWV9JykKICAgICAgICBzeXMuZXhpdCgxKQogICAgZXhjZXB0IFN5bnRheEVycm9yOgogICAgICAgIHByaW50KCdcbnsibXNnIjogIlN5bnRheEVycm9yOiBwcm9iYWJseSBkdWUgdG8gaW5zdGFsbGVkIHNpbXBsZWpzb24gYmVpbmcgZm9yIGEgZGlmZmVyZW50IHB5dGhvbiB2ZXJzaW9uIiwgImZhaWxlZCI6IHRydWV9JykKICAgICAgICBzeXMuZXhpdCgxKQoKQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNUyA9IGRpY3QoKQp0cnk6CiAgICBpbXBvcnQgaGFzaGxpYgoKICAgICMgcHl0aG9uIDIuNy45KyBhbmQgMi43LjArCiAgICBmb3IgYXR0cmlidXRlIGluICgnYXZhaWxhYmxlX2FsZ29yaXRobXMnLCAnYWxnb3JpdGhtcycpOgogICAgICAgIGFsZ29yaXRobXMgPSBnZXRhdHRyKGhhc2hsaWIsIGF0dHJpYnV0ZSwgTm9uZSkKICAgICAgICBpZiBhbGdvcml0aG1zOgogICAgICAgICAgICBicmVhawogICAgaWYgYWxnb3JpdGhtcyBpcyBOb25lOgogICAgICAgICMgcHl0aG9uIDIuNSsKICAgICAgICBhbGdvcml0aG1zID0gKCdtZDUnLCAnc2hhMScsICdzaGEyMjQnLCAnc2hhMjU2JywgJ3NoYTM4NCcsICdzaGE1MTInKQogICAgZm9yIGFsZ29yaXRobSBpbiBhbGdvcml0aG1zOgogICAgICAgIEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVNbYWxnb3JpdGhtXSA9IGdldGF0dHIoaGFzaGxpYiwgYWxnb3JpdGhtKQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBpbXBvcnQgc2hhCiAgICBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TID0geydzaGExJzogc2hhLnNoYX0KICAgIHRyeToKICAgICAgICBpbXBvcnQgbWQ1CiAgICAgICAgQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNU1snbWQ1J10gPSBtZDUubWQ1CiAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgcGFzcwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5weWNvbXBhdDI0IGltcG9ydCBnZXRfZXhjZXB0aW9uLCBsaXRlcmFsX2V2YWwKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IChQWTIsIFBZMywgYiwgYmluYXJ5X3R5cGUsIGludGVnZXJfdHlwZXMsCiAgICAgICAgaXRlcml0ZW1zLCB0ZXh0X3R5cGUsIHN0cmluZ190eXBlcykKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXgubW92ZXMgaW1wb3J0IG1hcCwgcmVkdWNlLCBzaGxleF9xdW90ZQpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLl90ZXh0IGltcG9ydCB0b19uYXRpdmUsIHRvX2J5dGVzLCB0b190ZXh0CgpQQVNTV09SRF9NQVRDSCA9IHJlLmNvbXBpbGUocideKD86LitbLV9cc10pP3Bhc3MoPzpbLV9cc10/KD86d29yZHxwaHJhc2V8d3JkfHdkKT8pKD86Wy1fXHNdLispPyQnLCByZS5JKQoKX05VTUJFUlRZUEVTID0gdHVwbGUobGlzdChpbnRlZ2VyX3R5cGVzKSArIFtmbG9hdF0pCgojIERlcHJlY2F0ZWQgY29tcGF0LiAgT25seSBrZXB0IGluIGNhc2UgYW5vdGhlciBtb2R1bGUgdXNlZCB0aGVzZSBuYW1lcyAgVXNpbmcKIyBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaXMgcHJlZmVycmVkCgpOVU1CRVJUWVBFUyA9IF9OVU1CRVJUWVBFUwoKaW1hcCA9IG1hcAoKdHJ5OgogICAgIyBQeXRob24gMgogICAgdW5pY29kZQpleGNlcHQgTmFtZUVycm9yOgogICAgIyBQeXRob24gMwogICAgdW5pY29kZSA9IHRleHRfdHlwZQoKdHJ5OgogICAgIyBQeXRob24gMi42KwogICAgYnl0ZXMKZXhjZXB0IE5hbWVFcnJvcjoKICAgICMgUHl0aG9uIDIuNAogICAgYnl0ZXMgPSBiaW5hcnlfdHlwZQoKdHJ5OgogICAgIyBQeXRob24gMgogICAgYmFzZXN0cmluZwpleGNlcHQgTmFtZUVycm9yOgogICAgIyBQeXRob24gMwogICAgYmFzZXN0cmluZyA9IHN0cmluZ190eXBlcwoKX2xpdGVyYWxfZXZhbCA9IGxpdGVyYWxfZXZhbAoKIyBFbmQgb2YgZGVwcmVjYXRlZCBuYW1lcwoKIyBJbnRlcm5hbCBnbG9iYWwgaG9sZGluZyBwYXNzZWQgaW4gcGFyYW1zLiAgVGhpcyBpcyBjb25zdWx0ZWQgaW4gY2FzZQojIG11bHRpcGxlIEFuc2libGVNb2R1bGVzIGFyZSBjcmVhdGVkLiAgT3RoZXJ3aXNlIGVhY2ggQW5zaWJsZU1vZHVsZSB3b3VsZAojIGF0dGVtcHQgdG8gcmVhZCBmcm9tIHN0ZGluLiAgT3RoZXIgY29kZSBzaG91bGQgbm90IHVzZSB0aGlzIGRpcmVjdGx5IGFzIGl0CiMgaXMgYW4gaW50ZXJuYWwgaW1wbGVtZW50YXRpb24gZGV0YWlsCl9BTlNJQkxFX0FSR1MgPSBOb25lCgpGSUxFX0NPTU1PTl9BUkdVTUVOVFM9ZGljdCgKICAgIHNyYyA9IGRpY3QoKSwKICAgIG1vZGUgPSBkaWN0KHR5cGU9J3JhdycpLAogICAgb3duZXIgPSBkaWN0KCksCiAgICBncm91cCA9IGRpY3QoKSwKICAgIHNldXNlciA9IGRpY3QoKSwKICAgIHNlcm9sZSA9IGRpY3QoKSwKICAgIHNlbGV2ZWwgPSBkaWN0KCksCiAgICBzZXR5cGUgPSBkaWN0KCksCiAgICBmb2xsb3cgPSBkaWN0KHR5cGU9J2Jvb2wnLCBkZWZhdWx0PUZhbHNlKSwKICAgICMgbm90IHRha2VuIGJ5IHRoZSBmaWxlIG1vZHVsZSwgYnV0IG90aGVyIG1vZHVsZXMgY2FsbCBmaWxlIHNvIGl0IG11c3QgaWdub3JlIHRoZW0uCiAgICBjb250ZW50ID0gZGljdChub19sb2c9VHJ1ZSksCiAgICBiYWNrdXAgPSBkaWN0KCksCiAgICBmb3JjZSA9IGRpY3QoKSwKICAgIHJlbW90ZV9zcmMgPSBkaWN0KCksICMgdXNlZCBieSBhc3NlbWJsZQogICAgcmVnZXhwID0gZGljdCgpLCAjIHVzZWQgYnkgYXNzZW1ibGUKICAgIGRlbGltaXRlciA9IGRpY3QoKSwgIyB1c2VkIGJ5IGFzc2VtYmxlCiAgICBkaXJlY3RvcnlfbW9kZSA9IGRpY3QoKSwgIyB1c2VkIGJ5IGNvcHkKICAgIHVuc2FmZV93cml0ZXMgID0gZGljdCh0eXBlPSdib29sJyksICMgc2hvdWxkIGJlIGF2YWlsYWJsZSB0byBhbnkgbW9kdWxlIHVzaW5nIGF0b21pY19tb3ZlCiAgICBhdHRyaWJ1dGVzID0gZGljdChhbGlhc2VzPVsnYXR0ciddKSwKKQoKUEFTU1dEX0FSR19SRSA9IHJlLmNvbXBpbGUocideWy1dezAsMn1wYXNzWy1dPyh3b3JkfHdkKT8nKQoKIyBDYW4ndCB1c2UgMDc3Nzcgb24gUHl0aG9uIDMsIGNhbid0IHVzZSAwbzc3Nzcgb24gUHl0aG9uIDIuNApQRVJNX0JJVFMgPSBpbnQoJzA3Nzc3JywgOCkgICAgICAjIGZpbGUgbW9kZSBwZXJtaXNzaW9uIGJpdHMKRVhFQ19QRVJNX0JJVFMgPSBpbnQoJzAwMTExJywgOCkgIyBleGVjdXRlIHBlcm1pc3Npb24gYml0cwpERUZBVUxUX1BFUk0gPSBpbnQoJzA2NjYnLCA4KSAgICAjIGRlZmF1bHQgZmlsZSBwZXJtaXNzaW9uIGJpdHMKCgpkZWYgZ2V0X3BsYXRmb3JtKCk6CiAgICAnJycgd2hhdCdzIHRoZSBwbGF0Zm9ybT8gIGV4YW1wbGU6IExpbnV4IGlzIGEgcGxhdGZvcm0uICcnJwogICAgcmV0dXJuIHBsYXRmb3JtLnN5c3RlbSgpCgpkZWYgZ2V0X2Rpc3RyaWJ1dGlvbigpOgogICAgJycnIHJldHVybiB0aGUgZGlzdHJpYnV0aW9uIG5hbWUgJycnCiAgICBpZiBwbGF0Zm9ybS5zeXN0ZW0oKSA9PSAnTGludXgnOgogICAgICAgIHRyeToKICAgICAgICAgICAgc3VwcG9ydGVkX2Rpc3RzID0gcGxhdGZvcm0uX3N1cHBvcnRlZF9kaXN0cyArICgnYXJjaCcsJ2FscGluZScpCiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9IHBsYXRmb3JtLmxpbnV4X2Rpc3RyaWJ1dGlvbihzdXBwb3J0ZWRfZGlzdHM9c3VwcG9ydGVkX2Rpc3RzKVswXS5jYXBpdGFsaXplKCkKICAgICAgICAgICAgaWYgbm90IGRpc3RyaWJ1dGlvbiBhbmQgb3MucGF0aC5pc2ZpbGUoJy9ldGMvc3lzdGVtLXJlbGVhc2UnKToKICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9IHBsYXRmb3JtLmxpbnV4X2Rpc3RyaWJ1dGlvbihzdXBwb3J0ZWRfZGlzdHM9WydzeXN0ZW0nXSlbMF0uY2FwaXRhbGl6ZSgpCiAgICAgICAgICAgICAgICBpZiAnQW1hem9uJyBpbiBkaXN0cmlidXRpb246CiAgICAgICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gJ0FtYXpvbicKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gJ090aGVyTGludXgnCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAjIEZJWE1FOiBNZXRob2RNaXNzaW5nLCBJIGFzc3VtZT8KICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gcGxhdGZvcm0uZGlzdCgpWzBdLmNhcGl0YWxpemUoKQogICAgZWxzZToKICAgICAgICBkaXN0cmlidXRpb24gPSBOb25lCiAgICByZXR1cm4gZGlzdHJpYnV0aW9uCgpkZWYgZ2V0X2Rpc3RyaWJ1dGlvbl92ZXJzaW9uKCk6CiAgICAnJycgcmV0dXJuIHRoZSBkaXN0cmlidXRpb24gdmVyc2lvbiAnJycKICAgIGlmIHBsYXRmb3JtLnN5c3RlbSgpID09ICdMaW51eCc6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IHBsYXRmb3JtLmxpbnV4X2Rpc3RyaWJ1dGlvbigpWzFdCiAgICAgICAgICAgIGlmIG5vdCBkaXN0cmlidXRpb25fdmVyc2lvbiBhbmQgb3MucGF0aC5pc2ZpbGUoJy9ldGMvc3lzdGVtLXJlbGVhc2UnKToKICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbl92ZXJzaW9uID0gcGxhdGZvcm0ubGludXhfZGlzdHJpYnV0aW9uKHN1cHBvcnRlZF9kaXN0cz1bJ3N5c3RlbSddKVsxXQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgIyBGSVhNRTogTWV0aG9kTWlzc2luZywgSSBhc3N1bWU/CiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbl92ZXJzaW9uID0gcGxhdGZvcm0uZGlzdCgpWzFdCiAgICBlbHNlOgogICAgICAgIGRpc3RyaWJ1dGlvbl92ZXJzaW9uID0gTm9uZQogICAgcmV0dXJuIGRpc3RyaWJ1dGlvbl92ZXJzaW9uCgpkZWYgZ2V0X2FsbF9zdWJjbGFzc2VzKGNscyk6CiAgICAnJycKICAgIHVzZWQgYnkgbW9kdWxlcyBsaWtlIEhhcmR3YXJlIG9yIE5ldHdvcmsgZmFjdCBjbGFzc2VzIHRvIHJldHJpZXZlIGFsbCBzdWJjbGFzc2VzIG9mIGEgZ2l2ZW4gY2xhc3MuCiAgICBfX3N1YmNsYXNzZXNfXyByZXR1cm4gb25seSBkaXJlY3Qgc3ViIGNsYXNzZXMuIFRoaXMgb25lIGdvIGRvd24gaW50byB0aGUgY2xhc3MgdHJlZS4KICAgICcnJwogICAgIyBSZXRyaWV2ZSBkaXJlY3Qgc3ViY2xhc3NlcwogICAgc3ViY2xhc3NlcyA9IGNscy5fX3N1YmNsYXNzZXNfXygpCiAgICB0b192aXNpdCA9IGxpc3Qoc3ViY2xhc3NlcykKICAgICMgVGhlbiB2aXNpdCBhbGwgc3ViY2xhc3NlcwogICAgd2hpbGUgdG9fdmlzaXQ6CiAgICAgICAgZm9yIHNjIGluIHRvX3Zpc2l0OgogICAgICAgICAgICAjIFRoZSBjdXJyZW50IGNsYXNzIGlzIG5vdyB2aXNpdGVkLCBzbyByZW1vdmUgaXQgZnJvbSBsaXN0CiAgICAgICAgICAgIHRvX3Zpc2l0LnJlbW92ZShzYykKICAgICAgICAgICAgIyBBcHBlbmRpbmcgYWxsIHN1YmNsYXNzZXMgdG8gdmlzaXQgYW5kIGtlZXAgYSByZWZlcmVuY2Ugb2YgYXZhaWxhYmxlIGNsYXNzCiAgICAgICAgICAgIGZvciBzc2MgaW4gc2MuX19zdWJjbGFzc2VzX18oKToKICAgICAgICAgICAgICAgIHN1YmNsYXNzZXMuYXBwZW5kKHNzYykKICAgICAgICAgICAgICAgIHRvX3Zpc2l0LmFwcGVuZChzc2MpCiAgICByZXR1cm4gc3ViY2xhc3NlcwoKCmRlZiBsb2FkX3BsYXRmb3JtX3N1YmNsYXNzKGNscywgKmFyZ3MsICoqa3dhcmdzKToKICAgICcnJwogICAgdXNlZCBieSBtb2R1bGVzIGxpa2UgVXNlciB0byBoYXZlIGRpZmZlcmVudCBpbXBsZW1lbnRhdGlvbnMgYmFzZWQgb24gZGV0ZWN0ZWQgcGxhdGZvcm0uICBTZWUgVXNlcgogICAgbW9kdWxlIGZvciBhbiBleGFtcGxlLgogICAgJycnCgogICAgdGhpc19wbGF0Zm9ybSA9IGdldF9wbGF0Zm9ybSgpCiAgICBkaXN0cmlidXRpb24gPSBnZXRfZGlzdHJpYnV0aW9uKCkKICAgIHN1YmNsYXNzID0gTm9uZQoKICAgICMgZ2V0IHRoZSBtb3N0IHNwZWNpZmljIHN1cGVyY2xhc3MgZm9yIHRoaXMgcGxhdGZvcm0KICAgIGlmIGRpc3RyaWJ1dGlvbiBpcyBub3QgTm9uZToKICAgICAgICBmb3Igc2MgaW4gZ2V0X2FsbF9zdWJjbGFzc2VzKGNscyk6CiAgICAgICAgICAgIGlmIHNjLmRpc3RyaWJ1dGlvbiBpcyBub3QgTm9uZSBhbmQgc2MuZGlzdHJpYnV0aW9uID09IGRpc3RyaWJ1dGlvbiBhbmQgc2MucGxhdGZvcm0gPT0gdGhpc19wbGF0Zm9ybToKICAgICAgICAgICAgICAgIHN1YmNsYXNzID0gc2MKICAgIGlmIHN1YmNsYXNzIGlzIE5vbmU6CiAgICAgICAgZm9yIHNjIGluIGdldF9hbGxfc3ViY2xhc3NlcyhjbHMpOgogICAgICAgICAgICBpZiBzYy5wbGF0Zm9ybSA9PSB0aGlzX3BsYXRmb3JtIGFuZCBzYy5kaXN0cmlidXRpb24gaXMgTm9uZToKICAgICAgICAgICAgICAgIHN1YmNsYXNzID0gc2MKICAgIGlmIHN1YmNsYXNzIGlzIE5vbmU6CiAgICAgICAgc3ViY2xhc3MgPSBjbHMKCiAgICByZXR1cm4gc3VwZXIoY2xzLCBzdWJjbGFzcykuX19uZXdfXyhzdWJjbGFzcykKCgpkZWYganNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMoZCwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0Jyk6CiAgICAnJycgUmVjdXJzaXZlbHkgY29udmVydCBkaWN0IGtleXMgYW5kIHZhbHVlcyB0byBieXRlIHN0cgoKICAgICAgICBTcGVjaWFsaXplZCBmb3IganNvbiByZXR1cm4gYmVjYXVzZSB0aGlzIG9ubHkgaGFuZGxlcywgbGlzdHMsIHR1cGxlcywKICAgICAgICBhbmQgZGljdCBjb250YWluZXIgdHlwZXMgKHRoZSBjb250YWluZXJzIHRoYXQgdGhlIGpzb24gbW9kdWxlIHJldHVybnMpCiAgICAnJycKCiAgICBpZiBpc2luc3RhbmNlKGQsIHRleHRfdHlwZSk6CiAgICAgICAgcmV0dXJuIHRvX2J5dGVzKGQsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIGRpY3QpOgogICAgICAgIHJldHVybiBkaWN0KG1hcChqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcywgaXRlcml0ZW1zKGQpLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgbGlzdCk6CiAgICAgICAgcmV0dXJuIGxpc3QobWFwKGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzLCBkLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgdHVwbGUpOgogICAgICAgIHJldHVybiB0dXBsZShtYXAoanNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMsIGQsIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIGQKCmRlZiBqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZShkLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKToKICAgICcnJyBSZWN1cnNpdmVseSBjb252ZXJ0IGRpY3Qga2V5cyBhbmQgdmFsdWVzIHRvIGJ5dGUgc3RyCgogICAgICAgIFNwZWNpYWxpemVkIGZvciBqc29uIHJldHVybiBiZWNhdXNlIHRoaXMgb25seSBoYW5kbGVzLCBsaXN0cywgdHVwbGVzLAogICAgICAgIGFuZCBkaWN0IGNvbnRhaW5lciB0eXBlcyAodGhlIGNvbnRhaW5lcnMgdGhhdCB0aGUganNvbiBtb2R1bGUgcmV0dXJucykKICAgICcnJwoKICAgIGlmIGlzaW5zdGFuY2UoZCwgYmluYXJ5X3R5cGUpOgogICAgICAgICMgV2FybmluZywgY2FuIHRyYWNlYmFjawogICAgICAgIHJldHVybiB0b190ZXh0KGQsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIGRpY3QpOgogICAgICAgIHJldHVybiBkaWN0KG1hcChqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZSwgaXRlcml0ZW1zKGQpLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgbGlzdCk6CiAgICAgICAgcmV0dXJuIGxpc3QobWFwKGpzb25fZGljdF9ieXRlc190b191bmljb2RlLCBkLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgdHVwbGUpOgogICAgICAgIHJldHVybiB0dXBsZShtYXAoanNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUsIGQsIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIGQKCmRlZiByZXR1cm5fdmFsdWVzKG9iaik6CiAgICAiIiIgUmV0dXJuIG5hdGl2ZSBzdHJpbmdpZmllZCB2YWx1ZXMgZnJvbSBkYXRhc3RydWN0dXJlcy4KCiAgICBGb3IgdXNlIHdpdGggcmVtb3Zpbmcgc2Vuc2l0aXZlIHZhbHVlcyBwcmUtanNvbmlmaWNhdGlvbi4iIiIKICAgIGlmIGlzaW5zdGFuY2Uob2JqLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgIGlmIG9iajoKICAgICAgICAgICAgeWllbGQgdG9fbmF0aXZlKG9iaiwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICByZXR1cm4KICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIFNFUVVFTkNFVFlQRSk6CiAgICAgICAgZm9yIGVsZW1lbnQgaW4gb2JqOgogICAgICAgICAgICBmb3Igc3ViZWxlbWVudCBpbiByZXR1cm5fdmFsdWVzKGVsZW1lbnQpOgogICAgICAgICAgICAgICAgeWllbGQgc3ViZWxlbWVudAogICAgZWxpZiBpc2luc3RhbmNlKG9iaiwgTWFwcGluZyk6CiAgICAgICAgZm9yIGVsZW1lbnQgaW4gb2JqLml0ZW1zKCk6CiAgICAgICAgICAgIGZvciBzdWJlbGVtZW50IGluIHJldHVybl92YWx1ZXMoZWxlbWVudFsxXSk6CiAgICAgICAgICAgICAgICB5aWVsZCBzdWJlbGVtZW50CiAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCAoYm9vbCwgTm9uZVR5cGUpKToKICAgICAgICAjIFRoaXMgbXVzdCBjb21lIGJlZm9yZSBpbnQgYmVjYXVzZSBib29scyBhcmUgYWxzbyBpbnRzCiAgICAgICAgcmV0dXJuCiAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCBOVU1CRVJUWVBFUyk6CiAgICAgICAgeWllbGQgdG9fbmF0aXZlKG9iaiwgbm9uc3RyaW5nPSdzaW1wbGVyZXByJykKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdVbmtub3duIHBhcmFtZXRlciB0eXBlOiAlcywgJXMnICUgKHR5cGUob2JqKSwgb2JqKSkKCmRlZiByZW1vdmVfdmFsdWVzKHZhbHVlLCBub19sb2dfc3RyaW5ncyk6CiAgICAiIiIgUmVtb3ZlIHN0cmluZ3MgaW4gbm9fbG9nX3N0cmluZ3MgZnJvbSB2YWx1ZS4gIElmIHZhbHVlIGlzIGEgY29udGFpbmVyCiAgICB0eXBlLCB0aGVuIHJlbW92ZSBhIGxvdCBtb3JlIiIiCiAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgICMgTmVlZCBuYXRpdmUgc3RyIHR5cGUKICAgICAgICBuYXRpdmVfc3RyX3ZhbHVlID0gdmFsdWUKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICB2YWx1ZV9pc190ZXh0ID0gVHJ1ZQogICAgICAgICAgICBpZiBQWTI6CiAgICAgICAgICAgICAgICBuYXRpdmVfc3RyX3ZhbHVlID0gdG9fYnl0ZXModmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgIHZhbHVlX2lzX3RleHQgPSBGYWxzZQogICAgICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgICAgICBuYXRpdmVfc3RyX3ZhbHVlID0gdG9fdGV4dCh2YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKCiAgICAgICAgaWYgbmF0aXZlX3N0cl92YWx1ZSBpbiBub19sb2dfc3RyaW5nczoKICAgICAgICAgICAgcmV0dXJuICdWQUxVRV9TUEVDSUZJRURfSU5fTk9fTE9HX1BBUkFNRVRFUicKICAgICAgICBmb3Igb21pdF9tZSBpbiBub19sb2dfc3RyaW5nczoKICAgICAgICAgICAgbmF0aXZlX3N0cl92YWx1ZSA9IG5hdGl2ZV9zdHJfdmFsdWUucmVwbGFjZShvbWl0X21lLCAnKicgKiA4KQoKICAgICAgICBpZiB2YWx1ZV9pc190ZXh0IGFuZCBpc2luc3RhbmNlKG5hdGl2ZV9zdHJfdmFsdWUsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgdmFsdWUgPSB0b190ZXh0KG5hdGl2ZV9zdHJfdmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fcmVwbGFjZScpCiAgICAgICAgZWxpZiBub3QgdmFsdWVfaXNfdGV4dCBhbmQgaXNpbnN0YW5jZShuYXRpdmVfc3RyX3ZhbHVlLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICB2YWx1ZSA9IHRvX2J5dGVzKG5hdGl2ZV9zdHJfdmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fcmVwbGFjZScpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdmFsdWUgPSBuYXRpdmVfc3RyX3ZhbHVlCiAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIFNFUVVFTkNFVFlQRSk6CiAgICAgICAgcmV0dXJuIFtyZW1vdmVfdmFsdWVzKGVsZW0sIG5vX2xvZ19zdHJpbmdzKSBmb3IgZWxlbSBpbiB2YWx1ZV0KICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgTWFwcGluZyk6CiAgICAgICAgcmV0dXJuIGRpY3QoKGssIHJlbW92ZV92YWx1ZXModiwgbm9fbG9nX3N0cmluZ3MpKSBmb3IgaywgdiBpbiB2YWx1ZS5pdGVtcygpKQogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCB0dXBsZShjaGFpbihOVU1CRVJUWVBFUywgKGJvb2wsIE5vbmVUeXBlKSkpKToKICAgICAgICBzdHJpbmd5X3ZhbHVlID0gdG9fbmF0aXZlKHZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGlmIHN0cmluZ3lfdmFsdWUgaW4gbm9fbG9nX3N0cmluZ3M6CiAgICAgICAgICAgIHJldHVybiAnVkFMVUVfU1BFQ0lGSUVEX0lOX05PX0xPR19QQVJBTUVURVInCiAgICAgICAgZm9yIG9taXRfbWUgaW4gbm9fbG9nX3N0cmluZ3M6CiAgICAgICAgICAgIGlmIG9taXRfbWUgaW4gc3RyaW5neV92YWx1ZToKICAgICAgICAgICAgICAgIHJldHVybiAnVkFMVUVfU1BFQ0lGSUVEX0lOX05PX0xPR19QQVJBTUVURVInCiAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICB2YWx1ZSA9IHZhbHVlLmlzb2Zvcm1hdCgpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignVmFsdWUgb2YgdW5rbm93biB0eXBlOiAlcywgJXMnICUgKHR5cGUodmFsdWUpLCB2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWUKCgpkZWYgaGV1cmlzdGljX2xvZ19zYW5pdGl6ZShkYXRhLCBub19sb2dfdmFsdWVzPU5vbmUpOgogICAgJycnIFJlbW92ZSBzdHJpbmdzIHRoYXQgbG9vayBsaWtlIHBhc3N3b3JkcyBmcm9tIGxvZyBtZXNzYWdlcyAnJycKICAgICMgQ3VycmVudGx5IGZpbHRlcnM6CiAgICAjIHVzZXI6cGFzc0Bmb28vd2hhdGV2ZXIgYW5kIGh0dHA6Ly91c2VybmFtZTpwYXNzQHdoZXJldmVyL2ZvbwogICAgIyBUaGlzIGNvZGUgaGFzIGZhbHNlIHBvc2l0aXZlcyBhbmQgY29uc3VtZXMgcGFydHMgb2YgbG9ncyB0aGF0IGFyZQogICAgIyBub3QgcGFzc3dkcwoKICAgICMgYmVnaW46IHN0YXJ0IG9mIGEgcGFzc3dkIGNvbnRhaW5pbmcgc3RyaW5nCiAgICAjIGVuZDogZW5kIG9mIGEgcGFzc3dkIGNvbnRhaW5pbmcgc3RyaW5nCiAgICAjIHNlcDogY2hhciBiZXR3ZWVuIHVzZXIgYW5kIHBhc3N3ZAogICAgIyBwcmV2X2JlZ2luOiB3aGVyZSBpbiB0aGUgb3ZlcmFsbCBzdHJpbmcgdG8gc3RhcnQgYSBzZWFyY2ggZm9yCiAgICAjICAgYSBwYXNzd2QKICAgICMgc2VwX3NlYXJjaF9lbmQ6IHdoZXJlIGluIHRoZSBzdHJpbmcgdG8gZW5kIGEgc2VhcmNoIGZvciB0aGUgc2VwCiAgICBkYXRhID0gdG9fbmF0aXZlKGRhdGEpCgogICAgb3V0cHV0ID0gW10KICAgIGJlZ2luID0gbGVuKGRhdGEpCiAgICBwcmV2X2JlZ2luID0gYmVnaW4KICAgIHNlcCA9IDEKICAgIHdoaWxlIHNlcDoKICAgICAgICAjIEZpbmQgdGhlIHBvdGVudGlhbCBlbmQgb2YgYSBwYXNzd2QKICAgICAgICB0cnk6CiAgICAgICAgICAgIGVuZCA9IGRhdGEucmluZGV4KCdAJywgMCwgYmVnaW4pCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICMgTm8gcGFzc3dkIGluIHRoZSByZXN0IG9mIHRoZSBkYXRhCiAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgZGF0YVswOmJlZ2luXSkKICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgIyBTZWFyY2ggZm9yIHRoZSBiZWdpbm5pbmcgb2YgYSBwYXNzd2QKICAgICAgICBzZXAgPSBOb25lCiAgICAgICAgc2VwX3NlYXJjaF9lbmQgPSBlbmQKICAgICAgICB3aGlsZSBub3Qgc2VwOgogICAgICAgICAgICAjIFVSTC1zdHlsZSB1c2VybmFtZStwYXNzd29yZAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBiZWdpbiA9IGRhdGEucmluZGV4KCc6Ly8nLCAwLCBzZXBfc2VhcmNoX2VuZCkKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAjIE5vIHVybCBzdHlsZSBpbiB0aGUgZGF0YSwgY2hlY2sgZm9yIHNzaCBzdHlsZSBpbiB0aGUKICAgICAgICAgICAgICAgICMgcmVzdCBvZiB0aGUgc3RyaW5nCiAgICAgICAgICAgICAgICBiZWdpbiA9IDAKICAgICAgICAgICAgIyBTZWFyY2ggZm9yIHNlcGFyYXRvcgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZXAgPSBkYXRhLmluZGV4KCc6JywgYmVnaW4gKyAzLCBlbmQpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgIyBObyBzZXBhcmF0b3I7IGNob2ljZXM6CiAgICAgICAgICAgICAgICBpZiBiZWdpbiA9PSAwOgogICAgICAgICAgICAgICAgICAgICMgU2VhcmNoZWQgdGhlIHdob2xlIHN0cmluZyBzbyB0aGVyZSdzIG5vIHBhc3N3b3JkCiAgICAgICAgICAgICAgICAgICAgIyBoZXJlLiAgUmV0dXJuIHRoZSByZW1haW5pbmcgZGF0YQogICAgICAgICAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgZGF0YVswOmJlZ2luXSkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgIyBTZWFyY2ggZm9yIGEgZGlmZmVyZW50IGJlZ2lubmluZyBvZiB0aGUgcGFzc3dvcmQgZmllbGQuCiAgICAgICAgICAgICAgICBzZXBfc2VhcmNoX2VuZCA9IGJlZ2luCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgIGlmIHNlcDoKICAgICAgICAgICAgIyBQYXNzd29yZCB3YXMgZm91bmQ7IHJlbW92ZSBpdC4KICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCBkYXRhW2VuZDpwcmV2X2JlZ2luXSkKICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCAnKioqKioqKionKQogICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsIGRhdGFbYmVnaW46c2VwICsgMV0pCiAgICAgICAgICAgIHByZXZfYmVnaW4gPSBiZWdpbgoKICAgIG91dHB1dCA9ICcnLmpvaW4ob3V0cHV0KQogICAgaWYgbm9fbG9nX3ZhbHVlczoKICAgICAgICBvdXRwdXQgPSByZW1vdmVfdmFsdWVzKG91dHB1dCwgbm9fbG9nX3ZhbHVlcykKICAgIHJldHVybiBvdXRwdXQKCmRlZiBieXRlc190b19odW1hbihzaXplLCBpc2JpdHM9RmFsc2UsIHVuaXQ9Tm9uZSk6CgogICAgYmFzZSA9ICdCeXRlcycKICAgIGlmIGlzYml0czoKICAgICAgICBiYXNlID0gJ2JpdHMnCiAgICBzdWZmaXggPSAnJwoKICAgIGZvciBzdWZmaXgsIGxpbWl0IGluIHNvcnRlZChpdGVyaXRlbXMoU0laRV9SQU5HRVMpLCBrZXk9bGFtYmRhIGl0ZW06IC1pdGVtWzFdKToKICAgICAgICBpZiAodW5pdCBpcyBOb25lIGFuZCBzaXplID49IGxpbWl0KSBvciB1bml0IGlzIG5vdCBOb25lIGFuZCB1bml0LnVwcGVyKCkgPT0gc3VmZml4WzBdOgogICAgICAgICAgICBicmVhawoKICAgIGlmIGxpbWl0ICE9IDE6CiAgICAgICAgc3VmZml4ICs9IGJhc2VbMF0KICAgIGVsc2U6CiAgICAgICAgc3VmZml4ID0gYmFzZQoKICAgIHJldHVybiAnJS4yZiAlcycgJSAoZmxvYXQoc2l6ZSkvIGxpbWl0LCBzdWZmaXgpCgpkZWYgaHVtYW5fdG9fYnl0ZXMobnVtYmVyLCBkZWZhdWx0X3VuaXQ9Tm9uZSwgaXNiaXRzPUZhbHNlKToKCiAgICAnJycKICAgIENvbnZlcnQgbnVtYmVyIGluIHN0cmluZyBmb3JtYXQgaW50byBieXRlcyAoZXg6ICcySycgPT4gMjA0OCkgb3IgdXNpbmcgdW5pdCBhcmd1bWVudAogICAgZXg6CiAgICAgIGh1bWFuX3RvX2J5dGVzKCcxME0nKSA8PT4gaHVtYW5fdG9fYnl0ZXMoMTAsICdNJykKICAgICcnJwogICAgbSA9IHJlLnNlYXJjaCgnXlxzKihcZCpcLj9cZCopXHMqKFtBLVphLXpdKyk/Jywgc3RyKG51bWJlciksIGZsYWdzPXJlLklHTk9SRUNBU0UpCiAgICBpZiBtIGlzIE5vbmU6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaHVtYW5fdG9fYnl0ZXMoKSBjYW4ndCBpbnRlcnByZXQgZm9sbG93aW5nIHN0cmluZzogJXMiICUgc3RyKG51bWJlcikpCiAgICB0cnk6CiAgICAgICAgbnVtID0gZmxvYXQobS5ncm91cCgxKSkKICAgIGV4Y2VwdDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJodW1hbl90b19ieXRlcygpIGNhbid0IGludGVycHJldCBmb2xsb3dpbmcgbnVtYmVyOiAlcyAob3JpZ2luYWwgaW5wdXQgc3RyaW5nOiAlcykiICUgKG0uZ3JvdXAoMSksIG51bWJlcikpCgogICAgdW5pdCA9IG0uZ3JvdXAoMikKICAgIGlmIHVuaXQgaXMgTm9uZToKICAgICAgICB1bml0ID0gZGVmYXVsdF91bml0CgogICAgaWYgdW5pdCBpcyBOb25lOgogICAgICAgICcnJyBObyB1bml0IGdpdmVuLCByZXR1cm5pbmcgcmF3IG51bWJlciAnJycKICAgICAgICByZXR1cm4gaW50KHJvdW5kKG51bSkpCiAgICByYW5nZV9rZXkgPSB1bml0WzBdLnVwcGVyKCkKICAgIHRyeToKICAgICAgICBsaW1pdCA9IFNJWkVfUkFOR0VTW3JhbmdlX2tleV0KICAgIGV4Y2VwdDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJodW1hbl90b19ieXRlcygpIGZhaWxlZCB0byBjb252ZXJ0ICVzICh1bml0ID0gJXMpLiBUaGUgc3VmZml4IG11c3QgYmUgb25lIG9mICVzIiAlIChudW1iZXIsIHVuaXQsICIsICIuam9pbihTSVpFX1JBTkdFUy5rZXlzKCkpKSkKCiAgICAjIGRlZmF1bHQgdmFsdWUKICAgIHVuaXRfY2xhc3MgPSAnQicKICAgIHVuaXRfY2xhc3NfbmFtZSA9ICdieXRlJwogICAgIyBoYW5kbGluZyBiaXRzIGNhc2UKICAgIGlmIGlzYml0czoKICAgICAgICB1bml0X2NsYXNzID0gJ2InCiAgICAgICAgdW5pdF9jbGFzc19uYW1lID0gJ2JpdCcKICAgICMgY2hlY2sgdW5pdCB2YWx1ZSBpZiBtb3JlIHRoYW4gb25lIGNoYXJhY3RlciAoS0IsIE1CKQogICAgaWYgbGVuKHVuaXQpID4gMToKICAgICAgICBleHBlY3RfbWVzc2FnZSA9ICdleHBlY3QgJXMlcyBvciAlcycgJSAocmFuZ2Vfa2V5LCB1bml0X2NsYXNzLCByYW5nZV9rZXkpCiAgICAgICAgaWYgcmFuZ2Vfa2V5ID09ICdCJzoKICAgICAgICAgICAgZXhwZWN0X21lc3NhZ2UgPSAnZXhwZWN0ICVzIG9yICVzJyAlICh1bml0X2NsYXNzLCB1bml0X2NsYXNzX25hbWUpCgogICAgICAgIGlmIHVuaXRfY2xhc3NfbmFtZSBpbiB1bml0Lmxvd2VyKCk6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBlbGlmIHVuaXRbMV0gIT0gdW5pdF9jbGFzczoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaHVtYW5fdG9fYnl0ZXMoKSBmYWlsZWQgdG8gY29udmVydCAlcy4gVmFsdWUgaXMgbm90IGEgdmFsaWQgc3RyaW5nICglcykiICUgKG51bWJlciwgZXhwZWN0X21lc3NhZ2UpKQoKICAgIHJldHVybiBpbnQocm91bmQobnVtICogbGltaXQpKQoKZGVmIGlzX2V4ZWN1dGFibGUocGF0aCk6CiAgICAnJydpcyB0aGUgZ2l2ZW4gcGF0aCBleGVjdXRhYmxlPwoKICAgIExpbWl0YXRpb25zOgogICAgKiBEb2VzIG5vdCBhY2NvdW50IGZvciBGU0FDTHMuCiAgICAqIE1vc3QgdGltZXMgd2UgcmVhbGx5IHdhbnQgdG8ga25vdyAiQ2FuIHRoZSBjdXJyZW50IHVzZXIgZXhlY3V0ZSB0aGlzCiAgICAgIGZpbGUiICBUaGlzIGZ1bmN0aW9uIGRvZXMgbm90IHRlbGwgdXMgdGhhdCwgb25seSBpZiBhbiBleGVjdXRlIGJpdCBpcyBzZXQuCiAgICAnJycKICAgICMgVGhlc2UgYXJlIGFsbCBiaXRmaWVsZHMgc28gZmlyc3QgYml0d2lzZS1vciBhbGwgdGhlIHBlcm1pc3Npb25zIHdlJ3JlCiAgICAjIGxvb2tpbmcgZm9yLCB0aGVuIGJpdHdpc2UtYW5kIHdpdGggdGhlIGZpbGUncyBtb2RlIHRvIGRldGVybWluZSBpZiBhbnkKICAgICMgZXhlY3V0ZSBiaXRzIGFyZSBzZXQuCiAgICByZXR1cm4gKChzdGF0LlNfSVhVU1IgfCBzdGF0LlNfSVhHUlAgfCBzdGF0LlNfSVhPVEgpICYgb3Muc3RhdChwYXRoKVtzdGF0LlNUX01PREVdKQoKZGVmIF9sb2FkX3BhcmFtcygpOgogICAgJycnIHJlYWQgdGhlIG1vZHVsZXMgcGFyYW1ldGVycyBhbmQgc3RvcmUgdGhlbSBnbG9iYWxseS4KCiAgICBUaGlzIGZ1bmN0aW9uIG1heSBiZSBuZWVkZWQgZm9yIGNlcnRhaW4gdmVyeSBkeW5hbWljIGN1c3RvbSBtb2R1bGVzIHdoaWNoCiAgICB3YW50IHRvIHByb2Nlc3MgdGhlIHBhcmFtZXRlcnMgdGhhdCBhcmUgYmVpbmcgaGFuZGVkIHRoZSBtb2R1bGUuICBTaW5jZQogICAgdGhpcyBpcyBzbyBjbG9zZWx5IHRpZWQgdG8gdGhlIGltcGxlbWVudGF0aW9uIG9mIG1vZHVsZXMgd2UgY2Fubm90CiAgICBndWFyYW50ZWUgQVBJIHN0YWJpbGl0eSBmb3IgaXQgKGl0IG1heSBjaGFuZ2UgYmV0d2VlbiB2ZXJzaW9ucykgaG93ZXZlciB3ZQogICAgd2lsbCB0cnkgbm90IHRvIGJyZWFrIGl0IGdyYXR1aXRvdXNseS4gIEl0IGlzIGNlcnRhaW5seSBtb3JlIGZ1dHVyZS1wcm9vZgogICAgdG8gY2FsbCB0aGlzIGZ1bmN0aW9uIGFuZCBjb25zdW1lIGl0cyBvdXRwdXRzIHRoYW4gdG8gaW1wbGVtZW50IHRoZSBsb2dpYwogICAgaW5zaWRlIGl0IGFzIGEgY29weSBpbiB5b3VyIG93biBjb2RlLgogICAgJycnCiAgICBnbG9iYWwgX0FOU0lCTEVfQVJHUwogICAgaWYgX0FOU0lCTEVfQVJHUyBpcyBub3QgTm9uZToKICAgICAgICBidWZmZXIgPSBfQU5TSUJMRV9BUkdTCiAgICBlbHNlOgogICAgICAgICMgZGVidWcgb3ZlcnJpZGVzIHRvIHJlYWQgYXJncyBmcm9tIGZpbGUgb3IgY21kbGluZQoKICAgICAgICAjIEF2b2lkIHRyYWNlYmFja3Mgd2hlbiBsb2NhbGUgaXMgbm9uLXV0ZjgKICAgICAgICAjIFdlIGNvbnRyb2wgdGhlIGFyZ3MgYW5kIHdlIHBhc3MgdGhlbSBhcyB1dGY4CiAgICAgICAgaWYgbGVuKHN5cy5hcmd2KSA+IDE6CiAgICAgICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKHN5cy5hcmd2WzFdKToKICAgICAgICAgICAgICAgIGZkID0gb3BlbihzeXMuYXJndlsxXSwgJ3JiJykKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IGZkLnJlYWQoKQogICAgICAgICAgICAgICAgZmQuY2xvc2UoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYnVmZmVyID0gc3lzLmFyZ3ZbMV0KICAgICAgICAgICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBidWZmZXIuZW5jb2RlKCd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlZXNjYXBlJykKICAgICAgICAjIGRlZmF1bHQgY2FzZSwgcmVhZCBmcm9tIHN0ZGluCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgUFkyOgogICAgICAgICAgICAgICAgYnVmZmVyID0gc3lzLnN0ZGluLnJlYWQoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYnVmZmVyID0gc3lzLnN0ZGluLmJ1ZmZlci5yZWFkKCkKICAgICAgICBfQU5TSUJMRV9BUkdTID0gYnVmZmVyCgogICAgdHJ5OgogICAgICAgIHBhcmFtcyA9IGpzb24ubG9hZHMoYnVmZmVyLmRlY29kZSgndXRmLTgnKSkKICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICMgVGhpcyBoZWxwZXIgdXNlZCB0b28gZWFybHkgZm9yIGZhaWxfanNvbiB0byB3b3JrLgogICAgICAgIHByaW50KCdcbnsibXNnIjogIkVycm9yOiBNb2R1bGUgdW5hYmxlIHRvIGRlY29kZSB2YWxpZCBKU09OIG9uIHN0ZGluLiAgVW5hYmxlIHRvIGZpZ3VyZSBvdXQgd2hhdCBwYXJhbWV0ZXJzIHdlcmUgcGFzc2VkIiwgImZhaWxlZCI6IHRydWV9JykKICAgICAgICBzeXMuZXhpdCgxKQoKICAgIGlmIFBZMjoKICAgICAgICBwYXJhbXMgPSBqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcyhwYXJhbXMpCgogICAgdHJ5OgogICAgICAgIHJldHVybiBwYXJhbXNbJ0FOU0lCTEVfTU9EVUxFX0FSR1MnXQogICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICMgVGhpcyBoZWxwZXIgZG9lcyBub3QgaGF2ZSBhY2Nlc3MgdG8gZmFpbF9qc29uIHNvIHdlIGhhdmUgdG8gcHJpbnQKICAgICAgICAjIGpzb24gb3V0cHV0IG9uIG91ciBvd24uCiAgICAgICAgcHJpbnQoJ1xueyJtc2ciOiAiRXJyb3I6IE1vZHVsZSB1bmFibGUgdG8gbG9jYXRlIEFOU0lCTEVfTU9EVUxFX0FSR1MgaW4ganNvbiBkYXRhIGZyb20gc3RkaW4uICBVbmFibGUgdG8gZmlndXJlIG91dCB3aGF0IHBhcmFtZXRlcnMgd2VyZSBwYXNzZWQiLCAnCiAgICAgICAgICAgICAgJyJmYWlsZWQiOiB0cnVlfScpCiAgICAgICAgc3lzLmV4aXQoMSkKCmRlZiBlbnZfZmFsbGJhY2soKmFyZ3MsICoqa3dhcmdzKToKICAgICcnJyBMb2FkIHZhbHVlIGZyb20gZW52aXJvbm1lbnQgJycnCiAgICBmb3IgYXJnIGluIGFyZ3M6CiAgICAgICAgaWYgYXJnIGluIG9zLmVudmlyb246CiAgICAgICAgICAgIHJldHVybiBvcy5lbnZpcm9uW2FyZ10KICAgIGVsc2U6CiAgICAgICAgcmFpc2UgQW5zaWJsZUZhbGxiYWNrTm90Rm91bmQKCmRlZiBfbGVuaWVudF9sb3dlcmNhc2UobHN0KToKICAgICIiIkxvd2VyY2FzZSBlbGVtZW50cyBvZiBhIGxpc3QuCgogICAgSWYgYW4gZWxlbWVudCBpcyBub3QgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCB1bnRvdWNoZWQuCiAgICAiIiIKICAgIGxvd2VyZWQgPSBbXQogICAgZm9yIHZhbHVlIGluIGxzdDoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvd2VyZWQuYXBwZW5kKHZhbHVlLmxvd2VyKCkpCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICBsb3dlcmVkLmFwcGVuZCh2YWx1ZSkKICAgIHJldHVybiBsb3dlcmVkCgpkZWYgZm9ybWF0X2F0dHJpYnV0ZXMoYXR0cmlidXRlcyk6CiAgICBhdHRyaWJ1dGVfbGlzdCA9IFtdCiAgICBmb3IgYXR0ciBpbiBhdHRyaWJ1dGVzOgogICAgICAgIGlmIGF0dHIgaW4gRklMRV9BVFRSSUJVVEVTOgogICAgICAgICAgICBhdHRyaWJ1dGVfbGlzdC5hcHBlbmQoRklMRV9BVFRSSUJVVEVTW2F0dHJdKQogICAgcmV0dXJuIGF0dHJpYnV0ZV9saXN0CgpkZWYgZ2V0X2ZsYWdzX2Zyb21fYXR0cmlidXRlcyhhdHRyaWJ1dGVzKToKICAgIGZsYWdzID0gW10KICAgIGZvciBrZXksYXR0ciBpbiBGSUxFX0FUVFJJQlVURVMuaXRlbXMoKToKICAgICAgICBpZiBhdHRyIGluIGF0dHJpYnV0ZXM6CiAgICAgICAgICAgIGZsYWdzLmFwcGVuZChrZXkpCiAgICByZXR1cm4gJycuam9pbihmbGFncykKCmNsYXNzIEFuc2libGVGYWxsYmFja05vdEZvdW5kKEV4Y2VwdGlvbik6CiAgICBwYXNzCgoKY2xhc3MgQW5zaWJsZU1vZHVsZShvYmplY3QpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFyZ3VtZW50X3NwZWMsIGJ5cGFzc19jaGVja3M9RmFsc2UsIG5vX2xvZz1GYWxzZSwKICAgICAgICAgICAgICAgICBjaGVja19pbnZhbGlkX2FyZ3VtZW50cz1UcnVlLCBtdXR1YWxseV9leGNsdXNpdmU9Tm9uZSwgcmVxdWlyZWRfdG9nZXRoZXI9Tm9uZSwKICAgICAgICAgICAgICAgICByZXF1aXJlZF9vbmVfb2Y9Tm9uZSwgYWRkX2ZpbGVfY29tbW9uX2FyZ3M9RmFsc2UsIHN1cHBvcnRzX2NoZWNrX21vZGU9RmFsc2UsCiAgICAgICAgICAgICAgICAgcmVxdWlyZWRfaWY9Tm9uZSk6CgogICAgICAgICcnJwogICAgICAgIGNvbW1vbiBjb2RlIGZvciBxdWlja2x5IGJ1aWxkaW5nIGFuIGFuc2libGUgbW9kdWxlIGluIFB5dGhvbgogICAgICAgIChhbHRob3VnaCB5b3UgY2FuIHdyaXRlIG1vZHVsZXMgaW4gYW55dGhpbmcgdGhhdCBjYW4gcmV0dXJuIEpTT04pCiAgICAgICAgc2VlIGxpYnJhcnkvKiBmb3IgZXhhbXBsZXMKICAgICAgICAnJycKCiAgICAgICAgc2VsZi5fbmFtZSA9IG9zLnBhdGguYmFzZW5hbWUoX19maWxlX18pICNpbml0aWFsaXplIG5hbWUgdW50aWwgd2UgY2FuIHBhcnNlIGZyb20gb3B0aW9ucwogICAgICAgIHNlbGYuYXJndW1lbnRfc3BlYyA9IGFyZ3VtZW50X3NwZWMKICAgICAgICBzZWxmLnN1cHBvcnRzX2NoZWNrX21vZGUgPSBzdXBwb3J0c19jaGVja19tb2RlCiAgICAgICAgc2VsZi5jaGVja19tb2RlID0gRmFsc2UKICAgICAgICBzZWxmLm5vX2xvZyA9IG5vX2xvZwogICAgICAgIHNlbGYuY2xlYW51cF9maWxlcyA9IFtdCiAgICAgICAgc2VsZi5fZGVidWcgPSBGYWxzZQogICAgICAgIHNlbGYuX2RpZmYgPSBGYWxzZQogICAgICAgIHNlbGYuX3NvY2tldF9wYXRoID0gTm9uZQogICAgICAgIHNlbGYuX3ZlcmJvc2l0eSA9IDAKICAgICAgICAjIE1heSBiZSB1c2VkIHRvIHNldCBtb2RpZmljYXRpb25zIHRvIHRoZSBlbnZpcm9ubWVudCBmb3IgYW55CiAgICAgICAgIyBydW5fY29tbWFuZCBpbnZvY2F0aW9uCiAgICAgICAgc2VsZi5ydW5fY29tbWFuZF9lbnZpcm9uX3VwZGF0ZSA9IHt9CiAgICAgICAgc2VsZi5fd2FybmluZ3MgPSBbXQogICAgICAgIHNlbGYuX2RlcHJlY2F0aW9ucyA9IFtdCgogICAgICAgIHNlbGYuYWxpYXNlcyA9IHt9CiAgICAgICAgc2VsZi5fbGVnYWxfaW5wdXRzID0gWydfYW5zaWJsZV9jaGVja19tb2RlJywgJ19hbnNpYmxlX25vX2xvZycsICdfYW5zaWJsZV9kZWJ1ZycsICdfYW5zaWJsZV9kaWZmJywgJ19hbnNpYmxlX3ZlcmJvc2l0eScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdfYW5zaWJsZV9zZWxpbnV4X3NwZWNpYWxfZnMnLCAnX2Fuc2libGVfbW9kdWxlX25hbWUnLCAnX2Fuc2libGVfdmVyc2lvbicsICdfYW5zaWJsZV9zeXNsb2dfZmFjaWxpdHknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnX2Fuc2libGVfc29ja2V0J10KCiAgICAgICAgaWYgYWRkX2ZpbGVfY29tbW9uX2FyZ3M6CiAgICAgICAgICAgIGZvciBrLCB2IGluIEZJTEVfQ09NTU9OX0FSR1VNRU5UUy5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYgayBub3QgaW4gc2VsZi5hcmd1bWVudF9zcGVjOgogICAgICAgICAgICAgICAgICAgIHNlbGYuYXJndW1lbnRfc3BlY1trXSA9IHYKCiAgICAgICAgc2VsZi5fbG9hZF9wYXJhbXMoKQogICAgICAgIHNlbGYuX3NldF9mYWxsYmFja3MoKQoKICAgICAgICAjIGFwcGVuZCB0byBsZWdhbF9pbnB1dHMgYW5kIHRoZW4gcG9zc2libHkgY2hlY2sgYWdhaW5zdCB0aGVtCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmFsaWFzZXMgPSBzZWxmLl9oYW5kbGVfYWxpYXNlcygpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAjIFVzZSBleGNlcHRpb25zIGhlcmUgYmVjYXVzZSBpdCBpc24ndCBzYWZlIHRvIGNhbGwgZmFpbF9qc29uIHVudGlsIG5vX2xvZyBpcyBwcm9jZXNzZWQKICAgICAgICAgICAgcHJpbnQoJ1xueyJmYWlsZWQiOiB0cnVlLCAibXNnIjogIk1vZHVsZSBhbGlhcyBlcnJvcjogJXMifScgJSBzdHIoZSkpCiAgICAgICAgICAgIHN5cy5leGl0KDEpCgogICAgICAgICMgU2F2ZSBwYXJhbWV0ZXIgdmFsdWVzIHRoYXQgc2hvdWxkIG5ldmVyIGJlIGxvZ2dlZAogICAgICAgIHNlbGYubm9fbG9nX3ZhbHVlcyA9IHNldCgpCiAgICAgICAgIyBVc2UgdGhlIGFyZ3NwZWMgdG8gZGV0ZXJtaW5lIHdoaWNoIGFyZ3MgYXJlIG5vX2xvZwogICAgICAgIGZvciBhcmdfbmFtZSwgYXJnX29wdHMgaW4gc2VsZi5hcmd1bWVudF9zcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIGFyZ19vcHRzLmdldCgnbm9fbG9nJywgRmFsc2UpOgogICAgICAgICAgICAgICAgIyBGaW5kIHRoZSB2YWx1ZSBmb3IgdGhlIG5vX2xvZydkIHBhcmFtCiAgICAgICAgICAgICAgICBub19sb2dfb2JqZWN0ID0gc2VsZi5wYXJhbXMuZ2V0KGFyZ19uYW1lLCBOb25lKQogICAgICAgICAgICAgICAgaWYgbm9fbG9nX29iamVjdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLm5vX2xvZ192YWx1ZXMudXBkYXRlKHJldHVybl92YWx1ZXMobm9fbG9nX29iamVjdCkpCgogICAgICAgICAgICBpZiBhcmdfb3B0cy5nZXQoJ3JlbW92ZWRfaW5fdmVyc2lvbicpIGlzIG5vdCBOb25lIGFuZCBhcmdfbmFtZSBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgICAgIHNlbGYuX2RlcHJlY2F0aW9ucy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICdtc2cnOiAiUGFyYW0gJyVzJyBpcyBkZXByZWNhdGVkLiBTZWUgdGhlIG1vZHVsZSBkb2NzIGZvciBtb3JlIGluZm9ybWF0aW9uIiAlIGFyZ19uYW1lLAogICAgICAgICAgICAgICAgICAgICd2ZXJzaW9uJzogYXJnX29wdHMuZ2V0KCdyZW1vdmVkX2luX3ZlcnNpb24nKQogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgIyBjaGVjayB0aGUgbG9jYWxlIGFzIHNldCBieSB0aGUgY3VycmVudCBlbnZpcm9ubWVudCwgYW5kIHJlc2V0IHRvCiAgICAgICAgIyBhIGtub3duIHZhbGlkIChMQU5HPUMpIGlmIGl0J3MgYW4gaW52YWxpZC91bmF2YWlsYWJsZSBsb2NhbGUKICAgICAgICBzZWxmLl9jaGVja19sb2NhbGUoKQoKICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudHMoY2hlY2tfaW52YWxpZF9hcmd1bWVudHMpCgogICAgICAgICMgY2hlY2sgZXhjbHVzaXZlIGVhcmx5CiAgICAgICAgaWYgbm90IGJ5cGFzc19jaGVja3M6CiAgICAgICAgICAgIHNlbGYuX2NoZWNrX211dHVhbGx5X2V4Y2x1c2l2ZShtdXR1YWxseV9leGNsdXNpdmUpCgogICAgICAgIHNlbGYuX3NldF9kZWZhdWx0cyhwcmU9VHJ1ZSkKCiAgICAgICAgc2VsZi5fQ0hFQ0tfQVJHVU1FTlRfVFlQRVNfRElTUEFUQ0hFUiA9IHsKICAgICAgICAgICAgJ3N0cic6IHNlbGYuX2NoZWNrX3R5cGVfc3RyLAogICAgICAgICAgICAnbGlzdCc6IHNlbGYuX2NoZWNrX3R5cGVfbGlzdCwKICAgICAgICAgICAgJ2RpY3QnOiBzZWxmLl9jaGVja190eXBlX2RpY3QsCiAgICAgICAgICAgICdib29sJzogc2VsZi5fY2hlY2tfdHlwZV9ib29sLAogICAgICAgICAgICAnaW50Jzogc2VsZi5fY2hlY2tfdHlwZV9pbnQsCiAgICAgICAgICAgICdmbG9hdCc6IHNlbGYuX2NoZWNrX3R5cGVfZmxvYXQsCiAgICAgICAgICAgICdwYXRoJzogc2VsZi5fY2hlY2tfdHlwZV9wYXRoLAogICAgICAgICAgICAncmF3Jzogc2VsZi5fY2hlY2tfdHlwZV9yYXcsCiAgICAgICAgICAgICdqc29uYXJnJzogc2VsZi5fY2hlY2tfdHlwZV9qc29uYXJnLAogICAgICAgICAgICAnanNvbic6IHNlbGYuX2NoZWNrX3R5cGVfanNvbmFyZywKICAgICAgICAgICAgJ2J5dGVzJzogc2VsZi5fY2hlY2tfdHlwZV9ieXRlcywKICAgICAgICAgICAgJ2JpdHMnOiBzZWxmLl9jaGVja190eXBlX2JpdHMsCiAgICAgICAgfQogICAgICAgIGlmIG5vdCBieXBhc3NfY2hlY2tzOgogICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF9hcmd1bWVudHMoKQogICAgICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudF90eXBlcygpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50X3ZhbHVlcygpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX3RvZ2V0aGVyKHJlcXVpcmVkX3RvZ2V0aGVyKQogICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF9vbmVfb2YocmVxdWlyZWRfb25lX29mKQogICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF9pZihyZXF1aXJlZF9pZikKCiAgICAgICAgc2VsZi5fc2V0X2RlZmF1bHRzKHByZT1GYWxzZSkKCiAgICAgICAgaWYgbm90IHNlbGYubm9fbG9nOgogICAgICAgICAgICBzZWxmLl9sb2dfaW52b2NhdGlvbigpCgogICAgICAgICMgZmluYWxseSwgbWFrZSBzdXJlIHdlJ3JlIGluIGEgc2FuZSB3b3JraW5nIGRpcgogICAgICAgIHNlbGYuX3NldF9jd2QoKQoKICAgIGRlZiB3YXJuKHNlbGYsIHdhcm5pbmcpOgoKICAgICAgICBpZiBpc2luc3RhbmNlKHdhcm5pbmcsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHNlbGYuX3dhcm5pbmdzLmFwcGVuZCh3YXJuaW5nKQogICAgICAgICAgICBzZWxmLmxvZygnW1dBUk5JTkddICVzJyAlIHdhcm5pbmcpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJ3YXJuIHJlcXVpcmVzIGEgc3RyaW5nIG5vdCBhICVzIiAlIHR5cGUod2FybmluZykpCgogICAgZGVmIGRlcHJlY2F0ZShzZWxmLCBtc2csIHZlcnNpb249Tm9uZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZShtc2csIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHNlbGYuX2RlcHJlY2F0aW9ucy5hcHBlbmQoewogICAgICAgICAgICAgICAgJ21zZyc6IG1zZywKICAgICAgICAgICAgICAgICd2ZXJzaW9uJzogdmVyc2lvbgogICAgICAgICAgICB9KQogICAgICAgICAgICBzZWxmLmxvZygnW0RFUFJFQ0FUSU9OIFdBUk5JTkddICVzICVzJyAlIChtc2csIHZlcnNpb24pKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiZGVwcmVjYXRlIHJlcXVpcmVzIGEgc3RyaW5nIG5vdCBhICVzIiAlIHR5cGUobXNnKSkKCiAgICBkZWYgbG9hZF9maWxlX2NvbW1vbl9hcmd1bWVudHMoc2VsZiwgcGFyYW1zKToKICAgICAgICAnJycKICAgICAgICBtYW55IG1vZHVsZXMgZGVhbCB3aXRoIGZpbGVzLCB0aGlzIGVuY2Fwc3VsYXRlcyBjb21tb24KICAgICAgICBvcHRpb25zIHRoYXQgdGhlIGZpbGUgbW9kdWxlIGFjY2VwdHMgc3VjaCB0aGF0IGl0IGlzIGRpcmVjdGx5CiAgICAgICAgYXZhaWxhYmxlIHRvIGFsbCBtb2R1bGVzIGFuZCB0aGV5IGNhbiBzaGFyZSBjb2RlLgogICAgICAgICcnJwoKICAgICAgICBwYXRoID0gcGFyYW1zLmdldCgncGF0aCcsIHBhcmFtcy5nZXQoJ2Rlc3QnLCBOb25lKSkKICAgICAgICBpZiBwYXRoIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHBhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKHBhdGgpKQoKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgICMgaWYgdGhlIHBhdGggaXMgYSBzeW1saW5rLCBhbmQgd2UncmUgZm9sbG93aW5nIGxpbmtzLCBnZXQKICAgICAgICAjIHRoZSB0YXJnZXQgb2YgdGhlIGxpbmsgaW5zdGVhZCBmb3IgdGVzdGluZwogICAgICAgIGlmIHBhcmFtcy5nZXQoJ2ZvbGxvdycsIEZhbHNlKSBhbmQgb3MucGF0aC5pc2xpbmsoYl9wYXRoKToKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5yZWFscGF0aChiX3BhdGgpCiAgICAgICAgICAgIHBhdGggPSB0b19uYXRpdmUoYl9wYXRoKQoKICAgICAgICBtb2RlICAgPSBwYXJhbXMuZ2V0KCdtb2RlJywgTm9uZSkKICAgICAgICBvd25lciAgPSBwYXJhbXMuZ2V0KCdvd25lcicsIE5vbmUpCiAgICAgICAgZ3JvdXAgID0gcGFyYW1zLmdldCgnZ3JvdXAnLCBOb25lKQoKICAgICAgICAjIHNlbGludXggcmVsYXRlZCBvcHRpb25zCiAgICAgICAgc2V1c2VyICAgID0gcGFyYW1zLmdldCgnc2V1c2VyJywgTm9uZSkKICAgICAgICBzZXJvbGUgICAgPSBwYXJhbXMuZ2V0KCdzZXJvbGUnLCBOb25lKQogICAgICAgIHNldHlwZSAgICA9IHBhcmFtcy5nZXQoJ3NldHlwZScsIE5vbmUpCiAgICAgICAgc2VsZXZlbCAgID0gcGFyYW1zLmdldCgnc2VsZXZlbCcsIE5vbmUpCiAgICAgICAgc2Vjb250ZXh0ID0gW3NldXNlciwgc2Vyb2xlLCBzZXR5cGVdCgogICAgICAgIGlmIHNlbGYuc2VsaW51eF9tbHNfZW5hYmxlZCgpOgogICAgICAgICAgICBzZWNvbnRleHQuYXBwZW5kKHNlbGV2ZWwpCgogICAgICAgIGRlZmF1bHRfc2Vjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2RlZmF1bHRfY29udGV4dChwYXRoKQogICAgICAgIGZvciBpIGluIHJhbmdlKGxlbihkZWZhdWx0X3NlY29udGV4dCkpOgogICAgICAgICAgICBpZiBpIGlzIG5vdCBOb25lIGFuZCBzZWNvbnRleHRbaV0gPT0gJ19kZWZhdWx0JzoKICAgICAgICAgICAgICAgIHNlY29udGV4dFtpXSA9IGRlZmF1bHRfc2Vjb250ZXh0W2ldCgogICAgICAgIGF0dHJpYnV0ZXMgPSBwYXJhbXMuZ2V0KCdhdHRyaWJ1dGVzJywgTm9uZSkKICAgICAgICByZXR1cm4gZGljdCgKICAgICAgICAgICAgcGF0aD1wYXRoLCBtb2RlPW1vZGUsIG93bmVyPW93bmVyLCBncm91cD1ncm91cCwKICAgICAgICAgICAgc2V1c2VyPXNldXNlciwgc2Vyb2xlPXNlcm9sZSwgc2V0eXBlPXNldHlwZSwKICAgICAgICAgICAgc2VsZXZlbD1zZWxldmVsLCBzZWNvbnRleHQ9c2Vjb250ZXh0LCBhdHRyaWJ1dGVzPWF0dHJpYnV0ZXMsCiAgICAgICAgKQoKCiAgICAjIERldGVjdCB3aGV0aGVyIHVzaW5nIHNlbGludXggdGhhdCBpcyBNTFMtYXdhcmUuCiAgICAjIFdoaWxlIHRoaXMgbWVhbnMgeW91IGNhbiBzZXQgdGhlIGxldmVsL3JhbmdlIHdpdGgKICAgICMgc2VsaW51eC5sc2V0ZmlsZWNvbigpLCBpdCBtYXkgb3IgbWF5IG5vdCBtZWFuIHRoYXQgeW91CiAgICAjIHdpbGwgZ2V0IHRoZSBzZWxldmVsIGFzIHBhcnQgb2YgdGhlIGNvbnRleHQgcmV0dXJuZWQKICAgICMgYnkgc2VsaW51eC5sZ2V0ZmlsZWNvbigpLgoKICAgIGRlZiBzZWxpbnV4X21sc19lbmFibGVkKHNlbGYpOgogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVg6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGlmIHNlbGludXguaXNfc2VsaW51eF9tbHNfZW5hYmxlZCgpID09IDE6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHNlbGludXhfZW5hYmxlZChzZWxmKToKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYOgogICAgICAgICAgICBzZWVuYWJsZWQgPSBzZWxmLmdldF9iaW5fcGF0aCgnc2VsaW51eGVuYWJsZWQnKQogICAgICAgICAgICBpZiBzZWVuYWJsZWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAocmMsb3V0LGVycikgPSBzZWxmLnJ1bl9jb21tYW5kKHNlZW5hYmxlZCkKICAgICAgICAgICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJBYm9ydGluZywgdGFyZ2V0IHVzZXMgc2VsaW51eCBidXQgcHl0aG9uIGJpbmRpbmdzIChsaWJzZWxpbnV4LXB5dGhvbikgYXJlbid0IGluc3RhbGxlZCEiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBpZiBzZWxpbnV4LmlzX3NlbGludXhfZW5hYmxlZCgpID09IDE6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgIyBEZXRlcm1pbmUgd2hldGhlciB3ZSBuZWVkIGEgcGxhY2Vob2xkZXIgZm9yIHNlbGV2ZWwvbWxzCiAgICBkZWYgc2VsaW51eF9pbml0aWFsX2NvbnRleHQoc2VsZik6CiAgICAgICAgY29udGV4dCA9IFtOb25lLCBOb25lLCBOb25lXQogICAgICAgIGlmIHNlbGYuc2VsaW51eF9tbHNfZW5hYmxlZCgpOgogICAgICAgICAgICBjb250ZXh0LmFwcGVuZChOb25lKQogICAgICAgIHJldHVybiBjb250ZXh0CgogICAgIyBJZiBzZWxpbnV4IGZhaWxzIHRvIGZpbmQgYSBkZWZhdWx0LCByZXR1cm4gYW4gYXJyYXkgb2YgTm9uZQogICAgZGVmIHNlbGludXhfZGVmYXVsdF9jb250ZXh0KHNlbGYsIHBhdGgsIG1vZGU9MCk6CiAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9pbml0aWFsX2NvbnRleHQoKQogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVggb3Igbm90IHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXQgPSBzZWxpbnV4Lm1hdGNocGF0aGNvbih0b19uYXRpdmUocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JyksIG1vZGUpCiAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgaWYgcmV0WzBdID09IC0xOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgICMgTGltaXQgc3BsaXQgdG8gNCBiZWNhdXNlIHRoZSBzZWxldmVsLCB0aGUgbGFzdCBpbiB0aGUgbGlzdCwKICAgICAgICAjIG1heSBjb250YWluICc6JyBjaGFyYWN0ZXJzCiAgICAgICAgY29udGV4dCA9IHJldFsxXS5zcGxpdCgnOicsIDMpCiAgICAgICAgcmV0dXJuIGNvbnRleHQKCiAgICBkZWYgc2VsaW51eF9jb250ZXh0KHNlbGYsIHBhdGgpOgogICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfaW5pdGlhbF9jb250ZXh0KCkKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYIG9yIG5vdCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0ID0gc2VsaW51eC5sZ2V0ZmlsZWNvbl9yYXcodG9fbmF0aXZlKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpKQogICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIGlmIGUuZXJybm8gPT0gZXJybm8uRU5PRU5UOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J3BhdGggJXMgZG9lcyBub3QgZXhpc3QnICUgcGF0aCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdmYWlsZWQgdG8gcmV0cmlldmUgc2VsaW51eCBjb250ZXh0JykKICAgICAgICBpZiByZXRbMF0gPT0gLTE6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgIyBMaW1pdCBzcGxpdCB0byA0IGJlY2F1c2UgdGhlIHNlbGV2ZWwsIHRoZSBsYXN0IGluIHRoZSBsaXN0LAogICAgICAgICMgbWF5IGNvbnRhaW4gJzonIGNoYXJhY3RlcnMKICAgICAgICBjb250ZXh0ID0gcmV0WzFdLnNwbGl0KCc6JywgMykKICAgICAgICByZXR1cm4gY29udGV4dAoKICAgIGRlZiB1c2VyX2FuZF9ncm91cChzZWxmLCBwYXRoLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHN0ID0gb3MubHN0YXQoYl9wYXRoKQogICAgICAgIHVpZCA9IHN0LnN0X3VpZAogICAgICAgIGdpZCA9IHN0LnN0X2dpZAogICAgICAgIHJldHVybiAodWlkLCBnaWQpCgogICAgZGVmIGZpbmRfbW91bnRfcG9pbnQoc2VsZiwgcGF0aCk6CiAgICAgICAgcGF0aF9pc19ieXRlcyA9IEZhbHNlCiAgICAgICAgaWYgaXNpbnN0YW5jZShwYXRoLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgIHBhdGhfaXNfYnl0ZXMgPSBUcnVlCgogICAgICAgIGJfcGF0aCA9IG9zLnBhdGgucmVhbHBhdGgodG9fYnl0ZXMob3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhwYXRoKSksIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpKQogICAgICAgIHdoaWxlIG5vdCBvcy5wYXRoLmlzbW91bnQoYl9wYXRoKToKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5kaXJuYW1lKGJfcGF0aCkKCiAgICAgICAgaWYgcGF0aF9pc19ieXRlczoKICAgICAgICAgICAgcmV0dXJuIGJfcGF0aAoKICAgICAgICByZXR1cm4gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCgogICAgZGVmIGlzX3NwZWNpYWxfc2VsaW51eF9wYXRoKHNlbGYsIHBhdGgpOgogICAgICAgICIiIgogICAgICAgIFJldHVybnMgYSB0dXBsZSBjb250YWluaW5nIChUcnVlLCBzZWxpbnV4X2NvbnRleHQpIGlmIHRoZSBnaXZlbiBwYXRoIGlzIG9uIGEKICAgICAgICBORlMgb3Igb3RoZXIgJ3NwZWNpYWwnIGZzICBtb3VudCBwb2ludCwgb3RoZXJ3aXNlIHRoZSByZXR1cm4gd2lsbCBiZSAoRmFsc2UsIE5vbmUpLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgZiA9IG9wZW4oJy9wcm9jL21vdW50cycsICdyJykKICAgICAgICAgICAgbW91bnRfZGF0YSA9IGYucmVhZGxpbmVzKCkKICAgICAgICAgICAgZi5jbG9zZSgpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4gKEZhbHNlLCBOb25lKQogICAgICAgIHBhdGhfbW91bnRfcG9pbnQgPSBzZWxmLmZpbmRfbW91bnRfcG9pbnQocGF0aCkKICAgICAgICBmb3IgbGluZSBpbiBtb3VudF9kYXRhOgogICAgICAgICAgICAoZGV2aWNlLCBtb3VudF9wb2ludCwgZnN0eXBlLCBvcHRpb25zLCByZXN0KSA9IGxpbmUuc3BsaXQoJyAnLCA0KQoKICAgICAgICAgICAgaWYgcGF0aF9tb3VudF9wb2ludCA9PSBtb3VudF9wb2ludDoKICAgICAgICAgICAgICAgIGZvciBmcyBpbiBzZWxmLl9zZWxpbnV4X3NwZWNpYWxfZnM6CiAgICAgICAgICAgICAgICAgICAgaWYgZnMgaW4gZnN0eXBlOgogICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWFsX2NvbnRleHQgPSBzZWxmLnNlbGludXhfY29udGV4dChwYXRoX21vdW50X3BvaW50KQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKFRydWUsIHNwZWNpYWxfY29udGV4dCkKCiAgICAgICAgcmV0dXJuIChGYWxzZSwgTm9uZSkKCiAgICBkZWYgc2V0X2RlZmF1bHRfc2VsaW51eF9jb250ZXh0KHNlbGYsIHBhdGgsIGNoYW5nZWQpOgogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVggb3Igbm90IHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCiAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9kZWZhdWx0X2NvbnRleHQocGF0aCkKICAgICAgICByZXR1cm4gc2VsZi5zZXRfY29udGV4dF9pZl9kaWZmZXJlbnQocGF0aCwgY29udGV4dCwgRmFsc2UpCgogICAgZGVmIHNldF9jb250ZXh0X2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBjb250ZXh0LCBjaGFuZ2VkLCBkaWZmPU5vbmUpOgoKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYIG9yIG5vdCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAogICAgICAgIGN1cl9jb250ZXh0ID0gc2VsZi5zZWxpbnV4X2NvbnRleHQocGF0aCkKICAgICAgICBuZXdfY29udGV4dCA9IGxpc3QoY3VyX2NvbnRleHQpCiAgICAgICAgIyBJdGVyYXRlIG92ZXIgdGhlIGN1cnJlbnQgY29udGV4dCBpbnN0ZWFkIG9mIHRoZQogICAgICAgICMgYXJndW1lbnQgY29udGV4dCwgd2hpY2ggbWF5IGhhdmUgc2VsZXZlbC4KCiAgICAgICAgKGlzX3NwZWNpYWxfc2UsIHNwX2NvbnRleHQpID0gc2VsZi5pc19zcGVjaWFsX3NlbGludXhfcGF0aChwYXRoKQogICAgICAgIGlmIGlzX3NwZWNpYWxfc2U6CiAgICAgICAgICAgIG5ld19jb250ZXh0ID0gc3BfY29udGV4dAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKGxlbihjdXJfY29udGV4dCkpOgogICAgICAgICAgICAgICAgaWYgbGVuKGNvbnRleHQpID4gaToKICAgICAgICAgICAgICAgICAgICBpZiBjb250ZXh0W2ldIGlzIG5vdCBOb25lIGFuZCBjb250ZXh0W2ldICE9IGN1cl9jb250ZXh0W2ldOgogICAgICAgICAgICAgICAgICAgICAgICBuZXdfY29udGV4dFtpXSA9IGNvbnRleHRbaV0KICAgICAgICAgICAgICAgICAgICBlbGlmIGNvbnRleHRbaV0gaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2NvbnRleHRbaV0gPSBjdXJfY29udGV4dFtpXQoKICAgICAgICBpZiBjdXJfY29udGV4dCAhPSBuZXdfY29udGV4dDoKICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmICdiZWZvcmUnIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydzZWNvbnRleHQnXSA9IGN1cl9jb250ZXh0CiAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnc2Vjb250ZXh0J10gPSBuZXdfY29udGV4dAoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICByYyA9IHNlbGludXgubHNldGZpbGVjb24odG9fbmF0aXZlKHBhdGgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cignOicuam9pbihuZXdfY29udGV4dCkpKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdpbnZhbGlkIHNlbGludXggY29udGV4dDogJXMnICUgc3RyKGUpLCBuZXdfY29udGV4dD1uZXdfY29udGV4dCwgY3VyX2NvbnRleHQ9Y3VyX2NvbnRleHQsIGlucHV0X3dhcz1jb250ZXh0KQogICAgICAgICAgICBpZiByYyAhPSAwOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J3NldCBzZWxpbnV4IGNvbnRleHQgZmFpbGVkJykKICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfb3duZXJfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIG93bmVyLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgcGF0aCA9IHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgb3duZXIgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKICAgICAgICBvcmlnX3VpZCwgb3JpZ19naWQgPSBzZWxmLnVzZXJfYW5kX2dyb3VwKHBhdGgsIGV4cGFuZCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHVpZCA9IGludChvd25lcikKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdWlkID0gcHdkLmdldHB3bmFtKG93bmVyKS5wd191aWQKICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2Nob3duIGZhaWxlZDogZmFpbGVkIHRvIGxvb2sgdXAgdXNlciAlcycgJSBvd25lcikKICAgICAgICBpZiBvcmlnX3VpZCAhPSB1aWQ6CgogICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ293bmVyJ10gPSBvcmlnX3VpZAogICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ293bmVyJ10gPSB1aWQKCiAgICAgICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLmxjaG93bihiX3BhdGgsIHVpZCwgLTEpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2Nob3duIGZhaWxlZCcpCiAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X2dyb3VwX2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBncm91cCwgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHBhdGggPSB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGdyb3VwIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCiAgICAgICAgb3JpZ191aWQsIG9yaWdfZ2lkID0gc2VsZi51c2VyX2FuZF9ncm91cChiX3BhdGgsIGV4cGFuZCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGdpZCA9IGludChncm91cCkKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZ2lkID0gZ3JwLmdldGdybmFtKGdyb3VwKS5ncl9naWQKICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2NoZ3JwIGZhaWxlZDogZmFpbGVkIHRvIGxvb2sgdXAgZ3JvdXAgJXMnICUgZ3JvdXApCiAgICAgICAgaWYgb3JpZ19naWQgIT0gZ2lkOgoKICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmICdiZWZvcmUnIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydncm91cCddID0gb3JpZ19naWQKICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydncm91cCddID0gZ2lkCgogICAgICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5sY2hvd24oYl9wYXRoLCAtMSwgZ2lkKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaGdycCBmYWlsZWQnKQogICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9tb2RlX2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBtb2RlLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgcGF0aCA9IHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgcGF0aF9zdGF0ID0gb3MubHN0YXQoYl9wYXRoKQoKICAgICAgICBpZiBtb2RlIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG1vZGUsIGludCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG1vZGUgPSBpbnQobW9kZSwgOCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBtb2RlID0gc2VsZi5fc3ltYm9saWNfbW9kZV90b19vY3RhbChwYXRoX3N0YXQsIG1vZGUpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnPSJtb2RlIG11c3QgYmUgaW4gb2N0YWwgb3Igc3ltYm9saWMgZm9ybSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlscz1zdHIoZSkpCgogICAgICAgICAgICAgICAgaWYgbW9kZSAhPSBzdGF0LlNfSU1PREUobW9kZSk6CiAgICAgICAgICAgICAgICAgICAgIyBwcmV2ZW50IG1vZGUgZnJvbSBoYXZpbmcgZXh0cmEgaW5mbyBvcmJlaW5nIGludmFsaWQgbG9uZyBudW1iZXIKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0iSW52YWxpZCBtb2RlIHN1cHBsaWVkLCBvbmx5IHBlcm1pc3Npb24gaW5mbyBpcyBhbGxvd2VkIiwgZGV0YWlscz1tb2RlKQoKICAgICAgICBwcmV2X21vZGUgPSBzdGF0LlNfSU1PREUocGF0aF9zdGF0LnN0X21vZGUpCgogICAgICAgIGlmIHByZXZfbW9kZSAhPSBtb2RlOgoKICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmICdiZWZvcmUnIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydtb2RlJ10gPSAnMCUwM28nICUgcHJldl9tb2RlCiAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnbW9kZSddID0gJzAlMDNvJyAlIG1vZGUKCiAgICAgICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICMgRklYTUU6IGNvbXBhcmlzb24gYWdhaW5zdCBzdHJpbmcgYWJvdmUgd2lsbCBjYXVzZSB0aGlzIHRvIGJlIGV4ZWN1dGVkCiAgICAgICAgICAgICMgZXZlcnkgdGltZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKG9zLCAnbGNobW9kJyk6CiAgICAgICAgICAgICAgICAgICAgb3MubGNobW9kKGJfcGF0aCwgbW9kZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguaXNsaW5rKGJfcGF0aCk6CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNobW9kKGJfcGF0aCwgbW9kZSkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIEF0dGVtcHQgdG8gc2V0IHRoZSBwZXJtcyBvZiB0aGUgc3ltbGluayBidXQgYmUKICAgICAgICAgICAgICAgICAgICAgICAgIyBjYXJlZnVsIG5vdCB0byBjaGFuZ2UgdGhlIHBlcm1zIG9mIHRoZSB1bmRlcmx5aW5nCiAgICAgICAgICAgICAgICAgICAgICAgICMgZmlsZSB3aGlsZSB0cnlpbmcKICAgICAgICAgICAgICAgICAgICAgICAgdW5kZXJseWluZ19zdGF0ID0gb3Muc3RhdChiX3BhdGgpCiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNobW9kKGJfcGF0aCwgbW9kZSkKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X3VuZGVybHlpbmdfc3RhdCA9IG9zLnN0YXQoYl9wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiB1bmRlcmx5aW5nX3N0YXQuc3RfbW9kZSAhPSBuZXdfdW5kZXJseWluZ19zdGF0LnN0X21vZGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy5jaG1vZChiX3BhdGgsIHN0YXQuU19JTU9ERSh1bmRlcmx5aW5nX3N0YXQuc3RfbW9kZSkpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5pc2xpbmsoYl9wYXRoKSBhbmQgZS5lcnJubyA9PSBlcnJuby5FUEVSTTogICMgQ2FuJ3Qgc2V0IG1vZGUgb24gc3ltYm9saWMgbGlua3MKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBlbGlmIGUuZXJybm8gaW4gKGVycm5vLkVOT0VOVCwgZXJybm8uRUxPT1ApOiAjIENhbid0IHNldCBtb2RlIG9uIGJyb2tlbiBzeW1ib2xpYyBsaW5rcwogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2NobW9kIGZhaWxlZCcsIGRldGFpbHM9c3RyKGUpKQoKICAgICAgICAgICAgcGF0aF9zdGF0ID0gb3MubHN0YXQoYl9wYXRoKQogICAgICAgICAgICBuZXdfbW9kZSA9IHN0YXQuU19JTU9ERShwYXRoX3N0YXQuc3RfbW9kZSkKCiAgICAgICAgICAgIGlmIG5ld19tb2RlICE9IHByZXZfbW9kZToKICAgICAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIGF0dHJpYnV0ZXMsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgoKICAgICAgICBpZiBhdHRyaWJ1dGVzIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBwYXRoID0gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKCiAgICAgICAgZXhpc3RpbmcgPSBzZWxmLmdldF9maWxlX2F0dHJpYnV0ZXMoYl9wYXRoKQoKICAgICAgICBpZiBleGlzdGluZy5nZXQoJ2F0dHJfZmxhZ3MnLCcnKSAhPSBhdHRyaWJ1dGVzOgogICAgICAgICAgICBhdHRyY21kID0gc2VsZi5nZXRfYmluX3BhdGgoJ2NoYXR0cicpCiAgICAgICAgICAgIGlmIGF0dHJjbWQ6CiAgICAgICAgICAgICAgICBhdHRyY21kID0gW2F0dHJjbWQsICc9JXMnICUgYXR0cmlidXRlcywgYl9wYXRoXQogICAgICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKCiAgICAgICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIGlmICdiZWZvcmUnIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ2F0dHJpYnV0ZXMnXSA9IGV4aXN0aW5nLmdldCgnYXR0cl9mbGFncycpCiAgICAgICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnYXR0cmlidXRlcyddID0gYXR0cmlidXRlcwoKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLnJ1bl9jb21tYW5kKGF0dHJjbWQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJjICE9IDAgb3IgZXJyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJFcnJvciB3aGlsZSBzZXR0aW5nIGF0dHJpYnV0ZXM6ICVzIiAlIChvdXQgKyBlcnIpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hhdHRyIGZhaWxlZCcsIGRldGFpbHM9c3RyKGUpKQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIGdldF9maWxlX2F0dHJpYnV0ZXMoc2VsZiwgcGF0aCk6CiAgICAgICAgb3V0cHV0ID0ge30KICAgICAgICBhdHRyY21kID0gc2VsZi5nZXRfYmluX3BhdGgoJ2xzYXR0cicsIEZhbHNlKQogICAgICAgIGlmIGF0dHJjbWQ6CiAgICAgICAgICAgIGF0dHJjbWQgPSBbYXR0cmNtZCwgJy12ZCcsIHBhdGhdCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYucnVuX2NvbW1hbmQoYXR0cmNtZCkKICAgICAgICAgICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgICAgICAgICAgcmVzID0gb3V0LnNwbGl0KCcgJylbMDoyXQogICAgICAgICAgICAgICAgICAgIG91dHB1dFsnYXR0cl9mbGFncyddID0gIHJlc1sxXS5yZXBsYWNlKCctJywnJykuc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIG91dHB1dFsndmVyc2lvbiddID0gcmVzWzBdLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBvdXRwdXRbJ2F0dHJpYnV0ZXMnXSA9IGZvcm1hdF9hdHRyaWJ1dGVzKG91dHB1dFsnYXR0cl9mbGFncyddKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIG91dHB1dAoKCiAgICBkZWYgX3N5bWJvbGljX21vZGVfdG9fb2N0YWwoc2VsZiwgcGF0aF9zdGF0LCBzeW1ib2xpY19tb2RlKToKICAgICAgICBuZXdfbW9kZSA9IHN0YXQuU19JTU9ERShwYXRoX3N0YXQuc3RfbW9kZSkKCiAgICAgICAgbW9kZV9yZSA9IHJlLmNvbXBpbGUocideKD9QPHVzZXJzPlt1Z29hXSspKD9QPG9wZXJhdG9yPlstKz1dKSg/UDxwZXJtcz5bcnd4WHN0LV0qfFt1Z29dKSQnKQogICAgICAgIGZvciBtb2RlIGluIHN5bWJvbGljX21vZGUuc3BsaXQoJywnKToKICAgICAgICAgICAgbWF0Y2ggPSBtb2RlX3JlLm1hdGNoKG1vZGUpCiAgICAgICAgICAgIGlmIG1hdGNoOgogICAgICAgICAgICAgICAgdXNlcnMgPSBtYXRjaC5ncm91cCgndXNlcnMnKQogICAgICAgICAgICAgICAgb3BlcmF0b3IgPSBtYXRjaC5ncm91cCgnb3BlcmF0b3InKQogICAgICAgICAgICAgICAgcGVybXMgPSBtYXRjaC5ncm91cCgncGVybXMnKQoKICAgICAgICAgICAgICAgIGlmIHVzZXJzID09ICdhJzoKICAgICAgICAgICAgICAgICAgICB1c2VycyA9ICd1Z28nCgogICAgICAgICAgICAgICAgZm9yIHVzZXIgaW4gdXNlcnM6CiAgICAgICAgICAgICAgICAgICAgbW9kZV90b19hcHBseSA9IHNlbGYuX2dldF9vY3RhbF9tb2RlX2Zyb21fc3ltYm9saWNfcGVybXMocGF0aF9zdGF0LCB1c2VyLCBwZXJtcykKICAgICAgICAgICAgICAgICAgICBuZXdfbW9kZSA9IHNlbGYuX2FwcGx5X29wZXJhdGlvbl90b19tb2RlKHVzZXIsIG9wZXJhdG9yLCBtb2RlX3RvX2FwcGx5LCBuZXdfbW9kZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImJhZCBzeW1ib2xpYyBwZXJtaXNzaW9uIGZvciBtb2RlOiAlcyIgJSBtb2RlKQogICAgICAgIHJldHVybiBuZXdfbW9kZQoKICAgIGRlZiBfYXBwbHlfb3BlcmF0aW9uX3RvX21vZGUoc2VsZiwgdXNlciwgb3BlcmF0b3IsIG1vZGVfdG9fYXBwbHksIGN1cnJlbnRfbW9kZSk6CiAgICAgICAgaWYgb3BlcmF0b3IgID09ICAnPSc6CiAgICAgICAgICAgIGlmIHVzZXIgPT0gJ3UnOgogICAgICAgICAgICAgICAgbWFzayA9IHN0YXQuU19JUldYVSB8IHN0YXQuU19JU1VJRAogICAgICAgICAgICBlbGlmIHVzZXIgPT0gJ2cnOgogICAgICAgICAgICAgICAgbWFzayA9IHN0YXQuU19JUldYRyB8IHN0YXQuU19JU0dJRAogICAgICAgICAgICBlbGlmIHVzZXIgPT0gJ28nOgogICAgICAgICAgICAgICAgbWFzayA9IHN0YXQuU19JUldYTyB8IHN0YXQuU19JU1ZUWAoKICAgICAgICAgICAgIyBtYXNrIG91dCB1LCBnLCBvciBvIHBlcm1pc3Npb25zIGZyb20gY3VycmVudF9tb2RlIGFuZCBhcHBseSBuZXcgcGVybWlzc2lvbnMKICAgICAgICAgICAgaW52ZXJzZV9tYXNrID0gbWFzayBeIFBFUk1fQklUUwogICAgICAgICAgICBuZXdfbW9kZSA9IChjdXJyZW50X21vZGUgJiBpbnZlcnNlX21hc2spIHwgbW9kZV90b19hcHBseQogICAgICAgIGVsaWYgb3BlcmF0b3IgPT0gJysnOgogICAgICAgICAgICBuZXdfbW9kZSA9IGN1cnJlbnRfbW9kZSB8IG1vZGVfdG9fYXBwbHkKICAgICAgICBlbGlmIG9wZXJhdG9yID09ICctJzoKICAgICAgICAgICAgbmV3X21vZGUgPSBjdXJyZW50X21vZGUgLSAoY3VycmVudF9tb2RlICYgbW9kZV90b19hcHBseSkKICAgICAgICByZXR1cm4gbmV3X21vZGUKCiAgICBkZWYgX2dldF9vY3RhbF9tb2RlX2Zyb21fc3ltYm9saWNfcGVybXMoc2VsZiwgcGF0aF9zdGF0LCB1c2VyLCBwZXJtcyk6CiAgICAgICAgcHJldl9tb2RlID0gc3RhdC5TX0lNT0RFKHBhdGhfc3RhdC5zdF9tb2RlKQoKICAgICAgICBpc19kaXJlY3RvcnkgPSBzdGF0LlNfSVNESVIocGF0aF9zdGF0LnN0X21vZGUpCiAgICAgICAgaGFzX3hfcGVybWlzc2lvbnMgPSAocHJldl9tb2RlICYgRVhFQ19QRVJNX0JJVFMpID4gMAogICAgICAgIGFwcGx5X1hfcGVybWlzc2lvbiA9IGlzX2RpcmVjdG9yeSBvciBoYXNfeF9wZXJtaXNzaW9ucwoKICAgICAgICAjIFBlcm1pc3Npb24gYml0cyBjb25zdGFudHMgZG9jdW1lbnRlZCBhdDoKICAgICAgICAjIGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvMi9saWJyYXJ5L3N0YXQuaHRtbCNzdGF0LlNfSVNVSUQKICAgICAgICBpZiBhcHBseV9YX3Blcm1pc3Npb246CiAgICAgICAgICAgIFhfcGVybXMgPSB7CiAgICAgICAgICAgICAgICAndSc6IHsnWCc6IHN0YXQuU19JWFVTUn0sCiAgICAgICAgICAgICAgICAnZyc6IHsnWCc6IHN0YXQuU19JWEdSUH0sCiAgICAgICAgICAgICAgICAnbyc6IHsnWCc6IHN0YXQuU19JWE9USH0KICAgICAgICAgICAgfQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIFhfcGVybXMgPSB7CiAgICAgICAgICAgICAgICAndSc6IHsnWCc6IDB9LAogICAgICAgICAgICAgICAgJ2cnOiB7J1gnOiAwfSwKICAgICAgICAgICAgICAgICdvJzogeydYJzogMH0KICAgICAgICAgICAgfQoKICAgICAgICB1c2VyX3Blcm1zX3RvX21vZGVzID0gewogICAgICAgICAgICAndSc6IHsKICAgICAgICAgICAgICAgICdyJzogc3RhdC5TX0lSVVNSLAogICAgICAgICAgICAgICAgJ3cnOiBzdGF0LlNfSVdVU1IsCiAgICAgICAgICAgICAgICAneCc6IHN0YXQuU19JWFVTUiwKICAgICAgICAgICAgICAgICdzJzogc3RhdC5TX0lTVUlELAogICAgICAgICAgICAgICAgJ3QnOiAwLAogICAgICAgICAgICAgICAgJ3UnOiBwcmV2X21vZGUgJiBzdGF0LlNfSVJXWFUsCiAgICAgICAgICAgICAgICAnZyc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWEcpIDw8IDMsCiAgICAgICAgICAgICAgICAnbyc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWE8pIDw8IDYgfSwKICAgICAgICAgICAgJ2cnOiB7CiAgICAgICAgICAgICAgICAncic6IHN0YXQuU19JUkdSUCwKICAgICAgICAgICAgICAgICd3Jzogc3RhdC5TX0lXR1JQLAogICAgICAgICAgICAgICAgJ3gnOiBzdGF0LlNfSVhHUlAsCiAgICAgICAgICAgICAgICAncyc6IHN0YXQuU19JU0dJRCwKICAgICAgICAgICAgICAgICd0JzogMCwKICAgICAgICAgICAgICAgICd1JzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYVSkgPj4gMywKICAgICAgICAgICAgICAgICdnJzogcHJldl9tb2RlICYgc3RhdC5TX0lSV1hHLAogICAgICAgICAgICAgICAgJ28nOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hPKSA8PCAzIH0sCiAgICAgICAgICAgICdvJzogewogICAgICAgICAgICAgICAgJ3InOiBzdGF0LlNfSVJPVEgsCiAgICAgICAgICAgICAgICAndyc6IHN0YXQuU19JV09USCwKICAgICAgICAgICAgICAgICd4Jzogc3RhdC5TX0lYT1RILAogICAgICAgICAgICAgICAgJ3MnOiAwLAogICAgICAgICAgICAgICAgJ3QnOiBzdGF0LlNfSVNWVFgsCiAgICAgICAgICAgICAgICAndSc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWFUpID4+IDYsCiAgICAgICAgICAgICAgICAnZyc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWEcpID4+IDMsCiAgICAgICAgICAgICAgICAnbyc6IHByZXZfbW9kZSAmIHN0YXQuU19JUldYTyB9CiAgICAgICAgfQoKICAgICAgICAjIEluc2VydCBYX3Blcm1zIGludG8gdXNlcl9wZXJtc190b19tb2RlcwogICAgICAgIGZvciBrZXksIHZhbHVlIGluIFhfcGVybXMuaXRlbXMoKToKICAgICAgICAgICAgdXNlcl9wZXJtc190b19tb2Rlc1trZXldLnVwZGF0ZSh2YWx1ZSkKCiAgICAgICAgb3JfcmVkdWNlID0gbGFtYmRhIG1vZGUsIHBlcm06IG1vZGUgfCB1c2VyX3Blcm1zX3RvX21vZGVzW3VzZXJdW3Blcm1dCiAgICAgICAgcmV0dXJuIHJlZHVjZShvcl9yZWR1Y2UsIHBlcm1zLCAwKQoKICAgIGRlZiBzZXRfZnNfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoc2VsZiwgZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICAjIHNldCBtb2RlcyBvd25lcnMgYW5kIGNvbnRleHQgYXMgbmVlZGVkCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydzZWNvbnRleHQnXSwgY2hhbmdlZCwgZGlmZgogICAgICAgICkKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfb3duZXJfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydvd25lciddLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQKICAgICAgICApCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X2dyb3VwX2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snZ3JvdXAnXSwgY2hhbmdlZCwgZGlmZiwgZXhwYW5kCiAgICAgICAgKQogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9tb2RlX2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snbW9kZSddLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQKICAgICAgICApCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydhdHRyaWJ1dGVzJ10sIGNoYW5nZWQsIGRpZmYsIGV4cGFuZAogICAgICAgICkKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfZGlyZWN0b3J5X2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KHNlbGYsIGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgcmV0dXJuIHNlbGYuc2V0X2ZzX2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZiwgZXhwYW5kKQoKICAgIGRlZiBzZXRfZmlsZV9hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChzZWxmLCBmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIHJldHVybiBzZWxmLnNldF9mc19hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmYsIGV4cGFuZCkKCiAgICBkZWYgYWRkX3BhdGhfaW5mbyhzZWxmLCBrd2FyZ3MpOgogICAgICAgICcnJwogICAgICAgIGZvciByZXN1bHRzIHRoYXQgYXJlIGZpbGVzLCBzdXBwbGVtZW50IHRoZSBpbmZvIGFib3V0IHRoZSBmaWxlCiAgICAgICAgaW4gdGhlIHJldHVybiBwYXRoIHdpdGggc3RhdHMgYWJvdXQgdGhlIGZpbGUgcGF0aC4KICAgICAgICAnJycKCiAgICAgICAgcGF0aCA9IGt3YXJncy5nZXQoJ3BhdGgnLCBrd2FyZ3MuZ2V0KCdkZXN0JywgTm9uZSkpCiAgICAgICAgaWYgcGF0aCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4ga3dhcmdzCiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhiX3BhdGgpOgogICAgICAgICAgICAodWlkLCBnaWQpID0gc2VsZi51c2VyX2FuZF9ncm91cChwYXRoKQogICAgICAgICAgICBrd2FyZ3NbJ3VpZCddID0gdWlkCiAgICAgICAgICAgIGt3YXJnc1snZ2lkJ10gPSBnaWQKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdXNlciA9IHB3ZC5nZXRwd3VpZCh1aWQpWzBdCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHVzZXIgPSBzdHIodWlkKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBncm91cCA9IGdycC5nZXRncmdpZChnaWQpWzBdCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIGdyb3VwID0gc3RyKGdpZCkKICAgICAgICAgICAga3dhcmdzWydvd25lciddID0gdXNlcgogICAgICAgICAgICBrd2FyZ3NbJ2dyb3VwJ10gPSBncm91cAogICAgICAgICAgICBzdCA9IG9zLmxzdGF0KGJfcGF0aCkKICAgICAgICAgICAga3dhcmdzWydtb2RlJ10gPSAnMCUwM28nICUgc3RhdC5TX0lNT0RFKHN0W3N0YXQuU1RfTU9ERV0pCiAgICAgICAgICAgICMgc2Vjb250ZXh0IG5vdCB5ZXQgc3VwcG9ydGVkCiAgICAgICAgICAgIGlmIG9zLnBhdGguaXNsaW5rKGJfcGF0aCk6CiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnbGluaycKICAgICAgICAgICAgZWxpZiBvcy5wYXRoLmlzZGlyKGJfcGF0aCk6CiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnZGlyZWN0b3J5JwogICAgICAgICAgICBlbGlmIG9zLnN0YXQoYl9wYXRoKS5zdF9ubGluayA+IDE6CiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnaGFyZCcKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdmaWxlJwogICAgICAgICAgICBpZiBIQVZFX1NFTElOVVggYW5kIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3NlY29udGV4dCddID0gJzonLmpvaW4oc2VsZi5zZWxpbnV4X2NvbnRleHQocGF0aCkpCiAgICAgICAgICAgIGt3YXJnc1snc2l6ZSddID0gc3Rbc3RhdC5TVF9TSVpFXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdhYnNlbnQnCiAgICAgICAgcmV0dXJuIGt3YXJncwoKICAgIGRlZiBfY2hlY2tfbG9jYWxlKHNlbGYpOgogICAgICAgICcnJwogICAgICAgIFVzZXMgdGhlIGxvY2FsZSBtb2R1bGUgdG8gdGVzdCB0aGUgY3VycmVudGx5IHNldCBsb2NhbGUKICAgICAgICAocGVyIHRoZSBMQU5HIGFuZCBMQ19DVFlQRSBlbnZpcm9ubWVudCBzZXR0aW5ncykKICAgICAgICAnJycKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgc2V0dGluZyB0aGUgbG9jYWxlIHRvICcnIHVzZXMgdGhlIGRlZmF1bHQgbG9jYWxlCiAgICAgICAgICAgICMgYXMgaXQgd291bGQgYmUgcmV0dXJuZWQgYnkgbG9jYWxlLmdldGRlZmF1bHRsb2NhbGUoKQogICAgICAgICAgICBsb2NhbGUuc2V0bG9jYWxlKGxvY2FsZS5MQ19BTEwsICcnKQogICAgICAgIGV4Y2VwdCBsb2NhbGUuRXJyb3I6CiAgICAgICAgICAgICMgZmFsbGJhY2sgdG8gdGhlICdDJyBsb2NhbGUsIHdoaWNoIG1heSBjYXVzZSB1bmljb2RlCiAgICAgICAgICAgICMgaXNzdWVzIGJ1dCBpcyBwcmVmZXJhYmxlIHRvIHNpbXBseSBmYWlsaW5nIGJlY2F1c2UKICAgICAgICAgICAgIyBvZiBhbiB1bmtub3duIGxvY2FsZQogICAgICAgICAgICBsb2NhbGUuc2V0bG9jYWxlKGxvY2FsZS5MQ19BTEwsICdDJykKICAgICAgICAgICAgb3MuZW52aXJvblsnTEFORyddID0gJ0MnCiAgICAgICAgICAgIG9zLmVudmlyb25bJ0xDX0FMTCddID0gJ0MnCiAgICAgICAgICAgIG9zLmVudmlyb25bJ0xDX01FU1NBR0VTJ10gPSAnQycKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iQW4gdW5rbm93biBlcnJvciB3YXMgZW5jb3VudGVyZWQgd2hpbGUgYXR0ZW1wdGluZyB0byB2YWxpZGF0ZSB0aGUgbG9jYWxlOiAlcyIgJSBlKQoKICAgIGRlZiBfaGFuZGxlX2FsaWFzZXMoc2VsZiwgc3BlYz1Ob25lKToKICAgICAgICAjIHRoaXMgdXNlcyBleGNlcHRpb25zIGFzIGl0IGhhcHBlbnMgYmVmb3JlIHdlIGNhbiBzYWZlbHkgY2FsbCBmYWlsX2pzb24KICAgICAgICBhbGlhc2VzX3Jlc3VsdHMgPSB7fSAjYWxpYXM6Y2Fub24KICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHNwZWMgPSBzZWxmLmFyZ3VtZW50X3NwZWMKICAgICAgICBmb3IgKGssdikgaW4gc3BlYy5pdGVtcygpOgogICAgICAgICAgICBzZWxmLl9sZWdhbF9pbnB1dHMuYXBwZW5kKGspCiAgICAgICAgICAgIGFsaWFzZXMgPSB2LmdldCgnYWxpYXNlcycsIE5vbmUpCiAgICAgICAgICAgIGRlZmF1bHQgPSB2LmdldCgnZGVmYXVsdCcsIE5vbmUpCiAgICAgICAgICAgIHJlcXVpcmVkID0gdi5nZXQoJ3JlcXVpcmVkJywgRmFsc2UpCiAgICAgICAgICAgIGlmIGRlZmF1bHQgaXMgbm90IE5vbmUgYW5kIHJlcXVpcmVkOgogICAgICAgICAgICAgICAgIyBub3QgYWxpYXMgc3BlY2lmaWMgYnV0IHRoaXMgaXMgYSBnb29kIHBsYWNlIHRvIGNoZWNrIHRoaXMKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiaW50ZXJuYWwgZXJyb3I6IHJlcXVpcmVkIGFuZCBkZWZhdWx0IGFyZSBtdXR1YWxseSBleGNsdXNpdmUgZm9yICVzIiAlIGspCiAgICAgICAgICAgIGlmIGFsaWFzZXMgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGFsaWFzZXMsIFNFUVVFTkNFVFlQRSkgb3IgaXNpbnN0YW5jZShhbGlhc2VzLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpOgogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCdpbnRlcm5hbCBlcnJvcjogYWxpYXNlcyBtdXN0IGJlIGEgbGlzdCBvciB0dXBsZScpCiAgICAgICAgICAgIGZvciBhbGlhcyBpbiBhbGlhc2VzOgogICAgICAgICAgICAgICAgc2VsZi5fbGVnYWxfaW5wdXRzLmFwcGVuZChhbGlhcykKICAgICAgICAgICAgICAgIGFsaWFzZXNfcmVzdWx0c1thbGlhc10gPSBrCiAgICAgICAgICAgICAgICBpZiBhbGlhcyBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcmFtc1trXSA9IHNlbGYucGFyYW1zW2FsaWFzXQoKICAgICAgICByZXR1cm4gYWxpYXNlc19yZXN1bHRzCgogICAgZGVmIF9jaGVja19hcmd1bWVudHMoc2VsZiwgY2hlY2tfaW52YWxpZF9hcmd1bWVudHMpOgogICAgICAgIHNlbGYuX3N5c2xvZ19mYWNpbGl0eSA9ICdMT0dfVVNFUicKICAgICAgICB1bnN1cHBvcnRlZF9wYXJhbWV0ZXJzID0gc2V0KCkKICAgICAgICBmb3IgKGssdikgaW4gbGlzdChzZWxmLnBhcmFtcy5pdGVtcygpKToKCiAgICAgICAgICAgIGlmIGsgPT0gJ19hbnNpYmxlX2NoZWNrX21vZGUnIGFuZCB2OgogICAgICAgICAgICAgICAgc2VsZi5jaGVja19tb2RlID0gVHJ1ZQoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9ub19sb2cnOgogICAgICAgICAgICAgICAgc2VsZi5ub19sb2cgPSBzZWxmLmJvb2xlYW4odikKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfZGVidWcnOgogICAgICAgICAgICAgICAgc2VsZi5fZGVidWcgPSBzZWxmLmJvb2xlYW4odikKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfZGlmZic6CiAgICAgICAgICAgICAgICBzZWxmLl9kaWZmID0gc2VsZi5ib29sZWFuKHYpCgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX3ZlcmJvc2l0eSc6CiAgICAgICAgICAgICAgICBzZWxmLl92ZXJib3NpdHkgPSB2CgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX3NlbGludXhfc3BlY2lhbF9mcyc6CiAgICAgICAgICAgICAgICBzZWxmLl9zZWxpbnV4X3NwZWNpYWxfZnMgPSB2CgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX3N5c2xvZ19mYWNpbGl0eSc6CiAgICAgICAgICAgICAgICBzZWxmLl9zeXNsb2dfZmFjaWxpdHkgPSB2CgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX3ZlcnNpb24nOgogICAgICAgICAgICAgICAgc2VsZi5hbnNpYmxlX3ZlcnNpb24gPSB2CgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX21vZHVsZV9uYW1lJzoKICAgICAgICAgICAgICAgIHNlbGYuX25hbWUgPSB2CgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX3NvY2tldCc6CiAgICAgICAgICAgICAgICBzZWxmLl9zb2NrZXRfcGF0aCA9IHYKCiAgICAgICAgICAgIGVsaWYgY2hlY2tfaW52YWxpZF9hcmd1bWVudHMgYW5kIGsgbm90IGluIHNlbGYuX2xlZ2FsX2lucHV0czoKICAgICAgICAgICAgICAgIHVuc3VwcG9ydGVkX3BhcmFtZXRlcnMuYWRkKGspCgogICAgICAgICAgICAjY2xlYW4gdXAgaW50ZXJuYWwgcGFyYW1zOgogICAgICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoJ19hbnNpYmxlXycpOgogICAgICAgICAgICAgICAgZGVsIHNlbGYucGFyYW1zW2tdCgogICAgICAgIGlmIHVuc3VwcG9ydGVkX3BhcmFtZXRlcnM6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iVW5zdXBwb3J0ZWQgcGFyYW1ldGVycyBmb3IgKCVzKSBtb2R1bGU6ICVzLiBTdXBwb3J0ZWQgcGFyYW1ldGVycyBpbmNsdWRlOiAlcyIgJSAoc2VsZi5fbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLCcuam9pbihzb3J0ZWQobGlzdCh1bnN1cHBvcnRlZF9wYXJhbWV0ZXJzKSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcsJy5qb2luKHNvcnRlZChzZWxmLmFyZ3VtZW50X3NwZWMua2V5cygpKSkpKQogICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZSBhbmQgbm90IHNlbGYuc3VwcG9ydHNfY2hlY2tfbW9kZToKICAgICAgICAgICAgc2VsZi5leGl0X2pzb24oc2tpcHBlZD1UcnVlLCBtc2c9InJlbW90ZSBtb2R1bGUgKCVzKSBkb2VzIG5vdCBzdXBwb3J0IGNoZWNrIG1vZGUiICUgc2VsZi5fbmFtZSkKCiAgICBkZWYgX2NvdW50X3Rlcm1zKHNlbGYsIGNoZWNrKToKICAgICAgICBjb3VudCA9IDAKICAgICAgICBmb3IgdGVybSBpbiBjaGVjazoKICAgICAgICAgICAgaWYgdGVybSBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgICAgIGNvdW50ICs9IDEKICAgICAgICByZXR1cm4gY291bnQKCiAgICBkZWYgX2NoZWNrX211dHVhbGx5X2V4Y2x1c2l2ZShzZWxmLCBzcGVjKToKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciBjaGVjayBpbiBzcGVjOgogICAgICAgICAgICBjb3VudCA9IHNlbGYuX2NvdW50X3Rlcm1zKGNoZWNrKQogICAgICAgICAgICBpZiBjb3VudCA+IDE6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9InBhcmFtZXRlcnMgYXJlIG11dHVhbGx5IGV4Y2x1c2l2ZTogJXMiICUgKGNoZWNrLCkpCgogICAgZGVmIF9jaGVja19yZXF1aXJlZF9vbmVfb2Yoc2VsZiwgc3BlYyk6CiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3IgY2hlY2sgaW4gc3BlYzoKICAgICAgICAgICAgY291bnQgPSBzZWxmLl9jb3VudF90ZXJtcyhjaGVjaykKICAgICAgICAgICAgaWYgY291bnQgPT0gMDoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0ib25lIG9mIHRoZSBmb2xsb3dpbmcgaXMgcmVxdWlyZWQ6ICVzIiAlICcsJy5qb2luKGNoZWNrKSkKCiAgICBkZWYgX2NoZWNrX3JlcXVpcmVkX3RvZ2V0aGVyKHNlbGYsIHNwZWMpOgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZm9yIGNoZWNrIGluIHNwZWM6CiAgICAgICAgICAgIGNvdW50cyA9IFsgc2VsZi5fY291bnRfdGVybXMoW2ZpZWxkXSkgZm9yIGZpZWxkIGluIGNoZWNrIF0KICAgICAgICAgICAgbm9uX3plcm8gPSBbIGMgZm9yIGMgaW4gY291bnRzIGlmIGMgPiAwIF0KICAgICAgICAgICAgaWYgbGVuKG5vbl96ZXJvKSA+IDA6CiAgICAgICAgICAgICAgICBpZiAwIGluIGNvdW50czoKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9InBhcmFtZXRlcnMgYXJlIHJlcXVpcmVkIHRvZ2V0aGVyOiAlcyIgJSAoY2hlY2ssKSkKCiAgICBkZWYgX2NoZWNrX3JlcXVpcmVkX2FyZ3VtZW50cyhzZWxmLCBzcGVjPU5vbmUsIHBhcmFtPU5vbmUgKToKICAgICAgICAnJycgZW5zdXJlIGFsbCByZXF1aXJlZCBhcmd1bWVudHMgYXJlIHByZXNlbnQgJycnCiAgICAgICAgbWlzc2luZyA9IFtdCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICBzcGVjID0gc2VsZi5hcmd1bWVudF9zcGVjCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToKICAgICAgICAgICAgcGFyYW0gPSBzZWxmLnBhcmFtcwogICAgICAgIGZvciAoayx2KSBpbiBzcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIHJlcXVpcmVkID0gdi5nZXQoJ3JlcXVpcmVkJywgRmFsc2UpCiAgICAgICAgICAgIGlmIHJlcXVpcmVkIGFuZCBrIG5vdCBpbiBwYXJhbToKICAgICAgICAgICAgICAgIG1pc3NpbmcuYXBwZW5kKGspCiAgICAgICAgaWYgbGVuKG1pc3NpbmcpID4gMDoKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJtaXNzaW5nIHJlcXVpcmVkIGFyZ3VtZW50czogJXMiICUgIiwiLmpvaW4obWlzc2luZykpCgogICAgZGVmIF9jaGVja19yZXF1aXJlZF9pZihzZWxmLCBzcGVjKToKICAgICAgICAnJycgZW5zdXJlIHRoYXQgcGFyYW1ldGVycyB3aGljaCBjb25kaXRpb25hbGx5IHJlcXVpcmVkIGFyZSBwcmVzZW50ICcnJwogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZm9yIHNwIGluIHNwZWM6CiAgICAgICAgICAgIG1pc3NpbmcgPSBbXQogICAgICAgICAgICBtYXhfbWlzc2luZ19jb3VudCA9IDAKICAgICAgICAgICAgaXNfb25lX29mID0gRmFsc2UKICAgICAgICAgICAgaWYgbGVuKHNwKSA9PSA0OgogICAgICAgICAgICAgICAga2V5LCB2YWwsIHJlcXVpcmVtZW50cywgaXNfb25lX29mID0gc3AKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGtleSwgdmFsLCByZXF1aXJlbWVudHMgPSBzcAoKICAgICAgICAgICAgIyBpc19vbmVfb2YgaXMgVHJ1ZSBhdCBsZWFzdCBvbmUgcmVxdWlyZW1lbnQgc2hvdWxkIGJlCiAgICAgICAgICAgICMgcHJlc2VudCwgZWxzZSBhbGwgcmVxdWlyZW1lbnRzIHNob3VsZCBiZSBwcmVzZW50LgogICAgICAgICAgICBpZiBpc19vbmVfb2Y6CiAgICAgICAgICAgICAgICBtYXhfbWlzc2luZ19jb3VudCA9IGxlbihyZXF1aXJlbWVudHMpCgogICAgICAgICAgICBpZiBrZXkgaW4gc2VsZi5wYXJhbXMgYW5kIHNlbGYucGFyYW1zW2tleV0gPT0gdmFsOgogICAgICAgICAgICAgICAgZm9yIGNoZWNrIGluIHJlcXVpcmVtZW50czoKICAgICAgICAgICAgICAgICAgICBjb3VudCA9IHNlbGYuX2NvdW50X3Rlcm1zKChjaGVjaywpKQogICAgICAgICAgICAgICAgICAgIGlmIGNvdW50ID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIG1pc3NpbmcuYXBwZW5kKGNoZWNrKQogICAgICAgICAgICBpZiBsZW4obWlzc2luZykgYW5kIGxlbihtaXNzaW5nKSA+PSBtYXhfbWlzc2luZ19jb3VudDoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iJXMgaXMgJXMgYnV0IHRoZSBmb2xsb3dpbmcgYXJlIG1pc3Npbmc6ICVzIiAlIChrZXksIHZhbCwgJywnLmpvaW4obWlzc2luZykpKQoKICAgIGRlZiBfY2hlY2tfYXJndW1lbnRfdmFsdWVzKHNlbGYsIHNwZWM9Tm9uZSwgcGFyYW09Tm9uZSk6CiAgICAgICAgJycnIGVuc3VyZSBhbGwgYXJndW1lbnRzIGhhdmUgdGhlIHJlcXVlc3RlZCB2YWx1ZXMsIGFuZCB0aGVyZSBhcmUgbm8gc3RyYXkgYXJndW1lbnRzICcnJwogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgc3BlYyA9IHNlbGYuYXJndW1lbnRfc3BlYwogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAgICAgIHBhcmFtID0gc2VsZi5wYXJhbXMKICAgICAgICBmb3IgKGssdikgaW4gc3BlYy5pdGVtcygpOgogICAgICAgICAgICBjaG9pY2VzID0gdi5nZXQoJ2Nob2ljZXMnLE5vbmUpCiAgICAgICAgICAgIGlmIGNob2ljZXMgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoY2hvaWNlcywgU0VRVUVOQ0VUWVBFKSBhbmQgbm90IGlzaW5zdGFuY2UoY2hvaWNlcywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKToKICAgICAgICAgICAgICAgIGlmIGsgaW4gcGFyYW06CiAgICAgICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gbm90IGluIGNob2ljZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICMgUHlZYW1sIGNvbnZlcnRzIGNlcnRhaW4gc3RyaW5ncyB0byBib29scy4gIElmIHdlIGNhbiB1bmFtYmlndW91c2x5IGNvbnZlcnQgYmFjaywgZG8gc28gYmVmb3JlIGNoZWNraW5nCiAgICAgICAgICAgICAgICAgICAgICAgICMgdGhlIHZhbHVlLiAgSWYgd2UgY2FuJ3QgZmlndXJlIHRoaXMgb3V0LCBtb2R1bGUgYXV0aG9yIGlzIHJlc3BvbnNpYmxlLgogICAgICAgICAgICAgICAgICAgICAgICBsb3dlcmVkX2Nob2ljZXMgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdID09ICdGYWxzZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb3dlcmVkX2Nob2ljZXMgPSBfbGVuaWVudF9sb3dlcmNhc2UoY2hvaWNlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZBTFNFWSA9IGZyb3plbnNldChCT09MRUFOU19GQUxTRSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJsYXAgPSBGQUxTRVkuaW50ZXJzZWN0aW9uKGNob2ljZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4ob3ZlcmxhcCkgPT0gMToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEV4dHJhY3QgZnJvbSBhIHNldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChwYXJhbVtrXSwpID0gb3ZlcmxhcAoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gPT0gJ1RydWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbG93ZXJlZF9jaG9pY2VzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJlZF9jaG9pY2VzID0gX2xlbmllbnRfbG93ZXJjYXNlKGNob2ljZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBUUlVUSFkgPSBmcm96ZW5zZXQoQk9PTEVBTlNfVFJVRSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJsYXAgPSBUUlVUSFkuaW50ZXJzZWN0aW9uKGNob2ljZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4ob3ZlcmxhcCkgPT0gMToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAocGFyYW1ba10sKSA9IG92ZXJsYXAKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdIG5vdCBpbiBjaG9pY2VzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlc19zdHI9IiwiLmpvaW4oW3RvX25hdGl2ZShjKSBmb3IgYyBpbiBjaG9pY2VzXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZz0idmFsdWUgb2YgJXMgbXVzdCBiZSBvbmUgb2Y6ICVzLCBnb3Q6ICVzIiAlIChrLCBjaG9pY2VzX3N0ciwgcGFyYW1ba10pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9bXNnKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJpbnRlcm5hbCBlcnJvcjogY2hvaWNlcyBmb3IgYXJndW1lbnQgJXMgYXJlIG5vdCBpdGVyYWJsZTogJXMiICUgKGssIGNob2ljZXMpKQoKICAgIGRlZiBzYWZlX2V2YWwoc2VsZiwgdmFsdWUsIGxvY2Fscz1Ob25lLCBpbmNsdWRlX2V4Y2VwdGlvbnM9RmFsc2UpOgoKICAgICAgICAjIGRvIG5vdCBhbGxvdyBtZXRob2QgY2FsbHMgdG8gbW9kdWxlcwogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICAjIGFscmVhZHkgdGVtcGxhdGVkIHRvIGEgZGF0YXZhbHVlc3RydWN0dXJlLCBwZXJoYXBzPwogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHZhbHVlLCBOb25lKQogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICBpZiByZS5zZWFyY2gocidcd1wuXHcrXCgnLCB2YWx1ZSk6CiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAodmFsdWUsIE5vbmUpCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgICMgZG8gbm90IGFsbG93IGltcG9ydHMKICAgICAgICBpZiByZS5zZWFyY2gocidpbXBvcnQgXHcrJywgdmFsdWUpOgogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHZhbHVlLCBOb25lKQogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3VsdCA9IGxpdGVyYWxfZXZhbCh2YWx1ZSkKICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuIChyZXN1bHQsIE5vbmUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHZhbHVlLCBlKQogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICBkZWYgX2NoZWNrX3R5cGVfc3RyKHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICAjIE5vdGU6IFRoaXMgY291bGQgdGhyb3cgYSB1bmljb2RlIGVycm9yIGlmIHZhbHVlJ3MgX19zdHJfXygpIG1ldGhvZAogICAgICAgICMgcmV0dXJucyBub24tYXNjaWkuICBIYXZlIHRvIHBvcnQgdXRpbHMudG9fYnl0ZXMoKSBpZiB0aGF0IGhhcHBlbnMKICAgICAgICByZXR1cm4gc3RyKHZhbHVlKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9saXN0KHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBsaXN0KToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5zcGxpdCgiLCIpCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBpbnQpIG9yIGlzaW5zdGFuY2UodmFsdWUsIGZsb2F0KToKICAgICAgICAgICAgcmV0dXJuIFsgc3RyKHZhbHVlKSBdCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGxpc3QnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2RpY3Qoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGRpY3QpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgaWYgdmFsdWUuc3RhcnRzd2l0aCgieyIpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmxvYWRzKHZhbHVlKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIChyZXN1bHQsIGV4YykgPSBzZWxmLnNhZmVfZXZhbCh2YWx1ZSwgZGljdCgpLCBpbmNsdWRlX2V4Y2VwdGlvbnM9VHJ1ZSkKICAgICAgICAgICAgICAgICAgICBpZiBleGMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigndW5hYmxlIHRvIGV2YWx1YXRlIHN0cmluZyBhcyBkaWN0aW9uYXJ5JykKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0CiAgICAgICAgICAgIGVsaWYgJz0nIGluIHZhbHVlOgogICAgICAgICAgICAgICAgZmllbGRzID0gW10KICAgICAgICAgICAgICAgIGZpZWxkX2J1ZmZlciA9IFtdCiAgICAgICAgICAgICAgICBpbl9xdW90ZSA9IEZhbHNlCiAgICAgICAgICAgICAgICBpbl9lc2NhcGUgPSBGYWxzZQogICAgICAgICAgICAgICAgZm9yIGMgaW4gdmFsdWUuc3RyaXAoKToKICAgICAgICAgICAgICAgICAgICBpZiBpbl9lc2NhcGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkX2J1ZmZlci5hcHBlbmQoYykKICAgICAgICAgICAgICAgICAgICAgICAgaW5fZXNjYXBlID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBlbGlmIGMgPT0gJ1xcJzoKICAgICAgICAgICAgICAgICAgICAgICAgaW5fZXNjYXBlID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGVsaWYgbm90IGluX3F1b3RlIGFuZCBjIGluICgnXCcnLCAnIicpOgogICAgICAgICAgICAgICAgICAgICAgICBpbl9xdW90ZSA9IGMKICAgICAgICAgICAgICAgICAgICBlbGlmIGluX3F1b3RlIGFuZCBpbl9xdW90ZSA9PSBjOgogICAgICAgICAgICAgICAgICAgICAgICBpbl9xdW90ZSA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgZWxpZiBub3QgaW5fcXVvdGUgYW5kIGMgaW4gKCcsJywgJyAnKToKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQgPSAnJy5qb2luKGZpZWxkX2J1ZmZlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZmllbGQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHMuYXBwZW5kKGZpZWxkKQogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZF9idWZmZXIgPSBbXQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkX2J1ZmZlci5hcHBlbmQoYykKCiAgICAgICAgICAgICAgICBmaWVsZCA9ICcnLmpvaW4oZmllbGRfYnVmZmVyKQogICAgICAgICAgICAgICAgaWYgZmllbGQ6CiAgICAgICAgICAgICAgICAgICAgZmllbGRzLmFwcGVuZChmaWVsZCkKICAgICAgICAgICAgICAgIHJldHVybiBkaWN0KHguc3BsaXQoIj0iLCAxKSBmb3IgeCBpbiBmaWVsZHMpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoImRpY3Rpb25hcnkgcmVxdWVzdGVkLCBjb3VsZCBub3QgcGFyc2UgSlNPTiBvciBrZXk9dmFsdWUiKQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBkaWN0JyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9ib29sKHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBib29sKToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcykgb3IgaXNpbnN0YW5jZSh2YWx1ZSwgaW50KToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuYm9vbGVhbih2YWx1ZSkKCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgYm9vbCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfaW50KHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBpbnQpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgcmV0dXJuIGludCh2YWx1ZSkKCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGFuIGludCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfZmxvYXQoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGZsb2F0KToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlLCBpbnQpKToKICAgICAgICAgICAgcmV0dXJuIGZsb2F0KHZhbHVlKQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBmbG9hdCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfcGF0aChzZWxmLCB2YWx1ZSk6CiAgICAgICAgdmFsdWUgPSBzZWxmLl9jaGVja190eXBlX3N0cih2YWx1ZSkKICAgICAgICByZXR1cm4gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2pzb25hcmcoc2VsZiwgdmFsdWUpOgogICAgICAgICMgUmV0dXJuIGEganNvbmlmaWVkIHN0cmluZy4gIFNvbWV0aW1lcyB0aGUgY29udHJvbGxlciB0dXJucyBhIGpzb24KICAgICAgICAjIHN0cmluZyBpbnRvIGEgZGljdC9saXN0IHNvIHRyYW5zZm9ybSBpdCBiYWNrIGludG8ganNvbiBoZXJlCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnN0cmlwKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCAobGlzdCwgdHVwbGUsIGRpY3QpKToKICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmR1bXBzKHZhbHVlKQogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGpzb24gc3RyaW5nJyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9yYXcoc2VsZiwgdmFsdWUpOgogICAgICAgIHJldHVybiB2YWx1ZQoKCiAgICBkZWYgX2NoZWNrX3R5cGVfYnl0ZXMoc2VsZiwgdmFsdWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5odW1hbl90b19ieXRlcyh2YWx1ZSkKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgQnl0ZSB2YWx1ZScgJSB0eXBlKHZhbHVlKSkKCgogICAgZGVmIF9jaGVja190eXBlX2JpdHMoc2VsZiwgdmFsdWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5odW1hbl90b19ieXRlcyh2YWx1ZSwgaXNiaXRzPVRydWUpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIEJpdCB2YWx1ZScgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX2FyZ3VtZW50X3R5cGVzKHNlbGYsIHNwZWM9Tm9uZSwgcGFyYW09Tm9uZSk6CiAgICAgICAgJycnIGVuc3VyZSBhbGwgYXJndW1lbnRzIGhhdmUgdGhlIHJlcXVlc3RlZCB0eXBlICcnJwoKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHNwZWMgPSBzZWxmLmFyZ3VtZW50X3NwZWMKICAgICAgICBpZiBwYXJhbSBpcyBOb25lOgogICAgICAgICAgICBwYXJhbSA9IHNlbGYucGFyYW1zCgogICAgICAgIGZvciAoaywgdikgaW4gc3BlYy5pdGVtcygpOgogICAgICAgICAgICB3YW50ZWQgPSB2LmdldCgndHlwZScsIE5vbmUpCiAgICAgICAgICAgIGlmIGsgbm90IGluIHBhcmFtOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgd2FudGVkIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAjIE1vc3RseSB3ZSB3YW50IHRvIGRlZmF1bHQgdG8gc3RyLgogICAgICAgICAgICAgICAgIyBGb3IgdmFsdWVzIHNldCB0byBOb25lIGV4cGxpY2l0bHksIHJldHVybiBOb25lIGluc3RlYWQgYXMKICAgICAgICAgICAgICAgICMgdGhhdCBhbGxvd3MgYSB1c2VyIHRvIHVuc2V0IGEgcGFyYW1ldGVyCiAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB3YW50ZWQgPSAnc3RyJwoKICAgICAgICAgICAgdmFsdWUgPSBwYXJhbVtrXQogICAgICAgICAgICBpZiB2YWx1ZSBpcyBOb25lOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHR5cGVfY2hlY2tlciA9IHNlbGYuX0NIRUNLX0FSR1VNRU5UX1RZUEVTX0RJU1BBVENIRVJbd2FudGVkXQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImltcGxlbWVudGF0aW9uIGVycm9yOiB1bmtub3duIHR5cGUgJXMgcmVxdWVzdGVkIGZvciAlcyIgJSAod2FudGVkLCBrKSkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcGFyYW1ba10gPSB0eXBlX2NoZWNrZXIodmFsdWUpCiAgICAgICAgICAgIGV4Y2VwdCAoVHlwZUVycm9yLCBWYWx1ZUVycm9yKToKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iYXJndW1lbnQgJXMgaXMgb2YgdHlwZSAlcyBhbmQgd2Ugd2VyZSB1bmFibGUgdG8gY29udmVydCB0byAlczogJXMiICUgKGssIHR5cGUodmFsdWUpLCB3YW50ZWQsIGUpKQoKICAgICAgICAgICAgIyBkZWFsIHdpdGggc3ViIG9wdGlvbnMgdG8gY3JlYXRlIHN1YiBzcGVjCiAgICAgICAgICAgIHNwZWMgPSBOb25lCiAgICAgICAgICAgIGlmIHdhbnRlZCA9PSAnZGljdCcgb3IgKHdhbnRlZCA9PSAnbGlzdCcgYW5kIHYuZ2V0KCdlbGVtZW50cycsICcnKSA9PSAnZGljdCcpOgogICAgICAgICAgICAgICAgc3BlYyA9IHYuZ2V0KCdvcHRpb25zJywgTm9uZSkKICAgICAgICAgICAgICAgIGlmIHNwZWM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfYXJndW1lbnRzKHNwZWMsIHBhcmFtW2tdKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50X3R5cGVzKHNwZWMsIHBhcmFtW2tdKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50X3ZhbHVlcyhzcGVjLCBwYXJhbVtrXSkKCiAgICBkZWYgX3NldF9kZWZhdWx0cyhzZWxmLCBwcmU9VHJ1ZSk6CiAgICAgICAgZm9yIChrLHYpIGluIHNlbGYuYXJndW1lbnRfc3BlYy5pdGVtcygpOgogICAgICAgICAgICBkZWZhdWx0ID0gdi5nZXQoJ2RlZmF1bHQnLCBOb25lKQogICAgICAgICAgICBpZiBwcmUgaXMgVHJ1ZToKICAgICAgICAgICAgICAgICMgdGhpcyBwcmV2ZW50cyBzZXR0aW5nIGRlZmF1bHRzIG9uIHJlcXVpcmVkIGl0ZW1zCiAgICAgICAgICAgICAgICBpZiBkZWZhdWx0IGlzIG5vdCBOb25lIGFuZCBrIG5vdCBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcmFtc1trXSA9IGRlZmF1bHQKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgbWFrZSBzdXJlIHRoaW5ncyB3aXRob3V0IGEgZGVmYXVsdCBzdGlsbCBnZXQgc2V0IE5vbmUKICAgICAgICAgICAgICAgIGlmIGsgbm90IGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyYW1zW2tdID0gZGVmYXVsdAoKICAgIGRlZiBfc2V0X2ZhbGxiYWNrcyhzZWxmKToKICAgICAgICBmb3Igayx2IGluIHNlbGYuYXJndW1lbnRfc3BlYy5pdGVtcygpOgogICAgICAgICAgICBmYWxsYmFjayA9IHYuZ2V0KCdmYWxsYmFjaycsIChOb25lLCkpCiAgICAgICAgICAgIGZhbGxiYWNrX3N0cmF0ZWd5ID0gZmFsbGJhY2tbMF0KICAgICAgICAgICAgZmFsbGJhY2tfYXJncyA9IFtdCiAgICAgICAgICAgIGZhbGxiYWNrX2t3YXJncyA9IHt9CiAgICAgICAgICAgIGlmIGsgbm90IGluIHNlbGYucGFyYW1zIGFuZCBmYWxsYmFja19zdHJhdGVneSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGZvciBpdGVtIGluIGZhbGxiYWNrWzE6XToKICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGl0ZW0sIGRpY3QpOgogICAgICAgICAgICAgICAgICAgICAgICBmYWxsYmFja19rd2FyZ3MgPSBpdGVtCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tfYXJncyA9IGl0ZW0KICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcmFtc1trXSA9IGZhbGxiYWNrX3N0cmF0ZWd5KCpmYWxsYmFja19hcmdzLCAqKmZhbGxiYWNrX2t3YXJncykKICAgICAgICAgICAgICAgIGV4Y2VwdCBBbnNpYmxlRmFsbGJhY2tOb3RGb3VuZDoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgIGRlZiBfbG9hZF9wYXJhbXMoc2VsZik6CiAgICAgICAgJycnIHJlYWQgdGhlIGlucHV0IGFuZCBzZXQgdGhlIHBhcmFtcyBhdHRyaWJ1dGUuCgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4gIFRoZSBndXRzIG9mIHRoZSBmdW5jdGlvbgogICAgICAgIHdlcmUgbW92ZWQgb3V0IGluIDIuMSBzbyB0aGF0IGN1c3RvbSBtb2R1bGVzIGNvdWxkIHJlYWQgdGhlIHBhcmFtZXRlcnMuCiAgICAgICAgJycnCiAgICAgICAgIyBkZWJ1ZyBvdmVycmlkZXMgdG8gcmVhZCBhcmdzIGZyb20gZmlsZSBvciBjbWRsaW5lCiAgICAgICAgc2VsZi5wYXJhbXMgPSBfbG9hZF9wYXJhbXMoKQoKICAgIGRlZiBfbG9nX3RvX3N5c2xvZyhzZWxmLCBtc2cpOgogICAgICAgIGlmIEhBU19TWVNMT0c6CiAgICAgICAgICAgIG1vZHVsZSA9ICdhbnNpYmxlLSVzJyAlIHNlbGYuX25hbWUKICAgICAgICAgICAgZmFjaWxpdHkgPSBnZXRhdHRyKHN5c2xvZywgc2VsZi5fc3lzbG9nX2ZhY2lsaXR5LCBzeXNsb2cuTE9HX1VTRVIpCiAgICAgICAgICAgIHN5c2xvZy5vcGVubG9nKHN0cihtb2R1bGUpLCAwLCBmYWNpbGl0eSkKICAgICAgICAgICAgc3lzbG9nLnN5c2xvZyhzeXNsb2cuTE9HX0lORk8sIG1zZykKCiAgICBkZWYgZGVidWcoc2VsZiwgbXNnKToKICAgICAgICBpZiBzZWxmLl9kZWJ1ZzoKICAgICAgICAgICAgc2VsZi5sb2coJ1tkZWJ1Z10gJXMnICUgbXNnKQoKICAgIGRlZiBsb2coc2VsZiwgbXNnLCBsb2dfYXJncz1Ob25lKToKCiAgICAgICAgaWYgbm90IHNlbGYubm9fbG9nOgoKICAgICAgICAgICAgaWYgbG9nX2FyZ3MgaXMgTm9uZToKICAgICAgICAgICAgICAgIGxvZ19hcmdzID0gZGljdCgpCgogICAgICAgICAgICBtb2R1bGUgPSAnYW5zaWJsZS0lcycgJSBzZWxmLl9uYW1lCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UobW9kdWxlLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgICAgICBtb2R1bGUgPSBtb2R1bGUuZGVjb2RlKCd1dGYtOCcsICdyZXBsYWNlJykKCiAgICAgICAgICAgICMgNjY1NSAtIGFsbG93IGZvciBhY2NlbnRlZCBjaGFyYWN0ZXJzCiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG1zZywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigibXNnIHNob3VsZCBiZSBhIHN0cmluZyAoZ290ICVzKSIgJSB0eXBlKG1zZykpCgogICAgICAgICAgICAjIFdlIHdhbnQgam91cm5hbCB0byBhbHdheXMgdGFrZSB0ZXh0IHR5cGUKICAgICAgICAgICAgIyBzeXNsb2cgdGFrZXMgYnl0ZXMgb24gcHkyLCB0ZXh0IHR5cGUgb24gcHkzCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UobXNnLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgICAgICBqb3VybmFsX21zZyA9IHJlbW92ZV92YWx1ZXMobXNnLmRlY29kZSgndXRmLTgnLCAncmVwbGFjZScpLCBzZWxmLm5vX2xvZ192YWx1ZXMpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFRPRE86IHN1cnJvZ2F0ZWVzY2FwZSBpcyBhIGRhbmdlciBoZXJlIG9uIFB5MwogICAgICAgICAgICAgICAgam91cm5hbF9tc2cgPSByZW1vdmVfdmFsdWVzKG1zZywgc2VsZi5ub19sb2dfdmFsdWVzKQoKICAgICAgICAgICAgaWYgUFkzOgogICAgICAgICAgICAgICAgc3lzbG9nX21zZyA9IGpvdXJuYWxfbXNnCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzeXNsb2dfbXNnID0gam91cm5hbF9tc2cuZW5jb2RlKCd1dGYtOCcsICdyZXBsYWNlJykKCiAgICAgICAgICAgIGlmIGhhc19qb3VybmFsOgogICAgICAgICAgICAgICAgam91cm5hbF9hcmdzID0gWygiTU9EVUxFIiwgb3MucGF0aC5iYXNlbmFtZShfX2ZpbGVfXykpXQogICAgICAgICAgICAgICAgZm9yIGFyZyBpbiBsb2dfYXJnczoKICAgICAgICAgICAgICAgICAgICBqb3VybmFsX2FyZ3MuYXBwZW5kKChhcmcudXBwZXIoKSwgc3RyKGxvZ19hcmdzW2FyZ10pKSkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBqb3VybmFsLnNlbmQodSIlcyAlcyIgJSAobW9kdWxlLCBqb3VybmFsX21zZyksICoqZGljdChqb3VybmFsX2FyZ3MpKQogICAgICAgICAgICAgICAgZXhjZXB0IElPRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgIyBmYWxsIGJhY2sgdG8gc3lzbG9nIHNpbmNlIGxvZ2dpbmcgdG8gam91cm5hbCBmYWlsZWQKICAgICAgICAgICAgICAgICAgICBzZWxmLl9sb2dfdG9fc3lzbG9nKHN5c2xvZ19tc2cpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLl9sb2dfdG9fc3lzbG9nKHN5c2xvZ19tc2cpCgogICAgZGVmIF9sb2dfaW52b2NhdGlvbihzZWxmKToKICAgICAgICAnJycgbG9nIHRoYXQgYW5zaWJsZSByYW4gdGhlIG1vZHVsZSAnJycKICAgICAgICAjIFRPRE86IGdlbmVyYWxpemUgYSBzZXBhcmF0ZSBsb2cgZnVuY3Rpb24gYW5kIG1ha2UgbG9nX2ludm9jYXRpb24gdXNlIGl0CiAgICAgICAgIyBTYW5pdGl6ZSBwb3NzaWJsZSBwYXNzd29yZCBhcmd1bWVudCB3aGVuIGxvZ2dpbmcuCiAgICAgICAgbG9nX2FyZ3MgPSBkaWN0KCkKCiAgICAgICAgZm9yIHBhcmFtIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICBjYW5vbiAgPSBzZWxmLmFsaWFzZXMuZ2V0KHBhcmFtLCBwYXJhbSkKICAgICAgICAgICAgYXJnX29wdHMgPSBzZWxmLmFyZ3VtZW50X3NwZWMuZ2V0KGNhbm9uLCB7fSkKICAgICAgICAgICAgbm9fbG9nID0gYXJnX29wdHMuZ2V0KCdub19sb2cnLCBGYWxzZSkKCiAgICAgICAgICAgIGlmIHNlbGYuYm9vbGVhbihub19sb2cpOgogICAgICAgICAgICAgICAgbG9nX2FyZ3NbcGFyYW1dID0gJ05PVF9MT0dHSU5HX1BBUkFNRVRFUicKICAgICAgICAgICAgIyB0cnkgdG8gY2FwdHVyZSBhbGwgcGFzc3dvcmRzL3Bhc3NwaHJhc2UgbmFtZWQgZmllbGRzIG1pc3NlZCBieSBub19sb2cKICAgICAgICAgICAgZWxpZiBQQVNTV09SRF9NQVRDSC5zZWFyY2gocGFyYW0pIGFuZCBcCiAgICAgICAgICAgICAgYXJnX29wdHMuZ2V0KCd0eXBlJywgJ3N0cicpICE9ICdib29sJyBhbmQgXAogICAgICAgICAgICAgIG5vdCBhcmdfb3B0cy5nZXQoJ2Nob2ljZXMnLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAjIHNraXAgYm9vbGVhbiBhbmQgZW51bXMgYXMgdGhleSBhcmUgYWJvdXQgJ3Bhc3N3b3JkJyBzdGF0ZQogICAgICAgICAgICAgICAgbG9nX2FyZ3NbcGFyYW1dID0gJ05PVF9MT0dHSU5HX1BBU1NXT1JEJwogICAgICAgICAgICAgICAgc2VsZi53YXJuKCdNb2R1bGUgZGlkIG5vdCBzZXQgbm9fbG9nIGZvciAlcycgJSBwYXJhbSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHBhcmFtX3ZhbCA9IHNlbGYucGFyYW1zW3BhcmFtXQogICAgICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UocGFyYW1fdmFsLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgICAgICAgICAgICAgIHBhcmFtX3ZhbCA9IHN0cihwYXJhbV92YWwpCiAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UocGFyYW1fdmFsLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICAgICAgICAgIHBhcmFtX3ZhbCA9IHBhcmFtX3ZhbC5lbmNvZGUoJ3V0Zi04JykKICAgICAgICAgICAgICAgIGxvZ19hcmdzW3BhcmFtXSA9IGhldXJpc3RpY19sb2dfc2FuaXRpemUocGFyYW1fdmFsLCBzZWxmLm5vX2xvZ192YWx1ZXMpCgogICAgICAgIG1zZyA9IFsnJXM9JXMnICUgKHRvX25hdGl2ZShhcmcpLCB0b19uYXRpdmUodmFsKSkgZm9yIGFyZywgdmFsIGluIGxvZ19hcmdzLml0ZW1zKCldCiAgICAgICAgaWYgbXNnOgogICAgICAgICAgICBtc2cgPSAnSW52b2tlZCB3aXRoICVzJyAlICcgJy5qb2luKG1zZykKICAgICAgICBlbHNlOgogICAgICAgICAgICBtc2cgPSAnSW52b2tlZCcKCiAgICAgICAgc2VsZi5sb2cobXNnLCBsb2dfYXJncz1sb2dfYXJncykKCgogICAgZGVmIF9zZXRfY3dkKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgY3dkID0gb3MuZ2V0Y3dkKCkKICAgICAgICAgICAgaWYgbm90IG9zLmFjY2Vzcyhjd2QsIG9zLkZfT0t8b3MuUl9PSyk6CiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oKQogICAgICAgICAgICByZXR1cm4gY3dkCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAjIHdlIGRvbid0IGhhdmUgYWNjZXNzIHRvIHRoZSBjd2QsIHByb2JhYmx5IGJlY2F1c2Ugb2Ygc3Vkby4KICAgICAgICAgICAgIyBUcnkgYW5kIG1vdmUgdG8gYSBuZXV0cmFsIGxvY2F0aW9uIHRvIHByZXZlbnQgZXJyb3JzCiAgICAgICAgICAgIGZvciBjd2QgaW4gW29zLnBhdGguZXhwYW5kdmFycygnJEhPTUUnKSwgdGVtcGZpbGUuZ2V0dGVtcGRpcigpXToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBvcy5hY2Nlc3MoY3dkLCBvcy5GX09LfG9zLlJfT0spOgogICAgICAgICAgICAgICAgICAgICAgICBvcy5jaGRpcihjd2QpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjd2QKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgIyB3ZSB3b24ndCBlcnJvciBoZXJlLCBhcyBpdCBtYXkgKm5vdCogYmUgYSBwcm9ibGVtLAogICAgICAgICMgYW5kIHdlIGRvbid0IHdhbnQgdG8gYnJlYWsgbW9kdWxlcyB1bm5lY2Vzc2FyaWx5CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgZ2V0X2Jpbl9wYXRoKHNlbGYsIGFyZywgcmVxdWlyZWQ9RmFsc2UsIG9wdF9kaXJzPVtdKToKICAgICAgICAnJycKICAgICAgICBmaW5kIHN5c3RlbSBleGVjdXRhYmxlIGluIFBBVEguCiAgICAgICAgT3B0aW9uYWwgYXJndW1lbnRzOgogICAgICAgICAgIC0gcmVxdWlyZWQ6ICBpZiBleGVjdXRhYmxlIGlzIG5vdCBmb3VuZCBhbmQgcmVxdWlyZWQgaXMgdHJ1ZSwgZmFpbF9qc29uCiAgICAgICAgICAgLSBvcHRfZGlyczogIG9wdGlvbmFsIGxpc3Qgb2YgZGlyZWN0b3JpZXMgdG8gc2VhcmNoIGluIGFkZGl0aW9uIHRvIFBBVEgKICAgICAgICBpZiBmb3VuZCByZXR1cm4gZnVsbCBwYXRoOyBvdGhlcndpc2UgcmV0dXJuIE5vbmUKICAgICAgICAnJycKICAgICAgICBzYmluX3BhdGhzID0gWycvc2JpbicsICcvdXNyL3NiaW4nLCAnL3Vzci9sb2NhbC9zYmluJ10KICAgICAgICBwYXRocyA9IFtdCiAgICAgICAgZm9yIGQgaW4gb3B0X2RpcnM6CiAgICAgICAgICAgIGlmIGQgaXMgbm90IE5vbmUgYW5kIG9zLnBhdGguZXhpc3RzKGQpOgogICAgICAgICAgICAgICAgcGF0aHMuYXBwZW5kKGQpCiAgICAgICAgcGF0aHMgKz0gb3MuZW52aXJvbi5nZXQoJ1BBVEgnLCAnJykuc3BsaXQob3MucGF0aHNlcCkKICAgICAgICBiaW5fcGF0aCA9IE5vbmUKICAgICAgICAjIG1hbmdsZSBQQVRIIHRvIGluY2x1ZGUgL3NiaW4gZGlycwogICAgICAgIGZvciBwIGluIHNiaW5fcGF0aHM6CiAgICAgICAgICAgIGlmIHAgbm90IGluIHBhdGhzIGFuZCBvcy5wYXRoLmV4aXN0cyhwKToKICAgICAgICAgICAgICAgIHBhdGhzLmFwcGVuZChwKQogICAgICAgIGZvciBkIGluIHBhdGhzOgogICAgICAgICAgICBpZiBub3QgZDoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIHBhdGggPSBvcy5wYXRoLmpvaW4oZCwgYXJnKQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhwYXRoKSBhbmQgbm90IG9zLnBhdGguaXNkaXIocGF0aCkgYW5kIGlzX2V4ZWN1dGFibGUocGF0aCk6CiAgICAgICAgICAgICAgICBiaW5fcGF0aCA9IHBhdGgKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgaWYgcmVxdWlyZWQgYW5kIGJpbl9wYXRoIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nRmFpbGVkIHRvIGZpbmQgcmVxdWlyZWQgZXhlY3V0YWJsZSAlcyBpbiBwYXRoczogJXMnICUgKGFyZywgb3MucGF0aHNlcC5qb2luKHBhdGhzKSkpCiAgICAgICAgcmV0dXJuIGJpbl9wYXRoCgogICAgZGVmIGJvb2xlYW4oc2VsZiwgYXJnKToKICAgICAgICAnJycgcmV0dXJuIGEgYm9vbCBmb3IgdGhlIGFyZyAnJycKICAgICAgICBpZiBhcmcgaXMgTm9uZSBvciBpc2luc3RhbmNlKGFyZywgYm9vbCk6CiAgICAgICAgICAgIHJldHVybiBhcmcKICAgICAgICBpZiBpc2luc3RhbmNlKGFyZywgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgYXJnID0gYXJnLmxvd2VyKCkKICAgICAgICBpZiBhcmcgaW4gQk9PTEVBTlNfVFJVRToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbGlmIGFyZyBpbiBCT09MRUFOU19GQUxTRToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSclcyBpcyBub3QgYSB2YWxpZCBib29sZWFuLiBWYWxpZCBib29sZWFucyBpbmNsdWRlOiAlcycgJSAodG9fdGV4dChhcmcpLCAnLCcuam9pbihbJyVzJyAlIHggZm9yIHggaW4gQk9PTEVBTlNdKSkpCgogICAgZGVmIGpzb25pZnkoc2VsZiwgZGF0YSk6CiAgICAgICAgZm9yIGVuY29kaW5nIGluICgidXRmLTgiLCAibGF0aW4tMSIpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5kdW1wcyhkYXRhLCBlbmNvZGluZz1lbmNvZGluZykKICAgICAgICAgICAgIyBPbGQgc3lzdGVtcyB1c2luZyBvbGQgc2ltcGxlanNvbiBtb2R1bGUgZG9lcyBub3Qgc3VwcG9ydCBlbmNvZGluZyBrZXl3b3JkLgogICAgICAgICAgICBleGNlcHQgVHlwZUVycm9yOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG5ld19kYXRhID0ganNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUoZGF0YSwgZW5jb2Rpbmc9ZW5jb2RpbmcpCiAgICAgICAgICAgICAgICBleGNlcHQgVW5pY29kZURlY29kZUVycm9yOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5kdW1wcyhuZXdfZGF0YSkKICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVEZWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdJbnZhbGlkIHVuaWNvZGUgZW5jb2RpbmcgZW5jb3VudGVyZWQnKQoKICAgIGRlZiBmcm9tX2pzb24oc2VsZiwgZGF0YSk6CiAgICAgICAgcmV0dXJuIGpzb24ubG9hZHMoZGF0YSkKCiAgICBkZWYgYWRkX2NsZWFudXBfZmlsZShzZWxmLCBwYXRoKToKICAgICAgICBpZiBwYXRoIG5vdCBpbiBzZWxmLmNsZWFudXBfZmlsZXM6CiAgICAgICAgICAgIHNlbGYuY2xlYW51cF9maWxlcy5hcHBlbmQocGF0aCkKCiAgICBkZWYgZG9fY2xlYW51cF9maWxlcyhzZWxmKToKICAgICAgICBmb3IgcGF0aCBpbiBzZWxmLmNsZWFudXBfZmlsZXM6CiAgICAgICAgICAgIHNlbGYuY2xlYW51cChwYXRoKQoKICAgIGRlZiBfcmV0dXJuX2Zvcm1hdHRlZChzZWxmLCBrd2FyZ3MpOgoKICAgICAgICBzZWxmLmFkZF9wYXRoX2luZm8oa3dhcmdzKQoKICAgICAgICBpZiAnaW52b2NhdGlvbicgbm90IGluIGt3YXJnczoKICAgICAgICAgICAga3dhcmdzWydpbnZvY2F0aW9uJ10gPSB7J21vZHVsZV9hcmdzJzogc2VsZi5wYXJhbXN9CgogICAgICAgIGlmICd3YXJuaW5ncycgaW4ga3dhcmdzOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGt3YXJnc1snd2FybmluZ3MnXSwgbGlzdCk6CiAgICAgICAgICAgICAgICBmb3IgdyBpbiBrd2FyZ3NbJ3dhcm5pbmdzJ106CiAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJuKHcpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLndhcm4oa3dhcmdzWyd3YXJuaW5ncyddKQoKICAgICAgICBpZiBzZWxmLl93YXJuaW5nczoKICAgICAgICAgICAga3dhcmdzWyd3YXJuaW5ncyddID0gc2VsZi5fd2FybmluZ3MKCiAgICAgICAgaWYgJ2RlcHJlY2F0aW9ucycgaW4ga3dhcmdzOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGt3YXJnc1snZGVwcmVjYXRpb25zJ10sIGxpc3QpOgogICAgICAgICAgICAgICAgZm9yIGQgaW4ga3dhcmdzWydkZXByZWNhdGlvbnMnXToKICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGQsIFNFUVVFTkNFVFlQRSkgYW5kIGxlbihkKSA9PSAyOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRlcHJlY2F0ZShkWzBdLCB2ZXJzaW9uPWRbMV0pCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kZXByZWNhdGUoZCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuZGVwcmVjYXRlKGt3YXJnc1snZGVwcmVjYXRpb25zJ10pCgogICAgICAgIGlmIHNlbGYuX2RlcHJlY2F0aW9uczoKICAgICAgICAgICAga3dhcmdzWydkZXByZWNhdGlvbnMnXSA9IHNlbGYuX2RlcHJlY2F0aW9ucwoKICAgICAgICBrd2FyZ3MgPSByZW1vdmVfdmFsdWVzKGt3YXJncywgc2VsZi5ub19sb2dfdmFsdWVzKQogICAgICAgIHByaW50KCdcbiVzJyAlIHNlbGYuanNvbmlmeShrd2FyZ3MpKQoKICAgIGRlZiBleGl0X2pzb24oc2VsZiwgKiprd2FyZ3MpOgogICAgICAgICcnJyByZXR1cm4gZnJvbSB0aGUgbW9kdWxlLCB3aXRob3V0IGVycm9yICcnJwoKICAgICAgICBpZiBub3QgJ2NoYW5nZWQnIGluIGt3YXJnczoKICAgICAgICAgICAga3dhcmdzWydjaGFuZ2VkJ10gPSBGYWxzZQoKICAgICAgICBzZWxmLmRvX2NsZWFudXBfZmlsZXMoKQogICAgICAgIHNlbGYuX3JldHVybl9mb3JtYXR0ZWQoa3dhcmdzKQogICAgICAgIHN5cy5leGl0KDApCgogICAgZGVmIGZhaWxfanNvbihzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgJycnIHJldHVybiBmcm9tIHRoZSBtb2R1bGUsIHdpdGggYW4gZXJyb3IgbWVzc2FnZSAnJycKCiAgICAgICAgYXNzZXJ0ICdtc2cnIGluIGt3YXJncywgImltcGxlbWVudGF0aW9uIGVycm9yIC0tIG1zZyB0byBleHBsYWluIHRoZSBlcnJvciBpcyByZXF1aXJlZCIKICAgICAgICBrd2FyZ3NbJ2ZhaWxlZCddID0gVHJ1ZQoKICAgICAgICBpZiBub3QgJ2NoYW5nZWQnIGluIGt3YXJnczoKICAgICAgICAgICAga3dhcmdzWydjaGFuZ2VkJ10gPSBGYWxzZQoKICAgICAgICBzZWxmLmRvX2NsZWFudXBfZmlsZXMoKQogICAgICAgIHNlbGYuX3JldHVybl9mb3JtYXR0ZWQoa3dhcmdzKQogICAgICAgIHN5cy5leGl0KDEpCgogICAgZGVmIGZhaWxfb25fbWlzc2luZ19wYXJhbXMoc2VsZiwgcmVxdWlyZWRfcGFyYW1zPU5vbmUpOgogICAgICAgICcnJyBUaGlzIGlzIGZvciBjaGVja2luZyBmb3IgcmVxdWlyZWQgcGFyYW1zIHdoZW4gd2UgY2FuIG5vdCBjaGVjayB2aWEgYXJnc3BlYyBiZWNhdXNlIHdlCiAgICAgICAgbmVlZCBtb3JlIGluZm9ybWF0aW9uIHRoYW4gaXMgc2ltcGx5IGdpdmVuIGluIHRoZSBhcmdzcGVjLgogICAgICAgICcnJwogICAgICAgIGlmIG5vdCByZXF1aXJlZF9wYXJhbXM6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIG1pc3NpbmdfcGFyYW1zID0gW10KICAgICAgICBmb3IgcmVxdWlyZWRfcGFyYW0gaW4gcmVxdWlyZWRfcGFyYW1zOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5wYXJhbXMuZ2V0KHJlcXVpcmVkX3BhcmFtKToKICAgICAgICAgICAgICAgIG1pc3NpbmdfcGFyYW1zLmFwcGVuZChyZXF1aXJlZF9wYXJhbSkKICAgICAgICBpZiBtaXNzaW5nX3BhcmFtczoKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJtaXNzaW5nIHJlcXVpcmVkIGFyZ3VtZW50czogJXMiICUgJywnLmpvaW4obWlzc2luZ19wYXJhbXMpKQoKICAgIGRlZiBkaWdlc3RfZnJvbV9maWxlKHNlbGYsIGZpbGVuYW1lLCBhbGdvcml0aG0pOgogICAgICAgICcnJyBSZXR1cm4gaGV4IGRpZ2VzdCBvZiBsb2NhbCBmaWxlIGZvciBhIGRpZ2VzdF9tZXRob2Qgc3BlY2lmaWVkIGJ5IG5hbWUsIG9yIE5vbmUgaWYgZmlsZSBpcyBub3QgcHJlc2VudC4gJycnCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVuYW1lKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBpZiBvcy5wYXRoLmlzZGlyKGZpbGVuYW1lKToKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJhdHRlbXB0ZWQgdG8gdGFrZSBjaGVja3N1bSBvZiBkaXJlY3Rvcnk6ICVzIiAlIGZpbGVuYW1lKQoKICAgICAgICAjIHByZXNlcnZlIG9sZCBiZWhhdmlvdXIgd2hlcmUgdGhlIHRoaXJkIHBhcmFtZXRlciB3YXMgYSBoYXNoIGFsZ29yaXRobSBvYmplY3QKICAgICAgICBpZiBoYXNhdHRyKGFsZ29yaXRobSwgJ2hleGRpZ2VzdCcpOgogICAgICAgICAgICBkaWdlc3RfbWV0aG9kID0gYWxnb3JpdGhtCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGlnZXN0X21ldGhvZCA9IEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVNbYWxnb3JpdGhtXSgpCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iQ291bGQgbm90IGhhc2ggZmlsZSAnJXMnIHdpdGggYWxnb3JpdGhtICclcycuIEF2YWlsYWJsZSBhbGdvcml0aG1zOiAlcyIgJQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmaWxlbmFtZSwgYWxnb3JpdGhtLCAnLCAnLmpvaW4oQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNUykpKQoKICAgICAgICBibG9ja3NpemUgPSA2NCAqIDEwMjQKICAgICAgICBpbmZpbGUgPSBvcGVuKG9zLnBhdGgucmVhbHBhdGgoZmlsZW5hbWUpLCAncmInKQogICAgICAgIGJsb2NrID0gaW5maWxlLnJlYWQoYmxvY2tzaXplKQogICAgICAgIHdoaWxlIGJsb2NrOgogICAgICAgICAgICBkaWdlc3RfbWV0aG9kLnVwZGF0ZShibG9jaykKICAgICAgICAgICAgYmxvY2sgPSBpbmZpbGUucmVhZChibG9ja3NpemUpCiAgICAgICAgaW5maWxlLmNsb3NlKCkKICAgICAgICByZXR1cm4gZGlnZXN0X21ldGhvZC5oZXhkaWdlc3QoKQoKICAgIGRlZiBtZDUoc2VsZiwgZmlsZW5hbWUpOgogICAgICAgICcnJyBSZXR1cm4gTUQ1IGhleCBkaWdlc3Qgb2YgbG9jYWwgZmlsZSB1c2luZyBkaWdlc3RfZnJvbV9maWxlKCkuCgogICAgICAgIERvIG5vdCB1c2UgdGhpcyBmdW5jdGlvbiB1bmxlc3MgeW91IGhhdmUgbm8gb3RoZXIgY2hvaWNlIGZvcjoKICAgICAgICAgICAgMSkgT3B0aW9uYWwgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgMikgQ29tcGF0aWJpbGl0eSB3aXRoIGEgdGhpcmQgcGFydHkgcHJvdG9jb2wKCiAgICAgICAgVGhpcyBmdW5jdGlvbiB3aWxsIG5vdCB3b3JrIG9uIHN5c3RlbXMgY29tcGx5aW5nIHdpdGggRklQUy0xNDAtMi4KCiAgICAgICAgTW9zdCB1c2VzIG9mIHRoaXMgZnVuY3Rpb24gY2FuIHVzZSB0aGUgbW9kdWxlLnNoYTEgZnVuY3Rpb24gaW5zdGVhZC4KICAgICAgICAnJycKICAgICAgICBpZiAnbWQ1JyBub3QgaW4gQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNUzoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignTUQ1IG5vdCBhdmFpbGFibGUuICBQb3NzaWJseSBydW5uaW5nIGluIEZJUFMgbW9kZScpCiAgICAgICAgcmV0dXJuIHNlbGYuZGlnZXN0X2Zyb21fZmlsZShmaWxlbmFtZSwgJ21kNScpCgogICAgZGVmIHNoYTEoc2VsZiwgZmlsZW5hbWUpOgogICAgICAgICcnJyBSZXR1cm4gU0hBMSBoZXggZGlnZXN0IG9mIGxvY2FsIGZpbGUgdXNpbmcgZGlnZXN0X2Zyb21fZmlsZSgpLiAnJycKICAgICAgICByZXR1cm4gc2VsZi5kaWdlc3RfZnJvbV9maWxlKGZpbGVuYW1lLCAnc2hhMScpCgogICAgZGVmIHNoYTI1NihzZWxmLCBmaWxlbmFtZSk6CiAgICAgICAgJycnIFJldHVybiBTSEEtMjU2IGhleCBkaWdlc3Qgb2YgbG9jYWwgZmlsZSB1c2luZyBkaWdlc3RfZnJvbV9maWxlKCkuICcnJwogICAgICAgIHJldHVybiBzZWxmLmRpZ2VzdF9mcm9tX2ZpbGUoZmlsZW5hbWUsICdzaGEyNTYnKQoKICAgIGRlZiBiYWNrdXBfbG9jYWwoc2VsZiwgZm4pOgogICAgICAgICcnJ21ha2UgYSBkYXRlLW1hcmtlZCBiYWNrdXAgb2YgdGhlIHNwZWNpZmllZCBmaWxlLCByZXR1cm4gVHJ1ZSBvciBGYWxzZSBvbiBzdWNjZXNzIG9yIGZhaWx1cmUnJycKCiAgICAgICAgYmFja3VwZGVzdCA9ICcnCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZm4pOgogICAgICAgICAgICAjIGJhY2t1cHMgbmFtZWQgYmFzZW5hbWUuUElELllZWVktTU0tRERASEg6TU06U1N+CiAgICAgICAgICAgIGV4dCA9IHRpbWUuc3RyZnRpbWUoIiVZLSVtLSVkQCVIOiVNOiVTfiIsIHRpbWUubG9jYWx0aW1lKHRpbWUudGltZSgpKSkKICAgICAgICAgICAgYmFja3VwZGVzdCA9ICclcy4lcy4lcycgJSAoZm4sIG9zLmdldHBpZCgpLCBleHQpCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzaHV0aWwuY29weTIoZm4sIGJhY2t1cGRlc3QpCiAgICAgICAgICAgIGV4Y2VwdCAoc2h1dGlsLkVycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nQ291bGQgbm90IG1ha2UgYmFja3VwIG9mICVzIHRvICVzOiAlcycgJSAoZm4sIGJhY2t1cGRlc3QsIGUpKQoKICAgICAgICByZXR1cm4gYmFja3VwZGVzdAoKICAgIGRlZiBjbGVhbnVwKHNlbGYsIHRtcGZpbGUpOgogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHRtcGZpbGUpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy51bmxpbmsodG1wZmlsZSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzeXMuc3RkZXJyLndyaXRlKCJjb3VsZCBub3QgY2xlYW51cCAlczogJXMiICUgKHRtcGZpbGUsIGUpKQoKICAgIGRlZiBhdG9taWNfbW92ZShzZWxmLCBzcmMsIGRlc3QsIHVuc2FmZV93cml0ZXM9RmFsc2UpOgogICAgICAgICcnJ2F0b21pY2FsbHkgbW92ZSBzcmMgdG8gZGVzdCwgY29weWluZyBhdHRyaWJ1dGVzIGZyb20gZGVzdCwgcmV0dXJucyB0cnVlIG9uIHN1Y2Nlc3MKICAgICAgICBpdCB1c2VzIG9zLnJlbmFtZSB0byBlbnN1cmUgdGhpcyBhcyBpdCBpcyBhbiBhdG9taWMgb3BlcmF0aW9uLCByZXN0IG9mIHRoZSBmdW5jdGlvbiBpcwogICAgICAgIHRvIHdvcmsgYXJvdW5kIGxpbWl0YXRpb25zLCBjb3JuZXIgY2FzZXMgYW5kIGVuc3VyZSBzZWxpbnV4IGNvbnRleHQgaXMgc2F2ZWQgaWYgcG9zc2libGUnJycKICAgICAgICBjb250ZXh0ID0gTm9uZQogICAgICAgIGRlc3Rfc3RhdCA9IE5vbmUKICAgICAgICBiX3NyYyA9IHRvX2J5dGVzKHNyYywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBiX2Rlc3QgPSB0b19ieXRlcyhkZXN0LCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGJfZGVzdCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRlc3Rfc3RhdCA9IG9zLnN0YXQoYl9kZXN0KQoKICAgICAgICAgICAgICAgICMgY29weSBtb2RlIGFuZCBvd25lcnNoaXAKICAgICAgICAgICAgICAgIG9zLmNobW9kKGJfc3JjLCBkZXN0X3N0YXQuc3RfbW9kZSAmIFBFUk1fQklUUykKICAgICAgICAgICAgICAgIG9zLmNob3duKGJfc3JjLCBkZXN0X3N0YXQuc3RfdWlkLCBkZXN0X3N0YXQuc3RfZ2lkKQoKICAgICAgICAgICAgICAgICMgdHJ5IHRvIGNvcHkgZmxhZ3MgaWYgcG9zc2libGUKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIob3MsICdjaGZsYWdzJykgYW5kIGhhc2F0dHIoZGVzdF9zdGF0LCAnc3RfZmxhZ3MnKToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNoZmxhZ3MoYl9zcmMsIGRlc3Rfc3RhdC5zdF9mbGFncykKICAgICAgICAgICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgZXJyIGluICdFT1BOT1RTVVBQJywgJ0VOT1RTVVAnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgaGFzYXR0cihlcnJubywgZXJyKSBhbmQgZS5lcnJubyA9PSBnZXRhdHRyKGVycm5vLCBlcnIpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIGlmIGUuZXJybm8gIT0gZXJybm8uRVBFUk06CiAgICAgICAgICAgICAgICAgICAgcmFpc2UKICAgICAgICAgICAgaWYgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfY29udGV4dChkZXN0KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2RlZmF1bHRfY29udGV4dChkZXN0KQoKICAgICAgICBjcmVhdGluZyA9IG5vdCBvcy5wYXRoLmV4aXN0cyhiX2Rlc3QpCgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBPcHRpbWlzdGljYWxseSB0cnkgYSByZW5hbWUsIHNvbHZlcyBzb21lIGNvcm5lciBjYXNlcyBhbmQgY2FuIGF2b2lkIHVzZWxlc3Mgd29yaywgdGhyb3dzIGV4Y2VwdGlvbiBpZiBub3QgYXRvbWljLgogICAgICAgICAgICBvcy5yZW5hbWUoYl9zcmMsIGJfZGVzdCkKICAgICAgICBleGNlcHQgKElPRXJyb3IsIE9TRXJyb3IpOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIGlmIGUuZXJybm8gbm90IGluIFtlcnJuby5FUEVSTSwgZXJybm8uRVhERVYsIGVycm5vLkVBQ0NFUywgZXJybm8uRVRYVEJTWSwgZXJybm8uRUJVU1ldOgogICAgICAgICAgICAgICAgIyBvbmx5IHRyeSB3b3JrYXJvdW5kcyBmb3IgZXJybm8gMTggKGNyb3NzIGRldmljZSksIDEgKG5vdCBwZXJtaXR0ZWQpLCAgMTMgKHBlcm1pc3Npb24gZGVuaWVkKQogICAgICAgICAgICAgICAgIyBhbmQgMjYgKHRleHQgZmlsZSBidXN5KSB3aGljaCBoYXBwZW5zIG9uIHZhZ3JhbnQgc3luY2VkIGZvbGRlcnMgYW5kIG90aGVyICdleG90aWMnIG5vbiBwb3NpeCBmaWxlIHN5c3RlbXMKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nQ291bGQgbm90IHJlcGxhY2UgZmlsZTogJXMgdG8gJXM6ICVzJyAlIChzcmMsIGRlc3QsIGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJfZGVzdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUoYl9kZXN0KQogICAgICAgICAgICAgICAgIyBVc2UgYnl0ZXMgaGVyZS4gIEluIHRoZSBzaGlwcGFibGUgQ0ksIHRoaXMgZmFpbHMgd2l0aAogICAgICAgICAgICAgICAgIyBhIFVuaWNvZGVFcnJvciB3aXRoIHN1cnJvZ2F0ZWVzY2FwZSdkIHN0cmluZ3MgZm9yIGFuIHVua25vd24KICAgICAgICAgICAgICAgICMgcmVhc29uIChkb2Vzbid0IGhhcHBlbiBpbiBhIGxvY2FsIFVidW50dTE2LjA0IFZNKQogICAgICAgICAgICAgICAgbmF0aXZlX2Rlc3RfZGlyID0gYl9kZXN0X2RpcgogICAgICAgICAgICAgICAgbmF0aXZlX3N1ZmZpeCA9IG9zLnBhdGguYmFzZW5hbWUoYl9kZXN0KQogICAgICAgICAgICAgICAgbmF0aXZlX3ByZWZpeCA9IGIoJy5hbnNpYmxlX3RtcCcpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdG1wX2Rlc3RfZmQsIHRtcF9kZXN0X25hbWUgPSB0ZW1wZmlsZS5ta3N0ZW1wKCBwcmVmaXg9bmF0aXZlX3ByZWZpeCwgZGlyPW5hdGl2ZV9kZXN0X2Rpciwgc3VmZml4PW5hdGl2ZV9zdWZmaXgpCiAgICAgICAgICAgICAgICBleGNlcHQgKE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J1RoZSBkZXN0aW5hdGlvbiBkaXJlY3RvcnkgKCVzKSBpcyBub3Qgd3JpdGFibGUgYnkgdGhlIGN1cnJlbnQgdXNlci4gRXJyb3Igd2FzOiAlcycgJSAob3MucGF0aC5kaXJuYW1lKGRlc3QpLCBlKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBUeXBlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgIyBXZSBleHBlY3QgdGhhdCB0aGlzIGlzIGhhcHBlbmluZyBiZWNhdXNlIHB5dGhvbjMuNC54IGFuZAogICAgICAgICAgICAgICAgICAgICMgYmVsb3cgY2FuJ3QgaGFuZGxlIGJ5dGUgc3RyaW5ncyBpbiBta3N0ZW1wKCkuICBUcmFjZWJhY2sKICAgICAgICAgICAgICAgICAgICAjIHdvdWxkIGVuZCBpbiBzb21ldGhpbmcgbGlrZToKICAgICAgICAgICAgICAgICAgICAjICAgICBmaWxlID0gX29zLnBhdGguam9pbihkaXIsIHByZSArIG5hbWUgKyBzdWYpCiAgICAgICAgICAgICAgICAgICAgIyBUeXBlRXJyb3I6IGNhbid0IGNvbmNhdCBieXRlcyB0byBzdHIKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0ZhaWxlZCBjcmVhdGluZyB0ZW1wIGZpbGUgZm9yIGF0b21pYyBtb3ZlLiAgVGhpcyB1c3VhbGx5IGhhcHBlbnMgd2hlbiB1c2luZyBQeXRob24zIGxlc3MgdGhhbiBQeXRob24zLjUuICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1BsZWFzZSB1c2UgUHl0aG9uMi54IG9yIFB5dGhvbjMuNSBvciBncmVhdGVyLicsIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQoKICAgICAgICAgICAgICAgIGJfdG1wX2Rlc3RfbmFtZSA9IHRvX2J5dGVzKHRtcF9kZXN0X25hbWUsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgIyBjbG9zZSB0bXAgZmlsZSBoYW5kbGUgYmVmb3JlIGZpbGUgb3BlcmF0aW9ucyB0byBwcmV2ZW50IHRleHQgZmlsZSBidXN5IGVycm9ycyBvbiB2Ym94ZnMgc3luY2VkIGZvbGRlcnMgKHdpbmRvd3MgaG9zdCkKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2xvc2UodG1wX2Rlc3RfZmQpCiAgICAgICAgICAgICAgICAgICAgICAgICMgbGVhdmVzIHRtcCBmaWxlIGJlaGluZCB3aGVuIHN1ZG8gYW5kIG5vdCByb290CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNodXRpbC5tb3ZlKGJfc3JjLCBiX3RtcF9kZXN0X25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBjbGVhbnVwIHdpbGwgaGFwcGVuIGJ5ICdybScgb2YgdGVtcGRpcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBjb3B5MiB3aWxsIHByZXNlcnZlIHNvbWUgbWV0YWRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5MihiX3NyYywgYl90bXBfZGVzdF9uYW1lKQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJfdG1wX2Rlc3RfbmFtZSwgY29udGV4dCwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcF9zdGF0ID0gb3Muc3RhdChiX3RtcF9kZXN0X25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkZXN0X3N0YXQgYW5kICh0bXBfc3RhdC5zdF91aWQgIT0gZGVzdF9zdGF0LnN0X3VpZCBvciB0bXBfc3RhdC5zdF9naWQgIT0gZGVzdF9zdGF0LnN0X2dpZCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2hvd24oYl90bXBfZGVzdF9uYW1lLCBkZXN0X3N0YXQuc3RfdWlkLCBkZXN0X3N0YXQuc3RfZ2lkKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGUuZXJybm8gIT0gZXJybm8uRVBFUk06CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MucmVuYW1lKGJfdG1wX2Rlc3RfbmFtZSwgYl9kZXN0KQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgKHNodXRpbC5FcnJvciwgT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB1bnNhZmVfd3JpdGVzIGFuZCBlLmVycm5vID09IGVycm5vLkVCVVNZOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3Vuc2FmZV93cml0ZXMoYl90bXBfZGVzdF9uYW1lLCBiX2Rlc3QpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nVW5hYmxlIHRvIHJlbmFtZSBmaWxlOiAlcyB0byAlczogJXMnICUgKHNyYywgZGVzdCwgZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCAoc2h1dGlsLkVycm9yLCBPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0ZhaWxlZCB0byByZXBsYWNlIGZpbGU6ICVzIHRvICVzOiAlcycgJSAoc3JjLCBkZXN0LCBlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCiAgICAgICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuY2xlYW51cChiX3RtcF9kZXN0X25hbWUpCgogICAgICAgIGlmIGNyZWF0aW5nOgogICAgICAgICAgICAjIG1ha2Ugc3VyZSB0aGUgZmlsZSBoYXMgdGhlIGNvcnJlY3QgcGVybWlzc2lvbnMKICAgICAgICAgICAgIyBiYXNlZCBvbiB0aGUgY3VycmVudCB2YWx1ZSBvZiB1bWFzawogICAgICAgICAgICB1bWFzayA9IG9zLnVtYXNrKDApCiAgICAgICAgICAgIG9zLnVtYXNrKHVtYXNrKQogICAgICAgICAgICBvcy5jaG1vZChiX2Rlc3QsIERFRkFVTFRfUEVSTSAmIH51bWFzaykKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MuY2hvd24oYl9kZXN0LCBvcy5nZXRldWlkKCksIG9zLmdldGVnaWQoKSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAjIFdlJ3JlIG9rYXkgd2l0aCB0cnlpbmcgb3VyIGJlc3QgaGVyZS4gIElmIHRoZSB1c2VyIGlzIG5vdAogICAgICAgICAgICAgICAgIyByb290IChvciBvbGQgVW5pY2VzKSB0aGV5IHdvbid0IGJlIGFibGUgdG8gY2hvd24uCiAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgIGlmIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICMgcmVuYW1lIG1pZ2h0IG5vdCBwcmVzZXJ2ZSBjb250ZXh0CiAgICAgICAgICAgIHNlbGYuc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KGRlc3QsIGNvbnRleHQsIEZhbHNlKQoKICAgIGRlZiBfdW5zYWZlX3dyaXRlcyhzZWxmLCBzcmMsIGRlc3QpOgogICAgICAgICMgc2FkbHkgdGhlcmUgYXJlIHNvbWUgc2l0dWF0aW9ucyB3aGVyZSB3ZSBjYW5ub3QgZW5zdXJlIGF0b21pY2l0eSwgYnV0IG9ubHkgaWYKICAgICAgICAjIHRoZSB1c2VyIGluc2lzdHMgYW5kIHdlIGdldCB0aGUgYXBwcm9wcmlhdGUgZXJyb3Igd2UgdXBkYXRlIHRoZSBmaWxlIHVuc2FmZWx5CiAgICAgICAgdHJ5OgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvdXRfZGVzdCA9IG9wZW4oZGVzdCwgJ3diJykKICAgICAgICAgICAgICAgIGluX3NyYyA9IG9wZW4oc3JjLCAncmInKQogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHlmaWxlb2JqKGluX3NyYywgb3V0X2Rlc3QpCiAgICAgICAgICAgIGZpbmFsbHk6ICAjIGFzc3VyaW5nIGNsb3NlZCBmaWxlcyBpbiAyLjQgY29tcGF0aWJsZSB3YXkKICAgICAgICAgICAgICAgIGlmIG91dF9kZXN0OgogICAgICAgICAgICAgICAgICAgIG91dF9kZXN0LmNsb3NlKCkKICAgICAgICAgICAgICAgIGlmIGluX3NyYzoKICAgICAgICAgICAgICAgICAgICBpbl9zcmMuY2xvc2UoKQogICAgICAgIGV4Y2VwdCAoc2h1dGlsLkVycm9yLCBPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0NvdWxkIG5vdCB3cml0ZSBkYXRhIHRvIGZpbGUgKCVzKSBmcm9tICglcyk6ICVzJyAlIChkZXN0LCBzcmMsIGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKCgogICAgZGVmIF9yZWFkX2Zyb21fcGlwZXMoc2VsZiwgcnBpcGVzLCByZmRzLCBmaWxlX2Rlc2NyaXB0b3IpOgogICAgICAgIGRhdGEgPSBiKCcnKQogICAgICAgIGlmIGZpbGVfZGVzY3JpcHRvciBpbiByZmRzOgogICAgICAgICAgICBkYXRhID0gb3MucmVhZChmaWxlX2Rlc2NyaXB0b3IuZmlsZW5vKCksIDkwMDApCiAgICAgICAgICAgIGlmIGRhdGEgPT0gYignJyk6CiAgICAgICAgICAgICAgICBycGlwZXMucmVtb3ZlKGZpbGVfZGVzY3JpcHRvcikKCiAgICAgICAgcmV0dXJuIGRhdGEKCiAgICBkZWYgcnVuX2NvbW1hbmQoc2VsZiwgYXJncywgY2hlY2tfcmM9RmFsc2UsIGNsb3NlX2Zkcz1UcnVlLCBleGVjdXRhYmxlPU5vbmUsIGRhdGE9Tm9uZSwgYmluYXJ5X2RhdGE9RmFsc2UsIHBhdGhfcHJlZml4PU5vbmUsIGN3ZD1Ob25lLAogICAgICAgICAgICAgICAgICAgIHVzZV91bnNhZmVfc2hlbGw9RmFsc2UsIHByb21wdF9yZWdleD1Ob25lLCBlbnZpcm9uX3VwZGF0ZT1Ob25lLCB1bWFzaz1Ob25lLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKToKICAgICAgICAnJycKICAgICAgICBFeGVjdXRlIGEgY29tbWFuZCwgcmV0dXJucyByYywgc3Rkb3V0LCBhbmQgc3RkZXJyLgoKICAgICAgICA6YXJnIGFyZ3M6IGlzIHRoZSBjb21tYW5kIHRvIHJ1bgogICAgICAgICAgICAqIElmIGFyZ3MgaXMgYSBsaXN0LCB0aGUgY29tbWFuZCB3aWxsIGJlIHJ1biB3aXRoIHNoZWxsPUZhbHNlLgogICAgICAgICAgICAqIElmIGFyZ3MgaXMgYSBzdHJpbmcgYW5kIHVzZV91bnNhZmVfc2hlbGw9RmFsc2UgaXQgd2lsbCBzcGxpdCBhcmdzIHRvIGEgbGlzdCBhbmQgcnVuIHdpdGggc2hlbGw9RmFsc2UKICAgICAgICAgICAgKiBJZiBhcmdzIGlzIGEgc3RyaW5nIGFuZCB1c2VfdW5zYWZlX3NoZWxsPVRydWUgaXQgcnVucyB3aXRoIHNoZWxsPVRydWUuCiAgICAgICAgOmt3IGNoZWNrX3JjOiBXaGV0aGVyIHRvIGNhbGwgZmFpbF9qc29uIGluIGNhc2Ugb2Ygbm9uIHplcm8gUkMuCiAgICAgICAgICAgIERlZmF1bHQgRmFsc2UKICAgICAgICA6a3cgY2xvc2VfZmRzOiBTZWUgZG9jdW1lbnRhdGlvbiBmb3Igc3VicHJvY2Vzcy5Qb3BlbigpLiBEZWZhdWx0IFRydWUKICAgICAgICA6a3cgZXhlY3V0YWJsZTogU2VlIGRvY3VtZW50YXRpb24gZm9yIHN1YnByb2Nlc3MuUG9wZW4oKS4gRGVmYXVsdCBOb25lCiAgICAgICAgOmt3IGRhdGE6IElmIGdpdmVuLCBpbmZvcm1hdGlvbiB0byB3cml0ZSB0byB0aGUgc3RkaW4gb2YgdGhlIGNvbW1hbmQKICAgICAgICA6a3cgYmluYXJ5X2RhdGE6IElmIEZhbHNlLCBhcHBlbmQgYSBuZXdsaW5lIHRvIHRoZSBkYXRhLiAgRGVmYXVsdCBGYWxzZQogICAgICAgIDprdyBwYXRoX3ByZWZpeDogSWYgZ2l2ZW4sIGFkZGl0aW9uYWwgcGF0aCB0byBmaW5kIHRoZSBjb21tYW5kIGluLgogICAgICAgICAgICBUaGlzIGFkZHMgdG8gdGhlIFBBVEggZW52aXJvbm1lbnQgdmFpcmFibGUgc28gaGVscGVyIGNvbW1hbmRzIGluCiAgICAgICAgICAgIHRoZSBzYW1lIGRpcmVjdG9yeSBjYW4gYWxzbyBiZSBmb3VuZAogICAgICAgIDprdyBjd2Q6IElmIGdpdmVuLCB3b3JraW5nIGRpcmVjdG9yeSB0byBydW4gdGhlIGNvbW1hbmQgaW5zaWRlCiAgICAgICAgOmt3IHVzZV91bnNhZmVfc2hlbGw6IFNlZSBgYXJnc2AgcGFyYW1ldGVyLiAgRGVmYXVsdCBGYWxzZQogICAgICAgIDprdyBwcm9tcHRfcmVnZXg6IFJlZ2V4IHN0cmluZyAobm90IGEgY29tcGlsZWQgcmVnZXgpIHdoaWNoIGNhbiBiZQogICAgICAgICAgICB1c2VkIHRvIGRldGVjdCBwcm9tcHRzIGluIHRoZSBzdGRvdXQgd2hpY2ggd291bGQgb3RoZXJ3aXNlIGNhdXNlCiAgICAgICAgICAgIHRoZSBleGVjdXRpb24gdG8gaGFuZyAoZXNwZWNpYWxseSBpZiBubyBpbnB1dCBkYXRhIGlzIHNwZWNpZmllZCkKICAgICAgICA6a3cgZW52aXJvbl91cGRhdGU6IGRpY3Rpb25hcnkgdG8gKnVwZGF0ZSogb3MuZW52aXJvbiB3aXRoCiAgICAgICAgOmt3IHVtYXNrOiBVbWFzayB0byBiZSB1c2VkIHdoZW4gcnVubmluZyB0aGUgY29tbWFuZC4gRGVmYXVsdCBOb25lCiAgICAgICAgOmt3IGVuY29kaW5nOiBTaW5jZSB3ZSByZXR1cm4gbmF0aXZlIHN0cmluZ3MsIG9uIHB5dGhvbjMgd2UgbmVlZCB0bwogICAgICAgICAgICBrbm93IHRoZSBlbmNvZGluZyB0byB1c2UgdG8gdHJhbnNmb3JtIGZyb20gYnl0ZXMgdG8gdGV4dC4gIElmIHlvdQogICAgICAgICAgICB3YW50IHRvIGFsd2F5cyBnZXQgYnl0ZXMgYmFjaywgdXNlIGVuY29kaW5nPU5vbmUuICBUaGUgZGVmYXVsdCBpcwogICAgICAgICAgICAidXRmLTgiLiAgVGhpcyBkb2VzIG5vdCBhZmZlY3QgdHJhbnNmb3JtYXRpb24gb2Ygc3RyaW5ncyBnaXZlbiBhcwogICAgICAgICAgICBhcmdzLgogICAgICAgIDprdyBlcnJvcnM6IFNpbmNlIHdlIHJldHVybiBuYXRpdmUgc3RyaW5ncywgb24gcHl0aG9uMyB3ZSBuZWVkIHRvCiAgICAgICAgICAgIHRyYW5zZm9ybSBzdGRvdXQgYW5kIHN0ZGVyciBmcm9tIGJ5dGVzIHRvIHRleHQuICBJZiB0aGUgYnl0ZXMgYXJlCiAgICAgICAgICAgIHVuZGVjb2RhYmxlIGluIHRoZSBgYGVuY29kaW5nYGAgc3BlY2lmaWVkLCB0aGVuIHVzZSB0aGlzIGVycm9yCiAgICAgICAgICAgIGhhbmRsZXIgdG8gZGVhbCB3aXRoIHRoZW0uICBUaGUgZGVmYXVsdCBpcyBgYHN1cnJvZ2F0ZV9vcl9zdHJpY3RgYAogICAgICAgICAgICB3aGljaCBtZWFucyB0aGF0IHRoZSBieXRlcyB3aWxsIGJlIGRlY29kZWQgdXNpbmcgdGhlCiAgICAgICAgICAgIHN1cnJvZ2F0ZWVzY2FwZSBlcnJvciBoYW5kbGVyIGlmIGF2YWlsYWJsZSAoYXZhaWxhYmxlIG9uIGFsbAogICAgICAgICAgICBweXRob24zIHZlcnNpb25zIHdlIHN1cHBvcnQpIG90aGVyd2lzZSBhIFVuaWNvZGVFcnJvciB0cmFjZWJhY2sKICAgICAgICAgICAgd2lsbCBiZSByYWlzZWQuICBUaGlzIGRvZXMgbm90IGFmZmVjdCB0cmFuc2Zvcm1hdGlvbnMgb2Ygc3RyaW5ncwogICAgICAgICAgICBnaXZlbiBhcyBhcmdzLgogICAgICAgIDpyZXR1cm5zOiBBIDMtdHVwbGUgb2YgcmV0dXJuIGNvZGUgKGludGVnZXIpLCBzdGRvdXQgKG5hdGl2ZSBzdHJpbmcpLAogICAgICAgICAgICBhbmQgc3RkZXJyIChuYXRpdmUgc3RyaW5nKS4gIE9uIHB5dGhvbjIsIHN0ZG91dCBhbmQgc3RkZXJyIGFyZSBib3RoCiAgICAgICAgICAgIGJ5dGUgc3RyaW5ncy4gIE9uIHB5dGhvbjMsIHN0ZG91dCBhbmQgc3RkZXJyIGFyZSB0ZXh0IHN0cmluZ3MgY29udmVydGVkCiAgICAgICAgICAgIGFjY29yZGluZyB0byB0aGUgZW5jb2RpbmcgYW5kIGVycm9ycyBwYXJhbWV0ZXJzLiAgSWYgeW91IHdhbnQgYnl0ZQogICAgICAgICAgICBzdHJpbmdzIG9uIHB5dGhvbjMsIHVzZSBlbmNvZGluZz1Ob25lIHRvIHR1cm4gZGVjb2RpbmcgdG8gdGV4dCBvZmYuCiAgICAgICAgJycnCgogICAgICAgIGlmIGlzaW5zdGFuY2UoYXJncywgbGlzdCk6CiAgICAgICAgICAgIGlmIHVzZV91bnNhZmVfc2hlbGw6CiAgICAgICAgICAgICAgICBhcmdzID0gIiAiLmpvaW4oW3NobGV4X3F1b3RlKHgpIGZvciB4IGluIGFyZ3NdKQogICAgICAgICAgICAgICAgc2hlbGwgPSBUcnVlCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGFyZ3MsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSkgYW5kIHVzZV91bnNhZmVfc2hlbGw6CiAgICAgICAgICAgIHNoZWxsID0gVHJ1ZQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShhcmdzLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpOgogICAgICAgICAgICBpZiBub3QgdXNlX3Vuc2FmZV9zaGVsbDoKICAgICAgICAgICAgICAgICMgT24gcHl0aG9uMi42IGFuZCBiZWxvdywgc2hsZXggaGFzIHByb2JsZW1zIHdpdGggdGV4dCB0eXBlCiAgICAgICAgICAgICAgICAjIE9uIHB5dGhvbjMsIHNobGV4IG5lZWRzIGEgdGV4dCB0eXBlLgogICAgICAgICAgICAgICAgaWYgUFkyOgogICAgICAgICAgICAgICAgICAgIGFyZ3MgPSB0b19ieXRlcyhhcmdzLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgICAgICAgICAgZWxpZiBQWTM6CiAgICAgICAgICAgICAgICAgICAgYXJncyA9IHRvX3RleHQoYXJncywgZXJyb3JzPSdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICAgICAgICAgYXJncyA9IHNobGV4LnNwbGl0KGFyZ3MpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbXNnID0gIkFyZ3VtZW50ICdhcmdzJyB0byBydW5fY29tbWFuZCBtdXN0IGJlIGxpc3Qgb3Igc3RyaW5nIgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihyYz0yNTcsIGNtZD1hcmdzLCBtc2c9bXNnKQoKICAgICAgICBzaGVsbCA9IEZhbHNlCiAgICAgICAgaWYgdXNlX3Vuc2FmZV9zaGVsbDoKICAgICAgICAgICAgaWYgZXhlY3V0YWJsZSBpcyBOb25lOgogICAgICAgICAgICAgICAgZXhlY3V0YWJsZSA9IG9zLmVudmlyb24uZ2V0KCdTSEVMTCcpCiAgICAgICAgICAgIGlmIGV4ZWN1dGFibGU6CiAgICAgICAgICAgICAgICBhcmdzID0gW2V4ZWN1dGFibGUsICctYycsIGFyZ3NdCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzaGVsbCA9IFRydWUKCiAgICAgICAgcHJvbXB0X3JlID0gTm9uZQogICAgICAgIGlmIHByb21wdF9yZWdleDoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShwcm9tcHRfcmVnZXgsIHRleHRfdHlwZSk6CiAgICAgICAgICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgICAgICAgICAgcHJvbXB0X3JlZ2V4ID0gdG9fYnl0ZXMocHJvbXB0X3JlZ2V4LCBlcnJvcnM9J3N1cnJvZ2F0ZWVzY2FwZScpCiAgICAgICAgICAgICAgICBlbGlmIFBZMjoKICAgICAgICAgICAgICAgICAgICBwcm9tcHRfcmVnZXggPSB0b19ieXRlcyhwcm9tcHRfcmVnZXgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHByb21wdF9yZSA9IHJlLmNvbXBpbGUocHJvbXB0X3JlZ2V4LCByZS5NVUxUSUxJTkUpCiAgICAgICAgICAgIGV4Y2VwdCByZS5lcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iaW52YWxpZCBwcm9tcHQgcmVndWxhciBleHByZXNzaW9uIGdpdmVuIHRvIHJ1bl9jb21tYW5kIikKCiAgICAgICAgIyBleHBhbmQgdGhpbmdzIGxpa2UgJEhPTUUgYW5kIH4KICAgICAgICBpZiBub3Qgc2hlbGw6CiAgICAgICAgICAgIGFyZ3MgPSBbIG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoeCkpIGZvciB4IGluIGFyZ3MgaWYgeCBpcyBub3QgTm9uZSBdCgogICAgICAgIHJjID0gMAogICAgICAgIG1zZyA9IE5vbmUKICAgICAgICBzdF9pbiA9IE5vbmUKCiAgICAgICAgIyBNYW5pcHVsYXRlIHRoZSBlbnZpcm9uIHdlJ2xsIHNlbmQgdG8gdGhlIG5ldyBwcm9jZXNzCiAgICAgICAgb2xkX2Vudl92YWxzID0ge30KICAgICAgICAjIFdlIGNhbiBzZXQgdGhpcyBmcm9tIGJvdGggYW4gYXR0cmlidXRlIGFuZCBwZXIgY2FsbAogICAgICAgIGZvciBrZXksIHZhbCBpbiBzZWxmLnJ1bl9jb21tYW5kX2Vudmlyb25fdXBkYXRlLml0ZW1zKCk6CiAgICAgICAgICAgIG9sZF9lbnZfdmFsc1trZXldID0gb3MuZW52aXJvbi5nZXQoa2V5LCBOb25lKQogICAgICAgICAgICBvcy5lbnZpcm9uW2tleV0gPSB2YWwKICAgICAgICBpZiBlbnZpcm9uX3VwZGF0ZToKICAgICAgICAgICAgZm9yIGtleSwgdmFsIGluIGVudmlyb25fdXBkYXRlLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBvbGRfZW52X3ZhbHNba2V5XSA9IG9zLmVudmlyb24uZ2V0KGtleSwgTm9uZSkKICAgICAgICAgICAgICAgIG9zLmVudmlyb25ba2V5XSA9IHZhbAogICAgICAgIGlmIHBhdGhfcHJlZml4OgogICAgICAgICAgICBvbGRfZW52X3ZhbHNbJ1BBVEgnXSA9IG9zLmVudmlyb25bJ1BBVEgnXQogICAgICAgICAgICBvcy5lbnZpcm9uWydQQVRIJ10gPSAiJXM6JXMiICUgKHBhdGhfcHJlZml4LCBvcy5lbnZpcm9uWydQQVRIJ10pCgogICAgICAgICMgSWYgdXNpbmcgdGVzdC1tb2R1bGUgYW5kIGV4cGxvZGUsIHRoZSByZW1vdGUgbGliIHBhdGggd2lsbCByZXNlbWJsZSAuLi4KICAgICAgICAjICAgL3RtcC90ZXN0X21vZHVsZV9zY3JhdGNoL2RlYnVnX2Rpci9hbnNpYmxlL21vZHVsZV91dGlscy9iYXNpYy5weQogICAgICAgICMgSWYgdXNpbmcgYW5zaWJsZSBvciBhbnNpYmxlLXBsYXlib29rIHdpdGggYSByZW1vdGUgc3lzdGVtIC4uLgogICAgICAgICMgICAvdG1wL2Fuc2libGVfdm13ZUxRL2Fuc2libGVfbW9kbGliLnppcC9hbnNpYmxlL21vZHVsZV91dGlscy9iYXNpYy5weQoKICAgICAgICAjIENsZWFuIG91dCBweXRob24gcGF0aHMgc2V0IGJ5IGFuc2liYWxsegogICAgICAgIGlmICdQWVRIT05QQVRIJyBpbiBvcy5lbnZpcm9uOgogICAgICAgICAgICBweXBhdGhzID0gb3MuZW52aXJvblsnUFlUSE9OUEFUSCddLnNwbGl0KCc6JykKICAgICAgICAgICAgcHlwYXRocyA9IFt4IGZvciB4IGluIHB5cGF0aHMgXAogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgeC5lbmRzd2l0aCgnL2Fuc2libGVfbW9kbGliLnppcCcpIFwKICAgICAgICAgICAgICAgICAgICAgICAgYW5kIG5vdCB4LmVuZHN3aXRoKCcvZGVidWdfZGlyJyldCiAgICAgICAgICAgIG9zLmVudmlyb25bJ1BZVEhPTlBBVEgnXSA9ICc6Jy5qb2luKHB5cGF0aHMpCiAgICAgICAgICAgIGlmIG5vdCBvcy5lbnZpcm9uWydQWVRIT05QQVRIJ106CiAgICAgICAgICAgICAgICBkZWwgb3MuZW52aXJvblsnUFlUSE9OUEFUSCddCgogICAgICAgICMgY3JlYXRlIGEgcHJpbnRhYmxlIHZlcnNpb24gb2YgdGhlIGNvbW1hbmQgZm9yIHVzZQogICAgICAgICMgaW4gcmVwb3J0aW5nIGxhdGVyLCB3aGljaCBzdHJpcHMgb3V0IHRoaW5ncyBsaWtlCiAgICAgICAgIyBwYXNzd29yZHMgZnJvbSB0aGUgYXJncyBsaXN0CiAgICAgICAgdG9fY2xlYW5fYXJncyA9IGFyZ3MKICAgICAgICBpZiBQWTI6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYXJncywgdGV4dF90eXBlKToKICAgICAgICAgICAgICAgIHRvX2NsZWFuX2FyZ3MgPSB0b19ieXRlcyhhcmdzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYXJncywgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICAgICAgdG9fY2xlYW5fYXJncyA9IHRvX3RleHQoYXJncykKICAgICAgICBpZiBpc2luc3RhbmNlKGFyZ3MsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgICAgIHRvX2NsZWFuX2FyZ3MgPSBzaGxleC5zcGxpdCh0b19jbGVhbl9hcmdzKQoKICAgICAgICBjbGVhbl9hcmdzID0gW10KICAgICAgICBpc19wYXNzd2QgPSBGYWxzZQogICAgICAgIGZvciBhcmcgaW4gdG9fY2xlYW5fYXJnczoKICAgICAgICAgICAgaWYgaXNfcGFzc3dkOgogICAgICAgICAgICAgICAgaXNfcGFzc3dkID0gRmFsc2UKICAgICAgICAgICAgICAgIGNsZWFuX2FyZ3MuYXBwZW5kKCcqKioqKioqKicpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBQQVNTV0RfQVJHX1JFLm1hdGNoKGFyZyk6CiAgICAgICAgICAgICAgICBzZXBfaWR4ID0gYXJnLmZpbmQoJz0nKQogICAgICAgICAgICAgICAgaWYgc2VwX2lkeCA+IC0xOgogICAgICAgICAgICAgICAgICAgIGNsZWFuX2FyZ3MuYXBwZW5kKCclcz0qKioqKioqKicgJSBhcmdbOnNlcF9pZHhdKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGlzX3Bhc3N3ZCA9IFRydWUKICAgICAgICAgICAgYXJnID0gaGV1cmlzdGljX2xvZ19zYW5pdGl6ZShhcmcsIHNlbGYubm9fbG9nX3ZhbHVlcykKICAgICAgICAgICAgY2xlYW5fYXJncy5hcHBlbmQoYXJnKQogICAgICAgIGNsZWFuX2FyZ3MgPSAnICcuam9pbihzaGxleF9xdW90ZShhcmcpIGZvciBhcmcgaW4gY2xlYW5fYXJncykKCiAgICAgICAgaWYgZGF0YToKICAgICAgICAgICAgc3RfaW4gPSBzdWJwcm9jZXNzLlBJUEUKCiAgICAgICAga3dhcmdzID0gZGljdCgKICAgICAgICAgICAgZXhlY3V0YWJsZT1leGVjdXRhYmxlLAogICAgICAgICAgICBzaGVsbD1zaGVsbCwKICAgICAgICAgICAgY2xvc2VfZmRzPWNsb3NlX2ZkcywKICAgICAgICAgICAgc3RkaW49c3RfaW4sCiAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsCiAgICAgICAgICAgIHN0ZGVycj1zdWJwcm9jZXNzLlBJUEUsCiAgICAgICAgKQoKICAgICAgICAjIHN0b3JlIHRoZSBwd2QKICAgICAgICBwcmV2X2RpciA9IG9zLmdldGN3ZCgpCgogICAgICAgICMgbWFrZSBzdXJlIHdlJ3JlIGluIHRoZSByaWdodCB3b3JraW5nIGRpcmVjdG9yeQogICAgICAgIGlmIGN3ZCBhbmQgb3MucGF0aC5pc2Rpcihjd2QpOgogICAgICAgICAgICBjd2QgPSBvcy5wYXRoLmFic3BhdGgob3MucGF0aC5leHBhbmR1c2VyKGN3ZCkpCiAgICAgICAgICAgIGt3YXJnc1snY3dkJ10gPSBjd2QKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MuY2hkaXIoY3dkKQogICAgICAgICAgICBleGNlcHQgKE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocmM9ZS5lcnJubywgbXNnPSJDb3VsZCBub3Qgb3BlbiAlcywgJXMiICUgKGN3ZCwgc3RyKGUpKSkKCiAgICAgICAgb2xkX3VtYXNrID0gTm9uZQogICAgICAgIGlmIHVtYXNrOgogICAgICAgICAgICBvbGRfdW1hc2sgPSBvcy51bWFzayh1bWFzaykKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLl9kZWJ1ZzoKICAgICAgICAgICAgICAgIHNlbGYubG9nKCdFeGVjdXRpbmc6ICcgKyBjbGVhbl9hcmdzKQogICAgICAgICAgICBjbWQgPSBzdWJwcm9jZXNzLlBvcGVuKGFyZ3MsICoqa3dhcmdzKQoKICAgICAgICAgICAgIyB0aGUgY29tbXVuaWNhdGlvbiBsb2dpYyBoZXJlIGlzIGVzc2VudGlhbGx5IHRha2VuIGZyb20gdGhhdAogICAgICAgICAgICAjIG9mIHRoZSBfY29tbXVuaWNhdGUoKSBmdW5jdGlvbiBpbiBzc2gucHkKCiAgICAgICAgICAgIHN0ZG91dCA9IGIoJycpCiAgICAgICAgICAgIHN0ZGVyciA9IGIoJycpCiAgICAgICAgICAgIHJwaXBlcyA9IFtjbWQuc3Rkb3V0LCBjbWQuc3RkZXJyXQoKICAgICAgICAgICAgaWYgZGF0YToKICAgICAgICAgICAgICAgIGlmIG5vdCBiaW5hcnlfZGF0YToKICAgICAgICAgICAgICAgICAgICBkYXRhICs9ICdcbicKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZGF0YSwgdGV4dF90eXBlKToKICAgICAgICAgICAgICAgICAgICBkYXRhID0gdG9fYnl0ZXMoZGF0YSkKICAgICAgICAgICAgICAgIGNtZC5zdGRpbi53cml0ZShkYXRhKQogICAgICAgICAgICAgICAgY21kLnN0ZGluLmNsb3NlKCkKCiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICByZmRzLCB3ZmRzLCBlZmRzID0gc2VsZWN0LnNlbGVjdChycGlwZXMsIFtdLCBycGlwZXMsIDEpCiAgICAgICAgICAgICAgICBzdGRvdXQgKz0gc2VsZi5fcmVhZF9mcm9tX3BpcGVzKHJwaXBlcywgcmZkcywgY21kLnN0ZG91dCkKICAgICAgICAgICAgICAgIHN0ZGVyciArPSBzZWxmLl9yZWFkX2Zyb21fcGlwZXMocnBpcGVzLCByZmRzLCBjbWQuc3RkZXJyKQogICAgICAgICAgICAgICAgIyBpZiB3ZSdyZSBjaGVja2luZyBmb3IgcHJvbXB0cywgZG8gaXQgbm93CiAgICAgICAgICAgICAgICBpZiBwcm9tcHRfcmU6CiAgICAgICAgICAgICAgICAgICAgaWYgcHJvbXB0X3JlLnNlYXJjaChzdGRvdXQpIGFuZCBub3QgZGF0YToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZW5jb2Rpbmc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQgPSB0b19uYXRpdmUoc3Rkb3V0LCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycykKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dCA9IHN0ZG91dAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKDI1Nywgc3Rkb3V0LCAiQSBwcm9tcHQgd2FzIGVuY291bnRlcmVkIHdoaWxlIHJ1bm5pbmcgYSBjb21tYW5kLCBidXQgbm8gaW5wdXQgZGF0YSB3YXMgc3BlY2lmaWVkIikKICAgICAgICAgICAgICAgICMgb25seSBicmVhayBvdXQgaWYgbm8gcGlwZXMgYXJlIGxlZnQgdG8gcmVhZCBvcgogICAgICAgICAgICAgICAgIyB0aGUgcGlwZXMgYXJlIGNvbXBsZXRlbHkgcmVhZCBhbmQKICAgICAgICAgICAgICAgICMgdGhlIHByb2Nlc3MgaXMgdGVybWluYXRlZAogICAgICAgICAgICAgICAgaWYgKG5vdCBycGlwZXMgb3Igbm90IHJmZHMpIGFuZCBjbWQucG9sbCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAjIE5vIHBpcGVzIGFyZSBsZWZ0IHRvIHJlYWQgYnV0IHByb2Nlc3MgaXMgbm90IHlldCB0ZXJtaW5hdGVkCiAgICAgICAgICAgICAgICAjIE9ubHkgdGhlbiBpdCBpcyBzYWZlIHRvIHdhaXQgZm9yIHRoZSBwcm9jZXNzIHRvIGJlIGZpbmlzaGVkCiAgICAgICAgICAgICAgICAjIE5PVEU6IEFjdHVhbGx5IGNtZC5wb2xsKCkgaXMgYWx3YXlzIE5vbmUgaGVyZSBpZiBycGlwZXMgaXMgZW1wdHkKICAgICAgICAgICAgICAgIGVsaWYgbm90IHJwaXBlcyBhbmQgY21kLnBvbGwoKSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIGNtZC53YWl0KCkKICAgICAgICAgICAgICAgICAgICAjIFRoZSBwcm9jZXNzIGlzIHRlcm1pbmF0ZWQuIFNpbmNlIG5vIHBpcGVzIHRvIHJlYWQgZnJvbSBhcmUKICAgICAgICAgICAgICAgICAgICAjIGxlZnQsIHRoZXJlIGlzIG5vIG5lZWQgdG8gY2FsbCBzZWxlY3QoKSBhZ2Fpbi4KICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgY21kLnN0ZG91dC5jbG9zZSgpCiAgICAgICAgICAgIGNtZC5zdGRlcnIuY2xvc2UoKQoKICAgICAgICAgICAgcmMgPSBjbWQucmV0dXJuY29kZQogICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5sb2coIkVycm9yIEV4ZWN1dGluZyBDTUQ6JXMgRXhjZXB0aW9uOiVzIiAlIChjbGVhbl9hcmdzLCB0b19uYXRpdmUoZSkpKQogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihyYz1lLmVycm5vLCBtc2c9dG9fbmF0aXZlKGUpLCBjbWQ9Y2xlYW5fYXJncykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYubG9nKCJFcnJvciBFeGVjdXRpbmcgQ01EOiVzIEV4Y2VwdGlvbjolcyIgJSAoY2xlYW5fYXJncyx0b19uYXRpdmUodHJhY2ViYWNrLmZvcm1hdF9leGMoKSkpKQogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihyYz0yNTcsIG1zZz10b19uYXRpdmUoZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpLCBjbWQ9Y2xlYW5fYXJncykKCiAgICAgICAgIyBSZXN0b3JlIGVudiBzZXR0aW5ncwogICAgICAgIGZvciBrZXksIHZhbCBpbiBvbGRfZW52X3ZhbHMuaXRlbXMoKToKICAgICAgICAgICAgaWYgdmFsIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBkZWwgb3MuZW52aXJvbltrZXldCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBvcy5lbnZpcm9uW2tleV0gPSB2YWwKCiAgICAgICAgaWYgb2xkX3VtYXNrOgogICAgICAgICAgICBvcy51bWFzayhvbGRfdW1hc2spCgogICAgICAgIGlmIHJjICE9IDAgYW5kIGNoZWNrX3JjOgogICAgICAgICAgICBtc2cgPSBoZXVyaXN0aWNfbG9nX3Nhbml0aXplKHN0ZGVyci5yc3RyaXAoKSwgc2VsZi5ub19sb2dfdmFsdWVzKQogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihjbWQ9Y2xlYW5fYXJncywgcmM9cmMsIHN0ZG91dD1zdGRvdXQsIHN0ZGVycj1zdGRlcnIsIG1zZz1tc2cpCgogICAgICAgICMgcmVzZXQgdGhlIHB3ZAogICAgICAgIG9zLmNoZGlyKHByZXZfZGlyKQoKICAgICAgICBpZiBlbmNvZGluZyBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0dXJuIChyYywgdG9fbmF0aXZlKHN0ZG91dCwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpLAogICAgICAgICAgICAgICAgICAgIHRvX25hdGl2ZShzdGRlcnIsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKSkKICAgICAgICByZXR1cm4gKHJjLCBzdGRvdXQsIHN0ZGVycikKCiAgICBkZWYgYXBwZW5kX3RvX2ZpbGUoc2VsZiwgZmlsZW5hbWUsIHN0cik6CiAgICAgICAgZmlsZW5hbWUgPSBvcy5wYXRoLmV4cGFuZHZhcnMob3MucGF0aC5leHBhbmR1c2VyKGZpbGVuYW1lKSkKICAgICAgICBmaCA9IG9wZW4oZmlsZW5hbWUsICdhJykKICAgICAgICBmaC53cml0ZShzdHIpCiAgICAgICAgZmguY2xvc2UoKQoKICAgIGRlZiBieXRlc190b19odW1hbihzZWxmLCBzaXplKToKICAgICAgICByZXR1cm4gYnl0ZXNfdG9faHVtYW4oc2l6ZSkKCiAgICAjIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQogICAgcHJldHR5X2J5dGVzID0gYnl0ZXNfdG9faHVtYW4KCiAgICBkZWYgaHVtYW5fdG9fYnl0ZXMoc2VsZiwgbnVtYmVyLCBpc2JpdHM9RmFsc2UpOgogICAgICAgIHJldHVybiBodW1hbl90b19ieXRlcyhudW1iZXIsIGlzYml0cykKCiAgICAjCiAgICAjIEJhY2t3YXJkcyBjb21wYXQKICAgICMKCiAgICAjIEluIDIuMCwgbW92ZWQgZnJvbSBpbnNpZGUgdGhlIG1vZHVsZSB0byB0aGUgdG9wbGV2ZWwKICAgIGlzX2V4ZWN1dGFibGUgPSBpc19leGVjdXRhYmxlCgoKZGVmIGdldF9tb2R1bGVfcGF0aCgpOgogICAgcmV0dXJuIG9zLnBhdGguZGlybmFtZShvcy5wYXRoLnJlYWxwYXRoKF9fZmlsZV9fKSkKUEsDBBQAAAAAANS7K0t3Tv60fCgAAHwoAAAgAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZjVfdXRpbHMucHkjCiMgQ29weXJpZ2h0IDIwMTYgRjUgTmV0d29ya3MgSW5jLgojCiMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKCiMgTGVnYWN5Cgp0cnk6CiAgICBpbXBvcnQgYmlnc3VkcwogICAgYmlnc3Vkc19mb3VuZCA9IFRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgYmlnc3Vkc19mb3VuZCA9IEZhbHNlCgoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5iYXNpYyBpbXBvcnQgZW52X2ZhbGxiYWNrCgoKZGVmIGY1X2FyZ3VtZW50X3NwZWMoKToKICAgIHJldHVybiBkaWN0KAogICAgICAgIHNlcnZlcj1kaWN0KAogICAgICAgICAgICB0eXBlPSdzdHInLAogICAgICAgICAgICByZXF1aXJlZD1UcnVlLAogICAgICAgICAgICBmYWxsYmFjaz0oZW52X2ZhbGxiYWNrLCBbJ0Y1X1NFUlZFUiddKQogICAgICAgICksCiAgICAgICAgdXNlcj1kaWN0KAogICAgICAgICAgICB0eXBlPSdzdHInLAogICAgICAgICAgICByZXF1aXJlZD1UcnVlLAogICAgICAgICAgICBmYWxsYmFjaz0oZW52X2ZhbGxiYWNrLCBbJ0Y1X1VTRVInXSkKICAgICAgICApLAogICAgICAgIHBhc3N3b3JkPWRpY3QoCiAgICAgICAgICAgIHR5cGU9J3N0cicsCiAgICAgICAgICAgIGFsaWFzZXM9WydwYXNzJywgJ3B3ZCddLAogICAgICAgICAgICByZXF1aXJlZD1UcnVlLAogICAgICAgICAgICBub19sb2c9VHJ1ZSwKICAgICAgICAgICAgZmFsbGJhY2s9KGVudl9mYWxsYmFjaywgWydGNV9QQVNTV09SRCddKQogICAgICAgICksCiAgICAgICAgdmFsaWRhdGVfY2VydHM9ZGljdCgKICAgICAgICAgICAgZGVmYXVsdD0neWVzJywKICAgICAgICAgICAgdHlwZT0nYm9vbCcsCiAgICAgICAgICAgIGZhbGxiYWNrPShlbnZfZmFsbGJhY2ssIFsnRjVfVkFMSURBVEVfQ0VSVFMnXSkKICAgICAgICApLAogICAgICAgIHNlcnZlcl9wb3J0PWRpY3QoCiAgICAgICAgICAgIHR5cGU9J2ludCcsCiAgICAgICAgICAgIGRlZmF1bHQ9NDQzLAogICAgICAgICAgICByZXF1aXJlZD1GYWxzZSwKICAgICAgICAgICAgZmFsbGJhY2s9KGVudl9mYWxsYmFjaywgWydGNV9TRVJWRVJfUE9SVCddKQogICAgICAgICksCiAgICAgICAgc3RhdGU9ZGljdCgKICAgICAgICAgICAgdHlwZT0nc3RyJywKICAgICAgICAgICAgZGVmYXVsdD0ncHJlc2VudCcsCiAgICAgICAgICAgIGNob2ljZXM9WydwcmVzZW50JywgJ2Fic2VudCddCiAgICAgICAgKSwKICAgICAgICBwYXJ0aXRpb249ZGljdCgKICAgICAgICAgICAgdHlwZT0nc3RyJywKICAgICAgICAgICAgZGVmYXVsdD0nQ29tbW9uJywKICAgICAgICAgICAgZmFsbGJhY2s9KGVudl9mYWxsYmFjaywgWydGNV9QQVJUSVRJT04nXSkKICAgICAgICApCiAgICApCgoKZGVmIGY1X3BhcnNlX2FyZ3VtZW50cyhtb2R1bGUpOgogICAgaWYgbm90IGJpZ3N1ZHNfZm91bmQ6CiAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9InRoZSBweXRob24gYmlnc3VkcyBtb2R1bGUgaXMgcmVxdWlyZWQiKQoKICAgIGlmIG1vZHVsZS5wYXJhbXNbJ3ZhbGlkYXRlX2NlcnRzJ106CiAgICAgICAgaW1wb3J0IHNzbAogICAgICAgIGlmIG5vdCBoYXNhdHRyKHNzbCwgJ1NTTENvbnRleHQnKToKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0iYmlnc3VkcyBkb2VzIG5vdCBzdXBwb3J0IHZlcmlmeWluZyBjZXJ0aWZpY2F0ZXMgd2l0aCBweXRob24gPCAyLjcuOS4iIFwKICAgICAgICAgICAgICAgICAgICAiRWl0aGVyIHVwZGF0ZSBweXRob24gb3Igc2V0IHZhbGlkYXRlX2NlcnRzPUZhbHNlIG9uIHRoZSB0YXNrJyIpCgogICAgcmV0dXJuICgKICAgICAgICBtb2R1bGUucGFyYW1zWydzZXJ2ZXInXSwKICAgICAgICBtb2R1bGUucGFyYW1zWyd1c2VyJ10sCiAgICAgICAgbW9kdWxlLnBhcmFtc1sncGFzc3dvcmQnXSwKICAgICAgICBtb2R1bGUucGFyYW1zWydzdGF0ZSddLAogICAgICAgIG1vZHVsZS5wYXJhbXNbJ3BhcnRpdGlvbiddLAogICAgICAgIG1vZHVsZS5wYXJhbXNbJ3ZhbGlkYXRlX2NlcnRzJ10sCiAgICAgICAgbW9kdWxlLnBhcmFtc1snc2VydmVyX3BvcnQnXQogICAgKQoKCmRlZiBiaWdpcF9hcGkoYmlnaXAsIHVzZXIsIHBhc3N3b3JkLCB2YWxpZGF0ZV9jZXJ0cywgcG9ydD00NDMpOgogICAgdHJ5OgogICAgICAgIGlmIGJpZ3N1ZHMuX192ZXJzaW9uX18gPj0gJzEuMC40JzoKICAgICAgICAgICAgYXBpID0gYmlnc3Vkcy5CSUdJUChob3N0bmFtZT1iaWdpcCwgdXNlcm5hbWU9dXNlciwgcGFzc3dvcmQ9cGFzc3dvcmQsIHZlcmlmeT12YWxpZGF0ZV9jZXJ0cywgcG9ydD1wb3J0KQogICAgICAgIGVsaWYgYmlnc3Vkcy5fX3ZlcnNpb25fXyA9PSAnMS4wLjMnOgogICAgICAgICAgICBhcGkgPSBiaWdzdWRzLkJJR0lQKGhvc3RuYW1lPWJpZ2lwLCB1c2VybmFtZT11c2VyLCBwYXNzd29yZD1wYXNzd29yZCwgdmVyaWZ5PXZhbGlkYXRlX2NlcnRzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGFwaSA9IGJpZ3N1ZHMuQklHSVAoaG9zdG5hbWU9YmlnaXAsIHVzZXJuYW1lPXVzZXIsIHBhc3N3b3JkPXBhc3N3b3JkKQogICAgZXhjZXB0IFR5cGVFcnJvcjoKICAgICAgICAjIGJpZ3N1ZHMgPCAxLjAuMywgbm8gdmVyaWZ5IHBhcmFtCiAgICAgICAgaWYgdmFsaWRhdGVfY2VydHM6CiAgICAgICAgICAgICMgTm90ZTogdmVyaWZpZWQgd2UgaGF2ZSBTU0xDb250ZXh0IHdoZW4gd2UgcGFyc2VkIHBhcmFtcwogICAgICAgICAgICBhcGkgPSBiaWdzdWRzLkJJR0lQKGhvc3RuYW1lPWJpZ2lwLCB1c2VybmFtZT11c2VyLCBwYXNzd29yZD1wYXNzd29yZCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpbXBvcnQgc3NsCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc3NsLCAnU1NMQ29udGV4dCcpOgogICAgICAgICAgICAgICAgIyBSZWFsbHksIHlvdSBzaG91bGQgbmV2ZXIgZG8gdGhpcy4gIEl0IGRpc2FibGVzIGNlcnRpZmljYXRlCiAgICAgICAgICAgICAgICAjIHZlcmlmaWNhdGlvbiAqZ2xvYmFsbHkqLiAgQnV0IHNpbmNlIG9sZGVyIGJpZ2lwIGxpYnJhcmllcwogICAgICAgICAgICAgICAgIyBkb24ndCBnaXZlIHVzIGEgd2F5IHRvIHRvZ2dsZSB2ZXJpZmljYXRpb24gd2UgbmVlZCB0bwogICAgICAgICAgICAgICAgIyBkaXNhYmxlIGl0IGF0IHRoZSBnbG9iYWwgbGV2ZWwuCiAgICAgICAgICAgICAgICAjIEZyb20gaHR0cHM6Ly93d3cucHl0aG9uLm9yZy9kZXYvcGVwcy9wZXAtMDQ3Ni8jaWQyOQogICAgICAgICAgICAgICAgc3NsLl9jcmVhdGVfZGVmYXVsdF9odHRwc19jb250ZXh0ID0gc3NsLl9jcmVhdGVfdW52ZXJpZmllZF9jb250ZXh0CiAgICAgICAgICAgIGFwaSA9IGJpZ3N1ZHMuQklHSVAoaG9zdG5hbWU9YmlnaXAsIHVzZXJuYW1lPXVzZXIsIHBhc3N3b3JkPXBhc3N3b3JkKQoKICAgIHJldHVybiBhcGkKCgojIEZ1bGx5IFF1YWxpZmllZCBuYW1lICh3aXRoIHRoZSBwYXJ0aXRpb24pCmRlZiBmcV9uYW1lKHBhcnRpdGlvbixuYW1lKToKICAgIGlmIG5hbWUgaXMgbm90IE5vbmUgYW5kIG5vdCBuYW1lLnN0YXJ0c3dpdGgoJy8nKToKICAgICAgICByZXR1cm4gJy8lcy8lcycgJSAocGFydGl0aW9uLG5hbWUpCiAgICByZXR1cm4gbmFtZQoKCiMgRnVsbHkgUXVhbGlmaWVkIG5hbWUgKHdpdGggcGFydGl0aW9uKSBmb3IgYSBsaXN0CmRlZiBmcV9saXN0X25hbWVzKHBhcnRpdGlvbixsaXN0X25hbWVzKToKICAgIGlmIGxpc3RfbmFtZXMgaXMgTm9uZToKICAgICAgICByZXR1cm4gTm9uZQogICAgcmV0dXJuIG1hcChsYW1iZGEgeDogZnFfbmFtZShwYXJ0aXRpb24seCksbGlzdF9uYW1lcykKCgoKCgojIE5ldyBzdHlsZQoKZnJvbSBhYmMgaW1wb3J0IEFCQ01ldGEsIGFic3RyYWN0cHJvcGVydHkKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IHdpdGhfbWV0YWNsYXNzCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IGRlZmF1bHRkaWN0Cgp0cnk6CiAgICBmcm9tIGY1LmJpZ2lwIGltcG9ydCBNYW5hZ2VtZW50Um9vdCBhcyBCaWdJcE1nbXQKICAgIGZyb20gZjUuYmlnaXAuY29udGV4dHMgaW1wb3J0IFRyYW5zYWN0aW9uQ29udGV4dE1hbmFnZXIgYXMgQmlnSXBUeENvbnRleHQKCiAgICBmcm9tIGY1LmJpZ2lxIGltcG9ydCBNYW5hZ2VtZW50Um9vdCBhcyBCaWdJcU1nbXQKCiAgICBmcm9tIGY1Lml3b3JrZmxvdyBpbXBvcnQgTWFuYWdlbWVudFJvb3QgYXMgaVdvcmtmbG93TWdtdAogICAgZnJvbSBpY29udHJvbC5zZXNzaW9uIGltcG9ydCBpQ29udHJvbFVuZXhwZWN0ZWRIVFRQRXJyb3IKICAgIEhBU19GNVNESyA9IFRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgSEFTX0Y1U0RLID0gRmFsc2UKCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmJhc2ljIGltcG9ydCAqCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGltcG9ydCBpdGVyaXRlbXMKCgpGNV9DT01NT05fQVJHUyA9IGRpY3QoCiAgICBzZXJ2ZXI9ZGljdCgKICAgICAgICB0eXBlPSdzdHInLAogICAgICAgIHJlcXVpcmVkPVRydWUsCiAgICAgICAgZmFsbGJhY2s9KGVudl9mYWxsYmFjaywgWydGNV9TRVJWRVInXSkKICAgICksCiAgICB1c2VyPWRpY3QoCiAgICAgICAgdHlwZT0nc3RyJywKICAgICAgICByZXF1aXJlZD1UcnVlLAogICAgICAgIGZhbGxiYWNrPShlbnZfZmFsbGJhY2ssIFsnRjVfVVNFUiddKQogICAgKSwKICAgIHBhc3N3b3JkPWRpY3QoCiAgICAgICAgdHlwZT0nc3RyJywKICAgICAgICBhbGlhc2VzPVsncGFzcycsICdwd2QnXSwKICAgICAgICByZXF1aXJlZD1UcnVlLAogICAgICAgIG5vX2xvZz1UcnVlLAogICAgICAgIGZhbGxiYWNrPShlbnZfZmFsbGJhY2ssIFsnRjVfUEFTU1dPUkQnXSkKICAgICksCiAgICB2YWxpZGF0ZV9jZXJ0cz1kaWN0KAogICAgICAgIGRlZmF1bHQ9J3llcycsCiAgICAgICAgdHlwZT0nYm9vbCcsCiAgICAgICAgZmFsbGJhY2s9KGVudl9mYWxsYmFjaywgWydGNV9WQUxJREFURV9DRVJUUyddKQogICAgKSwKICAgIHNlcnZlcl9wb3J0PWRpY3QoCiAgICAgICAgdHlwZT0naW50JywKICAgICAgICBkZWZhdWx0PTQ0MywKICAgICAgICByZXF1aXJlZD1GYWxzZSwKICAgICAgICBmYWxsYmFjaz0oZW52X2ZhbGxiYWNrLCBbJ0Y1X1NFUlZFUl9QT1JUJ10pCiAgICApLAogICAgc3RhdGU9ZGljdCgKICAgICAgICB0eXBlPSdzdHInLAogICAgICAgIGRlZmF1bHQ9J3ByZXNlbnQnLAogICAgICAgIGNob2ljZXM9WydwcmVzZW50JywgJ2Fic2VudCddCiAgICApLAogICAgcGFydGl0aW9uPWRpY3QoCiAgICAgICAgdHlwZT0nc3RyJywKICAgICAgICBkZWZhdWx0PSdDb21tb24nLAogICAgICAgIGZhbGxiYWNrPShlbnZfZmFsbGJhY2ssIFsnRjVfUEFSVElUSU9OJ10pCiAgICApCikKCgpjbGFzcyBBbnNpYmxlRjVDbGllbnQob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhcmd1bWVudF9zcGVjPU5vbmUsIHN1cHBvcnRzX2NoZWNrX21vZGU9RmFsc2UsCiAgICAgICAgICAgICAgICAgbXV0dWFsbHlfZXhjbHVzaXZlPU5vbmUsIHJlcXVpcmVkX3RvZ2V0aGVyPU5vbmUsCiAgICAgICAgICAgICAgICAgcmVxdWlyZWRfaWY9Tm9uZSwgcmVxdWlyZWRfb25lX29mPU5vbmUsCiAgICAgICAgICAgICAgICAgZjVfcHJvZHVjdF9uYW1lPSdiaWdpcCcpOgoKICAgICAgICBtZXJnZWRfYXJnX3NwZWMgPSBkaWN0KCkKICAgICAgICBtZXJnZWRfYXJnX3NwZWMudXBkYXRlKEY1X0NPTU1PTl9BUkdTKQogICAgICAgIGlmIGFyZ3VtZW50X3NwZWM6CiAgICAgICAgICAgIG1lcmdlZF9hcmdfc3BlYy51cGRhdGUoYXJndW1lbnRfc3BlYykKICAgICAgICAgICAgc2VsZi5hcmdfc3BlYyA9IG1lcmdlZF9hcmdfc3BlYwoKICAgICAgICBtdXR1YWxseV9leGNsdXNpdmVfcGFyYW1zID0gW10KICAgICAgICBpZiBtdXR1YWxseV9leGNsdXNpdmU6CiAgICAgICAgICAgIG11dHVhbGx5X2V4Y2x1c2l2ZV9wYXJhbXMgKz0gbXV0dWFsbHlfZXhjbHVzaXZlCgogICAgICAgIHJlcXVpcmVkX3RvZ2V0aGVyX3BhcmFtcyA9IFtdCiAgICAgICAgaWYgcmVxdWlyZWRfdG9nZXRoZXI6CiAgICAgICAgICAgIHJlcXVpcmVkX3RvZ2V0aGVyX3BhcmFtcyArPSByZXF1aXJlZF90b2dldGhlcgoKICAgICAgICBzZWxmLm1vZHVsZSA9IEFuc2libGVNb2R1bGUoCiAgICAgICAgICAgIGFyZ3VtZW50X3NwZWM9bWVyZ2VkX2FyZ19zcGVjLAogICAgICAgICAgICBzdXBwb3J0c19jaGVja19tb2RlPXN1cHBvcnRzX2NoZWNrX21vZGUsCiAgICAgICAgICAgIG11dHVhbGx5X2V4Y2x1c2l2ZT1tdXR1YWxseV9leGNsdXNpdmVfcGFyYW1zLAogICAgICAgICAgICByZXF1aXJlZF90b2dldGhlcj1yZXF1aXJlZF90b2dldGhlcl9wYXJhbXMsCiAgICAgICAgICAgIHJlcXVpcmVkX2lmPXJlcXVpcmVkX2lmLAogICAgICAgICAgICByZXF1aXJlZF9vbmVfb2Y9cmVxdWlyZWRfb25lX29mCiAgICAgICAgKQoKICAgICAgICBzZWxmLmNoZWNrX21vZGUgPSBzZWxmLm1vZHVsZS5jaGVja19tb2RlCiAgICAgICAgc2VsZi5fY29ubmVjdF9wYXJhbXMgPSBzZWxmLl9nZXRfY29ubmVjdF9wYXJhbXMoKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuYXBpID0gc2VsZi5fZ2V0X21nbXRfcm9vdCgKICAgICAgICAgICAgICAgIGY1X3Byb2R1Y3RfbmFtZSwgKipzZWxmLl9jb25uZWN0X3BhcmFtcwogICAgICAgICAgICApCiAgICAgICAgZXhjZXB0IGlDb250cm9sVW5leHBlY3RlZEhUVFBFcnJvciBhcyBleGM6CiAgICAgICAgICAgIHNlbGYuZmFpbChzdHIoZXhjKSkKCiAgICBkZWYgZmFpbChzZWxmLCBtc2cpOgogICAgICAgIHNlbGYubW9kdWxlLmZhaWxfanNvbihtc2c9bXNnKQoKICAgIGRlZiBfZ2V0X2Nvbm5lY3RfcGFyYW1zKHNlbGYpOgogICAgICAgIHBhcmFtcyA9IGRpY3QoCiAgICAgICAgICAgIHVzZXI9c2VsZi5tb2R1bGUucGFyYW1zWyd1c2VyJ10sCiAgICAgICAgICAgIHBhc3N3b3JkPXNlbGYubW9kdWxlLnBhcmFtc1sncGFzc3dvcmQnXSwKICAgICAgICAgICAgc2VydmVyPXNlbGYubW9kdWxlLnBhcmFtc1snc2VydmVyJ10sCiAgICAgICAgICAgIHNlcnZlcl9wb3J0PXNlbGYubW9kdWxlLnBhcmFtc1snc2VydmVyX3BvcnQnXSwKICAgICAgICAgICAgdmFsaWRhdGVfY2VydHM9c2VsZi5tb2R1bGUucGFyYW1zWyd2YWxpZGF0ZV9jZXJ0cyddCiAgICAgICAgKQogICAgICAgIHJldHVybiBwYXJhbXMKCiAgICBkZWYgX2dldF9tZ210X3Jvb3Qoc2VsZiwgdHlwZSwgKiprd2FyZ3MpOgogICAgICAgIGlmIHR5cGUgPT0gJ2JpZ2lwJzoKICAgICAgICAgICAgcmV0dXJuIEJpZ0lwTWdtdCgKICAgICAgICAgICAgICAgIGt3YXJnc1snc2VydmVyJ10sCiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3VzZXInXSwKICAgICAgICAgICAgICAgIGt3YXJnc1sncGFzc3dvcmQnXSwKICAgICAgICAgICAgICAgIHBvcnQ9a3dhcmdzWydzZXJ2ZXJfcG9ydCddLAogICAgICAgICAgICAgICAgdG9rZW49J3Rtb3MnCiAgICAgICAgICAgICkKICAgICAgICBlbGlmIHR5cGUgPT0gJ2l3b3JrZmxvdyc6CiAgICAgICAgICAgIHJldHVybiBpV29ya2Zsb3dNZ210KAogICAgICAgICAgICAgICAga3dhcmdzWydzZXJ2ZXInXSwKICAgICAgICAgICAgICAgIGt3YXJnc1sndXNlciddLAogICAgICAgICAgICAgICAga3dhcmdzWydwYXNzd29yZCddLAogICAgICAgICAgICAgICAgcG9ydD1rd2FyZ3NbJ3NlcnZlcl9wb3J0J10sCiAgICAgICAgICAgICAgICB0b2tlbj0nbG9jYWwnCiAgICAgICAgICAgICkKICAgICAgICBlbGlmIHR5cGUgPT0gJ2JpZ2lxJzoKICAgICAgICAgICAgcmV0dXJuIEJpZ0lxTWdtdCgKICAgICAgICAgICAgICAgIGt3YXJnc1snc2VydmVyJ10sCiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3VzZXInXSwKICAgICAgICAgICAgICAgIGt3YXJnc1sncGFzc3dvcmQnXSwKICAgICAgICAgICAgICAgIHBvcnQ9a3dhcmdzWydzZXJ2ZXJfcG9ydCddLAogICAgICAgICAgICAgICAgdG9rZW49J2xvY2FsJwogICAgICAgICAgICApCgoKY2xhc3MgQW5zaWJsZUY1UGFyYW1ldGVycyhvYmplY3QpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHBhcmFtcz1Ob25lKToKICAgICAgICBzZWxmLl92YWx1ZXMgPSBkZWZhdWx0ZGljdChsYW1iZGE6IE5vbmUpCiAgICAgICAgaWYgcGFyYW1zOgogICAgICAgICAgICBmb3Igayx2IGluIGl0ZXJpdGVtcyhwYXJhbXMpOgogICAgICAgICAgICAgICAgaWYgc2VsZi5hcGlfbWFwIGlzIG5vdCBOb25lIGFuZCBrIGluIHNlbGYuYXBpX21hcDoKICAgICAgICAgICAgICAgICAgICBkaWN0X3RvX3VzZSA9IHNlbGYuYXBpX21hcAogICAgICAgICAgICAgICAgICAgIG1hcF9rZXkgPSBzZWxmLmFwaV9tYXBba10KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZGljdF90b191c2UgPSBzZWxmLl92YWx1ZXMKICAgICAgICAgICAgICAgICAgICBtYXBfa2V5ID0gawoKICAgICAgICAgICAgICAgICMgSGFuZGxlIHdlaXJkIEFQSSBwYXJhbWV0ZXJzIGxpa2UgYGRucy5wcm94eS5fX2l0ZXJfX2AgYnkKICAgICAgICAgICAgICAgICMgdXNpbmcgYSBtYXAgcHJvdmlkZWQgYnkgdGhlIG1vZHVsZSBkZXZlbG9wZXIKICAgICAgICAgICAgICAgIGNsYXNzX2F0dHIgPSBnZXRhdHRyKHR5cGUoc2VsZiksIG1hcF9rZXksIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGNsYXNzX2F0dHIsIHByb3BlcnR5KToKICAgICAgICAgICAgICAgICAgICAjIFRoZXJlIGlzIGEgbWFwcGVkIHZhbHVlIGZvciB0aGUgYXBpX21hcCBrZXkKICAgICAgICAgICAgICAgICAgICBpZiBjbGFzc19hdHRyLmZzZXQgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBJZiB0aGUgbWFwcGVkIHZhbHVlIGRvZXMgbm90IGhhdmUgYW4gYXNzb2NpYXRlZCBzZXR0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fdmFsdWVzW21hcF9rZXldID0gdgogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgVGhlIG1hcHBlZCB2YWx1ZSBoYXMgYSBzZXR0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgc2V0YXR0cihzZWxmLCBtYXBfa2V5LCB2KQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIElmIHRoZSBtYXBwZWQgdmFsdWUgaXMgbm90IGEgQHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fdmFsdWVzW21hcF9rZXldID0gdgoKICAgIGRlZiBfX2dldGF0dHJfXyhzZWxmLCBpdGVtKToKICAgICAgICAjIEVuc3VyZXMgdGhhdCBwcm9wZXJ0aWVzIHRoYXQgd2VyZW4ndCBkZWZpbmVkLCBhbmQgdGhlcmVmb3JlIHN0YXNoZWQKICAgICAgICAjIGluIHRoZSBgX3ZhbHVlc2AgZGljdCwgd2lsbCBiZSByZXRyaWV2YWJsZS4KICAgICAgICByZXR1cm4gc2VsZi5fdmFsdWVzW2l0ZW1dCgogICAgQHByb3BlcnR5CiAgICBkZWYgcGFydGl0aW9uKHNlbGYpOgogICAgICAgIGlmIHNlbGYuX3ZhbHVlc1sncGFydGl0aW9uJ10gaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuICdDb21tb24nCiAgICAgICAgcmV0dXJuIHNlbGYuX3ZhbHVlc1sncGFydGl0aW9uJ10uc3RyaXAoJy8nKQoKICAgIEBwYXJ0aXRpb24uc2V0dGVyCiAgICBkZWYgcGFydGl0aW9uKHNlbGYsIHZhbHVlKToKICAgICAgICBzZWxmLl92YWx1ZXNbJ3BhcnRpdGlvbiddID0gdmFsdWUKCiAgICBkZWYgX2ZpbHRlcl9wYXJhbXMoc2VsZiwgcGFyYW1zKToKICAgICAgICByZXR1cm4gZGljdCgoaywgdikgZm9yIGssIHYgaW4gaXRlcml0ZW1zKHBhcmFtcykgaWYgdiBpcyBub3QgTm9uZSkKCgpjbGFzcyBGNU1vZHVsZUVycm9yKEV4Y2VwdGlvbik6CiAgICBwYXNzClBLAwQUAAAAAADUuytLtdgEBiUwAAAlMAAAHQAAAGFuc2libGUvbW9kdWxlX3V0aWxzL190ZXh0LnB5IyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojIFRoaXMgcGFydGljdWxhciBmaWxlIHNuaXBwZXQsIGFuZCB0aGlzIGZpbGUgc25pcHBldCBvbmx5LCBpcyBCU0QgbGljZW5zZWQuCiMgTW9kdWxlcyB5b3Ugd3JpdGUgdXNpbmcgdGhpcyBzbmlwcGV0LCB3aGljaCBpcyBlbWJlZGRlZCBkeW5hbWljYWxseSBieSBBbnNpYmxlCiMgc3RpbGwgYmVsb25nIHRvIHRoZSBhdXRob3Igb2YgdGhlIG1vZHVsZSwgYW5kIG1heSBhc3NpZ24gdGhlaXIgb3duIGxpY2Vuc2UKIyB0byB0aGUgY29tcGxldGUgd29yay4KIwojIENvcHlyaWdodCAoYyksIFRvc2hpbyBLdXJhdG9taSA8YS5iYWRnZXJAZ21haWwuY29tPiwgMjAxNgojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwKIyBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiMgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICAgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICAgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKIyBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAojIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4KIyBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwKIyBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sCiMgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCiMgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVAojIExJQUJJTElUWSwgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRQojIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCgoiIiIKLi4gd2Fybjo6IFRoaXMgbW9kdWxlX3V0aWwgaXMgY3VycmVudGx5IGludGVybmFsIGltcGxlbWVudGF0aW9uLgogICAgV2Ugd2FudCB0byBldmFsdWF0ZSB0aGlzIGNvZGUgZm9yIHN0YWJpbGl0eSBhbmQgQVBJIHN1aXRhYmlsaXR5IGJlZm9yZQogICAgbWFraW5nIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGd1YXJhbnRlZXMuICBUaGUgQVBJIG1heSBjaGFuZ2UgYmV0d2VlbgogICAgcmVsZWFzZXMuICBEbyBub3QgdXNlIHRoaXMgdW5sZXNzIHlvdSBhcmUgd2lsbGluZyB0byBwb3J0IHlvdXIgbW9kdWxlIGNvZGUuCiIiIgppbXBvcnQgY29kZWNzCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpbXBvcnQgUFkzLCB0ZXh0X3R5cGUsIGJpbmFyeV90eXBlCgoKdHJ5OgogICAgY29kZWNzLmxvb2t1cF9lcnJvcignc3Vycm9nYXRlZXNjYXBlJykKICAgIEhBU19TVVJST0dBVEVFU0NBUEUgPSBUcnVlCmV4Y2VwdCBMb29rdXBFcnJvcjoKICAgIEhBU19TVVJST0dBVEVFU0NBUEUgPSBGYWxzZQoKCl9DT01QT1NFRF9FUlJPUl9IQU5ETEVSUyA9IGZyb3plbnNldCgoTm9uZSwgJ3N1cnJvZ2F0ZV9vcl9lc2NhcGUnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1cnJvZ2F0ZV9vcl9zdHJpY3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKSkKCgpkZWYgdG9fYnl0ZXMob2JqLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9Tm9uZSwgbm9uc3RyaW5nPSdzaW1wbGVyZXByJyk6CiAgICAiIiJNYWtlIHN1cmUgdGhhdCBhIHN0cmluZyBpcyBhIGJ5dGUgc3RyaW5nCgogICAgOmFyZyBvYmo6IEFuIG9iamVjdCB0byBtYWtlIHN1cmUgaXMgYSBieXRlIHN0cmluZy4gIEluIG1vc3QgY2FzZXMgdGhpcwogICAgICAgIHdpbGwgYmUgZWl0aGVyIGEgdGV4dCBzdHJpbmcgb3IgYSBieXRlIHN0cmluZy4gIEhvd2V2ZXIsIHdpdGgKICAgICAgICBgYG5vbnN0cmluZz0nc2ltcGxlcmVwcidgYCwgdGhpcyBjYW4gYmUgdXNlZCBhcyBhIHRyYWNlYmFjay1mcmVlCiAgICAgICAgdmVyc2lvbiBvZiBgYHN0cihvYmopYGAuCiAgICA6a3dhcmcgZW5jb2Rpbmc6IFRoZSBlbmNvZGluZyB0byB1c2UgdG8gdHJhbnNmb3JtIGZyb20gYSB0ZXh0IHN0cmluZyB0bwogICAgICAgIGEgYnl0ZSBzdHJpbmcuICBEZWZhdWx0cyB0byB1c2luZyAndXRmLTgnLgogICAgOmt3YXJnIGVycm9yczogVGhlIGVycm9yIGhhbmRsZXIgdG8gdXNlIGlmIHRoZSB0ZXh0IHN0cmluZyBpcyBub3QKICAgICAgICBlbmNvZGFibGUgdXNpbmcgdGhlIHNwZWNpZmllZCBlbmNvZGluZy4gIEFueSB2YWxpZCBgY29kZWNzIGVycm9yCiAgICAgICAgaGFuZGxlciA8aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMi9saWJyYXJ5L2NvZGVjcy5odG1sI2NvZGVjLWJhc2UtY2xhc3Nlcz5gXwogICAgICAgIG1heSBiZSBzcGVjaWZpZWQuIFRoZXJlIGFyZSB0aHJlZSBhZGRpdGlvbmFsIGVycm9yIHN0cmF0ZWdpZXMKICAgICAgICBzcGVjaWZpY2FsbHkgYWltZWQgYXQgaGVscGluZyBwZW9wbGUgdG8gcG9ydCBjb2RlLiAgVGhlIGZpcnN0IHR3byBhcmU6CgogICAgICAgICAgICA6c3Vycm9nYXRlX29yX3N0cmljdDogV2lsbCB1c2UgYGBzdXJyb2dhdGVlc2NhcGVgYCBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLCBvdGhlcndpc2UgaXQgd2lsbCB1c2UgYGBzdHJpY3RgYAogICAgICAgICAgICA6c3Vycm9nYXRlX29yX3JlcGxhY2U6IFdpbGwgdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlciwgb3RoZXJ3aXNlIGl0IHdpbGwgdXNlIGBgcmVwbGFjZWBgLgoKICAgICAgICBCZWNhdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgd2FzIGFkZGVkIGluIFB5dGhvbjMgdGhpcyB1c3VhbGx5IG1lYW5zIHRoYXQKICAgICAgICBQeXRob24zIHdpbGwgdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgYW5kIFB5dGhvbjIgd2lsbCB1c2UgdGhlIGZhbGxiYWNrCiAgICAgICAgZXJyb3IgaGFuZGxlci4gTm90ZSB0aGF0IHRoZSBjb2RlIGNoZWNrcyBmb3IgYGBzdXJyb2dhdGVlc2NhcGVgYCB3aGVuIHRoZQogICAgICAgIG1vZHVsZSBpcyBpbXBvcnRlZC4gIElmIHlvdSBoYXZlIGEgYmFja3BvcnQgb2YgYGBzdXJyb2dhdGVlc2NhcGVgYCBmb3IKICAgICAgICBQeXRob24yLCBiZSBzdXJlIHRvIHJlZ2lzdGVyIHRoZSBlcnJvciBoYW5kbGVyIHByaW9yIHRvIGltcG9ydGluZyB0aGlzCiAgICAgICAgbW9kdWxlLgoKICAgICAgICBUaGUgbGFzdCBlcnJvciBoYW5kbGVyIGlzOgoKICAgICAgICAgICAgOnN1cnJvZ2F0ZV90aGVuX3JlcGxhY2U6IFdpbGwgdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlci4gIElmIGVuY29kaW5nIHdpdGggYGBzdXJyb2dhdGVlc2NhcGVgYCB3b3VsZCB0cmFjZWJhY2ssCiAgICAgICAgICAgICAgICBzdXJyb2dhdGVzIGFyZSBmaXJzdCByZXBsYWNlZCB3aXRoIGEgcmVwbGFjZW1lbnQgY2hhcmFjdGVycwogICAgICAgICAgICAgICAgYW5kIHRoZW4gdGhlIHN0cmluZyBpcyBlbmNvZGVkIHVzaW5nIGBgcmVwbGFjZWBgICh3aGljaCByZXBsYWNlcwogICAgICAgICAgICAgICAgdGhlIHJlc3Qgb2YgdGhlIG5vbmVuY29kYWJsZSBieXRlcykuICBJZiBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlzCiAgICAgICAgICAgICAgICBub3QgcHJlc2VudCBpdCB3aWxsIHNpbXBseSB1c2UgYGByZXBsYWNlYGAuICAoQWRkZWQgaW4gQW5zaWJsZSAyLjMpCiAgICAgICAgICAgICAgICBUaGlzIHN0cmF0ZWd5IGlzIGRlc2lnbmVkIHRvIG5ldmVyIHRyYWNlYmFjayB3aGVuIGl0IGF0dGVtcHRzCiAgICAgICAgICAgICAgICB0byBlbmNvZGUgYSBzdHJpbmcuCgogICAgICAgIFRoZSBkZWZhdWx0IHVudGlsIEFuc2libGUtMi4yIHdhcyBgYHN1cnJvZ2F0ZV9vcl9yZXBsYWNlYGAKICAgICAgICBGcm9tIEFuc2libGUtMi4zIG9ud2FyZHMsIHRoZSBkZWZhdWx0IGlzIGBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWBgLgoKICAgIDprd2FyZyBub25zdHJpbmc6IFRoZSBzdHJhdGVneSB0byB1c2UgaWYgYSBub25zdHJpbmcgaXMgc3BlY2lmaWVkIGluCiAgICAgICAgYGBvYmpgYC4gIERlZmF1bHQgaXMgJ3NpbXBsZXJlcHInLiAgVmFsaWQgdmFsdWVzIGFyZToKCiAgICAgICAgOnNpbXBsZXJlcHI6IFRoZSBkZWZhdWx0LiAgVGhpcyB0YWtlcyB0aGUgYGBzdHJgYCBvZiB0aGUgb2JqZWN0IGFuZAogICAgICAgICAgICB0aGVuIHJldHVybnMgdGhlIGJ5dGVzIHZlcnNpb24gb2YgdGhhdCBzdHJpbmcuCiAgICAgICAgOmVtcHR5OiBSZXR1cm4gYW4gZW1wdHkgYnl0ZSBzdHJpbmcKICAgICAgICA6cGFzc3RocnU6IFJldHVybiB0aGUgb2JqZWN0IHBhc3NlZCBpbgogICAgICAgIDpzdHJpY3Q6IFJhaXNlIGEgOmV4YzpgVHlwZUVycm9yYAoKICAgIDpyZXR1cm5zOiBUeXBpY2FsbHkgdGhpcyByZXR1cm5zIGEgYnl0ZSBzdHJpbmcuICBJZiBhIG5vbnN0cmluZyBvYmplY3QgaXMKICAgICAgICBwYXNzZWQgaW4gdGhpcyBtYXkgYmUgYSBkaWZmZXJlbnQgdHlwZSBkZXBlbmRpbmcgb24gdGhlIHN0cmF0ZWd5CiAgICAgICAgc3BlY2lmaWVkIGJ5IG5vbnN0cmluZy4gIFRoaXMgd2lsbCBuZXZlciByZXR1cm4gYSB0ZXh0IHN0cmluZy4KCiAgICAuLiBub3RlOjogSWYgcGFzc2VkIGEgYnl0ZSBzdHJpbmcsIHRoaXMgZnVuY3Rpb24gZG9lcyBub3QgY2hlY2sgdGhhdCB0aGUKICAgICAgICBzdHJpbmcgaXMgdmFsaWQgaW4gdGhlIHNwZWNpZmllZCBlbmNvZGluZy4gIElmIGl0J3MgaW1wb3J0YW50IHRoYXQgdGhlCiAgICAgICAgYnl0ZSBzdHJpbmcgaXMgaW4gdGhlIHNwZWNpZmllZCBlbmNvZGluZyBkbzo6CgogICAgICAgICAgICBlbmNvZGVkX3N0cmluZyA9IHRvX2J5dGVzKHRvX3RleHQoaW5wdXRfc3RyaW5nLCAnbGF0aW4tMScpLCAndXRmLTgnKQoKICAgIC4uIHZlcnNpb25fY2hhbmdlZDo6IDIuMwoKICAgICAgICBBZGRlZCB0aGUgYGBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlYGAgZXJyb3IgaGFuZGxlciBhbmQgbWFkZSBpdCB0aGUgZGVmYXVsdCBlcnJvciBoYW5kbGVyLgogICAgIiIiCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgYmluYXJ5X3R5cGUpOgogICAgICAgIHJldHVybiBvYmoKCiAgICAjIFdlJ3JlIGdpdmVuIGEgdGV4dCBzdHJpbmcKICAgICMgSWYgaXQgaGFzIHN1cnJvZ2F0ZXMsIHdlIGtub3cgYmVjYXVzZSBpdCB3aWxsIGRlY29kZQogICAgb3JpZ2luYWxfZXJyb3JzID0gZXJyb3JzCiAgICBpZiBlcnJvcnMgaW4gX0NPTVBPU0VEX0VSUk9SX0hBTkRMRVJTOgogICAgICAgIGlmIEhBU19TVVJST0dBVEVFU0NBUEU6CiAgICAgICAgICAgIGVycm9ycyA9ICdzdXJyb2dhdGVlc2NhcGUnCiAgICAgICAgZWxpZiBlcnJvcnMgPT0gJ3N1cnJvZ2F0ZV9vcl9zdHJpY3QnOgogICAgICAgICAgICBlcnJvcnMgPSAnc3RyaWN0JwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVycm9ycyA9ICdyZXBsYWNlJwoKICAgIGlmIGlzaW5zdGFuY2Uob2JqLCB0ZXh0X3R5cGUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBUcnkgdGhpcyBmaXJzdCBhcyBpdCdzIHRoZSBmYXN0ZXN0CiAgICAgICAgICAgIHJldHVybiBvYmouZW5jb2RlKGVuY29kaW5nLCBlcnJvcnMpCiAgICAgICAgZXhjZXB0IFVuaWNvZGVFbmNvZGVFcnJvcjoKICAgICAgICAgICAgaWYgb3JpZ2luYWxfZXJyb3JzIGluIChOb25lLCAnc3Vycm9nYXRlX3RoZW5fcmVwbGFjZScpOgogICAgICAgICAgICAgICAgIyBTbG93IGJ1dCB3b3JrcwogICAgICAgICAgICAgICAgcmV0dXJuX3N0cmluZyA9IG9iai5lbmNvZGUoJ3V0Zi04JywgJ3N1cnJvZ2F0ZWVzY2FwZScpCiAgICAgICAgICAgICAgICByZXR1cm5fc3RyaW5nID0gcmV0dXJuX3N0cmluZy5kZWNvZGUoJ3V0Zi04JywgJ3JlcGxhY2UnKQogICAgICAgICAgICAgICAgcmV0dXJuIHJldHVybl9zdHJpbmcuZW5jb2RlKGVuY29kaW5nLCAncmVwbGFjZScpCiAgICAgICAgICAgIHJhaXNlCgogICAgIyBOb3RlOiBXZSBkbyB0aGVzZSBsYXN0IGV2ZW4gdGhvdWdoIHdlIGhhdmUgdG8gY2FsbCB0b19ieXRlcyBhZ2FpbiBvbiB0aGUKICAgICMgdmFsdWUgYmVjYXVzZSB3ZSdyZSBvcHRpbWl6aW5nIHRoZSBjb21tb24gY2FzZQogICAgaWYgbm9uc3RyaW5nID09ICdzaW1wbGVyZXByJzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHZhbHVlID0gc3RyKG9iaikKICAgICAgICBleGNlcHQgVW5pY29kZUVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlcHIob2JqKQogICAgICAgICAgICBleGNlcHQgVW5pY29kZUVycm9yOgogICAgICAgICAgICAgICAgIyBHaXZpbmcgdXAKICAgICAgICAgICAgICAgIHJldHVybiB0b19ieXRlcygnJykKICAgIGVsaWYgbm9uc3RyaW5nID09ICdwYXNzdGhydSc6CiAgICAgICAgcmV0dXJuIG9iagogICAgZWxpZiBub25zdHJpbmcgPT0gJ2VtcHR5JzoKICAgICAgICAjIHB5dGhvbjIuNCBkb2Vzbid0IGhhdmUgYicnCiAgICAgICAgcmV0dXJuIHRvX2J5dGVzKCcnKQogICAgZWxpZiBub25zdHJpbmcgPT0gJ3N0cmljdCc6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdvYmogbXVzdCBiZSBhIHN0cmluZyB0eXBlJykKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdJbnZhbGlkIHZhbHVlICVzIGZvciB0b19ieXRlc1wnIG5vbnN0cmluZyBwYXJhbWV0ZXInICUgbm9uc3RyaW5nKQoKICAgIHJldHVybiB0b19ieXRlcyh2YWx1ZSwgZW5jb2RpbmcsIGVycm9ycykKCgpkZWYgdG9fdGV4dChvYmosIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz1Ob25lLCBub25zdHJpbmc9J3NpbXBsZXJlcHInKToKICAgICIiIk1ha2Ugc3VyZSB0aGF0IGEgc3RyaW5nIGlzIGEgdGV4dCBzdHJpbmcKCiAgICA6YXJnIG9iajogQW4gb2JqZWN0IHRvIG1ha2Ugc3VyZSBpcyBhIHRleHQgc3RyaW5nLiAgSW4gbW9zdCBjYXNlcyB0aGlzCiAgICAgICAgd2lsbCBiZSBlaXRoZXIgYSB0ZXh0IHN0cmluZyBvciBhIGJ5dGUgc3RyaW5nLiAgSG93ZXZlciwgd2l0aAogICAgICAgIGBgbm9uc3RyaW5nPSdzaW1wbGVyZXByJ2BgLCB0aGlzIGNhbiBiZSB1c2VkIGFzIGEgdHJhY2ViYWNrLWZyZWUKICAgICAgICB2ZXJzaW9uIG9mIGBgc3RyKG9iailgYC4KICAgIDprd2FyZyBlbmNvZGluZzogVGhlIGVuY29kaW5nIHRvIHVzZSB0byB0cmFuc2Zvcm0gZnJvbSBhIGJ5dGUgc3RyaW5nIHRvCiAgICAgICAgYSB0ZXh0IHN0cmluZy4gIERlZmF1bHRzIHRvIHVzaW5nICd1dGYtOCcuCiAgICA6a3dhcmcgZXJyb3JzOiBUaGUgZXJyb3IgaGFuZGxlciB0byB1c2UgaWYgdGhlIGJ5dGUgc3RyaW5nIGlzIG5vdAogICAgICAgIGRlY29kYWJsZSB1c2luZyB0aGUgc3BlY2lmaWVkIGVuY29kaW5nLiAgQW55IHZhbGlkIGBjb2RlY3MgZXJyb3IKICAgICAgICBoYW5kbGVyIDxodHRwczovL2RvY3MucHl0aG9uLm9yZy8yL2xpYnJhcnkvY29kZWNzLmh0bWwjY29kZWMtYmFzZS1jbGFzc2VzPmBfCiAgICAgICAgbWF5IGJlIHNwZWNpZmllZC4gICBXZSBzdXBwb3J0IHRocmVlIGFkZGl0aW9uYWwgZXJyb3Igc3RyYXRlZ2llcwogICAgICAgIHNwZWNpZmljYWxseSBhaW1lZCBhdCBoZWxwaW5nIHBlb3BsZSB0byBwb3J0IGNvZGU6CgogICAgICAgICAgICA6c3Vycm9nYXRlX29yX3N0cmljdDogV2lsbCB1c2Ugc3Vycm9nYXRlZXNjYXBlIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSBzdHJpY3QKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9yZXBsYWNlOiBXaWxsIHVzZSBzdXJyb2dhdGVlc2NhcGUgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlciwgb3RoZXJ3aXNlIGl0IHdpbGwgdXNlIHJlcGxhY2UuCiAgICAgICAgICAgIDpzdXJyb2dhdGVfdGhlbl9yZXBsYWNlOiBEb2VzIHRoZSBzYW1lIGFzIHN1cnJvZ2F0ZV9vcl9yZXBsYWNlIGJ1dAogICAgICAgICAgICAgICAgYHdhcyBhZGRlZCBmb3Igc3ltbWV0cnkgd2l0aCB0aGUgZXJyb3IgaGFuZGxlcnMgaW4KICAgICAgICAgICAgICAgIDpmdW5jOmBhbnNpYmxlLm1vZHVsZV91dGlscy5fdGV4dC50b19ieXRlc2AgKEFkZGVkIGluIEFuc2libGUgMi4zKQoKICAgICAgICBCZWNhdXNlIHN1cnJvZ2F0ZWVzY2FwZSB3YXMgYWRkZWQgaW4gUHl0aG9uMyB0aGlzIHVzdWFsbHkgbWVhbnMgdGhhdAogICAgICAgIFB5dGhvbjMgd2lsbCB1c2UgYHN1cnJvZ2F0ZWVzY2FwZWAgYW5kIFB5dGhvbjIgd2lsbCB1c2UgdGhlIGZhbGxiYWNrCiAgICAgICAgZXJyb3IgaGFuZGxlci4gTm90ZSB0aGF0IHRoZSBjb2RlIGNoZWNrcyBmb3Igc3Vycm9nYXRlZXNjYXBlIHdoZW4gdGhlCiAgICAgICAgbW9kdWxlIGlzIGltcG9ydGVkLiAgSWYgeW91IGhhdmUgYSBiYWNrcG9ydCBvZiBgc3Vycm9nYXRlZXNjYXBlYCBmb3IKICAgICAgICBweXRob24yLCBiZSBzdXJlIHRvIHJlZ2lzdGVyIHRoZSBlcnJvciBoYW5kbGVyIHByaW9yIHRvIGltcG9ydGluZyB0aGlzCiAgICAgICAgbW9kdWxlLgoKICAgICAgICBUaGUgZGVmYXVsdCB1bnRpbCBBbnNpYmxlLTIuMiB3YXMgYHN1cnJvZ2F0ZV9vcl9yZXBsYWNlYAogICAgICAgIEluIEFuc2libGUtMi4zIHRoaXMgZGVmYXVsdHMgdG8gYHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2VgIGZvciBzeW1tZXRyeQogICAgICAgIHdpdGggOmZ1bmM6YGFuc2libGUubW9kdWxlX3V0aWxzLl90ZXh0LnRvX2J5dGVzYCAuCiAgICA6a3dhcmcgbm9uc3RyaW5nOiBUaGUgc3RyYXRlZ3kgdG8gdXNlIGlmIGEgbm9uc3RyaW5nIGlzIHNwZWNpZmllZCBpbgogICAgICAgIGBgb2JqYGAuICBEZWZhdWx0IGlzICdzaW1wbGVyZXByJy4gIFZhbGlkIHZhbHVlcyBhcmU6CgogICAgICAgIDpzaW1wbGVyZXByOiBUaGUgZGVmYXVsdC4gIFRoaXMgdGFrZXMgdGhlIGBgc3RyYGAgb2YgdGhlIG9iamVjdCBhbmQKICAgICAgICAgICAgdGhlbiByZXR1cm5zIHRoZSB0ZXh0IHZlcnNpb24gb2YgdGhhdCBzdHJpbmcuCiAgICAgICAgOmVtcHR5OiBSZXR1cm4gYW4gZW1wdHkgdGV4dCBzdHJpbmcKICAgICAgICA6cGFzc3RocnU6IFJldHVybiB0aGUgb2JqZWN0IHBhc3NlZCBpbgogICAgICAgIDpzdHJpY3Q6IFJhaXNlIGEgOmV4YzpgVHlwZUVycm9yYAoKICAgIDpyZXR1cm5zOiBUeXBpY2FsbHkgdGhpcyByZXR1cm5zIGEgdGV4dCBzdHJpbmcuICBJZiBhIG5vbnN0cmluZyBvYmplY3QgaXMKICAgICAgICBwYXNzZWQgaW4gdGhpcyBtYXkgYmUgYSBkaWZmZXJlbnQgdHlwZSBkZXBlbmRpbmcgb24gdGhlIHN0cmF0ZWd5CiAgICAgICAgc3BlY2lmaWVkIGJ5IG5vbnN0cmluZy4gIFRoaXMgd2lsbCBuZXZlciByZXR1cm4gYSBieXRlIHN0cmluZy4KICAgICAgICBGcm9tIEFuc2libGUtMi4zIG9ud2FyZHMsIHRoZSBkZWZhdWx0IGlzIGBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlYC4KCiAgICAuLiB2ZXJzaW9uX2NoYW5nZWQ6OiAyLjMKCiAgICAgICAgQWRkZWQgdGhlIHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2UgZXJyb3IgaGFuZGxlciBhbmQgbWFkZSBpdCB0aGUgZGVmYXVsdCBlcnJvciBoYW5kbGVyLgogICAgIiIiCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgdGV4dF90eXBlKToKICAgICAgICByZXR1cm4gb2JqCgogICAgaWYgZXJyb3JzIGluIF9DT01QT1NFRF9FUlJPUl9IQU5ETEVSUzoKICAgICAgICBpZiBIQVNfU1VSUk9HQVRFRVNDQVBFOgogICAgICAgICAgICBlcnJvcnMgPSAnc3Vycm9nYXRlZXNjYXBlJwogICAgICAgIGVsaWYgZXJyb3JzID09ICdzdXJyb2dhdGVfb3Jfc3RyaWN0JzoKICAgICAgICAgICAgZXJyb3JzID0gJ3N0cmljdCcKICAgICAgICBlbHNlOgogICAgICAgICAgICBlcnJvcnMgPSAncmVwbGFjZScKCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgYmluYXJ5X3R5cGUpOgogICAgICAgICMgTm90ZTogV2UgZG9uJ3QgbmVlZCBzcGVjaWFsIGhhbmRsaW5nIGZvciBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlCiAgICAgICAgIyBiZWNhdXNlIGFsbCBieXRlcyB3aWxsIGVpdGhlciBiZSBtYWRlIGludG8gc3Vycm9nYXRlcyBvciBhcmUgdmFsaWQKICAgICAgICAjIHRvIGRlY29kZS4KICAgICAgICByZXR1cm4gb2JqLmRlY29kZShlbmNvZGluZywgZXJyb3JzKQoKICAgICMgTm90ZTogV2UgZG8gdGhlc2UgbGFzdCBldmVuIHRob3VnaCB3ZSBoYXZlIHRvIGNhbGwgdG9fdGV4dCBhZ2FpbiBvbiB0aGUKICAgICMgdmFsdWUgYmVjYXVzZSB3ZSdyZSBvcHRpbWl6aW5nIHRoZSBjb21tb24gY2FzZQogICAgaWYgbm9uc3RyaW5nID09ICdzaW1wbGVyZXByJzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHZhbHVlID0gc3RyKG9iaikKICAgICAgICBleGNlcHQgVW5pY29kZUVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlcHIob2JqKQogICAgICAgICAgICBleGNlcHQgVW5pY29kZUVycm9yOgogICAgICAgICAgICAgICAgIyBHaXZpbmcgdXAKICAgICAgICAgICAgICAgIHJldHVybiB1JycKICAgIGVsaWYgbm9uc3RyaW5nID09ICdwYXNzdGhydSc6CiAgICAgICAgcmV0dXJuIG9iagogICAgZWxpZiBub25zdHJpbmcgPT0gJ2VtcHR5JzoKICAgICAgICByZXR1cm4gdScnCiAgICBlbGlmIG5vbnN0cmluZyA9PSAnc3RyaWN0JzoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ29iaiBtdXN0IGJlIGEgc3RyaW5nIHR5cGUnKQogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ0ludmFsaWQgdmFsdWUgJXMgZm9yIHRvX3RleHRcJ3Mgbm9uc3RyaW5nIHBhcmFtZXRlcicgJSBub25zdHJpbmcpCgogICAgcmV0dXJuIHRvX3RleHQodmFsdWUsIGVuY29kaW5nLCBlcnJvcnMpCgoKIzogOnB5OmZ1bmM6YHRvX25hdGl2ZWAKIzogICAgICBUcmFuc2Zvcm0gYSB2YXJpYWJsZSBpbnRvIHRoZSBuYXRpdmUgc3RyIHR5cGUgZm9yIHRoZSBweXRob24gdmVyc2lvbgojOgojOiAgICAgIE9uIFB5dGhvbjIsIHRoaXMgaXMgYW4gYWxpYXMgZm9yCiM6ICAgICAgOmZ1bmM6YH5hbnNpYmxlLm1vZHVsZV91dGlscy50b19ieXRlc2AuICBPbiBQeXRob24zIGl0IGlzIGFuIGFsaWFzIGZvcgojOiAgICAgIDpmdW5jOmB+YW5zaWJsZS5tb2R1bGVfdXRpbHMudG9fdGV4dGAuICBJdCBtYWtlcyBpdCBlYXNpZXIgdG8KIzogICAgICB0cmFuc2Zvcm0gYSB2YXJpYWJsZSBpbnRvIHRoZSBuYXRpdmUgc3RyIHR5cGUgZm9yIHRoZSBweXRob24gdmVyc2lvbgojOiAgICAgIHRoZSBjb2RlIGlzIHJ1bm5pbmcgb24uICBVc2UgdGhpcyB3aGVuIGNvbnN0cnVjdGluZyB0aGUgbWVzc2FnZSB0bwojOiAgICAgIHNlbmQgdG8gZXhjZXB0aW9ucyBvciB3aGVuIGRlYWxpbmcgd2l0aCBhbiBBUEkgdGhhdCBuZWVkcyB0byB0YWtlCiM6ICAgICAgYSBuYXRpdmUgc3RyaW5nLiAgRXhhbXBsZTo6CiM6CiM6ICAgICAgICAgIHRyeToKIzogICAgICAgICAgICAgIDEvLzAKIzogICAgICAgICAgZXhjZXB0IFplcm9EaXZpc2lvbkVycm9yIGFzIGU6CiM6ICAgICAgICAgICAgICByYWlzZSBNeUV4Y2VwdGlvbignRW5jb3VudGVyZWQgYW5kIGVycm9yOiAlcycgJSB0b19uYXRpdmUoZSkpCmlmIFBZMzoKICAgIHRvX25hdGl2ZSA9IHRvX3RleHQKZWxzZToKICAgIHRvX25hdGl2ZSA9IHRvX2J5dGVzClBLAwQUAAAAAADUuytLJdy0fhMQAAATEAAAIgAAAGFuc2libGUvbW9kdWxlX3V0aWxzL3B5Y29tcGF0MjQucHkjIFRoaXMgY29kZSBpcyBwYXJ0IG9mIEFuc2libGUsIGJ1dCBpcyBhbiBpbmRlcGVuZGVudCBjb21wb25lbnQuCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBUb3NoaW8gS3VyYXRvbWkgPHRrdXJhdG9taUBhbnNpYmxlLmNvbT4KIyBDb3B5cmlnaHQgKGMpIDIwMTUsIE1hcml1cyBHZWRtaW5hcwojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwKIyBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiMgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICAgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICAgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKIyBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAojIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4KIyBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwKIyBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sCiMgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCiMgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVAojIExJQUJJTElUWSwgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRQojIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCgppbXBvcnQgc3lzCgpkZWYgZ2V0X2V4Y2VwdGlvbigpOgogICAgIiIiR2V0IHRoZSBjdXJyZW50IGV4Y2VwdGlvbi4KCiAgICBUaGlzIGNvZGUgbmVlZHMgdG8gd29yayBvbiBQeXRob24gMi40IHRocm91Z2ggMy54LCBzbyB3ZSBjYW5ub3QgdXNlCiAgICAiZXhjZXB0IEV4Y2VwdGlvbiwgZToiIChTeW50YXhFcnJvciBvbiBQeXRob24gMy54KSBub3IKICAgICJleGNlcHQgRXhjZXB0aW9uIGFzIGU6IiAoU3ludGF4RXJyb3Igb24gUHl0aG9uIDIuNC0yLjUpLgogICAgSW5zdGVhZCB3ZSBtdXN0IHVzZSA6OgoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCgogICAgIiIiCiAgICByZXR1cm4gc3lzLmV4Y19pbmZvKClbMV0KCnRyeToKICAgICMgUHl0aG9uIDIuNisKICAgIGZyb20gYXN0IGltcG9ydCBsaXRlcmFsX2V2YWwKZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyBhIHJlcGxhY2VtZW50IGZvciBsaXRlcmFsX2V2YWwgdGhhdCB3b3JrcyB3aXRoIHB5dGhvbiAyLjQuIGZyb206CiAgICAjIGh0dHBzOi8vbWFpbC5weXRob24ub3JnL3BpcGVybWFpbC9weXRob24tbGlzdC8yMDA5LVNlcHRlbWJlci81NTE4ODAuaHRtbAogICAgIyB3aGljaCBpcyBlc3NlbnRpYWxseSBhIGN1dC9wYXN0ZSBmcm9tIGFuIGVhcmxpZXIgKDIuNikgdmVyc2lvbiBvZiBweXRob24ncwogICAgIyBhc3QucHkKICAgIGZyb20gY29tcGlsZXIgaW1wb3J0IGFzdCwgcGFyc2UKICAgIGZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGltcG9ydCBiaW5hcnlfdHlwZSwgc3RyaW5nX3R5cGVzLCB0ZXh0X3R5cGUKCiAgICBkZWYgbGl0ZXJhbF9ldmFsKG5vZGVfb3Jfc3RyaW5nKToKICAgICAgICAiIiIKICAgICAgICBTYWZlbHkgZXZhbHVhdGUgYW4gZXhwcmVzc2lvbiBub2RlIG9yIGEgc3RyaW5nIGNvbnRhaW5pbmcgYSBQeXRob24KICAgICAgICBleHByZXNzaW9uLiAgVGhlIHN0cmluZyBvciBub2RlIHByb3ZpZGVkIG1heSBvbmx5IGNvbnNpc3Qgb2YgdGhlICBmb2xsb3dpbmcKICAgICAgICBQeXRob24gbGl0ZXJhbCBzdHJ1Y3R1cmVzOiBzdHJpbmdzLCBudW1iZXJzLCB0dXBsZXMsIGxpc3RzLCBkaWN0cywgIGJvb2xlYW5zLAogICAgICAgIGFuZCBOb25lLgogICAgICAgICIiIgogICAgICAgIF9zYWZlX25hbWVzID0geydOb25lJzogTm9uZSwgJ1RydWUnOiBUcnVlLCAnRmFsc2UnOiBGYWxzZX0KICAgICAgICBpZiBpc2luc3RhbmNlKG5vZGVfb3Jfc3RyaW5nLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBub2RlX29yX3N0cmluZyA9IHBhcnNlKG5vZGVfb3Jfc3RyaW5nLCBtb2RlPSdldmFsJykKICAgICAgICBpZiBpc2luc3RhbmNlKG5vZGVfb3Jfc3RyaW5nLCBhc3QuRXhwcmVzc2lvbik6CiAgICAgICAgICAgIG5vZGVfb3Jfc3RyaW5nID0gbm9kZV9vcl9zdHJpbmcubm9kZQoKICAgICAgICBkZWYgX2NvbnZlcnQobm9kZSk6CiAgICAgICAgICAgICMgT2theSB0byB1c2UgbG9uZyBoZXJlIGJlY2F1c2UgdGhpcyBpcyBvbmx5IGZvciBweXRob24gMi40IGFuZCAyLjUKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuQ29uc3QpIGFuZCBpc2luc3RhbmNlKG5vZGUudmFsdWUsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlLCBpbnQsIGZsb2F0LCBsb25nLCBjb21wbGV4KSk6CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0LlR1cGxlKToKICAgICAgICAgICAgICAgIHJldHVybiB0dXBsZShtYXAoX2NvbnZlcnQsIG5vZGUubm9kZXMpKQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0Lkxpc3QpOgogICAgICAgICAgICAgICAgcmV0dXJuIGxpc3QobWFwKF9jb252ZXJ0LCBub2RlLm5vZGVzKSkKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5EaWN0KToKICAgICAgICAgICAgICAgIHJldHVybiBkaWN0KChfY29udmVydChrKSwgX2NvbnZlcnQodikpIGZvciBrLCB2IGluIG5vZGUuaXRlbXMoKSkKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5OYW1lKToKICAgICAgICAgICAgICAgIGlmIG5vZGUubmFtZSBpbiBfc2FmZV9uYW1lczoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3NhZmVfbmFtZXNbbm9kZS5uYW1lXQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0LlVuYXJ5U3ViKToKICAgICAgICAgICAgICAgIHJldHVybiAtX2NvbnZlcnQobm9kZS5leHByKQogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdtYWxmb3JtZWQgc3RyaW5nJykKICAgICAgICByZXR1cm4gX2NvbnZlcnQobm9kZV9vcl9zdHJpbmcpCgpfX2FsbF9fID0gKCdnZXRfZXhjZXB0aW9uJywgJ2xpdGVyYWxfZXZhbCcpClBLAwQUAAAAAADUuytLGBdy9QERAAABEQAAJAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fX2luaXRfXy5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpIDIwMTcsIFRvc2hpbyBLdXJhdG9taSA8dGt1cmF0b21pQGFuc2libGUuY29tPgojCiMgVGhpcyBjb2RlIGlzIGJhc2VkIG9uIGNvZGUgZnJvbSBBc3Ryb3B5IGFuZCByZXRhaW5zIHRoZWlyIDMtY2xhdXNlIEJTRCBsaWNlbnNlCiMgcmVwcm9kdWNlZCBiZWxvdzoKIwojIENvcHlyaWdodCAoYykgMjAxMS0yMDE2LCBBc3Ryb3B5IERldmVsb3BlcnMKIwojIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiMKIyBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQKIyBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKIwojICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLCB0aGlzCiMgICBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KIyAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwKIyAgIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24KIyAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgojICogTmVpdGhlciB0aGUgbmFtZSBvZiB0aGUgQXN0cm9weSBUZWFtIG5vciB0aGUgbmFtZXMgb2YgaXRzIGNvbnRyaWJ1dG9ycyBtYXkKIyAgIGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzIGRlcml2ZWQgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQKIyAgIHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIgojIEFORCBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUKIyBJTVBMSUVEIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUKIyBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFCiMgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwKIyBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUgojIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSCiMgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwKIyBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRQojIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiMKIyBBc3Ryb3B5IExpY2Vuc2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9hc3Ryb3B5L2FzdHJvcHkvYmxvYi9jZjMyNjVlNDJhMGRiOGUwMGJiOTA2NDRkYjM3YzgxNTBmNWFjMDBjL2xpY2Vuc2VzL0xJQ0VOU0UucnN0CiMgQXN0cm9weSBDb2RlOiBodHRwczovL2dpdGh1Yi5jb20vYXN0cm9weS9hc3Ryb3B5L2Jsb2IvY2YzMjY1ZTQyYTBkYjhlMDBiYjkwNjQ0ZGIzN2M4MTUwZjVhYzAwYy9hc3Ryb3B5L2V4dGVybi9zaXgucHkKCiIiIgpIYW5kbGUgbG9hZGluZyBzaXggcGFja2FnZSBmcm9tIHN5c3RlbSBvciBmcm9tIHRoZSBidW5kbGVkIGNvcHkKIiIiCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgYWJzb2x1dGVfaW1wb3J0CgppbXBvcnQgaW1wIGFzIF9pbXAKaW1wb3J0IHN5cyBhcyBfc3lzCgp0cnk6CiAgICBmcm9tIGRpc3R1dGlscy52ZXJzaW9uIGltcG9ydCBMb29zZVZlcnNpb24gYXMgX0xvb3NlVmVyc2lvbgpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAjIFNvbWUgcGxhdGZvcm1zICpjb3VnaCpTb2xhcmlzKmNvdWdoKiBkb24ndCBzaGlwIHRoZSB3aG9sZSBzdGRsaWIKICAgIF9Mb29zZVZlcnNpb24gPSBOb25lCgp0cnk6CiAgICBpbXBvcnQgc2l4IGFzIF9zeXN0ZW1fc2l4CmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIF9zeXN0ZW1fc2l4ID0gTm9uZQoKZnJvbSAuIGltcG9ydCBfc2l4IGFzIF9idW5kbGVkX3NpeAoKCmRlZiBfZmluZF9tb2R1bGUobmFtZSwgcGF0aD1Ob25lKToKICAgICIiIkFsdGVybmF0aXZlIHRvIGBpbXAuZmluZF9tb2R1bGVgIHRoYXQgY2FuIGFsc28gc2VhcmNoIGluIHN1YnBhY2thZ2VzIiIiCiAgICBwYXJ0cyA9IG5hbWUuc3BsaXQoJy4nKQoKICAgIGZvciBwYXJ0IGluIHBhcnRzOgogICAgICAgIGlmIHBhdGggaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHBhdGggPSBbcGF0aF0KICAgICAgICBmaCwgcGF0aCwgZGVzY3IgPSBfaW1wLmZpbmRfbW9kdWxlKHBhcnQsIHBhdGgpCiAgICByZXR1cm4gZmgsIHBhdGgsIGRlc2NyCgoKZGVmIF9nZXRfYnVuZGxlZF9zaXhfc291cmNlKCk6CiAgICAjIFNwZWNpYWwgaW1wb3J0IGxvYWRlciAoemlwaW1wb3J0IGZvciBpbnN0YW5jZSkKICAgIGZvdW5kID0gRmFsc2UKICAgIGZvciBwYXRoIGluIF9zeXMucGF0aDoKICAgICAgICBpbXBvcnRlciA9IF9zeXMucGF0aF9pbXBvcnRlcl9jYWNoZS5nZXQocGF0aCkKICAgICAgICBpZiBpbXBvcnRlcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZm91bmQgPSBpbXBvcnRlci5maW5kX21vZHVsZSgnYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19zaXgnKQogICAgICAgICAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBmb3VuZDoKICAgICAgICAgICAgICAgIGJyZWFrCiAgICBlbHNlOgogICAgICAgIHJhaXNlIEltcG9ydEVycm9yKCJDb3VsZCBub3QgZmluZCBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXguX3NpeCIpCgogICAgbW9kdWxlX3NvdXJjZSA9IGltcG9ydGVyLmdldF9zb3VyY2UoJ2Fuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fc2l4JykKICAgIHJldHVybiBtb2R1bGVfc291cmNlCgoKZGVmIF9nZXRfc2l4X3NvdXJjZSgpOgogICAgIiIiSW1wb3J0IHRoZSBuZXdlc3QgdmVyc2lvbiBvZiB0aGUgc2l4IGxpYnJhcnkgdGhhdCdzIGF2YWlsYWJsZSIiIgogICAgbW9kX2luZm8gPSBOb25lCiAgICB0cnk6CiAgICAgICAgaWYgX3N5c3RlbV9zaXggYW5kIF9Mb29zZVZlcnNpb24gYW5kIFwKICAgICAgICAgICAgICAgIF9Mb29zZVZlcnNpb24oX3N5c3RlbV9zaXguX192ZXJzaW9uX18pID49IF9Mb29zZVZlcnNpb24oX2J1bmRsZWRfc2l4Ll9fdmVyc2lvbl9fKToKICAgICAgICAgICAgbW9kX2luZm8gPSBfZmluZF9tb2R1bGUoJ3NpeCcpCiAgICBleGNlcHQ6CiAgICAgICAgIyBBbnkgZXJyb3JzIGZpbmRpbmcgdGhlIHN5c3RlbSBsaWJyYXJ5LCB1c2Ugb3VyIGJ1bmRsZWQgbGliIGluc3RlYWQKICAgICAgICBwYXNzCgogICAgaWYgbm90IG1vZF9pbmZvOgogICAgICAgIHRyeToKICAgICAgICAgICAgbW9kX2luZm8gPSBfZmluZF9tb2R1bGUoJ2Fuc2libGUubW9kdWxlX3V0aWxzLnNpeC5fc2l4JykKICAgICAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgICAgICMgemlwaW1wb3J0CiAgICAgICAgICAgIG1vZHVsZV9zb3VyY2UgPSBfZ2V0X2J1bmRsZWRfc2l4X3NvdXJjZSgpCiAgICAgICAgICAgIHJldHVybiBtb2R1bGVfc291cmNlCgogICAgcmV0dXJuIG1vZF9pbmZvWzBdLnJlYWQoKQoKc291cmNlID0gX2dldF9zaXhfc291cmNlKCkKZXhlYyhzb3VyY2UpClBLAwQUAAAAAADUuytLOOLH0ZF1AACRdQAAIAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fc2l4LnB5IiIiVXRpbGl0aWVzIGZvciB3cml0aW5nIGNvZGUgdGhhdCBydW5zIG9uIFB5dGhvbiAyIGFuZCAzIiIiCgojIENvcHlyaWdodCAoYykgMjAxMC0yMDE1IEJlbmphbWluIFBldGVyc29uCiMKIyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiMgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKIyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAojIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwojIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiMKIyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGwKIyBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgojCiMgVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKIyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKIyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKIyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiMgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKIyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRQojIFNPRlRXQVJFLgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCBhYnNvbHV0ZV9pbXBvcnQKCmltcG9ydCBmdW5jdG9vbHMKaW1wb3J0IGl0ZXJ0b29scwppbXBvcnQgb3BlcmF0b3IKaW1wb3J0IHN5cwppbXBvcnQgdHlwZXMKCl9fYXV0aG9yX18gPSAiQmVuamFtaW4gUGV0ZXJzb24gPGJlbmphbWluQHB5dGhvbi5vcmc+IgpfX3ZlcnNpb25fXyA9ICIxLjEwLjAiCgoKIyBVc2VmdWwgZm9yIHZlcnkgY29hcnNlIHZlcnNpb24gZGlmZmVyZW50aWF0aW9uLgpQWTIgPSBzeXMudmVyc2lvbl9pbmZvWzBdID09IDIKUFkzID0gc3lzLnZlcnNpb25faW5mb1swXSA9PSAzClBZMzQgPSBzeXMudmVyc2lvbl9pbmZvWzA6Ml0gPj0gKDMsIDQpCgppZiBQWTM6CiAgICBzdHJpbmdfdHlwZXMgPSBzdHIsCiAgICBpbnRlZ2VyX3R5cGVzID0gaW50LAogICAgY2xhc3NfdHlwZXMgPSB0eXBlLAogICAgdGV4dF90eXBlID0gc3RyCiAgICBiaW5hcnlfdHlwZSA9IGJ5dGVzCiAgICBNQVhTSVpFID0gc3lzLm1heHNpemUKZWxzZToKICAgIHN0cmluZ190eXBlcyA9IGJhc2VzdHJpbmcsCiAgICBpbnRlZ2VyX3R5cGVzID0gKGludCwgbG9uZykKICAgIGNsYXNzX3R5cGVzID0gKHR5cGUsIHR5cGVzLkNsYXNzVHlwZSkKICAgIHRleHRfdHlwZSA9IHVuaWNvZGUKICAgIGJpbmFyeV90eXBlID0gc3RyCgogICAgaWYgc3lzLnBsYXRmb3JtLnN0YXJ0c3dpdGgoImphdmEiKToKICAgICAgICAjIEp5dGhvbiBhbHdheXMgdXNlcyAzMiBiaXRzLgogICAgICAgIE1BWFNJWkUgPSBpbnQoKDEgPDwgMzEpIC0gMSkKICAgIGVsc2U6CiAgICAgICAgIyBJdCdzIHBvc3NpYmxlIHRvIGhhdmUgc2l6ZW9mKGxvbmcpICE9IHNpemVvZihQeV9zc2l6ZV90KS4KICAgICAgICBjbGFzcyBYKG9iamVjdCk6CgogICAgICAgICAgICBkZWYgX19sZW5fXyhzZWxmKToKICAgICAgICAgICAgICAgIHJldHVybiAxIDw8IDMxCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsZW4oWCgpKQogICAgICAgIGV4Y2VwdCBPdmVyZmxvd0Vycm9yOgogICAgICAgICAgICAjIDMyLWJpdAogICAgICAgICAgICBNQVhTSVpFID0gaW50KCgxIDw8IDMxKSAtIDEpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyA2NC1iaXQKICAgICAgICAgICAgTUFYU0laRSA9IGludCgoMSA8PCA2MykgLSAxKQogICAgICAgIGRlbCBYCgoKZGVmIF9hZGRfZG9jKGZ1bmMsIGRvYyk6CiAgICAiIiJBZGQgZG9jdW1lbnRhdGlvbiB0byBhIGZ1bmN0aW9uLiIiIgogICAgZnVuYy5fX2RvY19fID0gZG9jCgoKZGVmIF9pbXBvcnRfbW9kdWxlKG5hbWUpOgogICAgIiIiSW1wb3J0IG1vZHVsZSwgcmV0dXJuaW5nIHRoZSBtb2R1bGUgYWZ0ZXIgdGhlIGxhc3QgZG90LiIiIgogICAgX19pbXBvcnRfXyhuYW1lKQogICAgcmV0dXJuIHN5cy5tb2R1bGVzW25hbWVdCgoKY2xhc3MgX0xhenlEZXNjcihvYmplY3QpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuYW1lKToKICAgICAgICBzZWxmLm5hbWUgPSBuYW1lCgogICAgZGVmIF9fZ2V0X18oc2VsZiwgb2JqLCB0cCk6CiAgICAgICAgcmVzdWx0ID0gc2VsZi5fcmVzb2x2ZSgpCiAgICAgICAgc2V0YXR0cihvYmosIHNlbGYubmFtZSwgcmVzdWx0KSAgIyBJbnZva2VzIF9fc2V0X18uCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFRoaXMgaXMgYSBiaXQgdWdseSwgYnV0IGl0IGF2b2lkcyBydW5uaW5nIHRoaXMgYWdhaW4gYnkKICAgICAgICAgICAgIyByZW1vdmluZyB0aGlzIGRlc2NyaXB0b3IuCiAgICAgICAgICAgIGRlbGF0dHIob2JqLl9fY2xhc3NfXywgc2VsZi5uYW1lKQogICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiByZXN1bHQKCgpjbGFzcyBNb3ZlZE1vZHVsZShfTGF6eURlc2NyKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSwgb2xkLCBuZXc9Tm9uZSk6CiAgICAgICAgc3VwZXIoTW92ZWRNb2R1bGUsIHNlbGYpLl9faW5pdF9fKG5hbWUpCiAgICAgICAgaWYgUFkzOgogICAgICAgICAgICBpZiBuZXcgaXMgTm9uZToKICAgICAgICAgICAgICAgIG5ldyA9IG5hbWUKICAgICAgICAgICAgc2VsZi5tb2QgPSBuZXcKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLm1vZCA9IG9sZAoKICAgIGRlZiBfcmVzb2x2ZShzZWxmKToKICAgICAgICByZXR1cm4gX2ltcG9ydF9tb2R1bGUoc2VsZi5tb2QpCgogICAgZGVmIF9fZ2V0YXR0cl9fKHNlbGYsIGF0dHIpOgogICAgICAgIF9tb2R1bGUgPSBzZWxmLl9yZXNvbHZlKCkKICAgICAgICB2YWx1ZSA9IGdldGF0dHIoX21vZHVsZSwgYXR0cikKICAgICAgICBzZXRhdHRyKHNlbGYsIGF0dHIsIHZhbHVlKQogICAgICAgIHJldHVybiB2YWx1ZQoKCmNsYXNzIF9MYXp5TW9kdWxlKHR5cGVzLk1vZHVsZVR5cGUpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuYW1lKToKICAgICAgICBzdXBlcihfTGF6eU1vZHVsZSwgc2VsZikuX19pbml0X18obmFtZSkKICAgICAgICBzZWxmLl9fZG9jX18gPSBzZWxmLl9fY2xhc3NfXy5fX2RvY19fCgogICAgZGVmIF9fZGlyX18oc2VsZik6CiAgICAgICAgYXR0cnMgPSBbIl9fZG9jX18iLCAiX19uYW1lX18iXQogICAgICAgIGF0dHJzICs9IFthdHRyLm5hbWUgZm9yIGF0dHIgaW4gc2VsZi5fbW92ZWRfYXR0cmlidXRlc10KICAgICAgICByZXR1cm4gYXR0cnMKCiAgICAjIFN1YmNsYXNzZXMgc2hvdWxkIG92ZXJyaWRlIHRoaXMKICAgIF9tb3ZlZF9hdHRyaWJ1dGVzID0gW10KCgpjbGFzcyBNb3ZlZEF0dHJpYnV0ZShfTGF6eURlc2NyKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSwgb2xkX21vZCwgbmV3X21vZCwgb2xkX2F0dHI9Tm9uZSwgbmV3X2F0dHI9Tm9uZSk6CiAgICAgICAgc3VwZXIoTW92ZWRBdHRyaWJ1dGUsIHNlbGYpLl9faW5pdF9fKG5hbWUpCiAgICAgICAgaWYgUFkzOgogICAgICAgICAgICBpZiBuZXdfbW9kIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBuZXdfbW9kID0gbmFtZQogICAgICAgICAgICBzZWxmLm1vZCA9IG5ld19tb2QKICAgICAgICAgICAgaWYgbmV3X2F0dHIgaXMgTm9uZToKICAgICAgICAgICAgICAgIGlmIG9sZF9hdHRyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgbmV3X2F0dHIgPSBuYW1lCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIG5ld19hdHRyID0gb2xkX2F0dHIKICAgICAgICAgICAgc2VsZi5hdHRyID0gbmV3X2F0dHIKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLm1vZCA9IG9sZF9tb2QKICAgICAgICAgICAgaWYgb2xkX2F0dHIgaXMgTm9uZToKICAgICAgICAgICAgICAgIG9sZF9hdHRyID0gbmFtZQogICAgICAgICAgICBzZWxmLmF0dHIgPSBvbGRfYXR0cgoKICAgIGRlZiBfcmVzb2x2ZShzZWxmKToKICAgICAgICBtb2R1bGUgPSBfaW1wb3J0X21vZHVsZShzZWxmLm1vZCkKICAgICAgICByZXR1cm4gZ2V0YXR0cihtb2R1bGUsIHNlbGYuYXR0cikKCgpjbGFzcyBfU2l4TWV0YVBhdGhJbXBvcnRlcihvYmplY3QpOgoKICAgICIiIgogICAgQSBtZXRhIHBhdGggaW1wb3J0ZXIgdG8gaW1wb3J0IHNpeC5tb3ZlcyBhbmQgaXRzIHN1Ym1vZHVsZXMuCgogICAgVGhpcyBjbGFzcyBpbXBsZW1lbnRzIGEgUEVQMzAyIGZpbmRlciBhbmQgbG9hZGVyLiBJdCBzaG91bGQgYmUgY29tcGF0aWJsZQogICAgd2l0aCBQeXRob24gMi41IGFuZCBhbGwgZXhpc3RpbmcgdmVyc2lvbnMgb2YgUHl0aG9uMwogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHNpeF9tb2R1bGVfbmFtZSk6CiAgICAgICAgc2VsZi5uYW1lID0gc2l4X21vZHVsZV9uYW1lCiAgICAgICAgc2VsZi5rbm93bl9tb2R1bGVzID0ge30KCiAgICBkZWYgX2FkZF9tb2R1bGUoc2VsZiwgbW9kLCAqZnVsbG5hbWVzKToKICAgICAgICBmb3IgZnVsbG5hbWUgaW4gZnVsbG5hbWVzOgogICAgICAgICAgICBzZWxmLmtub3duX21vZHVsZXNbc2VsZi5uYW1lICsgIi4iICsgZnVsbG5hbWVdID0gbW9kCgogICAgZGVmIF9nZXRfbW9kdWxlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICByZXR1cm4gc2VsZi5rbm93bl9tb2R1bGVzW3NlbGYubmFtZSArICIuIiArIGZ1bGxuYW1lXQoKICAgIGRlZiBmaW5kX21vZHVsZShzZWxmLCBmdWxsbmFtZSwgcGF0aD1Ob25lKToKICAgICAgICBpZiBmdWxsbmFtZSBpbiBzZWxmLmtub3duX21vZHVsZXM6CiAgICAgICAgICAgIHJldHVybiBzZWxmCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgX19nZXRfbW9kdWxlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmtub3duX21vZHVsZXNbZnVsbG5hbWVdCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigiVGhpcyBsb2FkZXIgZG9lcyBub3Qga25vdyBtb2R1bGUgIiArIGZ1bGxuYW1lKQoKICAgIGRlZiBsb2FkX21vZHVsZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIGluIGNhc2Ugb2YgYSByZWxvYWQKICAgICAgICAgICAgcmV0dXJuIHN5cy5tb2R1bGVzW2Z1bGxuYW1lXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgICAgIG1vZCA9IHNlbGYuX19nZXRfbW9kdWxlKGZ1bGxuYW1lKQogICAgICAgIGlmIGlzaW5zdGFuY2UobW9kLCBNb3ZlZE1vZHVsZSk6CiAgICAgICAgICAgIG1vZCA9IG1vZC5fcmVzb2x2ZSgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbW9kLl9fbG9hZGVyX18gPSBzZWxmCiAgICAgICAgc3lzLm1vZHVsZXNbZnVsbG5hbWVdID0gbW9kCiAgICAgICAgcmV0dXJuIG1vZAoKICAgIGRlZiBpc19wYWNrYWdlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm4gdHJ1ZSwgaWYgdGhlIG5hbWVkIG1vZHVsZSBpcyBhIHBhY2thZ2UuCgogICAgICAgIFdlIG5lZWQgdGhpcyBtZXRob2QgdG8gZ2V0IGNvcnJlY3Qgc3BlYyBvYmplY3RzIHdpdGgKICAgICAgICBQeXRob24gMy40IChzZWUgUEVQNDUxKQogICAgICAgICIiIgogICAgICAgIHJldHVybiBoYXNhdHRyKHNlbGYuX19nZXRfbW9kdWxlKGZ1bGxuYW1lKSwgIl9fcGF0aF9fIikKCiAgICBkZWYgZ2V0X2NvZGUoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgICIiIlJldHVybiBOb25lCgogICAgICAgIFJlcXVpcmVkLCBpZiBpc19wYWNrYWdlIGlzIGltcGxlbWVudGVkIiIiCiAgICAgICAgc2VsZi5fX2dldF9tb2R1bGUoZnVsbG5hbWUpICAjIGV2ZW50dWFsbHkgcmFpc2VzIEltcG9ydEVycm9yCiAgICAgICAgcmV0dXJuIE5vbmUKICAgIGdldF9zb3VyY2UgPSBnZXRfY29kZSAgIyBzYW1lIGFzIGdldF9jb2RlCgpfaW1wb3J0ZXIgPSBfU2l4TWV0YVBhdGhJbXBvcnRlcihfX25hbWVfXykKCgpjbGFzcyBfTW92ZWRJdGVtcyhfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMiIiIKICAgIF9fcGF0aF9fID0gW10gICMgbWFyayBhcyBwYWNrYWdlCgoKX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiY1N0cmluZ0lPIiwgImNTdHJpbmdJTyIsICJpbyIsICJTdHJpbmdJTyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImZpbHRlciIsICJpdGVydG9vbHMiLCAiYnVpbHRpbnMiLCAiaWZpbHRlciIsICJmaWx0ZXIiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJmaWx0ZXJmYWxzZSIsICJpdGVydG9vbHMiLCAiaXRlcnRvb2xzIiwgImlmaWx0ZXJmYWxzZSIsICJmaWx0ZXJmYWxzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImlucHV0IiwgIl9fYnVpbHRpbl9fIiwgImJ1aWx0aW5zIiwgInJhd19pbnB1dCIsICJpbnB1dCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImludGVybiIsICJfX2J1aWx0aW5fXyIsICJzeXMiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJtYXAiLCAiaXRlcnRvb2xzIiwgImJ1aWx0aW5zIiwgImltYXAiLCAibWFwIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZ2V0Y3dkIiwgIm9zIiwgIm9zIiwgImdldGN3ZHUiLCAiZ2V0Y3dkIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZ2V0Y3dkYiIsICJvcyIsICJvcyIsICJnZXRjd2QiLCAiZ2V0Y3dkYiIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInJhbmdlIiwgIl9fYnVpbHRpbl9fIiwgImJ1aWx0aW5zIiwgInhyYW5nZSIsICJyYW5nZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInJlbG9hZF9tb2R1bGUiLCAiX19idWlsdGluX18iLCAiaW1wb3J0bGliIiBpZiBQWTM0IGVsc2UgImltcCIsICJyZWxvYWQiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJyZWR1Y2UiLCAiX19idWlsdGluX18iLCAiZnVuY3Rvb2xzIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgic2hsZXhfcXVvdGUiLCAicGlwZXMiLCAic2hsZXgiLCAicXVvdGUiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJTdHJpbmdJTyIsICJTdHJpbmdJTyIsICJpbyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVzZXJEaWN0IiwgIlVzZXJEaWN0IiwgImNvbGxlY3Rpb25zIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVXNlckxpc3QiLCAiVXNlckxpc3QiLCAiY29sbGVjdGlvbnMiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVc2VyU3RyaW5nIiwgIlVzZXJTdHJpbmciLCAiY29sbGVjdGlvbnMiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ4cmFuZ2UiLCAiX19idWlsdGluX18iLCAiYnVpbHRpbnMiLCAieHJhbmdlIiwgInJhbmdlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiemlwIiwgIml0ZXJ0b29scyIsICJidWlsdGlucyIsICJpemlwIiwgInppcCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInppcF9sb25nZXN0IiwgIml0ZXJ0b29scyIsICJpdGVydG9vbHMiLCAiaXppcF9sb25nZXN0IiwgInppcF9sb25nZXN0IiksCiAgICBNb3ZlZE1vZHVsZSgiYnVpbHRpbnMiLCAiX19idWlsdGluX18iKSwKICAgIE1vdmVkTW9kdWxlKCJjb25maWdwYXJzZXIiLCAiQ29uZmlnUGFyc2VyIiksCiAgICBNb3ZlZE1vZHVsZSgiY29weXJlZyIsICJjb3B5X3JlZyIpLAogICAgTW92ZWRNb2R1bGUoImRibV9nbnUiLCAiZ2RibSIsICJkYm0uZ251IiksCiAgICBNb3ZlZE1vZHVsZSgiX2R1bW15X3RocmVhZCIsICJkdW1teV90aHJlYWQiLCAiX2R1bW15X3RocmVhZCIpLAogICAgTW92ZWRNb2R1bGUoImh0dHBfY29va2llamFyIiwgImNvb2tpZWxpYiIsICJodHRwLmNvb2tpZWphciIpLAogICAgTW92ZWRNb2R1bGUoImh0dHBfY29va2llcyIsICJDb29raWUiLCAiaHR0cC5jb29raWVzIiksCiAgICBNb3ZlZE1vZHVsZSgiaHRtbF9lbnRpdGllcyIsICJodG1sZW50aXR5ZGVmcyIsICJodG1sLmVudGl0aWVzIiksCiAgICBNb3ZlZE1vZHVsZSgiaHRtbF9wYXJzZXIiLCAiSFRNTFBhcnNlciIsICJodG1sLnBhcnNlciIpLAogICAgTW92ZWRNb2R1bGUoImh0dHBfY2xpZW50IiwgImh0dHBsaWIiLCAiaHR0cC5jbGllbnQiKSwKICAgIE1vdmVkTW9kdWxlKCJlbWFpbF9taW1lX211bHRpcGFydCIsICJlbWFpbC5NSU1FTXVsdGlwYXJ0IiwgImVtYWlsLm1pbWUubXVsdGlwYXJ0IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV9ub25tdWx0aXBhcnQiLCAiZW1haWwuTUlNRU5vbk11bHRpcGFydCIsICJlbWFpbC5taW1lLm5vbm11bHRpcGFydCIpLAogICAgTW92ZWRNb2R1bGUoImVtYWlsX21pbWVfdGV4dCIsICJlbWFpbC5NSU1FVGV4dCIsICJlbWFpbC5taW1lLnRleHQiKSwKICAgIE1vdmVkTW9kdWxlKCJlbWFpbF9taW1lX2Jhc2UiLCAiZW1haWwuTUlNRUJhc2UiLCAiZW1haWwubWltZS5iYXNlIiksCiAgICBNb3ZlZE1vZHVsZSgiQmFzZUhUVFBTZXJ2ZXIiLCAiQmFzZUhUVFBTZXJ2ZXIiLCAiaHR0cC5zZXJ2ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJDR0lIVFRQU2VydmVyIiwgIkNHSUhUVFBTZXJ2ZXIiLCAiaHR0cC5zZXJ2ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJTaW1wbGVIVFRQU2VydmVyIiwgIlNpbXBsZUhUVFBTZXJ2ZXIiLCAiaHR0cC5zZXJ2ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJjUGlja2xlIiwgImNQaWNrbGUiLCAicGlja2xlIiksCiAgICBNb3ZlZE1vZHVsZSgicXVldWUiLCAiUXVldWUiKSwKICAgIE1vdmVkTW9kdWxlKCJyZXBybGliIiwgInJlcHIiKSwKICAgIE1vdmVkTW9kdWxlKCJzb2NrZXRzZXJ2ZXIiLCAiU29ja2V0U2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiX3RocmVhZCIsICJ0aHJlYWQiLCAiX3RocmVhZCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXIiLCAiVGtpbnRlciIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZGlhbG9nIiwgIkRpYWxvZyIsICJ0a2ludGVyLmRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZmlsZWRpYWxvZyIsICJGaWxlRGlhbG9nIiwgInRraW50ZXIuZmlsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfc2Nyb2xsZWR0ZXh0IiwgIlNjcm9sbGVkVGV4dCIsICJ0a2ludGVyLnNjcm9sbGVkdGV4dCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfc2ltcGxlZGlhbG9nIiwgIlNpbXBsZURpYWxvZyIsICJ0a2ludGVyLnNpbXBsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfdGl4IiwgIlRpeCIsICJ0a2ludGVyLnRpeCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfdHRrIiwgInR0ayIsICJ0a2ludGVyLnR0ayIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfY29uc3RhbnRzIiwgIlRrY29uc3RhbnRzIiwgInRraW50ZXIuY29uc3RhbnRzIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9kbmQiLCAiVGtkbmQiLCAidGtpbnRlci5kbmQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2NvbG9yY2hvb3NlciIsICJ0a0NvbG9yQ2hvb3NlciIsCiAgICAgICAgICAgICAgICAidGtpbnRlci5jb2xvcmNob29zZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2NvbW1vbmRpYWxvZyIsICJ0a0NvbW1vbkRpYWxvZyIsCiAgICAgICAgICAgICAgICAidGtpbnRlci5jb21tb25kaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3RrZmlsZWRpYWxvZyIsICJ0a0ZpbGVEaWFsb2ciLCAidGtpbnRlci5maWxlZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9mb250IiwgInRrRm9udCIsICJ0a2ludGVyLmZvbnQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX21lc3NhZ2Vib3giLCAidGtNZXNzYWdlQm94IiwgInRraW50ZXIubWVzc2FnZWJveCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfdGtzaW1wbGVkaWFsb2ciLCAidGtTaW1wbGVEaWFsb2ciLAogICAgICAgICAgICAgICAgInRraW50ZXIuc2ltcGxlZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidXJsbGliX3BhcnNlIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYl9wYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkTW9kdWxlKCJ1cmxsaWJfZXJyb3IiLCBfX25hbWVfXyArICIubW92ZXMudXJsbGliX2Vycm9yIiwgInVybGxpYi5lcnJvciIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYiIsIF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIiLCBfX25hbWVfXyArICIubW92ZXMudXJsbGliIiksCiAgICBNb3ZlZE1vZHVsZSgidXJsbGliX3JvYm90cGFyc2VyIiwgInJvYm90cGFyc2VyIiwgInVybGxpYi5yb2JvdHBhcnNlciIpLAogICAgTW92ZWRNb2R1bGUoInhtbHJwY19jbGllbnQiLCAieG1scnBjbGliIiwgInhtbHJwYy5jbGllbnQiKSwKICAgIE1vdmVkTW9kdWxlKCJ4bWxycGNfc2VydmVyIiwgIlNpbXBsZVhNTFJQQ1NlcnZlciIsICJ4bWxycGMuc2VydmVyIiksCl0KIyBBZGQgd2luZG93cyBzcGVjaWZpYyBtb2R1bGVzLgppZiBzeXMucGxhdGZvcm0gPT0gIndpbjMyIjoKICAgIF9tb3ZlZF9hdHRyaWJ1dGVzICs9IFsKICAgICAgICBNb3ZlZE1vZHVsZSgid2lucmVnIiwgIl93aW5yZWciKSwKICAgIF0KCmZvciBhdHRyIGluIF9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihfTW92ZWRJdGVtcywgYXR0ci5uYW1lLCBhdHRyKQogICAgaWYgaXNpbnN0YW5jZShhdHRyLCBNb3ZlZE1vZHVsZSk6CiAgICAgICAgX2ltcG9ydGVyLl9hZGRfbW9kdWxlKGF0dHIsICJtb3Zlcy4iICsgYXR0ci5uYW1lKQpkZWwgYXR0cgoKX01vdmVkSXRlbXMuX21vdmVkX2F0dHJpYnV0ZXMgPSBfbW92ZWRfYXR0cmlidXRlcwoKbW92ZXMgPSBfTW92ZWRJdGVtcyhfX25hbWVfXyArICIubW92ZXMiKQpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUobW92ZXMsICJtb3ZlcyIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcGFyc2UoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfcGFyc2UiIiIKCgpfdXJsbGliX3BhcnNlX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUGFyc2VSZXN1bHQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiU3BsaXRSZXN1bHQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicGFyc2VfcXMiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicGFyc2VfcXNsIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybGRlZnJhZyIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxqb2luIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHBhcnNlIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHNwbGl0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHVucGFyc2UiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsdW5zcGxpdCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJxdW90ZSIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicXVvdGVfcGx1cyIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidW5xdW90ZSIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidW5xdW90ZV9wbHVzIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxlbmNvZGUiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInNwbGl0cXVlcnkiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInNwbGl0dGFnIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzcGxpdHVzZXIiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfZnJhZ21lbnQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19uZXRsb2MiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19wYXJhbXMiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19xdWVyeSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX3JlbGF0aXZlIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfcGFyc2VfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcGFyc2UsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9wYXJzZV9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcGFyc2UoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYl9wYXJzZSIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9wYXJzZSIsICJtb3Zlcy51cmxsaWIucGFyc2UiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX2Vycm9yIiIiCgoKX3VybGxpYl9lcnJvcl9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoIlVSTEVycm9yIiwgInVybGxpYjIiLCAidXJsbGliLmVycm9yIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEVycm9yIiwgInVybGxpYjIiLCAidXJsbGliLmVycm9yIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQ29udGVudFRvb1Nob3J0RXJyb3IiLCAidXJsbGliIiwgInVybGxpYi5lcnJvciIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfZXJyb3JfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfZXJyb3IsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9lcnJvcl9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfZXJyb3IoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5lcnJvciIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9lcnJvciIsICJtb3Zlcy51cmxsaWIuZXJyb3IiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfcmVxdWVzdCIiIgoKCl91cmxsaWJfcmVxdWVzdF9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoInVybG9wZW4iLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImluc3RhbGxfb3BlbmVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJidWlsZF9vcGVuZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInBhdGhuYW1lMnVybCIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmwycGF0aG5hbWUiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZ2V0cHJveGllcyIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJSZXF1ZXN0IiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJPcGVuZXJEaXJlY3RvciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUERlZmF1bHRFcnJvckhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBSZWRpcmVjdEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBDb29raWVQcm9jZXNzb3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlByb3h5SGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQmFzZUhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBQYXNzd29yZE1nciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUFBhc3N3b3JkTWdyV2l0aERlZmF1bHRSZWFsbSIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQWJzdHJhY3RCYXNpY0F1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQQmFzaWNBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUHJveHlCYXNpY0F1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJBYnN0cmFjdERpZ2VzdEF1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQRGlnZXN0QXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlByb3h5RGlnZXN0QXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQU0hhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkZpbGVIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJGVFBIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJDYWNoZUZUUEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVua25vd25IYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQRXJyb3JQcm9jZXNzb3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHJldHJpZXZlIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybGNsZWFudXAiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVVJMb3BlbmVyIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkZhbmN5VVJMb3BlbmVyIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInByb3h5X2J5cGFzcyIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX3JlcXVlc3RfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVxdWVzdCwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVxdWVzdC5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfcmVxdWVzdF9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVxdWVzdChfX25hbWVfXyArICIubW92ZXMudXJsbGliLnJlcXVlc3QiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfcmVxdWVzdCIsICJtb3Zlcy51cmxsaWIucmVxdWVzdCIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVzcG9uc2UoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfcmVzcG9uc2UiIiIKCgpfdXJsbGliX3Jlc3BvbnNlX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkYmFzZSIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkY2xvc2Vob29rIiwgInVybGxpYiIsICJ1cmxsaWIucmVzcG9uc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJhZGRpbmZvIiwgInVybGxpYiIsICJ1cmxsaWIucmVzcG9uc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJhZGRpbmZvdXJsIiwgInVybGxpYiIsICJ1cmxsaWIucmVzcG9uc2UiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX3Jlc3BvbnNlX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3Jlc3BvbnNlLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZS5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfcmVzcG9uc2VfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3Jlc3BvbnNlKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIucmVzcG9uc2UiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfcmVzcG9uc2UiLCAibW92ZXMudXJsbGliLnJlc3BvbnNlIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yb2JvdHBhcnNlcihfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9yb2JvdHBhcnNlciIiIgoKCl91cmxsaWJfcm9ib3RwYXJzZXJfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJSb2JvdEZpbGVQYXJzZXIiLCAicm9ib3RwYXJzZXIiLCAidXJsbGliLnJvYm90cGFyc2VyIiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9yb2JvdHBhcnNlcl9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yb2JvdHBhcnNlciwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3JvYm90cGFyc2VyX21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yb2JvdHBhcnNlcihfX25hbWVfXyArICIubW92ZXMudXJsbGliLnJvYm90cGFyc2VyIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3JvYm90cGFyc2VyIiwgIm1vdmVzLnVybGxpYi5yb2JvdHBhcnNlciIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWIodHlwZXMuTW9kdWxlVHlwZSk6CgogICAgIiIiQ3JlYXRlIGEgc2l4Lm1vdmVzLnVybGxpYiBuYW1lc3BhY2UgdGhhdCByZXNlbWJsZXMgdGhlIFB5dGhvbiAzIG5hbWVzcGFjZSIiIgogICAgX19wYXRoX18gPSBbXSAgIyBtYXJrIGFzIHBhY2thZ2UKICAgIHBhcnNlID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfcGFyc2UiKQogICAgZXJyb3IgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9lcnJvciIpCiAgICByZXF1ZXN0ID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfcmVxdWVzdCIpCiAgICByZXNwb25zZSA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3Jlc3BvbnNlIikKICAgIHJvYm90cGFyc2VyID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfcm9ib3RwYXJzZXIiKQoKICAgIGRlZiBfX2Rpcl9fKHNlbGYpOgogICAgICAgIHJldHVybiBbJ3BhcnNlJywgJ2Vycm9yJywgJ3JlcXVlc3QnLCAncmVzcG9uc2UnLCAncm9ib3RwYXJzZXInXQoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWIiKQoKCmRlZiBhZGRfbW92ZShtb3ZlKToKICAgICIiIkFkZCBhbiBpdGVtIHRvIHNpeC5tb3Zlcy4iIiIKICAgIHNldGF0dHIoX01vdmVkSXRlbXMsIG1vdmUubmFtZSwgbW92ZSkKCgpkZWYgcmVtb3ZlX21vdmUobmFtZSk6CiAgICAiIiJSZW1vdmUgaXRlbSBmcm9tIHNpeC5tb3Zlcy4iIiIKICAgIHRyeToKICAgICAgICBkZWxhdHRyKF9Nb3ZlZEl0ZW1zLCBuYW1lKQogICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgIHRyeToKICAgICAgICAgICAgZGVsIG1vdmVzLl9fZGljdF9fW25hbWVdCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICByYWlzZSBBdHRyaWJ1dGVFcnJvcigibm8gc3VjaCBtb3ZlLCAlciIgJSAobmFtZSwpKQoKCmlmIFBZMzoKICAgIF9tZXRoX2Z1bmMgPSAiX19mdW5jX18iCiAgICBfbWV0aF9zZWxmID0gIl9fc2VsZl9fIgoKICAgIF9mdW5jX2Nsb3N1cmUgPSAiX19jbG9zdXJlX18iCiAgICBfZnVuY19jb2RlID0gIl9fY29kZV9fIgogICAgX2Z1bmNfZGVmYXVsdHMgPSAiX19kZWZhdWx0c19fIgogICAgX2Z1bmNfZ2xvYmFscyA9ICJfX2dsb2JhbHNfXyIKZWxzZToKICAgIF9tZXRoX2Z1bmMgPSAiaW1fZnVuYyIKICAgIF9tZXRoX3NlbGYgPSAiaW1fc2VsZiIKCiAgICBfZnVuY19jbG9zdXJlID0gImZ1bmNfY2xvc3VyZSIKICAgIF9mdW5jX2NvZGUgPSAiZnVuY19jb2RlIgogICAgX2Z1bmNfZGVmYXVsdHMgPSAiZnVuY19kZWZhdWx0cyIKICAgIF9mdW5jX2dsb2JhbHMgPSAiZnVuY19nbG9iYWxzIgoKCnRyeToKICAgIGFkdmFuY2VfaXRlcmF0b3IgPSBuZXh0CmV4Y2VwdCBOYW1lRXJyb3I6CiAgICBkZWYgYWR2YW5jZV9pdGVyYXRvcihpdCk6CiAgICAgICAgcmV0dXJuIGl0Lm5leHQoKQpuZXh0ID0gYWR2YW5jZV9pdGVyYXRvcgoKCnRyeToKICAgIGNhbGxhYmxlID0gY2FsbGFibGUKZXhjZXB0IE5hbWVFcnJvcjoKICAgIGRlZiBjYWxsYWJsZShvYmopOgogICAgICAgIHJldHVybiBhbnkoIl9fY2FsbF9fIiBpbiBrbGFzcy5fX2RpY3RfXyBmb3Iga2xhc3MgaW4gdHlwZShvYmopLl9fbXJvX18pCgoKaWYgUFkzOgogICAgZGVmIGdldF91bmJvdW5kX2Z1bmN0aW9uKHVuYm91bmQpOgogICAgICAgIHJldHVybiB1bmJvdW5kCgogICAgY3JlYXRlX2JvdW5kX21ldGhvZCA9IHR5cGVzLk1ldGhvZFR5cGUKCiAgICBkZWYgY3JlYXRlX3VuYm91bmRfbWV0aG9kKGZ1bmMsIGNscyk6CiAgICAgICAgcmV0dXJuIGZ1bmMKCiAgICBJdGVyYXRvciA9IG9iamVjdAplbHNlOgogICAgZGVmIGdldF91bmJvdW5kX2Z1bmN0aW9uKHVuYm91bmQpOgogICAgICAgIHJldHVybiB1bmJvdW5kLmltX2Z1bmMKCiAgICBkZWYgY3JlYXRlX2JvdW5kX21ldGhvZChmdW5jLCBvYmopOgogICAgICAgIHJldHVybiB0eXBlcy5NZXRob2RUeXBlKGZ1bmMsIG9iaiwgb2JqLl9fY2xhc3NfXykKCiAgICBkZWYgY3JlYXRlX3VuYm91bmRfbWV0aG9kKGZ1bmMsIGNscyk6CiAgICAgICAgcmV0dXJuIHR5cGVzLk1ldGhvZFR5cGUoZnVuYywgTm9uZSwgY2xzKQoKICAgIGNsYXNzIEl0ZXJhdG9yKG9iamVjdCk6CgogICAgICAgIGRlZiBuZXh0KHNlbGYpOgogICAgICAgICAgICByZXR1cm4gdHlwZShzZWxmKS5fX25leHRfXyhzZWxmKQoKICAgIGNhbGxhYmxlID0gY2FsbGFibGUKX2FkZF9kb2MoZ2V0X3VuYm91bmRfZnVuY3Rpb24sCiAgICAgICAgICIiIkdldCB0aGUgZnVuY3Rpb24gb3V0IG9mIGEgcG9zc2libHkgdW5ib3VuZCBmdW5jdGlvbiIiIikKCgpnZXRfbWV0aG9kX2Z1bmN0aW9uID0gb3BlcmF0b3IuYXR0cmdldHRlcihfbWV0aF9mdW5jKQpnZXRfbWV0aG9kX3NlbGYgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9tZXRoX3NlbGYpCmdldF9mdW5jdGlvbl9jbG9zdXJlID0gb3BlcmF0b3IuYXR0cmdldHRlcihfZnVuY19jbG9zdXJlKQpnZXRfZnVuY3Rpb25fY29kZSA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfY29kZSkKZ2V0X2Z1bmN0aW9uX2RlZmF1bHRzID0gb3BlcmF0b3IuYXR0cmdldHRlcihfZnVuY19kZWZhdWx0cykKZ2V0X2Z1bmN0aW9uX2dsb2JhbHMgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9mdW5jX2dsb2JhbHMpCgoKaWYgUFkzOgogICAgZGVmIGl0ZXJrZXlzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBpdGVyKGQua2V5cygqKmt3KSkKCiAgICBkZWYgaXRlcnZhbHVlcyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLnZhbHVlcygqKmt3KSkKCiAgICBkZWYgaXRlcml0ZW1zKGQsICoqa3cpOgogICAgICAgIHJldHVybiBpdGVyKGQuaXRlbXMoKiprdykpCgogICAgZGVmIGl0ZXJsaXN0cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLmxpc3RzKCoqa3cpKQoKICAgIHZpZXdrZXlzID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJrZXlzIikKCiAgICB2aWV3dmFsdWVzID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJ2YWx1ZXMiKQoKICAgIHZpZXdpdGVtcyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigiaXRlbXMiKQplbHNlOgogICAgZGVmIGl0ZXJrZXlzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJrZXlzKCoqa3cpCgogICAgZGVmIGl0ZXJ2YWx1ZXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGQuaXRlcnZhbHVlcygqKmt3KQoKICAgIGRlZiBpdGVyaXRlbXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGQuaXRlcml0ZW1zKCoqa3cpCgogICAgZGVmIGl0ZXJsaXN0cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gZC5pdGVybGlzdHMoKiprdykKCiAgICB2aWV3a2V5cyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigidmlld2tleXMiKQoKICAgIHZpZXd2YWx1ZXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZpZXd2YWx1ZXMiKQoKICAgIHZpZXdpdGVtcyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigidmlld2l0ZW1zIikKCl9hZGRfZG9jKGl0ZXJrZXlzLCAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIGtleXMgb2YgYSBkaWN0aW9uYXJ5LiIpCl9hZGRfZG9jKGl0ZXJ2YWx1ZXMsICJSZXR1cm4gYW4gaXRlcmF0b3Igb3ZlciB0aGUgdmFsdWVzIG9mIGEgZGljdGlvbmFyeS4iKQpfYWRkX2RvYyhpdGVyaXRlbXMsCiAgICAgICAgICJSZXR1cm4gYW4gaXRlcmF0b3Igb3ZlciB0aGUgKGtleSwgdmFsdWUpIHBhaXJzIG9mIGEgZGljdGlvbmFyeS4iKQpfYWRkX2RvYyhpdGVybGlzdHMsCiAgICAgICAgICJSZXR1cm4gYW4gaXRlcmF0b3Igb3ZlciB0aGUgKGtleSwgW3ZhbHVlc10pIHBhaXJzIG9mIGEgZGljdGlvbmFyeS4iKQoKCmlmIFBZMzoKICAgIGRlZiBiKHMpOgogICAgICAgIHJldHVybiBzLmVuY29kZSgibGF0aW4tMSIpCgogICAgZGVmIHUocyk6CiAgICAgICAgcmV0dXJuIHMKICAgIHVuaWNociA9IGNocgogICAgaW1wb3J0IHN0cnVjdAogICAgaW50MmJ5dGUgPSBzdHJ1Y3QuU3RydWN0KCI+QiIpLnBhY2sKICAgIGRlbCBzdHJ1Y3QKICAgIGJ5dGUyaW50ID0gb3BlcmF0b3IuaXRlbWdldHRlcigwKQogICAgaW5kZXhieXRlcyA9IG9wZXJhdG9yLmdldGl0ZW0KICAgIGl0ZXJieXRlcyA9IGl0ZXIKICAgIGltcG9ydCBpbwogICAgU3RyaW5nSU8gPSBpby5TdHJpbmdJTwogICAgQnl0ZXNJTyA9IGlvLkJ5dGVzSU8KICAgIF9hc3NlcnRDb3VudEVxdWFsID0gImFzc2VydENvdW50RXF1YWwiCiAgICBpZiBzeXMudmVyc2lvbl9pbmZvWzFdIDw9IDE6CiAgICAgICAgX2Fzc2VydFJhaXNlc1JlZ2V4ID0gImFzc2VydFJhaXNlc1JlZ2V4cCIKICAgICAgICBfYXNzZXJ0UmVnZXggPSAiYXNzZXJ0UmVnZXhwTWF0Y2hlcyIKICAgIGVsc2U6CiAgICAgICAgX2Fzc2VydFJhaXNlc1JlZ2V4ID0gImFzc2VydFJhaXNlc1JlZ2V4IgogICAgICAgIF9hc3NlcnRSZWdleCA9ICJhc3NlcnRSZWdleCIKZWxzZToKICAgIGRlZiBiKHMpOgogICAgICAgIHJldHVybiBzCiAgICAjIFdvcmthcm91bmQgZm9yIHN0YW5kYWxvbmUgYmFja3NsYXNoCgogICAgZGVmIHUocyk6CiAgICAgICAgcmV0dXJuIHVuaWNvZGUocy5yZXBsYWNlKHInXFwnLCByJ1xcXFwnKSwgInVuaWNvZGVfZXNjYXBlIikKICAgIHVuaWNociA9IHVuaWNocgogICAgaW50MmJ5dGUgPSBjaHIKCiAgICBkZWYgYnl0ZTJpbnQoYnMpOgogICAgICAgIHJldHVybiBvcmQoYnNbMF0pCgogICAgZGVmIGluZGV4Ynl0ZXMoYnVmLCBpKToKICAgICAgICByZXR1cm4gb3JkKGJ1ZltpXSkKICAgIGl0ZXJieXRlcyA9IGZ1bmN0b29scy5wYXJ0aWFsKGl0ZXJ0b29scy5pbWFwLCBvcmQpCiAgICBpbXBvcnQgU3RyaW5nSU8KICAgIFN0cmluZ0lPID0gQnl0ZXNJTyA9IFN0cmluZ0lPLlN0cmluZ0lPCiAgICBfYXNzZXJ0Q291bnRFcXVhbCA9ICJhc3NlcnRJdGVtc0VxdWFsIgogICAgX2Fzc2VydFJhaXNlc1JlZ2V4ID0gImFzc2VydFJhaXNlc1JlZ2V4cCIKICAgIF9hc3NlcnRSZWdleCA9ICJhc3NlcnRSZWdleHBNYXRjaGVzIgpfYWRkX2RvYyhiLCAiIiJCeXRlIGxpdGVyYWwiIiIpCl9hZGRfZG9jKHUsICIiIlRleHQgbGl0ZXJhbCIiIikKCgpkZWYgYXNzZXJ0Q291bnRFcXVhbChzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgcmV0dXJuIGdldGF0dHIoc2VsZiwgX2Fzc2VydENvdW50RXF1YWwpKCphcmdzLCAqKmt3YXJncykKCgpkZWYgYXNzZXJ0UmFpc2VzUmVnZXgoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgIHJldHVybiBnZXRhdHRyKHNlbGYsIF9hc3NlcnRSYWlzZXNSZWdleCkoKmFyZ3MsICoqa3dhcmdzKQoKCmRlZiBhc3NlcnRSZWdleChzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgcmV0dXJuIGdldGF0dHIoc2VsZiwgX2Fzc2VydFJlZ2V4KSgqYXJncywgKiprd2FyZ3MpCgoKaWYgUFkzOgogICAgZXhlY18gPSBnZXRhdHRyKG1vdmVzLmJ1aWx0aW5zLCAiZXhlYyIpCgogICAgZGVmIHJlcmFpc2UodHAsIHZhbHVlLCB0Yj1Ob25lKToKICAgICAgICBpZiB2YWx1ZSBpcyBOb25lOgogICAgICAgICAgICB2YWx1ZSA9IHRwKCkKICAgICAgICBpZiB2YWx1ZS5fX3RyYWNlYmFja19fIGlzIG5vdCB0YjoKICAgICAgICAgICAgcmFpc2UgdmFsdWUud2l0aF90cmFjZWJhY2sodGIpCiAgICAgICAgcmFpc2UgdmFsdWUKCmVsc2U6CiAgICBkZWYgZXhlY18oX2NvZGVfLCBfZ2xvYnNfPU5vbmUsIF9sb2NzXz1Ob25lKToKICAgICAgICAiIiJFeGVjdXRlIGNvZGUgaW4gYSBuYW1lc3BhY2UuIiIiCiAgICAgICAgaWYgX2dsb2JzXyBpcyBOb25lOgogICAgICAgICAgICBmcmFtZSA9IHN5cy5fZ2V0ZnJhbWUoMSkKICAgICAgICAgICAgX2dsb2JzXyA9IGZyYW1lLmZfZ2xvYmFscwogICAgICAgICAgICBpZiBfbG9jc18gaXMgTm9uZToKICAgICAgICAgICAgICAgIF9sb2NzXyA9IGZyYW1lLmZfbG9jYWxzCiAgICAgICAgICAgIGRlbCBmcmFtZQogICAgICAgIGVsaWYgX2xvY3NfIGlzIE5vbmU6CiAgICAgICAgICAgIF9sb2NzXyA9IF9nbG9ic18KICAgICAgICBleGVjKCIiImV4ZWMgX2NvZGVfIGluIF9nbG9ic18sIF9sb2NzXyIiIikKCiAgICBleGVjXygiIiJkZWYgcmVyYWlzZSh0cCwgdmFsdWUsIHRiPU5vbmUpOgogICAgcmFpc2UgdHAsIHZhbHVlLCB0YgoiIiIpCgoKaWYgc3lzLnZlcnNpb25faW5mb1s6Ml0gPT0gKDMsIDIpOgogICAgZXhlY18oIiIiZGVmIHJhaXNlX2Zyb20odmFsdWUsIGZyb21fdmFsdWUpOgogICAgaWYgZnJvbV92YWx1ZSBpcyBOb25lOgogICAgICAgIHJhaXNlIHZhbHVlCiAgICByYWlzZSB2YWx1ZSBmcm9tIGZyb21fdmFsdWUKIiIiKQplbGlmIHN5cy52ZXJzaW9uX2luZm9bOjJdID4gKDMsIDIpOgogICAgZXhlY18oIiIiZGVmIHJhaXNlX2Zyb20odmFsdWUsIGZyb21fdmFsdWUpOgogICAgcmFpc2UgdmFsdWUgZnJvbSBmcm9tX3ZhbHVlCiIiIikKZWxzZToKICAgIGRlZiByYWlzZV9mcm9tKHZhbHVlLCBmcm9tX3ZhbHVlKToKICAgICAgICByYWlzZSB2YWx1ZQoKCnByaW50XyA9IGdldGF0dHIobW92ZXMuYnVpbHRpbnMsICJwcmludCIsIE5vbmUpCmlmIHByaW50XyBpcyBOb25lOgogICAgZGVmIHByaW50XygqYXJncywgKiprd2FyZ3MpOgogICAgICAgICIiIlRoZSBuZXctc3R5bGUgcHJpbnQgZnVuY3Rpb24gZm9yIFB5dGhvbiAyLjQgYW5kIDIuNS4iIiIKICAgICAgICBmcCA9IGt3YXJncy5wb3AoImZpbGUiLCBzeXMuc3Rkb3V0KQogICAgICAgIGlmIGZwIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBkZWYgd3JpdGUoZGF0YSk6CiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGRhdGEsIGJhc2VzdHJpbmcpOgogICAgICAgICAgICAgICAgZGF0YSA9IHN0cihkYXRhKQogICAgICAgICAgICAjIElmIHRoZSBmaWxlIGhhcyBhbiBlbmNvZGluZywgZW5jb2RlIHVuaWNvZGUgd2l0aCBpdC4KICAgICAgICAgICAgaWYgKGlzaW5zdGFuY2UoZnAsIGZpbGUpIGFuZAogICAgICAgICAgICAgICAgICAgIGlzaW5zdGFuY2UoZGF0YSwgdW5pY29kZSkgYW5kCiAgICAgICAgICAgICAgICAgICAgZnAuZW5jb2RpbmcgaXMgbm90IE5vbmUpOgogICAgICAgICAgICAgICAgZXJyb3JzID0gZ2V0YXR0cihmcCwgImVycm9ycyIsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBlcnJvcnMgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBlcnJvcnMgPSAic3RyaWN0IgogICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEuZW5jb2RlKGZwLmVuY29kaW5nLCBlcnJvcnMpCiAgICAgICAgICAgIGZwLndyaXRlKGRhdGEpCiAgICAgICAgd2FudF91bmljb2RlID0gRmFsc2UKICAgICAgICBzZXAgPSBrd2FyZ3MucG9wKCJzZXAiLCBOb25lKQogICAgICAgIGlmIHNlcCBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzZXAsIHVuaWNvZGUpOgogICAgICAgICAgICAgICAgd2FudF91bmljb2RlID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5vdCBpc2luc3RhbmNlKHNlcCwgc3RyKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigic2VwIG11c3QgYmUgTm9uZSBvciBhIHN0cmluZyIpCiAgICAgICAgZW5kID0ga3dhcmdzLnBvcCgiZW5kIiwgTm9uZSkKICAgICAgICBpZiBlbmQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZW5kLCB1bmljb2RlKToKICAgICAgICAgICAgICAgIHdhbnRfdW5pY29kZSA9IFRydWUKICAgICAgICAgICAgZWxpZiBub3QgaXNpbnN0YW5jZShlbmQsIHN0cik6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoImVuZCBtdXN0IGJlIE5vbmUgb3IgYSBzdHJpbmciKQogICAgICAgIGlmIGt3YXJnczoKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJpbnZhbGlkIGtleXdvcmQgYXJndW1lbnRzIHRvIHByaW50KCkiKQogICAgICAgIGlmIG5vdCB3YW50X3VuaWNvZGU6CiAgICAgICAgICAgIGZvciBhcmcgaW4gYXJnczoKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYXJnLCB1bmljb2RlKToKICAgICAgICAgICAgICAgICAgICB3YW50X3VuaWNvZGUgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICBpZiB3YW50X3VuaWNvZGU6CiAgICAgICAgICAgIG5ld2xpbmUgPSB1bmljb2RlKCJcbiIpCiAgICAgICAgICAgIHNwYWNlID0gdW5pY29kZSgiICIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbmV3bGluZSA9ICJcbiIKICAgICAgICAgICAgc3BhY2UgPSAiICIKICAgICAgICBpZiBzZXAgaXMgTm9uZToKICAgICAgICAgICAgc2VwID0gc3BhY2UKICAgICAgICBpZiBlbmQgaXMgTm9uZToKICAgICAgICAgICAgZW5kID0gbmV3bGluZQogICAgICAgIGZvciBpLCBhcmcgaW4gZW51bWVyYXRlKGFyZ3MpOgogICAgICAgICAgICBpZiBpOgogICAgICAgICAgICAgICAgd3JpdGUoc2VwKQogICAgICAgICAgICB3cml0ZShhcmcpCiAgICAgICAgd3JpdGUoZW5kKQppZiBzeXMudmVyc2lvbl9pbmZvWzoyXSA8ICgzLCAzKToKICAgIF9wcmludCA9IHByaW50XwoKICAgIGRlZiBwcmludF8oKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBmcCA9IGt3YXJncy5nZXQoImZpbGUiLCBzeXMuc3Rkb3V0KQogICAgICAgIGZsdXNoID0ga3dhcmdzLnBvcCgiZmx1c2giLCBGYWxzZSkKICAgICAgICBfcHJpbnQoKmFyZ3MsICoqa3dhcmdzKQogICAgICAgIGlmIGZsdXNoIGFuZCBmcCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZnAuZmx1c2goKQoKX2FkZF9kb2MocmVyYWlzZSwgIiIiUmVyYWlzZSBhbiBleGNlcHRpb24uIiIiKQoKaWYgc3lzLnZlcnNpb25faW5mb1swOjJdIDwgKDMsIDQpOgogICAgZGVmIHdyYXBzKHdyYXBwZWQsIGFzc2lnbmVkPWZ1bmN0b29scy5XUkFQUEVSX0FTU0lHTk1FTlRTLAogICAgICAgICAgICAgIHVwZGF0ZWQ9ZnVuY3Rvb2xzLldSQVBQRVJfVVBEQVRFUyk6CiAgICAgICAgZGVmIHdyYXBwZXIoZik6CiAgICAgICAgICAgIGYgPSBmdW5jdG9vbHMud3JhcHMod3JhcHBlZCwgYXNzaWduZWQsIHVwZGF0ZWQpKGYpCiAgICAgICAgICAgIGYuX193cmFwcGVkX18gPSB3cmFwcGVkCiAgICAgICAgICAgIHJldHVybiBmCiAgICAgICAgcmV0dXJuIHdyYXBwZXIKZWxzZToKICAgIHdyYXBzID0gZnVuY3Rvb2xzLndyYXBzCgoKZGVmIHdpdGhfbWV0YWNsYXNzKG1ldGEsICpiYXNlcyk6CiAgICAiIiJDcmVhdGUgYSBiYXNlIGNsYXNzIHdpdGggYSBtZXRhY2xhc3MuIiIiCiAgICAjIFRoaXMgcmVxdWlyZXMgYSBiaXQgb2YgZXhwbGFuYXRpb246IHRoZSBiYXNpYyBpZGVhIGlzIHRvIG1ha2UgYSBkdW1teQogICAgIyBtZXRhY2xhc3MgZm9yIG9uZSBsZXZlbCBvZiBjbGFzcyBpbnN0YW50aWF0aW9uIHRoYXQgcmVwbGFjZXMgaXRzZWxmIHdpdGgKICAgICMgdGhlIGFjdHVhbCBtZXRhY2xhc3MuCiAgICBjbGFzcyBtZXRhY2xhc3MobWV0YSk6CgogICAgICAgIGRlZiBfX25ld19fKGNscywgbmFtZSwgdGhpc19iYXNlcywgZCk6CiAgICAgICAgICAgIHJldHVybiBtZXRhKG5hbWUsIGJhc2VzLCBkKQogICAgcmV0dXJuIHR5cGUuX19uZXdfXyhtZXRhY2xhc3MsICd0ZW1wb3JhcnlfY2xhc3MnLCAoKSwge30pCgoKZGVmIGFkZF9tZXRhY2xhc3MobWV0YWNsYXNzKToKICAgICIiIkNsYXNzIGRlY29yYXRvciBmb3IgY3JlYXRpbmcgYSBjbGFzcyB3aXRoIGEgbWV0YWNsYXNzLiIiIgogICAgZGVmIHdyYXBwZXIoY2xzKToKICAgICAgICBvcmlnX3ZhcnMgPSBjbHMuX19kaWN0X18uY29weSgpCiAgICAgICAgc2xvdHMgPSBvcmlnX3ZhcnMuZ2V0KCdfX3Nsb3RzX18nKQogICAgICAgIGlmIHNsb3RzIGlzIG5vdCBOb25lOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHNsb3RzLCBzdHIpOgogICAgICAgICAgICAgICAgc2xvdHMgPSBbc2xvdHNdCiAgICAgICAgICAgIGZvciBzbG90c192YXIgaW4gc2xvdHM6CiAgICAgICAgICAgICAgICBvcmlnX3ZhcnMucG9wKHNsb3RzX3ZhcikKICAgICAgICBvcmlnX3ZhcnMucG9wKCdfX2RpY3RfXycsIE5vbmUpCiAgICAgICAgb3JpZ192YXJzLnBvcCgnX193ZWFrcmVmX18nLCBOb25lKQogICAgICAgIHJldHVybiBtZXRhY2xhc3MoY2xzLl9fbmFtZV9fLCBjbHMuX19iYXNlc19fLCBvcmlnX3ZhcnMpCiAgICByZXR1cm4gd3JhcHBlcgoKCmRlZiBweXRob25fMl91bmljb2RlX2NvbXBhdGlibGUoa2xhc3MpOgogICAgIiIiCiAgICBBIGRlY29yYXRvciB0aGF0IGRlZmluZXMgX191bmljb2RlX18gYW5kIF9fc3RyX18gbWV0aG9kcyB1bmRlciBQeXRob24gMi4KICAgIFVuZGVyIFB5dGhvbiAzIGl0IGRvZXMgbm90aGluZy4KCiAgICBUbyBzdXBwb3J0IFB5dGhvbiAyIGFuZCAzIHdpdGggYSBzaW5nbGUgY29kZSBiYXNlLCBkZWZpbmUgYSBfX3N0cl9fIG1ldGhvZAogICAgcmV0dXJuaW5nIHRleHQgYW5kIGFwcGx5IHRoaXMgZGVjb3JhdG9yIHRvIHRoZSBjbGFzcy4KICAgICIiIgogICAgaWYgUFkyOgogICAgICAgIGlmICdfX3N0cl9fJyBub3QgaW4ga2xhc3MuX19kaWN0X186CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkBweXRob25fMl91bmljb2RlX2NvbXBhdGlibGUgY2Fubm90IGJlIGFwcGxpZWQgIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0byAlcyBiZWNhdXNlIGl0IGRvZXNuJ3QgZGVmaW5lIF9fc3RyX18oKS4iICUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrbGFzcy5fX25hbWVfXykKICAgICAgICBrbGFzcy5fX3VuaWNvZGVfXyA9IGtsYXNzLl9fc3RyX18KICAgICAgICBrbGFzcy5fX3N0cl9fID0gbGFtYmRhIHNlbGY6IHNlbGYuX191bmljb2RlX18oKS5lbmNvZGUoJ3V0Zi04JykKICAgIHJldHVybiBrbGFzcwoKCiMgQ29tcGxldGUgdGhlIG1vdmVzIGltcGxlbWVudGF0aW9uLgojIFRoaXMgY29kZSBpcyBhdCB0aGUgZW5kIG9mIHRoaXMgbW9kdWxlIHRvIHNwZWVkIHVwIG1vZHVsZSBsb2FkaW5nLgojIFR1cm4gdGhpcyBtb2R1bGUgaW50byBhIHBhY2thZ2UuCl9fcGF0aF9fID0gW10gICMgcmVxdWlyZWQgZm9yIFBFUCAzMDIgYW5kIFBFUCA0NTEKX19wYWNrYWdlX18gPSBfX25hbWVfXyAgIyBzZWUgUEVQIDM2NiBAUmVzZXJ2ZWRBc3NpZ25tZW50CmlmIGdsb2JhbHMoKS5nZXQoIl9fc3BlY19fIikgaXMgbm90IE5vbmU6CiAgICBfX3NwZWNfXy5zdWJtb2R1bGVfc2VhcmNoX2xvY2F0aW9ucyA9IFtdICAjIFBFUCA0NTEgQFVuZGVmaW5lZFZhcmlhYmxlCiMgUmVtb3ZlIG90aGVyIHNpeCBtZXRhIHBhdGggaW1wb3J0ZXJzLCBzaW5jZSB0aGV5IGNhdXNlIHByb2JsZW1zLiBUaGlzIGNhbgojIGhhcHBlbiBpZiBzaXggaXMgcmVtb3ZlZCBmcm9tIHN5cy5tb2R1bGVzIGFuZCB0aGVuIHJlbG9hZGVkLiAoU2V0dXB0b29scyBkb2VzCiMgdGhpcyBmb3Igc29tZSByZWFzb24uKQppZiBzeXMubWV0YV9wYXRoOgogICAgZm9yIGksIGltcG9ydGVyIGluIGVudW1lcmF0ZShzeXMubWV0YV9wYXRoKToKICAgICAgICAjIEhlcmUncyBzb21lIHJlYWwgbmFzdGluZXNzOiBBbm90aGVyICJpbnN0YW5jZSIgb2YgdGhlIHNpeCBtb2R1bGUgbWlnaHQKICAgICAgICAjIGJlIGZsb2F0aW5nIGFyb3VuZC4gVGhlcmVmb3JlLCB3ZSBjYW4ndCB1c2UgaXNpbnN0YW5jZSgpIHRvIGNoZWNrIGZvcgogICAgICAgICMgdGhlIHNpeCBtZXRhIHBhdGggaW1wb3J0ZXIsIHNpbmNlIHRoZSBvdGhlciBzaXggaW5zdGFuY2Ugd2lsbCBoYXZlCiAgICAgICAgIyBpbnNlcnRlZCBhbiBpbXBvcnRlciB3aXRoIGRpZmZlcmVudCBjbGFzcy4KICAgICAgICBpZiAodHlwZShpbXBvcnRlcikuX19uYW1lX18gPT0gIl9TaXhNZXRhUGF0aEltcG9ydGVyIiBhbmQKICAgICAgICAgICAgICAgIGltcG9ydGVyLm5hbWUgPT0gX19uYW1lX18pOgogICAgICAgICAgICBkZWwgc3lzLm1ldGFfcGF0aFtpXQogICAgICAgICAgICBicmVhawogICAgZGVsIGksIGltcG9ydGVyCiMgRmluYWxseSwgYWRkIHRoZSBpbXBvcnRlciB0byB0aGUgbWV0YSBwYXRoIGltcG9ydCBob29rLgpzeXMubWV0YV9wYXRoLmFwcGVuZChfaW1wb3J0ZXIpClBLAQIUAxQAAAAAANS7K0uPp/FSdwAAAHcAAAATAAAAAAAAAAAAAACAAQAAAABhbnNpYmxlL19faW5pdF9fLnB5UEsBAhQDFAAAAAAA1LsrS53F8WtIAAAASAAAACAAAAAAAAAAAAAAAIABqAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL19faW5pdF9fLnB5UEsBAhQDFAAAAAAA1LsrS95xgUU/8gAAP/IAAB0AAAAAAAAAAAAAAIABLgEAAGFuc2libGVfbW9kdWxlX2JpZ2lwX2ZhY3RzLnB5UEsBAhQDFAAAAAAA1LsrSzvfOZUwigEAMIoBAB0AAAAAAAAAAAAAAIABqPMAAGFuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5UEsBAhQDFAAAAAAA1LsrS3dO/rR8KAAAfCgAACAAAAAAAAAAAAAAAIABE34CAGFuc2libGUvbW9kdWxlX3V0aWxzL2Y1X3V0aWxzLnB5UEsBAhQDFAAAAAAA1LsrS7XYBAYlMAAAJTAAAB0AAAAAAAAAAAAAAIABzaYCAGFuc2libGUvbW9kdWxlX3V0aWxzL190ZXh0LnB5UEsBAhQDFAAAAAAA1LsrSyXctH4TEAAAExAAACIAAAAAAAAAAAAAAIABLdcCAGFuc2libGUvbW9kdWxlX3V0aWxzL3B5Y29tcGF0MjQucHlQSwECFAMUAAAAAADUuytLGBdy9QERAAABEQAAJAAAAAAAAAAAAAAAgAGA5wIAYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19faW5pdF9fLnB5UEsBAhQDFAAAAAAA1LsrSzjix9GRdQAAkXUAACAAAAAAAAAAAAAAAIABw/gCAGFuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fc2l4LnB5UEsFBgAAAAAJAAkArgIAAJJuAwAAAA=="""
def invoke_module(module, modlib_path, json_params):
    pythonpath = os.environ.get('PYTHONPATH')
    if pythonpath:
        os.environ['PYTHONPATH'] = ':'.join((modlib_path, pythonpath))
    else:
        os.environ['PYTHONPATH'] = modlib_path
    p = subprocess.Popen(['/usr/bin/python', module], env=os.environ, shell=False, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
    (stdout, stderr) = p.communicate(json_params)
    if not isinstance(stderr, (bytes, unicode)):
        stderr = stderr.read()
    if not isinstance(stdout, (bytes, unicode)):
        stdout = stdout.read()
    if PY3:
        sys.stderr.buffer.write(stderr)
        sys.stdout.buffer.write(stdout)
    else:
        sys.stderr.write(stderr)
        sys.stdout.write(stdout)
    return p.returncode
def debug(command, zipped_mod, json_params):
    basedir = os.path.join(os.path.abspath(os.path.dirname(__file__)), 'debug_dir')
    args_path = os.path.join(basedir, 'args')
    script_path = os.path.join(basedir, 'ansible_module_bigip_facts.py')
    if command == 'explode':
        z = zipfile.ZipFile(zipped_mod)
        for filename in z.namelist():
            if filename.startswith('/'):
                raise Exception('Something wrong with this module zip file: should not contain absolute paths')
            dest_filename = os.path.join(basedir, filename)
            if dest_filename.endswith(os.path.sep) and not os.path.exists(dest_filename):
                os.makedirs(dest_filename)
            else:
                directory = os.path.dirname(dest_filename)
                if not os.path.exists(directory):
                    os.makedirs(directory)
                f = open(dest_filename, 'wb')
                f.write(z.read(filename))
                f.close()
        f = open(args_path, 'wb')
        f.write(json_params)
        f.close()
        print('Module expanded into:')
        print('%s' % basedir)
        exitcode = 0
    elif command == 'execute':
        pythonpath = os.environ.get('PYTHONPATH')
        if pythonpath:
            os.environ['PYTHONPATH'] = ':'.join((basedir, pythonpath))
        else:
            os.environ['PYTHONPATH'] = basedir
        p = subprocess.Popen(['/usr/bin/python', script_path, args_path],
                env=os.environ, shell=False, stdout=subprocess.PIPE,
                stderr=subprocess.PIPE, stdin=subprocess.PIPE)
        (stdout, stderr) = p.communicate()
        if not isinstance(stderr, (bytes, unicode)):
            stderr = stderr.read()
        if not isinstance(stdout, (bytes, unicode)):
            stdout = stdout.read()
        if PY3:
            sys.stderr.buffer.write(stderr)
            sys.stdout.buffer.write(stdout)
        else:
            sys.stderr.write(stderr)
            sys.stdout.write(stdout)
        return p.returncode
    elif command == 'excommunicate':
        sys.argv = ['bigip_facts', args_path]
        sys.path.insert(0, basedir)
        from ansible_module_bigip_facts import main
        main()
        print('WARNING: Module returned to wrapper instead of exiting')
        sys.exit(1)
    else:
        print('WARNING: Unknown debug command.  Doing nothing.')
        exitcode = 0
    return exitcode
if __name__ == '__main__':
    ANSIBALLZ_PARAMS = json.dumps({"ANSIBLE_MODULE_ARGS": json.load(sys.stdin)})
    if PY3:
        ANSIBALLZ_PARAMS = ANSIBALLZ_PARAMS.encode('utf-8')
    try:
        temp_path = tempfile.mkdtemp(prefix='ansible_')
        zipped_mod = os.path.join(temp_path, 'ansible_modlib.zip')
        modlib = open(zipped_mod, 'wb')
        modlib.write(base64.b64decode(ZIPDATA))
        modlib.close()
        if len(sys.argv) == 2:
            exitcode = debug(sys.argv[1], zipped_mod, ANSIBALLZ_PARAMS)
        else:
            z = zipfile.ZipFile(zipped_mod, mode='r')
            module = os.path.join(temp_path, 'ansible_module_bigip_facts.py')
            f = open(module, 'wb')
            f.write(z.read('ansible_module_bigip_facts.py'))
            f.close()
            z = zipfile.ZipFile(zipped_mod, mode='a')
            sitecustomize = u'import sys\nsys.path.insert(0,"%s")\n' %  zipped_mod
            sitecustomize = sitecustomize.encode('utf-8')
            zinfo = zipfile.ZipInfo()
            zinfo.filename = 'sitecustomize.py'
            zinfo.date_time = ( 2017, 9, 11, 23, 30, 40)
            z.writestr(zinfo, sitecustomize)
            z.close()
            exitcode = invoke_module(module, zipped_mod, ANSIBALLZ_PARAMS)
    finally:
        try:
            shutil.rmtree(temp_path)
        except OSError:
            pass
    sys.exit(exitcode)