#!/usr/bin/python
# -*- coding: utf-8 -*-
ANSIBALLZ_WRAPPER = True # For test-module script to tell this is a ANSIBALLZ_WRAPPER
import os
import os.path
import sys
import __main__
scriptdir = None
try:
    scriptdir = os.path.dirname(os.path.abspath(__main__.__file__))
except (AttributeError, OSError):
    pass
if scriptdir is not None:
    sys.path = [p for p in sys.path if p != scriptdir]
import base64
import json
import shutil
import zipfile
import tempfile
import subprocess
if sys.version_info < (3,):
    bytes = str
    PY3 = False
else:
    unicode = str
    PY3 = True
try:
    from io import BytesIO as IOStream
except ImportError:
    from StringIO import StringIO as IOStream
ZIPDATA = """UEsDBBQAAAAAANS7K0uPp/FSdwAAAHcAAAATAAAAYW5zaWJsZS9fX2luaXRfXy5weWZyb20gcGtndXRpbCBpbXBvcnQgZXh0ZW5kX3BhdGgKX19wYXRoX189ZXh0ZW5kX3BhdGgoX19wYXRoX18sX19uYW1lX18pCl9fdmVyc2lvbl9fPSIyLjQuMCIKX19hdXRob3JfXz0iQW5zaWJsZSwgSW5jLiIKUEsDBBQAAAAAANS7K0udxfFrSAAAAEgAAAAgAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX19pbml0X18ucHlmcm9tIHBrZ3V0aWwgaW1wb3J0IGV4dGVuZF9wYXRoCl9fcGF0aF9fPWV4dGVuZF9wYXRoKF9fcGF0aF9fLF9fbmFtZV9fKQpQSwMEFAAAAAAA1LsrS4AJ7erEoAEAxKABACQAAABhbnNpYmxlX21vZHVsZV9jZV9hYWFfc2VydmVyX2hvc3QucHkjIS91c3IvYmluL3B5dGhvbgojCiMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgojCgpBTlNJQkxFX01FVEFEQVRBID0geydzdGF0dXMnOiBbJ3ByZXZpZXcnXSwKICAgICAgICAgICAgICAgICAgICAnc3VwcG9ydGVkX2J5JzogJ2NvbW11bml0eScsCiAgICAgICAgICAgICAgICAgICAgJ21ldGFkYXRhX3ZlcnNpb24nOiAnMS4wJ30KCkRPQ1VNRU5UQVRJT04gPSAnJycKLS0tCm1vZHVsZTogY2VfYWFhX3NlcnZlcl9ob3N0CnZlcnNpb25fYWRkZWQ6ICIyLjQiCnNob3J0X2Rlc2NyaXB0aW9uOiBNYW5hZ2VzIEFBQSBzZXJ2ZXIgaG9zdCBjb25maWd1cmF0aW9uIG9uIEhVQVdFSSBDbG91ZEVuZ2luZSBzd2l0Y2hlcy4KZGVzY3JpcHRpb246CiAgICAtIE1hbmFnZXMgQUFBIHNlcnZlciBob3N0IGNvbmZpZ3VyYXRpb24gb24gSFVBV0VJIENsb3VkRW5naW5lIHN3aXRjaGVzLgphdXRob3I6CiAgICAtIHdhbmdkZXpodWFuZyAoQENsb3VkRW5naW5lLUFuc2libGUpCm9wdGlvbnM6CiAgICBzdGF0ZToKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSBTcGVjaWZ5IGRlc2lyZWQgc3RhdGUgb2YgdGhlIHJlc291cmNlLgogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAgIGRlZmF1bHQ6IHByZXNlbnQKICAgICAgICBjaG9pY2VzOiBbJ3ByZXNlbnQnLCAnYWJzZW50J10KICAgIGxvY2FsX3VzZXJfbmFtZToKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSBOYW1lIG9mIGEgbG9jYWwgdXNlci4KICAgICAgICAgICAgICBUaGUgdmFsdWUgaXMgYSBzdHJpbmcgb2YgMSB0byAyNTMgY2hhcmFjdGVycy4KICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiBudWxsCiAgICBsb2NhbF9wYXNzd29yZDoKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSBMb2dpbiBwYXNzd29yZCBvZiBhIHVzZXIuIFRoZSBwYXNzd29yZCBjYW4gY29udGFpbiBsZXR0ZXJzLCBudW1iZXJzLCBhbmQgc3BlY2lhbCBjaGFyYWN0ZXJzLgogICAgICAgICAgICAgIFRoZSB2YWx1ZSBpcyBhIHN0cmluZyBvZiAxIHRvIDI1NSBjaGFyYWN0ZXJzLgogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAgIGRlZmF1bHQ6IG51bGwKICAgIGxvY2FsX3NlcnZpY2VfdHlwZToKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSBUaGUgdHlwZSBvZiBsb2NhbCB1c2VyIGxvZ2luIHRocm91Z2gsIHN1Y2ggYXMgZnRwIHNzaCBzbm1wIHRlbG5ldC4KICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiBudWxsCiAgICBsb2NhbF9mdHBfZGlyOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIEZUUCB1c2VyIGRpcmVjdG9yeS4KICAgICAgICAgICAgICBUaGUgdmFsdWUgaXMgYSBzdHJpbmcgb2YgMSB0byAyNTUgY2hhcmFjdGVycy4KICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiBudWxsCiAgICBsb2NhbF91c2VyX2xldmVsOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIExvZ2luIGxldmVsIG9mIGEgbG9jYWwgdXNlci4KICAgICAgICAgICAgICBUaGUgdmFsdWUgaXMgYW4gaW50ZWdlciByYW5naW5nIGZyb20gMCB0byAxNS4KICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiBudWxsCiAgICBsb2NhbF91c2VyX2dyb3VwOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIE5hbWUgb2YgdGhlIHVzZXIgZ3JvdXAgd2hlcmUgdGhlIHVzZXIgYmVsb25ncy4gVGhlIHVzZXIgaW5oZXJpdHMgYWxsIHRoZSByaWdodHMgb2YgdGhlIHVzZXIgZ3JvdXAuCiAgICAgICAgICAgICAgVGhlIHZhbHVlIGlzIGEgc3RyaW5nIG9mIDEgdG8gMzIgY2hhcmFjdGVycy4KICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiBudWxsCiAgICByYWRpdXNfZ3JvdXBfbmFtZToKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSBSQURJVVMgc2VydmVyIGdyb3VwJ3MgbmFtZS4KICAgICAgICAgICAgICBUaGUgdmFsdWUgaXMgYSBzdHJpbmcgb2YgMSB0byAzMiBjYXNlLWluc2Vuc2l0aXZlIGNoYXJhY3RlcnMuCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgICAgZGVmYXVsdDogbnVsbAogICAgcmFkaXVzX3NlcnZlcl90eXBlOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIFR5cGUgb2YgUmFkaXVzIFNlcnZlci4KICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiBudWxsCiAgICAgICAgY2hvaWNlczogWydBdXRoZW50aWNhdGlvbicsICdBY2NvdW50aW5nJ10KICAgIHJhZGl1c19zZXJ2ZXJfaXA6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gSVB2NCBhZGRyZXNzIG9mIGNvbmZpZ3VyZWQgc2VydmVyLgogICAgICAgICAgICAgIFRoZSB2YWx1ZSBpcyBhIHN0cmluZyBvZiAwIHRvIDI1NSBjaGFyYWN0ZXJzLCBpbiBkb3R0ZWQgZGVjaW1hbCBub3RhdGlvbi4KICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiBudWxsCiAgICByYWRpdXNfc2VydmVyX2lwdjY6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gSVB2NiBhZGRyZXNzIG9mIGNvbmZpZ3VyZWQgc2VydmVyLgogICAgICAgICAgICAgIFRoZSB0b3RhbCBsZW5ndGggaXMgMTI4IGJpdHMuCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgICAgZGVmYXVsdDogbnVsbAogICAgcmFkaXVzX3NlcnZlcl9wb3J0OgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIENvbmZpZ3VyZWQgc2VydmVyIHBvcnQgZm9yIGEgcGFydGljdWxhciBzZXJ2ZXIuCiAgICAgICAgICAgICAgVGhlIHZhbHVlIGlzIGFuIGludGVnZXIgcmFuZ2luZyBmcm9tIDEgdG8gNjU1MzUuCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgICAgZGVmYXVsdDogbnVsbAogICAgcmFkaXVzX3NlcnZlcl9tb2RlOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIENvbmZpZ3VyZWQgcHJpbWFyeSBvciBzZWNvbmRhcnkgc2VydmVyIGZvciBhIHBhcnRpY3VsYXIgc2VydmVyLgogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAgIGRlZmF1bHQ6IG51bGwKICAgICAgICBjaG9pY2VzOiBbJ1NlY29uZGFyeS1zZXJ2ZXInLCAnUHJpbWFyeS1zZXJ2ZXInXQogICAgcmFkaXVzX3Zwbl9uYW1lOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIFNldCBWUE4gaW5zdGFuY2UuCiAgICAgICAgICAgICAgVGhlIHZhbHVlIGlzIGEgc3RyaW5nIG9mIDEgdG8gMzEgY2FzZS1zZW5zaXRpdmUgY2hhcmFjdGVycy4KICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiBudWxsCiAgICByYWRpdXNfc2VydmVyX25hbWU6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gSG9zdG5hbWUgb2YgY29uZmlndXJlZCBzZXJ2ZXIuCiAgICAgICAgICAgICAgVGhlIHZhbHVlIGlzIGEgc3RyaW5nIG9mIDAgdG8gMjU1IGNhc2Utc2Vuc2l0aXZlIGNoYXJhY3RlcnMuCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgICAgZGVmYXVsdDogbnVsbAogICAgaHd0YWNhY3NfdGVtcGxhdGU6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gTmFtZSBvZiBhIEhXVEFDQUNTIHRlbXBsYXRlLgogICAgICAgICAgICAgIFRoZSB2YWx1ZSBpcyBhIHN0cmluZyBvZiAxIHRvIDMyIGNhc2UtaW5zZW5zaXRpdmUgY2hhcmFjdGVycy4KICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiBudWxsCiAgICBod3RhY2Fjc19zZXJ2ZXJfaXA6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gU2VydmVyIElQdjQgYWRkcmVzcy4gTXVzdCBiZSBhIHZhbGlkIHVuaWNhc3QgSVAgYWRkcmVzcy4KICAgICAgICAgICAgICBUaGUgdmFsdWUgaXMgYSBzdHJpbmcgb2YgMCB0byAyNTUgY2hhcmFjdGVycywgaW4gZG90dGVkIGRlY2ltYWwgbm90YXRpb24uCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgICAgZGVmYXVsdDogbnVsbAogICAgaHd0YWNhY3Nfc2VydmVyX2lwdjY6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gU2VydmVyIElQdjYgYWRkcmVzcy4gTXVzdCBiZSBhIHZhbGlkIHVuaWNhc3QgSVAgYWRkcmVzcy4KICAgICAgICAgICAgICBUaGUgdG90YWwgbGVuZ3RoIGlzIDEyOCBiaXRzLgogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAgIGRlZmF1bHQ6IG51bGwKICAgIGh3dGFjYWNzX3NlcnZlcl90eXBlOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIEh3dGFjYWNzIHNlcnZlciB0eXBlLgogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAgIGRlZmF1bHQ6IG51bGwKICAgICAgICBjaG9pY2VzOiBbJ0F1dGhlbnRpY2F0aW9uJywgJ0F1dGhvcml6YXRpb24nLCAnQWNjb3VudGluZycsICdDb21tb24nXQogICAgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlcjoKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSBXaGV0aGVyIHRoZSBzZXJ2ZXIgaXMgc2Vjb25kYXJ5LgogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAgIGRlZmF1bHQ6IGZhbHNlCiAgICAgICAgY2hvaWNlczogWyd0cnVlJywgJ2ZhbHNlJ10KICAgIGh3dGFjYWNzX3Zwbl9uYW1lOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIFZQTiBpbnN0YW5jZSBuYW1lLgogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAgIGRlZmF1bHQ6IG51bGwKICAgIGh3dGFjYWNzX2lzX3B1YmxpY19uZXQ6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gU2V0IHRoZSBwdWJsaWMtbmV0LgogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAgIGRlZmF1bHQ6IGZhbHNlCiAgICAgICAgY2hvaWNlczogWyd0cnVlJywgJ2ZhbHNlJ10KICAgIGh3dGFjYWNzX3NlcnZlcl9ob3N0X25hbWU6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gSHd0YWNhY3Mgc2VydmVyIGhvc3QgbmFtZS4KICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiBudWxsCicnJwoKRVhBTVBMRVMgPSAnJycKCi0gbmFtZTogQUFBIHNlcnZlciBob3N0IHRlc3QKICBob3N0czogY2xvdWRlbmdpbmUKICBjb25uZWN0aW9uOiBsb2NhbAogIGdhdGhlcl9mYWN0czogbm8KICB2YXJzOgogICAgY2xpOgogICAgICBob3N0OiAie3sgaW52ZW50b3J5X2hvc3RuYW1lIH19IgogICAgICBwb3J0OiAie3sgYW5zaWJsZV9zc2hfcG9ydCB9fSIKICAgICAgdXNlcm5hbWU6ICJ7eyB1c2VybmFtZSB9fSIKICAgICAgcGFzc3dvcmQ6ICJ7eyBwYXNzd29yZCB9fSIKICAgICAgdHJhbnNwb3J0OiBjbGkKCiAgdGFza3M6CgogIC0gbmFtZTogIkNvbmZpZyBsb2NhbCB1c2VyIHdoZW4gdXNlIGxvY2FsIHNjaGVtZSIKICAgIGNlX2FhYV9zZXJ2ZXJfaG9zdDoKICAgICAgc3RhdGU6IHByZXNlbnQKICAgICAgbG9jYWxfdXNlcl9uYW1lOiB1c2VyMQogICAgICBsb2NhbF9wYXNzd29yZDogMTIzNDU2CiAgICAgIHByb3ZpZGVyOiAie3sgY2xpIH19IgoKICAtIG5hbWU6ICJVbmRvIGxvY2FsIHVzZXIgd2hlbiB1c2UgbG9jYWwgc2NoZW1lIgogICAgY2VfYWFhX3NlcnZlcl9ob3N0OgogICAgICBzdGF0ZTogYWJzZW50CiAgICAgIGxvY2FsX3VzZXJfbmFtZTogdXNlcjEKICAgICAgbG9jYWxfcGFzc3dvcmQ6IDEyMzQ1NgogICAgICBwcm92aWRlcjogInt7IGNsaSB9fSIKCiAgLSBuYW1lOiAiQ29uZmlnIHJhZGl1cyBzZXJ2ZXIgaXAiCiAgICBjZV9hYWFfc2VydmVyX2hvc3Q6CiAgICAgIHN0YXRlOiBwcmVzZW50CiAgICAgIHJhZGl1c19ncm91cF9uYW1lOiBncm91cDEKICAgICAgcmFkdWlzX3NlcnZlcl90eXBlOiBBdXRoZW50aWNhdGlvbgogICAgICByYWRpdXNfc2VydmVyX2lwOiAxMC4xLjEwLjEKICAgICAgcmFkaXVzX3NlcnZlcl9wb3J0OiAyMDAwCiAgICAgIHJhZGl1c19zZXJ2ZXJfbW9kZTogUHJpbWFyeS1zZXJ2ZXIKICAgICAgcmFkaXVzX3Zwbl9uYW1lOiBfcHVibGljXwogICAgICBwcm92aWRlcjogInt7IGNsaSB9fSIKCiAgLSBuYW1lOiAiVW5kbyByYWRpdXMgc2VydmVyIGlwIgogICAgY2VfYWFhX3NlcnZlcl9ob3N0OgogICAgICBzdGF0ZTogYWJzZW50CiAgICAgIHJhZGl1c19ncm91cF9uYW1lOiBncm91cDEKICAgICAgcmFkdWlzX3NlcnZlcl90eXBlOiBBdXRoZW50aWNhdGlvbgogICAgICByYWRpdXNfc2VydmVyX2lwOiAxMC4xLjEwLjEKICAgICAgcmFkaXVzX3NlcnZlcl9wb3J0OiAyMDAwCiAgICAgIHJhZGl1c19zZXJ2ZXJfbW9kZTogUHJpbWFyeS1zZXJ2ZXIKICAgICAgcmFkaXVzX3Zwbl9uYW1lOiBfcHVibGljXwogICAgICBwcm92aWRlcjogInt7IGNsaSB9fSIKCiAgLSBuYW1lOiAiQ29uZmlnIGh3dGFjYWNzIHNlcnZlciBpcCIKICAgIGNlX2FhYV9zZXJ2ZXJfaG9zdDoKICAgICAgc3RhdGU6IHByZXNlbnQKICAgICAgaHd0YWNhY3NfdGVtcGxhdGU6IHRlbXBsYXRlCiAgICAgIGh3dGFjYWNzX3NlcnZlcl9pcDogMTAuMTAuMTAuMTAKICAgICAgaHd0YWNhY3Nfc2VydmVyX3R5cGU6IEF1dGhvcml6YXRpb24KICAgICAgaHd0YWNhY3NfdnBuX25hbWU6IF9wdWJsaWNfCiAgICAgIHByb3ZpZGVyOiAie3sgY2xpIH19IgoKICAtIG5hbWU6ICJVbmRvIGh3dGFjYWNzIHNlcnZlciBpcCIKICAgIGNlX2FhYV9zZXJ2ZXJfaG9zdDoKICAgICAgc3RhdGU6IGFic2VudAogICAgICBod3RhY2Fjc190ZW1wbGF0ZTogdGVtcGxhdGUKICAgICAgaHd0YWNhY3Nfc2VydmVyX2lwOiAxMC4xMC4xMC4xMAogICAgICBod3RhY2Fjc19zZXJ2ZXJfdHlwZTogQXV0aG9yaXphdGlvbgogICAgICBod3RhY2Fjc192cG5fbmFtZTogX3B1YmxpY18KICAgICAgcHJvdmlkZXI6ICJ7eyBjbGkgfX0iCicnJwoKUkVUVVJOID0gJycnCmNoYW5nZWQ6CiAgICBkZXNjcmlwdGlvbjogY2hlY2sgdG8gc2VlIGlmIGEgY2hhbmdlIHdhcyBtYWRlIG9uIHRoZSBkZXZpY2UKICAgIHJldHVybmVkOiBhbHdheXMKICAgIHR5cGU6IGJvb2xlYW4KICAgIHNhbXBsZTogdHJ1ZQpwcm9wb3NlZDoKICAgIGRlc2NyaXB0aW9uOiBrL3YgcGFpcnMgb2YgcGFyYW1ldGVycyBwYXNzZWQgaW50byBtb2R1bGUKICAgIHJldHVybmVkOiBhbHdheXMKICAgIHR5cGU6IGRpY3QKICAgIHNhbXBsZTogeyJod3RhY2Fjc19pc19wdWJsaWNfbmV0IjogImZhbHNlIiwKICAgICAgICAgICAgICJod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyIjogImZhbHNlIiwKICAgICAgICAgICAgICJod3RhY2Fjc19zZXJ2ZXJfaXAiOiAiMTAuMTM1LjE4Mi4xNTciLAogICAgICAgICAgICAgImh3dGFjYWNzX3NlcnZlcl90eXBlIjogIkF1dGhvcml6YXRpb24iLAogICAgICAgICAgICAgImh3dGFjYWNzX3RlbXBsYXRlIjogIndkeiIsCiAgICAgICAgICAgICAiaHd0YWNhY3NfdnBuX25hbWUiOiAiX3B1YmxpY18iLAogICAgICAgICAgICAgImxvY2FsX3Bhc3N3b3JkIjogIioqKioqKiIsCiAgICAgICAgICAgICAic3RhdGUiOiAicHJlc2VudCJ9CmV4aXN0aW5nOgogICAgZGVzY3JpcHRpb246IGsvdiBwYWlycyBvZiBleGlzdGluZyBhYWEgc2VydmVyIGhvc3QKICAgIHJldHVybmVkOiBhbHdheXMKICAgIHR5cGU6IGRpY3QKICAgIHNhbXBsZTogeyJyYWRpdXMgc2VydmVyIGlwdjQiOiBbXX0KZW5kX3N0YXRlOgogICAgZGVzY3JpcHRpb246IGsvdiBwYWlycyBvZiBhYWEgcGFyYW1zIGFmdGVyIG1vZHVsZSBleGVjdXRpb24KICAgIHJldHVybmVkOiBhbHdheXMKICAgIHR5cGU6IGRpY3QKICAgIHNhbXBsZTogeyJyYWRpdXMgc2VydmVyIGlwdjQiOiBbCiAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAiMTAuMS4xMC4xIiwKICAgICAgICAgICAgICAgICJBdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICAgICAiMjAwMCIsCiAgICAgICAgICAgICAgICAiUHJpbWFyeS1zZXJ2ZXIiLAogICAgICAgICAgICAgICAgIl9wdWJsaWNfIgogICAgICAgICAgICAgIF0KICAgICAgICAgICAgIF19CnVwZGF0ZXM6CiAgICBkZXNjcmlwdGlvbjogY29tbWFuZCBzZW50IHRvIHRoZSBkZXZpY2UKICAgIHJldHVybmVkOiBhbHdheXMKICAgIHR5cGU6IGxpc3QKICAgIHNhbXBsZTogWyJod3RhY2FjcyBzZXJ2ZXIgdGVtcGxhdGUgdGVzdCIsCiAgICAgICAgICAgICAiaHd0YWNhY3Mgc2VydmVyIGF1dGhvcml6YXRpb24gMTAuMTM1LjE4Mi4xNTcgdnBuLWluc3RhbmNlIHRlc3RfdnBuIHB1YmxpYy1uZXQiXQonJycKCmltcG9ydCBzeXMKaW1wb3J0IHNvY2tldApmcm9tIHhtbC5ldHJlZSBpbXBvcnQgRWxlbWVudFRyZWUKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5iYXNpYyBpbXBvcnQgQW5zaWJsZU1vZHVsZQpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmNlIGltcG9ydCBnZXRfbmNfY29uZmlnLCBzZXRfbmNfY29uZmlnLCBjZV9hcmd1bWVudF9zcGVjCgoKU1VDQ0VTUyA9ICIiInN1Y2Nlc3MiIiIKRkFJTEVEID0gIiIiZmFpbGVkIiIiCgpJTlZBTElEX1VTRVJfTkFNRV9DSEFSID0gWycgJywgJy8nLCAnXFwnLAogICAgICAgICAgICAgICAgICAgICAgICAgICc6JywgJyonLCAnPycsICciJywgJ1wnJywgJzwnLCAnPicsICclJ10KCiMgZ2V0IGxvY2FsIHVzZXIgbmFtZQpDRV9HRVRfTE9DQUxfVVNFUl9JTkZPX0hFQURFUiA9ICIiIgogICAgPGZpbHRlciB0eXBlPSJzdWJ0cmVlIj4KICAgICAgPGFhYSB4bWxucz0iaHR0cDovL3d3dy5odWF3ZWkuY29tL25ldGNvbmYvdnJwIiBjb250ZW50LXZlcnNpb249IjEuMCIgZm9ybWF0LXZlcnNpb249IjEuMCI+CiAgICAgICAgPGxhbT4KICAgICAgICAgIDx1c2Vycz4KICAgICAgICAgICAgPHVzZXI+CiAgICAgICAgICAgICAgPHVzZXJOYW1lPjwvdXNlck5hbWU+CiAgICAgICAgICAgICAgPHBhc3N3b3JkPjwvcGFzc3dvcmQ+CiIiIgpDRV9HRVRfTE9DQUxfVVNFUl9JTkZPX1RBSUwgPSAiIiIKICAgICAgICAgICAgPC91c2VyPgogICAgICAgICAgPC91c2Vycz4KICAgICAgICA8L2xhbT4KICAgICAgPC9hYWE+CiAgICA8L2ZpbHRlcj4KIiIiCgojIG1lcmdlIGxvY2FsIHVzZXIgbmFtZQpDRV9NRVJHRV9MT0NBTF9VU0VSX0lORk9fSEVBREVSID0gIiIiCiAgICA8Y29uZmlnPgogICAgICA8YWFhIHhtbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiIGNvbnRlbnQtdmVyc2lvbj0iMS4wIiBmb3JtYXQtdmVyc2lvbj0iMS4wIj4KICAgICAgICA8bGFtPgogICAgICAgICAgPHVzZXJzPgogICAgICAgICAgICA8dXNlciBvcGVyYXRpb249Im1lcmdlIj4KICAgICAgICAgICAgICA8dXNlck5hbWU+JXM8L3VzZXJOYW1lPgoiIiIKQ0VfTUVSR0VfTE9DQUxfVVNFUl9JTkZPX1RBSUwgPSAiIiIKICAgICAgICAgICAgPC91c2VyPgogICAgICAgICAgPC91c2Vycz4KICAgICAgICA8L2xhbT4KICAgICAgPC9hYWE+CiAgICA8L2NvbmZpZz4KIiIiCgojIGRlbGV0ZSBsb2NhbCB1c2VyIG5hbWUKQ0VfREVMRVRFX0xPQ0FMX1VTRVJfSU5GT19IRUFERVIgPSAiIiIKICAgIDxjb25maWc+CiAgICAgIDxhYWEgeG1sbnM9Imh0dHA6Ly93d3cuaHVhd2VpLmNvbS9uZXRjb25mL3ZycCIgY29udGVudC12ZXJzaW9uPSIxLjAiIGZvcm1hdC12ZXJzaW9uPSIxLjAiPgogICAgICAgIDxsYW0+CiAgICAgICAgICA8dXNlcnM+CiAgICAgICAgICAgIDx1c2VyIG9wZXJhdGlvbj0iZGVsZXRlIj4KICAgICAgICAgICAgICA8dXNlck5hbWU+JXM8L3VzZXJOYW1lPgoiIiIKQ0VfREVMRVRFX0xPQ0FMX1VTRVJfSU5GT19UQUlMID0gIiIiCiAgICAgICAgICAgIDwvdXNlcj4KICAgICAgICAgIDwvdXNlcnM+CiAgICAgICAgPC9sYW0+CiAgICAgIDwvYWFhPgogICAgPC9jb25maWc+CiIiIgoKIyBnZXQgcmFkaXVzIHNlcnZlciBjb25maWcgaXB2NApDRV9HRVRfUkFESVVTX1NFUlZFUl9DRkdfSVBWNCA9ICIiIgogICAgPGZpbHRlciB0eXBlPSJzdWJ0cmVlIj4KICAgICAgPHJhZGl1cyB4bWxucz0iaHR0cDovL3d3dy5odWF3ZWkuY29tL25ldGNvbmYvdnJwIiBjb250ZW50LXZlcnNpb249IjEuMCIgZm9ybWF0LXZlcnNpb249IjEuMCI+CiAgICAgICAgPHJkc1RlbXBsYXRlcz4KICAgICAgICAgIDxyZHNUZW1wbGF0ZT4KICAgICAgICAgICAgPGdyb3VwTmFtZT4lczwvZ3JvdXBOYW1lPgogICAgICAgICAgICA8cmRzU2VydmVySVBWNHM+CiAgICAgICAgICAgICAgPHJkc1NlcnZlcklQVjQ+CiAgICAgICAgICAgICAgICA8c2VydmVyVHlwZT48L3NlcnZlclR5cGU+CiAgICAgICAgICAgICAgICA8c2VydmVySVBBZGRyZXNzPjwvc2VydmVySVBBZGRyZXNzPgogICAgICAgICAgICAgICAgPHNlcnZlclBvcnQ+PC9zZXJ2ZXJQb3J0PgogICAgICAgICAgICAgICAgPHNlcnZlck1vZGU+PC9zZXJ2ZXJNb2RlPgogICAgICAgICAgICAgICAgPHZwbk5hbWU+PC92cG5OYW1lPgogICAgICAgICAgICAgIDwvcmRzU2VydmVySVBWND4KICAgICAgICAgICAgPC9yZHNTZXJ2ZXJJUFY0cz4KICAgICAgICAgIDwvcmRzVGVtcGxhdGU+CiAgICAgICAgPC9yZHNUZW1wbGF0ZXM+CiAgICAgIDwvcmFkaXVzPgogICAgPC9maWx0ZXI+CiIiIgoKIyBtZXJnZSByYWRpdXMgc2VydmVyIGNvbmZpZyBpcHY0CkNFX01FUkdFX1JBRElVU19TRVJWRVJfQ0ZHX0lQVjQgPSAiIiIKICAgIDxjb25maWc+CiAgICAgIDxyYWRpdXMgeG1sbnM9Imh0dHA6Ly93d3cuaHVhd2VpLmNvbS9uZXRjb25mL3ZycCIgY29udGVudC12ZXJzaW9uPSIxLjAiIGZvcm1hdC12ZXJzaW9uPSIxLjAiPgogICAgICAgIDxyZHNUZW1wbGF0ZXM+CiAgICAgICAgICA8cmRzVGVtcGxhdGU+CiAgICAgICAgICAgIDxncm91cE5hbWU+JXM8L2dyb3VwTmFtZT4KICAgICAgICAgICAgPHJkc1NlcnZlcklQVjRzPgogICAgICAgICAgICAgIDxyZHNTZXJ2ZXJJUFY0IG9wZXJhdGlvbj0ibWVyZ2UiPgogICAgICAgICAgICAgICAgPHNlcnZlclR5cGU+JXM8L3NlcnZlclR5cGU+CiAgICAgICAgICAgICAgICA8c2VydmVySVBBZGRyZXNzPiVzPC9zZXJ2ZXJJUEFkZHJlc3M+CiAgICAgICAgICAgICAgICA8c2VydmVyUG9ydD4lczwvc2VydmVyUG9ydD4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJNb2RlPiVzPC9zZXJ2ZXJNb2RlPgogICAgICAgICAgICAgICAgPHZwbk5hbWU+JXM8L3Zwbk5hbWU+CiAgICAgICAgICAgICAgPC9yZHNTZXJ2ZXJJUFY0PgogICAgICAgICAgICA8L3Jkc1NlcnZlcklQVjRzPgogICAgICAgICAgPC9yZHNUZW1wbGF0ZT4KICAgICAgICA8L3Jkc1RlbXBsYXRlcz4KICAgICAgPC9yYWRpdXM+CiAgICA8L2NvbmZpZz4KIiIiCgojIGRlbGV0ZSByYWRpdXMgc2VydmVyIGNvbmZpZyBpcHY0CkNFX0RFTEVURV9SQURJVVNfU0VSVkVSX0NGR19JUFY0ID0gIiIiCiAgICA8Y29uZmlnPgogICAgICA8cmFkaXVzIHhtbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiIGNvbnRlbnQtdmVyc2lvbj0iMS4wIiBmb3JtYXQtdmVyc2lvbj0iMS4wIj4KICAgICAgICA8cmRzVGVtcGxhdGVzPgogICAgICAgICAgPHJkc1RlbXBsYXRlPgogICAgICAgICAgICA8Z3JvdXBOYW1lPiVzPC9ncm91cE5hbWU+CiAgICAgICAgICAgIDxyZHNTZXJ2ZXJJUFY0cz4KICAgICAgICAgICAgICA8cmRzU2VydmVySVBWNCBvcGVyYXRpb249ImRlbGV0ZSI+CiAgICAgICAgICAgICAgICA8c2VydmVyVHlwZT4lczwvc2VydmVyVHlwZT4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJJUEFkZHJlc3M+JXM8L3NlcnZlcklQQWRkcmVzcz4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJQb3J0PiVzPC9zZXJ2ZXJQb3J0PgogICAgICAgICAgICAgICAgPHNlcnZlck1vZGU+JXM8L3NlcnZlck1vZGU+CiAgICAgICAgICAgICAgICA8dnBuTmFtZT4lczwvdnBuTmFtZT4KICAgICAgICAgICAgICA8L3Jkc1NlcnZlcklQVjQ+CiAgICAgICAgICAgIDwvcmRzU2VydmVySVBWNHM+CiAgICAgICAgICA8L3Jkc1RlbXBsYXRlPgogICAgICAgIDwvcmRzVGVtcGxhdGVzPgogICAgICA8L3JhZGl1cz4KICAgIDwvY29uZmlnPgoiIiIKCiMgZ2V0IHJhZGl1cyBzZXJ2ZXIgY29uZmlnIGlwdjYKQ0VfR0VUX1JBRElVU19TRVJWRVJfQ0ZHX0lQVjYgPSAiIiIKICAgIDxmaWx0ZXIgdHlwZT0ic3VidHJlZSI+CiAgICAgIDxyYWRpdXMgeG1sbnM9Imh0dHA6Ly93d3cuaHVhd2VpLmNvbS9uZXRjb25mL3ZycCIgY29udGVudC12ZXJzaW9uPSIxLjAiIGZvcm1hdC12ZXJzaW9uPSIxLjAiPgogICAgICAgIDxyZHNUZW1wbGF0ZXM+CiAgICAgICAgICA8cmRzVGVtcGxhdGU+CiAgICAgICAgICAgIDxncm91cE5hbWU+JXM8L2dyb3VwTmFtZT4KICAgICAgICAgICAgPHJkc1NlcnZlcklQVjZzPgogICAgICAgICAgICAgIDxyZHNTZXJ2ZXJJUFY2PgogICAgICAgICAgICAgICAgPHNlcnZlclR5cGU+PC9zZXJ2ZXJUeXBlPgogICAgICAgICAgICAgICAgPHNlcnZlcklQQWRkcmVzcz48L3NlcnZlcklQQWRkcmVzcz4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJQb3J0Pjwvc2VydmVyUG9ydD4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJNb2RlPjwvc2VydmVyTW9kZT4KICAgICAgICAgICAgICA8L3Jkc1NlcnZlcklQVjY+CiAgICAgICAgICAgIDwvcmRzU2VydmVySVBWNnM+CiAgICAgICAgICA8L3Jkc1RlbXBsYXRlPgogICAgICAgIDwvcmRzVGVtcGxhdGVzPgogICAgICA8L3JhZGl1cz4KICAgIDwvZmlsdGVyPgoiIiIKCiMgbWVyZ2UgcmFkaXVzIHNlcnZlciBjb25maWcgaXB2NgpDRV9NRVJHRV9SQURJVVNfU0VSVkVSX0NGR19JUFY2ID0gIiIiCiAgICA8Y29uZmlnPgogICAgICA8cmFkaXVzIHhtbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiIGNvbnRlbnQtdmVyc2lvbj0iMS4wIiBmb3JtYXQtdmVyc2lvbj0iMS4wIj4KICAgICAgICA8cmRzVGVtcGxhdGVzPgogICAgICAgICAgPHJkc1RlbXBsYXRlPgogICAgICAgICAgICA8Z3JvdXBOYW1lPiVzPC9ncm91cE5hbWU+CiAgICAgICAgICAgIDxyZHNTZXJ2ZXJJUFY2cz4KICAgICAgICAgICAgICA8cmRzU2VydmVySVBWNiBvcGVyYXRpb249Im1lcmdlIj4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJUeXBlPiVzPC9zZXJ2ZXJUeXBlPgogICAgICAgICAgICAgICAgPHNlcnZlcklQQWRkcmVzcz4lczwvc2VydmVySVBBZGRyZXNzPgogICAgICAgICAgICAgICAgPHNlcnZlclBvcnQ+JXM8L3NlcnZlclBvcnQ+CiAgICAgICAgICAgICAgICA8c2VydmVyTW9kZT4lczwvc2VydmVyTW9kZT4KICAgICAgICAgICAgICA8L3Jkc1NlcnZlcklQVjY+CiAgICAgICAgICAgIDwvcmRzU2VydmVySVBWNnM+CiAgICAgICAgICA8L3Jkc1RlbXBsYXRlPgogICAgICAgIDwvcmRzVGVtcGxhdGVzPgogICAgICA8L3JhZGl1cz4KICAgIDwvY29uZmlnPgoiIiIKCiMgZGVsZXRlIHJhZGl1cyBzZXJ2ZXIgY29uZmlnIGlwdjYKQ0VfREVMRVRFX1JBRElVU19TRVJWRVJfQ0ZHX0lQVjYgPSAiIiIKICAgIDxjb25maWc+CiAgICAgIDxyYWRpdXMgeG1sbnM9Imh0dHA6Ly93d3cuaHVhd2VpLmNvbS9uZXRjb25mL3ZycCIgY29udGVudC12ZXJzaW9uPSIxLjAiIGZvcm1hdC12ZXJzaW9uPSIxLjAiPgogICAgICAgIDxyZHNUZW1wbGF0ZXM+CiAgICAgICAgICA8cmRzVGVtcGxhdGU+CiAgICAgICAgICAgIDxncm91cE5hbWU+JXM8L2dyb3VwTmFtZT4KICAgICAgICAgICAgPHJkc1NlcnZlcklQVjZzPgogICAgICAgICAgICAgIDxyZHNTZXJ2ZXJJUFY2IG9wZXJhdGlvbj0iZGVsZXRlIj4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJUeXBlPiVzPC9zZXJ2ZXJUeXBlPgogICAgICAgICAgICAgICAgPHNlcnZlcklQQWRkcmVzcz4lczwvc2VydmVySVBBZGRyZXNzPgogICAgICAgICAgICAgICAgPHNlcnZlclBvcnQ+JXM8L3NlcnZlclBvcnQ+CiAgICAgICAgICAgICAgICA8c2VydmVyTW9kZT4lczwvc2VydmVyTW9kZT4KICAgICAgICAgICAgICA8L3Jkc1NlcnZlcklQVjY+CiAgICAgICAgICAgIDwvcmRzU2VydmVySVBWNnM+CiAgICAgICAgICA8L3Jkc1RlbXBsYXRlPgogICAgICAgIDwvcmRzVGVtcGxhdGVzPgogICAgICA8L3JhZGl1cz4KICAgIDwvY29uZmlnPgoiIiIKCiMgZ2V0IHJhZGl1cyBzZXJ2ZXIgbmFtZQpDRV9HRVRfUkFESVVTX1NFUlZFUl9OQU1FID0gIiIiCiAgICA8ZmlsdGVyIHR5cGU9InN1YnRyZWUiPgogICAgICA8cmFkaXVzIHhtbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiIGNvbnRlbnQtdmVyc2lvbj0iMS4wIiBmb3JtYXQtdmVyc2lvbj0iMS4wIj4KICAgICAgICA8cmRzVGVtcGxhdGVzPgogICAgICAgICAgPHJkc1RlbXBsYXRlPgogICAgICAgICAgICA8Z3JvdXBOYW1lPiVzPC9ncm91cE5hbWU+CiAgICAgICAgICAgIDxyZHNTZXJ2ZXJOYW1lcz4KICAgICAgICAgICAgICA8cmRzU2VydmVyTmFtZT4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJUeXBlPjwvc2VydmVyVHlwZT4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJOYW1lPjwvc2VydmVyTmFtZT4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJQb3J0Pjwvc2VydmVyUG9ydD4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJNb2RlPjwvc2VydmVyTW9kZT4KICAgICAgICAgICAgICAgIDx2cG5OYW1lPjwvdnBuTmFtZT4KICAgICAgICAgICAgICA8L3Jkc1NlcnZlck5hbWU+CiAgICAgICAgICAgIDwvcmRzU2VydmVyTmFtZXM+CiAgICAgICAgICA8L3Jkc1RlbXBsYXRlPgogICAgICAgIDwvcmRzVGVtcGxhdGVzPgogICAgICA8L3JhZGl1cz4KICAgIDwvZmlsdGVyPgoiIiIKCiMgbWVyZ2UgcmFkaXVzIHNlcnZlciBuYW1lCkNFX01FUkdFX1JBRElVU19TRVJWRVJfTkFNRSA9ICIiIgogICAgPGNvbmZpZz4KICAgICAgPHJhZGl1cyB4bWxucz0iaHR0cDovL3d3dy5odWF3ZWkuY29tL25ldGNvbmYvdnJwIiBjb250ZW50LXZlcnNpb249IjEuMCIgZm9ybWF0LXZlcnNpb249IjEuMCI+CiAgICAgICAgPHJkc1RlbXBsYXRlcz4KICAgICAgICAgIDxyZHNUZW1wbGF0ZT4KICAgICAgICAgICAgPGdyb3VwTmFtZT4lczwvZ3JvdXBOYW1lPgogICAgICAgICAgICA8cmRzU2VydmVyTmFtZXM+CiAgICAgICAgICAgICAgPHJkc1NlcnZlck5hbWUgb3BlcmF0aW9uPSJtZXJnZSI+CiAgICAgICAgICAgICAgICA8c2VydmVyVHlwZT4lczwvc2VydmVyVHlwZT4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJOYW1lPiVzPC9zZXJ2ZXJOYW1lPgogICAgICAgICAgICAgICAgPHNlcnZlclBvcnQ+JXM8L3NlcnZlclBvcnQ+CiAgICAgICAgICAgICAgICA8c2VydmVyTW9kZT4lczwvc2VydmVyTW9kZT4KICAgICAgICAgICAgICAgIDx2cG5OYW1lPiVzPC92cG5OYW1lPgogICAgICAgICAgICAgIDwvcmRzU2VydmVyTmFtZT4KICAgICAgICAgICAgPC9yZHNTZXJ2ZXJOYW1lcz4KICAgICAgICAgIDwvcmRzVGVtcGxhdGU+CiAgICAgICAgPC9yZHNUZW1wbGF0ZXM+CiAgICAgIDwvcmFkaXVzPgogICAgPC9jb25maWc+CiIiIgoKIyBkZWxldGUgcmFkaXVzIHNlcnZlciBuYW1lCkNFX0RFTEVURV9SQURJVVNfU0VSVkVSX05BTUUgPSAiIiIKICAgIDxjb25maWc+CiAgICAgIDxyYWRpdXMgeG1sbnM9Imh0dHA6Ly93d3cuaHVhd2VpLmNvbS9uZXRjb25mL3ZycCIgY29udGVudC12ZXJzaW9uPSIxLjAiIGZvcm1hdC12ZXJzaW9uPSIxLjAiPgogICAgICAgIDxyZHNUZW1wbGF0ZXM+CiAgICAgICAgICA8cmRzVGVtcGxhdGU+CiAgICAgICAgICAgIDxncm91cE5hbWU+JXM8L2dyb3VwTmFtZT4KICAgICAgICAgICAgPHJkc1NlcnZlck5hbWVzPgogICAgICAgICAgICAgIDxyZHNTZXJ2ZXJOYW1lIG9wZXJhdGlvbj0iZGVsZXRlIj4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJUeXBlPiVzPC9zZXJ2ZXJUeXBlPgogICAgICAgICAgICAgICAgPHNlcnZlck5hbWU+JXM8L3NlcnZlck5hbWU+CiAgICAgICAgICAgICAgICA8c2VydmVyUG9ydD4lczwvc2VydmVyUG9ydD4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJNb2RlPiVzPC9zZXJ2ZXJNb2RlPgogICAgICAgICAgICAgICAgPHZwbk5hbWU+JXM8L3Zwbk5hbWU+CiAgICAgICAgICAgICAgPC9yZHNTZXJ2ZXJOYW1lPgogICAgICAgICAgICA8L3Jkc1NlcnZlck5hbWVzPgogICAgICAgICAgPC9yZHNUZW1wbGF0ZT4KICAgICAgICA8L3Jkc1RlbXBsYXRlcz4KICAgICAgPC9yYWRpdXM+CiAgICA8L2NvbmZpZz4KIiIiCgojIGdldCBod3RhY2FjcyBzZXJ2ZXIgY29uZmlnIGlwdjQKQ0VfR0VUX0hXVEFDQUNTX1NFUlZFUl9DRkdfSVBWNCA9ICIiIgogICAgPGZpbHRlciB0eXBlPSJzdWJ0cmVlIj4KICAgICAgPGh3dGFjYWNzIHhtbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiIGNvbnRlbnQtdmVyc2lvbj0iMS4wIiBmb3JtYXQtdmVyc2lvbj0iMS4wIj4KICAgICAgICA8aHdUYWNUZW1wQ2Zncz4KICAgICAgICAgIDxod1RhY1RlbXBDZmc+CiAgICAgICAgICAgIDx0ZW1wbGF0ZU5hbWU+JXM8L3RlbXBsYXRlTmFtZT4KICAgICAgICAgICAgPGh3VGFjU3J2Q2Zncz4KICAgICAgICAgICAgICA8aHdUYWNTcnZDZmc+CiAgICAgICAgICAgICAgICA8c2VydmVySXBBZGRyZXNzPjwvc2VydmVySXBBZGRyZXNzPgogICAgICAgICAgICAgICAgPHNlcnZlclR5cGU+PC9zZXJ2ZXJUeXBlPgogICAgICAgICAgICAgICAgPGlzU2Vjb25kYXJ5U2VydmVyPjwvaXNTZWNvbmRhcnlTZXJ2ZXI+CiAgICAgICAgICAgICAgICA8dnBuTmFtZT48L3Zwbk5hbWU+CiAgICAgICAgICAgICAgICA8aXNQdWJsaWNOZXQ+PC9pc1B1YmxpY05ldD4KICAgICAgICAgICAgICA8L2h3VGFjU3J2Q2ZnPgogICAgICAgICAgICA8L2h3VGFjU3J2Q2Zncz4KICAgICAgICAgIDwvaHdUYWNUZW1wQ2ZnPgogICAgICAgIDwvaHdUYWNUZW1wQ2Zncz4KICAgICAgPC9od3RhY2Fjcz4KICAgIDwvZmlsdGVyPgoiIiIKCiMgbWVyZ2UgaHd0YWNhY3Mgc2VydmVyIGNvbmZpZyBpcHY0CkNFX01FUkdFX0hXVEFDQUNTX1NFUlZFUl9DRkdfSVBWNCA9ICIiIgogICAgPGNvbmZpZz4KICAgICAgPGh3dGFjYWNzIHhtbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiIGNvbnRlbnQtdmVyc2lvbj0iMS4wIiBmb3JtYXQtdmVyc2lvbj0iMS4wIj4KICAgICAgICA8aHdUYWNUZW1wQ2Zncz4KICAgICAgICAgIDxod1RhY1RlbXBDZmc+CiAgICAgICAgICAgIDx0ZW1wbGF0ZU5hbWU+JXM8L3RlbXBsYXRlTmFtZT4KICAgICAgICAgICAgPGh3VGFjU3J2Q2Zncz4KICAgICAgICAgICAgICA8aHdUYWNTcnZDZmcgb3BlcmF0aW9uPSJtZXJnZSI+CiAgICAgICAgICAgICAgICA8c2VydmVySXBBZGRyZXNzPiVzPC9zZXJ2ZXJJcEFkZHJlc3M+CiAgICAgICAgICAgICAgICA8c2VydmVyVHlwZT4lczwvc2VydmVyVHlwZT4KICAgICAgICAgICAgICAgIDxpc1NlY29uZGFyeVNlcnZlcj4lczwvaXNTZWNvbmRhcnlTZXJ2ZXI+CiAgICAgICAgICAgICAgICA8dnBuTmFtZT4lczwvdnBuTmFtZT4KICAgICAgICAgICAgICAgIDxpc1B1YmxpY05ldD4lczwvaXNQdWJsaWNOZXQ+CiAgICAgICAgICAgICAgPC9od1RhY1NydkNmZz4KICAgICAgICAgICAgPC9od1RhY1NydkNmZ3M+CiAgICAgICAgICA8L2h3VGFjVGVtcENmZz4KICAgICAgICA8L2h3VGFjVGVtcENmZ3M+CiAgICAgIDwvaHd0YWNhY3M+CiAgICA8L2NvbmZpZz4KIiIiCgojIGRlbGV0ZSBod3RhY2FjcyBzZXJ2ZXIgY29uZmlnIGlwdjQKQ0VfREVMRVRFX0hXVEFDQUNTX1NFUlZFUl9DRkdfSVBWNCA9ICIiIgogICAgPGNvbmZpZz4KICAgICAgPGh3dGFjYWNzIHhtbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiIGNvbnRlbnQtdmVyc2lvbj0iMS4wIiBmb3JtYXQtdmVyc2lvbj0iMS4wIj4KICAgICAgICA8aHdUYWNUZW1wQ2Zncz4KICAgICAgICAgIDxod1RhY1RlbXBDZmc+CiAgICAgICAgICAgIDx0ZW1wbGF0ZU5hbWU+JXM8L3RlbXBsYXRlTmFtZT4KICAgICAgICAgICAgPGh3VGFjU3J2Q2Zncz4KICAgICAgICAgICAgICA8aHdUYWNTcnZDZmcgb3BlcmF0aW9uPSJkZWxldGUiPgogICAgICAgICAgICAgICAgPHNlcnZlcklwQWRkcmVzcz4lczwvc2VydmVySXBBZGRyZXNzPgogICAgICAgICAgICAgICAgPHNlcnZlclR5cGU+JXM8L3NlcnZlclR5cGU+CiAgICAgICAgICAgICAgICA8aXNTZWNvbmRhcnlTZXJ2ZXI+JXM8L2lzU2Vjb25kYXJ5U2VydmVyPgogICAgICAgICAgICAgICAgPHZwbk5hbWU+JXM8L3Zwbk5hbWU+CiAgICAgICAgICAgICAgICA8aXNQdWJsaWNOZXQ+JXM8L2lzUHVibGljTmV0PgogICAgICAgICAgICAgIDwvaHdUYWNTcnZDZmc+CiAgICAgICAgICAgIDwvaHdUYWNTcnZDZmdzPgogICAgICAgICAgPC9od1RhY1RlbXBDZmc+CiAgICAgICAgPC9od1RhY1RlbXBDZmdzPgogICAgICA8L2h3dGFjYWNzPgogICAgPC9jb25maWc+CiIiIgoKIyBnZXQgaHd0YWNhY3Mgc2VydmVyIGNvbmZpZyBpcHY2CkNFX0dFVF9IV1RBQ0FDU19TRVJWRVJfQ0ZHX0lQVjYgPSAiIiIKICAgIDxmaWx0ZXIgdHlwZT0ic3VidHJlZSI+CiAgICAgIDxod3RhY2FjcyB4bWxucz0iaHR0cDovL3d3dy5odWF3ZWkuY29tL25ldGNvbmYvdnJwIiBjb250ZW50LXZlcnNpb249IjEuMCIgZm9ybWF0LXZlcnNpb249IjEuMCI+CiAgICAgICAgPGh3VGFjVGVtcENmZ3M+CiAgICAgICAgICA8aHdUYWNUZW1wQ2ZnPgogICAgICAgICAgICA8dGVtcGxhdGVOYW1lPiVzPC90ZW1wbGF0ZU5hbWU+CiAgICAgICAgICAgIDxod1RhY0lwdjZTcnZDZmdzPgogICAgICAgICAgICAgIDxod1RhY0lwdjZTcnZDZmc+CiAgICAgICAgICAgICAgICA8c2VydmVySXBBZGRyZXNzPjwvc2VydmVySXBBZGRyZXNzPgogICAgICAgICAgICAgICAgPHNlcnZlclR5cGU+PC9zZXJ2ZXJUeXBlPgogICAgICAgICAgICAgICAgPGlzU2Vjb25kYXJ5U2VydmVyPjwvaXNTZWNvbmRhcnlTZXJ2ZXI+CiAgICAgICAgICAgICAgICA8dnBuTmFtZT48L3Zwbk5hbWU+CiAgICAgICAgICAgICAgPC9od1RhY0lwdjZTcnZDZmc+CiAgICAgICAgICAgIDwvaHdUYWNJcHY2U3J2Q2Zncz4KICAgICAgICAgIDwvaHdUYWNUZW1wQ2ZnPgogICAgICAgIDwvaHdUYWNUZW1wQ2Zncz4KICAgICAgPC9od3RhY2Fjcz4KICAgIDwvZmlsdGVyPgoiIiIKCiMgbWVyZ2UgaHd0YWNhY3Mgc2VydmVyIGNvbmZpZyBpcHY2CkNFX01FUkdFX0hXVEFDQUNTX1NFUlZFUl9DRkdfSVBWNiA9ICIiIgogICAgPGNvbmZpZz4KICAgICAgPGh3dGFjYWNzIHhtbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiIGNvbnRlbnQtdmVyc2lvbj0iMS4wIiBmb3JtYXQtdmVyc2lvbj0iMS4wIj4KICAgICAgICA8aHdUYWNUZW1wQ2Zncz4KICAgICAgICAgIDxod1RhY1RlbXBDZmc+CiAgICAgICAgICAgIDx0ZW1wbGF0ZU5hbWU+JXM8L3RlbXBsYXRlTmFtZT4KICAgICAgICAgICAgPGh3VGFjSXB2NlNydkNmZ3M+CiAgICAgICAgICAgICAgPGh3VGFjSXB2NlNydkNmZyBvcGVyYXRpb249Im1lcmdlIj4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJJcEFkZHJlc3M+JXM8L3NlcnZlcklwQWRkcmVzcz4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJUeXBlPiVzPC9zZXJ2ZXJUeXBlPgogICAgICAgICAgICAgICAgPGlzU2Vjb25kYXJ5U2VydmVyPiVzPC9pc1NlY29uZGFyeVNlcnZlcj4KICAgICAgICAgICAgICAgIDx2cG5OYW1lPiVzPC92cG5OYW1lPgogICAgICAgICAgICAgIDwvaHdUYWNJcHY2U3J2Q2ZnPgogICAgICAgICAgICA8L2h3VGFjSXB2NlNydkNmZ3M+CiAgICAgICAgICA8L2h3VGFjVGVtcENmZz4KICAgICAgICA8L2h3VGFjVGVtcENmZ3M+CiAgICAgIDwvaHd0YWNhY3M+CiAgICA8L2NvbmZpZz4KIiIiCgojIGRlbGV0ZSBod3RhY2FjcyBzZXJ2ZXIgY29uZmlnIGlwdjYKQ0VfREVMRVRFX0hXVEFDQUNTX1NFUlZFUl9DRkdfSVBWNiA9ICIiIgogICAgPGNvbmZpZz4KICAgICAgPGh3dGFjYWNzIHhtbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiIGNvbnRlbnQtdmVyc2lvbj0iMS4wIiBmb3JtYXQtdmVyc2lvbj0iMS4wIj4KICAgICAgICA8aHdUYWNUZW1wQ2Zncz4KICAgICAgICAgIDxod1RhY1RlbXBDZmc+CiAgICAgICAgICAgIDx0ZW1wbGF0ZU5hbWU+JXM8L3RlbXBsYXRlTmFtZT4KICAgICAgICAgICAgPGh3VGFjSXB2NlNydkNmZ3M+CiAgICAgICAgICAgICAgPGh3VGFjSXB2NlNydkNmZyBvcGVyYXRpb249ImRlbGV0ZSI+CiAgICAgICAgICAgICAgICA8c2VydmVySXBBZGRyZXNzPiVzPC9zZXJ2ZXJJcEFkZHJlc3M+CiAgICAgICAgICAgICAgICA8c2VydmVyVHlwZT4lczwvc2VydmVyVHlwZT4KICAgICAgICAgICAgICAgIDxpc1NlY29uZGFyeVNlcnZlcj4lczwvaXNTZWNvbmRhcnlTZXJ2ZXI+CiAgICAgICAgICAgICAgICA8dnBuTmFtZT4lczwvdnBuTmFtZT4KICAgICAgICAgICAgICA8L2h3VGFjSXB2NlNydkNmZz4KICAgICAgICAgICAgPC9od1RhY0lwdjZTcnZDZmdzPgogICAgICAgICAgPC9od1RhY1RlbXBDZmc+CiAgICAgICAgPC9od1RhY1RlbXBDZmdzPgogICAgICA8L2h3dGFjYWNzPgogICAgPC9jb25maWc+CiIiIgoKIyBnZXQgaHd0YWNhY3MgaG9zdCBzZXJ2ZXIgY29uZmlnCkNFX0dFVF9IV1RBQ0FDU19IT1NUX1NFUlZFUl9DRkcgPSAiIiIKICAgIDxmaWx0ZXIgdHlwZT0ic3VidHJlZSI+CiAgICAgIDxod3RhY2FjcyB4bWxucz0iaHR0cDovL3d3dy5odWF3ZWkuY29tL25ldGNvbmYvdnJwIiBjb250ZW50LXZlcnNpb249IjEuMCIgZm9ybWF0LXZlcnNpb249IjEuMCI+CiAgICAgICAgPGh3VGFjVGVtcENmZ3M+CiAgICAgICAgICA8aHdUYWNUZW1wQ2ZnPgogICAgICAgICAgICA8dGVtcGxhdGVOYW1lPiVzPC90ZW1wbGF0ZU5hbWU+CiAgICAgICAgICAgIDxod1RhY0hvc3RTcnZDZmdzPgogICAgICAgICAgICAgIDxod1RhY0hvc3RTcnZDZmc+CiAgICAgICAgICAgICAgICA8c2VydmVySG9zdE5hbWU+PC9zZXJ2ZXJIb3N0TmFtZT4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJUeXBlPjwvc2VydmVyVHlwZT4KICAgICAgICAgICAgICAgIDxpc1NlY29uZGFyeVNlcnZlcj48L2lzU2Vjb25kYXJ5U2VydmVyPgogICAgICAgICAgICAgICAgPHZwbk5hbWU+PC92cG5OYW1lPgogICAgICAgICAgICAgICAgPGlzUHVibGljTmV0PjwvaXNQdWJsaWNOZXQ+CiAgICAgICAgICAgICAgPC9od1RhY0hvc3RTcnZDZmc+CiAgICAgICAgICAgIDwvaHdUYWNIb3N0U3J2Q2Zncz4KICAgICAgICAgIDwvaHdUYWNUZW1wQ2ZnPgogICAgICAgIDwvaHdUYWNUZW1wQ2Zncz4KICAgICAgPC9od3RhY2Fjcz4KICAgIDwvZmlsdGVyPgoiIiIKCiMgbWVyZ2UgaHd0YWNhY3MgaG9zdCBzZXJ2ZXIgY29uZmlnCkNFX01FUkdFX0hXVEFDQUNTX0hPU1RfU0VSVkVSX0NGRyA9ICIiIgogICAgPGNvbmZpZz4KICAgICAgPGh3dGFjYWNzIHhtbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiIGNvbnRlbnQtdmVyc2lvbj0iMS4wIiBmb3JtYXQtdmVyc2lvbj0iMS4wIj4KICAgICAgICA8aHdUYWNUZW1wQ2Zncz4KICAgICAgICAgIDxod1RhY1RlbXBDZmc+CiAgICAgICAgICAgIDx0ZW1wbGF0ZU5hbWU+JXM8L3RlbXBsYXRlTmFtZT4KICAgICAgICAgICAgPGh3VGFjSG9zdFNydkNmZ3M+CiAgICAgICAgICAgICAgPGh3VGFjSG9zdFNydkNmZyBvcGVyYXRpb249Im1lcmdlIj4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJIb3N0TmFtZT4lczwvc2VydmVySG9zdE5hbWU+CiAgICAgICAgICAgICAgICA8c2VydmVyVHlwZT4lczwvc2VydmVyVHlwZT4KICAgICAgICAgICAgICAgIDxpc1NlY29uZGFyeVNlcnZlcj4lczwvaXNTZWNvbmRhcnlTZXJ2ZXI+CiAgICAgICAgICAgICAgICA8dnBuTmFtZT4lczwvdnBuTmFtZT4KICAgICAgICAgICAgICAgIDxpc1B1YmxpY05ldD4lczwvaXNQdWJsaWNOZXQ+CiAgICAgICAgICAgICAgPC9od1RhY0hvc3RTcnZDZmc+CiAgICAgICAgICAgIDwvaHdUYWNIb3N0U3J2Q2Zncz4KICAgICAgICAgIDwvaHdUYWNUZW1wQ2ZnPgogICAgICAgIDwvaHdUYWNUZW1wQ2Zncz4KICAgICAgPC9od3RhY2Fjcz4KICAgIDwvY29uZmlnPgoiIiIKCiMgZGVsZXRlIGh3dGFjYWNzIGhvc3Qgc2VydmVyIGNvbmZpZwpDRV9ERUxFVEVfSFdUQUNBQ1NfSE9TVF9TRVJWRVJfQ0ZHID0gIiIiCiAgICA8Y29uZmlnPgogICAgICA8aHd0YWNhY3MgeG1sbnM9Imh0dHA6Ly93d3cuaHVhd2VpLmNvbS9uZXRjb25mL3ZycCIgY29udGVudC12ZXJzaW9uPSIxLjAiIGZvcm1hdC12ZXJzaW9uPSIxLjAiPgogICAgICAgIDxod1RhY1RlbXBDZmdzPgogICAgICAgICAgPGh3VGFjVGVtcENmZz4KICAgICAgICAgICAgPHRlbXBsYXRlTmFtZT4lczwvdGVtcGxhdGVOYW1lPgogICAgICAgICAgICA8aHdUYWNIb3N0U3J2Q2Zncz4KICAgICAgICAgICAgICA8aHdUYWNIb3N0U3J2Q2ZnIG9wZXJhdGlvbj0iZGVsZXRlIj4KICAgICAgICAgICAgICAgIDxzZXJ2ZXJIb3N0TmFtZT4lczwvc2VydmVySG9zdE5hbWU+CiAgICAgICAgICAgICAgICA8c2VydmVyVHlwZT4lczwvc2VydmVyVHlwZT4KICAgICAgICAgICAgICAgIDxpc1NlY29uZGFyeVNlcnZlcj4lczwvaXNTZWNvbmRhcnlTZXJ2ZXI+CiAgICAgICAgICAgICAgICA8dnBuTmFtZT4lczwvdnBuTmFtZT4KICAgICAgICAgICAgICAgIDxpc1B1YmxpY05ldD4lczwvaXNQdWJsaWNOZXQ+CiAgICAgICAgICAgICAgPC9od1RhY0hvc3RTcnZDZmc+CiAgICAgICAgICAgIDwvaHdUYWNIb3N0U3J2Q2Zncz4KICAgICAgICAgIDwvaHdUYWNUZW1wQ2ZnPgogICAgICAgIDwvaHdUYWNUZW1wQ2Zncz4KICAgICAgPC9od3RhY2Fjcz4KICAgIDwvY29uZmlnPgoiIiIKCgpjbGFzcyBBYWFTZXJ2ZXJIb3N0KG9iamVjdCk6CiAgICAiIiIgTWFuYWdlcyBhYWEgc2VydmVyIGhvc3QgY29uZmlndXJhdGlvbiAiIiIKCiAgICBkZWYgbmV0Y29uZl9nZXRfY29uZmlnKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAiIiIgR2V0IGNvbmZpZ3VyZSBieSBuZXRjb25mICIiIgoKICAgICAgICBtb2R1bGUgPSBrd2FyZ3NbIm1vZHVsZSJdCiAgICAgICAgY29uZl9zdHIgPSBrd2FyZ3NbImNvbmZfc3RyIl0KCiAgICAgICAgeG1sX3N0ciA9IGdldF9uY19jb25maWcobW9kdWxlLCBjb25mX3N0cikKCiAgICAgICAgcmV0dXJuIHhtbF9zdHIKCiAgICBkZWYgbmV0Y29uZl9zZXRfY29uZmlnKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAiIiIgU2V0IGNvbmZpZ3VyZSBieSBuZXRjb25mICIiIgoKICAgICAgICBtb2R1bGUgPSBrd2FyZ3NbIm1vZHVsZSJdCiAgICAgICAgY29uZl9zdHIgPSBrd2FyZ3NbImNvbmZfc3RyIl0KCiAgICAgICAgcmVjdl94bWwgPSBzZXRfbmNfY29uZmlnKG1vZHVsZSwgY29uZl9zdHIpCgogICAgICAgIHJldHVybiByZWN2X3htbAoKICAgIGRlZiBnZXRfbG9jYWxfdXNlcl9pbmZvKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAiIiIgR2V0IGxvY2FsIHVzZXIgaW5mb3JtYXRpb24gIiIiCgogICAgICAgIG1vZHVsZSA9IGt3YXJnc1sibW9kdWxlIl0KICAgICAgICBsb2NhbF91c2VyX25hbWUgPSBtb2R1bGUucGFyYW1zWydsb2NhbF91c2VyX25hbWUnXQogICAgICAgIGxvY2FsX3NlcnZpY2VfdHlwZSA9IG1vZHVsZS5wYXJhbXNbJ2xvY2FsX3NlcnZpY2VfdHlwZSddCiAgICAgICAgbG9jYWxfZnRwX2RpciA9IG1vZHVsZS5wYXJhbXNbJ2xvY2FsX2Z0cF9kaXInXQogICAgICAgIGxvY2FsX3VzZXJfbGV2ZWwgPSBtb2R1bGUucGFyYW1zWydsb2NhbF91c2VyX2xldmVsJ10KICAgICAgICBsb2NhbF91c2VyX2dyb3VwID0gbW9kdWxlLnBhcmFtc1snbG9jYWxfdXNlcl9ncm91cCddCiAgICAgICAgc3RhdGUgPSBtb2R1bGUucGFyYW1zWydzdGF0ZSddCgogICAgICAgIHJlc3VsdCA9IGRpY3QoKQogICAgICAgIHJlc3VsdFsibG9jYWxfdXNlcl9pbmZvIl0gPSBbXQogICAgICAgIG5lZWRfY2ZnID0gRmFsc2UKCiAgICAgICAgY29uZl9zdHIgPSBDRV9HRVRfTE9DQUxfVVNFUl9JTkZPX0hFQURFUgoKICAgICAgICBpZiBsb2NhbF9zZXJ2aWNlX3R5cGU6CiAgICAgICAgICAgIGlmIGxvY2FsX3NlcnZpY2VfdHlwZSA9PSAibm9uZSI6CiAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VUZXJtaW5hbD48L3NlcnZpY2VUZXJtaW5hbD4iCiAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VUZWxuZXQ+PC9zZXJ2aWNlVGVsbmV0PiIKICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8c2VydmljZUZ0cD48L3NlcnZpY2VGdHA+IgogICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjxzZXJ2aWNlU3NoPjwvc2VydmljZVNzaD4iCiAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VTbm1wPjwvc2VydmljZVNubXA+IgogICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjxzZXJ2aWNlRG90MXg+PC9zZXJ2aWNlRG90MXg+IgogICAgICAgICAgICBlbGlmIGxvY2FsX3NlcnZpY2VfdHlwZSA9PSAiZG90MXgiOgogICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjxzZXJ2aWNlRG90MXg+PC9zZXJ2aWNlRG90MXg+IgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb3B0aW9uID0gbG9jYWxfc2VydmljZV90eXBlLnNwbGl0KCIgIikKICAgICAgICAgICAgICAgIGZvciB0bXAgaW4gb3B0aW9uOgogICAgICAgICAgICAgICAgICAgIGlmIHRtcCA9PSAiZG90MXgiOgogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogRG8gbm90IGlucHV0IGRvdDF4IHdpdGggb3RoZXIgc2VydmljZSB0eXBlLicpCiAgICAgICAgICAgICAgICAgICAgZWxpZiB0bXAgPT0gIm5vbmUiOgogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogRG8gbm90IGlucHV0IG5vbmUgd2l0aCBvdGhlciBzZXJ2aWNlIHR5cGUuJykKICAgICAgICAgICAgICAgICAgICBlbGlmIHRtcCA9PSAiZnRwIjoKICAgICAgICAgICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjxzZXJ2aWNlRnRwPjwvc2VydmljZUZ0cD4iCiAgICAgICAgICAgICAgICAgICAgZWxpZiB0bXAgPT0gInNubXAiOgogICAgICAgICAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VTbm1wPjwvc2VydmljZVNubXA+IgogICAgICAgICAgICAgICAgICAgIGVsaWYgdG1wID09ICJzc2giOgogICAgICAgICAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VTc2g+PC9zZXJ2aWNlU3NoPiIKICAgICAgICAgICAgICAgICAgICBlbGlmIHRtcCA9PSAidGVsbmV0IjoKICAgICAgICAgICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjxzZXJ2aWNlVGVsbmV0Pjwvc2VydmljZVRlbG5ldD4iCiAgICAgICAgICAgICAgICAgICAgZWxpZiB0bXAgPT0gInRlcm1pbmFsIjoKICAgICAgICAgICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjxzZXJ2aWNlVGVybWluYWw+PC9zZXJ2aWNlVGVybWluYWw+IgogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2c9J0Vycm9yOiBEbyBub3Qgc3VwcG9ydCB0aGUgdHlwZSBbJXNdLicgJSB0bXApCgogICAgICAgIGlmIGxvY2FsX2Z0cF9kaXI6CiAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8ZnRwRGlyPjwvZnRwRGlyPiIKCiAgICAgICAgaWYgbG9jYWxfdXNlcl9sZXZlbDoKICAgICAgICAgICAgY29uZl9zdHIgKz0gIjx1c2VyTGV2ZWw+PC91c2VyTGV2ZWw+IgoKICAgICAgICBpZiBsb2NhbF91c2VyX2dyb3VwOgogICAgICAgICAgICBjb25mX3N0ciArPSAiPHVzZXJHcm91cE5hbWU+PC91c2VyR3JvdXBOYW1lPiIKCiAgICAgICAgY29uZl9zdHIgKz0gQ0VfR0VUX0xPQ0FMX1VTRVJfSU5GT19UQUlMCgogICAgICAgIHJlY3ZfeG1sID0gc2VsZi5uZXRjb25mX2dldF9jb25maWcobW9kdWxlPW1vZHVsZSwgY29uZl9zdHI9Y29uZl9zdHIpCgogICAgICAgIGlmICI8ZGF0YS8+IiBpbiByZWN2X3htbDoKICAgICAgICAgICAgaWYgc3RhdGUgPT0gInByZXNlbnQiOgogICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHhtbF9zdHIgPSByZWN2X3htbC5yZXBsYWNlKCdccicsICcnKS5yZXBsYWNlKCdcbicsICcnKS5cCiAgICAgICAgICAgICAgICByZXBsYWNlKCd4bWxucz0idXJuOmlldGY6cGFyYW1zOnhtbDpuczpuZXRjb25mOmJhc2U6MS4wIicsICIiKS5cCiAgICAgICAgICAgICAgICByZXBsYWNlKCd4bWxucz0iaHR0cDovL3d3dy5odWF3ZWkuY29tL25ldGNvbmYvdnJwIicsICIiKQoKICAgICAgICAgICAgcm9vdCA9IEVsZW1lbnRUcmVlLmZyb21zdHJpbmcoeG1sX3N0cikKICAgICAgICAgICAgbG9jYWxfdXNlcl9pbmZvID0gcm9vdC5maW5kYWxsKCJkYXRhL2FhYS9sYW0vdXNlcnMvdXNlciIpCiAgICAgICAgICAgIGlmIGxvY2FsX3VzZXJfaW5mbzoKICAgICAgICAgICAgICAgIGZvciB0bXAgaW4gbG9jYWxfdXNlcl9pbmZvOgogICAgICAgICAgICAgICAgICAgIHRtcF9kaWN0ID0gZGljdCgpCiAgICAgICAgICAgICAgICAgICAgZm9yIHNpdGUgaW4gdG1wOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzaXRlLnRhZyBpbiBbInVzZXJOYW1lIiwgInBhc3N3b3JkIiwgInVzZXJMZXZlbCIsICJmdHBEaXIiLCAidXNlckdyb3VwTmFtZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAic2VydmljZVRlcm1pbmFsIiwgInNlcnZpY2VUZWxuZXQiLCAic2VydmljZUZ0cCIsICJzZXJ2aWNlU3NoIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzZXJ2aWNlU25tcCIsICJzZXJ2aWNlRG90MXgiXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcF9kaWN0W3NpdGUudGFnXSA9IHNpdGUudGV4dAoKICAgICAgICAgICAgICAgICAgICByZXN1bHRbImxvY2FsX3VzZXJfaW5mbyJdLmFwcGVuZCh0bXBfZGljdCkKCiAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgaWYgcmVzdWx0WyJsb2NhbF91c2VyX2luZm8iXToKICAgICAgICAgICAgICAgICAgICBmb3IgdG1wIGluIHJlc3VsdFsibG9jYWxfdXNlcl9pbmZvIl06CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICJ1c2VyTmFtZSIgaW4gdG1wLmtleXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsidXNlck5hbWUiXSA9PSBsb2NhbF91c2VyX25hbWU6CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBsb2NhbF9zZXJ2aWNlX3R5cGUgYW5kIG5vdCBsb2NhbF91c2VyX2xldmVsIFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBub3QgbG9jYWxfZnRwX2RpciBhbmQgbm90IGxvY2FsX3VzZXJfZ3JvdXA6CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbG9jYWxfc2VydmljZV90eXBlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsb2NhbF9zZXJ2aWNlX3R5cGUgPT0gIm5vbmUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wLmdldCgic2VydmljZVRlcm1pbmFsIikgPT0gInRydWUiIG9yIFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wLmdldCgic2VydmljZVRlbG5ldCIpID09ICJ0cnVlIiBvciBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcC5nZXQoInNlcnZpY2VGdHAiKSA9PSAidHJ1ZSIgb3IgXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXAuZ2V0KCJzZXJ2aWNlU3NoIikgPT0gInRydWUiIG9yIFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wLmdldCgic2VydmljZVNubXAiKSA9PSAidHJ1ZSIgb3IgXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXAuZ2V0KCJzZXJ2aWNlRG90MXgiKSA9PSAidHJ1ZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgbG9jYWxfc2VydmljZV90eXBlID09ICJkb3QxeCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXAuZ2V0KCJzZXJ2aWNlRG90MXgiKSA9PSAidHJ1ZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgdG1wID09ICJmdHAiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wLmdldCgic2VydmljZUZ0cCIpID09ICJ0cnVlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiB0bXAgPT0gInNubXAiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wLmdldCgic2VydmljZVNubXAiKSA9PSAidHJ1ZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgdG1wID09ICJzc2giOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wLmdldCgic2VydmljZVNzaCIpID09ICJ0cnVlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiB0bXAgPT0gInRlbG5ldCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXAuZ2V0KCJzZXJ2aWNlVGVsbmV0IikgPT0gInRydWUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGlmIHRtcCA9PSAidGVybWluYWwiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wLmdldCgic2VydmljZVRlcm1pbmFsIikgPT0gInRydWUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsb2NhbF91c2VyX2xldmVsOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXAuZ2V0KCJ1c2VyTGV2ZWwiKSA9PSBsb2NhbF91c2VyX2xldmVsOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxvY2FsX2Z0cF9kaXI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcC5nZXQoImZ0cERpciIpID09IGxvY2FsX2Z0cF9kaXI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbG9jYWxfdXNlcl9ncm91cDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wLmdldCgidXNlckdyb3VwTmFtZSIpID09IGxvY2FsX3VzZXJfZ3JvdXA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgcmVzdWx0WyJuZWVkX2NmZyJdID0gbmVlZF9jZmcKICAgICAgICByZXR1cm4gcmVzdWx0CgogICAgZGVmIG1lcmdlX2xvY2FsX3VzZXJfaW5mbyhzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgIiIiIE1lcmdlIGxvY2FsIHVzZXIgaW5mb3JtYXRpb24gYnkgbmV0Y29uZiAiIiIKCiAgICAgICAgbW9kdWxlID0ga3dhcmdzWyJtb2R1bGUiXQogICAgICAgIGxvY2FsX3VzZXJfbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ2xvY2FsX3VzZXJfbmFtZSddCiAgICAgICAgbG9jYWxfcGFzc3dvcmQgPSBtb2R1bGUucGFyYW1zWydsb2NhbF9wYXNzd29yZCddCiAgICAgICAgbG9jYWxfc2VydmljZV90eXBlID0gbW9kdWxlLnBhcmFtc1snbG9jYWxfc2VydmljZV90eXBlJ10KICAgICAgICBsb2NhbF9mdHBfZGlyID0gbW9kdWxlLnBhcmFtc1snbG9jYWxfZnRwX2RpciddCiAgICAgICAgbG9jYWxfdXNlcl9sZXZlbCA9IG1vZHVsZS5wYXJhbXNbJ2xvY2FsX3VzZXJfbGV2ZWwnXQogICAgICAgIGxvY2FsX3VzZXJfZ3JvdXAgPSBtb2R1bGUucGFyYW1zWydsb2NhbF91c2VyX2dyb3VwJ10KICAgICAgICBzdGF0ZSA9IG1vZHVsZS5wYXJhbXNbJ3N0YXRlJ10KCiAgICAgICAgY21kcyA9IFtdCgogICAgICAgIGNvbmZfc3RyID0gQ0VfTUVSR0VfTE9DQUxfVVNFUl9JTkZPX0hFQURFUiAlIGxvY2FsX3VzZXJfbmFtZQoKICAgICAgICBpZiBsb2NhbF9wYXNzd29yZDoKICAgICAgICAgICAgY29uZl9zdHIgKz0gIjxwYXNzd29yZD4lczwvcGFzc3dvcmQ+IiAlIGxvY2FsX3Bhc3N3b3JkCgogICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgY21kID0gImxvY2FsLXVzZXIgJXMgcGFzc3dvcmQgY2lwaGVyICVzIiAlICgKICAgICAgICAgICAgICAgIGxvY2FsX3VzZXJfbmFtZSwgbG9jYWxfcGFzc3dvcmQpCiAgICAgICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKCiAgICAgICAgaWYgbG9jYWxfc2VydmljZV90eXBlOgogICAgICAgICAgICBpZiBsb2NhbF9zZXJ2aWNlX3R5cGUgPT0gIm5vbmUiOgogICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjxzZXJ2aWNlVGVybWluYWw+ZmFsc2U8L3NlcnZpY2VUZXJtaW5hbD4iCiAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VUZWxuZXQ+ZmFsc2U8L3NlcnZpY2VUZWxuZXQ+IgogICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjxzZXJ2aWNlRnRwPmZhbHNlPC9zZXJ2aWNlRnRwPiIKICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8c2VydmljZVNzaD5mYWxzZTwvc2VydmljZVNzaD4iCiAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VTbm1wPmZhbHNlPC9zZXJ2aWNlU25tcD4iCiAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VEb3QxeD5mYWxzZTwvc2VydmljZURvdDF4PiIKCiAgICAgICAgICAgICAgICBjbWQgPSAibG9jYWwtdXNlciAlcyBzZXJ2aWNlLXR5cGUgbm9uZSIgJSBsb2NhbF91c2VyX25hbWUKICAgICAgICAgICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKCiAgICAgICAgICAgIGVsaWYgbG9jYWxfc2VydmljZV90eXBlID09ICJkb3QxeCI6CiAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjxzZXJ2aWNlRG90MXg+dHJ1ZTwvc2VydmljZURvdDF4PiIKICAgICAgICAgICAgICAgICAgICBjbWQgPSAibG9jYWwtdXNlciAlcyBzZXJ2aWNlLXR5cGUgZG90MXgiICUgbG9jYWxfdXNlcl9uYW1lCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8c2VydmljZURvdDF4PmZhbHNlPC9zZXJ2aWNlRG90MXg+IgogICAgICAgICAgICAgICAgICAgIGNtZCA9ICJ1bmRvIGxvY2FsLXVzZXIgJXMgc2VydmljZS10eXBlIiAlIGxvY2FsX3VzZXJfbmFtZQoKICAgICAgICAgICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBvcHRpb24gPSBsb2NhbF9zZXJ2aWNlX3R5cGUuc3BsaXQoIiAiKQogICAgICAgICAgICAgICAgZm9yIHRtcCBpbiBvcHRpb246CiAgICAgICAgICAgICAgICAgICAgaWYgdG1wID09ICJkb3QxeCI6CiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2c9J0Vycm9yOiBEbyBub3QgaW5wdXQgZG90MXggd2l0aCBvdGhlciBzZXJ2aWNlIHR5cGUuJykKICAgICAgICAgICAgICAgICAgICBpZiB0bXAgPT0gIm5vbmUiOgogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogRG8gbm90IGlucHV0IG5vbmUgd2l0aCBvdGhlciBzZXJ2aWNlIHR5cGUuJykKCiAgICAgICAgICAgICAgICAgICAgaWYgc3RhdGUgPT0gInByZXNlbnQiOgogICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXAgPT0gImZ0cCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VGdHA+dHJ1ZTwvc2VydmljZUZ0cD4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWQgPSAibG9jYWwtdXNlciAlcyBzZXJ2aWNlLXR5cGUgZnRwIiAlIGxvY2FsX3VzZXJfbmFtZQogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIHRtcCA9PSAic25tcCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VTbm1wPnRydWU8L3NlcnZpY2VTbm1wPiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZCA9ICJsb2NhbC11c2VyICVzIHNlcnZpY2UtdHlwZSBzbm1wIiAlIGxvY2FsX3VzZXJfbmFtZQogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIHRtcCA9PSAic3NoIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8c2VydmljZVNzaD50cnVlPC9zZXJ2aWNlU3NoPiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZCA9ICJsb2NhbC11c2VyICVzIHNlcnZpY2UtdHlwZSBzc2giICUgbG9jYWxfdXNlcl9uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgdG1wID09ICJ0ZWxuZXQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjxzZXJ2aWNlVGVsbmV0PnRydWU8L3NlcnZpY2VUZWxuZXQ+IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kID0gImxvY2FsLXVzZXIgJXMgc2VydmljZS10eXBlIHRlbG5ldCIgJSBsb2NhbF91c2VyX25hbWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiB0bXAgPT0gInRlcm1pbmFsIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8c2VydmljZVRlcm1pbmFsPnRydWU8L3NlcnZpY2VUZXJtaW5hbD4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWQgPSAibG9jYWwtdXNlciAlcyBzZXJ2aWNlLXR5cGUgdGVybWluYWwiICUgbG9jYWxfdXNlcl9uYW1lCgogICAgICAgICAgICAgICAgICAgICAgICBjbWRzLmFwcGVuZChjbWQpCgogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcCA9PSAiZnRwIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8c2VydmljZUZ0cD5mYWxzZTwvc2VydmljZUZ0cD4iCiAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgdG1wID09ICJzbm1wIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8c2VydmljZVNubXA+ZmFsc2U8L3NlcnZpY2VTbm1wPiIKICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiB0bXAgPT0gInNzaCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VTc2g+ZmFsc2U8L3NlcnZpY2VTc2g+IgogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIHRtcCA9PSAidGVsbmV0IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8c2VydmljZVRlbG5ldD5mYWxzZTwvc2VydmljZVRlbG5ldD4iCiAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgdG1wID09ICJ0ZXJtaW5hbCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25mX3N0ciArPSAiPHNlcnZpY2VUZXJtaW5hbD5mYWxzZTwvc2VydmljZVRlcm1pbmFsPiIKCiAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAiYWJzZW50IjoKICAgICAgICAgICAgICAgICAgICBjbWQgPSAidW5kbyBsb2NhbC11c2VyICVzIHNlcnZpY2UtdHlwZSIgJSBsb2NhbF91c2VyX25hbWUKICAgICAgICAgICAgICAgICAgICBjbWRzLmFwcGVuZChjbWQpCgogICAgICAgIGlmIGxvY2FsX2Z0cF9kaXI6CiAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8ZnRwRGlyPiVzPC9mdHBEaXI+IiAlIGxvY2FsX2Z0cF9kaXIKICAgICAgICAgICAgICAgIGNtZCA9ICJsb2NhbC11c2VyICVzIGZ0cC1kaXJlY3RvcnkgJXMiICUgKAogICAgICAgICAgICAgICAgICAgIGxvY2FsX3VzZXJfbmFtZSwgbG9jYWxfZnRwX2RpcikKICAgICAgICAgICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8ZnRwRGlyPjwvZnRwRGlyPiIKICAgICAgICAgICAgICAgIGNtZCA9ICJ1bmRvIGxvY2FsLXVzZXIgJXMgZnRwLWRpcmVjdG9yeSIgJSBsb2NhbF91c2VyX25hbWUKICAgICAgICAgICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKCiAgICAgICAgaWYgbG9jYWxfdXNlcl9sZXZlbDoKICAgICAgICAgICAgaWYgc3RhdGUgPT0gInByZXNlbnQiOgogICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjx1c2VyTGV2ZWw+JXM8L3VzZXJMZXZlbD4iICUgbG9jYWxfdXNlcl9sZXZlbAogICAgICAgICAgICAgICAgY21kID0gImxvY2FsLXVzZXIgJXMgbGV2ZWwgJXMiICUgKAogICAgICAgICAgICAgICAgICAgIGxvY2FsX3VzZXJfbmFtZSwgbG9jYWxfdXNlcl9sZXZlbCkKICAgICAgICAgICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8dXNlckxldmVsPjwvdXNlckxldmVsPiIKICAgICAgICAgICAgICAgIGNtZCA9ICJ1bmRvIGxvY2FsLXVzZXIgJXMgbGV2ZWwiICUgbG9jYWxfdXNlcl9uYW1lCiAgICAgICAgICAgICAgICBjbWRzLmFwcGVuZChjbWQpCgogICAgICAgIGlmIGxvY2FsX3VzZXJfZ3JvdXA6CiAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgIGNvbmZfc3RyICs9ICI8dXNlckdyb3VwTmFtZT4lczwvdXNlckdyb3VwTmFtZT4iICUgbG9jYWxfdXNlcl9ncm91cAogICAgICAgICAgICAgICAgY21kID0gImxvY2FsLXVzZXIgJXMgdXNlci1ncm91cCAlcyIgJSAoCiAgICAgICAgICAgICAgICAgICAgbG9jYWxfdXNlcl9uYW1lLCBsb2NhbF91c2VyX2dyb3VwKQogICAgICAgICAgICAgICAgY21kcy5hcHBlbmQoY21kKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgY29uZl9zdHIgKz0gIjx1c2VyR3JvdXBOYW1lPjwvdXNlckdyb3VwTmFtZT4iCiAgICAgICAgICAgICAgICBjbWQgPSAidW5kbyBsb2NhbC11c2VyICVzIHVzZXItZ3JvdXAiICUgbG9jYWxfdXNlcl9uYW1lCiAgICAgICAgICAgICAgICBjbWRzLmFwcGVuZChjbWQpCgogICAgICAgIGNvbmZfc3RyICs9IENFX01FUkdFX0xPQ0FMX1VTRVJfSU5GT19UQUlMCgogICAgICAgIHJlY3ZfeG1sID0gc2VsZi5uZXRjb25mX3NldF9jb25maWcobW9kdWxlPW1vZHVsZSwgY29uZl9zdHI9Y29uZl9zdHIpCgogICAgICAgIGlmICI8b2svPiIgbm90IGluIHJlY3ZfeG1sOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG1zZz0nRXJyb3I6IE1lcmdlIGxvY2FsIHVzZXIgaW5mbyBmYWlsZWQuJykKCiAgICAgICAgcmV0dXJuIGNtZHMKCiAgICBkZWYgZGVsZXRlX2xvY2FsX3VzZXJfaW5mbyhzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgIiIiIERlbGV0ZSBsb2NhbCB1c2VyIGluZm9ybWF0aW9uIGJ5IG5ldGNvbmYgIiIiCgogICAgICAgIG1vZHVsZSA9IGt3YXJnc1sibW9kdWxlIl0KICAgICAgICBsb2NhbF91c2VyX25hbWUgPSBtb2R1bGUucGFyYW1zWydsb2NhbF91c2VyX25hbWUnXQogICAgICAgIGNvbmZfc3RyID0gQ0VfREVMRVRFX0xPQ0FMX1VTRVJfSU5GT19IRUFERVIgJSBsb2NhbF91c2VyX25hbWUKICAgICAgICBjb25mX3N0ciArPSBDRV9ERUxFVEVfTE9DQUxfVVNFUl9JTkZPX1RBSUwKCiAgICAgICAgY21kcyA9IFtdCgogICAgICAgIHJlY3ZfeG1sID0gc2VsZi5uZXRjb25mX3NldF9jb25maWcobW9kdWxlPW1vZHVsZSwgY29uZl9zdHI9Y29uZl9zdHIpCgogICAgICAgIGlmICI8b2svPiIgbm90IGluIHJlY3ZfeG1sOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG1zZz0nRXJyb3I6IERlbGV0ZSBsb2NhbCB1c2VyIGluZm8gZmFpbGVkLicpCgogICAgICAgIGNtZCA9ICJ1bmRvIGxvY2FsLXVzZXIgJXMiICUgbG9jYWxfdXNlcl9uYW1lCiAgICAgICAgY21kcy5hcHBlbmQoY21kKQoKICAgICAgICByZXR1cm4gY21kcwoKICAgIGRlZiBnZXRfcmFkaXVzX3NlcnZlcl9jZmdfaXB2NChzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgIiIiIEdldCByYWRpdXMgc2VydmVyIGNvbmZpZ3VyZSBpcHY0ICIiIgoKICAgICAgICBtb2R1bGUgPSBrd2FyZ3NbIm1vZHVsZSJdCiAgICAgICAgcmFkaXVzX2dyb3VwX25hbWUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfZ3JvdXBfbmFtZSddCiAgICAgICAgcmFkdWlzX3NlcnZlcl90eXBlID0gbW9kdWxlLnBhcmFtc1sncmFkdWlzX3NlcnZlcl90eXBlJ10KICAgICAgICByYWRpdXNfc2VydmVyX2lwID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9pcCddCiAgICAgICAgcmFkaXVzX3NlcnZlcl9wb3J0ID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9wb3J0J10KICAgICAgICByYWRpdXNfc2VydmVyX21vZGUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX21vZGUnXQogICAgICAgIHJhZGl1c192cG5fbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c192cG5fbmFtZSddCiAgICAgICAgc3RhdGUgPSBtb2R1bGUucGFyYW1zWydzdGF0ZSddCgogICAgICAgIHJlc3VsdCA9IGRpY3QoKQogICAgICAgIHJlc3VsdFsicmFkaXVzX3NlcnZlcl9pcF92NCJdID0gW10KICAgICAgICBuZWVkX2NmZyA9IEZhbHNlCgogICAgICAgIGNvbmZfc3RyID0gQ0VfR0VUX1JBRElVU19TRVJWRVJfQ0ZHX0lQVjQgJSByYWRpdXNfZ3JvdXBfbmFtZQoKICAgICAgICByZWN2X3htbCA9IHNlbGYubmV0Y29uZl9nZXRfY29uZmlnKG1vZHVsZT1tb2R1bGUsIGNvbmZfc3RyPWNvbmZfc3RyKQoKICAgICAgICBpZiAiPGRhdGEvPiIgaW4gcmVjdl94bWw6CiAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQoKICAgICAgICBlbHNlOgogICAgICAgICAgICB4bWxfc3RyID0gcmVjdl94bWwucmVwbGFjZSgnXHInLCAnJykucmVwbGFjZSgnXG4nLCAnJykuXAogICAgICAgICAgICAgICAgcmVwbGFjZSgneG1sbnM9InVybjppZXRmOnBhcmFtczp4bWw6bnM6bmV0Y29uZjpiYXNlOjEuMCInLCAiIikuXAogICAgICAgICAgICAgICAgcmVwbGFjZSgneG1sbnM9Imh0dHA6Ly93d3cuaHVhd2VpLmNvbS9uZXRjb25mL3ZycCInLCAiIikKCiAgICAgICAgICAgIHJvb3QgPSBFbGVtZW50VHJlZS5mcm9tc3RyaW5nKHhtbF9zdHIpCiAgICAgICAgICAgIHJhZGl1c19zZXJ2ZXJfaXBfdjQgPSByb290LmZpbmRhbGwoCiAgICAgICAgICAgICAgICAiZGF0YS9yYWRpdXMvcmRzVGVtcGxhdGVzL3Jkc1RlbXBsYXRlL3Jkc1NlcnZlcklQVjRzL3Jkc1NlcnZlcklQVjQiKQogICAgICAgICAgICBpZiByYWRpdXNfc2VydmVyX2lwX3Y0OgogICAgICAgICAgICAgICAgZm9yIHRtcCBpbiByYWRpdXNfc2VydmVyX2lwX3Y0OgogICAgICAgICAgICAgICAgICAgIHRtcF9kaWN0ID0gZGljdCgpCiAgICAgICAgICAgICAgICAgICAgZm9yIHNpdGUgaW4gdG1wOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzaXRlLnRhZyBpbiBbInNlcnZlclR5cGUiLCAic2VydmVySVBBZGRyZXNzIiwgInNlcnZlclBvcnQiLCAic2VydmVyTW9kZSIsICJ2cG5OYW1lIl06CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBfZGljdFtzaXRlLnRhZ10gPSBzaXRlLnRleHQKCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0WyJyYWRpdXNfc2VydmVyX2lwX3Y0Il0uYXBwZW5kKHRtcF9kaWN0KQoKICAgICAgICAgICAgaWYgcmVzdWx0WyJyYWRpdXNfc2VydmVyX2lwX3Y0Il06CiAgICAgICAgICAgICAgICBmb3IgdG1wIGluIHJlc3VsdFsicmFkaXVzX3NlcnZlcl9pcF92NCJdOgogICAgICAgICAgICAgICAgICAgIGlmICJzZXJ2ZXJUeXBlIiBpbiB0bXAua2V5cygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbInNlcnZlclR5cGUiXSAhPSByYWR1aXNfc2VydmVyX3R5cGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbInNlcnZlclR5cGUiXSA9PSByYWR1aXNfc2VydmVyX3R5cGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgInNlcnZlcklQQWRkcmVzcyIgaW4gdG1wLmtleXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc3RhdGUgPT0gInByZXNlbnQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJzZXJ2ZXJJUEFkZHJlc3MiXSAhPSByYWRpdXNfc2VydmVyX2lwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJzZXJ2ZXJJUEFkZHJlc3MiXSA9PSByYWRpdXNfc2VydmVyX2lwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGlmICJzZXJ2ZXJQb3J0IiBpbiB0bXAua2V5cygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbInNlcnZlclBvcnQiXSAhPSByYWRpdXNfc2VydmVyX3BvcnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbInNlcnZlclBvcnQiXSA9PSByYWRpdXNfc2VydmVyX3BvcnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgInNlcnZlck1vZGUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyTW9kZSJdICE9IHJhZGl1c19zZXJ2ZXJfbW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyTW9kZSJdID09IHJhZGl1c19zZXJ2ZXJfbW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICBpZiAidnBuTmFtZSIgaW4gdG1wLmtleXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc3RhdGUgPT0gInByZXNlbnQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJ2cG5OYW1lIl0gIT0gcmFkaXVzX3Zwbl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJ2cG5OYW1lIl0gPT0gcmFkaXVzX3Zwbl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQoKICAgICAgICByZXN1bHRbIm5lZWRfY2ZnIl0gPSBuZWVkX2NmZwogICAgICAgIHJldHVybiByZXN1bHQKCiAgICBkZWYgbWVyZ2VfcmFkaXVzX3NlcnZlcl9jZmdfaXB2NChzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgIiIiIE1lcmdlIHJhZGl1cyBzZXJ2ZXIgY29uZmlndXJlIGlwdjQgIiIiCgogICAgICAgIG1vZHVsZSA9IGt3YXJnc1sibW9kdWxlIl0KICAgICAgICByYWRpdXNfZ3JvdXBfbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19ncm91cF9uYW1lJ10KICAgICAgICByYWR1aXNfc2VydmVyX3R5cGUgPSBtb2R1bGUucGFyYW1zWydyYWR1aXNfc2VydmVyX3R5cGUnXQogICAgICAgIHJhZGl1c19zZXJ2ZXJfaXAgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX2lwJ10KICAgICAgICByYWRpdXNfc2VydmVyX3BvcnQgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX3BvcnQnXQogICAgICAgIHJhZGl1c19zZXJ2ZXJfbW9kZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19zZXJ2ZXJfbW9kZSddCiAgICAgICAgcmFkaXVzX3Zwbl9uYW1lID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3Zwbl9uYW1lJ10KCiAgICAgICAgY29uZl9zdHIgPSBDRV9NRVJHRV9SQURJVVNfU0VSVkVSX0NGR19JUFY0ICUgKAogICAgICAgICAgICByYWRpdXNfZ3JvdXBfbmFtZSwgcmFkdWlzX3NlcnZlcl90eXBlLAogICAgICAgICAgICByYWRpdXNfc2VydmVyX2lwLCByYWRpdXNfc2VydmVyX3BvcnQsCiAgICAgICAgICAgIHJhZGl1c19zZXJ2ZXJfbW9kZSwgcmFkaXVzX3Zwbl9uYW1lKQoKICAgICAgICByZWN2X3htbCA9IHNlbGYubmV0Y29uZl9zZXRfY29uZmlnKG1vZHVsZT1tb2R1bGUsIGNvbmZfc3RyPWNvbmZfc3RyKQoKICAgICAgICBpZiAiPG9rLz4iIG5vdCBpbiByZWN2X3htbDoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IE1lcmdlIHJhZGl1cyBzZXJ2ZXIgY29uZmlnIGlwdjQgZmFpbGVkLicpCgogICAgICAgIGNtZHMgPSBbXQoKICAgICAgICBjbWQgPSAicmFkaXVzIHNlcnZlciBncm91cCAlcyIgJSByYWRpdXNfZ3JvdXBfbmFtZQogICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKCiAgICAgICAgaWYgcmFkdWlzX3NlcnZlcl90eXBlID09ICJBdXRoZW50aWNhdGlvbiI6CiAgICAgICAgICAgIGNtZCA9ICJyYWRpdXMgc2VydmVyIGF1dGhlbnRpY2F0aW9uICVzICVzIiAlICgKICAgICAgICAgICAgICAgIHJhZGl1c19zZXJ2ZXJfaXAsIHJhZGl1c19zZXJ2ZXJfcG9ydCkKCiAgICAgICAgICAgIGlmIHJhZGl1c192cG5fbmFtZSBhbmQgcmFkaXVzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgcmFkaXVzX3Zwbl9uYW1lCgogICAgICAgICAgICBpZiByYWRpdXNfc2VydmVyX21vZGUgPT0gIlNlY29uZGFyeS1zZXJ2ZXIiOgogICAgICAgICAgICAgICAgY21kICs9ICIgc2Vjb25kYXJ5IgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNtZCA9ICJyYWRpdXMgc2VydmVyIGFjY291bnRpbmcgJXMgJXMiICUgKAogICAgICAgICAgICAgICAgcmFkaXVzX3NlcnZlcl9pcCwgcmFkaXVzX3NlcnZlcl9wb3J0KQoKICAgICAgICAgICAgaWYgcmFkaXVzX3Zwbl9uYW1lIGFuZCByYWRpdXNfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSByYWRpdXNfdnBuX25hbWUKCiAgICAgICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfbW9kZSA9PSAiU2Vjb25kYXJ5LXNlcnZlciI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKICAgICAgICByZXR1cm4gY21kcwoKICAgIGRlZiBkZWxldGVfcmFkaXVzX3NlcnZlcl9jZmdfaXB2NChzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgIiIiIERlbGV0ZSByYWRpdXMgc2VydmVyIGNvbmZpZ3VyZSBpcHY0ICIiIgoKICAgICAgICBtb2R1bGUgPSBrd2FyZ3NbIm1vZHVsZSJdCiAgICAgICAgcmFkaXVzX2dyb3VwX25hbWUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfZ3JvdXBfbmFtZSddCiAgICAgICAgcmFkdWlzX3NlcnZlcl90eXBlID0gbW9kdWxlLnBhcmFtc1sncmFkdWlzX3NlcnZlcl90eXBlJ10KICAgICAgICByYWRpdXNfc2VydmVyX2lwID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9pcCddCiAgICAgICAgcmFkaXVzX3NlcnZlcl9wb3J0ID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9wb3J0J10KICAgICAgICByYWRpdXNfc2VydmVyX21vZGUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX21vZGUnXQogICAgICAgIHJhZGl1c192cG5fbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c192cG5fbmFtZSddCgogICAgICAgIGNvbmZfc3RyID0gQ0VfREVMRVRFX1JBRElVU19TRVJWRVJfQ0ZHX0lQVjQgJSAoCiAgICAgICAgICAgIHJhZGl1c19ncm91cF9uYW1lLCByYWR1aXNfc2VydmVyX3R5cGUsCiAgICAgICAgICAgIHJhZGl1c19zZXJ2ZXJfaXAsIHJhZGl1c19zZXJ2ZXJfcG9ydCwKICAgICAgICAgICAgcmFkaXVzX3NlcnZlcl9tb2RlLCByYWRpdXNfdnBuX25hbWUpCgogICAgICAgIHJlY3ZfeG1sID0gc2VsZi5uZXRjb25mX3NldF9jb25maWcobW9kdWxlPW1vZHVsZSwgY29uZl9zdHI9Y29uZl9zdHIpCgogICAgICAgIGlmICI8b2svPiIgbm90IGluIHJlY3ZfeG1sOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogQ3JlYXRlIHJhZGl1cyBzZXJ2ZXIgY29uZmlnIGlwdjQgZmFpbGVkLicpCgogICAgICAgIGNtZHMgPSBbXQoKICAgICAgICBjbWQgPSAicmFkaXVzIHNlcnZlciBncm91cCAlcyIgJSByYWRpdXNfZ3JvdXBfbmFtZQogICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKCiAgICAgICAgaWYgcmFkdWlzX3NlcnZlcl90eXBlID09ICJBdXRoZW50aWNhdGlvbiI6CiAgICAgICAgICAgIGNtZCA9ICJ1bmRvIHJhZGl1cyBzZXJ2ZXIgYXV0aGVudGljYXRpb24gJXMgJXMiICUgKAogICAgICAgICAgICAgICAgcmFkaXVzX3NlcnZlcl9pcCwgcmFkaXVzX3NlcnZlcl9wb3J0KQoKICAgICAgICAgICAgaWYgcmFkaXVzX3Zwbl9uYW1lIGFuZCByYWRpdXNfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSByYWRpdXNfdnBuX25hbWUKCiAgICAgICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfbW9kZSA9PSAiU2Vjb25kYXJ5LXNlcnZlciI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY21kID0gInVuZG8gcmFkaXVzIHNlcnZlciBhY2NvdW50aW5nICAlcyAlcyIgJSAoCiAgICAgICAgICAgICAgICByYWRpdXNfc2VydmVyX2lwLCByYWRpdXNfc2VydmVyX3BvcnQpCgogICAgICAgICAgICBpZiByYWRpdXNfdnBuX25hbWUgYW5kIHJhZGl1c192cG5fbmFtZSAhPSAiX3B1YmxpY18iOgogICAgICAgICAgICAgICAgY21kICs9ICIgdnBuLWluc3RhbmNlICVzIiAlIHJhZGl1c192cG5fbmFtZQoKICAgICAgICAgICAgaWYgcmFkaXVzX3NlcnZlcl9tb2RlID09ICJTZWNvbmRhcnktc2VydmVyIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHNlY29uZGFyeSIKCiAgICAgICAgY21kcy5hcHBlbmQoY21kKQogICAgICAgIHJldHVybiBjbWRzCgogICAgZGVmIGdldF9yYWRpdXNfc2VydmVyX2NmZ19pcHY2KHNlbGYsICoqa3dhcmdzKToKICAgICAgICAiIiIgR2V0IHJhZGl1cyBzZXJ2ZXIgY29uZmlndXJlIGlwdjYgIiIiCgogICAgICAgIG1vZHVsZSA9IGt3YXJnc1sibW9kdWxlIl0KICAgICAgICByYWRpdXNfZ3JvdXBfbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19ncm91cF9uYW1lJ10KICAgICAgICByYWR1aXNfc2VydmVyX3R5cGUgPSBtb2R1bGUucGFyYW1zWydyYWR1aXNfc2VydmVyX3R5cGUnXQogICAgICAgIHJhZGl1c19zZXJ2ZXJfaXB2NiA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19zZXJ2ZXJfaXB2NiddCiAgICAgICAgcmFkaXVzX3NlcnZlcl9wb3J0ID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9wb3J0J10KICAgICAgICByYWRpdXNfc2VydmVyX21vZGUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX21vZGUnXQogICAgICAgIHN0YXRlID0gbW9kdWxlLnBhcmFtc1snc3RhdGUnXQoKICAgICAgICByZXN1bHQgPSBkaWN0KCkKICAgICAgICByZXN1bHRbInJhZGl1c19zZXJ2ZXJfaXBfdjYiXSA9IFtdCiAgICAgICAgbmVlZF9jZmcgPSBGYWxzZQoKICAgICAgICBjb25mX3N0ciA9IENFX0dFVF9SQURJVVNfU0VSVkVSX0NGR19JUFY2ICUgcmFkaXVzX2dyb3VwX25hbWUKCiAgICAgICAgcmVjdl94bWwgPSBzZWxmLm5ldGNvbmZfZ2V0X2NvbmZpZyhtb2R1bGU9bW9kdWxlLCBjb25mX3N0cj1jb25mX3N0cikKCiAgICAgICAgaWYgIjxkYXRhLz4iIGluIHJlY3ZfeG1sOgogICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKCiAgICAgICAgZWxzZToKICAgICAgICAgICAgeG1sX3N0ciA9IHJlY3ZfeG1sLnJlcGxhY2UoJ1xyJywgJycpLnJlcGxhY2UoJ1xuJywgJycpLlwKICAgICAgICAgICAgICAgIHJlcGxhY2UoJ3htbG5zPSJ1cm46aWV0ZjpwYXJhbXM6eG1sOm5zOm5ldGNvbmY6YmFzZToxLjAiJywgIiIpLlwKICAgICAgICAgICAgICAgIHJlcGxhY2UoJ3htbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiJywgIiIpCgogICAgICAgICAgICByb290ID0gRWxlbWVudFRyZWUuZnJvbXN0cmluZyh4bWxfc3RyKQogICAgICAgICAgICByYWRpdXNfc2VydmVyX2lwX3Y2ID0gcm9vdC5maW5kYWxsKAogICAgICAgICAgICAgICAgImRhdGEvcmFkaXVzL3Jkc1RlbXBsYXRlcy9yZHNUZW1wbGF0ZS9yZHNTZXJ2ZXJJUFY2cy9yZHNTZXJ2ZXJJUFY2IikKICAgICAgICAgICAgaWYgcmFkaXVzX3NlcnZlcl9pcF92NjoKICAgICAgICAgICAgICAgIGZvciB0bXAgaW4gcmFkaXVzX3NlcnZlcl9pcF92NjoKICAgICAgICAgICAgICAgICAgICB0bXBfZGljdCA9IGRpY3QoKQogICAgICAgICAgICAgICAgICAgIGZvciBzaXRlIGluIHRtcDoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2l0ZS50YWcgaW4gWyJzZXJ2ZXJUeXBlIiwgInNlcnZlcklQQWRkcmVzcyIsICJzZXJ2ZXJQb3J0IiwgInNlcnZlck1vZGUiXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcF9kaWN0W3NpdGUudGFnXSA9IHNpdGUudGV4dAoKICAgICAgICAgICAgICAgICAgICByZXN1bHRbInJhZGl1c19zZXJ2ZXJfaXBfdjYiXS5hcHBlbmQodG1wX2RpY3QpCgogICAgICAgICAgICBpZiByZXN1bHRbInJhZGl1c19zZXJ2ZXJfaXBfdjYiXToKICAgICAgICAgICAgICAgIGZvciB0bXAgaW4gcmVzdWx0WyJyYWRpdXNfc2VydmVyX2lwX3Y2Il06CiAgICAgICAgICAgICAgICAgICAgaWYgInNlcnZlclR5cGUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyVHlwZSJdICE9IHJhZHVpc19zZXJ2ZXJfdHlwZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyVHlwZSJdID09IHJhZHVpc19zZXJ2ZXJfdHlwZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICBpZiAic2VydmVySVBBZGRyZXNzIiBpbiB0bXAua2V5cygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbInNlcnZlcklQQWRkcmVzcyJdICE9IHJhZGl1c19zZXJ2ZXJfaXB2NjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVySVBBZGRyZXNzIl0gPT0gcmFkaXVzX3NlcnZlcl9pcHY2OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGlmICJzZXJ2ZXJQb3J0IiBpbiB0bXAua2V5cygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbInNlcnZlclBvcnQiXSAhPSByYWRpdXNfc2VydmVyX3BvcnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbInNlcnZlclBvcnQiXSA9PSByYWRpdXNfc2VydmVyX3BvcnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgInNlcnZlck1vZGUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyTW9kZSJdICE9IHJhZGl1c19zZXJ2ZXJfbW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyTW9kZSJdID09IHJhZGl1c19zZXJ2ZXJfbW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKCiAgICAgICAgcmVzdWx0WyJuZWVkX2NmZyJdID0gbmVlZF9jZmcKICAgICAgICByZXR1cm4gcmVzdWx0CgogICAgZGVmIG1lcmdlX3JhZGl1c19zZXJ2ZXJfY2ZnX2lwdjYoc2VsZiwgKiprd2FyZ3MpOgogICAgICAgICIiIiBNZXJnZSByYWRpdXMgc2VydmVyIGNvbmZpZ3VyZSBpcHY2ICIiIgoKICAgICAgICBtb2R1bGUgPSBrd2FyZ3NbIm1vZHVsZSJdCiAgICAgICAgcmFkaXVzX2dyb3VwX25hbWUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfZ3JvdXBfbmFtZSddCiAgICAgICAgcmFkdWlzX3NlcnZlcl90eXBlID0gbW9kdWxlLnBhcmFtc1sncmFkdWlzX3NlcnZlcl90eXBlJ10KICAgICAgICByYWRpdXNfc2VydmVyX2lwdjYgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX2lwdjYnXQogICAgICAgIHJhZGl1c19zZXJ2ZXJfcG9ydCA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19zZXJ2ZXJfcG9ydCddCiAgICAgICAgcmFkaXVzX3NlcnZlcl9tb2RlID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9tb2RlJ10KCiAgICAgICAgY29uZl9zdHIgPSBDRV9NRVJHRV9SQURJVVNfU0VSVkVSX0NGR19JUFY2ICUgKAogICAgICAgICAgICByYWRpdXNfZ3JvdXBfbmFtZSwgcmFkdWlzX3NlcnZlcl90eXBlLAogICAgICAgICAgICByYWRpdXNfc2VydmVyX2lwdjYsIHJhZGl1c19zZXJ2ZXJfcG9ydCwKICAgICAgICAgICAgcmFkaXVzX3NlcnZlcl9tb2RlKQoKICAgICAgICByZWN2X3htbCA9IHNlbGYubmV0Y29uZl9zZXRfY29uZmlnKG1vZHVsZT1tb2R1bGUsIGNvbmZfc3RyPWNvbmZfc3RyKQoKICAgICAgICBpZiAiPG9rLz4iIG5vdCBpbiByZWN2X3htbDoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IE1lcmdlIHJhZGl1cyBzZXJ2ZXIgY29uZmlnIGlwdjYgZmFpbGVkLicpCgogICAgICAgIGNtZHMgPSBbXQoKICAgICAgICBjbWQgPSAicmFkaXVzIHNlcnZlciBncm91cCAlcyIgJSByYWRpdXNfZ3JvdXBfbmFtZQogICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKCiAgICAgICAgaWYgcmFkdWlzX3NlcnZlcl90eXBlID09ICJBdXRoZW50aWNhdGlvbiI6CiAgICAgICAgICAgIGNtZCA9ICJyYWRpdXMgc2VydmVyIGF1dGhlbnRpY2F0aW9uICVzICVzIiAlICgKICAgICAgICAgICAgICAgIHJhZGl1c19zZXJ2ZXJfaXB2NiwgcmFkaXVzX3NlcnZlcl9wb3J0KQoKICAgICAgICAgICAgaWYgcmFkaXVzX3NlcnZlcl9tb2RlID09ICJTZWNvbmRhcnktc2VydmVyIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHNlY29uZGFyeSIKICAgICAgICBlbHNlOgogICAgICAgICAgICBjbWQgPSAicmFkaXVzIHNlcnZlciBhY2NvdW50aW5nICAlcyAlcyIgJSAoCiAgICAgICAgICAgICAgICByYWRpdXNfc2VydmVyX2lwdjYsIHJhZGl1c19zZXJ2ZXJfcG9ydCkKCiAgICAgICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfbW9kZSA9PSAiU2Vjb25kYXJ5LXNlcnZlciI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKICAgICAgICByZXR1cm4gY21kcwoKICAgIGRlZiBkZWxldGVfcmFkaXVzX3NlcnZlcl9jZmdfaXB2NihzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgIiIiIERlbGV0ZSByYWRpdXMgc2VydmVyIGNvbmZpZ3VyZSBpcHY2ICIiIgoKICAgICAgICBtb2R1bGUgPSBrd2FyZ3NbIm1vZHVsZSJdCiAgICAgICAgcmFkaXVzX2dyb3VwX25hbWUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfZ3JvdXBfbmFtZSddCiAgICAgICAgcmFkdWlzX3NlcnZlcl90eXBlID0gbW9kdWxlLnBhcmFtc1sncmFkdWlzX3NlcnZlcl90eXBlJ10KICAgICAgICByYWRpdXNfc2VydmVyX2lwdjYgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX2lwdjYnXQogICAgICAgIHJhZGl1c19zZXJ2ZXJfcG9ydCA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19zZXJ2ZXJfcG9ydCddCiAgICAgICAgcmFkaXVzX3NlcnZlcl9tb2RlID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9tb2RlJ10KCiAgICAgICAgY29uZl9zdHIgPSBDRV9ERUxFVEVfUkFESVVTX1NFUlZFUl9DRkdfSVBWNiAlICgKICAgICAgICAgICAgcmFkaXVzX2dyb3VwX25hbWUsIHJhZHVpc19zZXJ2ZXJfdHlwZSwKICAgICAgICAgICAgcmFkaXVzX3NlcnZlcl9pcHY2LCByYWRpdXNfc2VydmVyX3BvcnQsCiAgICAgICAgICAgIHJhZGl1c19zZXJ2ZXJfbW9kZSkKCiAgICAgICAgcmVjdl94bWwgPSBzZWxmLm5ldGNvbmZfc2V0X2NvbmZpZyhtb2R1bGU9bW9kdWxlLCBjb25mX3N0cj1jb25mX3N0cikKCiAgICAgICAgaWYgIjxvay8+IiBub3QgaW4gcmVjdl94bWw6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgICAgICBtc2c9J0Vycm9yOiBDcmVhdGUgcmFkaXVzIHNlcnZlciBjb25maWcgaXB2NiBmYWlsZWQuJykKCiAgICAgICAgY21kcyA9IFtdCgogICAgICAgIGNtZCA9ICJyYWRpdXMgc2VydmVyIGdyb3VwICVzIiAlIHJhZGl1c19ncm91cF9uYW1lCiAgICAgICAgY21kcy5hcHBlbmQoY21kKQoKICAgICAgICBpZiByYWR1aXNfc2VydmVyX3R5cGUgPT0gIkF1dGhlbnRpY2F0aW9uIjoKICAgICAgICAgICAgY21kID0gInVuZG8gcmFkaXVzIHNlcnZlciBhdXRoZW50aWNhdGlvbiAlcyAlcyIgJSAoCiAgICAgICAgICAgICAgICByYWRpdXNfc2VydmVyX2lwdjYsIHJhZGl1c19zZXJ2ZXJfcG9ydCkKCiAgICAgICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfbW9kZSA9PSAiU2Vjb25kYXJ5LXNlcnZlciI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY21kID0gInVuZG8gcmFkaXVzIHNlcnZlciBhY2NvdW50aW5nICAlcyAlcyIgJSAoCiAgICAgICAgICAgICAgICByYWRpdXNfc2VydmVyX2lwdjYsIHJhZGl1c19zZXJ2ZXJfcG9ydCkKCiAgICAgICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfbW9kZSA9PSAiU2Vjb25kYXJ5LXNlcnZlciI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKICAgICAgICByZXR1cm4gY21kcwoKICAgIGRlZiBnZXRfcmFkaXVzX3NlcnZlcl9uYW1lKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAiIiIgR2V0IHJhZGl1cyBzZXJ2ZXIgbmFtZSAiIiIKCiAgICAgICAgbW9kdWxlID0ga3dhcmdzWyJtb2R1bGUiXQogICAgICAgIHJhZGl1c19ncm91cF9uYW1lID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX2dyb3VwX25hbWUnXQogICAgICAgIHJhZHVpc19zZXJ2ZXJfdHlwZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZHVpc19zZXJ2ZXJfdHlwZSddCiAgICAgICAgcmFkaXVzX3NlcnZlcl9uYW1lID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9uYW1lJ10KICAgICAgICByYWRpdXNfc2VydmVyX3BvcnQgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX3BvcnQnXQogICAgICAgIHJhZGl1c19zZXJ2ZXJfbW9kZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19zZXJ2ZXJfbW9kZSddCiAgICAgICAgcmFkaXVzX3Zwbl9uYW1lID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3Zwbl9uYW1lJ10KICAgICAgICBzdGF0ZSA9IG1vZHVsZS5wYXJhbXNbJ3N0YXRlJ10KCiAgICAgICAgcmVzdWx0ID0gZGljdCgpCiAgICAgICAgcmVzdWx0WyJyYWRpdXNfc2VydmVyX25hbWVfY2ZnIl0gPSBbXQogICAgICAgIG5lZWRfY2ZnID0gRmFsc2UKCiAgICAgICAgY29uZl9zdHIgPSBDRV9HRVRfUkFESVVTX1NFUlZFUl9OQU1FICUgcmFkaXVzX2dyb3VwX25hbWUKCiAgICAgICAgcmVjdl94bWwgPSBzZWxmLm5ldGNvbmZfZ2V0X2NvbmZpZyhtb2R1bGU9bW9kdWxlLCBjb25mX3N0cj1jb25mX3N0cikKCiAgICAgICAgaWYgIjxkYXRhLz4iIGluIHJlY3ZfeG1sOgogICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKCiAgICAgICAgZWxzZToKICAgICAgICAgICAgeG1sX3N0ciA9IHJlY3ZfeG1sLnJlcGxhY2UoJ1xyJywgJycpLnJlcGxhY2UoJ1xuJywgJycpLlwKICAgICAgICAgICAgICAgIHJlcGxhY2UoJ3htbG5zPSJ1cm46aWV0ZjpwYXJhbXM6eG1sOm5zOm5ldGNvbmY6YmFzZToxLjAiJywgIiIpLlwKICAgICAgICAgICAgICAgIHJlcGxhY2UoJ3htbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiJywgIiIpCgogICAgICAgICAgICByb290ID0gRWxlbWVudFRyZWUuZnJvbXN0cmluZyh4bWxfc3RyKQogICAgICAgICAgICByYWRpdXNfc2VydmVyX25hbWVfY2ZnID0gcm9vdC5maW5kYWxsKAogICAgICAgICAgICAgICAgImRhdGEvcmFkaXVzL3Jkc1RlbXBsYXRlcy9yZHNUZW1wbGF0ZS9yZHNTZXJ2ZXJOYW1lcy9yZHNTZXJ2ZXJOYW1lIikKICAgICAgICAgICAgaWYgcmFkaXVzX3NlcnZlcl9uYW1lX2NmZzoKICAgICAgICAgICAgICAgIGZvciB0bXAgaW4gcmFkaXVzX3NlcnZlcl9uYW1lX2NmZzoKICAgICAgICAgICAgICAgICAgICB0bXBfZGljdCA9IGRpY3QoKQogICAgICAgICAgICAgICAgICAgIGZvciBzaXRlIGluIHRtcDoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2l0ZS50YWcgaW4gWyJzZXJ2ZXJUeXBlIiwgInNlcnZlck5hbWUiLCAic2VydmVyUG9ydCIsICJzZXJ2ZXJNb2RlIiwgInZwbk5hbWUiXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcF9kaWN0W3NpdGUudGFnXSA9IHNpdGUudGV4dAoKICAgICAgICAgICAgICAgICAgICByZXN1bHRbInJhZGl1c19zZXJ2ZXJfbmFtZV9jZmciXS5hcHBlbmQodG1wX2RpY3QpCgogICAgICAgICAgICBpZiByZXN1bHRbInJhZGl1c19zZXJ2ZXJfbmFtZV9jZmciXToKICAgICAgICAgICAgICAgIGZvciB0bXAgaW4gcmVzdWx0WyJyYWRpdXNfc2VydmVyX25hbWVfY2ZnIl06CiAgICAgICAgICAgICAgICAgICAgaWYgInNlcnZlclR5cGUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyVHlwZSJdICE9IHJhZHVpc19zZXJ2ZXJfdHlwZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyVHlwZSJdID09IHJhZHVpc19zZXJ2ZXJfdHlwZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICBpZiAic2VydmVyTmFtZSIgaW4gdG1wLmtleXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc3RhdGUgPT0gInByZXNlbnQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJzZXJ2ZXJOYW1lIl0gIT0gcmFkaXVzX3NlcnZlcl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJzZXJ2ZXJOYW1lIl0gPT0gcmFkaXVzX3NlcnZlcl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGlmICJzZXJ2ZXJQb3J0IiBpbiB0bXAua2V5cygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbInNlcnZlclBvcnQiXSAhPSByYWRpdXNfc2VydmVyX3BvcnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbInNlcnZlclBvcnQiXSA9PSByYWRpdXNfc2VydmVyX3BvcnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgInNlcnZlck1vZGUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyTW9kZSJdICE9IHJhZGl1c19zZXJ2ZXJfbW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyTW9kZSJdID09IHJhZGl1c19zZXJ2ZXJfbW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICBpZiAidnBuTmFtZSIgaW4gdG1wLmtleXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc3RhdGUgPT0gInByZXNlbnQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJ2cG5OYW1lIl0gIT0gcmFkaXVzX3Zwbl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJ2cG5OYW1lIl0gPT0gcmFkaXVzX3Zwbl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQoKICAgICAgICByZXN1bHRbIm5lZWRfY2ZnIl0gPSBuZWVkX2NmZwogICAgICAgIHJldHVybiByZXN1bHQKCiAgICBkZWYgbWVyZ2VfcmFkaXVzX3NlcnZlcl9uYW1lKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAiIiIgTWVyZ2UgcmFkaXVzIHNlcnZlciBuYW1lICIiIgoKICAgICAgICBtb2R1bGUgPSBrd2FyZ3NbIm1vZHVsZSJdCiAgICAgICAgcmFkaXVzX2dyb3VwX25hbWUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfZ3JvdXBfbmFtZSddCiAgICAgICAgcmFkdWlzX3NlcnZlcl90eXBlID0gbW9kdWxlLnBhcmFtc1sncmFkdWlzX3NlcnZlcl90eXBlJ10KICAgICAgICByYWRpdXNfc2VydmVyX25hbWUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX25hbWUnXQogICAgICAgIHJhZGl1c19zZXJ2ZXJfcG9ydCA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19zZXJ2ZXJfcG9ydCddCiAgICAgICAgcmFkaXVzX3NlcnZlcl9tb2RlID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9tb2RlJ10KICAgICAgICByYWRpdXNfdnBuX25hbWUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfdnBuX25hbWUnXQoKICAgICAgICBjb25mX3N0ciA9IENFX01FUkdFX1JBRElVU19TRVJWRVJfTkFNRSAlICgKICAgICAgICAgICAgcmFkaXVzX2dyb3VwX25hbWUsIHJhZHVpc19zZXJ2ZXJfdHlwZSwKICAgICAgICAgICAgcmFkaXVzX3NlcnZlcl9uYW1lLCByYWRpdXNfc2VydmVyX3BvcnQsCiAgICAgICAgICAgIHJhZGl1c19zZXJ2ZXJfbW9kZSwgcmFkaXVzX3Zwbl9uYW1lKQoKICAgICAgICByZWN2X3htbCA9IHNlbGYubmV0Y29uZl9zZXRfY29uZmlnKG1vZHVsZT1tb2R1bGUsIGNvbmZfc3RyPWNvbmZfc3RyKQoKICAgICAgICBpZiAiPG9rLz4iIG5vdCBpbiByZWN2X3htbDoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9J0Vycm9yOiBNZXJnZSByYWRpdXMgc2VydmVyIG5hbWUgZmFpbGVkLicpCgogICAgICAgIGNtZHMgPSBbXQoKICAgICAgICBjbWQgPSAicmFkaXVzIHNlcnZlciBncm91cCAlcyIgJSByYWRpdXNfZ3JvdXBfbmFtZQogICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKCiAgICAgICAgaWYgcmFkdWlzX3NlcnZlcl90eXBlID09ICJBdXRoZW50aWNhdGlvbiI6CiAgICAgICAgICAgIGNtZCA9ICJyYWRpdXMgc2VydmVyIGF1dGhlbnRpY2F0aW9uIGhvc3RuYW1lICVzICVzIiAlICgKICAgICAgICAgICAgICAgIHJhZGl1c19zZXJ2ZXJfbmFtZSwgcmFkaXVzX3NlcnZlcl9wb3J0KQoKICAgICAgICAgICAgaWYgcmFkaXVzX3Zwbl9uYW1lIGFuZCByYWRpdXNfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSByYWRpdXNfdnBuX25hbWUKCiAgICAgICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfbW9kZSA9PSAiU2Vjb25kYXJ5LXNlcnZlciI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY21kID0gInJhZGl1cyBzZXJ2ZXIgYWNjb3VudGluZyBob3N0bmFtZSAlcyAlcyIgJSAoCiAgICAgICAgICAgICAgICByYWRpdXNfc2VydmVyX25hbWUsIHJhZGl1c19zZXJ2ZXJfcG9ydCkKCiAgICAgICAgICAgIGlmIHJhZGl1c192cG5fbmFtZSBhbmQgcmFkaXVzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgcmFkaXVzX3Zwbl9uYW1lCgogICAgICAgICAgICBpZiByYWRpdXNfc2VydmVyX21vZGUgPT0gIlNlY29uZGFyeS1zZXJ2ZXIiOgogICAgICAgICAgICAgICAgY21kICs9ICIgc2Vjb25kYXJ5IgoKICAgICAgICBjbWRzLmFwcGVuZChjbWQpCiAgICAgICAgcmV0dXJuIGNtZHMKCiAgICBkZWYgZGVsZXRlX3JhZGl1c19zZXJ2ZXJfbmFtZShzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgIiIiIERlbGV0ZSByYWRpdXMgc2VydmVyIG5hbWUgIiIiCgogICAgICAgIG1vZHVsZSA9IGt3YXJnc1sibW9kdWxlIl0KICAgICAgICByYWRpdXNfZ3JvdXBfbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19ncm91cF9uYW1lJ10KICAgICAgICByYWR1aXNfc2VydmVyX3R5cGUgPSBtb2R1bGUucGFyYW1zWydyYWR1aXNfc2VydmVyX3R5cGUnXQogICAgICAgIHJhZGl1c19zZXJ2ZXJfbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19zZXJ2ZXJfbmFtZSddCiAgICAgICAgcmFkaXVzX3NlcnZlcl9wb3J0ID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9wb3J0J10KICAgICAgICByYWRpdXNfc2VydmVyX21vZGUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX21vZGUnXQogICAgICAgIHJhZGl1c192cG5fbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c192cG5fbmFtZSddCgogICAgICAgIGNvbmZfc3RyID0gQ0VfREVMRVRFX1JBRElVU19TRVJWRVJfTkFNRSAlICgKICAgICAgICAgICAgcmFkaXVzX2dyb3VwX25hbWUsIHJhZHVpc19zZXJ2ZXJfdHlwZSwKICAgICAgICAgICAgcmFkaXVzX3NlcnZlcl9uYW1lLCByYWRpdXNfc2VydmVyX3BvcnQsCiAgICAgICAgICAgIHJhZGl1c19zZXJ2ZXJfbW9kZSwgcmFkaXVzX3Zwbl9uYW1lKQoKICAgICAgICByZWN2X3htbCA9IHNlbGYubmV0Y29uZl9zZXRfY29uZmlnKG1vZHVsZT1tb2R1bGUsIGNvbmZfc3RyPWNvbmZfc3RyKQoKICAgICAgICBpZiAiPG9rLz4iIG5vdCBpbiByZWN2X3htbDoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9J0Vycm9yOiBkZWxldGUgcmFkaXVzIHNlcnZlciBuYW1lIGZhaWxlZC4nKQoKICAgICAgICBjbWRzID0gW10KCiAgICAgICAgY21kID0gInJhZGl1cyBzZXJ2ZXIgZ3JvdXAgJXMiICUgcmFkaXVzX2dyb3VwX25hbWUKICAgICAgICBjbWRzLmFwcGVuZChjbWQpCgogICAgICAgIGlmIHJhZHVpc19zZXJ2ZXJfdHlwZSA9PSAiQXV0aGVudGljYXRpb24iOgogICAgICAgICAgICBjbWQgPSAidW5kbyByYWRpdXMgc2VydmVyIGF1dGhlbnRpY2F0aW9uIGhvc3RuYW1lICVzICVzIiAlICgKICAgICAgICAgICAgICAgIHJhZGl1c19zZXJ2ZXJfbmFtZSwgcmFkaXVzX3NlcnZlcl9wb3J0KQoKICAgICAgICAgICAgaWYgcmFkaXVzX3Zwbl9uYW1lIGFuZCByYWRpdXNfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSByYWRpdXNfdnBuX25hbWUKCiAgICAgICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfbW9kZSA9PSAiU2Vjb25kYXJ5LXNlcnZlciI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY21kID0gInVuZG8gcmFkaXVzIHNlcnZlciBhY2NvdW50aW5nIGhvc3RuYW1lICVzICVzIiAlICgKICAgICAgICAgICAgICAgIHJhZGl1c19zZXJ2ZXJfbmFtZSwgcmFkaXVzX3NlcnZlcl9wb3J0KQoKICAgICAgICAgICAgaWYgcmFkaXVzX3Zwbl9uYW1lIGFuZCByYWRpdXNfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSByYWRpdXNfdnBuX25hbWUKCiAgICAgICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfbW9kZSA9PSAiU2Vjb25kYXJ5LXNlcnZlciI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKICAgICAgICByZXR1cm4gY21kcwoKICAgIGRlZiBnZXRfaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY0KHNlbGYsICoqa3dhcmdzKToKICAgICAgICAiIiIgR2V0IGh3dGFjYWNzIHNlcnZlciBjb25maWd1cmUgaXB2NCAiIiIKCiAgICAgICAgbW9kdWxlID0ga3dhcmdzWyJtb2R1bGUiXQogICAgICAgIGh3dGFjYWNzX3RlbXBsYXRlID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3NfdGVtcGxhdGUiXQogICAgICAgIGh3dGFjYWNzX3NlcnZlcl9pcCA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3NlcnZlcl9pcCJdCiAgICAgICAgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPSBtb2R1bGUucGFyYW1zWyJod3RhY2Fjc19zZXJ2ZXJfdHlwZSJdCiAgICAgICAgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlciA9IG1vZHVsZS5wYXJhbXNbCiAgICAgICAgICAgICJod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyIl0KICAgICAgICBod3RhY2Fjc192cG5fbmFtZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3Zwbl9uYW1lIl0KICAgICAgICBod3RhY2Fjc19pc19wdWJsaWNfbmV0ID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3NfaXNfcHVibGljX25ldCJdCiAgICAgICAgc3RhdGUgPSBtb2R1bGUucGFyYW1zWyJzdGF0ZSJdCgogICAgICAgIHJlc3VsdCA9IGRpY3QoKQogICAgICAgIHJlc3VsdFsiaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY0Il0gPSBbXQogICAgICAgIG5lZWRfY2ZnID0gRmFsc2UKCiAgICAgICAgY29uZl9zdHIgPSBDRV9HRVRfSFdUQUNBQ1NfU0VSVkVSX0NGR19JUFY0ICUgaHd0YWNhY3NfdGVtcGxhdGUKCiAgICAgICAgcmVjdl94bWwgPSBzZWxmLm5ldGNvbmZfZ2V0X2NvbmZpZyhtb2R1bGU9bW9kdWxlLCBjb25mX3N0cj1jb25mX3N0cikKCiAgICAgICAgaWYgIjxkYXRhLz4iIGluIHJlY3ZfeG1sOgogICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKCiAgICAgICAgZWxzZToKICAgICAgICAgICAgeG1sX3N0ciA9IHJlY3ZfeG1sLnJlcGxhY2UoJ1xyJywgJycpLnJlcGxhY2UoJ1xuJywgJycpLlwKICAgICAgICAgICAgICAgIHJlcGxhY2UoJ3htbG5zPSJ1cm46aWV0ZjpwYXJhbXM6eG1sOm5zOm5ldGNvbmY6YmFzZToxLjAiJywgIiIpLlwKICAgICAgICAgICAgICAgIHJlcGxhY2UoJ3htbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiJywgIiIpCgogICAgICAgICAgICByb290ID0gRWxlbWVudFRyZWUuZnJvbXN0cmluZyh4bWxfc3RyKQogICAgICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjQgPSByb290LmZpbmRhbGwoCiAgICAgICAgICAgICAgICAiZGF0YS9od3RhY2Fjcy9od1RhY1RlbXBDZmdzL2h3VGFjVGVtcENmZy9od1RhY1NydkNmZ3MvaHdUYWNTcnZDZmciKQogICAgICAgICAgICBpZiBod3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjQ6CiAgICAgICAgICAgICAgICBmb3IgdG1wIGluIGh3dGFjYWNzX3NlcnZlcl9jZmdfaXB2NDoKICAgICAgICAgICAgICAgICAgICB0bXBfZGljdCA9IGRpY3QoKQogICAgICAgICAgICAgICAgICAgIGZvciBzaXRlIGluIHRtcDoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2l0ZS50YWcgaW4gWyJzZXJ2ZXJJcEFkZHJlc3MiLCAic2VydmVyVHlwZSIsICJpc1NlY29uZGFyeVNlcnZlciIsICJpc1B1YmxpY05ldCIsICJ2cG5OYW1lIl06CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBfZGljdFtzaXRlLnRhZ10gPSBzaXRlLnRleHQKCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0WyJod3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjQiXS5hcHBlbmQodG1wX2RpY3QpCgogICAgICAgICAgICBpZiByZXN1bHRbImh3dGFjYWNzX3NlcnZlcl9jZmdfaXB2NCJdOgogICAgICAgICAgICAgICAgZm9yIHRtcCBpbiByZXN1bHRbImh3dGFjYWNzX3NlcnZlcl9jZmdfaXB2NCJdOgogICAgICAgICAgICAgICAgICAgIGlmICJzZXJ2ZXJJcEFkZHJlc3MiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVySXBBZGRyZXNzIl0gIT0gaHd0YWNhY3Nfc2VydmVyX2lwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJzZXJ2ZXJJcEFkZHJlc3MiXSA9PSBod3RhY2Fjc19zZXJ2ZXJfaXA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgInNlcnZlclR5cGUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyVHlwZSJdICE9IGh3dGFjYWNzX3NlcnZlcl90eXBlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJzZXJ2ZXJUeXBlIl0gPT0gaHd0YWNhY3Nfc2VydmVyX3R5cGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgImlzU2Vjb25kYXJ5U2VydmVyIiBpbiB0bXAua2V5cygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbImlzU2Vjb25kYXJ5U2VydmVyIl0gIT0gc3RyKGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbImlzU2Vjb25kYXJ5U2VydmVyIl0gPT0gc3RyKGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgImlzUHVibGljTmV0IiBpbiB0bXAua2V5cygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbImlzUHVibGljTmV0Il0gIT0gc3RyKGh3dGFjYWNzX2lzX3B1YmxpY19uZXQpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbImlzUHVibGljTmV0Il0gPT0gc3RyKGh3dGFjYWNzX2lzX3B1YmxpY19uZXQpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgInZwbk5hbWUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsidnBuTmFtZSJdICE9IGh3dGFjYWNzX3Zwbl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJ2cG5OYW1lIl0gPT0gaHd0YWNhY3NfdnBuX25hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCgogICAgICAgIHJlc3VsdFsibmVlZF9jZmciXSA9IG5lZWRfY2ZnCiAgICAgICAgcmV0dXJuIHJlc3VsdAoKICAgIGRlZiBtZXJnZV9od3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjQoc2VsZiwgKiprd2FyZ3MpOgogICAgICAgICIiIiBNZXJnZSBod3RhY2FjcyBzZXJ2ZXIgY29uZmlndXJlIGlwdjQgIiIiCgogICAgICAgIG1vZHVsZSA9IGt3YXJnc1sibW9kdWxlIl0KICAgICAgICBod3RhY2Fjc190ZW1wbGF0ZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3RlbXBsYXRlIl0KICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfaXAgPSBtb2R1bGUucGFyYW1zWyJod3RhY2Fjc19zZXJ2ZXJfaXAiXQogICAgICAgIGh3dGFjYWNzX3NlcnZlcl90eXBlID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3Nfc2VydmVyX3R5cGUiXQogICAgICAgIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIgPSBtb2R1bGUucGFyYW1zWwogICAgICAgICAgICAiaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlciJdCiAgICAgICAgaHd0YWNhY3NfdnBuX25hbWUgPSBtb2R1bGUucGFyYW1zWyJod3RhY2Fjc192cG5fbmFtZSJdCiAgICAgICAgaHd0YWNhY3NfaXNfcHVibGljX25ldCA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX2lzX3B1YmxpY19uZXQiXQoKICAgICAgICBjb25mX3N0ciA9IENFX01FUkdFX0hXVEFDQUNTX1NFUlZFUl9DRkdfSVBWNCAlICgKICAgICAgICAgICAgaHd0YWNhY3NfdGVtcGxhdGUsIGh3dGFjYWNzX3NlcnZlcl9pcCwKICAgICAgICAgICAgaHd0YWNhY3Nfc2VydmVyX3R5cGUsIHN0cihod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyKS5sb3dlcigpLAogICAgICAgICAgICBod3RhY2Fjc192cG5fbmFtZSwgc3RyKGh3dGFjYWNzX2lzX3B1YmxpY19uZXQpLmxvd2VyKCkpCgogICAgICAgIHJlY3ZfeG1sID0gc2VsZi5uZXRjb25mX3NldF9jb25maWcobW9kdWxlPW1vZHVsZSwgY29uZl9zdHI9Y29uZl9zdHIpCgogICAgICAgIGlmICI8b2svPiIgbm90IGluIHJlY3ZfeG1sOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogTWVyZ2UgaHd0YWNhY3Mgc2VydmVyIGNvbmZpZyBpcHY0IGZhaWxlZC4nKQoKICAgICAgICBjbWRzID0gW10KCiAgICAgICAgY21kID0gImh3dGFjYWNzIHNlcnZlciB0ZW1wbGF0ZSAlcyIgJSBod3RhY2Fjc190ZW1wbGF0ZQogICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKCiAgICAgICAgaWYgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPT0gIkF1dGhlbnRpY2F0aW9uIjoKICAgICAgICAgICAgY21kID0gImh3dGFjYWNzIHNlcnZlciBhdXRoZW50aWNhdGlvbiAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaXAKICAgICAgICAgICAgaWYgaHd0YWNhY3NfdnBuX25hbWUgYW5kIGh3dGFjYWNzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgaHd0YWNhY3NfdnBuX25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfcHVibGljX25ldDoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHB1YmxpYy1uZXQiCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGVsaWYgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPT0gIkF1dGhvcml6YXRpb24iOgogICAgICAgICAgICBjbWQgPSAiaHd0YWNhY3Mgc2VydmVyIGF1dGhvcml6YXRpb24gJXMiICUgaHd0YWNhY3Nfc2VydmVyX2lwCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX3Zwbl9uYW1lIGFuZCBod3RhY2Fjc192cG5fbmFtZSAhPSAiX3B1YmxpY18iOgogICAgICAgICAgICAgICAgY21kICs9ICIgdnBuLWluc3RhbmNlICVzIiAlIGh3dGFjYWNzX3Zwbl9uYW1lCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3B1YmxpY19uZXQ6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBwdWJsaWMtbmV0IgogICAgICAgICAgICBpZiBod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyOgogICAgICAgICAgICAgICAgY21kICs9ICIgc2Vjb25kYXJ5IgoKICAgICAgICBlbGlmIGh3dGFjYWNzX3NlcnZlcl90eXBlID09ICJBY2NvdW50aW5nIjoKICAgICAgICAgICAgY21kID0gImh3dGFjYWNzIHNlcnZlciBhY2NvdW50aW5nICVzIiAlIGh3dGFjYWNzX3NlcnZlcl9pcAogICAgICAgICAgICBpZiBod3RhY2Fjc192cG5fbmFtZSBhbmQgaHd0YWNhY3NfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSBod3RhY2Fjc192cG5fbmFtZQogICAgICAgICAgICBpZiBod3RhY2Fjc19pc19wdWJsaWNfbmV0OgogICAgICAgICAgICAgICAgY21kICs9ICIgcHVibGljLW5ldCIKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlcjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHNlY29uZGFyeSIKCiAgICAgICAgZWxpZiBod3RhY2Fjc19zZXJ2ZXJfdHlwZSA9PSAiQ29tbW9uIjoKICAgICAgICAgICAgY21kID0gImh3dGFjYWNzIHNlcnZlciAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaXAKICAgICAgICAgICAgaWYgaHd0YWNhY3NfdnBuX25hbWUgYW5kIGh3dGFjYWNzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgaHd0YWNhY3NfdnBuX25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfcHVibGljX25ldDoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHB1YmxpYy1uZXQiCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKICAgICAgICByZXR1cm4gY21kcwoKICAgIGRlZiBkZWxldGVfaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY0KHNlbGYsICoqa3dhcmdzKToKICAgICAgICAiIiIgRGVsZXRlIGh3dGFjYWNzIHNlcnZlciBjb25maWd1cmUgaXB2NCAiIiIKCiAgICAgICAgbW9kdWxlID0ga3dhcmdzWyJtb2R1bGUiXQogICAgICAgIGh3dGFjYWNzX3RlbXBsYXRlID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3NfdGVtcGxhdGUiXQogICAgICAgIGh3dGFjYWNzX3NlcnZlcl9pcCA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3NlcnZlcl9pcCJdCiAgICAgICAgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPSBtb2R1bGUucGFyYW1zWyJod3RhY2Fjc19zZXJ2ZXJfdHlwZSJdCiAgICAgICAgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlciA9IG1vZHVsZS5wYXJhbXNbCiAgICAgICAgICAgICJod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyIl0KICAgICAgICBod3RhY2Fjc192cG5fbmFtZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3Zwbl9uYW1lIl0KICAgICAgICBod3RhY2Fjc19pc19wdWJsaWNfbmV0ID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3NfaXNfcHVibGljX25ldCJdCgogICAgICAgIGNvbmZfc3RyID0gQ0VfREVMRVRFX0hXVEFDQUNTX1NFUlZFUl9DRkdfSVBWNCAlICgKICAgICAgICAgICAgaHd0YWNhY3NfdGVtcGxhdGUsIGh3dGFjYWNzX3NlcnZlcl9pcCwKICAgICAgICAgICAgaHd0YWNhY3Nfc2VydmVyX3R5cGUsIHN0cihod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyKS5sb3dlcigpLAogICAgICAgICAgICBod3RhY2Fjc192cG5fbmFtZSwgc3RyKGh3dGFjYWNzX2lzX3B1YmxpY19uZXQpLmxvd2VyKCkpCgogICAgICAgIHJlY3ZfeG1sID0gc2VsZi5uZXRjb25mX3NldF9jb25maWcobW9kdWxlPW1vZHVsZSwgY29uZl9zdHI9Y29uZl9zdHIpCgogICAgICAgIGlmICI8b2svPiIgbm90IGluIHJlY3ZfeG1sOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogRGVsZXRlIGh3dGFjYWNzIHNlcnZlciBjb25maWcgaXB2NCBmYWlsZWQuJykKCiAgICAgICAgY21kcyA9IFtdCgogICAgICAgIGNtZCA9ICJod3RhY2FjcyBzZXJ2ZXIgdGVtcGxhdGUgJXMiICUgaHd0YWNhY3NfdGVtcGxhdGUKICAgICAgICBjbWRzLmFwcGVuZChjbWQpCgogICAgICAgIGlmIGh3dGFjYWNzX3NlcnZlcl90eXBlID09ICJBdXRoZW50aWNhdGlvbiI6CiAgICAgICAgICAgIGNtZCA9ICJ1bmRvIGh3dGFjYWNzIHNlcnZlciBhdXRoZW50aWNhdGlvbiAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaXAKICAgICAgICAgICAgaWYgaHd0YWNhY3NfdnBuX25hbWUgYW5kIGh3dGFjYWNzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgaHd0YWNhY3NfdnBuX25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfcHVibGljX25ldDoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHB1YmxpYy1uZXQiCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGVsaWYgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPT0gIkF1dGhvcml6YXRpb24iOgogICAgICAgICAgICBjbWQgPSAidW5kbyBod3RhY2FjcyBzZXJ2ZXIgYXV0aG9yaXphdGlvbiAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaXAKICAgICAgICAgICAgaWYgaHd0YWNhY3NfdnBuX25hbWUgYW5kIGh3dGFjYWNzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgaHd0YWNhY3NfdnBuX25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfcHVibGljX25ldDoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHB1YmxpYy1uZXQiCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGVsaWYgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPT0gIkFjY291bnRpbmciOgogICAgICAgICAgICBjbWQgPSAidW5kbyBod3RhY2FjcyBzZXJ2ZXIgYWNjb3VudGluZyAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaXAKICAgICAgICAgICAgaWYgaHd0YWNhY3NfdnBuX25hbWUgYW5kIGh3dGFjYWNzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgaHd0YWNhY3NfdnBuX25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfcHVibGljX25ldDoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHB1YmxpYy1uZXQiCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGVsaWYgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPT0gIkNvbW1vbiI6CiAgICAgICAgICAgIGNtZCA9ICJ1bmRvIGh3dGFjYWNzIHNlcnZlciAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaXAKICAgICAgICAgICAgaWYgaHd0YWNhY3NfdnBuX25hbWUgYW5kIGh3dGFjYWNzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgaHd0YWNhY3NfdnBuX25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfcHVibGljX25ldDoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHB1YmxpYy1uZXQiCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGNtZHMuYXBwZW5kKGNtZCkKICAgICAgICByZXR1cm4gY21kcwoKICAgIGRlZiBnZXRfaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY2KHNlbGYsICoqa3dhcmdzKToKICAgICAgICAiIiIgR2V0IGh3dGFjYWNzIHNlcnZlciBjb25maWd1cmUgaXB2NiAiIiIKCiAgICAgICAgbW9kdWxlID0ga3dhcmdzWyJtb2R1bGUiXQogICAgICAgIGh3dGFjYWNzX3RlbXBsYXRlID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3NfdGVtcGxhdGUiXQogICAgICAgIGh3dGFjYWNzX3NlcnZlcl9pcHY2ID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3Nfc2VydmVyX2lwdjYiXQogICAgICAgIGh3dGFjYWNzX3NlcnZlcl90eXBlID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3Nfc2VydmVyX3R5cGUiXQogICAgICAgIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIgPSBtb2R1bGUucGFyYW1zWwogICAgICAgICAgICAiaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlciJdCiAgICAgICAgaHd0YWNhY3NfdnBuX25hbWUgPSBtb2R1bGUucGFyYW1zWyJod3RhY2Fjc192cG5fbmFtZSJdCiAgICAgICAgc3RhdGUgPSBtb2R1bGUucGFyYW1zWyJzdGF0ZSJdCgogICAgICAgIHJlc3VsdCA9IGRpY3QoKQogICAgICAgIHJlc3VsdFsiaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY2Il0gPSBbXQogICAgICAgIG5lZWRfY2ZnID0gRmFsc2UKCiAgICAgICAgY29uZl9zdHIgPSBDRV9HRVRfSFdUQUNBQ1NfU0VSVkVSX0NGR19JUFY2ICUgaHd0YWNhY3NfdGVtcGxhdGUKCiAgICAgICAgcmVjdl94bWwgPSBzZWxmLm5ldGNvbmZfZ2V0X2NvbmZpZyhtb2R1bGU9bW9kdWxlLCBjb25mX3N0cj1jb25mX3N0cikKCiAgICAgICAgaWYgIjxkYXRhLz4iIGluIHJlY3ZfeG1sOgogICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKCiAgICAgICAgZWxzZToKICAgICAgICAgICAgeG1sX3N0ciA9IHJlY3ZfeG1sLnJlcGxhY2UoJ1xyJywgJycpLnJlcGxhY2UoJ1xuJywgJycpLlwKICAgICAgICAgICAgICAgIHJlcGxhY2UoJ3htbG5zPSJ1cm46aWV0ZjpwYXJhbXM6eG1sOm5zOm5ldGNvbmY6YmFzZToxLjAiJywgIiIpLlwKICAgICAgICAgICAgICAgIHJlcGxhY2UoJ3htbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiJywgIiIpCgogICAgICAgICAgICByb290ID0gRWxlbWVudFRyZWUuZnJvbXN0cmluZyh4bWxfc3RyKQogICAgICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjYgPSByb290LmZpbmRhbGwoCiAgICAgICAgICAgICAgICAiZGF0YS9od3RhY2Fjcy9od1RhY1RlbXBDZmdzL2h3VGFjVGVtcENmZy9od1RhY0lwdjZTcnZDZmdzL2h3VGFjSXB2NlNydkNmZyIpCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX3NlcnZlcl9jZmdfaXB2NjoKICAgICAgICAgICAgICAgIGZvciB0bXAgaW4gaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY2OgogICAgICAgICAgICAgICAgICAgIHRtcF9kaWN0ID0gZGljdCgpCiAgICAgICAgICAgICAgICAgICAgZm9yIHNpdGUgaW4gdG1wOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzaXRlLnRhZyBpbiBbInNlcnZlcklwQWRkcmVzcyIsICJzZXJ2ZXJUeXBlIiwgImlzU2Vjb25kYXJ5U2VydmVyIiwgInZwbk5hbWUiXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcF9kaWN0W3NpdGUudGFnXSA9IHNpdGUudGV4dAoKICAgICAgICAgICAgICAgICAgICByZXN1bHRbImh3dGFjYWNzX3NlcnZlcl9jZmdfaXB2NiJdLmFwcGVuZCh0bXBfZGljdCkKCiAgICAgICAgICAgIGlmIHJlc3VsdFsiaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY2Il06CiAgICAgICAgICAgICAgICBmb3IgdG1wIGluIHJlc3VsdFsiaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY2Il06CiAgICAgICAgICAgICAgICAgICAgaWYgInNlcnZlcklwQWRkcmVzcyIgaW4gdG1wLmtleXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc3RhdGUgPT0gInByZXNlbnQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJzZXJ2ZXJJcEFkZHJlc3MiXSAhPSBod3RhY2Fjc19zZXJ2ZXJfaXB2NjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVySXBBZGRyZXNzIl0gPT0gaHd0YWNhY3Nfc2VydmVyX2lwdjY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgInNlcnZlclR5cGUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyVHlwZSJdICE9IGh3dGFjYWNzX3NlcnZlcl90eXBlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJzZXJ2ZXJUeXBlIl0gPT0gaHd0YWNhY3Nfc2VydmVyX3R5cGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgImlzU2Vjb25kYXJ5U2VydmVyIiBpbiB0bXAua2V5cygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbImlzU2Vjb25kYXJ5U2VydmVyIl0gIT0gc3RyKGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbImlzU2Vjb25kYXJ5U2VydmVyIl0gPT0gc3RyKGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgInZwbk5hbWUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsidnBuTmFtZSJdICE9IGh3dGFjYWNzX3Zwbl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJ2cG5OYW1lIl0gPT0gaHd0YWNhY3NfdnBuX25hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCgogICAgICAgIHJlc3VsdFsibmVlZF9jZmciXSA9IG5lZWRfY2ZnCiAgICAgICAgcmV0dXJuIHJlc3VsdAoKICAgIGRlZiBtZXJnZV9od3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjYoc2VsZiwgKiprd2FyZ3MpOgogICAgICAgICIiIiBNZXJnZSBod3RhY2FjcyBzZXJ2ZXIgY29uZmlndXJlIGlwdjYgIiIiCgogICAgICAgIG1vZHVsZSA9IGt3YXJnc1sibW9kdWxlIl0KICAgICAgICBod3RhY2Fjc190ZW1wbGF0ZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3RlbXBsYXRlIl0KICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfaXB2NiA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3NlcnZlcl9pcHY2Il0KICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfdHlwZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3NlcnZlcl90eXBlIl0KICAgICAgICBod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyID0gbW9kdWxlLnBhcmFtc1sKICAgICAgICAgICAgImh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIiXQogICAgICAgIGh3dGFjYWNzX3Zwbl9uYW1lID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3NfdnBuX25hbWUiXQoKICAgICAgICBjb25mX3N0ciA9IENFX01FUkdFX0hXVEFDQUNTX1NFUlZFUl9DRkdfSVBWNiAlICgKICAgICAgICAgICAgaHd0YWNhY3NfdGVtcGxhdGUsIGh3dGFjYWNzX3NlcnZlcl9pcHY2LAogICAgICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfdHlwZSwgc3RyKGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIpLmxvd2VyKCksCiAgICAgICAgICAgIGh3dGFjYWNzX3Zwbl9uYW1lKQoKICAgICAgICByZWN2X3htbCA9IHNlbGYubmV0Y29uZl9zZXRfY29uZmlnKG1vZHVsZT1tb2R1bGUsIGNvbmZfc3RyPWNvbmZfc3RyKQoKICAgICAgICBpZiAiPG9rLz4iIG5vdCBpbiByZWN2X3htbDoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IE1lcmdlIGh3dGFjYWNzIHNlcnZlciBjb25maWcgaXB2NiBmYWlsZWQuJykKCiAgICAgICAgY21kcyA9IFtdCgogICAgICAgIGNtZCA9ICJod3RhY2FjcyBzZXJ2ZXIgdGVtcGxhdGUgJXMiICUgaHd0YWNhY3NfdGVtcGxhdGUKICAgICAgICBjbWRzLmFwcGVuZChjbWQpCgogICAgICAgIGlmIGh3dGFjYWNzX3NlcnZlcl90eXBlID09ICJBdXRoZW50aWNhdGlvbiI6CiAgICAgICAgICAgIGNtZCA9ICJod3RhY2FjcyBzZXJ2ZXIgYXV0aGVudGljYXRpb24gJXMiICUgaHd0YWNhY3Nfc2VydmVyX2lwdjYKICAgICAgICAgICAgaWYgaHd0YWNhY3NfdnBuX25hbWUgYW5kIGh3dGFjYWNzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgaHd0YWNhY3NfdnBuX25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlcjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHNlY29uZGFyeSIKCiAgICAgICAgZWxpZiBod3RhY2Fjc19zZXJ2ZXJfdHlwZSA9PSAiQXV0aG9yaXphdGlvbiI6CiAgICAgICAgICAgIGNtZCA9ICJod3RhY2FjcyBzZXJ2ZXIgYXV0aG9yaXphdGlvbiAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaXB2NgogICAgICAgICAgICBpZiBod3RhY2Fjc192cG5fbmFtZSBhbmQgaHd0YWNhY3NfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSBod3RhY2Fjc192cG5fbmFtZQogICAgICAgICAgICBpZiBod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyOgogICAgICAgICAgICAgICAgY21kICs9ICIgc2Vjb25kYXJ5IgoKICAgICAgICBlbGlmIGh3dGFjYWNzX3NlcnZlcl90eXBlID09ICJBY2NvdW50aW5nIjoKICAgICAgICAgICAgY21kID0gImh3dGFjYWNzIHNlcnZlciBhY2NvdW50aW5nICVzIiAlIGh3dGFjYWNzX3NlcnZlcl9pcHY2CiAgICAgICAgICAgIGlmIGh3dGFjYWNzX3Zwbl9uYW1lIGFuZCBod3RhY2Fjc192cG5fbmFtZSAhPSAiX3B1YmxpY18iOgogICAgICAgICAgICAgICAgY21kICs9ICIgdnBuLWluc3RhbmNlICVzIiAlIGh3dGFjYWNzX3Zwbl9uYW1lCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGVsaWYgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPT0gIkNvbW1vbiI6CiAgICAgICAgICAgIGNtZCA9ICJod3RhY2FjcyBzZXJ2ZXIgJXMiICUgaHd0YWNhY3Nfc2VydmVyX2lwdjYKICAgICAgICAgICAgaWYgaHd0YWNhY3NfdnBuX25hbWUgYW5kIGh3dGFjYWNzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgaHd0YWNhY3NfdnBuX25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlcjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHNlY29uZGFyeSIKCiAgICAgICAgY21kcy5hcHBlbmQoY21kKQogICAgICAgIHJldHVybiBjbWRzCgogICAgZGVmIGRlbGV0ZV9od3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjYoc2VsZiwgKiprd2FyZ3MpOgogICAgICAgICIiIiBEZWxldGUgaHd0YWNhY3Mgc2VydmVyIGNvbmZpZ3VyZSBpcHY2ICIiIgoKICAgICAgICBtb2R1bGUgPSBrd2FyZ3NbIm1vZHVsZSJdCiAgICAgICAgaHd0YWNhY3NfdGVtcGxhdGUgPSBtb2R1bGUucGFyYW1zWyJod3RhY2Fjc190ZW1wbGF0ZSJdCiAgICAgICAgaHd0YWNhY3Nfc2VydmVyX2lwdjYgPSBtb2R1bGUucGFyYW1zWyJod3RhY2Fjc19zZXJ2ZXJfaXB2NiJdCiAgICAgICAgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPSBtb2R1bGUucGFyYW1zWyJod3RhY2Fjc19zZXJ2ZXJfdHlwZSJdCiAgICAgICAgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlciA9IG1vZHVsZS5wYXJhbXNbCiAgICAgICAgICAgICJod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyIl0KICAgICAgICBod3RhY2Fjc192cG5fbmFtZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3Zwbl9uYW1lIl0KCiAgICAgICAgY29uZl9zdHIgPSBDRV9ERUxFVEVfSFdUQUNBQ1NfU0VSVkVSX0NGR19JUFY2ICUgKAogICAgICAgICAgICBod3RhY2Fjc190ZW1wbGF0ZSwgaHd0YWNhY3Nfc2VydmVyX2lwdjYsCiAgICAgICAgICAgIGh3dGFjYWNzX3NlcnZlcl90eXBlLCBzdHIoaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlcikubG93ZXIoKSwKICAgICAgICAgICAgaHd0YWNhY3NfdnBuX25hbWUpCgogICAgICAgIHJlY3ZfeG1sID0gc2VsZi5uZXRjb25mX3NldF9jb25maWcobW9kdWxlPW1vZHVsZSwgY29uZl9zdHI9Y29uZl9zdHIpCgogICAgICAgIGlmICI8b2svPiIgbm90IGluIHJlY3ZfeG1sOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogRGVsZXRlIGh3dGFjYWNzIHNlcnZlciBjb25maWcgaXB2NiBmYWlsZWQuJykKCiAgICAgICAgY21kcyA9IFtdCgogICAgICAgIGNtZCA9ICJod3RhY2FjcyBzZXJ2ZXIgdGVtcGxhdGUgJXMiICUgaHd0YWNhY3NfdGVtcGxhdGUKICAgICAgICBjbWRzLmFwcGVuZChjbWQpCgogICAgICAgIGlmIGh3dGFjYWNzX3NlcnZlcl90eXBlID09ICJBdXRoZW50aWNhdGlvbiI6CiAgICAgICAgICAgIGNtZCA9ICJ1bmRvIGh3dGFjYWNzIHNlcnZlciBhdXRoZW50aWNhdGlvbiAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaXB2NgogICAgICAgICAgICBpZiBod3RhY2Fjc192cG5fbmFtZSBhbmQgaHd0YWNhY3NfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSBod3RhY2Fjc192cG5fbmFtZQogICAgICAgICAgICBpZiBod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyOgogICAgICAgICAgICAgICAgY21kICs9ICIgc2Vjb25kYXJ5IgoKICAgICAgICBlbGlmIGh3dGFjYWNzX3NlcnZlcl90eXBlID09ICJBdXRob3JpemF0aW9uIjoKICAgICAgICAgICAgY21kID0gInVuZG8gaHd0YWNhY3Mgc2VydmVyIGF1dGhvcml6YXRpb24gJXMiICUgaHd0YWNhY3Nfc2VydmVyX2lwdjYKICAgICAgICAgICAgaWYgaHd0YWNhY3NfdnBuX25hbWUgYW5kIGh3dGFjYWNzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgaHd0YWNhY3NfdnBuX25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlcjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHNlY29uZGFyeSIKCiAgICAgICAgZWxpZiBod3RhY2Fjc19zZXJ2ZXJfdHlwZSA9PSAiQWNjb3VudGluZyI6CiAgICAgICAgICAgIGNtZCA9ICJ1bmRvIGh3dGFjYWNzIHNlcnZlciBhY2NvdW50aW5nICVzIiAlIGh3dGFjYWNzX3NlcnZlcl9pcHY2CiAgICAgICAgICAgIGlmIGh3dGFjYWNzX3Zwbl9uYW1lIGFuZCBod3RhY2Fjc192cG5fbmFtZSAhPSAiX3B1YmxpY18iOgogICAgICAgICAgICAgICAgY21kICs9ICIgdnBuLWluc3RhbmNlICVzIiAlIGh3dGFjYWNzX3Zwbl9uYW1lCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGVsaWYgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPT0gIkNvbW1vbiI6CiAgICAgICAgICAgIGNtZCA9ICJ1bmRvIGh3dGFjYWNzIHNlcnZlciAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaXB2NgogICAgICAgICAgICBpZiBod3RhY2Fjc192cG5fbmFtZSBhbmQgaHd0YWNhY3NfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSBod3RhY2Fjc192cG5fbmFtZQogICAgICAgICAgICBpZiBod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyOgogICAgICAgICAgICAgICAgY21kICs9ICIgc2Vjb25kYXJ5IgoKICAgICAgICBjbWRzLmFwcGVuZChjbWQpCiAgICAgICAgcmV0dXJuIGNtZHMKCiAgICBkZWYgZ2V0X2h3dGFjYWNzX2hvc3Rfc2VydmVyX2NmZyhzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgIiIiIEdldCBod3RhY2FjcyBob3N0IHNlcnZlciBjb25maWd1cmUgIiIiCgogICAgICAgIG1vZHVsZSA9IGt3YXJnc1sibW9kdWxlIl0KICAgICAgICBod3RhY2Fjc190ZW1wbGF0ZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3RlbXBsYXRlIl0KICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZSJdCiAgICAgICAgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPSBtb2R1bGUucGFyYW1zWyJod3RhY2Fjc19zZXJ2ZXJfdHlwZSJdCiAgICAgICAgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlciA9IG1vZHVsZS5wYXJhbXNbCiAgICAgICAgICAgICJod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyIl0KICAgICAgICBod3RhY2Fjc192cG5fbmFtZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3Zwbl9uYW1lIl0KICAgICAgICBod3RhY2Fjc19pc19wdWJsaWNfbmV0ID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3NfaXNfcHVibGljX25ldCJdCiAgICAgICAgc3RhdGUgPSBtb2R1bGUucGFyYW1zWyJzdGF0ZSJdCgogICAgICAgIHJlc3VsdCA9IGRpY3QoKQogICAgICAgIHJlc3VsdFsiaHd0YWNhY3Nfc2VydmVyX25hbWVfY2ZnIl0gPSBbXQogICAgICAgIG5lZWRfY2ZnID0gRmFsc2UKCiAgICAgICAgY29uZl9zdHIgPSBDRV9HRVRfSFdUQUNBQ1NfSE9TVF9TRVJWRVJfQ0ZHICUgaHd0YWNhY3NfdGVtcGxhdGUKCiAgICAgICAgcmVjdl94bWwgPSBzZWxmLm5ldGNvbmZfZ2V0X2NvbmZpZyhtb2R1bGU9bW9kdWxlLCBjb25mX3N0cj1jb25mX3N0cikKCiAgICAgICAgaWYgIjxkYXRhLz4iIGluIHJlY3ZfeG1sOgogICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICBuZWVkX2NmZyA9IFRydWUKCiAgICAgICAgZWxzZToKICAgICAgICAgICAgeG1sX3N0ciA9IHJlY3ZfeG1sLnJlcGxhY2UoJ1xyJywgJycpLnJlcGxhY2UoJ1xuJywgJycpLlwKICAgICAgICAgICAgICAgIHJlcGxhY2UoJ3htbG5zPSJ1cm46aWV0ZjpwYXJhbXM6eG1sOm5zOm5ldGNvbmY6YmFzZToxLjAiJywgIiIpLlwKICAgICAgICAgICAgICAgIHJlcGxhY2UoJ3htbG5zPSJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi92cnAiJywgIiIpCgogICAgICAgICAgICByb290ID0gRWxlbWVudFRyZWUuZnJvbXN0cmluZyh4bWxfc3RyKQogICAgICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfbmFtZV9jZmcgPSByb290LmZpbmRhbGwoCiAgICAgICAgICAgICAgICAiZGF0YS9od3RhY2Fjcy9od1RhY1RlbXBDZmdzL2h3VGFjVGVtcENmZy9od1RhY0hvc3RTcnZDZmdzL2h3VGFjSG9zdFNydkNmZyIpCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX3NlcnZlcl9uYW1lX2NmZzoKICAgICAgICAgICAgICAgIGZvciB0bXAgaW4gaHd0YWNhY3Nfc2VydmVyX25hbWVfY2ZnOgogICAgICAgICAgICAgICAgICAgIHRtcF9kaWN0ID0gZGljdCgpCiAgICAgICAgICAgICAgICAgICAgZm9yIHNpdGUgaW4gdG1wOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzaXRlLnRhZyBpbiBbInNlcnZlckhvc3ROYW1lIiwgInNlcnZlclR5cGUiLCAiaXNTZWNvbmRhcnlTZXJ2ZXIiLCAiaXNQdWJsaWNOZXQiLCAidnBuTmFtZSJdOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wX2RpY3Rbc2l0ZS50YWddID0gc2l0ZS50ZXh0CgogICAgICAgICAgICAgICAgICAgIHJlc3VsdFsiaHd0YWNhY3Nfc2VydmVyX25hbWVfY2ZnIl0uYXBwZW5kKHRtcF9kaWN0KQoKICAgICAgICAgICAgaWYgcmVzdWx0WyJod3RhY2Fjc19zZXJ2ZXJfbmFtZV9jZmciXToKICAgICAgICAgICAgICAgIGZvciB0bXAgaW4gcmVzdWx0WyJod3RhY2Fjc19zZXJ2ZXJfbmFtZV9jZmciXToKICAgICAgICAgICAgICAgICAgICBpZiAic2VydmVySG9zdE5hbWUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVySG9zdE5hbWUiXSAhPSBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJzZXJ2ZXJIb3N0TmFtZSJdID09IGh3dGFjYWNzX3NlcnZlcl9ob3N0X25hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgInNlcnZlclR5cGUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsic2VydmVyVHlwZSJdICE9IGh3dGFjYWNzX3NlcnZlcl90eXBlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJzZXJ2ZXJUeXBlIl0gPT0gaHd0YWNhY3Nfc2VydmVyX3R5cGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgImlzU2Vjb25kYXJ5U2VydmVyIiBpbiB0bXAua2V5cygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbImlzU2Vjb25kYXJ5U2VydmVyIl0gIT0gc3RyKGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbImlzU2Vjb25kYXJ5U2VydmVyIl0gPT0gc3RyKGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgImlzUHVibGljTmV0IiBpbiB0bXAua2V5cygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbImlzUHVibGljTmV0Il0gIT0gc3RyKGh3dGFjYWNzX2lzX3B1YmxpY19uZXQpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0bXBbImlzUHVibGljTmV0Il0gPT0gc3RyKGh3dGFjYWNzX2lzX3B1YmxpY19uZXQpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgaWYgInZwbk5hbWUiIGluIHRtcC5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcFsidnBuTmFtZSJdICE9IGh3dGFjYWNzX3Zwbl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRfY2ZnID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wWyJ2cG5OYW1lIl0gPT0gaHd0YWNhY3NfdnBuX25hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVlZF9jZmcgPSBUcnVlCgogICAgICAgIHJlc3VsdFsibmVlZF9jZmciXSA9IG5lZWRfY2ZnCiAgICAgICAgcmV0dXJuIHJlc3VsdAoKICAgIGRlZiBtZXJnZV9od3RhY2Fjc19ob3N0X3NlcnZlcl9jZmcoc2VsZiwgKiprd2FyZ3MpOgogICAgICAgICIiIiBNZXJnZSBod3RhY2FjcyBob3N0IHNlcnZlciBjb25maWd1cmUgIiIiCgogICAgICAgIG1vZHVsZSA9IGt3YXJnc1sibW9kdWxlIl0KICAgICAgICBod3RhY2Fjc190ZW1wbGF0ZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3RlbXBsYXRlIl0KICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZSJdCiAgICAgICAgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPSBtb2R1bGUucGFyYW1zWyJod3RhY2Fjc19zZXJ2ZXJfdHlwZSJdCiAgICAgICAgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlciA9IG1vZHVsZS5wYXJhbXNbCiAgICAgICAgICAgICJod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyIl0KICAgICAgICBod3RhY2Fjc192cG5fbmFtZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3Zwbl9uYW1lIl0KICAgICAgICBod3RhY2Fjc19pc19wdWJsaWNfbmV0ID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3NfaXNfcHVibGljX25ldCJdCgogICAgICAgIGNvbmZfc3RyID0gQ0VfTUVSR0VfSFdUQUNBQ1NfSE9TVF9TRVJWRVJfQ0ZHICUgKAogICAgICAgICAgICBod3RhY2Fjc190ZW1wbGF0ZSwgaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZSwKICAgICAgICAgICAgaHd0YWNhY3Nfc2VydmVyX3R5cGUsIHN0cihod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyKS5sb3dlcigpLAogICAgICAgICAgICBod3RhY2Fjc192cG5fbmFtZSwgc3RyKGh3dGFjYWNzX2lzX3B1YmxpY19uZXQpLmxvd2VyKCkpCgogICAgICAgIHJlY3ZfeG1sID0gc2VsZi5uZXRjb25mX3NldF9jb25maWcobW9kdWxlPW1vZHVsZSwgY29uZl9zdHI9Y29uZl9zdHIpCgogICAgICAgIGlmICI8b2svPiIgbm90IGluIHJlY3ZfeG1sOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogTWVyZ2UgaHd0YWNhY3MgaG9zdCBzZXJ2ZXIgY29uZmlnIGZhaWxlZC4nKQoKICAgICAgICBjbWRzID0gW10KCiAgICAgICAgaWYgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPT0gIkF1dGhlbnRpY2F0aW9uIjoKICAgICAgICAgICAgY21kID0gImh3dGFjYWNzIHNlcnZlciBhdXRoZW50aWNhdGlvbiBob3N0IGhvc3QtbmFtZSAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX3Zwbl9uYW1lIGFuZCBod3RhY2Fjc192cG5fbmFtZSAhPSAiX3B1YmxpY18iOgogICAgICAgICAgICAgICAgY21kICs9ICIgdnBuLWluc3RhbmNlICVzIiAlIGh3dGFjYWNzX3Zwbl9uYW1lCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3B1YmxpY19uZXQ6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBwdWJsaWMtbmV0IgogICAgICAgICAgICBpZiBod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyOgogICAgICAgICAgICAgICAgY21kICs9ICIgc2Vjb25kYXJ5IgoKICAgICAgICBlbGlmIGh3dGFjYWNzX3NlcnZlcl90eXBlID09ICJBdXRob3JpemF0aW9uIjoKICAgICAgICAgICAgY21kID0gImh3dGFjYWNzIHNlcnZlciBhdXRob3JpemF0aW9uIGhvc3QgaG9zdC1uYW1lICVzIiAlIGh3dGFjYWNzX3NlcnZlcl9ob3N0X25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfdnBuX25hbWUgYW5kIGh3dGFjYWNzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgaHd0YWNhY3NfdnBuX25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfcHVibGljX25ldDoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHB1YmxpYy1uZXQiCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGVsaWYgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPT0gIkFjY291bnRpbmciOgogICAgICAgICAgICBjbWQgPSAiaHd0YWNhY3Mgc2VydmVyIGFjY291bnRpbmcgaG9zdCBob3N0LW5hbWUgJXMiICUgaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZQogICAgICAgICAgICBpZiBod3RhY2Fjc192cG5fbmFtZSBhbmQgaHd0YWNhY3NfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSBod3RhY2Fjc192cG5fbmFtZQogICAgICAgICAgICBpZiBod3RhY2Fjc19pc19wdWJsaWNfbmV0OgogICAgICAgICAgICAgICAgY21kICs9ICIgcHVibGljLW5ldCIKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlcjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHNlY29uZGFyeSIKCiAgICAgICAgZWxpZiBod3RhY2Fjc19zZXJ2ZXJfdHlwZSA9PSAiQ29tbW9uIjoKICAgICAgICAgICAgY21kID0gImh3dGFjYWNzIHNlcnZlciBob3N0IGhvc3QtbmFtZSAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX3Zwbl9uYW1lIGFuZCBod3RhY2Fjc192cG5fbmFtZSAhPSAiX3B1YmxpY18iOgogICAgICAgICAgICAgICAgY21kICs9ICIgdnBuLWluc3RhbmNlICVzIiAlIGh3dGFjYWNzX3Zwbl9uYW1lCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3B1YmxpY19uZXQ6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBwdWJsaWMtbmV0IgogICAgICAgICAgICBpZiBod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyOgogICAgICAgICAgICAgICAgY21kICs9ICIgc2Vjb25kYXJ5IgoKICAgICAgICBjbWRzLmFwcGVuZChjbWQpCiAgICAgICAgcmV0dXJuIGNtZHMKCiAgICBkZWYgZGVsZXRlX2h3dGFjYWNzX2hvc3Rfc2VydmVyX2NmZyhzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgIiIiIERlbGV0ZSBod3RhY2FjcyBob3N0IHNlcnZlciBjb25maWd1cmUgIiIiCgogICAgICAgIG1vZHVsZSA9IGt3YXJnc1sibW9kdWxlIl0KICAgICAgICBod3RhY2Fjc190ZW1wbGF0ZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3RlbXBsYXRlIl0KICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZSJdCiAgICAgICAgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPSBtb2R1bGUucGFyYW1zWyJod3RhY2Fjc19zZXJ2ZXJfdHlwZSJdCiAgICAgICAgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlciA9IG1vZHVsZS5wYXJhbXNbCiAgICAgICAgICAgICJod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyIl0KICAgICAgICBod3RhY2Fjc192cG5fbmFtZSA9IG1vZHVsZS5wYXJhbXNbImh3dGFjYWNzX3Zwbl9uYW1lIl0KICAgICAgICBod3RhY2Fjc19pc19wdWJsaWNfbmV0ID0gbW9kdWxlLnBhcmFtc1siaHd0YWNhY3NfaXNfcHVibGljX25ldCJdCgogICAgICAgIGNvbmZfc3RyID0gQ0VfREVMRVRFX0hXVEFDQUNTX0hPU1RfU0VSVkVSX0NGRyAlICgKICAgICAgICAgICAgaHd0YWNhY3NfdGVtcGxhdGUsIGh3dGFjYWNzX3NlcnZlcl9ob3N0X25hbWUsCiAgICAgICAgICAgIGh3dGFjYWNzX3NlcnZlcl90eXBlLCBzdHIoaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlcikubG93ZXIoKSwKICAgICAgICAgICAgaHd0YWNhY3NfdnBuX25hbWUsIHN0cihod3RhY2Fjc19pc19wdWJsaWNfbmV0KS5sb3dlcigpKQoKICAgICAgICByZWN2X3htbCA9IHNlbGYubmV0Y29uZl9zZXRfY29uZmlnKG1vZHVsZT1tb2R1bGUsIGNvbmZfc3RyPWNvbmZfc3RyKQoKICAgICAgICBpZiAiPG9rLz4iIG5vdCBpbiByZWN2X3htbDoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IERlbGV0ZSBod3RhY2FjcyBob3N0IHNlcnZlciBjb25maWcgZmFpbGVkLicpCgogICAgICAgIGNtZHMgPSBbXQoKICAgICAgICBpZiBod3RhY2Fjc19zZXJ2ZXJfdHlwZSA9PSAiQXV0aGVudGljYXRpb24iOgogICAgICAgICAgICBjbWQgPSAidW5kbyBod3RhY2FjcyBzZXJ2ZXIgYXV0aGVudGljYXRpb24gaG9zdCBob3N0LW5hbWUgJXMiICUgaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZQogICAgICAgICAgICBpZiBod3RhY2Fjc192cG5fbmFtZSBhbmQgaHd0YWNhY3NfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSBod3RhY2Fjc192cG5fbmFtZQogICAgICAgICAgICBpZiBod3RhY2Fjc19pc19wdWJsaWNfbmV0OgogICAgICAgICAgICAgICAgY21kICs9ICIgcHVibGljLW5ldCIKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlcjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHNlY29uZGFyeSIKCiAgICAgICAgZWxpZiBod3RhY2Fjc19zZXJ2ZXJfdHlwZSA9PSAiQXV0aG9yaXphdGlvbiI6CiAgICAgICAgICAgIGNtZCA9ICJ1bmRvIGh3dGFjYWNzIHNlcnZlciBhdXRob3JpemF0aW9uIGhvc3QgaG9zdC1uYW1lICVzIiAlIGh3dGFjYWNzX3NlcnZlcl9ob3N0X25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfdnBuX25hbWUgYW5kIGh3dGFjYWNzX3Zwbl9uYW1lICE9ICJfcHVibGljXyI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiB2cG4taW5zdGFuY2UgJXMiICUgaHd0YWNhY3NfdnBuX25hbWUKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfcHVibGljX25ldDoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHB1YmxpYy1uZXQiCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBzZWNvbmRhcnkiCgogICAgICAgIGVsaWYgaHd0YWNhY3Nfc2VydmVyX3R5cGUgPT0gIkFjY291bnRpbmciOgogICAgICAgICAgICBjbWQgPSAidW5kbyBod3RhY2FjcyBzZXJ2ZXIgYWNjb3VudGluZyBob3N0IGhvc3QtbmFtZSAlcyIgJSBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX3Zwbl9uYW1lIGFuZCBod3RhY2Fjc192cG5fbmFtZSAhPSAiX3B1YmxpY18iOgogICAgICAgICAgICAgICAgY21kICs9ICIgdnBuLWluc3RhbmNlICVzIiAlIGh3dGFjYWNzX3Zwbl9uYW1lCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX2lzX3B1YmxpY19uZXQ6CiAgICAgICAgICAgICAgICBjbWQgKz0gIiBwdWJsaWMtbmV0IgogICAgICAgICAgICBpZiBod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyOgogICAgICAgICAgICAgICAgY21kICs9ICIgc2Vjb25kYXJ5IgoKICAgICAgICBlbGlmIGh3dGFjYWNzX3NlcnZlcl90eXBlID09ICJDb21tb24iOgogICAgICAgICAgICBjbWQgPSAidW5kbyBod3RhY2FjcyBzZXJ2ZXIgaG9zdCBob3N0LW5hbWUgJXMiICUgaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZQogICAgICAgICAgICBpZiBod3RhY2Fjc192cG5fbmFtZSBhbmQgaHd0YWNhY3NfdnBuX25hbWUgIT0gIl9wdWJsaWNfIjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHZwbi1pbnN0YW5jZSAlcyIgJSBod3RhY2Fjc192cG5fbmFtZQogICAgICAgICAgICBpZiBod3RhY2Fjc19pc19wdWJsaWNfbmV0OgogICAgICAgICAgICAgICAgY21kICs9ICIgcHVibGljLW5ldCIKICAgICAgICAgICAgaWYgaHd0YWNhY3NfaXNfc2Vjb25kYXJ5X3NlcnZlcjoKICAgICAgICAgICAgICAgIGNtZCArPSAiIHNlY29uZGFyeSIKCiAgICAgICAgY21kcy5hcHBlbmQoY21kKQogICAgICAgIHJldHVybiBjbWRzCgoKZGVmIGNoZWNrX2lwX2FkZHIoaXBhZGRyKToKICAgICIiIiBjaGVja19pcF9hZGRyLCBTdXBwb3J0cyBJUHY0IGFuZCBJUHY2ICIiIgoKICAgIGlmIG5vdCBpcGFkZHIgb3IgJ1x4MDAnIGluIGlwYWRkcjoKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICB0cnk6CiAgICAgICAgcmVzID0gc29ja2V0LmdldGFkZHJpbmZvKGlwYWRkciwgMCwgc29ja2V0LkFGX1VOU1BFQywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0LlNPQ0tfU1RSRUFNLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwLCBzb2NrZXQuQUlfTlVNRVJJQ0hPU1QpCiAgICAgICAgcmV0dXJuIGJvb2wocmVzKQogICAgZXhjZXB0IHNvY2tldC5nYWllcnJvcjoKICAgICAgICBlcnIgPSBzeXMuZXhjX2luZm8oKVsxXQogICAgICAgIGlmIGVyci5hcmdzWzBdID09IHNvY2tldC5FQUlfTk9OQU1FOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICByYWlzZQogICAgcmV0dXJuIFRydWUKCgpkZWYgY2hlY2tfbmFtZSgqKmt3YXJncyk6CiAgICAiIiIgQ2hlY2sgaW52YWxpZCBuYW1lICIiIgoKICAgIG1vZHVsZSA9IGt3YXJnc1sibW9kdWxlIl0KICAgIG5hbWUgPSBrd2FyZ3NbIm5hbWUiXQogICAgaW52YWxpZF9jaGFyID0ga3dhcmdzWyJpbnZhbGlkX2NoYXIiXQoKICAgIGZvciBpdGVtIGluIGludmFsaWRfY2hhcjoKICAgICAgICBpZiBpdGVtIGluIG5hbWU6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgICAgICBtc2c9J0Vycm9yOiBJbnZhbGlkIGNoYXIgJXMgaXMgaW4gdGhlIG5hbWUgJXMgJyAlIChpdGVtLCBuYW1lKSkKCgpkZWYgY2hlY2tfbW9kdWxlX2FyZ3VtZW50KCoqa3dhcmdzKToKICAgICIiIiBDaGVjayBtb2R1bGUgYXJndW1lbnQgIiIiCgogICAgbW9kdWxlID0ga3dhcmdzWyJtb2R1bGUiXQoKICAgICMgbG9jYWwgcGFyYQogICAgbG9jYWxfdXNlcl9uYW1lID0gbW9kdWxlLnBhcmFtc1snbG9jYWxfdXNlcl9uYW1lJ10KICAgIGxvY2FsX3Bhc3N3b3JkID0gbW9kdWxlLnBhcmFtc1snbG9jYWxfcGFzc3dvcmQnXQogICAgbG9jYWxfZnRwX2RpciA9IG1vZHVsZS5wYXJhbXNbJ2xvY2FsX2Z0cF9kaXInXQogICAgbG9jYWxfdXNlcl9sZXZlbCA9IG1vZHVsZS5wYXJhbXNbJ2xvY2FsX3VzZXJfbGV2ZWwnXQogICAgbG9jYWxfdXNlcl9ncm91cCA9IG1vZHVsZS5wYXJhbXNbJ2xvY2FsX3VzZXJfZ3JvdXAnXQoKICAgICMgcmFkaXVzIHBhcmEKICAgIHJhZGl1c19ncm91cF9uYW1lID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX2dyb3VwX25hbWUnXQogICAgcmFkaXVzX3NlcnZlcl9pcCA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19zZXJ2ZXJfaXAnXQogICAgcmFkaXVzX3NlcnZlcl9wb3J0ID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9wb3J0J10KICAgIHJhZGl1c192cG5fbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c192cG5fbmFtZSddCiAgICByYWRpdXNfc2VydmVyX25hbWUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX25hbWUnXQoKICAgICMgaHd0YWNhY3MgcGFyYQogICAgaHd0YWNhY3NfdGVtcGxhdGUgPSBtb2R1bGUucGFyYW1zWydod3RhY2Fjc190ZW1wbGF0ZSddCiAgICBod3RhY2Fjc19zZXJ2ZXJfaXAgPSBtb2R1bGUucGFyYW1zWydod3RhY2Fjc19zZXJ2ZXJfaXAnXQogICAgaHd0YWNhY3NfdnBuX25hbWUgPSBtb2R1bGUucGFyYW1zWydod3RhY2Fjc192cG5fbmFtZSddCiAgICBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lID0gbW9kdWxlLnBhcmFtc1snaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZSddCgogICAgaWYgbG9jYWxfdXNlcl9uYW1lOgogICAgICAgIGlmIGxlbihsb2NhbF91c2VyX25hbWUpID4gMjUzOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogVGhlIGxvY2FsX3VzZXJfbmFtZSAlcyBpcyBsYXJnZSB0aGFuIDI1My4nICUgbG9jYWxfdXNlcl9uYW1lKQogICAgICAgIGNoZWNrX25hbWUobW9kdWxlPW1vZHVsZSwgbmFtZT1sb2NhbF91c2VyX25hbWUsCiAgICAgICAgICAgICAgICAgICBpbnZhbGlkX2NoYXI9SU5WQUxJRF9VU0VSX05BTUVfQ0hBUikKCiAgICBpZiBsb2NhbF9wYXNzd29yZCBhbmQgbGVuKGxvY2FsX3Bhc3N3b3JkKSA+IDI1NToKICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICBtc2c9J0Vycm9yOiBUaGUgbG9jYWxfcGFzc3dvcmQgJXMgaXMgbGFyZ2UgdGhhbiAyNTUuJyAlIGxvY2FsX3Bhc3N3b3JkKQoKICAgIGlmIGxvY2FsX3VzZXJfbGV2ZWw6CiAgICAgICAgaWYgaW50KGxvY2FsX3VzZXJfbGV2ZWwpID4gMTUgb3IgaW50KGxvY2FsX3VzZXJfbGV2ZWwpIDwgMDoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IFRoZSBsb2NhbF91c2VyX2xldmVsICVzIGlzIG91dCBvZiBbMCAtIDE1XS4nICUgbG9jYWxfdXNlcl9sZXZlbCkKCiAgICBpZiBsb2NhbF9mdHBfZGlyOgogICAgICAgIGlmIGxlbihsb2NhbF9mdHBfZGlyKSA+IDI1NToKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IFRoZSBsb2NhbF9mdHBfZGlyICVzIGlzIGxhcmdlIHRoYW4gMjU1LicgJSBsb2NhbF9mdHBfZGlyKQoKICAgIGlmIGxvY2FsX3VzZXJfZ3JvdXA6CiAgICAgICAgaWYgbGVuKGxvY2FsX3VzZXJfZ3JvdXApID4gMzIgb3IgbGVuKGxvY2FsX3VzZXJfZ3JvdXApIDwgMToKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IFRoZSBsb2NhbF91c2VyX2dyb3VwICVzIGlzIG91dCBvZiBbMSAtIDMyXS4nICUgbG9jYWxfdXNlcl9ncm91cCkKCiAgICBpZiByYWRpdXNfZ3JvdXBfbmFtZSBhbmQgbGVuKHJhZGl1c19ncm91cF9uYW1lKSA+IDMyOgogICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgIG1zZz0nRXJyb3I6IFRoZSByYWRpdXNfZ3JvdXBfbmFtZSAlcyBpcyBsYXJnZSB0aGFuIDMyLicgJSByYWRpdXNfZ3JvdXBfbmFtZSkKCiAgICBpZiByYWRpdXNfc2VydmVyX2lwIGFuZCBub3QgY2hlY2tfaXBfYWRkcihyYWRpdXNfc2VydmVyX2lwKToKICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICBtc2c9J0Vycm9yOiBUaGUgcmFkaXVzX3NlcnZlcl9pcCAlcyBpcyBpbnZhbGlkLicgJSByYWRpdXNfc2VydmVyX2lwKQoKICAgIGlmIHJhZGl1c19zZXJ2ZXJfcG9ydCBhbmQgbm90IHJhZGl1c19zZXJ2ZXJfcG9ydC5pc2RpZ2l0KCk6CiAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgbXNnPSdFcnJvcjogVGhlIHJhZGl1c19zZXJ2ZXJfcG9ydCAlcyBpcyBpbnZhbGlkLicgJSByYWRpdXNfc2VydmVyX3BvcnQpCgogICAgaWYgcmFkaXVzX3Zwbl9uYW1lOgogICAgICAgIGlmIGxlbihyYWRpdXNfdnBuX25hbWUpID4gMzE6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgICAgICBtc2c9J0Vycm9yOiBUaGUgcmFkaXVzX3Zwbl9uYW1lICVzIGlzIGxhcmdlIHRoYW4gMzEuJyAlIHJhZGl1c192cG5fbmFtZSkKICAgICAgICBpZiAnICcgaW4gcmFkaXVzX3Zwbl9uYW1lOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogVGhlIHJhZGl1c192cG5fbmFtZSAlcyBpbmNsdWRlIHNwYWNlLicgJSByYWRpdXNfdnBuX25hbWUpCgogICAgaWYgcmFkaXVzX3NlcnZlcl9uYW1lOgogICAgICAgIGlmIGxlbihyYWRpdXNfc2VydmVyX25hbWUpID4gMjU1OgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogVGhlIHJhZGl1c19zZXJ2ZXJfbmFtZSAlcyBpcyBsYXJnZSB0aGFuIDI1NS4nICUgcmFkaXVzX3NlcnZlcl9uYW1lKQogICAgICAgIGlmICcgJyBpbiByYWRpdXNfc2VydmVyX25hbWU6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgICAgICBtc2c9J0Vycm9yOiBUaGUgcmFkaXVzX3NlcnZlcl9uYW1lICVzIGluY2x1ZGUgc3BhY2UuJyAlIHJhZGl1c19zZXJ2ZXJfbmFtZSkKCiAgICBpZiBod3RhY2Fjc190ZW1wbGF0ZSBhbmQgbGVuKGh3dGFjYWNzX3RlbXBsYXRlKSA+IDMyOgogICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgIG1zZz0nRXJyb3I6IFRoZSBod3RhY2Fjc190ZW1wbGF0ZSAlcyBpcyBsYXJnZSB0aGFuIDMyLicgJSBod3RhY2Fjc190ZW1wbGF0ZSkKCiAgICBpZiBod3RhY2Fjc19zZXJ2ZXJfaXAgYW5kIG5vdCBjaGVja19pcF9hZGRyKGh3dGFjYWNzX3NlcnZlcl9pcCk6CiAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgbXNnPSdFcnJvcjogVGhlIGh3dGFjYWNzX3NlcnZlcl9pcCAlcyBpcyBpbnZhbGlkLicgJSBod3RhY2Fjc19zZXJ2ZXJfaXApCgogICAgaWYgaHd0YWNhY3NfdnBuX25hbWU6CiAgICAgICAgaWYgbGVuKGh3dGFjYWNzX3Zwbl9uYW1lKSA+IDMxOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogVGhlIGh3dGFjYWNzX3Zwbl9uYW1lICVzIGlzIGxhcmdlIHRoYW4gMzEuJyAlIGh3dGFjYWNzX3Zwbl9uYW1lKQogICAgICAgIGlmICcgJyBpbiBod3RhY2Fjc192cG5fbmFtZToKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IFRoZSBod3RhY2Fjc192cG5fbmFtZSAlcyBpbmNsdWRlIHNwYWNlLicgJSBod3RhY2Fjc192cG5fbmFtZSkKCiAgICBpZiBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lOgogICAgICAgIGlmIGxlbihod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lKSA+IDI1NToKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IFRoZSBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lICVzIGlzIGxhcmdlIHRoYW4gMjU1LicgJSBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lKQogICAgICAgIGlmICcgJyBpbiBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogVGhlIGh3dGFjYWNzX3NlcnZlcl9ob3N0X25hbWUgJXMgaW5jbHVkZSBzcGFjZS4nICUgaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZSkKCgpkZWYgbWFpbigpOgogICAgIiIiIE1vZHVsZSBtYWluICIiIgoKICAgIGFyZ3VtZW50X3NwZWMgPSBkaWN0KAogICAgICAgIHN0YXRlPWRpY3QoY2hvaWNlcz1bJ3ByZXNlbnQnLCAnYWJzZW50J10sIGRlZmF1bHQ9J3ByZXNlbnQnKSwKICAgICAgICBsb2NhbF91c2VyX25hbWU9ZGljdCh0eXBlPSdzdHInKSwKICAgICAgICBsb2NhbF9wYXNzd29yZD1kaWN0KHR5cGU9J3N0cicsIG5vX2xvZz1UcnVlKSwKICAgICAgICBsb2NhbF9zZXJ2aWNlX3R5cGU9ZGljdCh0eXBlPSdzdHInKSwKICAgICAgICBsb2NhbF9mdHBfZGlyPWRpY3QodHlwZT0nc3RyJyksCiAgICAgICAgbG9jYWxfdXNlcl9sZXZlbD1kaWN0KHR5cGU9J3N0cicpLAogICAgICAgIGxvY2FsX3VzZXJfZ3JvdXA9ZGljdCh0eXBlPSdzdHInKSwKICAgICAgICByYWRpdXNfZ3JvdXBfbmFtZT1kaWN0KHR5cGU9J3N0cicpLAogICAgICAgIHJhZHVpc19zZXJ2ZXJfdHlwZT1kaWN0KGNob2ljZXM9WydBdXRoZW50aWNhdGlvbicsICdBY2NvdW50aW5nJ10pLAogICAgICAgIHJhZGl1c19zZXJ2ZXJfaXA9ZGljdCh0eXBlPSdzdHInKSwKICAgICAgICByYWRpdXNfc2VydmVyX2lwdjY9ZGljdCh0eXBlPSdzdHInKSwKICAgICAgICByYWRpdXNfc2VydmVyX3BvcnQ9ZGljdCh0eXBlPSdzdHInKSwKICAgICAgICByYWRpdXNfc2VydmVyX21vZGU9ZGljdCgKICAgICAgICAgICAgY2hvaWNlcz1bJ1NlY29uZGFyeS1zZXJ2ZXInLCAnUHJpbWFyeS1zZXJ2ZXInXSksCiAgICAgICAgcmFkaXVzX3Zwbl9uYW1lPWRpY3QodHlwZT0nc3RyJyksCiAgICAgICAgcmFkaXVzX3NlcnZlcl9uYW1lPWRpY3QodHlwZT0nc3RyJyksCiAgICAgICAgaHd0YWNhY3NfdGVtcGxhdGU9ZGljdCh0eXBlPSdzdHInKSwKICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfaXA9ZGljdCh0eXBlPSdzdHInKSwKICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfaXB2Nj1kaWN0KHR5cGU9J3N0cicpLAogICAgICAgIGh3dGFjYWNzX3NlcnZlcl90eXBlPWRpY3QoCiAgICAgICAgICAgIGNob2ljZXM9WydBdXRoZW50aWNhdGlvbicsICdBdXRob3JpemF0aW9uJywgJ0FjY291bnRpbmcnLCAnQ29tbW9uJ10pLAogICAgICAgIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXI9ZGljdCgKICAgICAgICAgICAgcmVxdWlyZWQ9RmFsc2UsIGRlZmF1bHQ9RmFsc2UsIHR5cGU9J2Jvb2wnKSwKICAgICAgICBod3RhY2Fjc192cG5fbmFtZT1kaWN0KHR5cGU9J3N0cicpLAogICAgICAgIGh3dGFjYWNzX2lzX3B1YmxpY19uZXQ9ZGljdCgKICAgICAgICAgICAgcmVxdWlyZWQ9RmFsc2UsIGRlZmF1bHQ9RmFsc2UsIHR5cGU9J2Jvb2wnKSwKICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lPWRpY3QodHlwZT0nc3RyJykKICAgICkKCiAgICBhcmd1bWVudF9zcGVjLnVwZGF0ZShjZV9hcmd1bWVudF9zcGVjKQoKICAgIG1vZHVsZSA9IEFuc2libGVNb2R1bGUoYXJndW1lbnRfc3BlYz1hcmd1bWVudF9zcGVjLAogICAgICAgICAgICAgICAgICAgICAgICAgICBzdXBwb3J0c19jaGVja19tb2RlPVRydWUpCgogICAgY2hlY2tfbW9kdWxlX2FyZ3VtZW50KG1vZHVsZT1tb2R1bGUpCgogICAgY2hhbmdlZCA9IEZhbHNlCiAgICBwcm9wb3NlZCA9IGRpY3QoKQogICAgZXhpc3RpbmcgPSBkaWN0KCkKICAgIGVuZF9zdGF0ZSA9IGRpY3QoKQogICAgdXBkYXRlcyA9IFtdCgogICAgIyBjb21tb24gcGFyYQogICAgc3RhdGUgPSBtb2R1bGUucGFyYW1zWydzdGF0ZSddCgogICAgIyBsb2NhbCBwYXJhCiAgICBsb2NhbF91c2VyX25hbWUgPSBtb2R1bGUucGFyYW1zWydsb2NhbF91c2VyX25hbWUnXQogICAgbG9jYWxfcGFzc3dvcmQgPSBtb2R1bGUucGFyYW1zWydsb2NhbF9wYXNzd29yZCddCiAgICBsb2NhbF9zZXJ2aWNlX3R5cGUgPSBtb2R1bGUucGFyYW1zWydsb2NhbF9zZXJ2aWNlX3R5cGUnXQogICAgbG9jYWxfZnRwX2RpciA9IG1vZHVsZS5wYXJhbXNbJ2xvY2FsX2Z0cF9kaXInXQogICAgbG9jYWxfdXNlcl9sZXZlbCA9IG1vZHVsZS5wYXJhbXNbJ2xvY2FsX3VzZXJfbGV2ZWwnXQogICAgbG9jYWxfdXNlcl9ncm91cCA9IG1vZHVsZS5wYXJhbXNbJ2xvY2FsX3VzZXJfZ3JvdXAnXQoKICAgICMgcmFkaXVzIHBhcmEKICAgIHJhZGl1c19ncm91cF9uYW1lID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX2dyb3VwX25hbWUnXQogICAgcmFkdWlzX3NlcnZlcl90eXBlID0gbW9kdWxlLnBhcmFtc1sncmFkdWlzX3NlcnZlcl90eXBlJ10KICAgIHJhZGl1c19zZXJ2ZXJfaXAgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX2lwJ10KICAgIHJhZGl1c19zZXJ2ZXJfaXB2NiA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c19zZXJ2ZXJfaXB2NiddCiAgICByYWRpdXNfc2VydmVyX3BvcnQgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX3BvcnQnXQogICAgcmFkaXVzX3NlcnZlcl9tb2RlID0gbW9kdWxlLnBhcmFtc1sncmFkaXVzX3NlcnZlcl9tb2RlJ10KICAgIHJhZGl1c192cG5fbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ3JhZGl1c192cG5fbmFtZSddCiAgICByYWRpdXNfc2VydmVyX25hbWUgPSBtb2R1bGUucGFyYW1zWydyYWRpdXNfc2VydmVyX25hbWUnXQoKICAgICMgaHd0YWNhY3MgcGFyYQogICAgaHd0YWNhY3NfdGVtcGxhdGUgPSBtb2R1bGUucGFyYW1zWydod3RhY2Fjc190ZW1wbGF0ZSddCiAgICBod3RhY2Fjc19zZXJ2ZXJfaXAgPSBtb2R1bGUucGFyYW1zWydod3RhY2Fjc19zZXJ2ZXJfaXAnXQogICAgaHd0YWNhY3Nfc2VydmVyX2lwdjYgPSBtb2R1bGUucGFyYW1zWydod3RhY2Fjc19zZXJ2ZXJfaXB2NiddCiAgICBod3RhY2Fjc19zZXJ2ZXJfdHlwZSA9IG1vZHVsZS5wYXJhbXNbJ2h3dGFjYWNzX3NlcnZlcl90eXBlJ10KICAgIGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIgPSBtb2R1bGUucGFyYW1zWwogICAgICAgICdod3RhY2Fjc19pc19zZWNvbmRhcnlfc2VydmVyJ10KICAgIGh3dGFjYWNzX3Zwbl9uYW1lID0gbW9kdWxlLnBhcmFtc1snaHd0YWNhY3NfdnBuX25hbWUnXQogICAgaHd0YWNhY3NfaXNfcHVibGljX25ldCA9IG1vZHVsZS5wYXJhbXNbJ2h3dGFjYWNzX2lzX3B1YmxpY19uZXQnXQogICAgaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZSA9IG1vZHVsZS5wYXJhbXNbJ2h3dGFjYWNzX3NlcnZlcl9ob3N0X25hbWUnXQoKICAgIGNlX2FhYV9zZXJ2ZXJfaG9zdCA9IEFhYVNlcnZlckhvc3QoKQoKICAgIGlmIG5vdCBjZV9hYWFfc2VydmVyX2hvc3Q6CiAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9J0Vycm9yOiBDb25zdHJ1Y3QgY2VfYWFhX3NlcnZlciBmYWlsZWQuJykKCiAgICAjIGdldCBwcm9wb3NlZAogICAgcHJvcG9zZWRbInN0YXRlIl0gPSBzdGF0ZQogICAgaWYgbG9jYWxfdXNlcl9uYW1lOgogICAgICAgIHByb3Bvc2VkWyJsb2NhbF91c2VyX25hbWUiXSA9IGxvY2FsX3VzZXJfbmFtZQogICAgaWYgbG9jYWxfcGFzc3dvcmQ6CiAgICAgICAgcHJvcG9zZWRbImxvY2FsX3Bhc3N3b3JkIl0gPSAiKioqKioqIgogICAgaWYgbG9jYWxfc2VydmljZV90eXBlOgogICAgICAgIHByb3Bvc2VkWyJsb2NhbF9zZXJ2aWNlX3R5cGUiXSA9IGxvY2FsX3NlcnZpY2VfdHlwZQogICAgaWYgbG9jYWxfZnRwX2RpcjoKICAgICAgICBwcm9wb3NlZFsibG9jYWxfZnRwX2RpciJdID0gbG9jYWxfZnRwX2RpcgogICAgaWYgbG9jYWxfdXNlcl9sZXZlbDoKICAgICAgICBwcm9wb3NlZFsibG9jYWxfdXNlcl9sZXZlbCJdID0gbG9jYWxfdXNlcl9sZXZlbAogICAgaWYgbG9jYWxfdXNlcl9ncm91cDoKICAgICAgICBwcm9wb3NlZFsibG9jYWxfdXNlcl9ncm91cCJdID0gbG9jYWxfdXNlcl9ncm91cAogICAgaWYgcmFkaXVzX2dyb3VwX25hbWU6CiAgICAgICAgcHJvcG9zZWRbInJhZGl1c19ncm91cF9uYW1lIl0gPSByYWRpdXNfZ3JvdXBfbmFtZQogICAgaWYgcmFkdWlzX3NlcnZlcl90eXBlOgogICAgICAgIHByb3Bvc2VkWyJyYWR1aXNfc2VydmVyX3R5cGUiXSA9IHJhZHVpc19zZXJ2ZXJfdHlwZQogICAgaWYgcmFkaXVzX3NlcnZlcl9pcDoKICAgICAgICBwcm9wb3NlZFsicmFkaXVzX3NlcnZlcl9pcCJdID0gcmFkaXVzX3NlcnZlcl9pcAogICAgaWYgcmFkaXVzX3NlcnZlcl9pcHY2OgogICAgICAgIHByb3Bvc2VkWyJyYWRpdXNfc2VydmVyX2lwdjYiXSA9IHJhZGl1c19zZXJ2ZXJfaXB2NgogICAgaWYgcmFkaXVzX3NlcnZlcl9wb3J0OgogICAgICAgIHByb3Bvc2VkWyJyYWRpdXNfc2VydmVyX3BvcnQiXSA9IHJhZGl1c19zZXJ2ZXJfcG9ydAogICAgaWYgcmFkaXVzX3NlcnZlcl9tb2RlOgogICAgICAgIHByb3Bvc2VkWyJyYWRpdXNfc2VydmVyX21vZGUiXSA9IHJhZGl1c19zZXJ2ZXJfbW9kZQogICAgaWYgcmFkaXVzX3Zwbl9uYW1lOgogICAgICAgIHByb3Bvc2VkWyJyYWRpdXNfdnBuX25hbWUiXSA9IHJhZGl1c192cG5fbmFtZQogICAgaWYgcmFkaXVzX3NlcnZlcl9uYW1lOgogICAgICAgIHByb3Bvc2VkWyJyYWRpdXNfc2VydmVyX25hbWUiXSA9IHJhZGl1c19zZXJ2ZXJfbmFtZQogICAgaWYgaHd0YWNhY3NfdGVtcGxhdGU6CiAgICAgICAgcHJvcG9zZWRbImh3dGFjYWNzX3RlbXBsYXRlIl0gPSBod3RhY2Fjc190ZW1wbGF0ZQogICAgaWYgaHd0YWNhY3Nfc2VydmVyX2lwOgogICAgICAgIHByb3Bvc2VkWyJod3RhY2Fjc19zZXJ2ZXJfaXAiXSA9IGh3dGFjYWNzX3NlcnZlcl9pcAogICAgaWYgaHd0YWNhY3Nfc2VydmVyX2lwdjY6CiAgICAgICAgcHJvcG9zZWRbImh3dGFjYWNzX3NlcnZlcl9pcHY2Il0gPSBod3RhY2Fjc19zZXJ2ZXJfaXB2NgogICAgaWYgaHd0YWNhY3Nfc2VydmVyX3R5cGU6CiAgICAgICAgcHJvcG9zZWRbImh3dGFjYWNzX3NlcnZlcl90eXBlIl0gPSBod3RhY2Fjc19zZXJ2ZXJfdHlwZQogICAgcHJvcG9zZWRbImh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIiXSA9IGh3dGFjYWNzX2lzX3NlY29uZGFyeV9zZXJ2ZXIKICAgIGlmIGh3dGFjYWNzX3Zwbl9uYW1lOgogICAgICAgIHByb3Bvc2VkWyJod3RhY2Fjc192cG5fbmFtZSJdID0gaHd0YWNhY3NfdnBuX25hbWUKICAgIHByb3Bvc2VkWyJod3RhY2Fjc19pc19wdWJsaWNfbmV0Il0gPSBod3RhY2Fjc19pc19wdWJsaWNfbmV0CiAgICBpZiBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lOgogICAgICAgIHByb3Bvc2VkWyJod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lIl0gPSBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lCgogICAgaWYgbG9jYWxfdXNlcl9uYW1lOgoKICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCIgYW5kIG5vdCBsb2NhbF9wYXNzd29yZDoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IFBsZWFzZSBpbnB1dCBsb2NhbF9wYXNzd29yZCB3aGVuIGNvbmZpZyBsb2NhbCB1c2VyLicpCgogICAgICAgIGxvY2FsX3VzZXJfcmVzdWx0ID0gY2VfYWFhX3NlcnZlcl9ob3N0LmdldF9sb2NhbF91c2VyX2luZm8oCiAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgZXhpc3RpbmdbImxvY2FsIHVzZXIgbmFtZSJdID0gbG9jYWxfdXNlcl9yZXN1bHRbImxvY2FsX3VzZXJfaW5mbyJdCgogICAgICAgIGlmIHN0YXRlID09ICJwcmVzZW50IjoKICAgICAgICAgICAgIyBwcmVzZW50IGxvY2FsIHVzZXIKICAgICAgICAgICAgaWYgbG9jYWxfdXNlcl9yZXN1bHRbIm5lZWRfY2ZnIl06CiAgICAgICAgICAgICAgICBjbWQgPSBjZV9hYWFfc2VydmVyX2hvc3QubWVyZ2VfbG9jYWxfdXNlcl9pbmZvKG1vZHVsZT1tb2R1bGUpCgogICAgICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICAgICAgICAgIHVwZGF0ZXMuYXBwZW5kKGNtZCkKCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBhYnNlbnQgbG9jYWwgdXNlcgogICAgICAgICAgICBpZiBsb2NhbF91c2VyX3Jlc3VsdFsibmVlZF9jZmciXToKICAgICAgICAgICAgICAgIGlmIG5vdCBsb2NhbF9zZXJ2aWNlX3R5cGUgYW5kIG5vdCBsb2NhbF9mdHBfZGlyIGFuZCBub3QgbG9jYWxfdXNlcl9sZXZlbCBhbmQgbm90IGxvY2FsX3VzZXJfZ3JvdXA6CiAgICAgICAgICAgICAgICAgICAgY21kID0gY2VfYWFhX3NlcnZlcl9ob3N0LmRlbGV0ZV9sb2NhbF91c2VyX2luZm8oCiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGNtZCA9IGNlX2FhYV9zZXJ2ZXJfaG9zdC5tZXJnZV9sb2NhbF91c2VyX2luZm8oCiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCgogICAgICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICAgICAgICAgIHVwZGF0ZXMuYXBwZW5kKGNtZCkKCiAgICAgICAgbG9jYWxfdXNlcl9yZXN1bHQgPSBjZV9hYWFfc2VydmVyX2hvc3QuZ2V0X2xvY2FsX3VzZXJfaW5mbygKICAgICAgICAgICAgbW9kdWxlPW1vZHVsZSkKICAgICAgICBlbmRfc3RhdGVbImxvY2FsIHVzZXIgbmFtZSJdID0gbG9jYWxfdXNlcl9yZXN1bHRbImxvY2FsX3VzZXJfaW5mbyJdCgogICAgaWYgcmFkaXVzX2dyb3VwX25hbWU6CgogICAgICAgIGlmIG5vdCByYWRpdXNfc2VydmVyX2lwIGFuZCBub3QgcmFkaXVzX3NlcnZlcl9pcHY2IGFuZCBub3QgcmFkaXVzX3NlcnZlcl9uYW1lOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogUGxlYXNlIGlucHV0IHJhZGl1c19zZXJ2ZXJfaXAgb3IgcmFkaXVzX3NlcnZlcl9pcHY2IG9yIHJhZGl1c19zZXJ2ZXJfbmFtZS4nKQoKICAgICAgICBpZiByYWRpdXNfc2VydmVyX2lwIGFuZCByYWRpdXNfc2VydmVyX2lwdjY6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgICAgICBtc2c9J0Vycm9yOiBQbGVhc2UgZG8gbm90IGlucHV0IHJhZGl1c19zZXJ2ZXJfaXAgYW5kIHJhZGl1c19zZXJ2ZXJfaXB2NiBhdCB0aGUgc2FtZSB0aW1lLicpCgogICAgICAgIGlmIG5vdCByYWR1aXNfc2VydmVyX3R5cGUgb3Igbm90IHJhZGl1c19zZXJ2ZXJfcG9ydCBvciBub3QgcmFkaXVzX3NlcnZlcl9tb2RlIG9yIG5vdCByYWRpdXNfdnBuX25hbWU6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgICAgICBtc2c9J0Vycm9yOiBQbGVhc2UgaW5wdXQgcmFkdWlzX3NlcnZlcl90eXBlIHJhZGl1c19zZXJ2ZXJfcG9ydCByYWRpdXNfc2VydmVyX21vZGUgcmFkaXVzX3Zwbl9uYW1lLicpCgogICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfaXA6CiAgICAgICAgICAgIHJkc19zZXJ2ZXJfaXB2NF9yZXN1bHQgPSBjZV9hYWFfc2VydmVyX2hvc3QuZ2V0X3JhZGl1c19zZXJ2ZXJfY2ZnX2lwdjQoCiAgICAgICAgICAgICAgICBtb2R1bGU9bW9kdWxlKQogICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfaXB2NjoKICAgICAgICAgICAgcmRzX3NlcnZlcl9pcHY2X3Jlc3VsdCA9IGNlX2FhYV9zZXJ2ZXJfaG9zdC5nZXRfcmFkaXVzX3NlcnZlcl9jZmdfaXB2NigKICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgaWYgcmFkaXVzX3NlcnZlcl9uYW1lOgogICAgICAgICAgICByZHNfc2VydmVyX25hbWVfcmVzdWx0ID0gY2VfYWFhX3NlcnZlcl9ob3N0LmdldF9yYWRpdXNfc2VydmVyX25hbWUoCiAgICAgICAgICAgICAgICBtb2R1bGU9bW9kdWxlKQoKICAgICAgICBpZiByYWRpdXNfc2VydmVyX2lwIGFuZCByZHNfc2VydmVyX2lwdjRfcmVzdWx0WyJyYWRpdXNfc2VydmVyX2lwX3Y0Il06CiAgICAgICAgICAgIGV4aXN0aW5nWyJyYWRpdXMgc2VydmVyIGlwdjQiXSA9IHJkc19zZXJ2ZXJfaXB2NF9yZXN1bHRbCiAgICAgICAgICAgICAgICAicmFkaXVzX3NlcnZlcl9pcF92NCJdCiAgICAgICAgaWYgcmFkaXVzX3NlcnZlcl9pcHY2IGFuZCByZHNfc2VydmVyX2lwdjZfcmVzdWx0WyJyYWRpdXNfc2VydmVyX2lwX3Y2Il06CiAgICAgICAgICAgIGV4aXN0aW5nWyJyYWRpdXMgc2VydmVyIGlwdjYiXSA9IHJkc19zZXJ2ZXJfaXB2Nl9yZXN1bHRbCiAgICAgICAgICAgICAgICAicmFkaXVzX3NlcnZlcl9pcF92NiJdCiAgICAgICAgaWYgcmFkaXVzX3NlcnZlcl9uYW1lIGFuZCByZHNfc2VydmVyX25hbWVfcmVzdWx0WyJyYWRpdXNfc2VydmVyX25hbWVfY2ZnIl06CiAgICAgICAgICAgIGV4aXN0aW5nWyJyYWRpdXMgc2VydmVyIG5hbWUgY2ZnIl0gPSByZHNfc2VydmVyX25hbWVfcmVzdWx0WwogICAgICAgICAgICAgICAgInJhZGl1c19zZXJ2ZXJfbmFtZV9jZmciXQoKICAgICAgICBpZiBzdGF0ZSA9PSAicHJlc2VudCI6CiAgICAgICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfaXAgYW5kIHJkc19zZXJ2ZXJfaXB2NF9yZXN1bHRbIm5lZWRfY2ZnIl06CiAgICAgICAgICAgICAgICBjbWQgPSBjZV9hYWFfc2VydmVyX2hvc3QubWVyZ2VfcmFkaXVzX3NlcnZlcl9jZmdfaXB2NCgKICAgICAgICAgICAgICAgICAgICBtb2R1bGU9bW9kdWxlKQogICAgICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICAgICAgICAgIHVwZGF0ZXMuYXBwZW5kKGNtZCkKCiAgICAgICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfaXB2NiBhbmQgcmRzX3NlcnZlcl9pcHY2X3Jlc3VsdFsibmVlZF9jZmciXToKICAgICAgICAgICAgICAgIGNtZCA9IGNlX2FhYV9zZXJ2ZXJfaG9zdC5tZXJnZV9yYWRpdXNfc2VydmVyX2NmZ19pcHY2KAogICAgICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgdXBkYXRlcy5hcHBlbmQoY21kKQoKICAgICAgICAgICAgaWYgcmFkaXVzX3NlcnZlcl9uYW1lIGFuZCByZHNfc2VydmVyX25hbWVfcmVzdWx0WyJuZWVkX2NmZyJdOgogICAgICAgICAgICAgICAgY21kID0gY2VfYWFhX3NlcnZlcl9ob3N0Lm1lcmdlX3JhZGl1c19zZXJ2ZXJfbmFtZSgKICAgICAgICAgICAgICAgICAgICBtb2R1bGU9bW9kdWxlKQogICAgICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICAgICAgICAgIHVwZGF0ZXMuYXBwZW5kKGNtZCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiByYWRpdXNfc2VydmVyX2lwIGFuZCByZHNfc2VydmVyX2lwdjRfcmVzdWx0WyJuZWVkX2NmZyJdOgogICAgICAgICAgICAgICAgY21kID0gY2VfYWFhX3NlcnZlcl9ob3N0LmRlbGV0ZV9yYWRpdXNfc2VydmVyX2NmZ19pcHY0KAogICAgICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgdXBkYXRlcy5hcHBlbmQoY21kKQoKICAgICAgICAgICAgaWYgcmFkaXVzX3NlcnZlcl9pcHY2IGFuZCByZHNfc2VydmVyX2lwdjZfcmVzdWx0WyJuZWVkX2NmZyJdOgogICAgICAgICAgICAgICAgY21kID0gY2VfYWFhX3NlcnZlcl9ob3N0LmRlbGV0ZV9yYWRpdXNfc2VydmVyX2NmZ19pcHY2KAogICAgICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgdXBkYXRlcy5hcHBlbmQoY21kKQoKICAgICAgICAgICAgaWYgcmFkaXVzX3NlcnZlcl9uYW1lIGFuZCByZHNfc2VydmVyX25hbWVfcmVzdWx0WyJuZWVkX2NmZyJdOgogICAgICAgICAgICAgICAgY21kID0gY2VfYWFhX3NlcnZlcl9ob3N0LmRlbGV0ZV9yYWRpdXNfc2VydmVyX25hbWUoCiAgICAgICAgICAgICAgICAgICAgbW9kdWxlPW1vZHVsZSkKICAgICAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgICAgICAgICB1cGRhdGVzLmFwcGVuZChjbWQpCgogICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfaXA6CiAgICAgICAgICAgIHJkc19zZXJ2ZXJfaXB2NF9yZXN1bHQgPSBjZV9hYWFfc2VydmVyX2hvc3QuZ2V0X3JhZGl1c19zZXJ2ZXJfY2ZnX2lwdjQoCiAgICAgICAgICAgICAgICBtb2R1bGU9bW9kdWxlKQogICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfaXB2NjoKICAgICAgICAgICAgcmRzX3NlcnZlcl9pcHY2X3Jlc3VsdCA9IGNlX2FhYV9zZXJ2ZXJfaG9zdC5nZXRfcmFkaXVzX3NlcnZlcl9jZmdfaXB2NigKICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgaWYgcmFkaXVzX3NlcnZlcl9uYW1lOgogICAgICAgICAgICByZHNfc2VydmVyX25hbWVfcmVzdWx0ID0gY2VfYWFhX3NlcnZlcl9ob3N0LmdldF9yYWRpdXNfc2VydmVyX25hbWUoCiAgICAgICAgICAgICAgICBtb2R1bGU9bW9kdWxlKQoKICAgICAgICBpZiByYWRpdXNfc2VydmVyX2lwIGFuZCByZHNfc2VydmVyX2lwdjRfcmVzdWx0WyJyYWRpdXNfc2VydmVyX2lwX3Y0Il06CiAgICAgICAgICAgIGVuZF9zdGF0ZVsicmFkaXVzIHNlcnZlciBpcHY0Il0gPSByZHNfc2VydmVyX2lwdjRfcmVzdWx0WwogICAgICAgICAgICAgICAgInJhZGl1c19zZXJ2ZXJfaXBfdjQiXQogICAgICAgIGlmIHJhZGl1c19zZXJ2ZXJfaXB2NiBhbmQgcmRzX3NlcnZlcl9pcHY2X3Jlc3VsdFsicmFkaXVzX3NlcnZlcl9pcF92NiJdOgogICAgICAgICAgICBlbmRfc3RhdGVbInJhZGl1cyBzZXJ2ZXIgaXB2NiJdID0gcmRzX3NlcnZlcl9pcHY2X3Jlc3VsdFsKICAgICAgICAgICAgICAgICJyYWRpdXNfc2VydmVyX2lwX3Y2Il0KICAgICAgICBpZiByYWRpdXNfc2VydmVyX25hbWUgYW5kIHJkc19zZXJ2ZXJfbmFtZV9yZXN1bHRbInJhZGl1c19zZXJ2ZXJfbmFtZV9jZmciXToKICAgICAgICAgICAgZW5kX3N0YXRlWyJyYWRpdXMgc2VydmVyIG5hbWUgY2ZnIl0gPSByZHNfc2VydmVyX25hbWVfcmVzdWx0WwogICAgICAgICAgICAgICAgInJhZGl1c19zZXJ2ZXJfbmFtZV9jZmciXQoKICAgIGlmIGh3dGFjYWNzX3RlbXBsYXRlOgoKICAgICAgICBpZiBub3QgaHd0YWNhY3Nfc2VydmVyX2lwIGFuZCBub3QgaHd0YWNhY3Nfc2VydmVyX2lwdjYgYW5kIG5vdCBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKAogICAgICAgICAgICAgICAgbXNnPSdFcnJvcjogUGxlYXNlIGlucHV0IGh3dGFjYWNzX3NlcnZlcl9pcCBvciBod3RhY2Fjc19zZXJ2ZXJfaXB2NiBvciBod3RhY2Fjc19zZXJ2ZXJfaG9zdF9uYW1lLicpCgogICAgICAgIGlmIG5vdCBod3RhY2Fjc19zZXJ2ZXJfdHlwZSBvciBub3QgaHd0YWNhY3NfdnBuX25hbWU6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgICAgICBtc2c9J0Vycm9yOiBQbGVhc2UgaW5wdXQgaHd0YWNhY3Nfc2VydmVyX3R5cGUgaHd0YWNhY3NfdnBuX25hbWUuJykKCiAgICAgICAgaWYgaHd0YWNhY3Nfc2VydmVyX2lwIGFuZCBod3RhY2Fjc19zZXJ2ZXJfaXB2NjoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IFBsZWFzZSBkbyBub3Qgc2V0IGh3dGFjYWNzX3NlcnZlcl9pcCBhbmQgaHd0YWNhY3Nfc2VydmVyX2lwdjYgYXQgdGhlIHNhbWUgdGltZS4nKQoKICAgICAgICBpZiBod3RhY2Fjc192cG5fbmFtZSBhbmQgaHd0YWNhY3NfaXNfcHVibGljX25ldDoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nRXJyb3I6IFBsZWFzZSBkbyBub3Qgc2V0IHZwbiBhbmQgcHVibGljIG5ldCBhdCB0aGUgc2FtZSB0aW1lLicpCgogICAgICAgIGlmIGh3dGFjYWNzX3NlcnZlcl9pcDoKICAgICAgICAgICAgaHd0YWNhY3Nfc2VydmVyX2lwdjRfcmVzdWx0ID0gY2VfYWFhX3NlcnZlcl9ob3N0LmdldF9od3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjQoCiAgICAgICAgICAgICAgICBtb2R1bGU9bW9kdWxlKQogICAgICAgIGlmIGh3dGFjYWNzX3NlcnZlcl9pcHY2OgogICAgICAgICAgICBod3RhY2Fjc19zZXJ2ZXJfaXB2Nl9yZXN1bHQgPSBjZV9hYWFfc2VydmVyX2hvc3QuZ2V0X2h3dGFjYWNzX3NlcnZlcl9jZmdfaXB2NigKICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgaWYgaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZToKICAgICAgICAgICAgaHd0YWNhY3NfaG9zdF9uYW1lX3Jlc3VsdCA9IGNlX2FhYV9zZXJ2ZXJfaG9zdC5nZXRfaHd0YWNhY3NfaG9zdF9zZXJ2ZXJfY2ZnKAogICAgICAgICAgICAgICAgbW9kdWxlPW1vZHVsZSkKCiAgICAgICAgaWYgaHd0YWNhY3Nfc2VydmVyX2lwIGFuZCBod3RhY2Fjc19zZXJ2ZXJfaXB2NF9yZXN1bHRbImh3dGFjYWNzX3NlcnZlcl9jZmdfaXB2NCJdOgogICAgICAgICAgICBleGlzdGluZ1siaHd0YWNhY3Mgc2VydmVyIGNmZyBpcHY0Il0gPSBod3RhY2Fjc19zZXJ2ZXJfaXB2NF9yZXN1bHRbCiAgICAgICAgICAgICAgICAiaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY0Il0KICAgICAgICBpZiBod3RhY2Fjc19zZXJ2ZXJfaXB2NiBhbmQgaHd0YWNhY3Nfc2VydmVyX2lwdjZfcmVzdWx0WyJod3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjYiXToKICAgICAgICAgICAgZXhpc3RpbmdbImh3dGFjYWNzIHNlcnZlciBjZmcgaXB2NiJdID0gaHd0YWNhY3Nfc2VydmVyX2lwdjZfcmVzdWx0WwogICAgICAgICAgICAgICAgImh3dGFjYWNzX3NlcnZlcl9jZmdfaXB2NiJdCiAgICAgICAgaWYgaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZSBhbmQgaHd0YWNhY3NfaG9zdF9uYW1lX3Jlc3VsdFsiaHd0YWNhY3Nfc2VydmVyX25hbWVfY2ZnIl06CiAgICAgICAgICAgIGV4aXN0aW5nWyJod3RhY2FjcyBzZXJ2ZXIgbmFtZSBjZmciXSA9IGh3dGFjYWNzX2hvc3RfbmFtZV9yZXN1bHRbCiAgICAgICAgICAgICAgICAiaHd0YWNhY3Nfc2VydmVyX25hbWVfY2ZnIl0KCiAgICAgICAgaWYgc3RhdGUgPT0gInByZXNlbnQiOgogICAgICAgICAgICBpZiBod3RhY2Fjc19zZXJ2ZXJfaXAgYW5kIGh3dGFjYWNzX3NlcnZlcl9pcHY0X3Jlc3VsdFsibmVlZF9jZmciXToKICAgICAgICAgICAgICAgIGNtZCA9IGNlX2FhYV9zZXJ2ZXJfaG9zdC5tZXJnZV9od3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjQoCiAgICAgICAgICAgICAgICAgICAgbW9kdWxlPW1vZHVsZSkKICAgICAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgICAgICAgICB1cGRhdGVzLmFwcGVuZChjbWQpCgogICAgICAgICAgICBpZiBod3RhY2Fjc19zZXJ2ZXJfaXB2NiBhbmQgaHd0YWNhY3Nfc2VydmVyX2lwdjZfcmVzdWx0WyJuZWVkX2NmZyJdOgogICAgICAgICAgICAgICAgY21kID0gY2VfYWFhX3NlcnZlcl9ob3N0Lm1lcmdlX2h3dGFjYWNzX3NlcnZlcl9jZmdfaXB2NigKICAgICAgICAgICAgICAgICAgICBtb2R1bGU9bW9kdWxlKQogICAgICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICAgICAgICAgIHVwZGF0ZXMuYXBwZW5kKGNtZCkKCiAgICAgICAgICAgIGlmIGh3dGFjYWNzX3NlcnZlcl9ob3N0X25hbWUgYW5kIGh3dGFjYWNzX2hvc3RfbmFtZV9yZXN1bHRbIm5lZWRfY2ZnIl06CiAgICAgICAgICAgICAgICBjbWQgPSBjZV9hYWFfc2VydmVyX2hvc3QubWVyZ2VfaHd0YWNhY3NfaG9zdF9zZXJ2ZXJfY2ZnKAogICAgICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgdXBkYXRlcy5hcHBlbmQoY21kKQoKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBod3RhY2Fjc19zZXJ2ZXJfaXAgYW5kIGh3dGFjYWNzX3NlcnZlcl9pcHY0X3Jlc3VsdFsibmVlZF9jZmciXToKICAgICAgICAgICAgICAgIGNtZCA9IGNlX2FhYV9zZXJ2ZXJfaG9zdC5kZWxldGVfaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY0KAogICAgICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgdXBkYXRlcy5hcHBlbmQoY21kKQoKICAgICAgICAgICAgaWYgaHd0YWNhY3Nfc2VydmVyX2lwdjYgYW5kIGh3dGFjYWNzX3NlcnZlcl9pcHY2X3Jlc3VsdFsibmVlZF9jZmciXToKICAgICAgICAgICAgICAgIGNtZCA9IGNlX2FhYV9zZXJ2ZXJfaG9zdC5kZWxldGVfaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY2KAogICAgICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgdXBkYXRlcy5hcHBlbmQoY21kKQoKICAgICAgICAgICAgaWYgaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZSBhbmQgaHd0YWNhY3NfaG9zdF9uYW1lX3Jlc3VsdFsibmVlZF9jZmciXToKICAgICAgICAgICAgICAgIGNtZCA9IGNlX2FhYV9zZXJ2ZXJfaG9zdC5kZWxldGVfaHd0YWNhY3NfaG9zdF9zZXJ2ZXJfY2ZnKAogICAgICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgdXBkYXRlcy5hcHBlbmQoY21kKQoKICAgICAgICBpZiBod3RhY2Fjc19zZXJ2ZXJfaXA6CiAgICAgICAgICAgIGh3dGFjYWNzX3NlcnZlcl9pcHY0X3Jlc3VsdCA9IGNlX2FhYV9zZXJ2ZXJfaG9zdC5nZXRfaHd0YWNhY3Nfc2VydmVyX2NmZ19pcHY0KAogICAgICAgICAgICAgICAgbW9kdWxlPW1vZHVsZSkKICAgICAgICBpZiBod3RhY2Fjc19zZXJ2ZXJfaXB2NjoKICAgICAgICAgICAgaHd0YWNhY3Nfc2VydmVyX2lwdjZfcmVzdWx0ID0gY2VfYWFhX3NlcnZlcl9ob3N0LmdldF9od3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjYoCiAgICAgICAgICAgICAgICBtb2R1bGU9bW9kdWxlKQogICAgICAgIGlmIGh3dGFjYWNzX3NlcnZlcl9ob3N0X25hbWU6CiAgICAgICAgICAgIGh3dGFjYWNzX2hvc3RfbmFtZV9yZXN1bHQgPSBjZV9hYWFfc2VydmVyX2hvc3QuZ2V0X2h3dGFjYWNzX2hvc3Rfc2VydmVyX2NmZygKICAgICAgICAgICAgICAgIG1vZHVsZT1tb2R1bGUpCgogICAgICAgIGlmIGh3dGFjYWNzX3NlcnZlcl9pcCBhbmQgaHd0YWNhY3Nfc2VydmVyX2lwdjRfcmVzdWx0WyJod3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjQiXToKICAgICAgICAgICAgZW5kX3N0YXRlWyJod3RhY2FjcyBzZXJ2ZXIgY2ZnIGlwdjQiXSA9IGh3dGFjYWNzX3NlcnZlcl9pcHY0X3Jlc3VsdFsKICAgICAgICAgICAgICAgICJod3RhY2Fjc19zZXJ2ZXJfY2ZnX2lwdjQiXQogICAgICAgIGlmIGh3dGFjYWNzX3NlcnZlcl9pcHY2IGFuZCBod3RhY2Fjc19zZXJ2ZXJfaXB2Nl9yZXN1bHRbImh3dGFjYWNzX3NlcnZlcl9jZmdfaXB2NiJdOgogICAgICAgICAgICBlbmRfc3RhdGVbImh3dGFjYWNzIHNlcnZlciBjZmcgaXB2NiJdID0gaHd0YWNhY3Nfc2VydmVyX2lwdjZfcmVzdWx0WwogICAgICAgICAgICAgICAgImh3dGFjYWNzX3NlcnZlcl9jZmdfaXB2NiJdCiAgICAgICAgaWYgaHd0YWNhY3Nfc2VydmVyX2hvc3RfbmFtZSBhbmQgaHd0YWNhY3NfaG9zdF9uYW1lX3Jlc3VsdFsiaHd0YWNhY3Nfc2VydmVyX25hbWVfY2ZnIl06CiAgICAgICAgICAgIGVuZF9zdGF0ZVsiaHd0YWNhY3Mgc2VydmVyIG5hbWUgY2ZnIl0gPSBod3RhY2Fjc19ob3N0X25hbWVfcmVzdWx0WwogICAgICAgICAgICAgICAgImh3dGFjYWNzX3NlcnZlcl9uYW1lX2NmZyJdCgogICAgcmVzdWx0cyA9IGRpY3QoKQogICAgcmVzdWx0c1sncHJvcG9zZWQnXSA9IHByb3Bvc2VkCiAgICByZXN1bHRzWydleGlzdGluZyddID0gZXhpc3RpbmcKICAgIHJlc3VsdHNbJ2NoYW5nZWQnXSA9IGNoYW5nZWQKICAgIHJlc3VsdHNbJ2VuZF9zdGF0ZSddID0gZW5kX3N0YXRlCiAgICByZXN1bHRzWyd1cGRhdGVzJ10gPSB1cGRhdGVzCgogICAgbW9kdWxlLmV4aXRfanNvbigqKnJlc3VsdHMpCgoKaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICAgIG1haW4oKQpQSwMEFAAAAAAA1LsrSzvfOZUwigEAMIoBAB0AAABhbnNpYmxlL21vZHVsZV91dGlscy9iYXNpYy5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpLCBNaWNoYWVsIERlSGFhbiA8bWljaGFlbC5kZWhhYW5AZ21haWwuY29tPiwgMjAxMi0yMDEzCiMgQ29weXJpZ2h0IChjKSwgVG9zaGlvIEt1cmF0b21pIDx0a3VyYXRvbWlAYW5zaWJsZS5jb20+IDIwMTYKIyBBbGwgcmlnaHRzIHJlc2VydmVkLgojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwKIyBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiMgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICAgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICAgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKIyBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAojIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4KIyBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwKIyBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sCiMgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCiMgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVAojIExJQUJJTElUWSwgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRQojIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCgpCT09MRUFOU19UUlVFID0gWyd5JywgJ3llcycsICdvbicsICcxJywgJ3RydWUnLCAxLCBUcnVlXQpCT09MRUFOU19GQUxTRSA9IFsnbicsICdubycsICdvZmYnLCAnMCcsICdmYWxzZScsIDAsIEZhbHNlXQpCT09MRUFOUyA9IEJPT0xFQU5TX1RSVUUgKyBCT09MRUFOU19GQUxTRQoKU0laRV9SQU5HRVMgPSB7ICdZJzogMTw8ODAsICdaJzogMTw8NzAsICdFJzogMTw8NjAsICdQJzogMTw8NTAsICdUJzogMTw8NDAsICdHJzogMTw8MzAsICdNJzogMTw8MjAsICdLJzogMTw8MTAsICdCJzogMSB9CgpGSUxFX0FUVFJJQlVURVMgPSB7CiAgICAnQSc6ICdub2F0aW1lJywKICAgICdhJzogJ2FwcGVuZCcsCiAgICAnYyc6ICdjb21wcmVzc2VkJywKICAgICdDJzogJ25vY293JywKICAgICdkJzogJ25vZHVtcCcsCiAgICAnRCc6ICdkaXJzeW5jJywKICAgICdlJzogJ2V4dGVudHMnLAogICAgJ0UnOiAnZW5jcnlwdGVkJywKICAgICdoJzogJ2Jsb2Nrc2l6ZScsCiAgICAnaSc6ICdpbW11dGFibGUnLAogICAgJ0knOiAnaW5kZXhlZCcsCiAgICAnaic6ICdqb3VybmFsbGVkJywKICAgICdOJzogJ2lubGluZScsCiAgICAncyc6ICd6ZXJvJywKICAgICdTJzogJ3N5bmNocm9ub3VzJywKICAgICd0JzogJ25vdGFpbCcsCiAgICAnVCc6ICdibG9ja3Jvb3QnLAogICAgJ3UnOiAndW5kZWxldGUnLAogICAgJ1gnOiAnY29tcHJlc3NlZHJhdycsCiAgICAnWic6ICdjb21wcmVzc2VkZGlydHknLAp9CgojIGFuc2libGUgbW9kdWxlcyBjYW4gYmUgd3JpdHRlbiBpbiBhbnkgbGFuZ3VhZ2UuICBUbyBzaW1wbGlmeQojIGRldmVsb3BtZW50IG9mIFB5dGhvbiBtb2R1bGVzLCB0aGUgZnVuY3Rpb25zIGF2YWlsYWJsZSBoZXJlIGNhbgojIGJlIHVzZWQgdG8gZG8gbWFueSBjb21tb24gdGFza3MKCmltcG9ydCBsb2NhbGUKaW1wb3J0IG9zCmltcG9ydCByZQppbXBvcnQgc2hsZXgKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHN5cwppbXBvcnQgdHlwZXMKaW1wb3J0IHRpbWUKaW1wb3J0IHNlbGVjdAppbXBvcnQgc2h1dGlsCmltcG9ydCBzdGF0CmltcG9ydCB0ZW1wZmlsZQppbXBvcnQgdHJhY2ViYWNrCmltcG9ydCBncnAKaW1wb3J0IHB3ZAppbXBvcnQgcGxhdGZvcm0KaW1wb3J0IGVycm5vCmltcG9ydCBkYXRldGltZQpmcm9tIGl0ZXJ0b29scyBpbXBvcnQgcmVwZWF0LCBjaGFpbgoKdHJ5OgogICAgaW1wb3J0IHN5c2xvZwogICAgSEFTX1NZU0xPRz1UcnVlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIEhBU19TWVNMT0c9RmFsc2UKCnRyeToKICAgIGZyb20gc3lzdGVtZCBpbXBvcnQgam91cm5hbAogICAgaGFzX2pvdXJuYWwgPSBUcnVlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGhhc19qb3VybmFsID0gRmFsc2UKCkhBVkVfU0VMSU5VWD1GYWxzZQp0cnk6CiAgICBpbXBvcnQgc2VsaW51eAogICAgSEFWRV9TRUxJTlVYPVRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgcGFzcwoKIyBQeXRob24yICYgMyB3YXkgdG8gZ2V0IE5vbmVUeXBlCk5vbmVUeXBlID0gdHlwZShOb25lKQoKdHJ5OgogICAgZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgU2VxdWVuY2UsIE1hcHBpbmcKZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyBweXRob24yLjUKICAgIFNlcXVlbmNlID0gKGxpc3QsIHR1cGxlKQogICAgTWFwcGluZyA9IChkaWN0LCkKCiMgTm90ZTogV2hlbiBnZXR0aW5nIFNlcXVlbmNlIGZyb20gY29sbGVjdGlvbnMsIGl0IG1hdGNoZXMgd2l0aCBzdHJpbmdzLiAgSWYKIyB0aGlzIG1hdHRlcnMsIG1ha2Ugc3VyZSB0byBjaGVjayBmb3Igc3RyaW5ncyBiZWZvcmUgY2hlY2tpbmcgZm9yIHNlcXVlbmNldHlwZQp0cnk6CiAgICBmcm9tIGNvbGxlY3Rpb25zLmFiYyBpbXBvcnQgS2V5c1ZpZXcKICAgIFNFUVVFTkNFVFlQRSA9IChTZXF1ZW5jZSwgS2V5c1ZpZXcpCmV4Y2VwdDoKICAgIFNFUVVFTkNFVFlQRSA9IFNlcXVlbmNlCgp0cnk6CiAgICBpbXBvcnQganNvbgogICAgIyBEZXRlY3QgdGhlIHB5dGhvbi1qc29uIGxpYnJhcnkgd2hpY2ggaXMgaW5jb21wYXRpYmxlCiAgICAjIExvb2sgZm9yIHNpbXBsZWpzb24gaWYgdGhhdCdzIHRoZSBjYXNlCiAgICB0cnk6CiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoanNvbi5sb2FkcywgdHlwZXMuRnVuY3Rpb25UeXBlKSBvciBub3QgaXNpbnN0YW5jZShqc29uLmR1bXBzLCB0eXBlcy5GdW5jdGlvblR5cGUpOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcgogICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgIHJhaXNlIEltcG9ydEVycm9yCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIHRyeToKICAgICAgICBpbXBvcnQgc2ltcGxlanNvbiBhcyBqc29uCiAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgcHJpbnQoJ1xueyJtc2ciOiAiRXJyb3I6IGFuc2libGUgcmVxdWlyZXMgdGhlIHN0ZGxpYiBqc29uIG9yIHNpbXBsZWpzb24gbW9kdWxlLCBuZWl0aGVyIHdhcyBmb3VuZCEiLCAiZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCiAgICBleGNlcHQgU3ludGF4RXJyb3I6CiAgICAgICAgcHJpbnQoJ1xueyJtc2ciOiAiU3ludGF4RXJyb3I6IHByb2JhYmx5IGR1ZSB0byBpbnN0YWxsZWQgc2ltcGxlanNvbiBiZWluZyBmb3IgYSBkaWZmZXJlbnQgcHl0aG9uIHZlcnNpb24iLCAiZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCgpBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TID0gZGljdCgpCnRyeToKICAgIGltcG9ydCBoYXNobGliCgogICAgIyBweXRob24gMi43LjkrIGFuZCAyLjcuMCsKICAgIGZvciBhdHRyaWJ1dGUgaW4gKCdhdmFpbGFibGVfYWxnb3JpdGhtcycsICdhbGdvcml0aG1zJyk6CiAgICAgICAgYWxnb3JpdGhtcyA9IGdldGF0dHIoaGFzaGxpYiwgYXR0cmlidXRlLCBOb25lKQogICAgICAgIGlmIGFsZ29yaXRobXM6CiAgICAgICAgICAgIGJyZWFrCiAgICBpZiBhbGdvcml0aG1zIGlzIE5vbmU6CiAgICAgICAgIyBweXRob24gMi41KwogICAgICAgIGFsZ29yaXRobXMgPSAoJ21kNScsICdzaGExJywgJ3NoYTIyNCcsICdzaGEyNTYnLCAnc2hhMzg0JywgJ3NoYTUxMicpCiAgICBmb3IgYWxnb3JpdGhtIGluIGFsZ29yaXRobXM6CiAgICAgICAgQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNU1thbGdvcml0aG1dID0gZ2V0YXR0cihoYXNobGliLCBhbGdvcml0aG0pCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGltcG9ydCBzaGEKICAgIEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVMgPSB7J3NoYTEnOiBzaGEuc2hhfQogICAgdHJ5OgogICAgICAgIGltcG9ydCBtZDUKICAgICAgICBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TWydtZDUnXSA9IG1kNS5tZDUKICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICBwYXNzCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnB5Y29tcGF0MjQgaW1wb3J0IGdldF9leGNlcHRpb24sIGxpdGVyYWxfZXZhbApmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpbXBvcnQgKFBZMiwgUFkzLCBiLCBiaW5hcnlfdHlwZSwgaW50ZWdlcl90eXBlcywKICAgICAgICBpdGVyaXRlbXMsIHRleHRfdHlwZSwgc3RyaW5nX3R5cGVzKQpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5tb3ZlcyBpbXBvcnQgbWFwLCByZWR1Y2UsIHNobGV4X3F1b3RlCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuX3RleHQgaW1wb3J0IHRvX25hdGl2ZSwgdG9fYnl0ZXMsIHRvX3RleHQKClBBU1NXT1JEX01BVENIID0gcmUuY29tcGlsZShyJ14oPzouK1stX1xzXSk/cGFzcyg/OlstX1xzXT8oPzp3b3JkfHBocmFzZXx3cmR8d2QpPykoPzpbLV9cc10uKyk/JCcsIHJlLkkpCgpfTlVNQkVSVFlQRVMgPSB0dXBsZShsaXN0KGludGVnZXJfdHlwZXMpICsgW2Zsb2F0XSkKCiMgRGVwcmVjYXRlZCBjb21wYXQuICBPbmx5IGtlcHQgaW4gY2FzZSBhbm90aGVyIG1vZHVsZSB1c2VkIHRoZXNlIG5hbWVzICBVc2luZwojIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpcyBwcmVmZXJyZWQKCk5VTUJFUlRZUEVTID0gX05VTUJFUlRZUEVTCgppbWFwID0gbWFwCgp0cnk6CiAgICAjIFB5dGhvbiAyCiAgICB1bmljb2RlCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICAjIFB5dGhvbiAzCiAgICB1bmljb2RlID0gdGV4dF90eXBlCgp0cnk6CiAgICAjIFB5dGhvbiAyLjYrCiAgICBieXRlcwpleGNlcHQgTmFtZUVycm9yOgogICAgIyBQeXRob24gMi40CiAgICBieXRlcyA9IGJpbmFyeV90eXBlCgp0cnk6CiAgICAjIFB5dGhvbiAyCiAgICBiYXNlc3RyaW5nCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICAjIFB5dGhvbiAzCiAgICBiYXNlc3RyaW5nID0gc3RyaW5nX3R5cGVzCgpfbGl0ZXJhbF9ldmFsID0gbGl0ZXJhbF9ldmFsCgojIEVuZCBvZiBkZXByZWNhdGVkIG5hbWVzCgojIEludGVybmFsIGdsb2JhbCBob2xkaW5nIHBhc3NlZCBpbiBwYXJhbXMuICBUaGlzIGlzIGNvbnN1bHRlZCBpbiBjYXNlCiMgbXVsdGlwbGUgQW5zaWJsZU1vZHVsZXMgYXJlIGNyZWF0ZWQuICBPdGhlcndpc2UgZWFjaCBBbnNpYmxlTW9kdWxlIHdvdWxkCiMgYXR0ZW1wdCB0byByZWFkIGZyb20gc3RkaW4uICBPdGhlciBjb2RlIHNob3VsZCBub3QgdXNlIHRoaXMgZGlyZWN0bHkgYXMgaXQKIyBpcyBhbiBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBkZXRhaWwKX0FOU0lCTEVfQVJHUyA9IE5vbmUKCkZJTEVfQ09NTU9OX0FSR1VNRU5UUz1kaWN0KAogICAgc3JjID0gZGljdCgpLAogICAgbW9kZSA9IGRpY3QodHlwZT0ncmF3JyksCiAgICBvd25lciA9IGRpY3QoKSwKICAgIGdyb3VwID0gZGljdCgpLAogICAgc2V1c2VyID0gZGljdCgpLAogICAgc2Vyb2xlID0gZGljdCgpLAogICAgc2VsZXZlbCA9IGRpY3QoKSwKICAgIHNldHlwZSA9IGRpY3QoKSwKICAgIGZvbGxvdyA9IGRpY3QodHlwZT0nYm9vbCcsIGRlZmF1bHQ9RmFsc2UpLAogICAgIyBub3QgdGFrZW4gYnkgdGhlIGZpbGUgbW9kdWxlLCBidXQgb3RoZXIgbW9kdWxlcyBjYWxsIGZpbGUgc28gaXQgbXVzdCBpZ25vcmUgdGhlbS4KICAgIGNvbnRlbnQgPSBkaWN0KG5vX2xvZz1UcnVlKSwKICAgIGJhY2t1cCA9IGRpY3QoKSwKICAgIGZvcmNlID0gZGljdCgpLAogICAgcmVtb3RlX3NyYyA9IGRpY3QoKSwgIyB1c2VkIGJ5IGFzc2VtYmxlCiAgICByZWdleHAgPSBkaWN0KCksICMgdXNlZCBieSBhc3NlbWJsZQogICAgZGVsaW1pdGVyID0gZGljdCgpLCAjIHVzZWQgYnkgYXNzZW1ibGUKICAgIGRpcmVjdG9yeV9tb2RlID0gZGljdCgpLCAjIHVzZWQgYnkgY29weQogICAgdW5zYWZlX3dyaXRlcyAgPSBkaWN0KHR5cGU9J2Jvb2wnKSwgIyBzaG91bGQgYmUgYXZhaWxhYmxlIHRvIGFueSBtb2R1bGUgdXNpbmcgYXRvbWljX21vdmUKICAgIGF0dHJpYnV0ZXMgPSBkaWN0KGFsaWFzZXM9WydhdHRyJ10pLAopCgpQQVNTV0RfQVJHX1JFID0gcmUuY29tcGlsZShyJ15bLV17MCwyfXBhc3NbLV0/KHdvcmR8d2QpPycpCgojIENhbid0IHVzZSAwNzc3NyBvbiBQeXRob24gMywgY2FuJ3QgdXNlIDBvNzc3NyBvbiBQeXRob24gMi40ClBFUk1fQklUUyA9IGludCgnMDc3NzcnLCA4KSAgICAgICMgZmlsZSBtb2RlIHBlcm1pc3Npb24gYml0cwpFWEVDX1BFUk1fQklUUyA9IGludCgnMDAxMTEnLCA4KSAjIGV4ZWN1dGUgcGVybWlzc2lvbiBiaXRzCkRFRkFVTFRfUEVSTSA9IGludCgnMDY2NicsIDgpICAgICMgZGVmYXVsdCBmaWxlIHBlcm1pc3Npb24gYml0cwoKCmRlZiBnZXRfcGxhdGZvcm0oKToKICAgICcnJyB3aGF0J3MgdGhlIHBsYXRmb3JtPyAgZXhhbXBsZTogTGludXggaXMgYSBwbGF0Zm9ybS4gJycnCiAgICByZXR1cm4gcGxhdGZvcm0uc3lzdGVtKCkKCmRlZiBnZXRfZGlzdHJpYnV0aW9uKCk6CiAgICAnJycgcmV0dXJuIHRoZSBkaXN0cmlidXRpb24gbmFtZSAnJycKICAgIGlmIHBsYXRmb3JtLnN5c3RlbSgpID09ICdMaW51eCc6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdXBwb3J0ZWRfZGlzdHMgPSBwbGF0Zm9ybS5fc3VwcG9ydGVkX2Rpc3RzICsgKCdhcmNoJywnYWxwaW5lJykKICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gcGxhdGZvcm0ubGludXhfZGlzdHJpYnV0aW9uKHN1cHBvcnRlZF9kaXN0cz1zdXBwb3J0ZWRfZGlzdHMpWzBdLmNhcGl0YWxpemUoKQogICAgICAgICAgICBpZiBub3QgZGlzdHJpYnV0aW9uIGFuZCBvcy5wYXRoLmlzZmlsZSgnL2V0Yy9zeXN0ZW0tcmVsZWFzZScpOgogICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gcGxhdGZvcm0ubGludXhfZGlzdHJpYnV0aW9uKHN1cHBvcnRlZF9kaXN0cz1bJ3N5c3RlbSddKVswXS5jYXBpdGFsaXplKCkKICAgICAgICAgICAgICAgIGlmICdBbWF6b24nIGluIGRpc3RyaWJ1dGlvbjoKICAgICAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSAnQW1hem9uJwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSAnT3RoZXJMaW51eCcKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICMgRklYTUU6IE1ldGhvZE1pc3NpbmcsIEkgYXNzdW1lPwogICAgICAgICAgICBkaXN0cmlidXRpb24gPSBwbGF0Zm9ybS5kaXN0KClbMF0uY2FwaXRhbGl6ZSgpCiAgICBlbHNlOgogICAgICAgIGRpc3RyaWJ1dGlvbiA9IE5vbmUKICAgIHJldHVybiBkaXN0cmlidXRpb24KCmRlZiBnZXRfZGlzdHJpYnV0aW9uX3ZlcnNpb24oKToKICAgICcnJyByZXR1cm4gdGhlIGRpc3RyaWJ1dGlvbiB2ZXJzaW9uICcnJwogICAgaWYgcGxhdGZvcm0uc3lzdGVtKCkgPT0gJ0xpbnV4JzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbl92ZXJzaW9uID0gcGxhdGZvcm0ubGludXhfZGlzdHJpYnV0aW9uKClbMV0KICAgICAgICAgICAgaWYgbm90IGRpc3RyaWJ1dGlvbl92ZXJzaW9uIGFuZCBvcy5wYXRoLmlzZmlsZSgnL2V0Yy9zeXN0ZW0tcmVsZWFzZScpOgogICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oc3VwcG9ydGVkX2Rpc3RzPVsnc3lzdGVtJ10pWzFdCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAjIEZJWE1FOiBNZXRob2RNaXNzaW5nLCBJIGFzc3VtZT8KICAgICAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBwbGF0Zm9ybS5kaXN0KClbMV0KICAgIGVsc2U6CiAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBOb25lCiAgICByZXR1cm4gZGlzdHJpYnV0aW9uX3ZlcnNpb24KCmRlZiBnZXRfYWxsX3N1YmNsYXNzZXMoY2xzKToKICAgICcnJwogICAgdXNlZCBieSBtb2R1bGVzIGxpa2UgSGFyZHdhcmUgb3IgTmV0d29yayBmYWN0IGNsYXNzZXMgdG8gcmV0cmlldmUgYWxsIHN1YmNsYXNzZXMgb2YgYSBnaXZlbiBjbGFzcy4KICAgIF9fc3ViY2xhc3Nlc19fIHJldHVybiBvbmx5IGRpcmVjdCBzdWIgY2xhc3Nlcy4gVGhpcyBvbmUgZ28gZG93biBpbnRvIHRoZSBjbGFzcyB0cmVlLgogICAgJycnCiAgICAjIFJldHJpZXZlIGRpcmVjdCBzdWJjbGFzc2VzCiAgICBzdWJjbGFzc2VzID0gY2xzLl9fc3ViY2xhc3Nlc19fKCkKICAgIHRvX3Zpc2l0ID0gbGlzdChzdWJjbGFzc2VzKQogICAgIyBUaGVuIHZpc2l0IGFsbCBzdWJjbGFzc2VzCiAgICB3aGlsZSB0b192aXNpdDoKICAgICAgICBmb3Igc2MgaW4gdG9fdmlzaXQ6CiAgICAgICAgICAgICMgVGhlIGN1cnJlbnQgY2xhc3MgaXMgbm93IHZpc2l0ZWQsIHNvIHJlbW92ZSBpdCBmcm9tIGxpc3QKICAgICAgICAgICAgdG9fdmlzaXQucmVtb3ZlKHNjKQogICAgICAgICAgICAjIEFwcGVuZGluZyBhbGwgc3ViY2xhc3NlcyB0byB2aXNpdCBhbmQga2VlcCBhIHJlZmVyZW5jZSBvZiBhdmFpbGFibGUgY2xhc3MKICAgICAgICAgICAgZm9yIHNzYyBpbiBzYy5fX3N1YmNsYXNzZXNfXygpOgogICAgICAgICAgICAgICAgc3ViY2xhc3Nlcy5hcHBlbmQoc3NjKQogICAgICAgICAgICAgICAgdG9fdmlzaXQuYXBwZW5kKHNzYykKICAgIHJldHVybiBzdWJjbGFzc2VzCgoKZGVmIGxvYWRfcGxhdGZvcm1fc3ViY2xhc3MoY2xzLCAqYXJncywgKiprd2FyZ3MpOgogICAgJycnCiAgICB1c2VkIGJ5IG1vZHVsZXMgbGlrZSBVc2VyIHRvIGhhdmUgZGlmZmVyZW50IGltcGxlbWVudGF0aW9ucyBiYXNlZCBvbiBkZXRlY3RlZCBwbGF0Zm9ybS4gIFNlZSBVc2VyCiAgICBtb2R1bGUgZm9yIGFuIGV4YW1wbGUuCiAgICAnJycKCiAgICB0aGlzX3BsYXRmb3JtID0gZ2V0X3BsYXRmb3JtKCkKICAgIGRpc3RyaWJ1dGlvbiA9IGdldF9kaXN0cmlidXRpb24oKQogICAgc3ViY2xhc3MgPSBOb25lCgogICAgIyBnZXQgdGhlIG1vc3Qgc3BlY2lmaWMgc3VwZXJjbGFzcyBmb3IgdGhpcyBwbGF0Zm9ybQogICAgaWYgZGlzdHJpYnV0aW9uIGlzIG5vdCBOb25lOgogICAgICAgIGZvciBzYyBpbiBnZXRfYWxsX3N1YmNsYXNzZXMoY2xzKToKICAgICAgICAgICAgaWYgc2MuZGlzdHJpYnV0aW9uIGlzIG5vdCBOb25lIGFuZCBzYy5kaXN0cmlidXRpb24gPT0gZGlzdHJpYnV0aW9uIGFuZCBzYy5wbGF0Zm9ybSA9PSB0aGlzX3BsYXRmb3JtOgogICAgICAgICAgICAgICAgc3ViY2xhc3MgPSBzYwogICAgaWYgc3ViY2xhc3MgaXMgTm9uZToKICAgICAgICBmb3Igc2MgaW4gZ2V0X2FsbF9zdWJjbGFzc2VzKGNscyk6CiAgICAgICAgICAgIGlmIHNjLnBsYXRmb3JtID09IHRoaXNfcGxhdGZvcm0gYW5kIHNjLmRpc3RyaWJ1dGlvbiBpcyBOb25lOgogICAgICAgICAgICAgICAgc3ViY2xhc3MgPSBzYwogICAgaWYgc3ViY2xhc3MgaXMgTm9uZToKICAgICAgICBzdWJjbGFzcyA9IGNscwoKICAgIHJldHVybiBzdXBlcihjbHMsIHN1YmNsYXNzKS5fX25ld19fKHN1YmNsYXNzKQoKCmRlZiBqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcyhkLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKToKICAgICcnJyBSZWN1cnNpdmVseSBjb252ZXJ0IGRpY3Qga2V5cyBhbmQgdmFsdWVzIHRvIGJ5dGUgc3RyCgogICAgICAgIFNwZWNpYWxpemVkIGZvciBqc29uIHJldHVybiBiZWNhdXNlIHRoaXMgb25seSBoYW5kbGVzLCBsaXN0cywgdHVwbGVzLAogICAgICAgIGFuZCBkaWN0IGNvbnRhaW5lciB0eXBlcyAodGhlIGNvbnRhaW5lcnMgdGhhdCB0aGUganNvbiBtb2R1bGUgcmV0dXJucykKICAgICcnJwoKICAgIGlmIGlzaW5zdGFuY2UoZCwgdGV4dF90eXBlKToKICAgICAgICByZXR1cm4gdG9fYnl0ZXMoZCwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgZGljdCk6CiAgICAgICAgcmV0dXJuIGRpY3QobWFwKGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzLCBpdGVyaXRlbXMoZCksIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBsaXN0KToKICAgICAgICByZXR1cm4gbGlzdChtYXAoanNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMsIGQsIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCB0dXBsZSk6CiAgICAgICAgcmV0dXJuIHR1cGxlKG1hcChqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcywgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxzZToKICAgICAgICByZXR1cm4gZAoKZGVmIGpzb25fZGljdF9ieXRlc190b191bmljb2RlKGQsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpOgogICAgJycnIFJlY3Vyc2l2ZWx5IGNvbnZlcnQgZGljdCBrZXlzIGFuZCB2YWx1ZXMgdG8gYnl0ZSBzdHIKCiAgICAgICAgU3BlY2lhbGl6ZWQgZm9yIGpzb24gcmV0dXJuIGJlY2F1c2UgdGhpcyBvbmx5IGhhbmRsZXMsIGxpc3RzLCB0dXBsZXMsCiAgICAgICAgYW5kIGRpY3QgY29udGFpbmVyIHR5cGVzICh0aGUgY29udGFpbmVycyB0aGF0IHRoZSBqc29uIG1vZHVsZSByZXR1cm5zKQogICAgJycnCgogICAgaWYgaXNpbnN0YW5jZShkLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgIyBXYXJuaW5nLCBjYW4gdHJhY2ViYWNrCiAgICAgICAgcmV0dXJuIHRvX3RleHQoZCwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgZGljdCk6CiAgICAgICAgcmV0dXJuIGRpY3QobWFwKGpzb25fZGljdF9ieXRlc190b191bmljb2RlLCBpdGVyaXRlbXMoZCksIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBsaXN0KToKICAgICAgICByZXR1cm4gbGlzdChtYXAoanNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUsIGQsIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCB0dXBsZSk6CiAgICAgICAgcmV0dXJuIHR1cGxlKG1hcChqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZSwgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxzZToKICAgICAgICByZXR1cm4gZAoKZGVmIHJldHVybl92YWx1ZXMob2JqKToKICAgICIiIiBSZXR1cm4gbmF0aXZlIHN0cmluZ2lmaWVkIHZhbHVlcyBmcm9tIGRhdGFzdHJ1Y3R1cmVzLgoKICAgIEZvciB1c2Ugd2l0aCByZW1vdmluZyBzZW5zaXRpdmUgdmFsdWVzIHByZS1qc29uaWZpY2F0aW9uLiIiIgogICAgaWYgaXNpbnN0YW5jZShvYmosICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgaWYgb2JqOgogICAgICAgICAgICB5aWVsZCB0b19uYXRpdmUob2JqLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIHJldHVybgogICAgZWxpZiBpc2luc3RhbmNlKG9iaiwgU0VRVUVOQ0VUWVBFKToKICAgICAgICBmb3IgZWxlbWVudCBpbiBvYmo6CiAgICAgICAgICAgIGZvciBzdWJlbGVtZW50IGluIHJldHVybl92YWx1ZXMoZWxlbWVudCk6CiAgICAgICAgICAgICAgICB5aWVsZCBzdWJlbGVtZW50CiAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCBNYXBwaW5nKToKICAgICAgICBmb3IgZWxlbWVudCBpbiBvYmouaXRlbXMoKToKICAgICAgICAgICAgZm9yIHN1YmVsZW1lbnQgaW4gcmV0dXJuX3ZhbHVlcyhlbGVtZW50WzFdKToKICAgICAgICAgICAgICAgIHlpZWxkIHN1YmVsZW1lbnQKICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIChib29sLCBOb25lVHlwZSkpOgogICAgICAgICMgVGhpcyBtdXN0IGNvbWUgYmVmb3JlIGludCBiZWNhdXNlIGJvb2xzIGFyZSBhbHNvIGludHMKICAgICAgICByZXR1cm4KICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIE5VTUJFUlRZUEVTKToKICAgICAgICB5aWVsZCB0b19uYXRpdmUob2JqLCBub25zdHJpbmc9J3NpbXBsZXJlcHInKQogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ1Vua25vd24gcGFyYW1ldGVyIHR5cGU6ICVzLCAlcycgJSAodHlwZShvYmopLCBvYmopKQoKZGVmIHJlbW92ZV92YWx1ZXModmFsdWUsIG5vX2xvZ19zdHJpbmdzKToKICAgICIiIiBSZW1vdmUgc3RyaW5ncyBpbiBub19sb2dfc3RyaW5ncyBmcm9tIHZhbHVlLiAgSWYgdmFsdWUgaXMgYSBjb250YWluZXIKICAgIHR5cGUsIHRoZW4gcmVtb3ZlIGEgbG90IG1vcmUiIiIKICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgIyBOZWVkIG5hdGl2ZSBzdHIgdHlwZQogICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSB2YWx1ZQogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHRleHRfdHlwZSk6CiAgICAgICAgICAgIHZhbHVlX2lzX3RleHQgPSBUcnVlCiAgICAgICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSB0b19ieXRlcyh2YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgdmFsdWVfaXNfdGV4dCA9IEZhbHNlCiAgICAgICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSB0b190ZXh0KHZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQoKICAgICAgICBpZiBuYXRpdmVfc3RyX3ZhbHVlIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICByZXR1cm4gJ1ZBTFVFX1NQRUNJRklFRF9JTl9OT19MT0dfUEFSQU1FVEVSJwogICAgICAgIGZvciBvbWl0X21lIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICBuYXRpdmVfc3RyX3ZhbHVlID0gbmF0aXZlX3N0cl92YWx1ZS5yZXBsYWNlKG9taXRfbWUsICcqJyAqIDgpCgogICAgICAgIGlmIHZhbHVlX2lzX3RleHQgYW5kIGlzaW5zdGFuY2UobmF0aXZlX3N0cl92YWx1ZSwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICB2YWx1ZSA9IHRvX3RleHQobmF0aXZlX3N0cl92YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykKICAgICAgICBlbGlmIG5vdCB2YWx1ZV9pc190ZXh0IGFuZCBpc2luc3RhbmNlKG5hdGl2ZV9zdHJfdmFsdWUsIHRleHRfdHlwZSk6CiAgICAgICAgICAgIHZhbHVlID0gdG9fYnl0ZXMobmF0aXZlX3N0cl92YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykKICAgICAgICBlbHNlOgogICAgICAgICAgICB2YWx1ZSA9IG5hdGl2ZV9zdHJfdmFsdWUKICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgU0VRVUVOQ0VUWVBFKToKICAgICAgICByZXR1cm4gW3JlbW92ZV92YWx1ZXMoZWxlbSwgbm9fbG9nX3N0cmluZ3MpIGZvciBlbGVtIGluIHZhbHVlXQogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBNYXBwaW5nKToKICAgICAgICByZXR1cm4gZGljdCgoaywgcmVtb3ZlX3ZhbHVlcyh2LCBub19sb2dfc3RyaW5ncykpIGZvciBrLCB2IGluIHZhbHVlLml0ZW1zKCkpCiAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIHR1cGxlKGNoYWluKE5VTUJFUlRZUEVTLCAoYm9vbCwgTm9uZVR5cGUpKSkpOgogICAgICAgIHN0cmluZ3lfdmFsdWUgPSB0b19uYXRpdmUodmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgaWYgc3RyaW5neV92YWx1ZSBpbiBub19sb2dfc3RyaW5nczoKICAgICAgICAgICAgcmV0dXJuICdWQUxVRV9TUEVDSUZJRURfSU5fTk9fTE9HX1BBUkFNRVRFUicKICAgICAgICBmb3Igb21pdF9tZSBpbiBub19sb2dfc3RyaW5nczoKICAgICAgICAgICAgaWYgb21pdF9tZSBpbiBzdHJpbmd5X3ZhbHVlOgogICAgICAgICAgICAgICAgcmV0dXJuICdWQUxVRV9TUEVDSUZJRURfSU5fTk9fTE9HX1BBUkFNRVRFUicKICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgZGF0ZXRpbWUuZGF0ZXRpbWUpOgogICAgICAgIHZhbHVlID0gdmFsdWUuaXNvZm9ybWF0KCkKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdWYWx1ZSBvZiB1bmtub3duIHR5cGU6ICVzLCAlcycgJSAodHlwZSh2YWx1ZSksIHZhbHVlKSkKICAgIHJldHVybiB2YWx1ZQoKCmRlZiBoZXVyaXN0aWNfbG9nX3Nhbml0aXplKGRhdGEsIG5vX2xvZ192YWx1ZXM9Tm9uZSk6CiAgICAnJycgUmVtb3ZlIHN0cmluZ3MgdGhhdCBsb29rIGxpa2UgcGFzc3dvcmRzIGZyb20gbG9nIG1lc3NhZ2VzICcnJwogICAgIyBDdXJyZW50bHkgZmlsdGVyczoKICAgICMgdXNlcjpwYXNzQGZvby93aGF0ZXZlciBhbmQgaHR0cDovL3VzZXJuYW1lOnBhc3NAd2hlcmV2ZXIvZm9vCiAgICAjIFRoaXMgY29kZSBoYXMgZmFsc2UgcG9zaXRpdmVzIGFuZCBjb25zdW1lcyBwYXJ0cyBvZiBsb2dzIHRoYXQgYXJlCiAgICAjIG5vdCBwYXNzd2RzCgogICAgIyBiZWdpbjogc3RhcnQgb2YgYSBwYXNzd2QgY29udGFpbmluZyBzdHJpbmcKICAgICMgZW5kOiBlbmQgb2YgYSBwYXNzd2QgY29udGFpbmluZyBzdHJpbmcKICAgICMgc2VwOiBjaGFyIGJldHdlZW4gdXNlciBhbmQgcGFzc3dkCiAgICAjIHByZXZfYmVnaW46IHdoZXJlIGluIHRoZSBvdmVyYWxsIHN0cmluZyB0byBzdGFydCBhIHNlYXJjaCBmb3IKICAgICMgICBhIHBhc3N3ZAogICAgIyBzZXBfc2VhcmNoX2VuZDogd2hlcmUgaW4gdGhlIHN0cmluZyB0byBlbmQgYSBzZWFyY2ggZm9yIHRoZSBzZXAKICAgIGRhdGEgPSB0b19uYXRpdmUoZGF0YSkKCiAgICBvdXRwdXQgPSBbXQogICAgYmVnaW4gPSBsZW4oZGF0YSkKICAgIHByZXZfYmVnaW4gPSBiZWdpbgogICAgc2VwID0gMQogICAgd2hpbGUgc2VwOgogICAgICAgICMgRmluZCB0aGUgcG90ZW50aWFsIGVuZCBvZiBhIHBhc3N3ZAogICAgICAgIHRyeToKICAgICAgICAgICAgZW5kID0gZGF0YS5yaW5kZXgoJ0AnLCAwLCBiZWdpbikKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgIyBObyBwYXNzd2QgaW4gdGhlIHJlc3Qgb2YgdGhlIGRhdGEKICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCBkYXRhWzA6YmVnaW5dKQogICAgICAgICAgICBicmVhawoKICAgICAgICAjIFNlYXJjaCBmb3IgdGhlIGJlZ2lubmluZyBvZiBhIHBhc3N3ZAogICAgICAgIHNlcCA9IE5vbmUKICAgICAgICBzZXBfc2VhcmNoX2VuZCA9IGVuZAogICAgICAgIHdoaWxlIG5vdCBzZXA6CiAgICAgICAgICAgICMgVVJMLXN0eWxlIHVzZXJuYW1lK3Bhc3N3b3JkCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGJlZ2luID0gZGF0YS5yaW5kZXgoJzovLycsIDAsIHNlcF9zZWFyY2hfZW5kKQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICMgTm8gdXJsIHN0eWxlIGluIHRoZSBkYXRhLCBjaGVjayBmb3Igc3NoIHN0eWxlIGluIHRoZQogICAgICAgICAgICAgICAgIyByZXN0IG9mIHRoZSBzdHJpbmcKICAgICAgICAgICAgICAgIGJlZ2luID0gMAogICAgICAgICAgICAjIFNlYXJjaCBmb3Igc2VwYXJhdG9yCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlcCA9IGRhdGEuaW5kZXgoJzonLCBiZWdpbiArIDMsIGVuZCkKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAjIE5vIHNlcGFyYXRvcjsgY2hvaWNlczoKICAgICAgICAgICAgICAgIGlmIGJlZ2luID09IDA6CiAgICAgICAgICAgICAgICAgICAgIyBTZWFyY2hlZCB0aGUgd2hvbGUgc3RyaW5nIHNvIHRoZXJlJ3Mgbm8gcGFzc3dvcmQKICAgICAgICAgICAgICAgICAgICAjIGhlcmUuICBSZXR1cm4gdGhlIHJlbWFpbmluZyBkYXRhCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCBkYXRhWzA6YmVnaW5dKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAjIFNlYXJjaCBmb3IgYSBkaWZmZXJlbnQgYmVnaW5uaW5nIG9mIHRoZSBwYXNzd29yZCBmaWVsZC4KICAgICAgICAgICAgICAgIHNlcF9zZWFyY2hfZW5kID0gYmVnaW4KICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgaWYgc2VwOgogICAgICAgICAgICAjIFBhc3N3b3JkIHdhcyBmb3VuZDsgcmVtb3ZlIGl0LgogICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsIGRhdGFbZW5kOnByZXZfYmVnaW5dKQogICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsICcqKioqKioqKicpCiAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgZGF0YVtiZWdpbjpzZXAgKyAxXSkKICAgICAgICAgICAgcHJldl9iZWdpbiA9IGJlZ2luCgogICAgb3V0cHV0ID0gJycuam9pbihvdXRwdXQpCiAgICBpZiBub19sb2dfdmFsdWVzOgogICAgICAgIG91dHB1dCA9IHJlbW92ZV92YWx1ZXMob3V0cHV0LCBub19sb2dfdmFsdWVzKQogICAgcmV0dXJuIG91dHB1dAoKZGVmIGJ5dGVzX3RvX2h1bWFuKHNpemUsIGlzYml0cz1GYWxzZSwgdW5pdD1Ob25lKToKCiAgICBiYXNlID0gJ0J5dGVzJwogICAgaWYgaXNiaXRzOgogICAgICAgIGJhc2UgPSAnYml0cycKICAgIHN1ZmZpeCA9ICcnCgogICAgZm9yIHN1ZmZpeCwgbGltaXQgaW4gc29ydGVkKGl0ZXJpdGVtcyhTSVpFX1JBTkdFUyksIGtleT1sYW1iZGEgaXRlbTogLWl0ZW1bMV0pOgogICAgICAgIGlmICh1bml0IGlzIE5vbmUgYW5kIHNpemUgPj0gbGltaXQpIG9yIHVuaXQgaXMgbm90IE5vbmUgYW5kIHVuaXQudXBwZXIoKSA9PSBzdWZmaXhbMF06CiAgICAgICAgICAgIGJyZWFrCgogICAgaWYgbGltaXQgIT0gMToKICAgICAgICBzdWZmaXggKz0gYmFzZVswXQogICAgZWxzZToKICAgICAgICBzdWZmaXggPSBiYXNlCgogICAgcmV0dXJuICclLjJmICVzJyAlIChmbG9hdChzaXplKS8gbGltaXQsIHN1ZmZpeCkKCmRlZiBodW1hbl90b19ieXRlcyhudW1iZXIsIGRlZmF1bHRfdW5pdD1Ob25lLCBpc2JpdHM9RmFsc2UpOgoKICAgICcnJwogICAgQ29udmVydCBudW1iZXIgaW4gc3RyaW5nIGZvcm1hdCBpbnRvIGJ5dGVzIChleDogJzJLJyA9PiAyMDQ4KSBvciB1c2luZyB1bml0IGFyZ3VtZW50CiAgICBleDoKICAgICAgaHVtYW5fdG9fYnl0ZXMoJzEwTScpIDw9PiBodW1hbl90b19ieXRlcygxMCwgJ00nKQogICAgJycnCiAgICBtID0gcmUuc2VhcmNoKCdeXHMqKFxkKlwuP1xkKilccyooW0EtWmEtel0rKT8nLCBzdHIobnVtYmVyKSwgZmxhZ3M9cmUuSUdOT1JFQ0FTRSkKICAgIGlmIG0gaXMgTm9uZToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJodW1hbl90b19ieXRlcygpIGNhbid0IGludGVycHJldCBmb2xsb3dpbmcgc3RyaW5nOiAlcyIgJSBzdHIobnVtYmVyKSkKICAgIHRyeToKICAgICAgICBudW0gPSBmbG9hdChtLmdyb3VwKDEpKQogICAgZXhjZXB0OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgY2FuJ3QgaW50ZXJwcmV0IGZvbGxvd2luZyBudW1iZXI6ICVzIChvcmlnaW5hbCBpbnB1dCBzdHJpbmc6ICVzKSIgJSAobS5ncm91cCgxKSwgbnVtYmVyKSkKCiAgICB1bml0ID0gbS5ncm91cCgyKQogICAgaWYgdW5pdCBpcyBOb25lOgogICAgICAgIHVuaXQgPSBkZWZhdWx0X3VuaXQKCiAgICBpZiB1bml0IGlzIE5vbmU6CiAgICAgICAgJycnIE5vIHVuaXQgZ2l2ZW4sIHJldHVybmluZyByYXcgbnVtYmVyICcnJwogICAgICAgIHJldHVybiBpbnQocm91bmQobnVtKSkKICAgIHJhbmdlX2tleSA9IHVuaXRbMF0udXBwZXIoKQogICAgdHJ5OgogICAgICAgIGxpbWl0ID0gU0laRV9SQU5HRVNbcmFuZ2Vfa2V5XQogICAgZXhjZXB0OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgZmFpbGVkIHRvIGNvbnZlcnQgJXMgKHVuaXQgPSAlcykuIFRoZSBzdWZmaXggbXVzdCBiZSBvbmUgb2YgJXMiICUgKG51bWJlciwgdW5pdCwgIiwgIi5qb2luKFNJWkVfUkFOR0VTLmtleXMoKSkpKQoKICAgICMgZGVmYXVsdCB2YWx1ZQogICAgdW5pdF9jbGFzcyA9ICdCJwogICAgdW5pdF9jbGFzc19uYW1lID0gJ2J5dGUnCiAgICAjIGhhbmRsaW5nIGJpdHMgY2FzZQogICAgaWYgaXNiaXRzOgogICAgICAgIHVuaXRfY2xhc3MgPSAnYicKICAgICAgICB1bml0X2NsYXNzX25hbWUgPSAnYml0JwogICAgIyBjaGVjayB1bml0IHZhbHVlIGlmIG1vcmUgdGhhbiBvbmUgY2hhcmFjdGVyIChLQiwgTUIpCiAgICBpZiBsZW4odW5pdCkgPiAxOgogICAgICAgIGV4cGVjdF9tZXNzYWdlID0gJ2V4cGVjdCAlcyVzIG9yICVzJyAlIChyYW5nZV9rZXksIHVuaXRfY2xhc3MsIHJhbmdlX2tleSkKICAgICAgICBpZiByYW5nZV9rZXkgPT0gJ0InOgogICAgICAgICAgICBleHBlY3RfbWVzc2FnZSA9ICdleHBlY3QgJXMgb3IgJXMnICUgKHVuaXRfY2xhc3MsIHVuaXRfY2xhc3NfbmFtZSkKCiAgICAgICAgaWYgdW5pdF9jbGFzc19uYW1lIGluIHVuaXQubG93ZXIoKToKICAgICAgICAgICAgcGFzcwogICAgICAgIGVsaWYgdW5pdFsxXSAhPSB1bml0X2NsYXNzOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJodW1hbl90b19ieXRlcygpIGZhaWxlZCB0byBjb252ZXJ0ICVzLiBWYWx1ZSBpcyBub3QgYSB2YWxpZCBzdHJpbmcgKCVzKSIgJSAobnVtYmVyLCBleHBlY3RfbWVzc2FnZSkpCgogICAgcmV0dXJuIGludChyb3VuZChudW0gKiBsaW1pdCkpCgpkZWYgaXNfZXhlY3V0YWJsZShwYXRoKToKICAgICcnJ2lzIHRoZSBnaXZlbiBwYXRoIGV4ZWN1dGFibGU/CgogICAgTGltaXRhdGlvbnM6CiAgICAqIERvZXMgbm90IGFjY291bnQgZm9yIEZTQUNMcy4KICAgICogTW9zdCB0aW1lcyB3ZSByZWFsbHkgd2FudCB0byBrbm93ICJDYW4gdGhlIGN1cnJlbnQgdXNlciBleGVjdXRlIHRoaXMKICAgICAgZmlsZSIgIFRoaXMgZnVuY3Rpb24gZG9lcyBub3QgdGVsbCB1cyB0aGF0LCBvbmx5IGlmIGFuIGV4ZWN1dGUgYml0IGlzIHNldC4KICAgICcnJwogICAgIyBUaGVzZSBhcmUgYWxsIGJpdGZpZWxkcyBzbyBmaXJzdCBiaXR3aXNlLW9yIGFsbCB0aGUgcGVybWlzc2lvbnMgd2UncmUKICAgICMgbG9va2luZyBmb3IsIHRoZW4gYml0d2lzZS1hbmQgd2l0aCB0aGUgZmlsZSdzIG1vZGUgdG8gZGV0ZXJtaW5lIGlmIGFueQogICAgIyBleGVjdXRlIGJpdHMgYXJlIHNldC4KICAgIHJldHVybiAoKHN0YXQuU19JWFVTUiB8IHN0YXQuU19JWEdSUCB8IHN0YXQuU19JWE9USCkgJiBvcy5zdGF0KHBhdGgpW3N0YXQuU1RfTU9ERV0pCgpkZWYgX2xvYWRfcGFyYW1zKCk6CiAgICAnJycgcmVhZCB0aGUgbW9kdWxlcyBwYXJhbWV0ZXJzIGFuZCBzdG9yZSB0aGVtIGdsb2JhbGx5LgoKICAgIFRoaXMgZnVuY3Rpb24gbWF5IGJlIG5lZWRlZCBmb3IgY2VydGFpbiB2ZXJ5IGR5bmFtaWMgY3VzdG9tIG1vZHVsZXMgd2hpY2gKICAgIHdhbnQgdG8gcHJvY2VzcyB0aGUgcGFyYW1ldGVycyB0aGF0IGFyZSBiZWluZyBoYW5kZWQgdGhlIG1vZHVsZS4gIFNpbmNlCiAgICB0aGlzIGlzIHNvIGNsb3NlbHkgdGllZCB0byB0aGUgaW1wbGVtZW50YXRpb24gb2YgbW9kdWxlcyB3ZSBjYW5ub3QKICAgIGd1YXJhbnRlZSBBUEkgc3RhYmlsaXR5IGZvciBpdCAoaXQgbWF5IGNoYW5nZSBiZXR3ZWVuIHZlcnNpb25zKSBob3dldmVyIHdlCiAgICB3aWxsIHRyeSBub3QgdG8gYnJlYWsgaXQgZ3JhdHVpdG91c2x5LiAgSXQgaXMgY2VydGFpbmx5IG1vcmUgZnV0dXJlLXByb29mCiAgICB0byBjYWxsIHRoaXMgZnVuY3Rpb24gYW5kIGNvbnN1bWUgaXRzIG91dHB1dHMgdGhhbiB0byBpbXBsZW1lbnQgdGhlIGxvZ2ljCiAgICBpbnNpZGUgaXQgYXMgYSBjb3B5IGluIHlvdXIgb3duIGNvZGUuCiAgICAnJycKICAgIGdsb2JhbCBfQU5TSUJMRV9BUkdTCiAgICBpZiBfQU5TSUJMRV9BUkdTIGlzIG5vdCBOb25lOgogICAgICAgIGJ1ZmZlciA9IF9BTlNJQkxFX0FSR1MKICAgIGVsc2U6CiAgICAgICAgIyBkZWJ1ZyBvdmVycmlkZXMgdG8gcmVhZCBhcmdzIGZyb20gZmlsZSBvciBjbWRsaW5lCgogICAgICAgICMgQXZvaWQgdHJhY2ViYWNrcyB3aGVuIGxvY2FsZSBpcyBub24tdXRmOAogICAgICAgICMgV2UgY29udHJvbCB0aGUgYXJncyBhbmQgd2UgcGFzcyB0aGVtIGFzIHV0ZjgKICAgICAgICBpZiBsZW4oc3lzLmFyZ3YpID4gMToKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUoc3lzLmFyZ3ZbMV0pOgogICAgICAgICAgICAgICAgZmQgPSBvcGVuKHN5cy5hcmd2WzFdLCAncmInKQogICAgICAgICAgICAgICAgYnVmZmVyID0gZmQucmVhZCgpCiAgICAgICAgICAgICAgICBmZC5jbG9zZSgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzeXMuYXJndlsxXQogICAgICAgICAgICAgICAgaWYgUFkzOgogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IGJ1ZmZlci5lbmNvZGUoJ3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICMgZGVmYXVsdCBjYXNlLCByZWFkIGZyb20gc3RkaW4KICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBQWTI6CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzeXMuc3RkaW4ucmVhZCgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzeXMuc3RkaW4uYnVmZmVyLnJlYWQoKQogICAgICAgIF9BTlNJQkxFX0FSR1MgPSBidWZmZXIKCiAgICB0cnk6CiAgICAgICAgcGFyYW1zID0ganNvbi5sb2FkcyhidWZmZXIuZGVjb2RlKCd1dGYtOCcpKQogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgIyBUaGlzIGhlbHBlciB1c2VkIHRvbyBlYXJseSBmb3IgZmFpbF9qc29uIHRvIHdvcmsuCiAgICAgICAgcHJpbnQoJ1xueyJtc2ciOiAiRXJyb3I6IE1vZHVsZSB1bmFibGUgdG8gZGVjb2RlIHZhbGlkIEpTT04gb24gc3RkaW4uICBVbmFibGUgdG8gZmlndXJlIG91dCB3aGF0IHBhcmFtZXRlcnMgd2VyZSBwYXNzZWQiLCAiZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCgogICAgaWYgUFkyOgogICAgICAgIHBhcmFtcyA9IGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzKHBhcmFtcykKCiAgICB0cnk6CiAgICAgICAgcmV0dXJuIHBhcmFtc1snQU5TSUJMRV9NT0RVTEVfQVJHUyddCiAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgIyBUaGlzIGhlbHBlciBkb2VzIG5vdCBoYXZlIGFjY2VzcyB0byBmYWlsX2pzb24gc28gd2UgaGF2ZSB0byBwcmludAogICAgICAgICMganNvbiBvdXRwdXQgb24gb3VyIG93bi4KICAgICAgICBwcmludCgnXG57Im1zZyI6ICJFcnJvcjogTW9kdWxlIHVuYWJsZSB0byBsb2NhdGUgQU5TSUJMRV9NT0RVTEVfQVJHUyBpbiBqc29uIGRhdGEgZnJvbSBzdGRpbi4gIFVuYWJsZSB0byBmaWd1cmUgb3V0IHdoYXQgcGFyYW1ldGVycyB3ZXJlIHBhc3NlZCIsICcKICAgICAgICAgICAgICAnImZhaWxlZCI6IHRydWV9JykKICAgICAgICBzeXMuZXhpdCgxKQoKZGVmIGVudl9mYWxsYmFjaygqYXJncywgKiprd2FyZ3MpOgogICAgJycnIExvYWQgdmFsdWUgZnJvbSBlbnZpcm9ubWVudCAnJycKICAgIGZvciBhcmcgaW4gYXJnczoKICAgICAgICBpZiBhcmcgaW4gb3MuZW52aXJvbjoKICAgICAgICAgICAgcmV0dXJuIG9zLmVudmlyb25bYXJnXQogICAgZWxzZToKICAgICAgICByYWlzZSBBbnNpYmxlRmFsbGJhY2tOb3RGb3VuZAoKZGVmIF9sZW5pZW50X2xvd2VyY2FzZShsc3QpOgogICAgIiIiTG93ZXJjYXNlIGVsZW1lbnRzIG9mIGEgbGlzdC4KCiAgICBJZiBhbiBlbGVtZW50IGlzIG5vdCBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIHVudG91Y2hlZC4KICAgICIiIgogICAgbG93ZXJlZCA9IFtdCiAgICBmb3IgdmFsdWUgaW4gbHN0OgogICAgICAgIHRyeToKICAgICAgICAgICAgbG93ZXJlZC5hcHBlbmQodmFsdWUubG93ZXIoKSkKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgIGxvd2VyZWQuYXBwZW5kKHZhbHVlKQogICAgcmV0dXJuIGxvd2VyZWQKCmRlZiBmb3JtYXRfYXR0cmlidXRlcyhhdHRyaWJ1dGVzKToKICAgIGF0dHJpYnV0ZV9saXN0ID0gW10KICAgIGZvciBhdHRyIGluIGF0dHJpYnV0ZXM6CiAgICAgICAgaWYgYXR0ciBpbiBGSUxFX0FUVFJJQlVURVM6CiAgICAgICAgICAgIGF0dHJpYnV0ZV9saXN0LmFwcGVuZChGSUxFX0FUVFJJQlVURVNbYXR0cl0pCiAgICByZXR1cm4gYXR0cmlidXRlX2xpc3QKCmRlZiBnZXRfZmxhZ3NfZnJvbV9hdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpOgogICAgZmxhZ3MgPSBbXQogICAgZm9yIGtleSxhdHRyIGluIEZJTEVfQVRUUklCVVRFUy5pdGVtcygpOgogICAgICAgIGlmIGF0dHIgaW4gYXR0cmlidXRlczoKICAgICAgICAgICAgZmxhZ3MuYXBwZW5kKGtleSkKICAgIHJldHVybiAnJy5qb2luKGZsYWdzKQoKY2xhc3MgQW5zaWJsZUZhbGxiYWNrTm90Rm91bmQoRXhjZXB0aW9uKToKICAgIHBhc3MKCgpjbGFzcyBBbnNpYmxlTW9kdWxlKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgYXJndW1lbnRfc3BlYywgYnlwYXNzX2NoZWNrcz1GYWxzZSwgbm9fbG9nPUZhbHNlLAogICAgICAgICAgICAgICAgIGNoZWNrX2ludmFsaWRfYXJndW1lbnRzPVRydWUsIG11dHVhbGx5X2V4Y2x1c2l2ZT1Ob25lLCByZXF1aXJlZF90b2dldGhlcj1Ob25lLAogICAgICAgICAgICAgICAgIHJlcXVpcmVkX29uZV9vZj1Ob25lLCBhZGRfZmlsZV9jb21tb25fYXJncz1GYWxzZSwgc3VwcG9ydHNfY2hlY2tfbW9kZT1GYWxzZSwKICAgICAgICAgICAgICAgICByZXF1aXJlZF9pZj1Ob25lKToKCiAgICAgICAgJycnCiAgICAgICAgY29tbW9uIGNvZGUgZm9yIHF1aWNrbHkgYnVpbGRpbmcgYW4gYW5zaWJsZSBtb2R1bGUgaW4gUHl0aG9uCiAgICAgICAgKGFsdGhvdWdoIHlvdSBjYW4gd3JpdGUgbW9kdWxlcyBpbiBhbnl0aGluZyB0aGF0IGNhbiByZXR1cm4gSlNPTikKICAgICAgICBzZWUgbGlicmFyeS8qIGZvciBleGFtcGxlcwogICAgICAgICcnJwoKICAgICAgICBzZWxmLl9uYW1lID0gb3MucGF0aC5iYXNlbmFtZShfX2ZpbGVfXykgI2luaXRpYWxpemUgbmFtZSB1bnRpbCB3ZSBjYW4gcGFyc2UgZnJvbSBvcHRpb25zCiAgICAgICAgc2VsZi5hcmd1bWVudF9zcGVjID0gYXJndW1lbnRfc3BlYwogICAgICAgIHNlbGYuc3VwcG9ydHNfY2hlY2tfbW9kZSA9IHN1cHBvcnRzX2NoZWNrX21vZGUKICAgICAgICBzZWxmLmNoZWNrX21vZGUgPSBGYWxzZQogICAgICAgIHNlbGYubm9fbG9nID0gbm9fbG9nCiAgICAgICAgc2VsZi5jbGVhbnVwX2ZpbGVzID0gW10KICAgICAgICBzZWxmLl9kZWJ1ZyA9IEZhbHNlCiAgICAgICAgc2VsZi5fZGlmZiA9IEZhbHNlCiAgICAgICAgc2VsZi5fc29ja2V0X3BhdGggPSBOb25lCiAgICAgICAgc2VsZi5fdmVyYm9zaXR5ID0gMAogICAgICAgICMgTWF5IGJlIHVzZWQgdG8gc2V0IG1vZGlmaWNhdGlvbnMgdG8gdGhlIGVudmlyb25tZW50IGZvciBhbnkKICAgICAgICAjIHJ1bl9jb21tYW5kIGludm9jYXRpb24KICAgICAgICBzZWxmLnJ1bl9jb21tYW5kX2Vudmlyb25fdXBkYXRlID0ge30KICAgICAgICBzZWxmLl93YXJuaW5ncyA9IFtdCiAgICAgICAgc2VsZi5fZGVwcmVjYXRpb25zID0gW10KCiAgICAgICAgc2VsZi5hbGlhc2VzID0ge30KICAgICAgICBzZWxmLl9sZWdhbF9pbnB1dHMgPSBbJ19hbnNpYmxlX2NoZWNrX21vZGUnLCAnX2Fuc2libGVfbm9fbG9nJywgJ19hbnNpYmxlX2RlYnVnJywgJ19hbnNpYmxlX2RpZmYnLCAnX2Fuc2libGVfdmVyYm9zaXR5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ19hbnNpYmxlX3NlbGludXhfc3BlY2lhbF9mcycsICdfYW5zaWJsZV9tb2R1bGVfbmFtZScsICdfYW5zaWJsZV92ZXJzaW9uJywgJ19hbnNpYmxlX3N5c2xvZ19mYWNpbGl0eScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdfYW5zaWJsZV9zb2NrZXQnXQoKICAgICAgICBpZiBhZGRfZmlsZV9jb21tb25fYXJnczoKICAgICAgICAgICAgZm9yIGssIHYgaW4gRklMRV9DT01NT05fQVJHVU1FTlRTLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBrIG5vdCBpbiBzZWxmLmFyZ3VtZW50X3NwZWM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5hcmd1bWVudF9zcGVjW2tdID0gdgoKICAgICAgICBzZWxmLl9sb2FkX3BhcmFtcygpCiAgICAgICAgc2VsZi5fc2V0X2ZhbGxiYWNrcygpCgogICAgICAgICMgYXBwZW5kIHRvIGxlZ2FsX2lucHV0cyBhbmQgdGhlbiBwb3NzaWJseSBjaGVjayBhZ2FpbnN0IHRoZW0KICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuYWxpYXNlcyA9IHNlbGYuX2hhbmRsZV9hbGlhc2VzKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICMgVXNlIGV4Y2VwdGlvbnMgaGVyZSBiZWNhdXNlIGl0IGlzbid0IHNhZmUgdG8gY2FsbCBmYWlsX2pzb24gdW50aWwgbm9fbG9nIGlzIHByb2Nlc3NlZAogICAgICAgICAgICBwcmludCgnXG57ImZhaWxlZCI6IHRydWUsICJtc2ciOiAiTW9kdWxlIGFsaWFzIGVycm9yOiAlcyJ9JyAlIHN0cihlKSkKICAgICAgICAgICAgc3lzLmV4aXQoMSkKCiAgICAgICAgIyBTYXZlIHBhcmFtZXRlciB2YWx1ZXMgdGhhdCBzaG91bGQgbmV2ZXIgYmUgbG9nZ2VkCiAgICAgICAgc2VsZi5ub19sb2dfdmFsdWVzID0gc2V0KCkKICAgICAgICAjIFVzZSB0aGUgYXJnc3BlYyB0byBkZXRlcm1pbmUgd2hpY2ggYXJncyBhcmUgbm9fbG9nCiAgICAgICAgZm9yIGFyZ19uYW1lLCBhcmdfb3B0cyBpbiBzZWxmLmFyZ3VtZW50X3NwZWMuaXRlbXMoKToKICAgICAgICAgICAgaWYgYXJnX29wdHMuZ2V0KCdub19sb2cnLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAjIEZpbmQgdGhlIHZhbHVlIGZvciB0aGUgbm9fbG9nJ2QgcGFyYW0KICAgICAgICAgICAgICAgIG5vX2xvZ19vYmplY3QgPSBzZWxmLnBhcmFtcy5nZXQoYXJnX25hbWUsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBub19sb2dfb2JqZWN0OgogICAgICAgICAgICAgICAgICAgIHNlbGYubm9fbG9nX3ZhbHVlcy51cGRhdGUocmV0dXJuX3ZhbHVlcyhub19sb2dfb2JqZWN0KSkKCiAgICAgICAgICAgIGlmIGFyZ19vcHRzLmdldCgncmVtb3ZlZF9pbl92ZXJzaW9uJykgaXMgbm90IE5vbmUgYW5kIGFyZ19uYW1lIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgc2VsZi5fZGVwcmVjYXRpb25zLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAgICAgJ21zZyc6ICJQYXJhbSAnJXMnIGlzIGRlcHJlY2F0ZWQuIFNlZSB0aGUgbW9kdWxlIGRvY3MgZm9yIG1vcmUgaW5mb3JtYXRpb24iICUgYXJnX25hbWUsCiAgICAgICAgICAgICAgICAgICAgJ3ZlcnNpb24nOiBhcmdfb3B0cy5nZXQoJ3JlbW92ZWRfaW5fdmVyc2lvbicpCiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAjIGNoZWNrIHRoZSBsb2NhbGUgYXMgc2V0IGJ5IHRoZSBjdXJyZW50IGVudmlyb25tZW50LCBhbmQgcmVzZXQgdG8KICAgICAgICAjIGEga25vd24gdmFsaWQgKExBTkc9QykgaWYgaXQncyBhbiBpbnZhbGlkL3VuYXZhaWxhYmxlIGxvY2FsZQogICAgICAgIHNlbGYuX2NoZWNrX2xvY2FsZSgpCgogICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50cyhjaGVja19pbnZhbGlkX2FyZ3VtZW50cykKCiAgICAgICAgIyBjaGVjayBleGNsdXNpdmUgZWFybHkKICAgICAgICBpZiBub3QgYnlwYXNzX2NoZWNrczoKICAgICAgICAgICAgc2VsZi5fY2hlY2tfbXV0dWFsbHlfZXhjbHVzaXZlKG11dHVhbGx5X2V4Y2x1c2l2ZSkKCiAgICAgICAgc2VsZi5fc2V0X2RlZmF1bHRzKHByZT1UcnVlKQoKICAgICAgICBzZWxmLl9DSEVDS19BUkdVTUVOVF9UWVBFU19ESVNQQVRDSEVSID0gewogICAgICAgICAgICAnc3RyJzogc2VsZi5fY2hlY2tfdHlwZV9zdHIsCiAgICAgICAgICAgICdsaXN0Jzogc2VsZi5fY2hlY2tfdHlwZV9saXN0LAogICAgICAgICAgICAnZGljdCc6IHNlbGYuX2NoZWNrX3R5cGVfZGljdCwKICAgICAgICAgICAgJ2Jvb2wnOiBzZWxmLl9jaGVja190eXBlX2Jvb2wsCiAgICAgICAgICAgICdpbnQnOiBzZWxmLl9jaGVja190eXBlX2ludCwKICAgICAgICAgICAgJ2Zsb2F0Jzogc2VsZi5fY2hlY2tfdHlwZV9mbG9hdCwKICAgICAgICAgICAgJ3BhdGgnOiBzZWxmLl9jaGVja190eXBlX3BhdGgsCiAgICAgICAgICAgICdyYXcnOiBzZWxmLl9jaGVja190eXBlX3JhdywKICAgICAgICAgICAgJ2pzb25hcmcnOiBzZWxmLl9jaGVja190eXBlX2pzb25hcmcsCiAgICAgICAgICAgICdqc29uJzogc2VsZi5fY2hlY2tfdHlwZV9qc29uYXJnLAogICAgICAgICAgICAnYnl0ZXMnOiBzZWxmLl9jaGVja190eXBlX2J5dGVzLAogICAgICAgICAgICAnYml0cyc6IHNlbGYuX2NoZWNrX3R5cGVfYml0cywKICAgICAgICB9CiAgICAgICAgaWYgbm90IGJ5cGFzc19jaGVja3M6CiAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX2FyZ3VtZW50cygpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50X3R5cGVzKCkKICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdmFsdWVzKCkKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfdG9nZXRoZXIocmVxdWlyZWRfdG9nZXRoZXIpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX29uZV9vZihyZXF1aXJlZF9vbmVfb2YpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX2lmKHJlcXVpcmVkX2lmKQoKICAgICAgICBzZWxmLl9zZXRfZGVmYXVsdHMocHJlPUZhbHNlKQoKICAgICAgICBpZiBub3Qgc2VsZi5ub19sb2c6CiAgICAgICAgICAgIHNlbGYuX2xvZ19pbnZvY2F0aW9uKCkKCiAgICAgICAgIyBmaW5hbGx5LCBtYWtlIHN1cmUgd2UncmUgaW4gYSBzYW5lIHdvcmtpbmcgZGlyCiAgICAgICAgc2VsZi5fc2V0X2N3ZCgpCgogICAgZGVmIHdhcm4oc2VsZiwgd2FybmluZyk6CgogICAgICAgIGlmIGlzaW5zdGFuY2Uod2FybmluZywgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgc2VsZi5fd2FybmluZ3MuYXBwZW5kKHdhcm5pbmcpCiAgICAgICAgICAgIHNlbGYubG9nKCdbV0FSTklOR10gJXMnICUgd2FybmluZykKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoIndhcm4gcmVxdWlyZXMgYSBzdHJpbmcgbm90IGEgJXMiICUgdHlwZSh3YXJuaW5nKSkKCiAgICBkZWYgZGVwcmVjYXRlKHNlbGYsIG1zZywgdmVyc2lvbj1Ob25lKToKICAgICAgICBpZiBpc2luc3RhbmNlKG1zZywgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgc2VsZi5fZGVwcmVjYXRpb25zLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAnbXNnJzogbXNnLAogICAgICAgICAgICAgICAgJ3ZlcnNpb24nOiB2ZXJzaW9uCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIHNlbGYubG9nKCdbREVQUkVDQVRJT04gV0FSTklOR10gJXMgJXMnICUgKG1zZywgdmVyc2lvbikpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJkZXByZWNhdGUgcmVxdWlyZXMgYSBzdHJpbmcgbm90IGEgJXMiICUgdHlwZShtc2cpKQoKICAgIGRlZiBsb2FkX2ZpbGVfY29tbW9uX2FyZ3VtZW50cyhzZWxmLCBwYXJhbXMpOgogICAgICAgICcnJwogICAgICAgIG1hbnkgbW9kdWxlcyBkZWFsIHdpdGggZmlsZXMsIHRoaXMgZW5jYXBzdWxhdGVzIGNvbW1vbgogICAgICAgIG9wdGlvbnMgdGhhdCB0aGUgZmlsZSBtb2R1bGUgYWNjZXB0cyBzdWNoIHRoYXQgaXQgaXMgZGlyZWN0bHkKICAgICAgICBhdmFpbGFibGUgdG8gYWxsIG1vZHVsZXMgYW5kIHRoZXkgY2FuIHNoYXJlIGNvZGUuCiAgICAgICAgJycnCgogICAgICAgIHBhdGggPSBwYXJhbXMuZ2V0KCdwYXRoJywgcGFyYW1zLmdldCgnZGVzdCcsIE5vbmUpKQogICAgICAgIGlmIHBhdGggaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMocGF0aCkpCgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgIyBpZiB0aGUgcGF0aCBpcyBhIHN5bWxpbmssIGFuZCB3ZSdyZSBmb2xsb3dpbmcgbGlua3MsIGdldAogICAgICAgICMgdGhlIHRhcmdldCBvZiB0aGUgbGluayBpbnN0ZWFkIGZvciB0ZXN0aW5nCiAgICAgICAgaWYgcGFyYW1zLmdldCgnZm9sbG93JywgRmFsc2UpIGFuZCBvcy5wYXRoLmlzbGluayhiX3BhdGgpOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLnJlYWxwYXRoKGJfcGF0aCkKICAgICAgICAgICAgcGF0aCA9IHRvX25hdGl2ZShiX3BhdGgpCgogICAgICAgIG1vZGUgICA9IHBhcmFtcy5nZXQoJ21vZGUnLCBOb25lKQogICAgICAgIG93bmVyICA9IHBhcmFtcy5nZXQoJ293bmVyJywgTm9uZSkKICAgICAgICBncm91cCAgPSBwYXJhbXMuZ2V0KCdncm91cCcsIE5vbmUpCgogICAgICAgICMgc2VsaW51eCByZWxhdGVkIG9wdGlvbnMKICAgICAgICBzZXVzZXIgICAgPSBwYXJhbXMuZ2V0KCdzZXVzZXInLCBOb25lKQogICAgICAgIHNlcm9sZSAgICA9IHBhcmFtcy5nZXQoJ3Nlcm9sZScsIE5vbmUpCiAgICAgICAgc2V0eXBlICAgID0gcGFyYW1zLmdldCgnc2V0eXBlJywgTm9uZSkKICAgICAgICBzZWxldmVsICAgPSBwYXJhbXMuZ2V0KCdzZWxldmVsJywgTm9uZSkKICAgICAgICBzZWNvbnRleHQgPSBbc2V1c2VyLCBzZXJvbGUsIHNldHlwZV0KCiAgICAgICAgaWYgc2VsZi5zZWxpbnV4X21sc19lbmFibGVkKCk6CiAgICAgICAgICAgIHNlY29udGV4dC5hcHBlbmQoc2VsZXZlbCkKCiAgICAgICAgZGVmYXVsdF9zZWNvbnRleHQgPSBzZWxmLnNlbGludXhfZGVmYXVsdF9jb250ZXh0KHBhdGgpCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKGRlZmF1bHRfc2Vjb250ZXh0KSk6CiAgICAgICAgICAgIGlmIGkgaXMgbm90IE5vbmUgYW5kIHNlY29udGV4dFtpXSA9PSAnX2RlZmF1bHQnOgogICAgICAgICAgICAgICAgc2Vjb250ZXh0W2ldID0gZGVmYXVsdF9zZWNvbnRleHRbaV0KCiAgICAgICAgYXR0cmlidXRlcyA9IHBhcmFtcy5nZXQoJ2F0dHJpYnV0ZXMnLCBOb25lKQogICAgICAgIHJldHVybiBkaWN0KAogICAgICAgICAgICBwYXRoPXBhdGgsIG1vZGU9bW9kZSwgb3duZXI9b3duZXIsIGdyb3VwPWdyb3VwLAogICAgICAgICAgICBzZXVzZXI9c2V1c2VyLCBzZXJvbGU9c2Vyb2xlLCBzZXR5cGU9c2V0eXBlLAogICAgICAgICAgICBzZWxldmVsPXNlbGV2ZWwsIHNlY29udGV4dD1zZWNvbnRleHQsIGF0dHJpYnV0ZXM9YXR0cmlidXRlcywKICAgICAgICApCgoKICAgICMgRGV0ZWN0IHdoZXRoZXIgdXNpbmcgc2VsaW51eCB0aGF0IGlzIE1MUy1hd2FyZS4KICAgICMgV2hpbGUgdGhpcyBtZWFucyB5b3UgY2FuIHNldCB0aGUgbGV2ZWwvcmFuZ2Ugd2l0aAogICAgIyBzZWxpbnV4LmxzZXRmaWxlY29uKCksIGl0IG1heSBvciBtYXkgbm90IG1lYW4gdGhhdCB5b3UKICAgICMgd2lsbCBnZXQgdGhlIHNlbGV2ZWwgYXMgcGFydCBvZiB0aGUgY29udGV4dCByZXR1cm5lZAogICAgIyBieSBzZWxpbnV4LmxnZXRmaWxlY29uKCkuCgogICAgZGVmIHNlbGludXhfbWxzX2VuYWJsZWQoc2VsZik6CiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgaWYgc2VsaW51eC5pc19zZWxpbnV4X21sc19lbmFibGVkKCkgPT0gMToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgc2VsaW51eF9lbmFibGVkKHNlbGYpOgogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVg6CiAgICAgICAgICAgIHNlZW5hYmxlZCA9IHNlbGYuZ2V0X2Jpbl9wYXRoKCdzZWxpbnV4ZW5hYmxlZCcpCiAgICAgICAgICAgIGlmIHNlZW5hYmxlZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIChyYyxvdXQsZXJyKSA9IHNlbGYucnVuX2NvbW1hbmQoc2VlbmFibGVkKQogICAgICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IkFib3J0aW5nLCB0YXJnZXQgdXNlcyBzZWxpbnV4IGJ1dCBweXRob24gYmluZGluZ3MgKGxpYnNlbGludXgtcHl0aG9uKSBhcmVuJ3QgaW5zdGFsbGVkISIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGlmIHNlbGludXguaXNfc2VsaW51eF9lbmFibGVkKCkgPT0gMToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAjIERldGVybWluZSB3aGV0aGVyIHdlIG5lZWQgYSBwbGFjZWhvbGRlciBmb3Igc2VsZXZlbC9tbHMKICAgIGRlZiBzZWxpbnV4X2luaXRpYWxfY29udGV4dChzZWxmKToKICAgICAgICBjb250ZXh0ID0gW05vbmUsIE5vbmUsIE5vbmVdCiAgICAgICAgaWYgc2VsZi5zZWxpbnV4X21sc19lbmFibGVkKCk6CiAgICAgICAgICAgIGNvbnRleHQuYXBwZW5kKE5vbmUpCiAgICAgICAgcmV0dXJuIGNvbnRleHQKCiAgICAjIElmIHNlbGludXggZmFpbHMgdG8gZmluZCBhIGRlZmF1bHQsIHJldHVybiBhbiBhcnJheSBvZiBOb25lCiAgICBkZWYgc2VsaW51eF9kZWZhdWx0X2NvbnRleHQoc2VsZiwgcGF0aCwgbW9kZT0wKToKICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2luaXRpYWxfY29udGV4dCgpCiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldCA9IHNlbGludXgubWF0Y2hwYXRoY29uKHRvX25hdGl2ZShwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKSwgbW9kZSkKICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICBpZiByZXRbMF0gPT0gLTE6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgIyBMaW1pdCBzcGxpdCB0byA0IGJlY2F1c2UgdGhlIHNlbGV2ZWwsIHRoZSBsYXN0IGluIHRoZSBsaXN0LAogICAgICAgICMgbWF5IGNvbnRhaW4gJzonIGNoYXJhY3RlcnMKICAgICAgICBjb250ZXh0ID0gcmV0WzFdLnNwbGl0KCc6JywgMykKICAgICAgICByZXR1cm4gY29udGV4dAoKICAgIGRlZiBzZWxpbnV4X2NvbnRleHQoc2VsZiwgcGF0aCk6CiAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9pbml0aWFsX2NvbnRleHQoKQogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVggb3Igbm90IHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXQgPSBzZWxpbnV4LmxnZXRmaWxlY29uX3Jhdyh0b19uYXRpdmUocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykpCiAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgaWYgZS5lcnJubyA9PSBlcnJuby5FTk9FTlQ6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0ncGF0aCAlcyBkb2VzIG5vdCBleGlzdCcgJSBwYXRoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2ZhaWxlZCB0byByZXRyaWV2ZSBzZWxpbnV4IGNvbnRleHQnKQogICAgICAgIGlmIHJldFswXSA9PSAtMToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICAjIExpbWl0IHNwbGl0IHRvIDQgYmVjYXVzZSB0aGUgc2VsZXZlbCwgdGhlIGxhc3QgaW4gdGhlIGxpc3QsCiAgICAgICAgIyBtYXkgY29udGFpbiAnOicgY2hhcmFjdGVycwogICAgICAgIGNvbnRleHQgPSByZXRbMV0uc3BsaXQoJzonLCAzKQogICAgICAgIHJldHVybiBjb250ZXh0CgogICAgZGVmIHVzZXJfYW5kX2dyb3VwKHNlbGYsIHBhdGgsIGV4cGFuZD1UcnVlKToKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgc3QgPSBvcy5sc3RhdChiX3BhdGgpCiAgICAgICAgdWlkID0gc3Quc3RfdWlkCiAgICAgICAgZ2lkID0gc3Quc3RfZ2lkCiAgICAgICAgcmV0dXJuICh1aWQsIGdpZCkKCiAgICBkZWYgZmluZF9tb3VudF9wb2ludChzZWxmLCBwYXRoKToKICAgICAgICBwYXRoX2lzX2J5dGVzID0gRmFsc2UKICAgICAgICBpZiBpc2luc3RhbmNlKHBhdGgsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgcGF0aF9pc19ieXRlcyA9IFRydWUKCiAgICAgICAgYl9wYXRoID0gb3MucGF0aC5yZWFscGF0aCh0b19ieXRlcyhvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKHBhdGgpKSwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykpCiAgICAgICAgd2hpbGUgbm90IG9zLnBhdGguaXNtb3VudChiX3BhdGgpOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmRpcm5hbWUoYl9wYXRoKQoKICAgICAgICBpZiBwYXRoX2lzX2J5dGVzOgogICAgICAgICAgICByZXR1cm4gYl9wYXRoCgogICAgICAgIHJldHVybiB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKCiAgICBkZWYgaXNfc3BlY2lhbF9zZWxpbnV4X3BhdGgoc2VsZiwgcGF0aCk6CiAgICAgICAgIiIiCiAgICAgICAgUmV0dXJucyBhIHR1cGxlIGNvbnRhaW5pbmcgKFRydWUsIHNlbGludXhfY29udGV4dCkgaWYgdGhlIGdpdmVuIHBhdGggaXMgb24gYQogICAgICAgIE5GUyBvciBvdGhlciAnc3BlY2lhbCcgZnMgIG1vdW50IHBvaW50LCBvdGhlcndpc2UgdGhlIHJldHVybiB3aWxsIGJlIChGYWxzZSwgTm9uZSkuCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmID0gb3BlbignL3Byb2MvbW91bnRzJywgJ3InKQogICAgICAgICAgICBtb3VudF9kYXRhID0gZi5yZWFkbGluZXMoKQogICAgICAgICAgICBmLmNsb3NlKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiAoRmFsc2UsIE5vbmUpCiAgICAgICAgcGF0aF9tb3VudF9wb2ludCA9IHNlbGYuZmluZF9tb3VudF9wb2ludChwYXRoKQogICAgICAgIGZvciBsaW5lIGluIG1vdW50X2RhdGE6CiAgICAgICAgICAgIChkZXZpY2UsIG1vdW50X3BvaW50LCBmc3R5cGUsIG9wdGlvbnMsIHJlc3QpID0gbGluZS5zcGxpdCgnICcsIDQpCgogICAgICAgICAgICBpZiBwYXRoX21vdW50X3BvaW50ID09IG1vdW50X3BvaW50OgogICAgICAgICAgICAgICAgZm9yIGZzIGluIHNlbGYuX3NlbGludXhfc3BlY2lhbF9mczoKICAgICAgICAgICAgICAgICAgICBpZiBmcyBpbiBmc3R5cGU6CiAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpYWxfY29udGV4dCA9IHNlbGYuc2VsaW51eF9jb250ZXh0KHBhdGhfbW91bnRfcG9pbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoVHJ1ZSwgc3BlY2lhbF9jb250ZXh0KQoKICAgICAgICByZXR1cm4gKEZhbHNlLCBOb25lKQoKICAgIGRlZiBzZXRfZGVmYXVsdF9zZWxpbnV4X2NvbnRleHQoc2VsZiwgcGF0aCwgY2hhbmdlZCk6CiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2RlZmF1bHRfY29udGV4dChwYXRoKQogICAgICAgIHJldHVybiBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudChwYXRoLCBjb250ZXh0LCBGYWxzZSkKCiAgICBkZWYgc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIGNvbnRleHQsIGNoYW5nZWQsIGRpZmY9Tm9uZSk6CgogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVggb3Igbm90IHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCiAgICAgICAgY3VyX2NvbnRleHQgPSBzZWxmLnNlbGludXhfY29udGV4dChwYXRoKQogICAgICAgIG5ld19jb250ZXh0ID0gbGlzdChjdXJfY29udGV4dCkKICAgICAgICAjIEl0ZXJhdGUgb3ZlciB0aGUgY3VycmVudCBjb250ZXh0IGluc3RlYWQgb2YgdGhlCiAgICAgICAgIyBhcmd1bWVudCBjb250ZXh0LCB3aGljaCBtYXkgaGF2ZSBzZWxldmVsLgoKICAgICAgICAoaXNfc3BlY2lhbF9zZSwgc3BfY29udGV4dCkgPSBzZWxmLmlzX3NwZWNpYWxfc2VsaW51eF9wYXRoKHBhdGgpCiAgICAgICAgaWYgaXNfc3BlY2lhbF9zZToKICAgICAgICAgICAgbmV3X2NvbnRleHQgPSBzcF9jb250ZXh0CiAgICAgICAgZWxzZToKICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKGN1cl9jb250ZXh0KSk6CiAgICAgICAgICAgICAgICBpZiBsZW4oY29udGV4dCkgPiBpOgogICAgICAgICAgICAgICAgICAgIGlmIGNvbnRleHRbaV0gaXMgbm90IE5vbmUgYW5kIGNvbnRleHRbaV0gIT0gY3VyX2NvbnRleHRbaV06CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld19jb250ZXh0W2ldID0gY29udGV4dFtpXQogICAgICAgICAgICAgICAgICAgIGVsaWYgY29udGV4dFtpXSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICBuZXdfY29udGV4dFtpXSA9IGN1cl9jb250ZXh0W2ldCgogICAgICAgIGlmIGN1cl9jb250ZXh0ICE9IG5ld19jb250ZXh0OgogICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ3NlY29udGV4dCddID0gY3VyX2NvbnRleHQKICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydzZWNvbnRleHQnXSA9IG5ld19jb250ZXh0CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIHJjID0gc2VsaW51eC5sc2V0ZmlsZWNvbih0b19uYXRpdmUocGF0aCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyKCc6Jy5qb2luKG5ld19jb250ZXh0KSkpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2ludmFsaWQgc2VsaW51eCBjb250ZXh0OiAlcycgJSBzdHIoZSksIG5ld19jb250ZXh0PW5ld19jb250ZXh0LCBjdXJfY29udGV4dD1jdXJfY29udGV4dCwgaW5wdXRfd2FzPWNvbnRleHQpCiAgICAgICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nc2V0IHNlbGludXggY29udGV4dCBmYWlsZWQnKQogICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9vd25lcl9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgb3duZXIsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBwYXRoID0gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBvd25lciBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAogICAgICAgIG9yaWdfdWlkLCBvcmlnX2dpZCA9IHNlbGYudXNlcl9hbmRfZ3JvdXAocGF0aCwgZXhwYW5kKQogICAgICAgIHRyeToKICAgICAgICAgICAgdWlkID0gaW50KG93bmVyKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB1aWQgPSBwd2QuZ2V0cHduYW0ob3duZXIpLnB3X3VpZAogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hvd24gZmFpbGVkOiBmYWlsZWQgdG8gbG9vayB1cCB1c2VyICVzJyAlIG93bmVyKQogICAgICAgIGlmIG9yaWdfdWlkICE9IHVpZDoKCiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnb3duZXInXSA9IG9yaWdfdWlkCiAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnb3duZXInXSA9IHVpZAoKICAgICAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MubGNob3duKGJfcGF0aCwgdWlkLCAtMSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hvd24gZmFpbGVkJykKICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfZ3JvdXBfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIGdyb3VwLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgcGF0aCA9IHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZ3JvdXAgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKICAgICAgICBvcmlnX3VpZCwgb3JpZ19naWQgPSBzZWxmLnVzZXJfYW5kX2dyb3VwKGJfcGF0aCwgZXhwYW5kKQogICAgICAgIHRyeToKICAgICAgICAgICAgZ2lkID0gaW50KGdyb3VwKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBnaWQgPSBncnAuZ2V0Z3JuYW0oZ3JvdXApLmdyX2dpZAogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hncnAgZmFpbGVkOiBmYWlsZWQgdG8gbG9vayB1cCBncm91cCAlcycgJSBncm91cCkKICAgICAgICBpZiBvcmlnX2dpZCAhPSBnaWQ6CgogICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ2dyb3VwJ10gPSBvcmlnX2dpZAogICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ2dyb3VwJ10gPSBnaWQKCiAgICAgICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLmxjaG93bihiX3BhdGgsIC0xLCBnaWQpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2NoZ3JwIGZhaWxlZCcpCiAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X21vZGVfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIG1vZGUsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBwYXRoID0gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBwYXRoX3N0YXQgPSBvcy5sc3RhdChiX3BhdGgpCgogICAgICAgIGlmIG1vZGUgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UobW9kZSwgaW50KToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbW9kZSA9IGludChtb2RlLCA4KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG1vZGUgPSBzZWxmLl9zeW1ib2xpY19tb2RlX3RvX29jdGFsKHBhdGhfc3RhdCwgbW9kZSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2c9Im1vZGUgbXVzdCBiZSBpbiBvY3RhbCBvciBzeW1ib2xpYyBmb3JtIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWxzPXN0cihlKSkKCiAgICAgICAgICAgICAgICBpZiBtb2RlICE9IHN0YXQuU19JTU9ERShtb2RlKToKICAgICAgICAgICAgICAgICAgICAjIHByZXZlbnQgbW9kZSBmcm9tIGhhdmluZyBleHRyYSBpbmZvIG9yYmVpbmcgaW52YWxpZCBsb25nIG51bWJlcgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSJJbnZhbGlkIG1vZGUgc3VwcGxpZWQsIG9ubHkgcGVybWlzc2lvbiBpbmZvIGlzIGFsbG93ZWQiLCBkZXRhaWxzPW1vZGUpCgogICAgICAgIHByZXZfbW9kZSA9IHN0YXQuU19JTU9ERShwYXRoX3N0YXQuc3RfbW9kZSkKCiAgICAgICAgaWYgcHJldl9tb2RlICE9IG1vZGU6CgogICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ21vZGUnXSA9ICcwJTAzbycgJSBwcmV2X21vZGUKICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydtb2RlJ10gPSAnMCUwM28nICUgbW9kZQoKICAgICAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgIyBGSVhNRTogY29tcGFyaXNvbiBhZ2FpbnN0IHN0cmluZyBhYm92ZSB3aWxsIGNhdXNlIHRoaXMgdG8gYmUgZXhlY3V0ZWQKICAgICAgICAgICAgIyBldmVyeSB0aW1lCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIob3MsICdsY2htb2QnKToKICAgICAgICAgICAgICAgICAgICBvcy5sY2htb2QoYl9wYXRoLCBtb2RlKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2xpbmsoYl9wYXRoKToKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2htb2QoYl9wYXRoLCBtb2RlKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQXR0ZW1wdCB0byBzZXQgdGhlIHBlcm1zIG9mIHRoZSBzeW1saW5rIGJ1dCBiZQogICAgICAgICAgICAgICAgICAgICAgICAjIGNhcmVmdWwgbm90IHRvIGNoYW5nZSB0aGUgcGVybXMgb2YgdGhlIHVuZGVybHlpbmcKICAgICAgICAgICAgICAgICAgICAgICAgIyBmaWxlIHdoaWxlIHRyeWluZwogICAgICAgICAgICAgICAgICAgICAgICB1bmRlcmx5aW5nX3N0YXQgPSBvcy5zdGF0KGJfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2htb2QoYl9wYXRoLCBtb2RlKQogICAgICAgICAgICAgICAgICAgICAgICBuZXdfdW5kZXJseWluZ19zdGF0ID0gb3Muc3RhdChiX3BhdGgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVuZGVybHlpbmdfc3RhdC5zdF9tb2RlICE9IG5ld191bmRlcmx5aW5nX3N0YXQuc3RfbW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNobW9kKGJfcGF0aCwgc3RhdC5TX0lNT0RFKHVuZGVybHlpbmdfc3RhdC5zdF9tb2RlKSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmlzbGluayhiX3BhdGgpIGFuZCBlLmVycm5vID09IGVycm5vLkVQRVJNOiAgIyBDYW4ndCBzZXQgbW9kZSBvbiBzeW1ib2xpYyBsaW5rcwogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIGVsaWYgZS5lcnJubyBpbiAoZXJybm8uRU5PRU5ULCBlcnJuby5FTE9PUCk6ICMgQ2FuJ3Qgc2V0IG1vZGUgb24gYnJva2VuIHN5bWJvbGljIGxpbmtzCiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByYWlzZSBlCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2htb2QgZmFpbGVkJywgZGV0YWlscz1zdHIoZSkpCgogICAgICAgICAgICBwYXRoX3N0YXQgPSBvcy5sc3RhdChiX3BhdGgpCiAgICAgICAgICAgIG5ld19tb2RlID0gc3RhdC5TX0lNT0RFKHBhdGhfc3RhdC5zdF9tb2RlKQoKICAgICAgICAgICAgaWYgbmV3X21vZGUgIT0gcHJldl9tb2RlOgogICAgICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgYXR0cmlidXRlcywgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CgogICAgICAgIGlmIGF0dHJpYnV0ZXMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHBhdGggPSB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQoKICAgICAgICBleGlzdGluZyA9IHNlbGYuZ2V0X2ZpbGVfYXR0cmlidXRlcyhiX3BhdGgpCgogICAgICAgIGlmIGV4aXN0aW5nLmdldCgnYXR0cl9mbGFncycsJycpICE9IGF0dHJpYnV0ZXM6CiAgICAgICAgICAgIGF0dHJjbWQgPSBzZWxmLmdldF9iaW5fcGF0aCgnY2hhdHRyJykKICAgICAgICAgICAgaWYgYXR0cmNtZDoKICAgICAgICAgICAgICAgIGF0dHJjbWQgPSBbYXR0cmNtZCwgJz0lcycgJSBhdHRyaWJ1dGVzLCBiX3BhdGhdCiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQoKICAgICAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnYXR0cmlidXRlcyddID0gZXhpc3RpbmcuZ2V0KCdhdHRyX2ZsYWdzJykKICAgICAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydhdHRyaWJ1dGVzJ10gPSBhdHRyaWJ1dGVzCgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYucnVuX2NvbW1hbmQoYXR0cmNtZCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmMgIT0gMCBvciBlcnI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIkVycm9yIHdoaWxlIHNldHRpbmcgYXR0cmlidXRlczogJXMiICUgKG91dCArIGVycikpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaGF0dHIgZmFpbGVkJywgZGV0YWlscz1zdHIoZSkpCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgZ2V0X2ZpbGVfYXR0cmlidXRlcyhzZWxmLCBwYXRoKToKICAgICAgICBvdXRwdXQgPSB7fQogICAgICAgIGF0dHJjbWQgPSBzZWxmLmdldF9iaW5fcGF0aCgnbHNhdHRyJywgRmFsc2UpCiAgICAgICAgaWYgYXR0cmNtZDoKICAgICAgICAgICAgYXR0cmNtZCA9IFthdHRyY21kLCAnLXZkJywgcGF0aF0KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5ydW5fY29tbWFuZChhdHRyY21kKQogICAgICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgICAgICByZXMgPSBvdXQuc3BsaXQoJyAnKVswOjJdCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0WydhdHRyX2ZsYWdzJ10gPSAgcmVzWzFdLnJlcGxhY2UoJy0nLCcnKS5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0Wyd2ZXJzaW9uJ10gPSByZXNbMF0uc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIG91dHB1dFsnYXR0cmlidXRlcyddID0gZm9ybWF0X2F0dHJpYnV0ZXMob3V0cHV0WydhdHRyX2ZsYWdzJ10pCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gb3V0cHV0CgoKICAgIGRlZiBfc3ltYm9saWNfbW9kZV90b19vY3RhbChzZWxmLCBwYXRoX3N0YXQsIHN5bWJvbGljX21vZGUpOgogICAgICAgIG5ld19tb2RlID0gc3RhdC5TX0lNT0RFKHBhdGhfc3RhdC5zdF9tb2RlKQoKICAgICAgICBtb2RlX3JlID0gcmUuY29tcGlsZShyJ14oP1A8dXNlcnM+W3Vnb2FdKykoP1A8b3BlcmF0b3I+Wy0rPV0pKD9QPHBlcm1zPltyd3hYc3QtXSp8W3Vnb10pJCcpCiAgICAgICAgZm9yIG1vZGUgaW4gc3ltYm9saWNfbW9kZS5zcGxpdCgnLCcpOgogICAgICAgICAgICBtYXRjaCA9IG1vZGVfcmUubWF0Y2gobW9kZSkKICAgICAgICAgICAgaWYgbWF0Y2g6CiAgICAgICAgICAgICAgICB1c2VycyA9IG1hdGNoLmdyb3VwKCd1c2VycycpCiAgICAgICAgICAgICAgICBvcGVyYXRvciA9IG1hdGNoLmdyb3VwKCdvcGVyYXRvcicpCiAgICAgICAgICAgICAgICBwZXJtcyA9IG1hdGNoLmdyb3VwKCdwZXJtcycpCgogICAgICAgICAgICAgICAgaWYgdXNlcnMgPT0gJ2EnOgogICAgICAgICAgICAgICAgICAgIHVzZXJzID0gJ3VnbycKCiAgICAgICAgICAgICAgICBmb3IgdXNlciBpbiB1c2VyczoKICAgICAgICAgICAgICAgICAgICBtb2RlX3RvX2FwcGx5ID0gc2VsZi5fZ2V0X29jdGFsX21vZGVfZnJvbV9zeW1ib2xpY19wZXJtcyhwYXRoX3N0YXQsIHVzZXIsIHBlcm1zKQogICAgICAgICAgICAgICAgICAgIG5ld19tb2RlID0gc2VsZi5fYXBwbHlfb3BlcmF0aW9uX3RvX21vZGUodXNlciwgb3BlcmF0b3IsIG1vZGVfdG9fYXBwbHksIG5ld19tb2RlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiYmFkIHN5bWJvbGljIHBlcm1pc3Npb24gZm9yIG1vZGU6ICVzIiAlIG1vZGUpCiAgICAgICAgcmV0dXJuIG5ld19tb2RlCgogICAgZGVmIF9hcHBseV9vcGVyYXRpb25fdG9fbW9kZShzZWxmLCB1c2VyLCBvcGVyYXRvciwgbW9kZV90b19hcHBseSwgY3VycmVudF9tb2RlKToKICAgICAgICBpZiBvcGVyYXRvciAgPT0gICc9JzoKICAgICAgICAgICAgaWYgdXNlciA9PSAndSc6CiAgICAgICAgICAgICAgICBtYXNrID0gc3RhdC5TX0lSV1hVIHwgc3RhdC5TX0lTVUlECiAgICAgICAgICAgIGVsaWYgdXNlciA9PSAnZyc6CiAgICAgICAgICAgICAgICBtYXNrID0gc3RhdC5TX0lSV1hHIHwgc3RhdC5TX0lTR0lECiAgICAgICAgICAgIGVsaWYgdXNlciA9PSAnbyc6CiAgICAgICAgICAgICAgICBtYXNrID0gc3RhdC5TX0lSV1hPIHwgc3RhdC5TX0lTVlRYCgogICAgICAgICAgICAjIG1hc2sgb3V0IHUsIGcsIG9yIG8gcGVybWlzc2lvbnMgZnJvbSBjdXJyZW50X21vZGUgYW5kIGFwcGx5IG5ldyBwZXJtaXNzaW9ucwogICAgICAgICAgICBpbnZlcnNlX21hc2sgPSBtYXNrIF4gUEVSTV9CSVRTCiAgICAgICAgICAgIG5ld19tb2RlID0gKGN1cnJlbnRfbW9kZSAmIGludmVyc2VfbWFzaykgfCBtb2RlX3RvX2FwcGx5CiAgICAgICAgZWxpZiBvcGVyYXRvciA9PSAnKyc6CiAgICAgICAgICAgIG5ld19tb2RlID0gY3VycmVudF9tb2RlIHwgbW9kZV90b19hcHBseQogICAgICAgIGVsaWYgb3BlcmF0b3IgPT0gJy0nOgogICAgICAgICAgICBuZXdfbW9kZSA9IGN1cnJlbnRfbW9kZSAtIChjdXJyZW50X21vZGUgJiBtb2RlX3RvX2FwcGx5KQogICAgICAgIHJldHVybiBuZXdfbW9kZQoKICAgIGRlZiBfZ2V0X29jdGFsX21vZGVfZnJvbV9zeW1ib2xpY19wZXJtcyhzZWxmLCBwYXRoX3N0YXQsIHVzZXIsIHBlcm1zKToKICAgICAgICBwcmV2X21vZGUgPSBzdGF0LlNfSU1PREUocGF0aF9zdGF0LnN0X21vZGUpCgogICAgICAgIGlzX2RpcmVjdG9yeSA9IHN0YXQuU19JU0RJUihwYXRoX3N0YXQuc3RfbW9kZSkKICAgICAgICBoYXNfeF9wZXJtaXNzaW9ucyA9IChwcmV2X21vZGUgJiBFWEVDX1BFUk1fQklUUykgPiAwCiAgICAgICAgYXBwbHlfWF9wZXJtaXNzaW9uID0gaXNfZGlyZWN0b3J5IG9yIGhhc194X3Blcm1pc3Npb25zCgogICAgICAgICMgUGVybWlzc2lvbiBiaXRzIGNvbnN0YW50cyBkb2N1bWVudGVkIGF0OgogICAgICAgICMgaHR0cDovL2RvY3MucHl0aG9uLm9yZy8yL2xpYnJhcnkvc3RhdC5odG1sI3N0YXQuU19JU1VJRAogICAgICAgIGlmIGFwcGx5X1hfcGVybWlzc2lvbjoKICAgICAgICAgICAgWF9wZXJtcyA9IHsKICAgICAgICAgICAgICAgICd1JzogeydYJzogc3RhdC5TX0lYVVNSfSwKICAgICAgICAgICAgICAgICdnJzogeydYJzogc3RhdC5TX0lYR1JQfSwKICAgICAgICAgICAgICAgICdvJzogeydYJzogc3RhdC5TX0lYT1RIfQogICAgICAgICAgICB9CiAgICAgICAgZWxzZToKICAgICAgICAgICAgWF9wZXJtcyA9IHsKICAgICAgICAgICAgICAgICd1JzogeydYJzogMH0sCiAgICAgICAgICAgICAgICAnZyc6IHsnWCc6IDB9LAogICAgICAgICAgICAgICAgJ28nOiB7J1gnOiAwfQogICAgICAgICAgICB9CgogICAgICAgIHVzZXJfcGVybXNfdG9fbW9kZXMgPSB7CiAgICAgICAgICAgICd1JzogewogICAgICAgICAgICAgICAgJ3InOiBzdGF0LlNfSVJVU1IsCiAgICAgICAgICAgICAgICAndyc6IHN0YXQuU19JV1VTUiwKICAgICAgICAgICAgICAgICd4Jzogc3RhdC5TX0lYVVNSLAogICAgICAgICAgICAgICAgJ3MnOiBzdGF0LlNfSVNVSUQsCiAgICAgICAgICAgICAgICAndCc6IDAsCiAgICAgICAgICAgICAgICAndSc6IHByZXZfbW9kZSAmIHN0YXQuU19JUldYVSwKICAgICAgICAgICAgICAgICdnJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYRykgPDwgMywKICAgICAgICAgICAgICAgICdvJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYTykgPDwgNiB9LAogICAgICAgICAgICAnZyc6IHsKICAgICAgICAgICAgICAgICdyJzogc3RhdC5TX0lSR1JQLAogICAgICAgICAgICAgICAgJ3cnOiBzdGF0LlNfSVdHUlAsCiAgICAgICAgICAgICAgICAneCc6IHN0YXQuU19JWEdSUCwKICAgICAgICAgICAgICAgICdzJzogc3RhdC5TX0lTR0lELAogICAgICAgICAgICAgICAgJ3QnOiAwLAogICAgICAgICAgICAgICAgJ3UnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hVKSA+PiAzLAogICAgICAgICAgICAgICAgJ2cnOiBwcmV2X21vZGUgJiBzdGF0LlNfSVJXWEcsCiAgICAgICAgICAgICAgICAnbyc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWE8pIDw8IDMgfSwKICAgICAgICAgICAgJ28nOiB7CiAgICAgICAgICAgICAgICAncic6IHN0YXQuU19JUk9USCwKICAgICAgICAgICAgICAgICd3Jzogc3RhdC5TX0lXT1RILAogICAgICAgICAgICAgICAgJ3gnOiBzdGF0LlNfSVhPVEgsCiAgICAgICAgICAgICAgICAncyc6IDAsCiAgICAgICAgICAgICAgICAndCc6IHN0YXQuU19JU1ZUWCwKICAgICAgICAgICAgICAgICd1JzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYVSkgPj4gNiwKICAgICAgICAgICAgICAgICdnJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYRykgPj4gMywKICAgICAgICAgICAgICAgICdvJzogcHJldl9tb2RlICYgc3RhdC5TX0lSV1hPIH0KICAgICAgICB9CgogICAgICAgICMgSW5zZXJ0IFhfcGVybXMgaW50byB1c2VyX3Blcm1zX3RvX21vZGVzCiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gWF9wZXJtcy5pdGVtcygpOgogICAgICAgICAgICB1c2VyX3Blcm1zX3RvX21vZGVzW2tleV0udXBkYXRlKHZhbHVlKQoKICAgICAgICBvcl9yZWR1Y2UgPSBsYW1iZGEgbW9kZSwgcGVybTogbW9kZSB8IHVzZXJfcGVybXNfdG9fbW9kZXNbdXNlcl1bcGVybV0KICAgICAgICByZXR1cm4gcmVkdWNlKG9yX3JlZHVjZSwgcGVybXMsIDApCgogICAgZGVmIHNldF9mc19hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChzZWxmLCBmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgICMgc2V0IG1vZGVzIG93bmVycyBhbmQgY29udGV4dCBhcyBuZWVkZWQKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ3NlY29udGV4dCddLCBjaGFuZ2VkLCBkaWZmCiAgICAgICAgKQogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9vd25lcl9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ293bmVyJ10sIGNoYW5nZWQsIGRpZmYsIGV4cGFuZAogICAgICAgICkKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfZ3JvdXBfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydncm91cCddLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQKICAgICAgICApCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X21vZGVfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydtb2RlJ10sIGNoYW5nZWQsIGRpZmYsIGV4cGFuZAogICAgICAgICkKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ2F0dHJpYnV0ZXMnXSwgY2hhbmdlZCwgZGlmZiwgZXhwYW5kCiAgICAgICAgKQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9kaXJlY3RvcnlfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoc2VsZiwgZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICByZXR1cm4gc2VsZi5zZXRfZnNfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQpCgogICAgZGVmIHNldF9maWxlX2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KHNlbGYsIGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgcmV0dXJuIHNlbGYuc2V0X2ZzX2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZiwgZXhwYW5kKQoKICAgIGRlZiBhZGRfcGF0aF9pbmZvKHNlbGYsIGt3YXJncyk6CiAgICAgICAgJycnCiAgICAgICAgZm9yIHJlc3VsdHMgdGhhdCBhcmUgZmlsZXMsIHN1cHBsZW1lbnQgdGhlIGluZm8gYWJvdXQgdGhlIGZpbGUKICAgICAgICBpbiB0aGUgcmV0dXJuIHBhdGggd2l0aCBzdGF0cyBhYm91dCB0aGUgZmlsZSBwYXRoLgogICAgICAgICcnJwoKICAgICAgICBwYXRoID0ga3dhcmdzLmdldCgncGF0aCcsIGt3YXJncy5nZXQoJ2Rlc3QnLCBOb25lKSkKICAgICAgICBpZiBwYXRoIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBrd2FyZ3MKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGJfcGF0aCk6CiAgICAgICAgICAgICh1aWQsIGdpZCkgPSBzZWxmLnVzZXJfYW5kX2dyb3VwKHBhdGgpCiAgICAgICAgICAgIGt3YXJnc1sndWlkJ10gPSB1aWQKICAgICAgICAgICAga3dhcmdzWydnaWQnXSA9IGdpZAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB1c2VyID0gcHdkLmdldHB3dWlkKHVpZClbMF0KICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgdXNlciA9IHN0cih1aWQpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGdyb3VwID0gZ3JwLmdldGdyZ2lkKGdpZClbMF0KICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgZ3JvdXAgPSBzdHIoZ2lkKQogICAgICAgICAgICBrd2FyZ3NbJ293bmVyJ10gPSB1c2VyCiAgICAgICAgICAgIGt3YXJnc1snZ3JvdXAnXSA9IGdyb3VwCiAgICAgICAgICAgIHN0ID0gb3MubHN0YXQoYl9wYXRoKQogICAgICAgICAgICBrd2FyZ3NbJ21vZGUnXSA9ICcwJTAzbycgJSBzdGF0LlNfSU1PREUoc3Rbc3RhdC5TVF9NT0RFXSkKICAgICAgICAgICAgIyBzZWNvbnRleHQgbm90IHlldCBzdXBwb3J0ZWQKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2xpbmsoYl9wYXRoKToKICAgICAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdsaW5rJwogICAgICAgICAgICBlbGlmIG9zLnBhdGguaXNkaXIoYl9wYXRoKToKICAgICAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdkaXJlY3RvcnknCiAgICAgICAgICAgIGVsaWYgb3Muc3RhdChiX3BhdGgpLnN0X25saW5rID4gMToKICAgICAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdoYXJkJwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2ZpbGUnCiAgICAgICAgICAgIGlmIEhBVkVfU0VMSU5VWCBhbmQgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgICAgIGt3YXJnc1snc2Vjb250ZXh0J10gPSAnOicuam9pbihzZWxmLnNlbGludXhfY29udGV4dChwYXRoKSkKICAgICAgICAgICAga3dhcmdzWydzaXplJ10gPSBzdFtzdGF0LlNUX1NJWkVdCiAgICAgICAgZWxzZToKICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2Fic2VudCcKICAgICAgICByZXR1cm4ga3dhcmdzCgogICAgZGVmIF9jaGVja19sb2NhbGUoc2VsZik6CiAgICAgICAgJycnCiAgICAgICAgVXNlcyB0aGUgbG9jYWxlIG1vZHVsZSB0byB0ZXN0IHRoZSBjdXJyZW50bHkgc2V0IGxvY2FsZQogICAgICAgIChwZXIgdGhlIExBTkcgYW5kIExDX0NUWVBFIGVudmlyb25tZW50IHNldHRpbmdzKQogICAgICAgICcnJwogICAgICAgIHRyeToKICAgICAgICAgICAgIyBzZXR0aW5nIHRoZSBsb2NhbGUgdG8gJycgdXNlcyB0aGUgZGVmYXVsdCBsb2NhbGUKICAgICAgICAgICAgIyBhcyBpdCB3b3VsZCBiZSByZXR1cm5lZCBieSBsb2NhbGUuZ2V0ZGVmYXVsdGxvY2FsZSgpCiAgICAgICAgICAgIGxvY2FsZS5zZXRsb2NhbGUobG9jYWxlLkxDX0FMTCwgJycpCiAgICAgICAgZXhjZXB0IGxvY2FsZS5FcnJvcjoKICAgICAgICAgICAgIyBmYWxsYmFjayB0byB0aGUgJ0MnIGxvY2FsZSwgd2hpY2ggbWF5IGNhdXNlIHVuaWNvZGUKICAgICAgICAgICAgIyBpc3N1ZXMgYnV0IGlzIHByZWZlcmFibGUgdG8gc2ltcGx5IGZhaWxpbmcgYmVjYXVzZQogICAgICAgICAgICAjIG9mIGFuIHVua25vd24gbG9jYWxlCiAgICAgICAgICAgIGxvY2FsZS5zZXRsb2NhbGUobG9jYWxlLkxDX0FMTCwgJ0MnKQogICAgICAgICAgICBvcy5lbnZpcm9uWydMQU5HJ10gPSAnQycKICAgICAgICAgICAgb3MuZW52aXJvblsnTENfQUxMJ10gPSAnQycKICAgICAgICAgICAgb3MuZW52aXJvblsnTENfTUVTU0FHRVMnXSA9ICdDJwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJBbiB1bmtub3duIGVycm9yIHdhcyBlbmNvdW50ZXJlZCB3aGlsZSBhdHRlbXB0aW5nIHRvIHZhbGlkYXRlIHRoZSBsb2NhbGU6ICVzIiAlIGUpCgogICAgZGVmIF9oYW5kbGVfYWxpYXNlcyhzZWxmLCBzcGVjPU5vbmUpOgogICAgICAgICMgdGhpcyB1c2VzIGV4Y2VwdGlvbnMgYXMgaXQgaGFwcGVucyBiZWZvcmUgd2UgY2FuIHNhZmVseSBjYWxsIGZhaWxfanNvbgogICAgICAgIGFsaWFzZXNfcmVzdWx0cyA9IHt9ICNhbGlhczpjYW5vbgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgc3BlYyA9IHNlbGYuYXJndW1lbnRfc3BlYwogICAgICAgIGZvciAoayx2KSBpbiBzcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIHNlbGYuX2xlZ2FsX2lucHV0cy5hcHBlbmQoaykKICAgICAgICAgICAgYWxpYXNlcyA9IHYuZ2V0KCdhbGlhc2VzJywgTm9uZSkKICAgICAgICAgICAgZGVmYXVsdCA9IHYuZ2V0KCdkZWZhdWx0JywgTm9uZSkKICAgICAgICAgICAgcmVxdWlyZWQgPSB2LmdldCgncmVxdWlyZWQnLCBGYWxzZSkKICAgICAgICAgICAgaWYgZGVmYXVsdCBpcyBub3QgTm9uZSBhbmQgcmVxdWlyZWQ6CiAgICAgICAgICAgICAgICAjIG5vdCBhbGlhcyBzcGVjaWZpYyBidXQgdGhpcyBpcyBhIGdvb2QgcGxhY2UgdG8gY2hlY2sgdGhpcwogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJpbnRlcm5hbCBlcnJvcjogcmVxdWlyZWQgYW5kIGRlZmF1bHQgYXJlIG11dHVhbGx5IGV4Y2x1c2l2ZSBmb3IgJXMiICUgaykKICAgICAgICAgICAgaWYgYWxpYXNlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoYWxpYXNlcywgU0VRVUVOQ0VUWVBFKSBvciBpc2luc3RhbmNlKGFsaWFzZXMsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oJ2ludGVybmFsIGVycm9yOiBhbGlhc2VzIG11c3QgYmUgYSBsaXN0IG9yIHR1cGxlJykKICAgICAgICAgICAgZm9yIGFsaWFzIGluIGFsaWFzZXM6CiAgICAgICAgICAgICAgICBzZWxmLl9sZWdhbF9pbnB1dHMuYXBwZW5kKGFsaWFzKQogICAgICAgICAgICAgICAgYWxpYXNlc19yZXN1bHRzW2FsaWFzXSA9IGsKICAgICAgICAgICAgICAgIGlmIGFsaWFzIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyYW1zW2tdID0gc2VsZi5wYXJhbXNbYWxpYXNdCgogICAgICAgIHJldHVybiBhbGlhc2VzX3Jlc3VsdHMKCiAgICBkZWYgX2NoZWNrX2FyZ3VtZW50cyhzZWxmLCBjaGVja19pbnZhbGlkX2FyZ3VtZW50cyk6CiAgICAgICAgc2VsZi5fc3lzbG9nX2ZhY2lsaXR5ID0gJ0xPR19VU0VSJwogICAgICAgIHVuc3VwcG9ydGVkX3BhcmFtZXRlcnMgPSBzZXQoKQogICAgICAgIGZvciAoayx2KSBpbiBsaXN0KHNlbGYucGFyYW1zLml0ZW1zKCkpOgoKICAgICAgICAgICAgaWYgayA9PSAnX2Fuc2libGVfY2hlY2tfbW9kZScgYW5kIHY6CiAgICAgICAgICAgICAgICBzZWxmLmNoZWNrX21vZGUgPSBUcnVlCgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX25vX2xvZyc6CiAgICAgICAgICAgICAgICBzZWxmLm5vX2xvZyA9IHNlbGYuYm9vbGVhbih2KQoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9kZWJ1Zyc6CiAgICAgICAgICAgICAgICBzZWxmLl9kZWJ1ZyA9IHNlbGYuYm9vbGVhbih2KQoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9kaWZmJzoKICAgICAgICAgICAgICAgIHNlbGYuX2RpZmYgPSBzZWxmLmJvb2xlYW4odikKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfdmVyYm9zaXR5JzoKICAgICAgICAgICAgICAgIHNlbGYuX3ZlcmJvc2l0eSA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfc2VsaW51eF9zcGVjaWFsX2ZzJzoKICAgICAgICAgICAgICAgIHNlbGYuX3NlbGludXhfc3BlY2lhbF9mcyA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfc3lzbG9nX2ZhY2lsaXR5JzoKICAgICAgICAgICAgICAgIHNlbGYuX3N5c2xvZ19mYWNpbGl0eSA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfdmVyc2lvbic6CiAgICAgICAgICAgICAgICBzZWxmLmFuc2libGVfdmVyc2lvbiA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfbW9kdWxlX25hbWUnOgogICAgICAgICAgICAgICAgc2VsZi5fbmFtZSA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfc29ja2V0JzoKICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldF9wYXRoID0gdgoKICAgICAgICAgICAgZWxpZiBjaGVja19pbnZhbGlkX2FyZ3VtZW50cyBhbmQgayBub3QgaW4gc2VsZi5fbGVnYWxfaW5wdXRzOgogICAgICAgICAgICAgICAgdW5zdXBwb3J0ZWRfcGFyYW1ldGVycy5hZGQoaykKCiAgICAgICAgICAgICNjbGVhbiB1cCBpbnRlcm5hbCBwYXJhbXM6CiAgICAgICAgICAgIGlmIGsuc3RhcnRzd2l0aCgnX2Fuc2libGVfJyk6CiAgICAgICAgICAgICAgICBkZWwgc2VsZi5wYXJhbXNba10KCiAgICAgICAgaWYgdW5zdXBwb3J0ZWRfcGFyYW1ldGVyczoKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJVbnN1cHBvcnRlZCBwYXJhbWV0ZXJzIGZvciAoJXMpIG1vZHVsZTogJXMuIFN1cHBvcnRlZCBwYXJhbWV0ZXJzIGluY2x1ZGU6ICVzIiAlIChzZWxmLl9uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcsJy5qb2luKHNvcnRlZChsaXN0KHVuc3VwcG9ydGVkX3BhcmFtZXRlcnMpKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJywnLmpvaW4oc29ydGVkKHNlbGYuYXJndW1lbnRfc3BlYy5rZXlzKCkpKSkpCiAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlIGFuZCBub3Qgc2VsZi5zdXBwb3J0c19jaGVja19tb2RlOgogICAgICAgICAgICBzZWxmLmV4aXRfanNvbihza2lwcGVkPVRydWUsIG1zZz0icmVtb3RlIG1vZHVsZSAoJXMpIGRvZXMgbm90IHN1cHBvcnQgY2hlY2sgbW9kZSIgJSBzZWxmLl9uYW1lKQoKICAgIGRlZiBfY291bnRfdGVybXMoc2VsZiwgY2hlY2spOgogICAgICAgIGNvdW50ID0gMAogICAgICAgIGZvciB0ZXJtIGluIGNoZWNrOgogICAgICAgICAgICBpZiB0ZXJtIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgY291bnQgKz0gMQogICAgICAgIHJldHVybiBjb3VudAoKICAgIGRlZiBfY2hlY2tfbXV0dWFsbHlfZXhjbHVzaXZlKHNlbGYsIHNwZWMpOgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZm9yIGNoZWNrIGluIHNwZWM6CiAgICAgICAgICAgIGNvdW50ID0gc2VsZi5fY291bnRfdGVybXMoY2hlY2spCiAgICAgICAgICAgIGlmIGNvdW50ID4gMToKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0icGFyYW1ldGVycyBhcmUgbXV0dWFsbHkgZXhjbHVzaXZlOiAlcyIgJSAoY2hlY2ssKSkKCiAgICBkZWYgX2NoZWNrX3JlcXVpcmVkX29uZV9vZihzZWxmLCBzcGVjKToKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciBjaGVjayBpbiBzcGVjOgogICAgICAgICAgICBjb3VudCA9IHNlbGYuX2NvdW50X3Rlcm1zKGNoZWNrKQogICAgICAgICAgICBpZiBjb3VudCA9PSAwOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJvbmUgb2YgdGhlIGZvbGxvd2luZyBpcyByZXF1aXJlZDogJXMiICUgJywnLmpvaW4oY2hlY2spKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfdG9nZXRoZXIoc2VsZiwgc3BlYyk6CiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3IgY2hlY2sgaW4gc3BlYzoKICAgICAgICAgICAgY291bnRzID0gWyBzZWxmLl9jb3VudF90ZXJtcyhbZmllbGRdKSBmb3IgZmllbGQgaW4gY2hlY2sgXQogICAgICAgICAgICBub25femVybyA9IFsgYyBmb3IgYyBpbiBjb3VudHMgaWYgYyA+IDAgXQogICAgICAgICAgICBpZiBsZW4obm9uX3plcm8pID4gMDoKICAgICAgICAgICAgICAgIGlmIDAgaW4gY291bnRzOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0icGFyYW1ldGVycyBhcmUgcmVxdWlyZWQgdG9nZXRoZXI6ICVzIiAlIChjaGVjaywpKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfYXJndW1lbnRzKHNlbGYsIHNwZWM9Tm9uZSwgcGFyYW09Tm9uZSApOgogICAgICAgICcnJyBlbnN1cmUgYWxsIHJlcXVpcmVkIGFyZ3VtZW50cyBhcmUgcHJlc2VudCAnJycKICAgICAgICBtaXNzaW5nID0gW10KICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHNwZWMgPSBzZWxmLmFyZ3VtZW50X3NwZWMKICAgICAgICBpZiBwYXJhbSBpcyBOb25lOgogICAgICAgICAgICBwYXJhbSA9IHNlbGYucGFyYW1zCiAgICAgICAgZm9yIChrLHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgcmVxdWlyZWQgPSB2LmdldCgncmVxdWlyZWQnLCBGYWxzZSkKICAgICAgICAgICAgaWYgcmVxdWlyZWQgYW5kIGsgbm90IGluIHBhcmFtOgogICAgICAgICAgICAgICAgbWlzc2luZy5hcHBlbmQoaykKICAgICAgICBpZiBsZW4obWlzc2luZykgPiAwOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9Im1pc3NpbmcgcmVxdWlyZWQgYXJndW1lbnRzOiAlcyIgJSAiLCIuam9pbihtaXNzaW5nKSkKCiAgICBkZWYgX2NoZWNrX3JlcXVpcmVkX2lmKHNlbGYsIHNwZWMpOgogICAgICAgICcnJyBlbnN1cmUgdGhhdCBwYXJhbWV0ZXJzIHdoaWNoIGNvbmRpdGlvbmFsbHkgcmVxdWlyZWQgYXJlIHByZXNlbnQgJycnCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3Igc3AgaW4gc3BlYzoKICAgICAgICAgICAgbWlzc2luZyA9IFtdCiAgICAgICAgICAgIG1heF9taXNzaW5nX2NvdW50ID0gMAogICAgICAgICAgICBpc19vbmVfb2YgPSBGYWxzZQogICAgICAgICAgICBpZiBsZW4oc3ApID09IDQ6CiAgICAgICAgICAgICAgICBrZXksIHZhbCwgcmVxdWlyZW1lbnRzLCBpc19vbmVfb2YgPSBzcAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAga2V5LCB2YWwsIHJlcXVpcmVtZW50cyA9IHNwCgogICAgICAgICAgICAjIGlzX29uZV9vZiBpcyBUcnVlIGF0IGxlYXN0IG9uZSByZXF1aXJlbWVudCBzaG91bGQgYmUKICAgICAgICAgICAgIyBwcmVzZW50LCBlbHNlIGFsbCByZXF1aXJlbWVudHMgc2hvdWxkIGJlIHByZXNlbnQuCiAgICAgICAgICAgIGlmIGlzX29uZV9vZjoKICAgICAgICAgICAgICAgIG1heF9taXNzaW5nX2NvdW50ID0gbGVuKHJlcXVpcmVtZW50cykKCiAgICAgICAgICAgIGlmIGtleSBpbiBzZWxmLnBhcmFtcyBhbmQgc2VsZi5wYXJhbXNba2V5XSA9PSB2YWw6CiAgICAgICAgICAgICAgICBmb3IgY2hlY2sgaW4gcmVxdWlyZW1lbnRzOgogICAgICAgICAgICAgICAgICAgIGNvdW50ID0gc2VsZi5fY291bnRfdGVybXMoKGNoZWNrLCkpCiAgICAgICAgICAgICAgICAgICAgaWYgY291bnQgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgbWlzc2luZy5hcHBlbmQoY2hlY2spCiAgICAgICAgICAgIGlmIGxlbihtaXNzaW5nKSBhbmQgbGVuKG1pc3NpbmcpID49IG1heF9taXNzaW5nX2NvdW50OgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSIlcyBpcyAlcyBidXQgdGhlIGZvbGxvd2luZyBhcmUgbWlzc2luZzogJXMiICUgKGtleSwgdmFsLCAnLCcuam9pbihtaXNzaW5nKSkpCgogICAgZGVmIF9jaGVja19hcmd1bWVudF92YWx1ZXMoc2VsZiwgc3BlYz1Ob25lLCBwYXJhbT1Ob25lKToKICAgICAgICAnJycgZW5zdXJlIGFsbCBhcmd1bWVudHMgaGF2ZSB0aGUgcmVxdWVzdGVkIHZhbHVlcywgYW5kIHRoZXJlIGFyZSBubyBzdHJheSBhcmd1bWVudHMgJycnCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICBzcGVjID0gc2VsZi5hcmd1bWVudF9zcGVjCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToKICAgICAgICAgICAgcGFyYW0gPSBzZWxmLnBhcmFtcwogICAgICAgIGZvciAoayx2KSBpbiBzcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIGNob2ljZXMgPSB2LmdldCgnY2hvaWNlcycsTm9uZSkKICAgICAgICAgICAgaWYgY2hvaWNlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShjaG9pY2VzLCBTRVFVRU5DRVRZUEUpIGFuZCBub3QgaXNpbnN0YW5jZShjaG9pY2VzLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpOgogICAgICAgICAgICAgICAgaWYgayBpbiBwYXJhbToKICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSBub3QgaW4gY2hvaWNlczoKICAgICAgICAgICAgICAgICAgICAgICAgIyBQeVlhbWwgY29udmVydHMgY2VydGFpbiBzdHJpbmdzIHRvIGJvb2xzLiAgSWYgd2UgY2FuIHVuYW1iaWd1b3VzbHkgY29udmVydCBiYWNrLCBkbyBzbyBiZWZvcmUgY2hlY2tpbmcKICAgICAgICAgICAgICAgICAgICAgICAgIyB0aGUgdmFsdWUuICBJZiB3ZSBjYW4ndCBmaWd1cmUgdGhpcyBvdXQsIG1vZHVsZSBhdXRob3IgaXMgcmVzcG9uc2libGUuCiAgICAgICAgICAgICAgICAgICAgICAgIGxvd2VyZWRfY2hvaWNlcyA9IE5vbmUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gPT0gJ0ZhbHNlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvd2VyZWRfY2hvaWNlcyA9IF9sZW5pZW50X2xvd2VyY2FzZShjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgRkFMU0VZID0gZnJvemVuc2V0KEJPT0xFQU5TX0ZBTFNFKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmxhcCA9IEZBTFNFWS5pbnRlcnNlY3Rpb24oY2hvaWNlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihvdmVybGFwKSA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgRXh0cmFjdCBmcm9tIGEgc2V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHBhcmFtW2tdLCkgPSBvdmVybGFwCgogICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSA9PSAnVHJ1ZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsb3dlcmVkX2Nob2ljZXMgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb3dlcmVkX2Nob2ljZXMgPSBfbGVuaWVudF9sb3dlcmNhc2UoY2hvaWNlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRSVVRIWSA9IGZyb3plbnNldChCT09MRUFOU19UUlVFKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmxhcCA9IFRSVVRIWS5pbnRlcnNlY3Rpb24oY2hvaWNlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihvdmVybGFwKSA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChwYXJhbVtrXSwpID0gb3ZlcmxhcAoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gbm90IGluIGNob2ljZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2VzX3N0cj0iLCIuam9pbihbdG9fbmF0aXZlKGMpIGZvciBjIGluIGNob2ljZXNdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnPSJ2YWx1ZSBvZiAlcyBtdXN0IGJlIG9uZSBvZjogJXMsIGdvdDogJXMiICUgKGssIGNob2ljZXNfc3RyLCBwYXJhbVtrXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz1tc2cpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImludGVybmFsIGVycm9yOiBjaG9pY2VzIGZvciBhcmd1bWVudCAlcyBhcmUgbm90IGl0ZXJhYmxlOiAlcyIgJSAoaywgY2hvaWNlcykpCgogICAgZGVmIHNhZmVfZXZhbChzZWxmLCB2YWx1ZSwgbG9jYWxzPU5vbmUsIGluY2x1ZGVfZXhjZXB0aW9ucz1GYWxzZSk6CgogICAgICAgICMgZG8gbm90IGFsbG93IG1ldGhvZCBjYWxscyB0byBtb2R1bGVzCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgICMgYWxyZWFkeSB0ZW1wbGF0ZWQgdG8gYSBkYXRhdmFsdWVzdHJ1Y3R1cmUsIHBlcmhhcHM/CiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAodmFsdWUsIE5vbmUpCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIGlmIHJlLnNlYXJjaChyJ1x3XC5cdytcKCcsIHZhbHVlKToKICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgTm9uZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgIyBkbyBub3QgYWxsb3cgaW1wb3J0cwogICAgICAgIGlmIHJlLnNlYXJjaChyJ2ltcG9ydCBcdysnLCB2YWx1ZSk6CiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAodmFsdWUsIE5vbmUpCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzdWx0ID0gbGl0ZXJhbF9ldmFsKHZhbHVlKQogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHJlc3VsdCwgTm9uZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAodmFsdWUsIGUpCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgIGRlZiBfY2hlY2tfdHlwZV9zdHIoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgICMgTm90ZTogVGhpcyBjb3VsZCB0aHJvdyBhIHVuaWNvZGUgZXJyb3IgaWYgdmFsdWUncyBfX3N0cl9fKCkgbWV0aG9kCiAgICAgICAgIyByZXR1cm5zIG5vbi1hc2NpaS4gIEhhdmUgdG8gcG9ydCB1dGlscy50b19ieXRlcygpIGlmIHRoYXQgaGFwcGVucwogICAgICAgIHJldHVybiBzdHIodmFsdWUpCgogICAgZGVmIF9jaGVja190eXBlX2xpc3Qoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGxpc3QpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnNwbGl0KCIsIikKICAgICAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIGludCkgb3IgaXNpbnN0YW5jZSh2YWx1ZSwgZmxvYXQpOgogICAgICAgICAgICByZXR1cm4gWyBzdHIodmFsdWUpIF0KCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgbGlzdCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfZGljdChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgZGljdCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBpZiB2YWx1ZS5zdGFydHN3aXRoKCJ7Iik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHModmFsdWUpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgKHJlc3VsdCwgZXhjKSA9IHNlbGYuc2FmZV9ldmFsKHZhbHVlLCBkaWN0KCksIGluY2x1ZGVfZXhjZXB0aW9ucz1UcnVlKQogICAgICAgICAgICAgICAgICAgIGlmIGV4YyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCd1bmFibGUgdG8gZXZhbHVhdGUgc3RyaW5nIGFzIGRpY3Rpb25hcnknKQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICAgICAgZWxpZiAnPScgaW4gdmFsdWU6CiAgICAgICAgICAgICAgICBmaWVsZHMgPSBbXQogICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyID0gW10KICAgICAgICAgICAgICAgIGluX3F1b3RlID0gRmFsc2UKICAgICAgICAgICAgICAgIGluX2VzY2FwZSA9IEZhbHNlCiAgICAgICAgICAgICAgICBmb3IgYyBpbiB2YWx1ZS5zdHJpcCgpOgogICAgICAgICAgICAgICAgICAgIGlmIGluX2VzY2FwZToKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyLmFwcGVuZChjKQogICAgICAgICAgICAgICAgICAgICAgICBpbl9lc2NhcGUgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsaWYgYyA9PSAnXFwnOgogICAgICAgICAgICAgICAgICAgICAgICBpbl9lc2NhcGUgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgZWxpZiBub3QgaW5fcXVvdGUgYW5kIGMgaW4gKCdcJycsICciJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGluX3F1b3RlID0gYwogICAgICAgICAgICAgICAgICAgIGVsaWYgaW5fcXVvdGUgYW5kIGluX3F1b3RlID09IGM6CiAgICAgICAgICAgICAgICAgICAgICAgIGluX3F1b3RlID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBpbl9xdW90ZSBhbmQgYyBpbiAoJywnLCAnICcpOgogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZCA9ICcnLmpvaW4oZmllbGRfYnVmZmVyKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBmaWVsZDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkcy5hcHBlbmQoZmllbGQpCiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkX2J1ZmZlciA9IFtdCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyLmFwcGVuZChjKQoKICAgICAgICAgICAgICAgIGZpZWxkID0gJycuam9pbihmaWVsZF9idWZmZXIpCiAgICAgICAgICAgICAgICBpZiBmaWVsZDoKICAgICAgICAgICAgICAgICAgICBmaWVsZHMuYXBwZW5kKGZpZWxkKQogICAgICAgICAgICAgICAgcmV0dXJuIGRpY3QoeC5zcGxpdCgiPSIsIDEpIGZvciB4IGluIGZpZWxkcykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiZGljdGlvbmFyeSByZXF1ZXN0ZWQsIGNvdWxkIG5vdCBwYXJzZSBKU09OIG9yIGtleT12YWx1ZSIpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGRpY3QnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2Jvb2woc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGJvb2wpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKSBvciBpc2luc3RhbmNlKHZhbHVlLCBpbnQpOgogICAgICAgICAgICByZXR1cm4gc2VsZi5ib29sZWFuKHZhbHVlKQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBib29sJyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9pbnQoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGludCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICByZXR1cm4gaW50KHZhbHVlKQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYW4gaW50JyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9mbG9hdChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgZmxvYXQpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUsIGludCkpOgogICAgICAgICAgICByZXR1cm4gZmxvYXQodmFsdWUpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGZsb2F0JyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9wYXRoKHNlbGYsIHZhbHVlKToKICAgICAgICB2YWx1ZSA9IHNlbGYuX2NoZWNrX3R5cGVfc3RyKHZhbHVlKQogICAgICAgIHJldHVybiBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfanNvbmFyZyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgIyBSZXR1cm4gYSBqc29uaWZpZWQgc3RyaW5nLiAgU29tZXRpbWVzIHRoZSBjb250cm9sbGVyIHR1cm5zIGEganNvbgogICAgICAgICMgc3RyaW5nIGludG8gYSBkaWN0L2xpc3Qgc28gdHJhbnNmb3JtIGl0IGJhY2sgaW50byBqc29uIGhlcmUKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUuc3RyaXAoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIChsaXN0LCB0dXBsZSwgZGljdCkpOgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24uZHVtcHModmFsdWUpCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEganNvbiBzdHJpbmcnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX3JhdyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgcmV0dXJuIHZhbHVlCgoKICAgIGRlZiBfY2hlY2tfdHlwZV9ieXRlcyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmh1bWFuX3RvX2J5dGVzKHZhbHVlKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBCeXRlIHZhbHVlJyAlIHR5cGUodmFsdWUpKQoKCiAgICBkZWYgX2NoZWNrX3R5cGVfYml0cyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmh1bWFuX3RvX2J5dGVzKHZhbHVlLCBpc2JpdHM9VHJ1ZSkKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgQml0IHZhbHVlJyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfYXJndW1lbnRfdHlwZXMoc2VsZiwgc3BlYz1Ob25lLCBwYXJhbT1Ob25lKToKICAgICAgICAnJycgZW5zdXJlIGFsbCBhcmd1bWVudHMgaGF2ZSB0aGUgcmVxdWVzdGVkIHR5cGUgJycnCgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgc3BlYyA9IHNlbGYuYXJndW1lbnRfc3BlYwogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAgICAgIHBhcmFtID0gc2VsZi5wYXJhbXMKCiAgICAgICAgZm9yIChrLCB2KSBpbiBzcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIHdhbnRlZCA9IHYuZ2V0KCd0eXBlJywgTm9uZSkKICAgICAgICAgICAgaWYgayBub3QgaW4gcGFyYW06CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiB3YW50ZWQgaXMgTm9uZToKICAgICAgICAgICAgICAgICMgTW9zdGx5IHdlIHdhbnQgdG8gZGVmYXVsdCB0byBzdHIuCiAgICAgICAgICAgICAgICAjIEZvciB2YWx1ZXMgc2V0IHRvIE5vbmUgZXhwbGljaXRseSwgcmV0dXJuIE5vbmUgaW5zdGVhZCBhcwogICAgICAgICAgICAgICAgIyB0aGF0IGFsbG93cyBhIHVzZXIgdG8gdW5zZXQgYSBwYXJhbWV0ZXIKICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHdhbnRlZCA9ICdzdHInCgogICAgICAgICAgICB2YWx1ZSA9IHBhcmFtW2tdCiAgICAgICAgICAgIGlmIHZhbHVlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdHlwZV9jaGVja2VyID0gc2VsZi5fQ0hFQ0tfQVJHVU1FTlRfVFlQRVNfRElTUEFUQ0hFUlt3YW50ZWRdCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iaW1wbGVtZW50YXRpb24gZXJyb3I6IHVua25vd24gdHlwZSAlcyByZXF1ZXN0ZWQgZm9yICVzIiAlICh3YW50ZWQsIGspKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwYXJhbVtrXSA9IHR5cGVfY2hlY2tlcih2YWx1ZSkKICAgICAgICAgICAgZXhjZXB0IChUeXBlRXJyb3IsIFZhbHVlRXJyb3IpOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJhcmd1bWVudCAlcyBpcyBvZiB0eXBlICVzIGFuZCB3ZSB3ZXJlIHVuYWJsZSB0byBjb252ZXJ0IHRvICVzOiAlcyIgJSAoaywgdHlwZSh2YWx1ZSksIHdhbnRlZCwgZSkpCgogICAgICAgICAgICAjIGRlYWwgd2l0aCBzdWIgb3B0aW9ucyB0byBjcmVhdGUgc3ViIHNwZWMKICAgICAgICAgICAgc3BlYyA9IE5vbmUKICAgICAgICAgICAgaWYgd2FudGVkID09ICdkaWN0JyBvciAod2FudGVkID09ICdsaXN0JyBhbmQgdi5nZXQoJ2VsZW1lbnRzJywgJycpID09ICdkaWN0Jyk6CiAgICAgICAgICAgICAgICBzcGVjID0gdi5nZXQoJ29wdGlvbnMnLCBOb25lKQogICAgICAgICAgICAgICAgaWYgc3BlYzoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF9hcmd1bWVudHMoc3BlYywgcGFyYW1ba10pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdHlwZXMoc3BlYywgcGFyYW1ba10pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdmFsdWVzKHNwZWMsIHBhcmFtW2tdKQoKICAgIGRlZiBfc2V0X2RlZmF1bHRzKHNlbGYsIHByZT1UcnVlKToKICAgICAgICBmb3IgKGssdikgaW4gc2VsZi5hcmd1bWVudF9zcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIGRlZmF1bHQgPSB2LmdldCgnZGVmYXVsdCcsIE5vbmUpCiAgICAgICAgICAgIGlmIHByZSBpcyBUcnVlOgogICAgICAgICAgICAgICAgIyB0aGlzIHByZXZlbnRzIHNldHRpbmcgZGVmYXVsdHMgb24gcmVxdWlyZWQgaXRlbXMKICAgICAgICAgICAgICAgIGlmIGRlZmF1bHQgaXMgbm90IE5vbmUgYW5kIGsgbm90IGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyYW1zW2tdID0gZGVmYXVsdAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBtYWtlIHN1cmUgdGhpbmdzIHdpdGhvdXQgYSBkZWZhdWx0IHN0aWxsIGdldCBzZXQgTm9uZQogICAgICAgICAgICAgICAgaWYgayBub3QgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBkZWZhdWx0CgogICAgZGVmIF9zZXRfZmFsbGJhY2tzKHNlbGYpOgogICAgICAgIGZvciBrLHYgaW4gc2VsZi5hcmd1bWVudF9zcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIGZhbGxiYWNrID0gdi5nZXQoJ2ZhbGxiYWNrJywgKE5vbmUsKSkKICAgICAgICAgICAgZmFsbGJhY2tfc3RyYXRlZ3kgPSBmYWxsYmFja1swXQogICAgICAgICAgICBmYWxsYmFja19hcmdzID0gW10KICAgICAgICAgICAgZmFsbGJhY2tfa3dhcmdzID0ge30KICAgICAgICAgICAgaWYgayBub3QgaW4gc2VsZi5wYXJhbXMgYW5kIGZhbGxiYWNrX3N0cmF0ZWd5IGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgZm9yIGl0ZW0gaW4gZmFsbGJhY2tbMTpdOgogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoaXRlbSwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrX2t3YXJncyA9IGl0ZW0KICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBmYWxsYmFja19hcmdzID0gaXRlbQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyYW1zW2tdID0gZmFsbGJhY2tfc3RyYXRlZ3koKmZhbGxiYWNrX2FyZ3MsICoqZmFsbGJhY2tfa3dhcmdzKQogICAgICAgICAgICAgICAgZXhjZXB0IEFuc2libGVGYWxsYmFja05vdEZvdW5kOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgZGVmIF9sb2FkX3BhcmFtcyhzZWxmKToKICAgICAgICAnJycgcmVhZCB0aGUgaW5wdXQgYW5kIHNldCB0aGUgcGFyYW1zIGF0dHJpYnV0ZS4KCiAgICAgICAgVGhpcyBtZXRob2QgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LiAgVGhlIGd1dHMgb2YgdGhlIGZ1bmN0aW9uCiAgICAgICAgd2VyZSBtb3ZlZCBvdXQgaW4gMi4xIHNvIHRoYXQgY3VzdG9tIG1vZHVsZXMgY291bGQgcmVhZCB0aGUgcGFyYW1ldGVycy4KICAgICAgICAnJycKICAgICAgICAjIGRlYnVnIG92ZXJyaWRlcyB0byByZWFkIGFyZ3MgZnJvbSBmaWxlIG9yIGNtZGxpbmUKICAgICAgICBzZWxmLnBhcmFtcyA9IF9sb2FkX3BhcmFtcygpCgogICAgZGVmIF9sb2dfdG9fc3lzbG9nKHNlbGYsIG1zZyk6CiAgICAgICAgaWYgSEFTX1NZU0xPRzoKICAgICAgICAgICAgbW9kdWxlID0gJ2Fuc2libGUtJXMnICUgc2VsZi5fbmFtZQogICAgICAgICAgICBmYWNpbGl0eSA9IGdldGF0dHIoc3lzbG9nLCBzZWxmLl9zeXNsb2dfZmFjaWxpdHksIHN5c2xvZy5MT0dfVVNFUikKICAgICAgICAgICAgc3lzbG9nLm9wZW5sb2coc3RyKG1vZHVsZSksIDAsIGZhY2lsaXR5KQogICAgICAgICAgICBzeXNsb2cuc3lzbG9nKHN5c2xvZy5MT0dfSU5GTywgbXNnKQoKICAgIGRlZiBkZWJ1ZyhzZWxmLCBtc2cpOgogICAgICAgIGlmIHNlbGYuX2RlYnVnOgogICAgICAgICAgICBzZWxmLmxvZygnW2RlYnVnXSAlcycgJSBtc2cpCgogICAgZGVmIGxvZyhzZWxmLCBtc2csIGxvZ19hcmdzPU5vbmUpOgoKICAgICAgICBpZiBub3Qgc2VsZi5ub19sb2c6CgogICAgICAgICAgICBpZiBsb2dfYXJncyBpcyBOb25lOgogICAgICAgICAgICAgICAgbG9nX2FyZ3MgPSBkaWN0KCkKCiAgICAgICAgICAgIG1vZHVsZSA9ICdhbnNpYmxlLSVzJyAlIHNlbGYuX25hbWUKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShtb2R1bGUsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgICAgIG1vZHVsZSA9IG1vZHVsZS5kZWNvZGUoJ3V0Zi04JywgJ3JlcGxhY2UnKQoKICAgICAgICAgICAgIyA2NjU1IC0gYWxsb3cgZm9yIGFjY2VudGVkIGNoYXJhY3RlcnMKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UobXNnLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJtc2cgc2hvdWxkIGJlIGEgc3RyaW5nIChnb3QgJXMpIiAlIHR5cGUobXNnKSkKCiAgICAgICAgICAgICMgV2Ugd2FudCBqb3VybmFsIHRvIGFsd2F5cyB0YWtlIHRleHQgdHlwZQogICAgICAgICAgICAjIHN5c2xvZyB0YWtlcyBieXRlcyBvbiBweTIsIHRleHQgdHlwZSBvbiBweTMKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShtc2csIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgICAgIGpvdXJuYWxfbXNnID0gcmVtb3ZlX3ZhbHVlcyhtc2cuZGVjb2RlKCd1dGYtOCcsICdyZXBsYWNlJyksIHNlbGYubm9fbG9nX3ZhbHVlcykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVE9ETzogc3Vycm9nYXRlZXNjYXBlIGlzIGEgZGFuZ2VyIGhlcmUgb24gUHkzCiAgICAgICAgICAgICAgICBqb3VybmFsX21zZyA9IHJlbW92ZV92YWx1ZXMobXNnLCBzZWxmLm5vX2xvZ192YWx1ZXMpCgogICAgICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgICAgICBzeXNsb2dfbXNnID0gam91cm5hbF9tc2cKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHN5c2xvZ19tc2cgPSBqb3VybmFsX21zZy5lbmNvZGUoJ3V0Zi04JywgJ3JlcGxhY2UnKQoKICAgICAgICAgICAgaWYgaGFzX2pvdXJuYWw6CiAgICAgICAgICAgICAgICBqb3VybmFsX2FyZ3MgPSBbKCJNT0RVTEUiLCBvcy5wYXRoLmJhc2VuYW1lKF9fZmlsZV9fKSldCiAgICAgICAgICAgICAgICBmb3IgYXJnIGluIGxvZ19hcmdzOgogICAgICAgICAgICAgICAgICAgIGpvdXJuYWxfYXJncy5hcHBlbmQoKGFyZy51cHBlcigpLCBzdHIobG9nX2FyZ3NbYXJnXSkpKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGpvdXJuYWwuc2VuZCh1IiVzICVzIiAlIChtb2R1bGUsIGpvdXJuYWxfbXNnKSwgKipkaWN0KGpvdXJuYWxfYXJncykpCiAgICAgICAgICAgICAgICBleGNlcHQgSU9FcnJvcjoKICAgICAgICAgICAgICAgICAgICAjIGZhbGwgYmFjayB0byBzeXNsb2cgc2luY2UgbG9nZ2luZyB0byBqb3VybmFsIGZhaWxlZAogICAgICAgICAgICAgICAgICAgIHNlbGYuX2xvZ190b19zeXNsb2coc3lzbG9nX21zZykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuX2xvZ190b19zeXNsb2coc3lzbG9nX21zZykKCiAgICBkZWYgX2xvZ19pbnZvY2F0aW9uKHNlbGYpOgogICAgICAgICcnJyBsb2cgdGhhdCBhbnNpYmxlIHJhbiB0aGUgbW9kdWxlICcnJwogICAgICAgICMgVE9ETzogZ2VuZXJhbGl6ZSBhIHNlcGFyYXRlIGxvZyBmdW5jdGlvbiBhbmQgbWFrZSBsb2dfaW52b2NhdGlvbiB1c2UgaXQKICAgICAgICAjIFNhbml0aXplIHBvc3NpYmxlIHBhc3N3b3JkIGFyZ3VtZW50IHdoZW4gbG9nZ2luZy4KICAgICAgICBsb2dfYXJncyA9IGRpY3QoKQoKICAgICAgICBmb3IgcGFyYW0gaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgIGNhbm9uICA9IHNlbGYuYWxpYXNlcy5nZXQocGFyYW0sIHBhcmFtKQogICAgICAgICAgICBhcmdfb3B0cyA9IHNlbGYuYXJndW1lbnRfc3BlYy5nZXQoY2Fub24sIHt9KQogICAgICAgICAgICBub19sb2cgPSBhcmdfb3B0cy5nZXQoJ25vX2xvZycsIEZhbHNlKQoKICAgICAgICAgICAgaWYgc2VsZi5ib29sZWFuKG5vX2xvZyk6CiAgICAgICAgICAgICAgICBsb2dfYXJnc1twYXJhbV0gPSAnTk9UX0xPR0dJTkdfUEFSQU1FVEVSJwogICAgICAgICAgICAjIHRyeSB0byBjYXB0dXJlIGFsbCBwYXNzd29yZHMvcGFzc3BocmFzZSBuYW1lZCBmaWVsZHMgbWlzc2VkIGJ5IG5vX2xvZwogICAgICAgICAgICBlbGlmIFBBU1NXT1JEX01BVENILnNlYXJjaChwYXJhbSkgYW5kIFwKICAgICAgICAgICAgICBhcmdfb3B0cy5nZXQoJ3R5cGUnLCAnc3RyJykgIT0gJ2Jvb2wnIGFuZCBcCiAgICAgICAgICAgICAgbm90IGFyZ19vcHRzLmdldCgnY2hvaWNlcycsIEZhbHNlKToKICAgICAgICAgICAgICAgICMgc2tpcCBib29sZWFuIGFuZCBlbnVtcyBhcyB0aGV5IGFyZSBhYm91dCAncGFzc3dvcmQnIHN0YXRlCiAgICAgICAgICAgICAgICBsb2dfYXJnc1twYXJhbV0gPSAnTk9UX0xPR0dJTkdfUEFTU1dPUkQnCiAgICAgICAgICAgICAgICBzZWxmLndhcm4oJ01vZHVsZSBkaWQgbm90IHNldCBub19sb2cgZm9yICVzJyAlIHBhcmFtKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcGFyYW1fdmFsID0gc2VsZi5wYXJhbXNbcGFyYW1dCiAgICAgICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShwYXJhbV92YWwsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgICAgICAgICAgICAgcGFyYW1fdmFsID0gc3RyKHBhcmFtX3ZhbCkKICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShwYXJhbV92YWwsIHRleHRfdHlwZSk6CiAgICAgICAgICAgICAgICAgICAgcGFyYW1fdmFsID0gcGFyYW1fdmFsLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICAgICAgbG9nX2FyZ3NbcGFyYW1dID0gaGV1cmlzdGljX2xvZ19zYW5pdGl6ZShwYXJhbV92YWwsIHNlbGYubm9fbG9nX3ZhbHVlcykKCiAgICAgICAgbXNnID0gWyclcz0lcycgJSAodG9fbmF0aXZlKGFyZyksIHRvX25hdGl2ZSh2YWwpKSBmb3IgYXJnLCB2YWwgaW4gbG9nX2FyZ3MuaXRlbXMoKV0KICAgICAgICBpZiBtc2c6CiAgICAgICAgICAgIG1zZyA9ICdJbnZva2VkIHdpdGggJXMnICUgJyAnLmpvaW4obXNnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1zZyA9ICdJbnZva2VkJwoKICAgICAgICBzZWxmLmxvZyhtc2csIGxvZ19hcmdzPWxvZ19hcmdzKQoKCiAgICBkZWYgX3NldF9jd2Qoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBjd2QgPSBvcy5nZXRjd2QoKQogICAgICAgICAgICBpZiBub3Qgb3MuYWNjZXNzKGN3ZCwgb3MuRl9PS3xvcy5SX09LKToKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigpCiAgICAgICAgICAgIHJldHVybiBjd2QKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICMgd2UgZG9uJ3QgaGF2ZSBhY2Nlc3MgdG8gdGhlIGN3ZCwgcHJvYmFibHkgYmVjYXVzZSBvZiBzdWRvLgogICAgICAgICAgICAjIFRyeSBhbmQgbW92ZSB0byBhIG5ldXRyYWwgbG9jYXRpb24gdG8gcHJldmVudCBlcnJvcnMKICAgICAgICAgICAgZm9yIGN3ZCBpbiBbb3MucGF0aC5leHBhbmR2YXJzKCckSE9NRScpLCB0ZW1wZmlsZS5nZXR0ZW1wZGlyKCldOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGlmIG9zLmFjY2Vzcyhjd2QsIG9zLkZfT0t8b3MuUl9PSyk6CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNoZGlyKGN3ZCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN3ZAogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAjIHdlIHdvbid0IGVycm9yIGhlcmUsIGFzIGl0IG1heSAqbm90KiBiZSBhIHByb2JsZW0sCiAgICAgICAgIyBhbmQgd2UgZG9uJ3Qgd2FudCB0byBicmVhayBtb2R1bGVzIHVubmVjZXNzYXJpbHkKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBnZXRfYmluX3BhdGgoc2VsZiwgYXJnLCByZXF1aXJlZD1GYWxzZSwgb3B0X2RpcnM9W10pOgogICAgICAgICcnJwogICAgICAgIGZpbmQgc3lzdGVtIGV4ZWN1dGFibGUgaW4gUEFUSC4KICAgICAgICBPcHRpb25hbCBhcmd1bWVudHM6CiAgICAgICAgICAgLSByZXF1aXJlZDogIGlmIGV4ZWN1dGFibGUgaXMgbm90IGZvdW5kIGFuZCByZXF1aXJlZCBpcyB0cnVlLCBmYWlsX2pzb24KICAgICAgICAgICAtIG9wdF9kaXJzOiAgb3B0aW9uYWwgbGlzdCBvZiBkaXJlY3RvcmllcyB0byBzZWFyY2ggaW4gYWRkaXRpb24gdG8gUEFUSAogICAgICAgIGlmIGZvdW5kIHJldHVybiBmdWxsIHBhdGg7IG90aGVyd2lzZSByZXR1cm4gTm9uZQogICAgICAgICcnJwogICAgICAgIHNiaW5fcGF0aHMgPSBbJy9zYmluJywgJy91c3Ivc2JpbicsICcvdXNyL2xvY2FsL3NiaW4nXQogICAgICAgIHBhdGhzID0gW10KICAgICAgICBmb3IgZCBpbiBvcHRfZGlyczoKICAgICAgICAgICAgaWYgZCBpcyBub3QgTm9uZSBhbmQgb3MucGF0aC5leGlzdHMoZCk6CiAgICAgICAgICAgICAgICBwYXRocy5hcHBlbmQoZCkKICAgICAgICBwYXRocyArPSBvcy5lbnZpcm9uLmdldCgnUEFUSCcsICcnKS5zcGxpdChvcy5wYXRoc2VwKQogICAgICAgIGJpbl9wYXRoID0gTm9uZQogICAgICAgICMgbWFuZ2xlIFBBVEggdG8gaW5jbHVkZSAvc2JpbiBkaXJzCiAgICAgICAgZm9yIHAgaW4gc2Jpbl9wYXRoczoKICAgICAgICAgICAgaWYgcCBub3QgaW4gcGF0aHMgYW5kIG9zLnBhdGguZXhpc3RzKHApOgogICAgICAgICAgICAgICAgcGF0aHMuYXBwZW5kKHApCiAgICAgICAgZm9yIGQgaW4gcGF0aHM6CiAgICAgICAgICAgIGlmIG5vdCBkOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgcGF0aCA9IG9zLnBhdGguam9pbihkLCBhcmcpCiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHBhdGgpIGFuZCBub3Qgb3MucGF0aC5pc2RpcihwYXRoKSBhbmQgaXNfZXhlY3V0YWJsZShwYXRoKToKICAgICAgICAgICAgICAgIGJpbl9wYXRoID0gcGF0aAogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICBpZiByZXF1aXJlZCBhbmQgYmluX3BhdGggaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdGYWlsZWQgdG8gZmluZCByZXF1aXJlZCBleGVjdXRhYmxlICVzIGluIHBhdGhzOiAlcycgJSAoYXJnLCBvcy5wYXRoc2VwLmpvaW4ocGF0aHMpKSkKICAgICAgICByZXR1cm4gYmluX3BhdGgKCiAgICBkZWYgYm9vbGVhbihzZWxmLCBhcmcpOgogICAgICAgICcnJyByZXR1cm4gYSBib29sIGZvciB0aGUgYXJnICcnJwogICAgICAgIGlmIGFyZyBpcyBOb25lIG9yIGlzaW5zdGFuY2UoYXJnLCBib29sKToKICAgICAgICAgICAgcmV0dXJuIGFyZwogICAgICAgIGlmIGlzaW5zdGFuY2UoYXJnLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBhcmcgPSBhcmcubG93ZXIoKQogICAgICAgIGlmIGFyZyBpbiBCT09MRUFOU19UUlVFOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsaWYgYXJnIGluIEJPT0xFQU5TX0ZBTFNFOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9JyVzIGlzIG5vdCBhIHZhbGlkIGJvb2xlYW4uIFZhbGlkIGJvb2xlYW5zIGluY2x1ZGU6ICVzJyAlICh0b190ZXh0KGFyZyksICcsJy5qb2luKFsnJXMnICUgeCBmb3IgeCBpbiBCT09MRUFOU10pKSkKCiAgICBkZWYganNvbmlmeShzZWxmLCBkYXRhKToKICAgICAgICBmb3IgZW5jb2RpbmcgaW4gKCJ1dGYtOCIsICJsYXRpbi0xIik6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmR1bXBzKGRhdGEsIGVuY29kaW5nPWVuY29kaW5nKQogICAgICAgICAgICAjIE9sZCBzeXN0ZW1zIHVzaW5nIG9sZCBzaW1wbGVqc29uIG1vZHVsZSBkb2VzIG5vdCBzdXBwb3J0IGVuY29kaW5nIGtleXdvcmQuCiAgICAgICAgICAgIGV4Y2VwdCBUeXBlRXJyb3I6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbmV3X2RhdGEgPSBqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZShkYXRhLCBlbmNvZGluZz1lbmNvZGluZykKICAgICAgICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRGVjb2RlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmR1bXBzKG5ld19kYXRhKQogICAgICAgICAgICBleGNlcHQgVW5pY29kZURlY29kZUVycm9yOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0ludmFsaWQgdW5pY29kZSBlbmNvZGluZyBlbmNvdW50ZXJlZCcpCgogICAgZGVmIGZyb21fanNvbihzZWxmLCBkYXRhKToKICAgICAgICByZXR1cm4ganNvbi5sb2FkcyhkYXRhKQoKICAgIGRlZiBhZGRfY2xlYW51cF9maWxlKHNlbGYsIHBhdGgpOgogICAgICAgIGlmIHBhdGggbm90IGluIHNlbGYuY2xlYW51cF9maWxlczoKICAgICAgICAgICAgc2VsZi5jbGVhbnVwX2ZpbGVzLmFwcGVuZChwYXRoKQoKICAgIGRlZiBkb19jbGVhbnVwX2ZpbGVzKHNlbGYpOgogICAgICAgIGZvciBwYXRoIGluIHNlbGYuY2xlYW51cF9maWxlczoKICAgICAgICAgICAgc2VsZi5jbGVhbnVwKHBhdGgpCgogICAgZGVmIF9yZXR1cm5fZm9ybWF0dGVkKHNlbGYsIGt3YXJncyk6CgogICAgICAgIHNlbGYuYWRkX3BhdGhfaW5mbyhrd2FyZ3MpCgogICAgICAgIGlmICdpbnZvY2F0aW9uJyBub3QgaW4ga3dhcmdzOgogICAgICAgICAgICBrd2FyZ3NbJ2ludm9jYXRpb24nXSA9IHsnbW9kdWxlX2FyZ3MnOiBzZWxmLnBhcmFtc30KCiAgICAgICAgaWYgJ3dhcm5pbmdzJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoa3dhcmdzWyd3YXJuaW5ncyddLCBsaXN0KToKICAgICAgICAgICAgICAgIGZvciB3IGluIGt3YXJnc1snd2FybmluZ3MnXToKICAgICAgICAgICAgICAgICAgICBzZWxmLndhcm4odykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYud2Fybihrd2FyZ3NbJ3dhcm5pbmdzJ10pCgogICAgICAgIGlmIHNlbGYuX3dhcm5pbmdzOgogICAgICAgICAgICBrd2FyZ3NbJ3dhcm5pbmdzJ10gPSBzZWxmLl93YXJuaW5ncwoKICAgICAgICBpZiAnZGVwcmVjYXRpb25zJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoa3dhcmdzWydkZXByZWNhdGlvbnMnXSwgbGlzdCk6CiAgICAgICAgICAgICAgICBmb3IgZCBpbiBrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddOgogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZCwgU0VRVUVOQ0VUWVBFKSBhbmQgbGVuKGQpID09IDI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGVwcmVjYXRlKGRbMF0sIHZlcnNpb249ZFsxXSkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRlcHJlY2F0ZShkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5kZXByZWNhdGUoa3dhcmdzWydkZXByZWNhdGlvbnMnXSkKCiAgICAgICAgaWYgc2VsZi5fZGVwcmVjYXRpb25zOgogICAgICAgICAgICBrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddID0gc2VsZi5fZGVwcmVjYXRpb25zCgogICAgICAgIGt3YXJncyA9IHJlbW92ZV92YWx1ZXMoa3dhcmdzLCBzZWxmLm5vX2xvZ192YWx1ZXMpCiAgICAgICAgcHJpbnQoJ1xuJXMnICUgc2VsZi5qc29uaWZ5KGt3YXJncykpCgogICAgZGVmIGV4aXRfanNvbihzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgJycnIHJldHVybiBmcm9tIHRoZSBtb2R1bGUsIHdpdGhvdXQgZXJyb3IgJycnCgogICAgICAgIGlmIG5vdCAnY2hhbmdlZCcgaW4ga3dhcmdzOgogICAgICAgICAgICBrd2FyZ3NbJ2NoYW5nZWQnXSA9IEZhbHNlCgogICAgICAgIHNlbGYuZG9fY2xlYW51cF9maWxlcygpCiAgICAgICAgc2VsZi5fcmV0dXJuX2Zvcm1hdHRlZChrd2FyZ3MpCiAgICAgICAgc3lzLmV4aXQoMCkKCiAgICBkZWYgZmFpbF9qc29uKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAnJycgcmV0dXJuIGZyb20gdGhlIG1vZHVsZSwgd2l0aCBhbiBlcnJvciBtZXNzYWdlICcnJwoKICAgICAgICBhc3NlcnQgJ21zZycgaW4ga3dhcmdzLCAiaW1wbGVtZW50YXRpb24gZXJyb3IgLS0gbXNnIHRvIGV4cGxhaW4gdGhlIGVycm9yIGlzIHJlcXVpcmVkIgogICAgICAgIGt3YXJnc1snZmFpbGVkJ10gPSBUcnVlCgogICAgICAgIGlmIG5vdCAnY2hhbmdlZCcgaW4ga3dhcmdzOgogICAgICAgICAgICBrd2FyZ3NbJ2NoYW5nZWQnXSA9IEZhbHNlCgogICAgICAgIHNlbGYuZG9fY2xlYW51cF9maWxlcygpCiAgICAgICAgc2VsZi5fcmV0dXJuX2Zvcm1hdHRlZChrd2FyZ3MpCiAgICAgICAgc3lzLmV4aXQoMSkKCiAgICBkZWYgZmFpbF9vbl9taXNzaW5nX3BhcmFtcyhzZWxmLCByZXF1aXJlZF9wYXJhbXM9Tm9uZSk6CiAgICAgICAgJycnIFRoaXMgaXMgZm9yIGNoZWNraW5nIGZvciByZXF1aXJlZCBwYXJhbXMgd2hlbiB3ZSBjYW4gbm90IGNoZWNrIHZpYSBhcmdzcGVjIGJlY2F1c2Ugd2UKICAgICAgICBuZWVkIG1vcmUgaW5mb3JtYXRpb24gdGhhbiBpcyBzaW1wbHkgZ2l2ZW4gaW4gdGhlIGFyZ3NwZWMuCiAgICAgICAgJycnCiAgICAgICAgaWYgbm90IHJlcXVpcmVkX3BhcmFtczoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgbWlzc2luZ19wYXJhbXMgPSBbXQogICAgICAgIGZvciByZXF1aXJlZF9wYXJhbSBpbiByZXF1aXJlZF9wYXJhbXM6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLnBhcmFtcy5nZXQocmVxdWlyZWRfcGFyYW0pOgogICAgICAgICAgICAgICAgbWlzc2luZ19wYXJhbXMuYXBwZW5kKHJlcXVpcmVkX3BhcmFtKQogICAgICAgIGlmIG1pc3NpbmdfcGFyYW1zOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9Im1pc3NpbmcgcmVxdWlyZWQgYXJndW1lbnRzOiAlcyIgJSAnLCcuam9pbihtaXNzaW5nX3BhcmFtcykpCgogICAgZGVmIGRpZ2VzdF9mcm9tX2ZpbGUoc2VsZiwgZmlsZW5hbWUsIGFsZ29yaXRobSk6CiAgICAgICAgJycnIFJldHVybiBoZXggZGlnZXN0IG9mIGxvY2FsIGZpbGUgZm9yIGEgZGlnZXN0X21ldGhvZCBzcGVjaWZpZWQgYnkgbmFtZSwgb3IgTm9uZSBpZiBmaWxlIGlzIG5vdCBwcmVzZW50LiAnJycKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZW5hbWUpOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIG9zLnBhdGguaXNkaXIoZmlsZW5hbWUpOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImF0dGVtcHRlZCB0byB0YWtlIGNoZWNrc3VtIG9mIGRpcmVjdG9yeTogJXMiICUgZmlsZW5hbWUpCgogICAgICAgICMgcHJlc2VydmUgb2xkIGJlaGF2aW91ciB3aGVyZSB0aGUgdGhpcmQgcGFyYW1ldGVyIHdhcyBhIGhhc2ggYWxnb3JpdGhtIG9iamVjdAogICAgICAgIGlmIGhhc2F0dHIoYWxnb3JpdGhtLCAnaGV4ZGlnZXN0Jyk6CiAgICAgICAgICAgIGRpZ2VzdF9tZXRob2QgPSBhbGdvcml0aG0KICAgICAgICBlbHNlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkaWdlc3RfbWV0aG9kID0gQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNU1thbGdvcml0aG1dKCkKICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJDb3VsZCBub3QgaGFzaCBmaWxlICclcycgd2l0aCBhbGdvcml0aG0gJyVzJy4gQXZhaWxhYmxlIGFsZ29yaXRobXM6ICVzIiAlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZpbGVuYW1lLCBhbGdvcml0aG0sICcsICcuam9pbihBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TKSkpCgogICAgICAgIGJsb2Nrc2l6ZSA9IDY0ICogMTAyNAogICAgICAgIGluZmlsZSA9IG9wZW4ob3MucGF0aC5yZWFscGF0aChmaWxlbmFtZSksICdyYicpCiAgICAgICAgYmxvY2sgPSBpbmZpbGUucmVhZChibG9ja3NpemUpCiAgICAgICAgd2hpbGUgYmxvY2s6CiAgICAgICAgICAgIGRpZ2VzdF9tZXRob2QudXBkYXRlKGJsb2NrKQogICAgICAgICAgICBibG9jayA9IGluZmlsZS5yZWFkKGJsb2Nrc2l6ZSkKICAgICAgICBpbmZpbGUuY2xvc2UoKQogICAgICAgIHJldHVybiBkaWdlc3RfbWV0aG9kLmhleGRpZ2VzdCgpCgogICAgZGVmIG1kNShzZWxmLCBmaWxlbmFtZSk6CiAgICAgICAgJycnIFJldHVybiBNRDUgaGV4IGRpZ2VzdCBvZiBsb2NhbCBmaWxlIHVzaW5nIGRpZ2VzdF9mcm9tX2ZpbGUoKS4KCiAgICAgICAgRG8gbm90IHVzZSB0aGlzIGZ1bmN0aW9uIHVubGVzcyB5b3UgaGF2ZSBubyBvdGhlciBjaG9pY2UgZm9yOgogICAgICAgICAgICAxKSBPcHRpb25hbCBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQogICAgICAgICAgICAyKSBDb21wYXRpYmlsaXR5IHdpdGggYSB0aGlyZCBwYXJ0eSBwcm90b2NvbAoKICAgICAgICBUaGlzIGZ1bmN0aW9uIHdpbGwgbm90IHdvcmsgb24gc3lzdGVtcyBjb21wbHlpbmcgd2l0aCBGSVBTLTE0MC0yLgoKICAgICAgICBNb3N0IHVzZXMgb2YgdGhpcyBmdW5jdGlvbiBjYW4gdXNlIHRoZSBtb2R1bGUuc2hhMSBmdW5jdGlvbiBpbnN0ZWFkLgogICAgICAgICcnJwogICAgICAgIGlmICdtZDUnIG5vdCBpbiBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdNRDUgbm90IGF2YWlsYWJsZS4gIFBvc3NpYmx5IHJ1bm5pbmcgaW4gRklQUyBtb2RlJykKICAgICAgICByZXR1cm4gc2VsZi5kaWdlc3RfZnJvbV9maWxlKGZpbGVuYW1lLCAnbWQ1JykKCiAgICBkZWYgc2hhMShzZWxmLCBmaWxlbmFtZSk6CiAgICAgICAgJycnIFJldHVybiBTSEExIGhleCBkaWdlc3Qgb2YgbG9jYWwgZmlsZSB1c2luZyBkaWdlc3RfZnJvbV9maWxlKCkuICcnJwogICAgICAgIHJldHVybiBzZWxmLmRpZ2VzdF9mcm9tX2ZpbGUoZmlsZW5hbWUsICdzaGExJykKCiAgICBkZWYgc2hhMjU2KHNlbGYsIGZpbGVuYW1lKToKICAgICAgICAnJycgUmV0dXJuIFNIQS0yNTYgaGV4IGRpZ2VzdCBvZiBsb2NhbCBmaWxlIHVzaW5nIGRpZ2VzdF9mcm9tX2ZpbGUoKS4gJycnCiAgICAgICAgcmV0dXJuIHNlbGYuZGlnZXN0X2Zyb21fZmlsZShmaWxlbmFtZSwgJ3NoYTI1NicpCgogICAgZGVmIGJhY2t1cF9sb2NhbChzZWxmLCBmbik6CiAgICAgICAgJycnbWFrZSBhIGRhdGUtbWFya2VkIGJhY2t1cCBvZiB0aGUgc3BlY2lmaWVkIGZpbGUsIHJldHVybiBUcnVlIG9yIEZhbHNlIG9uIHN1Y2Nlc3Mgb3IgZmFpbHVyZScnJwoKICAgICAgICBiYWNrdXBkZXN0ID0gJycKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhmbik6CiAgICAgICAgICAgICMgYmFja3VwcyBuYW1lZCBiYXNlbmFtZS5QSUQuWVlZWS1NTS1EREBISDpNTTpTU34KICAgICAgICAgICAgZXh0ID0gdGltZS5zdHJmdGltZSgiJVktJW0tJWRAJUg6JU06JVN+IiwgdGltZS5sb2NhbHRpbWUodGltZS50aW1lKCkpKQogICAgICAgICAgICBiYWNrdXBkZXN0ID0gJyVzLiVzLiVzJyAlIChmbiwgb3MuZ2V0cGlkKCksIGV4dCkKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5MihmbiwgYmFja3VwZGVzdCkKICAgICAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdDb3VsZCBub3QgbWFrZSBiYWNrdXAgb2YgJXMgdG8gJXM6ICVzJyAlIChmbiwgYmFja3VwZGVzdCwgZSkpCgogICAgICAgIHJldHVybiBiYWNrdXBkZXN0CgogICAgZGVmIGNsZWFudXAoc2VsZiwgdG1wZmlsZSk6CiAgICAgICAgaWYgb3MucGF0aC5leGlzdHModG1wZmlsZSk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLnVubGluayh0bXBmaWxlKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHN5cy5zdGRlcnIud3JpdGUoImNvdWxkIG5vdCBjbGVhbnVwICVzOiAlcyIgJSAodG1wZmlsZSwgZSkpCgogICAgZGVmIGF0b21pY19tb3ZlKHNlbGYsIHNyYywgZGVzdCwgdW5zYWZlX3dyaXRlcz1GYWxzZSk6CiAgICAgICAgJycnYXRvbWljYWxseSBtb3ZlIHNyYyB0byBkZXN0LCBjb3B5aW5nIGF0dHJpYnV0ZXMgZnJvbSBkZXN0LCByZXR1cm5zIHRydWUgb24gc3VjY2VzcwogICAgICAgIGl0IHVzZXMgb3MucmVuYW1lIHRvIGVuc3VyZSB0aGlzIGFzIGl0IGlzIGFuIGF0b21pYyBvcGVyYXRpb24sIHJlc3Qgb2YgdGhlIGZ1bmN0aW9uIGlzCiAgICAgICAgdG8gd29yayBhcm91bmQgbGltaXRhdGlvbnMsIGNvcm5lciBjYXNlcyBhbmQgZW5zdXJlIHNlbGludXggY29udGV4dCBpcyBzYXZlZCBpZiBwb3NzaWJsZScnJwogICAgICAgIGNvbnRleHQgPSBOb25lCiAgICAgICAgZGVzdF9zdGF0ID0gTm9uZQogICAgICAgIGJfc3JjID0gdG9fYnl0ZXMoc3JjLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGJfZGVzdCA9IHRvX2J5dGVzKGRlc3QsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoYl9kZXN0KToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGVzdF9zdGF0ID0gb3Muc3RhdChiX2Rlc3QpCgogICAgICAgICAgICAgICAgIyBjb3B5IG1vZGUgYW5kIG93bmVyc2hpcAogICAgICAgICAgICAgICAgb3MuY2htb2QoYl9zcmMsIGRlc3Rfc3RhdC5zdF9tb2RlICYgUEVSTV9CSVRTKQogICAgICAgICAgICAgICAgb3MuY2hvd24oYl9zcmMsIGRlc3Rfc3RhdC5zdF91aWQsIGRlc3Rfc3RhdC5zdF9naWQpCgogICAgICAgICAgICAgICAgIyB0cnkgdG8gY29weSBmbGFncyBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihvcywgJ2NoZmxhZ3MnKSBhbmQgaGFzYXR0cihkZXN0X3N0YXQsICdzdF9mbGFncycpOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2hmbGFncyhiX3NyYywgZGVzdF9zdGF0LnN0X2ZsYWdzKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBlcnIgaW4gJ0VPUE5PVFNVUFAnLCAnRU5PVFNVUCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKGVycm5vLCBlcnIpIGFuZCBlLmVycm5vID09IGdldGF0dHIoZXJybm8sIGVycik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgaWYgZS5lcnJubyAhPSBlcnJuby5FUEVSTToKICAgICAgICAgICAgICAgICAgICByYWlzZQogICAgICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9jb250ZXh0KGRlc3QpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfZGVmYXVsdF9jb250ZXh0KGRlc3QpCgogICAgICAgIGNyZWF0aW5nID0gbm90IG9zLnBhdGguZXhpc3RzKGJfZGVzdCkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIE9wdGltaXN0aWNhbGx5IHRyeSBhIHJlbmFtZSwgc29sdmVzIHNvbWUgY29ybmVyIGNhc2VzIGFuZCBjYW4gYXZvaWQgdXNlbGVzcyB3b3JrLCB0aHJvd3MgZXhjZXB0aW9uIGlmIG5vdCBhdG9taWMuCiAgICAgICAgICAgIG9zLnJlbmFtZShiX3NyYywgYl9kZXN0KQogICAgICAgIGV4Y2VwdCAoSU9FcnJvciwgT1NFcnJvcik6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgaWYgZS5lcnJubyBub3QgaW4gW2Vycm5vLkVQRVJNLCBlcnJuby5FWERFViwgZXJybm8uRUFDQ0VTLCBlcnJuby5FVFhUQlNZLCBlcnJuby5FQlVTWV06CiAgICAgICAgICAgICAgICAjIG9ubHkgdHJ5IHdvcmthcm91bmRzIGZvciBlcnJubyAxOCAoY3Jvc3MgZGV2aWNlKSwgMSAobm90IHBlcm1pdHRlZCksICAxMyAocGVybWlzc2lvbiBkZW5pZWQpCiAgICAgICAgICAgICAgICAjIGFuZCAyNiAodGV4dCBmaWxlIGJ1c3kpIHdoaWNoIGhhcHBlbnMgb24gdmFncmFudCBzeW5jZWQgZm9sZGVycyBhbmQgb3RoZXIgJ2V4b3RpYycgbm9uIHBvc2l4IGZpbGUgc3lzdGVtcwogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdDb3VsZCBub3QgcmVwbGFjZSBmaWxlOiAlcyB0byAlczogJXMnICUgKHNyYywgZGVzdCwgZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYl9kZXN0X2RpciA9IG9zLnBhdGguZGlybmFtZShiX2Rlc3QpCiAgICAgICAgICAgICAgICAjIFVzZSBieXRlcyBoZXJlLiAgSW4gdGhlIHNoaXBwYWJsZSBDSSwgdGhpcyBmYWlscyB3aXRoCiAgICAgICAgICAgICAgICAjIGEgVW5pY29kZUVycm9yIHdpdGggc3Vycm9nYXRlZXNjYXBlJ2Qgc3RyaW5ncyBmb3IgYW4gdW5rbm93bgogICAgICAgICAgICAgICAgIyByZWFzb24gKGRvZXNuJ3QgaGFwcGVuIGluIGEgbG9jYWwgVWJ1bnR1MTYuMDQgVk0pCiAgICAgICAgICAgICAgICBuYXRpdmVfZGVzdF9kaXIgPSBiX2Rlc3RfZGlyCiAgICAgICAgICAgICAgICBuYXRpdmVfc3VmZml4ID0gb3MucGF0aC5iYXNlbmFtZShiX2Rlc3QpCiAgICAgICAgICAgICAgICBuYXRpdmVfcHJlZml4ID0gYignLmFuc2libGVfdG1wJykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB0bXBfZGVzdF9mZCwgdG1wX2Rlc3RfbmFtZSA9IHRlbXBmaWxlLm1rc3RlbXAoIHByZWZpeD1uYXRpdmVfcHJlZml4LCBkaXI9bmF0aXZlX2Rlc3RfZGlyLCBzdWZmaXg9bmF0aXZlX3N1ZmZpeCkKICAgICAgICAgICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nVGhlIGRlc3RpbmF0aW9uIGRpcmVjdG9yeSAoJXMpIGlzIG5vdCB3cml0YWJsZSBieSB0aGUgY3VycmVudCB1c2VyLiBFcnJvciB3YXM6ICVzJyAlIChvcy5wYXRoLmRpcm5hbWUoZGVzdCksIGUpKQogICAgICAgICAgICAgICAgZXhjZXB0IFR5cGVFcnJvcjoKICAgICAgICAgICAgICAgICAgICAjIFdlIGV4cGVjdCB0aGF0IHRoaXMgaXMgaGFwcGVuaW5nIGJlY2F1c2UgcHl0aG9uMy40LnggYW5kCiAgICAgICAgICAgICAgICAgICAgIyBiZWxvdyBjYW4ndCBoYW5kbGUgYnl0ZSBzdHJpbmdzIGluIG1rc3RlbXAoKS4gIFRyYWNlYmFjawogICAgICAgICAgICAgICAgICAgICMgd291bGQgZW5kIGluIHNvbWV0aGluZyBsaWtlOgogICAgICAgICAgICAgICAgICAgICMgICAgIGZpbGUgPSBfb3MucGF0aC5qb2luKGRpciwgcHJlICsgbmFtZSArIHN1ZikKICAgICAgICAgICAgICAgICAgICAjIFR5cGVFcnJvcjogY2FuJ3QgY29uY2F0IGJ5dGVzIHRvIHN0cgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nRmFpbGVkIGNyZWF0aW5nIHRlbXAgZmlsZSBmb3IgYXRvbWljIG1vdmUuICBUaGlzIHVzdWFsbHkgaGFwcGVucyB3aGVuIHVzaW5nIFB5dGhvbjMgbGVzcyB0aGFuIFB5dGhvbjMuNS4gJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnUGxlYXNlIHVzZSBQeXRob24yLnggb3IgUHl0aG9uMy41IG9yIGdyZWF0ZXIuJywgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCgogICAgICAgICAgICAgICAgYl90bXBfZGVzdF9uYW1lID0gdG9fYnl0ZXModG1wX2Rlc3RfbmFtZSwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAjIGNsb3NlIHRtcCBmaWxlIGhhbmRsZSBiZWZvcmUgZmlsZSBvcGVyYXRpb25zIHRvIHByZXZlbnQgdGV4dCBmaWxlIGJ1c3kgZXJyb3JzIG9uIHZib3hmcyBzeW5jZWQgZm9sZGVycyAod2luZG93cyBob3N0KQogICAgICAgICAgICAgICAgICAgICAgICBvcy5jbG9zZSh0bXBfZGVzdF9mZCkKICAgICAgICAgICAgICAgICAgICAgICAgIyBsZWF2ZXMgdG1wIGZpbGUgYmVoaW5kIHdoZW4gc3VkbyBhbmQgbm90IHJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2h1dGlsLm1vdmUoYl9zcmMsIGJfdG1wX2Rlc3RfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIGNsZWFudXAgd2lsbCBoYXBwZW4gYnkgJ3JtJyBvZiB0ZW1wZGlyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIGNvcHkyIHdpbGwgcHJlc2VydmUgc29tZSBtZXRhZGF0YQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2h1dGlsLmNvcHkyKGJfc3JjLCBiX3RtcF9kZXN0X25hbWUpCgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYl90bXBfZGVzdF9uYW1lLCBjb250ZXh0LCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wX3N0YXQgPSBvcy5zdGF0KGJfdG1wX2Rlc3RfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGRlc3Rfc3RhdCBhbmQgKHRtcF9zdGF0LnN0X3VpZCAhPSBkZXN0X3N0YXQuc3RfdWlkIG9yIHRtcF9zdGF0LnN0X2dpZCAhPSBkZXN0X3N0YXQuc3RfZ2lkKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy5jaG93bihiX3RtcF9kZXN0X25hbWUsIGRlc3Rfc3RhdC5zdF91aWQsIGRlc3Rfc3RhdC5zdF9naWQpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZS5lcnJubyAhPSBlcnJuby5FUEVSTToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy5yZW5hbWUoYl90bXBfZGVzdF9uYW1lLCBiX2Rlc3QpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCAoc2h1dGlsLkVycm9yLCBPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVuc2FmZV93cml0ZXMgYW5kIGUuZXJybm8gPT0gZXJybm8uRUJVU1k6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fdW5zYWZlX3dyaXRlcyhiX3RtcF9kZXN0X25hbWUsIGJfZGVzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdVbmFibGUgdG8gcmVuYW1lIGZpbGU6ICVzIHRvICVzOiAlcycgJSAoc3JjLCBkZXN0LCBlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nRmFpbGVkIHRvIHJlcGxhY2UgZmlsZTogJXMgdG8gJXM6ICVzJyAlIChzcmMsIGRlc3QsIGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jbGVhbnVwKGJfdG1wX2Rlc3RfbmFtZSkKCiAgICAgICAgaWYgY3JlYXRpbmc6CiAgICAgICAgICAgICMgbWFrZSBzdXJlIHRoZSBmaWxlIGhhcyB0aGUgY29ycmVjdCBwZXJtaXNzaW9ucwogICAgICAgICAgICAjIGJhc2VkIG9uIHRoZSBjdXJyZW50IHZhbHVlIG9mIHVtYXNrCiAgICAgICAgICAgIHVtYXNrID0gb3MudW1hc2soMCkKICAgICAgICAgICAgb3MudW1hc2sodW1hc2spCiAgICAgICAgICAgIG9zLmNobW9kKGJfZGVzdCwgREVGQVVMVF9QRVJNICYgfnVtYXNrKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5jaG93bihiX2Rlc3QsIG9zLmdldGV1aWQoKSwgb3MuZ2V0ZWdpZCgpKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICMgV2UncmUgb2theSB3aXRoIHRyeWluZyBvdXIgYmVzdCBoZXJlLiAgSWYgdGhlIHVzZXIgaXMgbm90CiAgICAgICAgICAgICAgICAjIHJvb3QgKG9yIG9sZCBVbmljZXMpIHRoZXkgd29uJ3QgYmUgYWJsZSB0byBjaG93bi4KICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgaWYgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgIyByZW5hbWUgbWlnaHQgbm90IHByZXNlcnZlIGNvbnRleHQKICAgICAgICAgICAgc2VsZi5zZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoZGVzdCwgY29udGV4dCwgRmFsc2UpCgogICAgZGVmIF91bnNhZmVfd3JpdGVzKHNlbGYsIHNyYywgZGVzdCk6CiAgICAgICAgIyBzYWRseSB0aGVyZSBhcmUgc29tZSBzaXR1YXRpb25zIHdoZXJlIHdlIGNhbm5vdCBlbnN1cmUgYXRvbWljaXR5LCBidXQgb25seSBpZgogICAgICAgICMgdGhlIHVzZXIgaW5zaXN0cyBhbmQgd2UgZ2V0IHRoZSBhcHByb3ByaWF0ZSBlcnJvciB3ZSB1cGRhdGUgdGhlIGZpbGUgdW5zYWZlbHkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG91dF9kZXN0ID0gb3BlbihkZXN0LCAnd2InKQogICAgICAgICAgICAgICAgaW5fc3JjID0gb3BlbihzcmMsICdyYicpCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weWZpbGVvYmooaW5fc3JjLCBvdXRfZGVzdCkKICAgICAgICAgICAgZmluYWxseTogICMgYXNzdXJpbmcgY2xvc2VkIGZpbGVzIGluIDIuNCBjb21wYXRpYmxlIHdheQogICAgICAgICAgICAgICAgaWYgb3V0X2Rlc3Q6CiAgICAgICAgICAgICAgICAgICAgb3V0X2Rlc3QuY2xvc2UoKQogICAgICAgICAgICAgICAgaWYgaW5fc3JjOgogICAgICAgICAgICAgICAgICAgIGluX3NyYy5jbG9zZSgpCiAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nQ291bGQgbm90IHdyaXRlIGRhdGEgdG8gZmlsZSAoJXMpIGZyb20gKCVzKTogJXMnICUgKGRlc3QsIHNyYywgZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQoKCiAgICBkZWYgX3JlYWRfZnJvbV9waXBlcyhzZWxmLCBycGlwZXMsIHJmZHMsIGZpbGVfZGVzY3JpcHRvcik6CiAgICAgICAgZGF0YSA9IGIoJycpCiAgICAgICAgaWYgZmlsZV9kZXNjcmlwdG9yIGluIHJmZHM6CiAgICAgICAgICAgIGRhdGEgPSBvcy5yZWFkKGZpbGVfZGVzY3JpcHRvci5maWxlbm8oKSwgOTAwMCkKICAgICAgICAgICAgaWYgZGF0YSA9PSBiKCcnKToKICAgICAgICAgICAgICAgIHJwaXBlcy5yZW1vdmUoZmlsZV9kZXNjcmlwdG9yKQoKICAgICAgICByZXR1cm4gZGF0YQoKICAgIGRlZiBydW5fY29tbWFuZChzZWxmLCBhcmdzLCBjaGVja19yYz1GYWxzZSwgY2xvc2VfZmRzPVRydWUsIGV4ZWN1dGFibGU9Tm9uZSwgZGF0YT1Ob25lLCBiaW5hcnlfZGF0YT1GYWxzZSwgcGF0aF9wcmVmaXg9Tm9uZSwgY3dkPU5vbmUsCiAgICAgICAgICAgICAgICAgICAgdXNlX3Vuc2FmZV9zaGVsbD1GYWxzZSwgcHJvbXB0X3JlZ2V4PU5vbmUsIGVudmlyb25fdXBkYXRlPU5vbmUsIHVtYXNrPU5vbmUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpOgogICAgICAgICcnJwogICAgICAgIEV4ZWN1dGUgYSBjb21tYW5kLCByZXR1cm5zIHJjLCBzdGRvdXQsIGFuZCBzdGRlcnIuCgogICAgICAgIDphcmcgYXJnczogaXMgdGhlIGNvbW1hbmQgdG8gcnVuCiAgICAgICAgICAgICogSWYgYXJncyBpcyBhIGxpc3QsIHRoZSBjb21tYW5kIHdpbGwgYmUgcnVuIHdpdGggc2hlbGw9RmFsc2UuCiAgICAgICAgICAgICogSWYgYXJncyBpcyBhIHN0cmluZyBhbmQgdXNlX3Vuc2FmZV9zaGVsbD1GYWxzZSBpdCB3aWxsIHNwbGl0IGFyZ3MgdG8gYSBsaXN0IGFuZCBydW4gd2l0aCBzaGVsbD1GYWxzZQogICAgICAgICAgICAqIElmIGFyZ3MgaXMgYSBzdHJpbmcgYW5kIHVzZV91bnNhZmVfc2hlbGw9VHJ1ZSBpdCBydW5zIHdpdGggc2hlbGw9VHJ1ZS4KICAgICAgICA6a3cgY2hlY2tfcmM6IFdoZXRoZXIgdG8gY2FsbCBmYWlsX2pzb24gaW4gY2FzZSBvZiBub24gemVybyBSQy4KICAgICAgICAgICAgRGVmYXVsdCBGYWxzZQogICAgICAgIDprdyBjbG9zZV9mZHM6IFNlZSBkb2N1bWVudGF0aW9uIGZvciBzdWJwcm9jZXNzLlBvcGVuKCkuIERlZmF1bHQgVHJ1ZQogICAgICAgIDprdyBleGVjdXRhYmxlOiBTZWUgZG9jdW1lbnRhdGlvbiBmb3Igc3VicHJvY2Vzcy5Qb3BlbigpLiBEZWZhdWx0IE5vbmUKICAgICAgICA6a3cgZGF0YTogSWYgZ2l2ZW4sIGluZm9ybWF0aW9uIHRvIHdyaXRlIHRvIHRoZSBzdGRpbiBvZiB0aGUgY29tbWFuZAogICAgICAgIDprdyBiaW5hcnlfZGF0YTogSWYgRmFsc2UsIGFwcGVuZCBhIG5ld2xpbmUgdG8gdGhlIGRhdGEuICBEZWZhdWx0IEZhbHNlCiAgICAgICAgOmt3IHBhdGhfcHJlZml4OiBJZiBnaXZlbiwgYWRkaXRpb25hbCBwYXRoIHRvIGZpbmQgdGhlIGNvbW1hbmQgaW4uCiAgICAgICAgICAgIFRoaXMgYWRkcyB0byB0aGUgUEFUSCBlbnZpcm9ubWVudCB2YWlyYWJsZSBzbyBoZWxwZXIgY29tbWFuZHMgaW4KICAgICAgICAgICAgdGhlIHNhbWUgZGlyZWN0b3J5IGNhbiBhbHNvIGJlIGZvdW5kCiAgICAgICAgOmt3IGN3ZDogSWYgZ2l2ZW4sIHdvcmtpbmcgZGlyZWN0b3J5IHRvIHJ1biB0aGUgY29tbWFuZCBpbnNpZGUKICAgICAgICA6a3cgdXNlX3Vuc2FmZV9zaGVsbDogU2VlIGBhcmdzYCBwYXJhbWV0ZXIuICBEZWZhdWx0IEZhbHNlCiAgICAgICAgOmt3IHByb21wdF9yZWdleDogUmVnZXggc3RyaW5nIChub3QgYSBjb21waWxlZCByZWdleCkgd2hpY2ggY2FuIGJlCiAgICAgICAgICAgIHVzZWQgdG8gZGV0ZWN0IHByb21wdHMgaW4gdGhlIHN0ZG91dCB3aGljaCB3b3VsZCBvdGhlcndpc2UgY2F1c2UKICAgICAgICAgICAgdGhlIGV4ZWN1dGlvbiB0byBoYW5nIChlc3BlY2lhbGx5IGlmIG5vIGlucHV0IGRhdGEgaXMgc3BlY2lmaWVkKQogICAgICAgIDprdyBlbnZpcm9uX3VwZGF0ZTogZGljdGlvbmFyeSB0byAqdXBkYXRlKiBvcy5lbnZpcm9uIHdpdGgKICAgICAgICA6a3cgdW1hc2s6IFVtYXNrIHRvIGJlIHVzZWQgd2hlbiBydW5uaW5nIHRoZSBjb21tYW5kLiBEZWZhdWx0IE5vbmUKICAgICAgICA6a3cgZW5jb2Rpbmc6IFNpbmNlIHdlIHJldHVybiBuYXRpdmUgc3RyaW5ncywgb24gcHl0aG9uMyB3ZSBuZWVkIHRvCiAgICAgICAgICAgIGtub3cgdGhlIGVuY29kaW5nIHRvIHVzZSB0byB0cmFuc2Zvcm0gZnJvbSBieXRlcyB0byB0ZXh0LiAgSWYgeW91CiAgICAgICAgICAgIHdhbnQgdG8gYWx3YXlzIGdldCBieXRlcyBiYWNrLCB1c2UgZW5jb2Rpbmc9Tm9uZS4gIFRoZSBkZWZhdWx0IGlzCiAgICAgICAgICAgICJ1dGYtOCIuICBUaGlzIGRvZXMgbm90IGFmZmVjdCB0cmFuc2Zvcm1hdGlvbiBvZiBzdHJpbmdzIGdpdmVuIGFzCiAgICAgICAgICAgIGFyZ3MuCiAgICAgICAgOmt3IGVycm9yczogU2luY2Ugd2UgcmV0dXJuIG5hdGl2ZSBzdHJpbmdzLCBvbiBweXRob24zIHdlIG5lZWQgdG8KICAgICAgICAgICAgdHJhbnNmb3JtIHN0ZG91dCBhbmQgc3RkZXJyIGZyb20gYnl0ZXMgdG8gdGV4dC4gIElmIHRoZSBieXRlcyBhcmUKICAgICAgICAgICAgdW5kZWNvZGFibGUgaW4gdGhlIGBgZW5jb2RpbmdgYCBzcGVjaWZpZWQsIHRoZW4gdXNlIHRoaXMgZXJyb3IKICAgICAgICAgICAgaGFuZGxlciB0byBkZWFsIHdpdGggdGhlbS4gIFRoZSBkZWZhdWx0IGlzIGBgc3Vycm9nYXRlX29yX3N0cmljdGBgCiAgICAgICAgICAgIHdoaWNoIG1lYW5zIHRoYXQgdGhlIGJ5dGVzIHdpbGwgYmUgZGVjb2RlZCB1c2luZyB0aGUKICAgICAgICAgICAgc3Vycm9nYXRlZXNjYXBlIGVycm9yIGhhbmRsZXIgaWYgYXZhaWxhYmxlIChhdmFpbGFibGUgb24gYWxsCiAgICAgICAgICAgIHB5dGhvbjMgdmVyc2lvbnMgd2Ugc3VwcG9ydCkgb3RoZXJ3aXNlIGEgVW5pY29kZUVycm9yIHRyYWNlYmFjawogICAgICAgICAgICB3aWxsIGJlIHJhaXNlZC4gIFRoaXMgZG9lcyBub3QgYWZmZWN0IHRyYW5zZm9ybWF0aW9ucyBvZiBzdHJpbmdzCiAgICAgICAgICAgIGdpdmVuIGFzIGFyZ3MuCiAgICAgICAgOnJldHVybnM6IEEgMy10dXBsZSBvZiByZXR1cm4gY29kZSAoaW50ZWdlciksIHN0ZG91dCAobmF0aXZlIHN0cmluZyksCiAgICAgICAgICAgIGFuZCBzdGRlcnIgKG5hdGl2ZSBzdHJpbmcpLiAgT24gcHl0aG9uMiwgc3Rkb3V0IGFuZCBzdGRlcnIgYXJlIGJvdGgKICAgICAgICAgICAgYnl0ZSBzdHJpbmdzLiAgT24gcHl0aG9uMywgc3Rkb3V0IGFuZCBzdGRlcnIgYXJlIHRleHQgc3RyaW5ncyBjb252ZXJ0ZWQKICAgICAgICAgICAgYWNjb3JkaW5nIHRvIHRoZSBlbmNvZGluZyBhbmQgZXJyb3JzIHBhcmFtZXRlcnMuICBJZiB5b3Ugd2FudCBieXRlCiAgICAgICAgICAgIHN0cmluZ3Mgb24gcHl0aG9uMywgdXNlIGVuY29kaW5nPU5vbmUgdG8gdHVybiBkZWNvZGluZyB0byB0ZXh0IG9mZi4KICAgICAgICAnJycKCiAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCBsaXN0KToKICAgICAgICAgICAgaWYgdXNlX3Vuc2FmZV9zaGVsbDoKICAgICAgICAgICAgICAgIGFyZ3MgPSAiICIuam9pbihbc2hsZXhfcXVvdGUoeCkgZm9yIHggaW4gYXJnc10pCiAgICAgICAgICAgICAgICBzaGVsbCA9IFRydWUKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoYXJncywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKSBhbmQgdXNlX3Vuc2FmZV9zaGVsbDoKICAgICAgICAgICAgc2hlbGwgPSBUcnVlCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGFyZ3MsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgIGlmIG5vdCB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICAgICAgIyBPbiBweXRob24yLjYgYW5kIGJlbG93LCBzaGxleCBoYXMgcHJvYmxlbXMgd2l0aCB0ZXh0IHR5cGUKICAgICAgICAgICAgICAgICMgT24gcHl0aG9uMywgc2hsZXggbmVlZHMgYSB0ZXh0IHR5cGUuCiAgICAgICAgICAgICAgICBpZiBQWTI6CiAgICAgICAgICAgICAgICAgICAgYXJncyA9IHRvX2J5dGVzKGFyZ3MsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgICAgICAgICBlbGlmIFBZMzoKICAgICAgICAgICAgICAgICAgICBhcmdzID0gdG9fdGV4dChhcmdzLCBlcnJvcnM9J3N1cnJvZ2F0ZWVzY2FwZScpCiAgICAgICAgICAgICAgICBhcmdzID0gc2hsZXguc3BsaXQoYXJncykKICAgICAgICBlbHNlOgogICAgICAgICAgICBtc2cgPSAiQXJndW1lbnQgJ2FyZ3MnIHRvIHJ1bl9jb21tYW5kIG11c3QgYmUgbGlzdCBvciBzdHJpbmciCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPTI1NywgY21kPWFyZ3MsIG1zZz1tc2cpCgogICAgICAgIHNoZWxsID0gRmFsc2UKICAgICAgICBpZiB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICBpZiBleGVjdXRhYmxlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBleGVjdXRhYmxlID0gb3MuZW52aXJvbi5nZXQoJ1NIRUxMJykKICAgICAgICAgICAgaWYgZXhlY3V0YWJsZToKICAgICAgICAgICAgICAgIGFyZ3MgPSBbZXhlY3V0YWJsZSwgJy1jJywgYXJnc10KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNoZWxsID0gVHJ1ZQoKICAgICAgICBwcm9tcHRfcmUgPSBOb25lCiAgICAgICAgaWYgcHJvbXB0X3JlZ2V4OgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHByb21wdF9yZWdleCwgdGV4dF90eXBlKToKICAgICAgICAgICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgICAgICAgICBwcm9tcHRfcmVnZXggPSB0b19ieXRlcyhwcm9tcHRfcmVnZXgsIGVycm9ycz0nc3Vycm9nYXRlZXNjYXBlJykKICAgICAgICAgICAgICAgIGVsaWYgUFkyOgogICAgICAgICAgICAgICAgICAgIHByb21wdF9yZWdleCA9IHRvX2J5dGVzKHByb21wdF9yZWdleCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcHJvbXB0X3JlID0gcmUuY29tcGlsZShwcm9tcHRfcmVnZXgsIHJlLk1VTFRJTElORSkKICAgICAgICAgICAgZXhjZXB0IHJlLmVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJpbnZhbGlkIHByb21wdCByZWd1bGFyIGV4cHJlc3Npb24gZ2l2ZW4gdG8gcnVuX2NvbW1hbmQiKQoKICAgICAgICAjIGV4cGFuZCB0aGluZ3MgbGlrZSAkSE9NRSBhbmQgfgogICAgICAgIGlmIG5vdCBzaGVsbDoKICAgICAgICAgICAgYXJncyA9IFsgb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyh4KSkgZm9yIHggaW4gYXJncyBpZiB4IGlzIG5vdCBOb25lIF0KCiAgICAgICAgcmMgPSAwCiAgICAgICAgbXNnID0gTm9uZQogICAgICAgIHN0X2luID0gTm9uZQoKICAgICAgICAjIE1hbmlwdWxhdGUgdGhlIGVudmlyb24gd2UnbGwgc2VuZCB0byB0aGUgbmV3IHByb2Nlc3MKICAgICAgICBvbGRfZW52X3ZhbHMgPSB7fQogICAgICAgICMgV2UgY2FuIHNldCB0aGlzIGZyb20gYm90aCBhbiBhdHRyaWJ1dGUgYW5kIHBlciBjYWxsCiAgICAgICAgZm9yIGtleSwgdmFsIGluIHNlbGYucnVuX2NvbW1hbmRfZW52aXJvbl91cGRhdGUuaXRlbXMoKToKICAgICAgICAgICAgb2xkX2Vudl92YWxzW2tleV0gPSBvcy5lbnZpcm9uLmdldChrZXksIE5vbmUpCiAgICAgICAgICAgIG9zLmVudmlyb25ba2V5XSA9IHZhbAogICAgICAgIGlmIGVudmlyb25fdXBkYXRlOgogICAgICAgICAgICBmb3Iga2V5LCB2YWwgaW4gZW52aXJvbl91cGRhdGUuaXRlbXMoKToKICAgICAgICAgICAgICAgIG9sZF9lbnZfdmFsc1trZXldID0gb3MuZW52aXJvbi5nZXQoa2V5LCBOb25lKQogICAgICAgICAgICAgICAgb3MuZW52aXJvbltrZXldID0gdmFsCiAgICAgICAgaWYgcGF0aF9wcmVmaXg6CiAgICAgICAgICAgIG9sZF9lbnZfdmFsc1snUEFUSCddID0gb3MuZW52aXJvblsnUEFUSCddCiAgICAgICAgICAgIG9zLmVudmlyb25bJ1BBVEgnXSA9ICIlczolcyIgJSAocGF0aF9wcmVmaXgsIG9zLmVudmlyb25bJ1BBVEgnXSkKCiAgICAgICAgIyBJZiB1c2luZyB0ZXN0LW1vZHVsZSBhbmQgZXhwbG9kZSwgdGhlIHJlbW90ZSBsaWIgcGF0aCB3aWxsIHJlc2VtYmxlIC4uLgogICAgICAgICMgICAvdG1wL3Rlc3RfbW9kdWxlX3NjcmF0Y2gvZGVidWdfZGlyL2Fuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5CiAgICAgICAgIyBJZiB1c2luZyBhbnNpYmxlIG9yIGFuc2libGUtcGxheWJvb2sgd2l0aCBhIHJlbW90ZSBzeXN0ZW0gLi4uCiAgICAgICAgIyAgIC90bXAvYW5zaWJsZV92bXdlTFEvYW5zaWJsZV9tb2RsaWIuemlwL2Fuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5CgogICAgICAgICMgQ2xlYW4gb3V0IHB5dGhvbiBwYXRocyBzZXQgYnkgYW5zaWJhbGx6CiAgICAgICAgaWYgJ1BZVEhPTlBBVEgnIGluIG9zLmVudmlyb246CiAgICAgICAgICAgIHB5cGF0aHMgPSBvcy5lbnZpcm9uWydQWVRIT05QQVRIJ10uc3BsaXQoJzonKQogICAgICAgICAgICBweXBhdGhzID0gW3ggZm9yIHggaW4gcHlwYXRocyBcCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCB4LmVuZHN3aXRoKCcvYW5zaWJsZV9tb2RsaWIuemlwJykgXAogICAgICAgICAgICAgICAgICAgICAgICBhbmQgbm90IHguZW5kc3dpdGgoJy9kZWJ1Z19kaXInKV0KICAgICAgICAgICAgb3MuZW52aXJvblsnUFlUSE9OUEFUSCddID0gJzonLmpvaW4ocHlwYXRocykKICAgICAgICAgICAgaWYgbm90IG9zLmVudmlyb25bJ1BZVEhPTlBBVEgnXToKICAgICAgICAgICAgICAgIGRlbCBvcy5lbnZpcm9uWydQWVRIT05QQVRIJ10KCiAgICAgICAgIyBjcmVhdGUgYSBwcmludGFibGUgdmVyc2lvbiBvZiB0aGUgY29tbWFuZCBmb3IgdXNlCiAgICAgICAgIyBpbiByZXBvcnRpbmcgbGF0ZXIsIHdoaWNoIHN0cmlwcyBvdXQgdGhpbmdzIGxpa2UKICAgICAgICAjIHBhc3N3b3JkcyBmcm9tIHRoZSBhcmdzIGxpc3QKICAgICAgICB0b19jbGVhbl9hcmdzID0gYXJncwogICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICAgICAgdG9fY2xlYW5fYXJncyA9IHRvX2J5dGVzKGFyZ3MpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgICAgICB0b19jbGVhbl9hcmdzID0gdG9fdGV4dChhcmdzKQogICAgICAgIGlmIGlzaW5zdGFuY2UoYXJncywgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICAgICAgdG9fY2xlYW5fYXJncyA9IHNobGV4LnNwbGl0KHRvX2NsZWFuX2FyZ3MpCgogICAgICAgIGNsZWFuX2FyZ3MgPSBbXQogICAgICAgIGlzX3Bhc3N3ZCA9IEZhbHNlCiAgICAgICAgZm9yIGFyZyBpbiB0b19jbGVhbl9hcmdzOgogICAgICAgICAgICBpZiBpc19wYXNzd2Q6CiAgICAgICAgICAgICAgICBpc19wYXNzd2QgPSBGYWxzZQogICAgICAgICAgICAgICAgY2xlYW5fYXJncy5hcHBlbmQoJyoqKioqKioqJykKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIFBBU1NXRF9BUkdfUkUubWF0Y2goYXJnKToKICAgICAgICAgICAgICAgIHNlcF9pZHggPSBhcmcuZmluZCgnPScpCiAgICAgICAgICAgICAgICBpZiBzZXBfaWR4ID4gLTE6CiAgICAgICAgICAgICAgICAgICAgY2xlYW5fYXJncy5hcHBlbmQoJyVzPSoqKioqKioqJyAlIGFyZ1s6c2VwX2lkeF0pCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaXNfcGFzc3dkID0gVHJ1ZQogICAgICAgICAgICBhcmcgPSBoZXVyaXN0aWNfbG9nX3Nhbml0aXplKGFyZywgc2VsZi5ub19sb2dfdmFsdWVzKQogICAgICAgICAgICBjbGVhbl9hcmdzLmFwcGVuZChhcmcpCiAgICAgICAgY2xlYW5fYXJncyA9ICcgJy5qb2luKHNobGV4X3F1b3RlKGFyZykgZm9yIGFyZyBpbiBjbGVhbl9hcmdzKQoKICAgICAgICBpZiBkYXRhOgogICAgICAgICAgICBzdF9pbiA9IHN1YnByb2Nlc3MuUElQRQoKICAgICAgICBrd2FyZ3MgPSBkaWN0KAogICAgICAgICAgICBleGVjdXRhYmxlPWV4ZWN1dGFibGUsCiAgICAgICAgICAgIHNoZWxsPXNoZWxsLAogICAgICAgICAgICBjbG9zZV9mZHM9Y2xvc2VfZmRzLAogICAgICAgICAgICBzdGRpbj1zdF9pbiwKICAgICAgICAgICAgc3Rkb3V0PXN1YnByb2Nlc3MuUElQRSwKICAgICAgICAgICAgc3RkZXJyPXN1YnByb2Nlc3MuUElQRSwKICAgICAgICApCgogICAgICAgICMgc3RvcmUgdGhlIHB3ZAogICAgICAgIHByZXZfZGlyID0gb3MuZ2V0Y3dkKCkKCiAgICAgICAgIyBtYWtlIHN1cmUgd2UncmUgaW4gdGhlIHJpZ2h0IHdvcmtpbmcgZGlyZWN0b3J5CiAgICAgICAgaWYgY3dkIGFuZCBvcy5wYXRoLmlzZGlyKGN3ZCk6CiAgICAgICAgICAgIGN3ZCA9IG9zLnBhdGguYWJzcGF0aChvcy5wYXRoLmV4cGFuZHVzZXIoY3dkKSkKICAgICAgICAgICAga3dhcmdzWydjd2QnXSA9IGN3ZAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5jaGRpcihjd2QpCiAgICAgICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihyYz1lLmVycm5vLCBtc2c9IkNvdWxkIG5vdCBvcGVuICVzLCAlcyIgJSAoY3dkLCBzdHIoZSkpKQoKICAgICAgICBvbGRfdW1hc2sgPSBOb25lCiAgICAgICAgaWYgdW1hc2s6CiAgICAgICAgICAgIG9sZF91bWFzayA9IG9zLnVtYXNrKHVtYXNrKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbGYuX2RlYnVnOgogICAgICAgICAgICAgICAgc2VsZi5sb2coJ0V4ZWN1dGluZzogJyArIGNsZWFuX2FyZ3MpCiAgICAgICAgICAgIGNtZCA9IHN1YnByb2Nlc3MuUG9wZW4oYXJncywgKiprd2FyZ3MpCgogICAgICAgICAgICAjIHRoZSBjb21tdW5pY2F0aW9uIGxvZ2ljIGhlcmUgaXMgZXNzZW50aWFsbHkgdGFrZW4gZnJvbSB0aGF0CiAgICAgICAgICAgICMgb2YgdGhlIF9jb21tdW5pY2F0ZSgpIGZ1bmN0aW9uIGluIHNzaC5weQoKICAgICAgICAgICAgc3Rkb3V0ID0gYignJykKICAgICAgICAgICAgc3RkZXJyID0gYignJykKICAgICAgICAgICAgcnBpcGVzID0gW2NtZC5zdGRvdXQsIGNtZC5zdGRlcnJdCgogICAgICAgICAgICBpZiBkYXRhOgogICAgICAgICAgICAgICAgaWYgbm90IGJpbmFyeV9kYXRhOgogICAgICAgICAgICAgICAgICAgIGRhdGEgKz0gJ1xuJwogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkYXRhLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICAgICAgICAgIGRhdGEgPSB0b19ieXRlcyhkYXRhKQogICAgICAgICAgICAgICAgY21kLnN0ZGluLndyaXRlKGRhdGEpCiAgICAgICAgICAgICAgICBjbWQuc3RkaW4uY2xvc2UoKQoKICAgICAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgICAgIHJmZHMsIHdmZHMsIGVmZHMgPSBzZWxlY3Quc2VsZWN0KHJwaXBlcywgW10sIHJwaXBlcywgMSkKICAgICAgICAgICAgICAgIHN0ZG91dCArPSBzZWxmLl9yZWFkX2Zyb21fcGlwZXMocnBpcGVzLCByZmRzLCBjbWQuc3Rkb3V0KQogICAgICAgICAgICAgICAgc3RkZXJyICs9IHNlbGYuX3JlYWRfZnJvbV9waXBlcyhycGlwZXMsIHJmZHMsIGNtZC5zdGRlcnIpCiAgICAgICAgICAgICAgICAjIGlmIHdlJ3JlIGNoZWNraW5nIGZvciBwcm9tcHRzLCBkbyBpdCBub3cKICAgICAgICAgICAgICAgIGlmIHByb21wdF9yZToKICAgICAgICAgICAgICAgICAgICBpZiBwcm9tcHRfcmUuc2VhcmNoKHN0ZG91dCkgYW5kIG5vdCBkYXRhOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBlbmNvZGluZzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dCA9IHRvX25hdGl2ZShzdGRvdXQsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Rkb3V0ID0gc3Rkb3V0CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoMjU3LCBzdGRvdXQsICJBIHByb21wdCB3YXMgZW5jb3VudGVyZWQgd2hpbGUgcnVubmluZyBhIGNvbW1hbmQsIGJ1dCBubyBpbnB1dCBkYXRhIHdhcyBzcGVjaWZpZWQiKQogICAgICAgICAgICAgICAgIyBvbmx5IGJyZWFrIG91dCBpZiBubyBwaXBlcyBhcmUgbGVmdCB0byByZWFkIG9yCiAgICAgICAgICAgICAgICAjIHRoZSBwaXBlcyBhcmUgY29tcGxldGVseSByZWFkIGFuZAogICAgICAgICAgICAgICAgIyB0aGUgcHJvY2VzcyBpcyB0ZXJtaW5hdGVkCiAgICAgICAgICAgICAgICBpZiAobm90IHJwaXBlcyBvciBub3QgcmZkcykgYW5kIGNtZC5wb2xsKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICMgTm8gcGlwZXMgYXJlIGxlZnQgdG8gcmVhZCBidXQgcHJvY2VzcyBpcyBub3QgeWV0IHRlcm1pbmF0ZWQKICAgICAgICAgICAgICAgICMgT25seSB0aGVuIGl0IGlzIHNhZmUgdG8gd2FpdCBmb3IgdGhlIHByb2Nlc3MgdG8gYmUgZmluaXNoZWQKICAgICAgICAgICAgICAgICMgTk9URTogQWN0dWFsbHkgY21kLnBvbGwoKSBpcyBhbHdheXMgTm9uZSBoZXJlIGlmIHJwaXBlcyBpcyBlbXB0eQogICAgICAgICAgICAgICAgZWxpZiBub3QgcnBpcGVzIGFuZCBjbWQucG9sbCgpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgY21kLndhaXQoKQogICAgICAgICAgICAgICAgICAgICMgVGhlIHByb2Nlc3MgaXMgdGVybWluYXRlZC4gU2luY2Ugbm8gcGlwZXMgdG8gcmVhZCBmcm9tIGFyZQogICAgICAgICAgICAgICAgICAgICMgbGVmdCwgdGhlcmUgaXMgbm8gbmVlZCB0byBjYWxsIHNlbGVjdCgpIGFnYWluLgogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBjbWQuc3Rkb3V0LmNsb3NlKCkKICAgICAgICAgICAgY21kLnN0ZGVyci5jbG9zZSgpCgogICAgICAgICAgICByYyA9IGNtZC5yZXR1cm5jb2RlCiAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLmxvZygiRXJyb3IgRXhlY3V0aW5nIENNRDolcyBFeGNlcHRpb246JXMiICUgKGNsZWFuX2FyZ3MsIHRvX25hdGl2ZShlKSkpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPWUuZXJybm8sIG1zZz10b19uYXRpdmUoZSksIGNtZD1jbGVhbl9hcmdzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5sb2coIkVycm9yIEV4ZWN1dGluZyBDTUQ6JXMgRXhjZXB0aW9uOiVzIiAlIChjbGVhbl9hcmdzLHRvX25hdGl2ZSh0cmFjZWJhY2suZm9ybWF0X2V4YygpKSkpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPTI1NywgbXNnPXRvX25hdGl2ZShlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCksIGNtZD1jbGVhbl9hcmdzKQoKICAgICAgICAjIFJlc3RvcmUgZW52IHNldHRpbmdzCiAgICAgICAgZm9yIGtleSwgdmFsIGluIG9sZF9lbnZfdmFscy5pdGVtcygpOgogICAgICAgICAgICBpZiB2YWwgaXMgTm9uZToKICAgICAgICAgICAgICAgIGRlbCBvcy5lbnZpcm9uW2tleV0KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9zLmVudmlyb25ba2V5XSA9IHZhbAoKICAgICAgICBpZiBvbGRfdW1hc2s6CiAgICAgICAgICAgIG9zLnVtYXNrKG9sZF91bWFzaykKCiAgICAgICAgaWYgcmMgIT0gMCBhbmQgY2hlY2tfcmM6CiAgICAgICAgICAgIG1zZyA9IGhldXJpc3RpY19sb2dfc2FuaXRpemUoc3RkZXJyLnJzdHJpcCgpLCBzZWxmLm5vX2xvZ192YWx1ZXMpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKGNtZD1jbGVhbl9hcmdzLCByYz1yYywgc3Rkb3V0PXN0ZG91dCwgc3RkZXJyPXN0ZGVyciwgbXNnPW1zZykKCiAgICAgICAgIyByZXNldCB0aGUgcHdkCiAgICAgICAgb3MuY2hkaXIocHJldl9kaXIpCgogICAgICAgIGlmIGVuY29kaW5nIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXR1cm4gKHJjLCB0b19uYXRpdmUoc3Rkb3V0LCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycyksCiAgICAgICAgICAgICAgICAgICAgdG9fbmF0aXZlKHN0ZGVyciwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpKQogICAgICAgIHJldHVybiAocmMsIHN0ZG91dCwgc3RkZXJyKQoKICAgIGRlZiBhcHBlbmRfdG9fZmlsZShzZWxmLCBmaWxlbmFtZSwgc3RyKToKICAgICAgICBmaWxlbmFtZSA9IG9zLnBhdGguZXhwYW5kdmFycyhvcy5wYXRoLmV4cGFuZHVzZXIoZmlsZW5hbWUpKQogICAgICAgIGZoID0gb3BlbihmaWxlbmFtZSwgJ2EnKQogICAgICAgIGZoLndyaXRlKHN0cikKICAgICAgICBmaC5jbG9zZSgpCgogICAgZGVmIGJ5dGVzX3RvX2h1bWFuKHNlbGYsIHNpemUpOgogICAgICAgIHJldHVybiBieXRlc190b19odW1hbihzaXplKQoKICAgICMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CiAgICBwcmV0dHlfYnl0ZXMgPSBieXRlc190b19odW1hbgoKICAgIGRlZiBodW1hbl90b19ieXRlcyhzZWxmLCBudW1iZXIsIGlzYml0cz1GYWxzZSk6CiAgICAgICAgcmV0dXJuIGh1bWFuX3RvX2J5dGVzKG51bWJlciwgaXNiaXRzKQoKICAgICMKICAgICMgQmFja3dhcmRzIGNvbXBhdAogICAgIwoKICAgICMgSW4gMi4wLCBtb3ZlZCBmcm9tIGluc2lkZSB0aGUgbW9kdWxlIHRvIHRoZSB0b3BsZXZlbAogICAgaXNfZXhlY3V0YWJsZSA9IGlzX2V4ZWN1dGFibGUKCgpkZWYgZ2V0X21vZHVsZV9wYXRoKCk6CiAgICByZXR1cm4gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGgucmVhbHBhdGgoX19maWxlX18pKQpQSwMEFAAAAAAA1LsrSzvSQ9NgNQAAYDUAABoAAABhbnNpYmxlL21vZHVsZV91dGlscy9jZS5weSMKIyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgKGMpIDIwMTcgUmVkIEhhdCwgSW5jLgojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwKIyBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiMgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICAgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICAgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKIyBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAojIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4KIyBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwKIyBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sCiMgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCiMgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVAojIExJQUJJTElUWSwgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRQojIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCgppbXBvcnQgcmUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuYmFzaWMgaW1wb3J0IGVudl9mYWxsYmFjawpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLm5ldHdvcmtfY29tbW9uIGltcG9ydCB0b19saXN0LCBDb21wbGV4TGlzdApmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmNvbm5lY3Rpb24gaW1wb3J0IGV4ZWNfY29tbWFuZApmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnB5Y29tcGF0MjQgaW1wb3J0IGdldF9leGNlcHRpb24KZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IGl0ZXJpdGVtcwoKCnRyeToKICAgIGZyb20gbmNjbGllbnQgaW1wb3J0IG1hbmFnZXIsIHhtbF8KICAgIGZyb20gbmNjbGllbnQub3BlcmF0aW9ucy5ycGMgaW1wb3J0IFJQQ0Vycm9yCiAgICBmcm9tIG5jY2xpZW50LnRyYW5zcG9ydC5lcnJvcnMgaW1wb3J0IEF1dGhlbnRpY2F0aW9uRXJyb3IKICAgIGZyb20gbmNjbGllbnQub3BlcmF0aW9ucy5lcnJvcnMgaW1wb3J0IFRpbWVvdXRFeHBpcmVkRXJyb3IKICAgIEhBU19OQ0NMSUVOVCA9IFRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgSEFTX05DQ0xJRU5UID0gRmFsc2UKCgpfREVWSUNFX0NMSV9DT05ORUNUSU9OID0gTm9uZQpfREVWSUNFX05DX0NPTk5FQ1RJT04gPSBOb25lCgpjZV9hcmd1bWVudF9zcGVjID0gewogICAgJ2hvc3QnOiBkaWN0KCksCiAgICAncG9ydCc6IGRpY3QodHlwZT0naW50JyksCiAgICAndXNlcm5hbWUnOiBkaWN0KGZhbGxiYWNrPShlbnZfZmFsbGJhY2ssIFsnQU5TSUJMRV9ORVRfVVNFUk5BTUUnXSkpLAogICAgJ3Bhc3N3b3JkJzogZGljdChmYWxsYmFjaz0oZW52X2ZhbGxiYWNrLCBbJ0FOU0lCTEVfTkVUX1BBU1NXT1JEJ10pLCBub19sb2c9VHJ1ZSksCiAgICAndXNlX3NzbCc6IGRpY3QodHlwZT0nYm9vbCcpLAogICAgJ3ZhbGlkYXRlX2NlcnRzJzogZGljdCh0eXBlPSdib29sJyksCiAgICAndGltZW91dCc6IGRpY3QodHlwZT0naW50JyksCiAgICAncHJvdmlkZXInOiBkaWN0KHR5cGU9J2RpY3QnLCBub19sb2c9VHJ1ZSksCiAgICAndHJhbnNwb3J0JzogZGljdChjaG9pY2VzPVsnY2xpJ10pCn0KCgpkZWYgY2hlY2tfYXJncyhtb2R1bGUsIHdhcm5pbmdzKToKICAgIHByb3ZpZGVyID0gbW9kdWxlLnBhcmFtc1sncHJvdmlkZXInXSBvciB7fQogICAgZm9yIGtleSBpbiBjZV9hcmd1bWVudF9zcGVjOgogICAgICAgIGlmIGtleSBub3QgaW4gWydwcm92aWRlcicsICd0cmFuc3BvcnQnXSBhbmQgbW9kdWxlLnBhcmFtc1trZXldOgogICAgICAgICAgICB3YXJuaW5ncy5hcHBlbmQoJ2FyZ3VtZW50ICVzIGhhcyBiZWVuIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JlbW92ZWQgaW4gYSBmdXR1cmUgdmVyc2lvbicgJSBrZXkpCgoKZGVmIGxvYWRfcGFyYW1zKG1vZHVsZSk6CiAgICBwcm92aWRlciA9IG1vZHVsZS5wYXJhbXMuZ2V0KCdwcm92aWRlcicpIG9yIGRpY3QoKQogICAgZm9yIGtleSwgdmFsdWUgaW4gaXRlcml0ZW1zKHByb3ZpZGVyKToKICAgICAgICBpZiBrZXkgaW4gY2VfYXJndW1lbnRfc3BlYzoKICAgICAgICAgICAgaWYgbW9kdWxlLnBhcmFtcy5nZXQoa2V5KSBpcyBOb25lIGFuZCB2YWx1ZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIG1vZHVsZS5wYXJhbXNba2V5XSA9IHZhbHVlCgoKZGVmIGdldF9jb25uZWN0aW9uKG1vZHVsZSk6CiAgICBnbG9iYWwgX0RFVklDRV9DTElfQ09OTkVDVElPTgogICAgaWYgbm90IF9ERVZJQ0VfQ0xJX0NPTk5FQ1RJT046CiAgICAgICAgbG9hZF9wYXJhbXMobW9kdWxlKQogICAgICAgIGNvbm4gPSBDbGkobW9kdWxlKQogICAgICAgIF9ERVZJQ0VfQ0xJX0NPTk5FQ1RJT04gPSBjb25uCiAgICByZXR1cm4gX0RFVklDRV9DTElfQ09OTkVDVElPTgoKCmRlZiBybV9jb25maWdfcHJlZml4KGNmZyk6CiAgICBpZiBub3QgY2ZnOgogICAgICAgIHJldHVybiBjZmcKCiAgICBjbWRzID0gY2ZnLnNwbGl0KCJcbiIpCiAgICBmb3IgaSBpbiByYW5nZShsZW4oY21kcykpOgogICAgICAgIGlmIG5vdCBjbWRzW2ldOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIGlmICd+JyBpbiBjbWRzW2ldOgogICAgICAgICAgICBpbmRleCA9IGNtZHNbaV0uaW5kZXgoJ34nKQogICAgICAgICAgICBpZiBjbWRzW2ldWzppbmRleF0gPT0gJyAnICogaW5kZXg6CiAgICAgICAgICAgICAgICBjbWRzW2ldID0gY21kc1tpXS5yZXBsYWNlKCJ+IiwgIiIsIDEpCiAgICByZXR1cm4gJ1xuJy5qb2luKGNtZHMpCgoKY2xhc3MgQ2xpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBtb2R1bGUpOgogICAgICAgIHNlbGYuX21vZHVsZSA9IG1vZHVsZQogICAgICAgIHNlbGYuX2RldmljZV9jb25maWdzID0ge30KCiAgICBkZWYgZXhlY19jb21tYW5kKHNlbGYsIGNvbW1hbmQpOgogICAgICAgIGlmIGlzaW5zdGFuY2UoY29tbWFuZCwgZGljdCk6CiAgICAgICAgICAgIGNvbW1hbmQgPSBzZWxmLl9tb2R1bGUuanNvbmlmeShjb21tYW5kKQoKICAgICAgICByZXR1cm4gZXhlY19jb21tYW5kKHNlbGYuX21vZHVsZSwgY29tbWFuZCkKCiAgICBkZWYgZ2V0X2NvbmZpZyhzZWxmLCBmbGFncz1bXSk6CiAgICAgICAgIiIiUmV0cmlldmVzIHRoZSBjdXJyZW50IGNvbmZpZyBmcm9tIHRoZSBkZXZpY2Ugb3IgY2FjaGUKICAgICAgICAiIiIKICAgICAgICBjbWQgPSAnZGlzcGxheSBjdXJyZW50LWNvbmZpZ3VyYXRpb24gJwogICAgICAgIGNtZCArPSAnICcuam9pbihmbGFncykKICAgICAgICBjbWQgPSBjbWQuc3RyaXAoKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9kZXZpY2VfY29uZmlnc1tjbWRdCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLmV4ZWNfY29tbWFuZChjbWQpCiAgICAgICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgICAgICBzZWxmLl9tb2R1bGUuZmFpbF9qc29uKG1zZz1lcnIpCiAgICAgICAgICAgIGNmZyA9IHN0cihvdXQpLnN0cmlwKCkKICAgICAgICAgICAgIyByZW1vdmUgZGVmYXVsdCBjb25maWd1cmF0aW9uIHByZWZpeCAnficKICAgICAgICAgICAgZm9yIGZsYWcgaW4gZmxhZ3M6CiAgICAgICAgICAgICAgICBpZiAiaW5jbHVkZS1kZWZhdWx0IiBpbiBmbGFnOgogICAgICAgICAgICAgICAgICAgIGNmZyA9IHJtX2NvbmZpZ19wcmVmaXgoY2ZnKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBzZWxmLl9kZXZpY2VfY29uZmlnc1tjbWRdID0gY2ZnCiAgICAgICAgICAgIHJldHVybiBjZmcKCiAgICBkZWYgcnVuX2NvbW1hbmRzKHNlbGYsIGNvbW1hbmRzLCBjaGVja19yYz1UcnVlKToKICAgICAgICAiIiJSdW4gbGlzdCBvZiBjb21tYW5kcyBvbiByZW1vdGUgZGV2aWNlIGFuZCByZXR1cm4gcmVzdWx0cwogICAgICAgICIiIgogICAgICAgIHJlc3BvbnNlcyA9IGxpc3QoKQoKICAgICAgICBmb3IgaXRlbSBpbiB0b19saXN0KGNvbW1hbmRzKToKICAgICAgICAgICAgY21kID0gaXRlbVsnY29tbWFuZCddCgogICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLmV4ZWNfY29tbWFuZChjbWQpCgogICAgICAgICAgICBpZiBjaGVja19yYyBhbmQgcmMgIT0gMDoKICAgICAgICAgICAgICAgIHNlbGYuX21vZHVsZS5mYWlsX2pzb24obXNnPWNsaV9lcnJfbXNnKGNtZC5zdHJpcCgpLCBlcnIpKQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3V0ID0gc2VsZi5fbW9kdWxlLmZyb21fanNvbihvdXQpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgb3V0ID0gc3RyKG91dCkuc3RyaXAoKQoKICAgICAgICAgICAgcmVzcG9uc2VzLmFwcGVuZChvdXQpCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlcwoKICAgIGRlZiBsb2FkX2NvbmZpZyhzZWxmLCBjb25maWcpOgogICAgICAgICIiIlNlbmRzIGNvbmZpZ3VyYXRpb24gY29tbWFuZHMgdG8gdGhlIHJlbW90ZSBkZXZpY2UKICAgICAgICAiIiIKICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLmV4ZWNfY29tbWFuZCgnbW1pLW1vZGUgZW5hYmxlJykKICAgICAgICBpZiByYyAhPSAwOgogICAgICAgICAgICBzZWxmLl9tb2R1bGUuZmFpbF9qc29uKG1zZz0ndW5hYmxlIHRvIHNldCBtbWktbW9kZSBlbmFibGUnLCBvdXRwdXQ9ZXJyKQogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYuZXhlY19jb21tYW5kKCdzeXN0ZW0tdmlldyBpbW1lZGlhdGVseScpCiAgICAgICAgaWYgcmMgIT0gMDoKICAgICAgICAgICAgc2VsZi5fbW9kdWxlLmZhaWxfanNvbihtc2c9J3VuYWJsZSB0byBlbnRlciBzeXN0ZW0tdmlldycsIG91dHB1dD1lcnIpCgogICAgICAgIGZvciBjbWQgaW4gY29uZmlnOgogICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLmV4ZWNfY29tbWFuZChjbWQpCiAgICAgICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgICAgICBzZWxmLl9tb2R1bGUuZmFpbF9qc29uKG1zZz1jbGlfZXJyX21zZyhjbWQuc3RyaXAoKSwgZXJyKSkKCiAgICAgICAgc2VsZi5leGVjX2NvbW1hbmQoJ3JldHVybicpCgoKZGVmIGNsaV9lcnJfbXNnKGNtZCwgZXJyKToKICAgICIiIiBnZXQgY2xpIGV4Y2VwdGlvbiBtZXNzYWdlIiIiCgogICAgaWYgbm90IGVycjoKICAgICAgICByZXR1cm4gIkVycm9yOiBGYWlsIHRvIGdldCBjbGkgZXhjZXB0aW9uIG1lc3NhZ2UuIgoKICAgIG1zZyA9IGxpc3QoKQogICAgZXJyX2xpc3QgPSBzdHIoZXJyKS5zcGxpdCgiXHJcbiIpCiAgICBmb3IgZXJyIGluIGVycl9saXN0OgogICAgICAgIGVyciA9IGVyci5zdHJpcCgnLixcclxuXHQgJykKICAgICAgICBpZiBub3QgZXJyOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIGlmIGNtZCBhbmQgY21kID09IGVycjoKICAgICAgICAgICAgY29udGludWUKICAgICAgICBpZiAiIGF0ICdeJyBwb3NpdGlvbiIgaW4gZXJyOgogICAgICAgICAgICBlcnIgPSBlcnIucmVwbGFjZSgiIGF0ICdeJyBwb3NpdGlvbiIsICIiKS5zdHJpcCgpCiAgICAgICAgZXJyID0gZXJyLnN0cmlwKCcuLFxyXG5cdCAnKQogICAgICAgIGlmIGVyciA9PSAiXiI6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgaWYgbGVuKGVycikgPiAyIGFuZCBlcnJbMF0gaW4gWyI8IiwgIlsiXSBhbmQgZXJyWy0xXSBpbiBbIj4iLCAiXSJdOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIGVyci5zdHJpcCgnLixcclxuXHQgJykKICAgICAgICBpZiBlcnI6CiAgICAgICAgICAgIG1zZy5hcHBlbmQoZXJyKQoKICAgIGlmIGNtZDoKICAgICAgICBtc2cuaW5zZXJ0KDAsICJDb21tYW5kOiAlcyIgJSBjbWQpCgogICAgcmV0dXJuICIsICIuam9pbihtc2cpLmNhcGl0YWxpemUoKSArICIuIgoKCmRlZiB0b19jb21tYW5kKG1vZHVsZSwgY29tbWFuZHMpOgogICAgZGVmYXVsdF9vdXRwdXQgPSAndGV4dCcKICAgIHRyYW5zZm9ybSA9IENvbXBsZXhMaXN0KGRpY3QoCiAgICAgICAgY29tbWFuZD1kaWN0KGtleT1UcnVlKSwKICAgICAgICBvdXRwdXQ9ZGljdChkZWZhdWx0PWRlZmF1bHRfb3V0cHV0KSwKICAgICAgICBwcm9tcHQ9ZGljdCgpLAogICAgICAgIHJlc3BvbnNlPWRpY3QoKQogICAgKSwgbW9kdWxlKQoKICAgIGNvbW1hbmRzID0gdHJhbnNmb3JtKHRvX2xpc3QoY29tbWFuZHMpKQoKICAgIHJldHVybiBjb21tYW5kcwoKCmRlZiBnZXRfY29uZmlnKG1vZHVsZSwgZmxhZ3M9W10pOgogICAgY29ubiA9IGdldF9jb25uZWN0aW9uKG1vZHVsZSkKICAgIHJldHVybiBjb25uLmdldF9jb25maWcoZmxhZ3MpCgoKZGVmIHJ1bl9jb21tYW5kcyhtb2R1bGUsIGNvbW1hbmRzLCBjaGVja19yYz1UcnVlKToKICAgIGNvbm4gPSBnZXRfY29ubmVjdGlvbihtb2R1bGUpCiAgICByZXR1cm4gY29ubi5ydW5fY29tbWFuZHModG9fY29tbWFuZChtb2R1bGUsIGNvbW1hbmRzKSwgY2hlY2tfcmMpCgoKZGVmIGxvYWRfY29uZmlnKG1vZHVsZSwgY29uZmlnKToKICAgIGNvbm4gPSBnZXRfY29ubmVjdGlvbihtb2R1bGUpCiAgICByZXR1cm4gY29ubi5sb2FkX2NvbmZpZyhjb25maWcpCgoKZGVmIGNlX3Vua25vd25faG9zdF9jYihob3N0LCBmaW5nZXJwcmludCk6CiAgICAiIiIgY2VfdW5rbm93bl9ob3N0X2NiICIiIgoKICAgIHJldHVybiBUcnVlCgoKZGVmIGdldF9uY19zZXRfaWQoeG1sX3N0cik6CiAgICAiIiJnZXQgbmV0Y29uZiBzZXQtaWQgdmFsdWUiIiIKCiAgICByZXN1bHQgPSByZS5maW5kYWxsKHInPHJwYy1yZXBseS4rP3NldC1pZD1cIihcZCspXCInLCB4bWxfc3RyKQogICAgaWYgbm90IHJlc3VsdDoKICAgICAgICByZXR1cm4gTm9uZQogICAgcmV0dXJuIHJlc3VsdFswXQoKCmRlZiBnZXRfeG1sX2xpbmUoeG1sX2xpc3QsIGluZGV4KToKICAgICIiImdldCB4bWwgc3BlY2lmaWVkIGxpbmUgdmFsaWQgc3RyaW5nIGRhdGEiIiIKCiAgICBlbGUgPSBOb25lCiAgICB3aGlsZSB4bWxfbGlzdCBhbmQgbm90IGVsZToKICAgICAgICBpZiBpbmRleCA+PSAwIGFuZCBpbmRleCA+PSBsZW4oeG1sX2xpc3QpOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIGluZGV4IDwgMCBhbmQgYWJzKGluZGV4KSA+IGxlbih4bWxfbGlzdCk6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIGVsZSA9IHhtbF9saXN0W2luZGV4XQogICAgICAgIGlmIG5vdCBlbGUucmVwbGFjZSgiICIsICIiKToKICAgICAgICAgICAgeG1sX2xpc3QucG9wKGluZGV4KQogICAgICAgICAgICBlbGUgPSBOb25lCiAgICByZXR1cm4gZWxlCgoKZGVmIG1lcmdlX25jX3htbCh4bWwxLCB4bWwyKToKICAgICIiIm1lcmdlIHhtbDEgYW5kIHhtbDIiIiIKCiAgICB4bWwxX2xpc3QgPSB4bWwxLnNwbGl0KCI8L2RhdGE+IilbMF0uc3BsaXQoIlxuIikKICAgIHhtbDJfbGlzdCA9IHhtbDIuc3BsaXQoIjxkYXRhPiIpWzFdLnNwbGl0KCJcbiIpCgogICAgd2hpbGUgVHJ1ZToKICAgICAgICB4bWwxX2VsZTEgPSBnZXRfeG1sX2xpbmUoeG1sMV9saXN0LCAtMSkKICAgICAgICB4bWwxX2VsZTIgPSBnZXRfeG1sX2xpbmUoeG1sMV9saXN0LCAtMikKICAgICAgICB4bWwyX2VsZTEgPSBnZXRfeG1sX2xpbmUoeG1sMl9saXN0LCAwKQogICAgICAgIHhtbDJfZWxlMiA9IGdldF94bWxfbGluZSh4bWwyX2xpc3QsIDEpCiAgICAgICAgaWYgbm90IHhtbDFfZWxlMSBvciBub3QgeG1sMV9lbGUyIG9yIG5vdCB4bWwyX2VsZTEgb3Igbm90IHhtbDJfZWxlMjoKICAgICAgICAgICAgcmV0dXJuIHhtbDEKCiAgICAgICAgaWYgInhtbG5zIiBpbiB4bWwyX2VsZTE6CiAgICAgICAgICAgIHhtbDJfZWxlMSA9IHhtbDJfZWxlMS5sc3RyaXAoKS5zcGxpdCgiICIpWzBdICsgIj4iCiAgICAgICAgaWYgInhtbG5zIiBpbiB4bWwyX2VsZTI6CiAgICAgICAgICAgIHhtbDJfZWxlMiA9IHhtbDJfZWxlMi5sc3RyaXAoKS5zcGxpdCgiICIpWzBdICsgIj4iCiAgICAgICAgaWYgeG1sMV9lbGUxLnJlcGxhY2UoIiAiLCAiIikucmVwbGFjZSgiLyIsICIiKSA9PSB4bWwyX2VsZTEucmVwbGFjZSgiICIsICIiKS5yZXBsYWNlKCIvIiwgIiIpOgogICAgICAgICAgICBpZiB4bWwxX2VsZTIucmVwbGFjZSgiICIsICIiKS5yZXBsYWNlKCIvIiwgIiIpID09IHhtbDJfZWxlMi5yZXBsYWNlKCIgIiwgIiIpLnJlcGxhY2UoIi8iLCAiIik6CiAgICAgICAgICAgICAgICB4bWwxX2xpc3QucG9wKCkKICAgICAgICAgICAgICAgIHhtbDJfbGlzdC5wb3AoMCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYnJlYWsKCiAgICByZXR1cm4gIlxuIi5qb2luKHhtbDFfbGlzdCArIHhtbDJfbGlzdCkKCgpjbGFzcyBOZXRjb25mKG9iamVjdCk6CiAgICAiIiIgTmV0Y29uZiAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbW9kdWxlKToKCiAgICAgICAgc2VsZi5fbW9kdWxlID0gbW9kdWxlCgogICAgICAgIGlmIG5vdCBIQVNfTkNDTElFTlQ6CiAgICAgICAgICAgIHNlbGYuX21vZHVsZS5mYWlsX2pzb24obXNnPSdFcnJvcjogVGhlIG5jY2xpZW50IGxpYnJhcnkgaXMgcmVxdWlyZWQuJykKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLm1jID0gbWFuYWdlci5jb25uZWN0KGhvc3Q9bW9kdWxlLnBhcmFtc1siaG9zdCJdLCBwb3J0PW1vZHVsZS5wYXJhbXNbInBvcnQiXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZT1tb2R1bGUucGFyYW1zWyJ1c2VybmFtZSJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkPW1vZHVsZS5wYXJhbXNbInBhc3N3b3JkIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5rbm93bl9ob3N0X2NiPWNlX3Vua25vd25faG9zdF9jYiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvd19hZ2VudD1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29rX2Zvcl9rZXlzPUZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RrZXlfdmVyaWZ5PUZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZV9wYXJhbXM9eyduYW1lJzogJ2h1YXdlaSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQ9MzApCiAgICAgICAgZXhjZXB0IEF1dGhlbnRpY2F0aW9uRXJyb3I6CiAgICAgICAgICAgIHNlbGYuX21vZHVsZS5mYWlsX2pzb24obXNnPSdFcnJvcjogQXV0aGVudGljYXRpb24gZmFpbGVkIHdoaWxlIGNvbm5lY3RpbmcgdG8gZGV2aWNlLicpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZXJyID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYuX21vZHVsZS5mYWlsX2pzb24obXNnPSdFcnJvcjogJXMnICUgc3RyKGVycikucmVwbGFjZSgiXHJcbiIsICIiKSkKICAgICAgICAgICAgcmFpc2UKCiAgICBkZWYgX19kZWxfXyhzZWxmKToKCiAgICAgICAgc2VsZi5tYy5jbG9zZV9zZXNzaW9uKCkKCiAgICBkZWYgc2V0X2NvbmZpZyhzZWxmLCB4bWxfc3RyKToKICAgICAgICAiIiIgc2V0X2NvbmZpZyAiIiIKCiAgICAgICAgY29uX29iaiA9IE5vbmUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb25fb2JqID0gc2VsZi5tYy5lZGl0X2NvbmZpZyh0YXJnZXQ9J3J1bm5pbmcnLCBjb25maWc9eG1sX3N0cikKICAgICAgICBleGNlcHQgUlBDRXJyb3I6CiAgICAgICAgICAgIGVyciA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLl9tb2R1bGUuZmFpbF9qc29uKG1zZz0nRXJyb3I6ICVzJyAlIHN0cihlcnIpLnJlcGxhY2UoIlxyXG4iLCAiIikpCgogICAgICAgIHJldHVybiBjb25fb2JqLnhtbAoKICAgIGRlZiBnZXRfY29uZmlnKHNlbGYsIHhtbF9zdHIpOgogICAgICAgICIiIiBnZXRfY29uZmlnICIiIgoKICAgICAgICBjb25fb2JqID0gTm9uZQogICAgICAgIHRyeToKICAgICAgICAgICAgY29uX29iaiA9IHNlbGYubWMuZ2V0KGZpbHRlcj14bWxfc3RyKQogICAgICAgIGV4Y2VwdCBSUENFcnJvcjoKICAgICAgICAgICAgZXJyID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYuX21vZHVsZS5mYWlsX2pzb24obXNnPSdFcnJvcjogJXMnICUgc3RyKGVycikucmVwbGFjZSgiXHJcbiIsICIiKSkKCiAgICAgICAgc2V0X2lkID0gZ2V0X25jX3NldF9pZChjb25fb2JqLnhtbCkKICAgICAgICBpZiBub3Qgc2V0X2lkOgogICAgICAgICAgICByZXR1cm4gY29uX29iai54bWwKCiAgICAgICAgIyBjb250aW51ZSB0byBnZXQgbmV4dAogICAgICAgIHhtbF9zdHIgPSBjb25fb2JqLnhtbAogICAgICAgIHdoaWxlIHNldF9pZDoKICAgICAgICAgICAgc2V0X2F0dHIgPSBkaWN0KCkKICAgICAgICAgICAgc2V0X2F0dHJbInNldC1pZCJdID0gc3RyKHNldF9pZCkKICAgICAgICAgICAgeHNkX2ZldGNoID0geG1sXy5uZXdfZWxlX25zKCdnZXQtbmV4dCcsICJodHRwOi8vd3d3Lmh1YXdlaS5jb20vbmV0Y29uZi9jYXBhYmlsaXR5L2Jhc2UvMS4wIiwgc2V0X2F0dHIpCiAgICAgICAgICAgICMgZ2V0IG5leHQgZGF0YQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBjb25fb2JqX25leHQgPSBzZWxmLm1jLmRpc3BhdGNoKHhzZF9mZXRjaCkKICAgICAgICAgICAgZXhjZXB0IFJQQ0Vycm9yOgogICAgICAgICAgICAgICAgZXJyID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLl9tb2R1bGUuZmFpbF9qc29uKG1zZz0nRXJyb3I6ICVzJyAlIHN0cihlcnIpLnJlcGxhY2UoIlxyXG4iLCAiIikpCgogICAgICAgICAgICBpZiAiPGRhdGEvPiIgaW4gY29uX29ial9uZXh0LnhtbDoKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICAjIG1lcmdlIHR3byB4bWwgZGF0YQogICAgICAgICAgICB4bWxfc3RyID0gbWVyZ2VfbmNfeG1sKHhtbF9zdHIsIGNvbl9vYmpfbmV4dC54bWwpCiAgICAgICAgICAgIHNldF9pZCA9IGdldF9uY19zZXRfaWQoY29uX29ial9uZXh0LnhtbCkKCiAgICAgICAgcmV0dXJuIHhtbF9zdHIKCiAgICBkZWYgZXhlY3V0ZV9hY3Rpb24oc2VsZiwgeG1sX3N0cik6CiAgICAgICAgIiIiaHVhd2VpIGV4ZWN1dGUtYWN0aW9uIiIiCgogICAgICAgIGNvbl9vYmogPSBOb25lCgogICAgICAgIHRyeToKICAgICAgICAgICAgY29uX29iaiA9IHNlbGYubWMuYWN0aW9uKGFjdGlvbj14bWxfc3RyKQogICAgICAgIGV4Y2VwdCBSUENFcnJvcjoKICAgICAgICAgICAgZXJyID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYuX21vZHVsZS5mYWlsX2pzb24obXNnPSdFcnJvcjogJXMnICUgc3RyKGVycikucmVwbGFjZSgiXHJcbiIsICIiKSkKICAgICAgICBleGNlcHQgVGltZW91dEV4cGlyZWRFcnJvcjoKICAgICAgICAgICAgcmFpc2UKCiAgICAgICAgcmV0dXJuIGNvbl9vYmoueG1sCgogICAgZGVmIGV4ZWN1dGVfY2xpKHNlbGYsIHhtbF9zdHIpOgogICAgICAgICIiImh1YXdlaSBleGVjdXRlLWNsaSIiIgoKICAgICAgICBjb25fb2JqID0gTm9uZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbl9vYmogPSBzZWxmLm1jLmNsaShjb21tYW5kPXhtbF9zdHIpCiAgICAgICAgZXhjZXB0IFJQQ0Vycm9yOgogICAgICAgICAgICBlcnIgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5fbW9kdWxlLmZhaWxfanNvbihtc2c9J0Vycm9yOiAlcycgJSBzdHIoZXJyKS5yZXBsYWNlKCJcclxuIiwgIiIpKQoKICAgICAgICByZXR1cm4gY29uX29iai54bWwKCgpkZWYgZ2V0X25jX2Nvbm5lY3Rpb24obW9kdWxlKToKICAgIGdsb2JhbCBfREVWSUNFX05DX0NPTk5FQ1RJT04KICAgIGlmIG5vdCBfREVWSUNFX05DX0NPTk5FQ1RJT046CiAgICAgICAgbG9hZF9wYXJhbXMobW9kdWxlKQogICAgICAgIGNvbm4gPSBOZXRjb25mKG1vZHVsZSkKICAgICAgICBfREVWSUNFX05DX0NPTk5FQ1RJT04gPSBjb25uCiAgICByZXR1cm4gX0RFVklDRV9OQ19DT05ORUNUSU9OCgoKZGVmIHNldF9uY19jb25maWcobW9kdWxlLCB4bWxfc3RyKToKICAgICIiIiBzZXRfY29uZmlnICIiIgoKICAgIGNvbm4gPSBnZXRfbmNfY29ubmVjdGlvbihtb2R1bGUpCiAgICByZXR1cm4gY29ubi5zZXRfY29uZmlnKHhtbF9zdHIpCgoKZGVmIGdldF9uY19jb25maWcobW9kdWxlLCB4bWxfc3RyKToKICAgICIiIiBnZXRfY29uZmlnICIiIgoKICAgIGNvbm4gPSBnZXRfbmNfY29ubmVjdGlvbihtb2R1bGUpCiAgICByZXR1cm4gY29ubi5nZXRfY29uZmlnKHhtbF9zdHIpCgoKZGVmIGV4ZWN1dGVfbmNfYWN0aW9uKG1vZHVsZSwgeG1sX3N0cik6CiAgICAiIiIgaHVhd2VpIGV4ZWN1dGUtYWN0aW9uICIiIgoKICAgIGNvbm4gPSBnZXRfbmNfY29ubmVjdGlvbihtb2R1bGUpCiAgICByZXR1cm4gY29ubi5leGVjdXRlX2FjdGlvbih4bWxfc3RyKQoKCmRlZiBleGVjdXRlX25jX2NsaShtb2R1bGUsIHhtbF9zdHIpOgogICAgIiIiIGh1YXdlaSBleGVjdXRlLWNsaSAiIiIKCiAgICBjb25uID0gZ2V0X25jX2Nvbm5lY3Rpb24obW9kdWxlKQogICAgcmV0dXJuIGNvbm4uZXhlY3V0ZV9jbGkoeG1sX3N0cikKUEsDBBQAAAAAANS7K0u12AQGJTAAACUwAAAdAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX3RleHQucHkjIFRoaXMgY29kZSBpcyBwYXJ0IG9mIEFuc2libGUsIGJ1dCBpcyBhbiBpbmRlcGVuZGVudCBjb21wb25lbnQuCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgQ29weXJpZ2h0IChjKSwgVG9zaGlvIEt1cmF0b21pIDxhLmJhZGdlckBnbWFpbC5jb20+LCAyMDE2CiMKIyBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQgbW9kaWZpY2F0aW9uLAojIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKIwojICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKIyAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwKIyAgICAgIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24KIyAgICAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORAojIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVECiMgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRSBESVNDTEFJTUVELgojIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULAojIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywKIyBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MKIyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUCiMgTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFCiMgVVNFIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiMKCiIiIgouLiB3YXJuOjogVGhpcyBtb2R1bGVfdXRpbCBpcyBjdXJyZW50bHkgaW50ZXJuYWwgaW1wbGVtZW50YXRpb24uCiAgICBXZSB3YW50IHRvIGV2YWx1YXRlIHRoaXMgY29kZSBmb3Igc3RhYmlsaXR5IGFuZCBBUEkgc3VpdGFiaWxpdHkgYmVmb3JlCiAgICBtYWtpbmcgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgZ3VhcmFudGVlcy4gIFRoZSBBUEkgbWF5IGNoYW5nZSBiZXR3ZWVuCiAgICByZWxlYXNlcy4gIERvIG5vdCB1c2UgdGhpcyB1bmxlc3MgeW91IGFyZSB3aWxsaW5nIHRvIHBvcnQgeW91ciBtb2R1bGUgY29kZS4KIiIiCmltcG9ydCBjb2RlY3MKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGltcG9ydCBQWTMsIHRleHRfdHlwZSwgYmluYXJ5X3R5cGUKCgp0cnk6CiAgICBjb2RlY3MubG9va3VwX2Vycm9yKCdzdXJyb2dhdGVlc2NhcGUnKQogICAgSEFTX1NVUlJPR0FURUVTQ0FQRSA9IFRydWUKZXhjZXB0IExvb2t1cEVycm9yOgogICAgSEFTX1NVUlJPR0FURUVTQ0FQRSA9IEZhbHNlCgoKX0NPTVBPU0VEX0VSUk9SX0hBTkRMRVJTID0gZnJvemVuc2V0KChOb25lLCAnc3Vycm9nYXRlX29yX2VzY2FwZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3Vycm9nYXRlX29yX3N0cmljdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3Vycm9nYXRlX3RoZW5fcmVwbGFjZScpKQoKCmRlZiB0b19ieXRlcyhvYmosIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz1Ob25lLCBub25zdHJpbmc9J3NpbXBsZXJlcHInKToKICAgICIiIk1ha2Ugc3VyZSB0aGF0IGEgc3RyaW5nIGlzIGEgYnl0ZSBzdHJpbmcKCiAgICA6YXJnIG9iajogQW4gb2JqZWN0IHRvIG1ha2Ugc3VyZSBpcyBhIGJ5dGUgc3RyaW5nLiAgSW4gbW9zdCBjYXNlcyB0aGlzCiAgICAgICAgd2lsbCBiZSBlaXRoZXIgYSB0ZXh0IHN0cmluZyBvciBhIGJ5dGUgc3RyaW5nLiAgSG93ZXZlciwgd2l0aAogICAgICAgIGBgbm9uc3RyaW5nPSdzaW1wbGVyZXByJ2BgLCB0aGlzIGNhbiBiZSB1c2VkIGFzIGEgdHJhY2ViYWNrLWZyZWUKICAgICAgICB2ZXJzaW9uIG9mIGBgc3RyKG9iailgYC4KICAgIDprd2FyZyBlbmNvZGluZzogVGhlIGVuY29kaW5nIHRvIHVzZSB0byB0cmFuc2Zvcm0gZnJvbSBhIHRleHQgc3RyaW5nIHRvCiAgICAgICAgYSBieXRlIHN0cmluZy4gIERlZmF1bHRzIHRvIHVzaW5nICd1dGYtOCcuCiAgICA6a3dhcmcgZXJyb3JzOiBUaGUgZXJyb3IgaGFuZGxlciB0byB1c2UgaWYgdGhlIHRleHQgc3RyaW5nIGlzIG5vdAogICAgICAgIGVuY29kYWJsZSB1c2luZyB0aGUgc3BlY2lmaWVkIGVuY29kaW5nLiAgQW55IHZhbGlkIGBjb2RlY3MgZXJyb3IKICAgICAgICBoYW5kbGVyIDxodHRwczovL2RvY3MucHl0aG9uLm9yZy8yL2xpYnJhcnkvY29kZWNzLmh0bWwjY29kZWMtYmFzZS1jbGFzc2VzPmBfCiAgICAgICAgbWF5IGJlIHNwZWNpZmllZC4gVGhlcmUgYXJlIHRocmVlIGFkZGl0aW9uYWwgZXJyb3Igc3RyYXRlZ2llcwogICAgICAgIHNwZWNpZmljYWxseSBhaW1lZCBhdCBoZWxwaW5nIHBlb3BsZSB0byBwb3J0IGNvZGUuICBUaGUgZmlyc3QgdHdvIGFyZToKCiAgICAgICAgICAgIDpzdXJyb2dhdGVfb3Jfc3RyaWN0OiBXaWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSBgYHN0cmljdGBgCiAgICAgICAgICAgIDpzdXJyb2dhdGVfb3JfcmVwbGFjZTogV2lsbCB1c2UgYGBzdXJyb2dhdGVlc2NhcGVgYCBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLCBvdGhlcndpc2UgaXQgd2lsbCB1c2UgYGByZXBsYWNlYGAuCgogICAgICAgIEJlY2F1c2UgYGBzdXJyb2dhdGVlc2NhcGVgYCB3YXMgYWRkZWQgaW4gUHl0aG9uMyB0aGlzIHVzdWFsbHkgbWVhbnMgdGhhdAogICAgICAgIFB5dGhvbjMgd2lsbCB1c2UgYGBzdXJyb2dhdGVlc2NhcGVgYCBhbmQgUHl0aG9uMiB3aWxsIHVzZSB0aGUgZmFsbGJhY2sKICAgICAgICBlcnJvciBoYW5kbGVyLiBOb3RlIHRoYXQgdGhlIGNvZGUgY2hlY2tzIGZvciBgYHN1cnJvZ2F0ZWVzY2FwZWBgIHdoZW4gdGhlCiAgICAgICAgbW9kdWxlIGlzIGltcG9ydGVkLiAgSWYgeW91IGhhdmUgYSBiYWNrcG9ydCBvZiBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGZvcgogICAgICAgIFB5dGhvbjIsIGJlIHN1cmUgdG8gcmVnaXN0ZXIgdGhlIGVycm9yIGhhbmRsZXIgcHJpb3IgdG8gaW1wb3J0aW5nIHRoaXMKICAgICAgICBtb2R1bGUuCgogICAgICAgIFRoZSBsYXN0IGVycm9yIGhhbmRsZXIgaXM6CgogICAgICAgICAgICA6c3Vycm9nYXRlX3RoZW5fcmVwbGFjZTogV2lsbCB1c2UgYGBzdXJyb2dhdGVlc2NhcGVgYCBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLiAgSWYgZW5jb2Rpbmcgd2l0aCBgYHN1cnJvZ2F0ZWVzY2FwZWBgIHdvdWxkIHRyYWNlYmFjaywKICAgICAgICAgICAgICAgIHN1cnJvZ2F0ZXMgYXJlIGZpcnN0IHJlcGxhY2VkIHdpdGggYSByZXBsYWNlbWVudCBjaGFyYWN0ZXJzCiAgICAgICAgICAgICAgICBhbmQgdGhlbiB0aGUgc3RyaW5nIGlzIGVuY29kZWQgdXNpbmcgYGByZXBsYWNlYGAgKHdoaWNoIHJlcGxhY2VzCiAgICAgICAgICAgICAgICB0aGUgcmVzdCBvZiB0aGUgbm9uZW5jb2RhYmxlIGJ5dGVzKS4gIElmIGBgc3Vycm9nYXRlZXNjYXBlYGAgaXMKICAgICAgICAgICAgICAgIG5vdCBwcmVzZW50IGl0IHdpbGwgc2ltcGx5IHVzZSBgYHJlcGxhY2VgYC4gIChBZGRlZCBpbiBBbnNpYmxlIDIuMykKICAgICAgICAgICAgICAgIFRoaXMgc3RyYXRlZ3kgaXMgZGVzaWduZWQgdG8gbmV2ZXIgdHJhY2ViYWNrIHdoZW4gaXQgYXR0ZW1wdHMKICAgICAgICAgICAgICAgIHRvIGVuY29kZSBhIHN0cmluZy4KCiAgICAgICAgVGhlIGRlZmF1bHQgdW50aWwgQW5zaWJsZS0yLjIgd2FzIGBgc3Vycm9nYXRlX29yX3JlcGxhY2VgYAogICAgICAgIEZyb20gQW5zaWJsZS0yLjMgb253YXJkcywgdGhlIGRlZmF1bHQgaXMgYGBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlYGAuCgogICAgOmt3YXJnIG5vbnN0cmluZzogVGhlIHN0cmF0ZWd5IHRvIHVzZSBpZiBhIG5vbnN0cmluZyBpcyBzcGVjaWZpZWQgaW4KICAgICAgICBgYG9iamBgLiAgRGVmYXVsdCBpcyAnc2ltcGxlcmVwcicuICBWYWxpZCB2YWx1ZXMgYXJlOgoKICAgICAgICA6c2ltcGxlcmVwcjogVGhlIGRlZmF1bHQuICBUaGlzIHRha2VzIHRoZSBgYHN0cmBgIG9mIHRoZSBvYmplY3QgYW5kCiAgICAgICAgICAgIHRoZW4gcmV0dXJucyB0aGUgYnl0ZXMgdmVyc2lvbiBvZiB0aGF0IHN0cmluZy4KICAgICAgICA6ZW1wdHk6IFJldHVybiBhbiBlbXB0eSBieXRlIHN0cmluZwogICAgICAgIDpwYXNzdGhydTogUmV0dXJuIHRoZSBvYmplY3QgcGFzc2VkIGluCiAgICAgICAgOnN0cmljdDogUmFpc2UgYSA6ZXhjOmBUeXBlRXJyb3JgCgogICAgOnJldHVybnM6IFR5cGljYWxseSB0aGlzIHJldHVybnMgYSBieXRlIHN0cmluZy4gIElmIGEgbm9uc3RyaW5nIG9iamVjdCBpcwogICAgICAgIHBhc3NlZCBpbiB0aGlzIG1heSBiZSBhIGRpZmZlcmVudCB0eXBlIGRlcGVuZGluZyBvbiB0aGUgc3RyYXRlZ3kKICAgICAgICBzcGVjaWZpZWQgYnkgbm9uc3RyaW5nLiAgVGhpcyB3aWxsIG5ldmVyIHJldHVybiBhIHRleHQgc3RyaW5nLgoKICAgIC4uIG5vdGU6OiBJZiBwYXNzZWQgYSBieXRlIHN0cmluZywgdGhpcyBmdW5jdGlvbiBkb2VzIG5vdCBjaGVjayB0aGF0IHRoZQogICAgICAgIHN0cmluZyBpcyB2YWxpZCBpbiB0aGUgc3BlY2lmaWVkIGVuY29kaW5nLiAgSWYgaXQncyBpbXBvcnRhbnQgdGhhdCB0aGUKICAgICAgICBieXRlIHN0cmluZyBpcyBpbiB0aGUgc3BlY2lmaWVkIGVuY29kaW5nIGRvOjoKCiAgICAgICAgICAgIGVuY29kZWRfc3RyaW5nID0gdG9fYnl0ZXModG9fdGV4dChpbnB1dF9zdHJpbmcsICdsYXRpbi0xJyksICd1dGYtOCcpCgogICAgLi4gdmVyc2lvbl9jaGFuZ2VkOjogMi4zCgogICAgICAgIEFkZGVkIHRoZSBgYHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2VgYCBlcnJvciBoYW5kbGVyIGFuZCBtYWRlIGl0IHRoZSBkZWZhdWx0IGVycm9yIGhhbmRsZXIuCiAgICAiIiIKICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgcmV0dXJuIG9iagoKICAgICMgV2UncmUgZ2l2ZW4gYSB0ZXh0IHN0cmluZwogICAgIyBJZiBpdCBoYXMgc3Vycm9nYXRlcywgd2Uga25vdyBiZWNhdXNlIGl0IHdpbGwgZGVjb2RlCiAgICBvcmlnaW5hbF9lcnJvcnMgPSBlcnJvcnMKICAgIGlmIGVycm9ycyBpbiBfQ09NUE9TRURfRVJST1JfSEFORExFUlM6CiAgICAgICAgaWYgSEFTX1NVUlJPR0FURUVTQ0FQRToKICAgICAgICAgICAgZXJyb3JzID0gJ3N1cnJvZ2F0ZWVzY2FwZScKICAgICAgICBlbGlmIGVycm9ycyA9PSAnc3Vycm9nYXRlX29yX3N0cmljdCc6CiAgICAgICAgICAgIGVycm9ycyA9ICdzdHJpY3QnCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZXJyb3JzID0gJ3JlcGxhY2UnCgogICAgaWYgaXNpbnN0YW5jZShvYmosIHRleHRfdHlwZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFRyeSB0aGlzIGZpcnN0IGFzIGl0J3MgdGhlIGZhc3Rlc3QKICAgICAgICAgICAgcmV0dXJuIG9iai5lbmNvZGUoZW5jb2RpbmcsIGVycm9ycykKICAgICAgICBleGNlcHQgVW5pY29kZUVuY29kZUVycm9yOgogICAgICAgICAgICBpZiBvcmlnaW5hbF9lcnJvcnMgaW4gKE5vbmUsICdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJyk6CiAgICAgICAgICAgICAgICAjIFNsb3cgYnV0IHdvcmtzCiAgICAgICAgICAgICAgICByZXR1cm5fc3RyaW5nID0gb2JqLmVuY29kZSgndXRmLTgnLCAnc3Vycm9nYXRlZXNjYXBlJykKICAgICAgICAgICAgICAgIHJldHVybl9zdHJpbmcgPSByZXR1cm5fc3RyaW5nLmRlY29kZSgndXRmLTgnLCAncmVwbGFjZScpCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0dXJuX3N0cmluZy5lbmNvZGUoZW5jb2RpbmcsICdyZXBsYWNlJykKICAgICAgICAgICAgcmFpc2UKCiAgICAjIE5vdGU6IFdlIGRvIHRoZXNlIGxhc3QgZXZlbiB0aG91Z2ggd2UgaGF2ZSB0byBjYWxsIHRvX2J5dGVzIGFnYWluIG9uIHRoZQogICAgIyB2YWx1ZSBiZWNhdXNlIHdlJ3JlIG9wdGltaXppbmcgdGhlIGNvbW1vbiBjYXNlCiAgICBpZiBub25zdHJpbmcgPT0gJ3NpbXBsZXJlcHInOgogICAgICAgIHRyeToKICAgICAgICAgICAgdmFsdWUgPSBzdHIob2JqKQogICAgICAgIGV4Y2VwdCBVbmljb2RlRXJyb3I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHZhbHVlID0gcmVwcihvYmopCiAgICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRXJyb3I6CiAgICAgICAgICAgICAgICAjIEdpdmluZyB1cAogICAgICAgICAgICAgICAgcmV0dXJuIHRvX2J5dGVzKCcnKQogICAgZWxpZiBub25zdHJpbmcgPT0gJ3Bhc3N0aHJ1JzoKICAgICAgICByZXR1cm4gb2JqCiAgICBlbGlmIG5vbnN0cmluZyA9PSAnZW1wdHknOgogICAgICAgICMgcHl0aG9uMi40IGRvZXNuJ3QgaGF2ZSBiJycKICAgICAgICByZXR1cm4gdG9fYnl0ZXMoJycpCiAgICBlbGlmIG5vbnN0cmluZyA9PSAnc3RyaWN0JzoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ29iaiBtdXN0IGJlIGEgc3RyaW5nIHR5cGUnKQogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ0ludmFsaWQgdmFsdWUgJXMgZm9yIHRvX2J5dGVzXCcgbm9uc3RyaW5nIHBhcmFtZXRlcicgJSBub25zdHJpbmcpCgogICAgcmV0dXJuIHRvX2J5dGVzKHZhbHVlLCBlbmNvZGluZywgZXJyb3JzKQoKCmRlZiB0b190ZXh0KG9iaiwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPU5vbmUsIG5vbnN0cmluZz0nc2ltcGxlcmVwcicpOgogICAgIiIiTWFrZSBzdXJlIHRoYXQgYSBzdHJpbmcgaXMgYSB0ZXh0IHN0cmluZwoKICAgIDphcmcgb2JqOiBBbiBvYmplY3QgdG8gbWFrZSBzdXJlIGlzIGEgdGV4dCBzdHJpbmcuICBJbiBtb3N0IGNhc2VzIHRoaXMKICAgICAgICB3aWxsIGJlIGVpdGhlciBhIHRleHQgc3RyaW5nIG9yIGEgYnl0ZSBzdHJpbmcuICBIb3dldmVyLCB3aXRoCiAgICAgICAgYGBub25zdHJpbmc9J3NpbXBsZXJlcHInYGAsIHRoaXMgY2FuIGJlIHVzZWQgYXMgYSB0cmFjZWJhY2stZnJlZQogICAgICAgIHZlcnNpb24gb2YgYGBzdHIob2JqKWBgLgogICAgOmt3YXJnIGVuY29kaW5nOiBUaGUgZW5jb2RpbmcgdG8gdXNlIHRvIHRyYW5zZm9ybSBmcm9tIGEgYnl0ZSBzdHJpbmcgdG8KICAgICAgICBhIHRleHQgc3RyaW5nLiAgRGVmYXVsdHMgdG8gdXNpbmcgJ3V0Zi04Jy4KICAgIDprd2FyZyBlcnJvcnM6IFRoZSBlcnJvciBoYW5kbGVyIHRvIHVzZSBpZiB0aGUgYnl0ZSBzdHJpbmcgaXMgbm90CiAgICAgICAgZGVjb2RhYmxlIHVzaW5nIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcuICBBbnkgdmFsaWQgYGNvZGVjcyBlcnJvcgogICAgICAgIGhhbmRsZXIgPGh0dHBzOi8vZG9jcy5weXRob24ub3JnLzIvbGlicmFyeS9jb2RlY3MuaHRtbCNjb2RlYy1iYXNlLWNsYXNzZXM+YF8KICAgICAgICBtYXkgYmUgc3BlY2lmaWVkLiAgIFdlIHN1cHBvcnQgdGhyZWUgYWRkaXRpb25hbCBlcnJvciBzdHJhdGVnaWVzCiAgICAgICAgc3BlY2lmaWNhbGx5IGFpbWVkIGF0IGhlbHBpbmcgcGVvcGxlIHRvIHBvcnQgY29kZToKCiAgICAgICAgICAgIDpzdXJyb2dhdGVfb3Jfc3RyaWN0OiBXaWxsIHVzZSBzdXJyb2dhdGVlc2NhcGUgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlciwgb3RoZXJ3aXNlIGl0IHdpbGwgdXNlIHN0cmljdAogICAgICAgICAgICA6c3Vycm9nYXRlX29yX3JlcGxhY2U6IFdpbGwgdXNlIHN1cnJvZ2F0ZWVzY2FwZSBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLCBvdGhlcndpc2UgaXQgd2lsbCB1c2UgcmVwbGFjZS4KICAgICAgICAgICAgOnN1cnJvZ2F0ZV90aGVuX3JlcGxhY2U6IERvZXMgdGhlIHNhbWUgYXMgc3Vycm9nYXRlX29yX3JlcGxhY2UgYnV0CiAgICAgICAgICAgICAgICBgd2FzIGFkZGVkIGZvciBzeW1tZXRyeSB3aXRoIHRoZSBlcnJvciBoYW5kbGVycyBpbgogICAgICAgICAgICAgICAgOmZ1bmM6YGFuc2libGUubW9kdWxlX3V0aWxzLl90ZXh0LnRvX2J5dGVzYCAoQWRkZWQgaW4gQW5zaWJsZSAyLjMpCgogICAgICAgIEJlY2F1c2Ugc3Vycm9nYXRlZXNjYXBlIHdhcyBhZGRlZCBpbiBQeXRob24zIHRoaXMgdXN1YWxseSBtZWFucyB0aGF0CiAgICAgICAgUHl0aG9uMyB3aWxsIHVzZSBgc3Vycm9nYXRlZXNjYXBlYCBhbmQgUHl0aG9uMiB3aWxsIHVzZSB0aGUgZmFsbGJhY2sKICAgICAgICBlcnJvciBoYW5kbGVyLiBOb3RlIHRoYXQgdGhlIGNvZGUgY2hlY2tzIGZvciBzdXJyb2dhdGVlc2NhcGUgd2hlbiB0aGUKICAgICAgICBtb2R1bGUgaXMgaW1wb3J0ZWQuICBJZiB5b3UgaGF2ZSBhIGJhY2twb3J0IG9mIGBzdXJyb2dhdGVlc2NhcGVgIGZvcgogICAgICAgIHB5dGhvbjIsIGJlIHN1cmUgdG8gcmVnaXN0ZXIgdGhlIGVycm9yIGhhbmRsZXIgcHJpb3IgdG8gaW1wb3J0aW5nIHRoaXMKICAgICAgICBtb2R1bGUuCgogICAgICAgIFRoZSBkZWZhdWx0IHVudGlsIEFuc2libGUtMi4yIHdhcyBgc3Vycm9nYXRlX29yX3JlcGxhY2VgCiAgICAgICAgSW4gQW5zaWJsZS0yLjMgdGhpcyBkZWZhdWx0cyB0byBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWAgZm9yIHN5bW1ldHJ5CiAgICAgICAgd2l0aCA6ZnVuYzpgYW5zaWJsZS5tb2R1bGVfdXRpbHMuX3RleHQudG9fYnl0ZXNgIC4KICAgIDprd2FyZyBub25zdHJpbmc6IFRoZSBzdHJhdGVneSB0byB1c2UgaWYgYSBub25zdHJpbmcgaXMgc3BlY2lmaWVkIGluCiAgICAgICAgYGBvYmpgYC4gIERlZmF1bHQgaXMgJ3NpbXBsZXJlcHInLiAgVmFsaWQgdmFsdWVzIGFyZToKCiAgICAgICAgOnNpbXBsZXJlcHI6IFRoZSBkZWZhdWx0LiAgVGhpcyB0YWtlcyB0aGUgYGBzdHJgYCBvZiB0aGUgb2JqZWN0IGFuZAogICAgICAgICAgICB0aGVuIHJldHVybnMgdGhlIHRleHQgdmVyc2lvbiBvZiB0aGF0IHN0cmluZy4KICAgICAgICA6ZW1wdHk6IFJldHVybiBhbiBlbXB0eSB0ZXh0IHN0cmluZwogICAgICAgIDpwYXNzdGhydTogUmV0dXJuIHRoZSBvYmplY3QgcGFzc2VkIGluCiAgICAgICAgOnN0cmljdDogUmFpc2UgYSA6ZXhjOmBUeXBlRXJyb3JgCgogICAgOnJldHVybnM6IFR5cGljYWxseSB0aGlzIHJldHVybnMgYSB0ZXh0IHN0cmluZy4gIElmIGEgbm9uc3RyaW5nIG9iamVjdCBpcwogICAgICAgIHBhc3NlZCBpbiB0aGlzIG1heSBiZSBhIGRpZmZlcmVudCB0eXBlIGRlcGVuZGluZyBvbiB0aGUgc3RyYXRlZ3kKICAgICAgICBzcGVjaWZpZWQgYnkgbm9uc3RyaW5nLiAgVGhpcyB3aWxsIG5ldmVyIHJldHVybiBhIGJ5dGUgc3RyaW5nLgogICAgICAgIEZyb20gQW5zaWJsZS0yLjMgb253YXJkcywgdGhlIGRlZmF1bHQgaXMgYHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2VgLgoKICAgIC4uIHZlcnNpb25fY2hhbmdlZDo6IDIuMwoKICAgICAgICBBZGRlZCB0aGUgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZSBlcnJvciBoYW5kbGVyIGFuZCBtYWRlIGl0IHRoZSBkZWZhdWx0IGVycm9yIGhhbmRsZXIuCiAgICAiIiIKICAgIGlmIGlzaW5zdGFuY2Uob2JqLCB0ZXh0X3R5cGUpOgogICAgICAgIHJldHVybiBvYmoKCiAgICBpZiBlcnJvcnMgaW4gX0NPTVBPU0VEX0VSUk9SX0hBTkRMRVJTOgogICAgICAgIGlmIEhBU19TVVJST0dBVEVFU0NBUEU6CiAgICAgICAgICAgIGVycm9ycyA9ICdzdXJyb2dhdGVlc2NhcGUnCiAgICAgICAgZWxpZiBlcnJvcnMgPT0gJ3N1cnJvZ2F0ZV9vcl9zdHJpY3QnOgogICAgICAgICAgICBlcnJvcnMgPSAnc3RyaWN0JwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVycm9ycyA9ICdyZXBsYWNlJwoKICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgIyBOb3RlOiBXZSBkb24ndCBuZWVkIHNwZWNpYWwgaGFuZGxpbmcgZm9yIHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2UKICAgICAgICAjIGJlY2F1c2UgYWxsIGJ5dGVzIHdpbGwgZWl0aGVyIGJlIG1hZGUgaW50byBzdXJyb2dhdGVzIG9yIGFyZSB2YWxpZAogICAgICAgICMgdG8gZGVjb2RlLgogICAgICAgIHJldHVybiBvYmouZGVjb2RlKGVuY29kaW5nLCBlcnJvcnMpCgogICAgIyBOb3RlOiBXZSBkbyB0aGVzZSBsYXN0IGV2ZW4gdGhvdWdoIHdlIGhhdmUgdG8gY2FsbCB0b190ZXh0IGFnYWluIG9uIHRoZQogICAgIyB2YWx1ZSBiZWNhdXNlIHdlJ3JlIG9wdGltaXppbmcgdGhlIGNvbW1vbiBjYXNlCiAgICBpZiBub25zdHJpbmcgPT0gJ3NpbXBsZXJlcHInOgogICAgICAgIHRyeToKICAgICAgICAgICAgdmFsdWUgPSBzdHIob2JqKQogICAgICAgIGV4Y2VwdCBVbmljb2RlRXJyb3I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHZhbHVlID0gcmVwcihvYmopCiAgICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRXJyb3I6CiAgICAgICAgICAgICAgICAjIEdpdmluZyB1cAogICAgICAgICAgICAgICAgcmV0dXJuIHUnJwogICAgZWxpZiBub25zdHJpbmcgPT0gJ3Bhc3N0aHJ1JzoKICAgICAgICByZXR1cm4gb2JqCiAgICBlbGlmIG5vbnN0cmluZyA9PSAnZW1wdHknOgogICAgICAgIHJldHVybiB1JycKICAgIGVsaWYgbm9uc3RyaW5nID09ICdzdHJpY3QnOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignb2JqIG11c3QgYmUgYSBzdHJpbmcgdHlwZScpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignSW52YWxpZCB2YWx1ZSAlcyBmb3IgdG9fdGV4dFwncyBub25zdHJpbmcgcGFyYW1ldGVyJyAlIG5vbnN0cmluZykKCiAgICByZXR1cm4gdG9fdGV4dCh2YWx1ZSwgZW5jb2RpbmcsIGVycm9ycykKCgojOiA6cHk6ZnVuYzpgdG9fbmF0aXZlYAojOiAgICAgIFRyYW5zZm9ybSBhIHZhcmlhYmxlIGludG8gdGhlIG5hdGl2ZSBzdHIgdHlwZSBmb3IgdGhlIHB5dGhvbiB2ZXJzaW9uCiM6CiM6ICAgICAgT24gUHl0aG9uMiwgdGhpcyBpcyBhbiBhbGlhcyBmb3IKIzogICAgICA6ZnVuYzpgfmFuc2libGUubW9kdWxlX3V0aWxzLnRvX2J5dGVzYC4gIE9uIFB5dGhvbjMgaXQgaXMgYW4gYWxpYXMgZm9yCiM6ICAgICAgOmZ1bmM6YH5hbnNpYmxlLm1vZHVsZV91dGlscy50b190ZXh0YC4gIEl0IG1ha2VzIGl0IGVhc2llciB0bwojOiAgICAgIHRyYW5zZm9ybSBhIHZhcmlhYmxlIGludG8gdGhlIG5hdGl2ZSBzdHIgdHlwZSBmb3IgdGhlIHB5dGhvbiB2ZXJzaW9uCiM6ICAgICAgdGhlIGNvZGUgaXMgcnVubmluZyBvbi4gIFVzZSB0aGlzIHdoZW4gY29uc3RydWN0aW5nIHRoZSBtZXNzYWdlIHRvCiM6ICAgICAgc2VuZCB0byBleGNlcHRpb25zIG9yIHdoZW4gZGVhbGluZyB3aXRoIGFuIEFQSSB0aGF0IG5lZWRzIHRvIHRha2UKIzogICAgICBhIG5hdGl2ZSBzdHJpbmcuICBFeGFtcGxlOjoKIzoKIzogICAgICAgICAgdHJ5OgojOiAgICAgICAgICAgICAgMS8vMAojOiAgICAgICAgICBleGNlcHQgWmVyb0RpdmlzaW9uRXJyb3IgYXMgZToKIzogICAgICAgICAgICAgIHJhaXNlIE15RXhjZXB0aW9uKCdFbmNvdW50ZXJlZCBhbmQgZXJyb3I6ICVzJyAlIHRvX25hdGl2ZShlKSkKaWYgUFkzOgogICAgdG9fbmF0aXZlID0gdG9fdGV4dAplbHNlOgogICAgdG9fbmF0aXZlID0gdG9fYnl0ZXMKUEsDBBQAAAAAANS7K0sl3LR+ExAAABMQAAAiAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvcHljb21wYXQyNC5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpIDIwMTYsIFRvc2hpbyBLdXJhdG9taSA8dGt1cmF0b21pQGFuc2libGUuY29tPgojIENvcHlyaWdodCAoYykgMjAxNSwgTWFyaXVzIEdlZG1pbmFzCiMKIyBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQgbW9kaWZpY2F0aW9uLAojIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKIwojICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKIyAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwKIyAgICAgIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24KIyAgICAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORAojIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVECiMgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRSBESVNDTEFJTUVELgojIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULAojIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywKIyBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MKIyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUCiMgTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFCiMgVVNFIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiMKCmltcG9ydCBzeXMKCmRlZiBnZXRfZXhjZXB0aW9uKCk6CiAgICAiIiJHZXQgdGhlIGN1cnJlbnQgZXhjZXB0aW9uLgoKICAgIFRoaXMgY29kZSBuZWVkcyB0byB3b3JrIG9uIFB5dGhvbiAyLjQgdGhyb3VnaCAzLngsIHNvIHdlIGNhbm5vdCB1c2UKICAgICJleGNlcHQgRXhjZXB0aW9uLCBlOiIgKFN5bnRheEVycm9yIG9uIFB5dGhvbiAzLngpIG5vcgogICAgImV4Y2VwdCBFeGNlcHRpb24gYXMgZToiIChTeW50YXhFcnJvciBvbiBQeXRob24gMi40LTIuNSkuCiAgICBJbnN0ZWFkIHdlIG11c3QgdXNlIDo6CgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKCiAgICAiIiIKICAgIHJldHVybiBzeXMuZXhjX2luZm8oKVsxXQoKdHJ5OgogICAgIyBQeXRob24gMi42KwogICAgZnJvbSBhc3QgaW1wb3J0IGxpdGVyYWxfZXZhbApleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAjIGEgcmVwbGFjZW1lbnQgZm9yIGxpdGVyYWxfZXZhbCB0aGF0IHdvcmtzIHdpdGggcHl0aG9uIDIuNC4gZnJvbToKICAgICMgaHR0cHM6Ly9tYWlsLnB5dGhvbi5vcmcvcGlwZXJtYWlsL3B5dGhvbi1saXN0LzIwMDktU2VwdGVtYmVyLzU1MTg4MC5odG1sCiAgICAjIHdoaWNoIGlzIGVzc2VudGlhbGx5IGEgY3V0L3Bhc3RlIGZyb20gYW4gZWFybGllciAoMi42KSB2ZXJzaW9uIG9mIHB5dGhvbidzCiAgICAjIGFzdC5weQogICAgZnJvbSBjb21waWxlciBpbXBvcnQgYXN0LCBwYXJzZQogICAgZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IGJpbmFyeV90eXBlLCBzdHJpbmdfdHlwZXMsIHRleHRfdHlwZQoKICAgIGRlZiBsaXRlcmFsX2V2YWwobm9kZV9vcl9zdHJpbmcpOgogICAgICAgICIiIgogICAgICAgIFNhZmVseSBldmFsdWF0ZSBhbiBleHByZXNzaW9uIG5vZGUgb3IgYSBzdHJpbmcgY29udGFpbmluZyBhIFB5dGhvbgogICAgICAgIGV4cHJlc3Npb24uICBUaGUgc3RyaW5nIG9yIG5vZGUgcHJvdmlkZWQgbWF5IG9ubHkgY29uc2lzdCBvZiB0aGUgIGZvbGxvd2luZwogICAgICAgIFB5dGhvbiBsaXRlcmFsIHN0cnVjdHVyZXM6IHN0cmluZ3MsIG51bWJlcnMsIHR1cGxlcywgbGlzdHMsIGRpY3RzLCAgYm9vbGVhbnMsCiAgICAgICAgYW5kIE5vbmUuCiAgICAgICAgIiIiCiAgICAgICAgX3NhZmVfbmFtZXMgPSB7J05vbmUnOiBOb25lLCAnVHJ1ZSc6IFRydWUsICdGYWxzZSc6IEZhbHNlfQogICAgICAgIGlmIGlzaW5zdGFuY2Uobm9kZV9vcl9zdHJpbmcsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIG5vZGVfb3Jfc3RyaW5nID0gcGFyc2Uobm9kZV9vcl9zdHJpbmcsIG1vZGU9J2V2YWwnKQogICAgICAgIGlmIGlzaW5zdGFuY2Uobm9kZV9vcl9zdHJpbmcsIGFzdC5FeHByZXNzaW9uKToKICAgICAgICAgICAgbm9kZV9vcl9zdHJpbmcgPSBub2RlX29yX3N0cmluZy5ub2RlCgogICAgICAgIGRlZiBfY29udmVydChub2RlKToKICAgICAgICAgICAgIyBPa2F5IHRvIHVzZSBsb25nIGhlcmUgYmVjYXVzZSB0aGlzIGlzIG9ubHkgZm9yIHB5dGhvbiAyLjQgYW5kIDIuNQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5Db25zdCkgYW5kIGlzaW5zdGFuY2Uobm9kZS52YWx1ZSwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUsIGludCwgZmxvYXQsIGxvbmcsIGNvbXBsZXgpKToKICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnZhbHVlCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuVHVwbGUpOgogICAgICAgICAgICAgICAgcmV0dXJuIHR1cGxlKG1hcChfY29udmVydCwgbm9kZS5ub2RlcykpCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuTGlzdCk6CiAgICAgICAgICAgICAgICByZXR1cm4gbGlzdChtYXAoX2NvbnZlcnQsIG5vZGUubm9kZXMpKQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0LkRpY3QpOgogICAgICAgICAgICAgICAgcmV0dXJuIGRpY3QoKF9jb252ZXJ0KGspLCBfY29udmVydCh2KSkgZm9yIGssIHYgaW4gbm9kZS5pdGVtcygpKQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0Lk5hbWUpOgogICAgICAgICAgICAgICAgaWYgbm9kZS5uYW1lIGluIF9zYWZlX25hbWVzOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBfc2FmZV9uYW1lc1tub2RlLm5hbWVdCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuVW5hcnlTdWIpOgogICAgICAgICAgICAgICAgcmV0dXJuIC1fY29udmVydChub2RlLmV4cHIpCiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ21hbGZvcm1lZCBzdHJpbmcnKQogICAgICAgIHJldHVybiBfY29udmVydChub2RlX29yX3N0cmluZykKCl9fYWxsX18gPSAoJ2dldF9leGNlcHRpb24nLCAnbGl0ZXJhbF9ldmFsJykKUEsDBBQAAAAAANS7K0sYF3L1AREAAAERAAAkAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19faW5pdF9fLnB5IyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojIFRoaXMgcGFydGljdWxhciBmaWxlIHNuaXBwZXQsIGFuZCB0aGlzIGZpbGUgc25pcHBldCBvbmx5LCBpcyBCU0QgbGljZW5zZWQuCiMgTW9kdWxlcyB5b3Ugd3JpdGUgdXNpbmcgdGhpcyBzbmlwcGV0LCB3aGljaCBpcyBlbWJlZGRlZCBkeW5hbWljYWxseSBieSBBbnNpYmxlCiMgc3RpbGwgYmVsb25nIHRvIHRoZSBhdXRob3Igb2YgdGhlIG1vZHVsZSwgYW5kIG1heSBhc3NpZ24gdGhlaXIgb3duIGxpY2Vuc2UKIyB0byB0aGUgY29tcGxldGUgd29yay4KIwojIENvcHlyaWdodCAoYykgMjAxNywgVG9zaGlvIEt1cmF0b21pIDx0a3VyYXRvbWlAYW5zaWJsZS5jb20+CiMKIyBUaGlzIGNvZGUgaXMgYmFzZWQgb24gY29kZSBmcm9tIEFzdHJvcHkgYW5kIHJldGFpbnMgdGhlaXIgMy1jbGF1c2UgQlNEIGxpY2Vuc2UKIyByZXByb2R1Y2VkIGJlbG93OgojCiMgQ29weXJpZ2h0IChjKSAyMDExLTIwMTYsIEFzdHJvcHkgRGV2ZWxvcGVycwojCiMgQWxsIHJpZ2h0cyByZXNlcnZlZC4KIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dAojIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsIHRoaXMKIyAgIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMgKiBOZWl0aGVyIHRoZSBuYW1lIG9mIHRoZSBBc3Ryb3B5IFRlYW0gbm9yIHRoZSBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heQojICAgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHMgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dAojICAgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiCiMgQU5EIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRQojIElNUExJRUQgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRQojIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUKIyBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTAojIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SCiMgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIKIyBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLAojIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFCiMgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwojIEFzdHJvcHkgTGljZW5zZTogaHR0cHM6Ly9naXRodWIuY29tL2FzdHJvcHkvYXN0cm9weS9ibG9iL2NmMzI2NWU0MmEwZGI4ZTAwYmI5MDY0NGRiMzdjODE1MGY1YWMwMGMvbGljZW5zZXMvTElDRU5TRS5yc3QKIyBBc3Ryb3B5IENvZGU6IGh0dHBzOi8vZ2l0aHViLmNvbS9hc3Ryb3B5L2FzdHJvcHkvYmxvYi9jZjMyNjVlNDJhMGRiOGUwMGJiOTA2NDRkYjM3YzgxNTBmNWFjMDBjL2FzdHJvcHkvZXh0ZXJuL3NpeC5weQoKIiIiCkhhbmRsZSBsb2FkaW5nIHNpeCBwYWNrYWdlIGZyb20gc3lzdGVtIG9yIGZyb20gdGhlIGJ1bmRsZWQgY29weQoiIiIKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCBhYnNvbHV0ZV9pbXBvcnQKCmltcG9ydCBpbXAgYXMgX2ltcAppbXBvcnQgc3lzIGFzIF9zeXMKCnRyeToKICAgIGZyb20gZGlzdHV0aWxzLnZlcnNpb24gaW1wb3J0IExvb3NlVmVyc2lvbiBhcyBfTG9vc2VWZXJzaW9uCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICMgU29tZSBwbGF0Zm9ybXMgKmNvdWdoKlNvbGFyaXMqY291Z2gqIGRvbid0IHNoaXAgdGhlIHdob2xlIHN0ZGxpYgogICAgX0xvb3NlVmVyc2lvbiA9IE5vbmUKCnRyeToKICAgIGltcG9ydCBzaXggYXMgX3N5c3RlbV9zaXgKZXhjZXB0IEltcG9ydEVycm9yOgogICAgX3N5c3RlbV9zaXggPSBOb25lCgpmcm9tIC4gaW1wb3J0IF9zaXggYXMgX2J1bmRsZWRfc2l4CgoKZGVmIF9maW5kX21vZHVsZShuYW1lLCBwYXRoPU5vbmUpOgogICAgIiIiQWx0ZXJuYXRpdmUgdG8gYGltcC5maW5kX21vZHVsZWAgdGhhdCBjYW4gYWxzbyBzZWFyY2ggaW4gc3VicGFja2FnZXMiIiIKICAgIHBhcnRzID0gbmFtZS5zcGxpdCgnLicpCgogICAgZm9yIHBhcnQgaW4gcGFydHM6CiAgICAgICAgaWYgcGF0aCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGF0aCA9IFtwYXRoXQogICAgICAgIGZoLCBwYXRoLCBkZXNjciA9IF9pbXAuZmluZF9tb2R1bGUocGFydCwgcGF0aCkKICAgIHJldHVybiBmaCwgcGF0aCwgZGVzY3IKCgpkZWYgX2dldF9idW5kbGVkX3NpeF9zb3VyY2UoKToKICAgICMgU3BlY2lhbCBpbXBvcnQgbG9hZGVyICh6aXBpbXBvcnQgZm9yIGluc3RhbmNlKQogICAgZm91bmQgPSBGYWxzZQogICAgZm9yIHBhdGggaW4gX3N5cy5wYXRoOgogICAgICAgIGltcG9ydGVyID0gX3N5cy5wYXRoX2ltcG9ydGVyX2NhY2hlLmdldChwYXRoKQogICAgICAgIGlmIGltcG9ydGVyOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmb3VuZCA9IGltcG9ydGVyLmZpbmRfbW9kdWxlKCdhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeCcpCiAgICAgICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIGZvdW5kOgogICAgICAgICAgICAgICAgYnJlYWsKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoIkNvdWxkIG5vdCBmaW5kIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5fc2l4IikKCiAgICBtb2R1bGVfc291cmNlID0gaW1wb3J0ZXIuZ2V0X3NvdXJjZSgnYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19zaXgnKQogICAgcmV0dXJuIG1vZHVsZV9zb3VyY2UKCgpkZWYgX2dldF9zaXhfc291cmNlKCk6CiAgICAiIiJJbXBvcnQgdGhlIG5ld2VzdCB2ZXJzaW9uIG9mIHRoZSBzaXggbGlicmFyeSB0aGF0J3MgYXZhaWxhYmxlIiIiCiAgICBtb2RfaW5mbyA9IE5vbmUKICAgIHRyeToKICAgICAgICBpZiBfc3lzdGVtX3NpeCBhbmQgX0xvb3NlVmVyc2lvbiBhbmQgXAogICAgICAgICAgICAgICAgX0xvb3NlVmVyc2lvbihfc3lzdGVtX3NpeC5fX3ZlcnNpb25fXykgPj0gX0xvb3NlVmVyc2lvbihfYnVuZGxlZF9zaXguX192ZXJzaW9uX18pOgogICAgICAgICAgICBtb2RfaW5mbyA9IF9maW5kX21vZHVsZSgnc2l4JykKICAgIGV4Y2VwdDoKICAgICAgICAjIEFueSBlcnJvcnMgZmluZGluZyB0aGUgc3lzdGVtIGxpYnJhcnksIHVzZSBvdXIgYnVuZGxlZCBsaWIgaW5zdGVhZAogICAgICAgIHBhc3MKCiAgICBpZiBub3QgbW9kX2luZm86CiAgICAgICAgdHJ5OgogICAgICAgICAgICBtb2RfaW5mbyA9IF9maW5kX21vZHVsZSgnYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Ll9zaXgnKQogICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICAgICAgIyB6aXBpbXBvcnQKICAgICAgICAgICAgbW9kdWxlX3NvdXJjZSA9IF9nZXRfYnVuZGxlZF9zaXhfc291cmNlKCkKICAgICAgICAgICAgcmV0dXJuIG1vZHVsZV9zb3VyY2UKCiAgICByZXR1cm4gbW9kX2luZm9bMF0ucmVhZCgpCgpzb3VyY2UgPSBfZ2V0X3NpeF9zb3VyY2UoKQpleGVjKHNvdXJjZSkKUEsDBBQAAAAAANS7K0s44sfRkXUAAJF1AAAgAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19zaXgucHkiIiJVdGlsaXRpZXMgZm9yIHdyaXRpbmcgY29kZSB0aGF0IHJ1bnMgb24gUHl0aG9uIDIgYW5kIDMiIiIKCiMgQ29weXJpZ2h0IChjKSAyMDEwLTIwMTUgQmVuamFtaW4gUGV0ZXJzb24KIwojIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKIyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAojIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKIyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiMgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKIwojIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbAojIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiMKIyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgojIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAojIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQojIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKIyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAojIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFCiMgU09GVFdBUkUuCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IGFic29sdXRlX2ltcG9ydAoKaW1wb3J0IGZ1bmN0b29scwppbXBvcnQgaXRlcnRvb2xzCmltcG9ydCBvcGVyYXRvcgppbXBvcnQgc3lzCmltcG9ydCB0eXBlcwoKX19hdXRob3JfXyA9ICJCZW5qYW1pbiBQZXRlcnNvbiA8YmVuamFtaW5AcHl0aG9uLm9yZz4iCl9fdmVyc2lvbl9fID0gIjEuMTAuMCIKCgojIFVzZWZ1bCBmb3IgdmVyeSBjb2Fyc2UgdmVyc2lvbiBkaWZmZXJlbnRpYXRpb24uClBZMiA9IHN5cy52ZXJzaW9uX2luZm9bMF0gPT0gMgpQWTMgPSBzeXMudmVyc2lvbl9pbmZvWzBdID09IDMKUFkzNCA9IHN5cy52ZXJzaW9uX2luZm9bMDoyXSA+PSAoMywgNCkKCmlmIFBZMzoKICAgIHN0cmluZ190eXBlcyA9IHN0ciwKICAgIGludGVnZXJfdHlwZXMgPSBpbnQsCiAgICBjbGFzc190eXBlcyA9IHR5cGUsCiAgICB0ZXh0X3R5cGUgPSBzdHIKICAgIGJpbmFyeV90eXBlID0gYnl0ZXMKICAgIE1BWFNJWkUgPSBzeXMubWF4c2l6ZQplbHNlOgogICAgc3RyaW5nX3R5cGVzID0gYmFzZXN0cmluZywKICAgIGludGVnZXJfdHlwZXMgPSAoaW50LCBsb25nKQogICAgY2xhc3NfdHlwZXMgPSAodHlwZSwgdHlwZXMuQ2xhc3NUeXBlKQogICAgdGV4dF90eXBlID0gdW5pY29kZQogICAgYmluYXJ5X3R5cGUgPSBzdHIKCiAgICBpZiBzeXMucGxhdGZvcm0uc3RhcnRzd2l0aCgiamF2YSIpOgogICAgICAgICMgSnl0aG9uIGFsd2F5cyB1c2VzIDMyIGJpdHMuCiAgICAgICAgTUFYU0laRSA9IGludCgoMSA8PCAzMSkgLSAxKQogICAgZWxzZToKICAgICAgICAjIEl0J3MgcG9zc2libGUgdG8gaGF2ZSBzaXplb2YobG9uZykgIT0gc2l6ZW9mKFB5X3NzaXplX3QpLgogICAgICAgIGNsYXNzIFgob2JqZWN0KToKCiAgICAgICAgICAgIGRlZiBfX2xlbl9fKHNlbGYpOgogICAgICAgICAgICAgICAgcmV0dXJuIDEgPDwgMzEKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxlbihYKCkpCiAgICAgICAgZXhjZXB0IE92ZXJmbG93RXJyb3I6CiAgICAgICAgICAgICMgMzItYml0CiAgICAgICAgICAgIE1BWFNJWkUgPSBpbnQoKDEgPDwgMzEpIC0gMSkKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIDY0LWJpdAogICAgICAgICAgICBNQVhTSVpFID0gaW50KCgxIDw8IDYzKSAtIDEpCiAgICAgICAgZGVsIFgKCgpkZWYgX2FkZF9kb2MoZnVuYywgZG9jKToKICAgICIiIkFkZCBkb2N1bWVudGF0aW9uIHRvIGEgZnVuY3Rpb24uIiIiCiAgICBmdW5jLl9fZG9jX18gPSBkb2MKCgpkZWYgX2ltcG9ydF9tb2R1bGUobmFtZSk6CiAgICAiIiJJbXBvcnQgbW9kdWxlLCByZXR1cm5pbmcgdGhlIG1vZHVsZSBhZnRlciB0aGUgbGFzdCBkb3QuIiIiCiAgICBfX2ltcG9ydF9fKG5hbWUpCiAgICByZXR1cm4gc3lzLm1vZHVsZXNbbmFtZV0KCgpjbGFzcyBfTGF6eURlc2NyKG9iamVjdCk6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUpOgogICAgICAgIHNlbGYubmFtZSA9IG5hbWUKCiAgICBkZWYgX19nZXRfXyhzZWxmLCBvYmosIHRwKToKICAgICAgICByZXN1bHQgPSBzZWxmLl9yZXNvbHZlKCkKICAgICAgICBzZXRhdHRyKG9iaiwgc2VsZi5uYW1lLCByZXN1bHQpICAjIEludm9rZXMgX19zZXRfXy4KICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVGhpcyBpcyBhIGJpdCB1Z2x5LCBidXQgaXQgYXZvaWRzIHJ1bm5pbmcgdGhpcyBhZ2FpbiBieQogICAgICAgICAgICAjIHJlbW92aW5nIHRoaXMgZGVzY3JpcHRvci4KICAgICAgICAgICAgZGVsYXR0cihvYmouX19jbGFzc19fLCBzZWxmLm5hbWUpCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIHJlc3VsdAoKCmNsYXNzIE1vdmVkTW9kdWxlKF9MYXp5RGVzY3IpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuYW1lLCBvbGQsIG5ldz1Ob25lKToKICAgICAgICBzdXBlcihNb3ZlZE1vZHVsZSwgc2VsZikuX19pbml0X18obmFtZSkKICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgIGlmIG5ldyBpcyBOb25lOgogICAgICAgICAgICAgICAgbmV3ID0gbmFtZQogICAgICAgICAgICBzZWxmLm1vZCA9IG5ldwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYubW9kID0gb2xkCgogICAgZGVmIF9yZXNvbHZlKHNlbGYpOgogICAgICAgIHJldHVybiBfaW1wb3J0X21vZHVsZShzZWxmLm1vZCkKCiAgICBkZWYgX19nZXRhdHRyX18oc2VsZiwgYXR0cik6CiAgICAgICAgX21vZHVsZSA9IHNlbGYuX3Jlc29sdmUoKQogICAgICAgIHZhbHVlID0gZ2V0YXR0cihfbW9kdWxlLCBhdHRyKQogICAgICAgIHNldGF0dHIoc2VsZiwgYXR0ciwgdmFsdWUpCiAgICAgICAgcmV0dXJuIHZhbHVlCgoKY2xhc3MgX0xhenlNb2R1bGUodHlwZXMuTW9kdWxlVHlwZSk6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUpOgogICAgICAgIHN1cGVyKF9MYXp5TW9kdWxlLCBzZWxmKS5fX2luaXRfXyhuYW1lKQogICAgICAgIHNlbGYuX19kb2NfXyA9IHNlbGYuX19jbGFzc19fLl9fZG9jX18KCiAgICBkZWYgX19kaXJfXyhzZWxmKToKICAgICAgICBhdHRycyA9IFsiX19kb2NfXyIsICJfX25hbWVfXyJdCiAgICAgICAgYXR0cnMgKz0gW2F0dHIubmFtZSBmb3IgYXR0ciBpbiBzZWxmLl9tb3ZlZF9hdHRyaWJ1dGVzXQogICAgICAgIHJldHVybiBhdHRycwoKICAgICMgU3ViY2xhc3NlcyBzaG91bGQgb3ZlcnJpZGUgdGhpcwogICAgX21vdmVkX2F0dHJpYnV0ZXMgPSBbXQoKCmNsYXNzIE1vdmVkQXR0cmlidXRlKF9MYXp5RGVzY3IpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuYW1lLCBvbGRfbW9kLCBuZXdfbW9kLCBvbGRfYXR0cj1Ob25lLCBuZXdfYXR0cj1Ob25lKToKICAgICAgICBzdXBlcihNb3ZlZEF0dHJpYnV0ZSwgc2VsZikuX19pbml0X18obmFtZSkKICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgIGlmIG5ld19tb2QgaXMgTm9uZToKICAgICAgICAgICAgICAgIG5ld19tb2QgPSBuYW1lCiAgICAgICAgICAgIHNlbGYubW9kID0gbmV3X21vZAogICAgICAgICAgICBpZiBuZXdfYXR0ciBpcyBOb25lOgogICAgICAgICAgICAgICAgaWYgb2xkX2F0dHIgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBuZXdfYXR0ciA9IG5hbWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbmV3X2F0dHIgPSBvbGRfYXR0cgogICAgICAgICAgICBzZWxmLmF0dHIgPSBuZXdfYXR0cgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYubW9kID0gb2xkX21vZAogICAgICAgICAgICBpZiBvbGRfYXR0ciBpcyBOb25lOgogICAgICAgICAgICAgICAgb2xkX2F0dHIgPSBuYW1lCiAgICAgICAgICAgIHNlbGYuYXR0ciA9IG9sZF9hdHRyCgogICAgZGVmIF9yZXNvbHZlKHNlbGYpOgogICAgICAgIG1vZHVsZSA9IF9pbXBvcnRfbW9kdWxlKHNlbGYubW9kKQogICAgICAgIHJldHVybiBnZXRhdHRyKG1vZHVsZSwgc2VsZi5hdHRyKQoKCmNsYXNzIF9TaXhNZXRhUGF0aEltcG9ydGVyKG9iamVjdCk6CgogICAgIiIiCiAgICBBIG1ldGEgcGF0aCBpbXBvcnRlciB0byBpbXBvcnQgc2l4Lm1vdmVzIGFuZCBpdHMgc3VibW9kdWxlcy4KCiAgICBUaGlzIGNsYXNzIGltcGxlbWVudHMgYSBQRVAzMDIgZmluZGVyIGFuZCBsb2FkZXIuIEl0IHNob3VsZCBiZSBjb21wYXRpYmxlCiAgICB3aXRoIFB5dGhvbiAyLjUgYW5kIGFsbCBleGlzdGluZyB2ZXJzaW9ucyBvZiBQeXRob24zCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgc2l4X21vZHVsZV9uYW1lKToKICAgICAgICBzZWxmLm5hbWUgPSBzaXhfbW9kdWxlX25hbWUKICAgICAgICBzZWxmLmtub3duX21vZHVsZXMgPSB7fQoKICAgIGRlZiBfYWRkX21vZHVsZShzZWxmLCBtb2QsICpmdWxsbmFtZXMpOgogICAgICAgIGZvciBmdWxsbmFtZSBpbiBmdWxsbmFtZXM6CiAgICAgICAgICAgIHNlbGYua25vd25fbW9kdWxlc1tzZWxmLm5hbWUgKyAiLiIgKyBmdWxsbmFtZV0gPSBtb2QKCiAgICBkZWYgX2dldF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgIHJldHVybiBzZWxmLmtub3duX21vZHVsZXNbc2VsZi5uYW1lICsgIi4iICsgZnVsbG5hbWVdCgogICAgZGVmIGZpbmRfbW9kdWxlKHNlbGYsIGZ1bGxuYW1lLCBwYXRoPU5vbmUpOgogICAgICAgIGlmIGZ1bGxuYW1lIGluIHNlbGYua25vd25fbW9kdWxlczoKICAgICAgICAgICAgcmV0dXJuIHNlbGYKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBfX2dldF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIHNlbGYua25vd25fbW9kdWxlc1tmdWxsbmFtZV0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHJhaXNlIEltcG9ydEVycm9yKCJUaGlzIGxvYWRlciBkb2VzIG5vdCBrbm93IG1vZHVsZSAiICsgZnVsbG5hbWUpCgogICAgZGVmIGxvYWRfbW9kdWxlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgaW4gY2FzZSBvZiBhIHJlbG9hZAogICAgICAgICAgICByZXR1cm4gc3lzLm1vZHVsZXNbZnVsbG5hbWVdCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgbW9kID0gc2VsZi5fX2dldF9tb2R1bGUoZnVsbG5hbWUpCiAgICAgICAgaWYgaXNpbnN0YW5jZShtb2QsIE1vdmVkTW9kdWxlKToKICAgICAgICAgICAgbW9kID0gbW9kLl9yZXNvbHZlKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBtb2QuX19sb2FkZXJfXyA9IHNlbGYKICAgICAgICBzeXMubW9kdWxlc1tmdWxsbmFtZV0gPSBtb2QKICAgICAgICByZXR1cm4gbW9kCgogICAgZGVmIGlzX3BhY2thZ2Uoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgICIiIgogICAgICAgIFJldHVybiB0cnVlLCBpZiB0aGUgbmFtZWQgbW9kdWxlIGlzIGEgcGFja2FnZS4KCiAgICAgICAgV2UgbmVlZCB0aGlzIG1ldGhvZCB0byBnZXQgY29ycmVjdCBzcGVjIG9iamVjdHMgd2l0aAogICAgICAgIFB5dGhvbiAzLjQgKHNlZSBQRVA0NTEpCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIGhhc2F0dHIoc2VsZi5fX2dldF9tb2R1bGUoZnVsbG5hbWUpLCAiX19wYXRoX18iKQoKICAgIGRlZiBnZXRfY29kZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgIiIiUmV0dXJuIE5vbmUKCiAgICAgICAgUmVxdWlyZWQsIGlmIGlzX3BhY2thZ2UgaXMgaW1wbGVtZW50ZWQiIiIKICAgICAgICBzZWxmLl9fZ2V0X21vZHVsZShmdWxsbmFtZSkgICMgZXZlbnR1YWxseSByYWlzZXMgSW1wb3J0RXJyb3IKICAgICAgICByZXR1cm4gTm9uZQogICAgZ2V0X3NvdXJjZSA9IGdldF9jb2RlICAjIHNhbWUgYXMgZ2V0X2NvZGUKCl9pbXBvcnRlciA9IF9TaXhNZXRhUGF0aEltcG9ydGVyKF9fbmFtZV9fKQoKCmNsYXNzIF9Nb3ZlZEl0ZW1zKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyIiIgogICAgX19wYXRoX18gPSBbXSAgIyBtYXJrIGFzIHBhY2thZ2UKCgpfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJjU3RyaW5nSU8iLCAiY1N0cmluZ0lPIiwgImlvIiwgIlN0cmluZ0lPIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZmlsdGVyIiwgIml0ZXJ0b29scyIsICJidWlsdGlucyIsICJpZmlsdGVyIiwgImZpbHRlciIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImZpbHRlcmZhbHNlIiwgIml0ZXJ0b29scyIsICJpdGVydG9vbHMiLCAiaWZpbHRlcmZhbHNlIiwgImZpbHRlcmZhbHNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiaW5wdXQiLCAiX19idWlsdGluX18iLCAiYnVpbHRpbnMiLCAicmF3X2lucHV0IiwgImlucHV0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiaW50ZXJuIiwgIl9fYnVpbHRpbl9fIiwgInN5cyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIm1hcCIsICJpdGVydG9vbHMiLCAiYnVpbHRpbnMiLCAiaW1hcCIsICJtYXAiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJnZXRjd2QiLCAib3MiLCAib3MiLCAiZ2V0Y3dkdSIsICJnZXRjd2QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJnZXRjd2RiIiwgIm9zIiwgIm9zIiwgImdldGN3ZCIsICJnZXRjd2RiIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicmFuZ2UiLCAiX19idWlsdGluX18iLCAiYnVpbHRpbnMiLCAieHJhbmdlIiwgInJhbmdlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicmVsb2FkX21vZHVsZSIsICJfX2J1aWx0aW5fXyIsICJpbXBvcnRsaWIiIGlmIFBZMzQgZWxzZSAiaW1wIiwgInJlbG9hZCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInJlZHVjZSIsICJfX2J1aWx0aW5fXyIsICJmdW5jdG9vbHMiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzaGxleF9xdW90ZSIsICJwaXBlcyIsICJzaGxleCIsICJxdW90ZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlN0cmluZ0lPIiwgIlN0cmluZ0lPIiwgImlvIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVXNlckRpY3QiLCAiVXNlckRpY3QiLCAiY29sbGVjdGlvbnMiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVc2VyTGlzdCIsICJVc2VyTGlzdCIsICJjb2xsZWN0aW9ucyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVzZXJTdHJpbmciLCAiVXNlclN0cmluZyIsICJjb2xsZWN0aW9ucyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInhyYW5nZSIsICJfX2J1aWx0aW5fXyIsICJidWlsdGlucyIsICJ4cmFuZ2UiLCAicmFuZ2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ6aXAiLCAiaXRlcnRvb2xzIiwgImJ1aWx0aW5zIiwgIml6aXAiLCAiemlwIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiemlwX2xvbmdlc3QiLCAiaXRlcnRvb2xzIiwgIml0ZXJ0b29scyIsICJpemlwX2xvbmdlc3QiLCAiemlwX2xvbmdlc3QiKSwKICAgIE1vdmVkTW9kdWxlKCJidWlsdGlucyIsICJfX2J1aWx0aW5fXyIpLAogICAgTW92ZWRNb2R1bGUoImNvbmZpZ3BhcnNlciIsICJDb25maWdQYXJzZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJjb3B5cmVnIiwgImNvcHlfcmVnIiksCiAgICBNb3ZlZE1vZHVsZSgiZGJtX2dudSIsICJnZGJtIiwgImRibS5nbnUiKSwKICAgIE1vdmVkTW9kdWxlKCJfZHVtbXlfdGhyZWFkIiwgImR1bW15X3RocmVhZCIsICJfZHVtbXlfdGhyZWFkIiksCiAgICBNb3ZlZE1vZHVsZSgiaHR0cF9jb29raWVqYXIiLCAiY29va2llbGliIiwgImh0dHAuY29va2llamFyIiksCiAgICBNb3ZlZE1vZHVsZSgiaHR0cF9jb29raWVzIiwgIkNvb2tpZSIsICJodHRwLmNvb2tpZXMiKSwKICAgIE1vdmVkTW9kdWxlKCJodG1sX2VudGl0aWVzIiwgImh0bWxlbnRpdHlkZWZzIiwgImh0bWwuZW50aXRpZXMiKSwKICAgIE1vdmVkTW9kdWxlKCJodG1sX3BhcnNlciIsICJIVE1MUGFyc2VyIiwgImh0bWwucGFyc2VyIiksCiAgICBNb3ZlZE1vZHVsZSgiaHR0cF9jbGllbnQiLCAiaHR0cGxpYiIsICJodHRwLmNsaWVudCIpLAogICAgTW92ZWRNb2R1bGUoImVtYWlsX21pbWVfbXVsdGlwYXJ0IiwgImVtYWlsLk1JTUVNdWx0aXBhcnQiLCAiZW1haWwubWltZS5tdWx0aXBhcnQiKSwKICAgIE1vdmVkTW9kdWxlKCJlbWFpbF9taW1lX25vbm11bHRpcGFydCIsICJlbWFpbC5NSU1FTm9uTXVsdGlwYXJ0IiwgImVtYWlsLm1pbWUubm9ubXVsdGlwYXJ0IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV90ZXh0IiwgImVtYWlsLk1JTUVUZXh0IiwgImVtYWlsLm1pbWUudGV4dCIpLAogICAgTW92ZWRNb2R1bGUoImVtYWlsX21pbWVfYmFzZSIsICJlbWFpbC5NSU1FQmFzZSIsICJlbWFpbC5taW1lLmJhc2UiKSwKICAgIE1vdmVkTW9kdWxlKCJCYXNlSFRUUFNlcnZlciIsICJCYXNlSFRUUFNlcnZlciIsICJodHRwLnNlcnZlciIpLAogICAgTW92ZWRNb2R1bGUoIkNHSUhUVFBTZXJ2ZXIiLCAiQ0dJSFRUUFNlcnZlciIsICJodHRwLnNlcnZlciIpLAogICAgTW92ZWRNb2R1bGUoIlNpbXBsZUhUVFBTZXJ2ZXIiLCAiU2ltcGxlSFRUUFNlcnZlciIsICJodHRwLnNlcnZlciIpLAogICAgTW92ZWRNb2R1bGUoImNQaWNrbGUiLCAiY1BpY2tsZSIsICJwaWNrbGUiKSwKICAgIE1vdmVkTW9kdWxlKCJxdWV1ZSIsICJRdWV1ZSIpLAogICAgTW92ZWRNb2R1bGUoInJlcHJsaWIiLCAicmVwciIpLAogICAgTW92ZWRNb2R1bGUoInNvY2tldHNlcnZlciIsICJTb2NrZXRTZXJ2ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJfdGhyZWFkIiwgInRocmVhZCIsICJfdGhyZWFkIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlciIsICJUa2ludGVyIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9kaWFsb2ciLCAiRGlhbG9nIiwgInRraW50ZXIuZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9maWxlZGlhbG9nIiwgIkZpbGVEaWFsb2ciLCAidGtpbnRlci5maWxlZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9zY3JvbGxlZHRleHQiLCAiU2Nyb2xsZWRUZXh0IiwgInRraW50ZXIuc2Nyb2xsZWR0ZXh0IiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9zaW1wbGVkaWFsb2ciLCAiU2ltcGxlRGlhbG9nIiwgInRraW50ZXIuc2ltcGxlZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl90aXgiLCAiVGl4IiwgInRraW50ZXIudGl4IiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl90dGsiLCAidHRrIiwgInRraW50ZXIudHRrIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9jb25zdGFudHMiLCAiVGtjb25zdGFudHMiLCAidGtpbnRlci5jb25zdGFudHMiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2RuZCIsICJUa2RuZCIsICJ0a2ludGVyLmRuZCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfY29sb3JjaG9vc2VyIiwgInRrQ29sb3JDaG9vc2VyIiwKICAgICAgICAgICAgICAgICJ0a2ludGVyLmNvbG9yY2hvb3NlciIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfY29tbW9uZGlhbG9nIiwgInRrQ29tbW9uRGlhbG9nIiwKICAgICAgICAgICAgICAgICJ0a2ludGVyLmNvbW1vbmRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfdGtmaWxlZGlhbG9nIiwgInRrRmlsZURpYWxvZyIsICJ0a2ludGVyLmZpbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2ZvbnQiLCAidGtGb250IiwgInRraW50ZXIuZm9udCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfbWVzc2FnZWJveCIsICJ0a01lc3NhZ2VCb3giLCAidGtpbnRlci5tZXNzYWdlYm94IiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl90a3NpbXBsZWRpYWxvZyIsICJ0a1NpbXBsZURpYWxvZyIsCiAgICAgICAgICAgICAgICAidGtpbnRlci5zaW1wbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ1cmxsaWJfcGFyc2UiLCBfX25hbWVfXyArICIubW92ZXMudXJsbGliX3BhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYl9lcnJvciIsIF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWJfZXJyb3IiLCAidXJsbGliLmVycm9yIiksCiAgICBNb3ZlZE1vZHVsZSgidXJsbGliIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYiIsIF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIiKSwKICAgIE1vdmVkTW9kdWxlKCJ1cmxsaWJfcm9ib3RwYXJzZXIiLCAicm9ib3RwYXJzZXIiLCAidXJsbGliLnJvYm90cGFyc2VyIiksCiAgICBNb3ZlZE1vZHVsZSgieG1scnBjX2NsaWVudCIsICJ4bWxycGNsaWIiLCAieG1scnBjLmNsaWVudCIpLAogICAgTW92ZWRNb2R1bGUoInhtbHJwY19zZXJ2ZXIiLCAiU2ltcGxlWE1MUlBDU2VydmVyIiwgInhtbHJwYy5zZXJ2ZXIiKSwKXQojIEFkZCB3aW5kb3dzIHNwZWNpZmljIG1vZHVsZXMuCmlmIHN5cy5wbGF0Zm9ybSA9PSAid2luMzIiOgogICAgX21vdmVkX2F0dHJpYnV0ZXMgKz0gWwogICAgICAgIE1vdmVkTW9kdWxlKCJ3aW5yZWciLCAiX3dpbnJlZyIpLAogICAgXQoKZm9yIGF0dHIgaW4gX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKF9Nb3ZlZEl0ZW1zLCBhdHRyLm5hbWUsIGF0dHIpCiAgICBpZiBpc2luc3RhbmNlKGF0dHIsIE1vdmVkTW9kdWxlKToKICAgICAgICBfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoYXR0ciwgIm1vdmVzLiIgKyBhdHRyLm5hbWUpCmRlbCBhdHRyCgpfTW92ZWRJdGVtcy5fbW92ZWRfYXR0cmlidXRlcyA9IF9tb3ZlZF9hdHRyaWJ1dGVzCgptb3ZlcyA9IF9Nb3ZlZEl0ZW1zKF9fbmFtZV9fICsgIi5tb3ZlcyIpCl9pbXBvcnRlci5fYWRkX21vZHVsZShtb3ZlcywgIm1vdmVzIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9wYXJzZShfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9wYXJzZSIiIgoKCl91cmxsaWJfcGFyc2VfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJQYXJzZVJlc3VsdCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJTcGxpdFJlc3VsdCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwYXJzZV9xcyIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwYXJzZV9xc2wiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsZGVmcmFnIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybGpvaW4iLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJscGFyc2UiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsc3BsaXQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsdW5wYXJzZSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmx1bnNwbGl0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInF1b3RlIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJxdW90ZV9wbHVzIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1bnF1b3RlIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1bnF1b3RlX3BsdXMiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybGVuY29kZSIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgic3BsaXRxdWVyeSIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgic3BsaXR0YWciLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInNwbGl0dXNlciIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19mcmFnbWVudCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX25ldGxvYyIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX3BhcmFtcyIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX3F1ZXJ5IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfcmVsYXRpdmUiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9wYXJzZV9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9wYXJzZSwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcGFyc2UuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3BhcnNlX21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9wYXJzZShfX25hbWVfXyArICIubW92ZXMudXJsbGliX3BhcnNlIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3BhcnNlIiwgIm1vdmVzLnVybGxpYi5wYXJzZSIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfZXJyb3IoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfZXJyb3IiIiIKCgpfdXJsbGliX2Vycm9yX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVVJMRXJyb3IiLCAidXJsbGliMiIsICJ1cmxsaWIuZXJyb3IiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQRXJyb3IiLCAidXJsbGliMiIsICJ1cmxsaWIuZXJyb3IiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJDb250ZW50VG9vU2hvcnRFcnJvciIsICJ1cmxsaWIiLCAidXJsbGliLmVycm9yIiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9lcnJvcl9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvciwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfZXJyb3IuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX2Vycm9yX21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvcihfX25hbWVfXyArICIubW92ZXMudXJsbGliLmVycm9yIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX2Vycm9yIiwgIm1vdmVzLnVybGxpYi5lcnJvciIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVxdWVzdChfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9yZXF1ZXN0IiIiCgoKX3VybGxpYl9yZXF1ZXN0X21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsb3BlbiIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiaW5zdGFsbF9vcGVuZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImJ1aWxkX29wZW5lciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicGF0aG5hbWUydXJsIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybDJwYXRobmFtZSIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJnZXRwcm94aWVzIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlJlcXVlc3QiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIk9wZW5lckRpcmVjdG9yIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQRGVmYXVsdEVycm9ySGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUFJlZGlyZWN0SGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUENvb2tpZVByb2Nlc3NvciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUHJveHlIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJCYXNlSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUFBhc3N3b3JkTWdyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQUGFzc3dvcmRNZ3JXaXRoRGVmYXVsdFJlYWxtIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJBYnN0cmFjdEJhc2ljQXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBCYXNpY0F1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJQcm94eUJhc2ljQXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkFic3RyYWN0RGlnZXN0QXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBEaWdlc3RBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUHJveHlEaWdlc3RBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBTSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiRmlsZUhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkZUUEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkNhY2hlRlRQSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVW5rbm93bkhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBFcnJvclByb2Nlc3NvciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJscmV0cmlldmUiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsY2xlYW51cCIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVUkxvcGVuZXIiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiRmFuY3lVUkxvcGVuZXIiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicHJveHlfYnlwYXNzIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfcmVxdWVzdF9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXF1ZXN0LCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXF1ZXN0Ll9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9yZXF1ZXN0X21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXF1ZXN0KF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIucmVxdWVzdCIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9yZXF1ZXN0IiwgIm1vdmVzLnVybGxpYi5yZXF1ZXN0IikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZShfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9yZXNwb25zZSIiIgoKCl91cmxsaWJfcmVzcG9uc2VfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJhZGRiYXNlIiwgInVybGxpYiIsICJ1cmxsaWIucmVzcG9uc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJhZGRjbG9zZWhvb2siLCAidXJsbGliIiwgInVybGxpYi5yZXNwb25zZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGluZm8iLCAidXJsbGliIiwgInVybGxpYi5yZXNwb25zZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGluZm91cmwiLCAidXJsbGliIiwgInVybGxpYi5yZXNwb25zZSIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfcmVzcG9uc2VfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVzcG9uc2UsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3Jlc3BvbnNlLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9yZXNwb25zZV9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVzcG9uc2UoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5yZXNwb25zZSIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9yZXNwb25zZSIsICJtb3Zlcy51cmxsaWIucmVzcG9uc2UiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JvYm90cGFyc2VyKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3JvYm90cGFyc2VyIiIiCgoKX3VybGxpYl9yb2JvdHBhcnNlcl9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoIlJvYm90RmlsZVBhcnNlciIsICJyb2JvdHBhcnNlciIsICJ1cmxsaWIucm9ib3RwYXJzZXIiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX3JvYm90cGFyc2VyX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JvYm90cGFyc2VyLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yb2JvdHBhcnNlci5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfcm9ib3RwYXJzZXJfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JvYm90cGFyc2VyKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIucm9ib3RwYXJzZXIiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfcm9ib3RwYXJzZXIiLCAibW92ZXMudXJsbGliLnJvYm90cGFyc2VyIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYih0eXBlcy5Nb2R1bGVUeXBlKToKCiAgICAiIiJDcmVhdGUgYSBzaXgubW92ZXMudXJsbGliIG5hbWVzcGFjZSB0aGF0IHJlc2VtYmxlcyB0aGUgUHl0aG9uIDMgbmFtZXNwYWNlIiIiCiAgICBfX3BhdGhfXyA9IFtdICAjIG1hcmsgYXMgcGFja2FnZQogICAgcGFyc2UgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9wYXJzZSIpCiAgICBlcnJvciA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX2Vycm9yIikKICAgIHJlcXVlc3QgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9yZXF1ZXN0IikKICAgIHJlc3BvbnNlID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfcmVzcG9uc2UiKQogICAgcm9ib3RwYXJzZXIgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9yb2JvdHBhcnNlciIpCgogICAgZGVmIF9fZGlyX18oc2VsZik6CiAgICAgICAgcmV0dXJuIFsncGFyc2UnLCAnZXJyb3InLCAncmVxdWVzdCcsICdyZXNwb25zZScsICdyb2JvdHBhcnNlciddCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWIoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYiIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYiIpCgoKZGVmIGFkZF9tb3ZlKG1vdmUpOgogICAgIiIiQWRkIGFuIGl0ZW0gdG8gc2l4Lm1vdmVzLiIiIgogICAgc2V0YXR0cihfTW92ZWRJdGVtcywgbW92ZS5uYW1lLCBtb3ZlKQoKCmRlZiByZW1vdmVfbW92ZShuYW1lKToKICAgICIiIlJlbW92ZSBpdGVtIGZyb20gc2l4Lm1vdmVzLiIiIgogICAgdHJ5OgogICAgICAgIGRlbGF0dHIoX01vdmVkSXRlbXMsIG5hbWUpCiAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBkZWwgbW92ZXMuX19kaWN0X19bbmFtZV0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHJhaXNlIEF0dHJpYnV0ZUVycm9yKCJubyBzdWNoIG1vdmUsICVyIiAlIChuYW1lLCkpCgoKaWYgUFkzOgogICAgX21ldGhfZnVuYyA9ICJfX2Z1bmNfXyIKICAgIF9tZXRoX3NlbGYgPSAiX19zZWxmX18iCgogICAgX2Z1bmNfY2xvc3VyZSA9ICJfX2Nsb3N1cmVfXyIKICAgIF9mdW5jX2NvZGUgPSAiX19jb2RlX18iCiAgICBfZnVuY19kZWZhdWx0cyA9ICJfX2RlZmF1bHRzX18iCiAgICBfZnVuY19nbG9iYWxzID0gIl9fZ2xvYmFsc19fIgplbHNlOgogICAgX21ldGhfZnVuYyA9ICJpbV9mdW5jIgogICAgX21ldGhfc2VsZiA9ICJpbV9zZWxmIgoKICAgIF9mdW5jX2Nsb3N1cmUgPSAiZnVuY19jbG9zdXJlIgogICAgX2Z1bmNfY29kZSA9ICJmdW5jX2NvZGUiCiAgICBfZnVuY19kZWZhdWx0cyA9ICJmdW5jX2RlZmF1bHRzIgogICAgX2Z1bmNfZ2xvYmFscyA9ICJmdW5jX2dsb2JhbHMiCgoKdHJ5OgogICAgYWR2YW5jZV9pdGVyYXRvciA9IG5leHQKZXhjZXB0IE5hbWVFcnJvcjoKICAgIGRlZiBhZHZhbmNlX2l0ZXJhdG9yKGl0KToKICAgICAgICByZXR1cm4gaXQubmV4dCgpCm5leHQgPSBhZHZhbmNlX2l0ZXJhdG9yCgoKdHJ5OgogICAgY2FsbGFibGUgPSBjYWxsYWJsZQpleGNlcHQgTmFtZUVycm9yOgogICAgZGVmIGNhbGxhYmxlKG9iaik6CiAgICAgICAgcmV0dXJuIGFueSgiX19jYWxsX18iIGluIGtsYXNzLl9fZGljdF9fIGZvciBrbGFzcyBpbiB0eXBlKG9iaikuX19tcm9fXykKCgppZiBQWTM6CiAgICBkZWYgZ2V0X3VuYm91bmRfZnVuY3Rpb24odW5ib3VuZCk6CiAgICAgICAgcmV0dXJuIHVuYm91bmQKCiAgICBjcmVhdGVfYm91bmRfbWV0aG9kID0gdHlwZXMuTWV0aG9kVHlwZQoKICAgIGRlZiBjcmVhdGVfdW5ib3VuZF9tZXRob2QoZnVuYywgY2xzKToKICAgICAgICByZXR1cm4gZnVuYwoKICAgIEl0ZXJhdG9yID0gb2JqZWN0CmVsc2U6CiAgICBkZWYgZ2V0X3VuYm91bmRfZnVuY3Rpb24odW5ib3VuZCk6CiAgICAgICAgcmV0dXJuIHVuYm91bmQuaW1fZnVuYwoKICAgIGRlZiBjcmVhdGVfYm91bmRfbWV0aG9kKGZ1bmMsIG9iaik6CiAgICAgICAgcmV0dXJuIHR5cGVzLk1ldGhvZFR5cGUoZnVuYywgb2JqLCBvYmouX19jbGFzc19fKQoKICAgIGRlZiBjcmVhdGVfdW5ib3VuZF9tZXRob2QoZnVuYywgY2xzKToKICAgICAgICByZXR1cm4gdHlwZXMuTWV0aG9kVHlwZShmdW5jLCBOb25lLCBjbHMpCgogICAgY2xhc3MgSXRlcmF0b3Iob2JqZWN0KToKCiAgICAgICAgZGVmIG5leHQoc2VsZik6CiAgICAgICAgICAgIHJldHVybiB0eXBlKHNlbGYpLl9fbmV4dF9fKHNlbGYpCgogICAgY2FsbGFibGUgPSBjYWxsYWJsZQpfYWRkX2RvYyhnZXRfdW5ib3VuZF9mdW5jdGlvbiwKICAgICAgICAgIiIiR2V0IHRoZSBmdW5jdGlvbiBvdXQgb2YgYSBwb3NzaWJseSB1bmJvdW5kIGZ1bmN0aW9uIiIiKQoKCmdldF9tZXRob2RfZnVuY3Rpb24gPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9tZXRoX2Z1bmMpCmdldF9tZXRob2Rfc2VsZiA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX21ldGhfc2VsZikKZ2V0X2Z1bmN0aW9uX2Nsb3N1cmUgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9mdW5jX2Nsb3N1cmUpCmdldF9mdW5jdGlvbl9jb2RlID0gb3BlcmF0b3IuYXR0cmdldHRlcihfZnVuY19jb2RlKQpnZXRfZnVuY3Rpb25fZGVmYXVsdHMgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9mdW5jX2RlZmF1bHRzKQpnZXRfZnVuY3Rpb25fZ2xvYmFscyA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfZ2xvYmFscykKCgppZiBQWTM6CiAgICBkZWYgaXRlcmtleXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC5rZXlzKCoqa3cpKQoKICAgIGRlZiBpdGVydmFsdWVzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBpdGVyKGQudmFsdWVzKCoqa3cpKQoKICAgIGRlZiBpdGVyaXRlbXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC5pdGVtcygqKmt3KSkKCiAgICBkZWYgaXRlcmxpc3RzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBpdGVyKGQubGlzdHMoKiprdykpCgogICAgdmlld2tleXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoImtleXMiKQoKICAgIHZpZXd2YWx1ZXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZhbHVlcyIpCgogICAgdmlld2l0ZW1zID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJpdGVtcyIpCmVsc2U6CiAgICBkZWYgaXRlcmtleXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGQuaXRlcmtleXMoKiprdykKCiAgICBkZWYgaXRlcnZhbHVlcyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gZC5pdGVydmFsdWVzKCoqa3cpCgogICAgZGVmIGl0ZXJpdGVtcyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gZC5pdGVyaXRlbXMoKiprdykKCiAgICBkZWYgaXRlcmxpc3RzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJsaXN0cygqKmt3KQoKICAgIHZpZXdrZXlzID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJ2aWV3a2V5cyIpCgogICAgdmlld3ZhbHVlcyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigidmlld3ZhbHVlcyIpCgogICAgdmlld2l0ZW1zID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJ2aWV3aXRlbXMiKQoKX2FkZF9kb2MoaXRlcmtleXMsICJSZXR1cm4gYW4gaXRlcmF0b3Igb3ZlciB0aGUga2V5cyBvZiBhIGRpY3Rpb25hcnkuIikKX2FkZF9kb2MoaXRlcnZhbHVlcywgIlJldHVybiBhbiBpdGVyYXRvciBvdmVyIHRoZSB2YWx1ZXMgb2YgYSBkaWN0aW9uYXJ5LiIpCl9hZGRfZG9jKGl0ZXJpdGVtcywKICAgICAgICAgIlJldHVybiBhbiBpdGVyYXRvciBvdmVyIHRoZSAoa2V5LCB2YWx1ZSkgcGFpcnMgb2YgYSBkaWN0aW9uYXJ5LiIpCl9hZGRfZG9jKGl0ZXJsaXN0cywKICAgICAgICAgIlJldHVybiBhbiBpdGVyYXRvciBvdmVyIHRoZSAoa2V5LCBbdmFsdWVzXSkgcGFpcnMgb2YgYSBkaWN0aW9uYXJ5LiIpCgoKaWYgUFkzOgogICAgZGVmIGIocyk6CiAgICAgICAgcmV0dXJuIHMuZW5jb2RlKCJsYXRpbi0xIikKCiAgICBkZWYgdShzKToKICAgICAgICByZXR1cm4gcwogICAgdW5pY2hyID0gY2hyCiAgICBpbXBvcnQgc3RydWN0CiAgICBpbnQyYnl0ZSA9IHN0cnVjdC5TdHJ1Y3QoIj5CIikucGFjawogICAgZGVsIHN0cnVjdAogICAgYnl0ZTJpbnQgPSBvcGVyYXRvci5pdGVtZ2V0dGVyKDApCiAgICBpbmRleGJ5dGVzID0gb3BlcmF0b3IuZ2V0aXRlbQogICAgaXRlcmJ5dGVzID0gaXRlcgogICAgaW1wb3J0IGlvCiAgICBTdHJpbmdJTyA9IGlvLlN0cmluZ0lPCiAgICBCeXRlc0lPID0gaW8uQnl0ZXNJTwogICAgX2Fzc2VydENvdW50RXF1YWwgPSAiYXNzZXJ0Q291bnRFcXVhbCIKICAgIGlmIHN5cy52ZXJzaW9uX2luZm9bMV0gPD0gMToKICAgICAgICBfYXNzZXJ0UmFpc2VzUmVnZXggPSAiYXNzZXJ0UmFpc2VzUmVnZXhwIgogICAgICAgIF9hc3NlcnRSZWdleCA9ICJhc3NlcnRSZWdleHBNYXRjaGVzIgogICAgZWxzZToKICAgICAgICBfYXNzZXJ0UmFpc2VzUmVnZXggPSAiYXNzZXJ0UmFpc2VzUmVnZXgiCiAgICAgICAgX2Fzc2VydFJlZ2V4ID0gImFzc2VydFJlZ2V4IgplbHNlOgogICAgZGVmIGIocyk6CiAgICAgICAgcmV0dXJuIHMKICAgICMgV29ya2Fyb3VuZCBmb3Igc3RhbmRhbG9uZSBiYWNrc2xhc2gKCiAgICBkZWYgdShzKToKICAgICAgICByZXR1cm4gdW5pY29kZShzLnJlcGxhY2UocidcXCcsIHInXFxcXCcpLCAidW5pY29kZV9lc2NhcGUiKQogICAgdW5pY2hyID0gdW5pY2hyCiAgICBpbnQyYnl0ZSA9IGNocgoKICAgIGRlZiBieXRlMmludChicyk6CiAgICAgICAgcmV0dXJuIG9yZChic1swXSkKCiAgICBkZWYgaW5kZXhieXRlcyhidWYsIGkpOgogICAgICAgIHJldHVybiBvcmQoYnVmW2ldKQogICAgaXRlcmJ5dGVzID0gZnVuY3Rvb2xzLnBhcnRpYWwoaXRlcnRvb2xzLmltYXAsIG9yZCkKICAgIGltcG9ydCBTdHJpbmdJTwogICAgU3RyaW5nSU8gPSBCeXRlc0lPID0gU3RyaW5nSU8uU3RyaW5nSU8KICAgIF9hc3NlcnRDb3VudEVxdWFsID0gImFzc2VydEl0ZW1zRXF1YWwiCiAgICBfYXNzZXJ0UmFpc2VzUmVnZXggPSAiYXNzZXJ0UmFpc2VzUmVnZXhwIgogICAgX2Fzc2VydFJlZ2V4ID0gImFzc2VydFJlZ2V4cE1hdGNoZXMiCl9hZGRfZG9jKGIsICIiIkJ5dGUgbGl0ZXJhbCIiIikKX2FkZF9kb2ModSwgIiIiVGV4dCBsaXRlcmFsIiIiKQoKCmRlZiBhc3NlcnRDb3VudEVxdWFsKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICByZXR1cm4gZ2V0YXR0cihzZWxmLCBfYXNzZXJ0Q291bnRFcXVhbCkoKmFyZ3MsICoqa3dhcmdzKQoKCmRlZiBhc3NlcnRSYWlzZXNSZWdleChzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgcmV0dXJuIGdldGF0dHIoc2VsZiwgX2Fzc2VydFJhaXNlc1JlZ2V4KSgqYXJncywgKiprd2FyZ3MpCgoKZGVmIGFzc2VydFJlZ2V4KHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICByZXR1cm4gZ2V0YXR0cihzZWxmLCBfYXNzZXJ0UmVnZXgpKCphcmdzLCAqKmt3YXJncykKCgppZiBQWTM6CiAgICBleGVjXyA9IGdldGF0dHIobW92ZXMuYnVpbHRpbnMsICJleGVjIikKCiAgICBkZWYgcmVyYWlzZSh0cCwgdmFsdWUsIHRiPU5vbmUpOgogICAgICAgIGlmIHZhbHVlIGlzIE5vbmU6CiAgICAgICAgICAgIHZhbHVlID0gdHAoKQogICAgICAgIGlmIHZhbHVlLl9fdHJhY2ViYWNrX18gaXMgbm90IHRiOgogICAgICAgICAgICByYWlzZSB2YWx1ZS53aXRoX3RyYWNlYmFjayh0YikKICAgICAgICByYWlzZSB2YWx1ZQoKZWxzZToKICAgIGRlZiBleGVjXyhfY29kZV8sIF9nbG9ic189Tm9uZSwgX2xvY3NfPU5vbmUpOgogICAgICAgICIiIkV4ZWN1dGUgY29kZSBpbiBhIG5hbWVzcGFjZS4iIiIKICAgICAgICBpZiBfZ2xvYnNfIGlzIE5vbmU6CiAgICAgICAgICAgIGZyYW1lID0gc3lzLl9nZXRmcmFtZSgxKQogICAgICAgICAgICBfZ2xvYnNfID0gZnJhbWUuZl9nbG9iYWxzCiAgICAgICAgICAgIGlmIF9sb2NzXyBpcyBOb25lOgogICAgICAgICAgICAgICAgX2xvY3NfID0gZnJhbWUuZl9sb2NhbHMKICAgICAgICAgICAgZGVsIGZyYW1lCiAgICAgICAgZWxpZiBfbG9jc18gaXMgTm9uZToKICAgICAgICAgICAgX2xvY3NfID0gX2dsb2JzXwogICAgICAgIGV4ZWMoIiIiZXhlYyBfY29kZV8gaW4gX2dsb2JzXywgX2xvY3NfIiIiKQoKICAgIGV4ZWNfKCIiImRlZiByZXJhaXNlKHRwLCB2YWx1ZSwgdGI9Tm9uZSk6CiAgICByYWlzZSB0cCwgdmFsdWUsIHRiCiIiIikKCgppZiBzeXMudmVyc2lvbl9pbmZvWzoyXSA9PSAoMywgMik6CiAgICBleGVjXygiIiJkZWYgcmFpc2VfZnJvbSh2YWx1ZSwgZnJvbV92YWx1ZSk6CiAgICBpZiBmcm9tX3ZhbHVlIGlzIE5vbmU6CiAgICAgICAgcmFpc2UgdmFsdWUKICAgIHJhaXNlIHZhbHVlIGZyb20gZnJvbV92YWx1ZQoiIiIpCmVsaWYgc3lzLnZlcnNpb25faW5mb1s6Ml0gPiAoMywgMik6CiAgICBleGVjXygiIiJkZWYgcmFpc2VfZnJvbSh2YWx1ZSwgZnJvbV92YWx1ZSk6CiAgICByYWlzZSB2YWx1ZSBmcm9tIGZyb21fdmFsdWUKIiIiKQplbHNlOgogICAgZGVmIHJhaXNlX2Zyb20odmFsdWUsIGZyb21fdmFsdWUpOgogICAgICAgIHJhaXNlIHZhbHVlCgoKcHJpbnRfID0gZ2V0YXR0cihtb3Zlcy5idWlsdGlucywgInByaW50IiwgTm9uZSkKaWYgcHJpbnRfIGlzIE5vbmU6CiAgICBkZWYgcHJpbnRfKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgIiIiVGhlIG5ldy1zdHlsZSBwcmludCBmdW5jdGlvbiBmb3IgUHl0aG9uIDIuNCBhbmQgMi41LiIiIgogICAgICAgIGZwID0ga3dhcmdzLnBvcCgiZmlsZSIsIHN5cy5zdGRvdXQpCiAgICAgICAgaWYgZnAgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGRlZiB3cml0ZShkYXRhKToKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoZGF0YSwgYmFzZXN0cmluZyk6CiAgICAgICAgICAgICAgICBkYXRhID0gc3RyKGRhdGEpCiAgICAgICAgICAgICMgSWYgdGhlIGZpbGUgaGFzIGFuIGVuY29kaW5nLCBlbmNvZGUgdW5pY29kZSB3aXRoIGl0LgogICAgICAgICAgICBpZiAoaXNpbnN0YW5jZShmcCwgZmlsZSkgYW5kCiAgICAgICAgICAgICAgICAgICAgaXNpbnN0YW5jZShkYXRhLCB1bmljb2RlKSBhbmQKICAgICAgICAgICAgICAgICAgICBmcC5lbmNvZGluZyBpcyBub3QgTm9uZSk6CiAgICAgICAgICAgICAgICBlcnJvcnMgPSBnZXRhdHRyKGZwLCAiZXJyb3JzIiwgTm9uZSkKICAgICAgICAgICAgICAgIGlmIGVycm9ycyBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIGVycm9ycyA9ICJzdHJpY3QiCiAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5lbmNvZGUoZnAuZW5jb2RpbmcsIGVycm9ycykKICAgICAgICAgICAgZnAud3JpdGUoZGF0YSkKICAgICAgICB3YW50X3VuaWNvZGUgPSBGYWxzZQogICAgICAgIHNlcCA9IGt3YXJncy5wb3AoInNlcCIsIE5vbmUpCiAgICAgICAgaWYgc2VwIGlzIG5vdCBOb25lOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHNlcCwgdW5pY29kZSk6CiAgICAgICAgICAgICAgICB3YW50X3VuaWNvZGUgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2Uoc2VwLCBzdHIpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJzZXAgbXVzdCBiZSBOb25lIG9yIGEgc3RyaW5nIikKICAgICAgICBlbmQgPSBrd2FyZ3MucG9wKCJlbmQiLCBOb25lKQogICAgICAgIGlmIGVuZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShlbmQsIHVuaWNvZGUpOgogICAgICAgICAgICAgICAgd2FudF91bmljb2RlID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5vdCBpc2luc3RhbmNlKGVuZCwgc3RyKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiZW5kIG11c3QgYmUgTm9uZSBvciBhIHN0cmluZyIpCiAgICAgICAgaWYga3dhcmdzOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoImludmFsaWQga2V5d29yZCBhcmd1bWVudHMgdG8gcHJpbnQoKSIpCiAgICAgICAgaWYgbm90IHdhbnRfdW5pY29kZToKICAgICAgICAgICAgZm9yIGFyZyBpbiBhcmdzOgogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShhcmcsIHVuaWNvZGUpOgogICAgICAgICAgICAgICAgICAgIHdhbnRfdW5pY29kZSA9IFRydWUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGlmIHdhbnRfdW5pY29kZToKICAgICAgICAgICAgbmV3bGluZSA9IHVuaWNvZGUoIlxuIikKICAgICAgICAgICAgc3BhY2UgPSB1bmljb2RlKCIgIikKICAgICAgICBlbHNlOgogICAgICAgICAgICBuZXdsaW5lID0gIlxuIgogICAgICAgICAgICBzcGFjZSA9ICIgIgogICAgICAgIGlmIHNlcCBpcyBOb25lOgogICAgICAgICAgICBzZXAgPSBzcGFjZQogICAgICAgIGlmIGVuZCBpcyBOb25lOgogICAgICAgICAgICBlbmQgPSBuZXdsaW5lCiAgICAgICAgZm9yIGksIGFyZyBpbiBlbnVtZXJhdGUoYXJncyk6CiAgICAgICAgICAgIGlmIGk6CiAgICAgICAgICAgICAgICB3cml0ZShzZXApCiAgICAgICAgICAgIHdyaXRlKGFyZykKICAgICAgICB3cml0ZShlbmQpCmlmIHN5cy52ZXJzaW9uX2luZm9bOjJdIDwgKDMsIDMpOgogICAgX3ByaW50ID0gcHJpbnRfCgogICAgZGVmIHByaW50XygqYXJncywgKiprd2FyZ3MpOgogICAgICAgIGZwID0ga3dhcmdzLmdldCgiZmlsZSIsIHN5cy5zdGRvdXQpCiAgICAgICAgZmx1c2ggPSBrd2FyZ3MucG9wKCJmbHVzaCIsIEZhbHNlKQogICAgICAgIF9wcmludCgqYXJncywgKiprd2FyZ3MpCiAgICAgICAgaWYgZmx1c2ggYW5kIGZwIGlzIG5vdCBOb25lOgogICAgICAgICAgICBmcC5mbHVzaCgpCgpfYWRkX2RvYyhyZXJhaXNlLCAiIiJSZXJhaXNlIGFuIGV4Y2VwdGlvbi4iIiIpCgppZiBzeXMudmVyc2lvbl9pbmZvWzA6Ml0gPCAoMywgNCk6CiAgICBkZWYgd3JhcHMod3JhcHBlZCwgYXNzaWduZWQ9ZnVuY3Rvb2xzLldSQVBQRVJfQVNTSUdOTUVOVFMsCiAgICAgICAgICAgICAgdXBkYXRlZD1mdW5jdG9vbHMuV1JBUFBFUl9VUERBVEVTKToKICAgICAgICBkZWYgd3JhcHBlcihmKToKICAgICAgICAgICAgZiA9IGZ1bmN0b29scy53cmFwcyh3cmFwcGVkLCBhc3NpZ25lZCwgdXBkYXRlZCkoZikKICAgICAgICAgICAgZi5fX3dyYXBwZWRfXyA9IHdyYXBwZWQKICAgICAgICAgICAgcmV0dXJuIGYKICAgICAgICByZXR1cm4gd3JhcHBlcgplbHNlOgogICAgd3JhcHMgPSBmdW5jdG9vbHMud3JhcHMKCgpkZWYgd2l0aF9tZXRhY2xhc3MobWV0YSwgKmJhc2VzKToKICAgICIiIkNyZWF0ZSBhIGJhc2UgY2xhc3Mgd2l0aCBhIG1ldGFjbGFzcy4iIiIKICAgICMgVGhpcyByZXF1aXJlcyBhIGJpdCBvZiBleHBsYW5hdGlvbjogdGhlIGJhc2ljIGlkZWEgaXMgdG8gbWFrZSBhIGR1bW15CiAgICAjIG1ldGFjbGFzcyBmb3Igb25lIGxldmVsIG9mIGNsYXNzIGluc3RhbnRpYXRpb24gdGhhdCByZXBsYWNlcyBpdHNlbGYgd2l0aAogICAgIyB0aGUgYWN0dWFsIG1ldGFjbGFzcy4KICAgIGNsYXNzIG1ldGFjbGFzcyhtZXRhKToKCiAgICAgICAgZGVmIF9fbmV3X18oY2xzLCBuYW1lLCB0aGlzX2Jhc2VzLCBkKToKICAgICAgICAgICAgcmV0dXJuIG1ldGEobmFtZSwgYmFzZXMsIGQpCiAgICByZXR1cm4gdHlwZS5fX25ld19fKG1ldGFjbGFzcywgJ3RlbXBvcmFyeV9jbGFzcycsICgpLCB7fSkKCgpkZWYgYWRkX21ldGFjbGFzcyhtZXRhY2xhc3MpOgogICAgIiIiQ2xhc3MgZGVjb3JhdG9yIGZvciBjcmVhdGluZyBhIGNsYXNzIHdpdGggYSBtZXRhY2xhc3MuIiIiCiAgICBkZWYgd3JhcHBlcihjbHMpOgogICAgICAgIG9yaWdfdmFycyA9IGNscy5fX2RpY3RfXy5jb3B5KCkKICAgICAgICBzbG90cyA9IG9yaWdfdmFycy5nZXQoJ19fc2xvdHNfXycpCiAgICAgICAgaWYgc2xvdHMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc2xvdHMsIHN0cik6CiAgICAgICAgICAgICAgICBzbG90cyA9IFtzbG90c10KICAgICAgICAgICAgZm9yIHNsb3RzX3ZhciBpbiBzbG90czoKICAgICAgICAgICAgICAgIG9yaWdfdmFycy5wb3Aoc2xvdHNfdmFyKQogICAgICAgIG9yaWdfdmFycy5wb3AoJ19fZGljdF9fJywgTm9uZSkKICAgICAgICBvcmlnX3ZhcnMucG9wKCdfX3dlYWtyZWZfXycsIE5vbmUpCiAgICAgICAgcmV0dXJuIG1ldGFjbGFzcyhjbHMuX19uYW1lX18sIGNscy5fX2Jhc2VzX18sIG9yaWdfdmFycykKICAgIHJldHVybiB3cmFwcGVyCgoKZGVmIHB5dGhvbl8yX3VuaWNvZGVfY29tcGF0aWJsZShrbGFzcyk6CiAgICAiIiIKICAgIEEgZGVjb3JhdG9yIHRoYXQgZGVmaW5lcyBfX3VuaWNvZGVfXyBhbmQgX19zdHJfXyBtZXRob2RzIHVuZGVyIFB5dGhvbiAyLgogICAgVW5kZXIgUHl0aG9uIDMgaXQgZG9lcyBub3RoaW5nLgoKICAgIFRvIHN1cHBvcnQgUHl0aG9uIDIgYW5kIDMgd2l0aCBhIHNpbmdsZSBjb2RlIGJhc2UsIGRlZmluZSBhIF9fc3RyX18gbWV0aG9kCiAgICByZXR1cm5pbmcgdGV4dCBhbmQgYXBwbHkgdGhpcyBkZWNvcmF0b3IgdG8gdGhlIGNsYXNzLgogICAgIiIiCiAgICBpZiBQWTI6CiAgICAgICAgaWYgJ19fc3RyX18nIG5vdCBpbiBrbGFzcy5fX2RpY3RfXzoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiQHB5dGhvbl8yX3VuaWNvZGVfY29tcGF0aWJsZSBjYW5ub3QgYmUgYXBwbGllZCAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRvICVzIGJlY2F1c2UgaXQgZG9lc24ndCBkZWZpbmUgX19zdHJfXygpLiIgJQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtsYXNzLl9fbmFtZV9fKQogICAgICAgIGtsYXNzLl9fdW5pY29kZV9fID0ga2xhc3MuX19zdHJfXwogICAgICAgIGtsYXNzLl9fc3RyX18gPSBsYW1iZGEgc2VsZjogc2VsZi5fX3VuaWNvZGVfXygpLmVuY29kZSgndXRmLTgnKQogICAgcmV0dXJuIGtsYXNzCgoKIyBDb21wbGV0ZSB0aGUgbW92ZXMgaW1wbGVtZW50YXRpb24uCiMgVGhpcyBjb2RlIGlzIGF0IHRoZSBlbmQgb2YgdGhpcyBtb2R1bGUgdG8gc3BlZWQgdXAgbW9kdWxlIGxvYWRpbmcuCiMgVHVybiB0aGlzIG1vZHVsZSBpbnRvIGEgcGFja2FnZS4KX19wYXRoX18gPSBbXSAgIyByZXF1aXJlZCBmb3IgUEVQIDMwMiBhbmQgUEVQIDQ1MQpfX3BhY2thZ2VfXyA9IF9fbmFtZV9fICAjIHNlZSBQRVAgMzY2IEBSZXNlcnZlZEFzc2lnbm1lbnQKaWYgZ2xvYmFscygpLmdldCgiX19zcGVjX18iKSBpcyBub3QgTm9uZToKICAgIF9fc3BlY19fLnN1Ym1vZHVsZV9zZWFyY2hfbG9jYXRpb25zID0gW10gICMgUEVQIDQ1MSBAVW5kZWZpbmVkVmFyaWFibGUKIyBSZW1vdmUgb3RoZXIgc2l4IG1ldGEgcGF0aCBpbXBvcnRlcnMsIHNpbmNlIHRoZXkgY2F1c2UgcHJvYmxlbXMuIFRoaXMgY2FuCiMgaGFwcGVuIGlmIHNpeCBpcyByZW1vdmVkIGZyb20gc3lzLm1vZHVsZXMgYW5kIHRoZW4gcmVsb2FkZWQuIChTZXR1cHRvb2xzIGRvZXMKIyB0aGlzIGZvciBzb21lIHJlYXNvbi4pCmlmIHN5cy5tZXRhX3BhdGg6CiAgICBmb3IgaSwgaW1wb3J0ZXIgaW4gZW51bWVyYXRlKHN5cy5tZXRhX3BhdGgpOgogICAgICAgICMgSGVyZSdzIHNvbWUgcmVhbCBuYXN0aW5lc3M6IEFub3RoZXIgImluc3RhbmNlIiBvZiB0aGUgc2l4IG1vZHVsZSBtaWdodAogICAgICAgICMgYmUgZmxvYXRpbmcgYXJvdW5kLiBUaGVyZWZvcmUsIHdlIGNhbid0IHVzZSBpc2luc3RhbmNlKCkgdG8gY2hlY2sgZm9yCiAgICAgICAgIyB0aGUgc2l4IG1ldGEgcGF0aCBpbXBvcnRlciwgc2luY2UgdGhlIG90aGVyIHNpeCBpbnN0YW5jZSB3aWxsIGhhdmUKICAgICAgICAjIGluc2VydGVkIGFuIGltcG9ydGVyIHdpdGggZGlmZmVyZW50IGNsYXNzLgogICAgICAgIGlmICh0eXBlKGltcG9ydGVyKS5fX25hbWVfXyA9PSAiX1NpeE1ldGFQYXRoSW1wb3J0ZXIiIGFuZAogICAgICAgICAgICAgICAgaW1wb3J0ZXIubmFtZSA9PSBfX25hbWVfXyk6CiAgICAgICAgICAgIGRlbCBzeXMubWV0YV9wYXRoW2ldCiAgICAgICAgICAgIGJyZWFrCiAgICBkZWwgaSwgaW1wb3J0ZXIKIyBGaW5hbGx5LCBhZGQgdGhlIGltcG9ydGVyIHRvIHRoZSBtZXRhIHBhdGggaW1wb3J0IGhvb2suCnN5cy5tZXRhX3BhdGguYXBwZW5kKF9pbXBvcnRlcikKUEsDBBQAAAAAANS7K0umzEeScQsAAHELAAAiAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvY29ubmVjdGlvbi5weSMKIyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojIFRoaXMgcGFydGljdWxhciBmaWxlIHNuaXBwZXQsIGFuZCB0aGlzIGZpbGUgc25pcHBldCBvbmx5LCBpcyBCU0QgbGljZW5zZWQuCiMgTW9kdWxlcyB5b3Ugd3JpdGUgdXNpbmcgdGhpcyBzbmlwcGV0LCB3aGljaCBpcyBlbWJlZGRlZCBkeW5hbWljYWxseSBieSBBbnNpYmxlCiMgc3RpbGwgYmVsb25nIHRvIHRoZSBhdXRob3Igb2YgdGhlIG1vZHVsZSwgYW5kIG1heSBhc3NpZ24gdGhlaXIgb3duIGxpY2Vuc2UKIyB0byB0aGUgY29tcGxldGUgd29yay4KIwojIChjKSAyMDE3IFJlZCBIYXQgSW5jLgojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwKIyBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiMgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICAgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICAgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKIyBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAojIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4KIyBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwKIyBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sCiMgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCiMgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVAojIExJQUJJTElUWSwgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRQojIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCmltcG9ydCBzb2NrZXQKaW1wb3J0IHN0cnVjdAppbXBvcnQgc2lnbmFsCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmJhc2ljIGltcG9ydCBnZXRfZXhjZXB0aW9uCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuX3RleHQgaW1wb3J0IHRvX2J5dGVzLCB0b19uYXRpdmUKCmRlZiBzZW5kX2RhdGEocywgZGF0YSk6CiAgICBwYWNrZWRfbGVuID0gc3RydWN0LnBhY2soJyFRJyxsZW4oZGF0YSkpCiAgICByZXR1cm4gcy5zZW5kYWxsKHBhY2tlZF9sZW4gKyBkYXRhKQoKZGVmIHJlY3ZfZGF0YShzKToKICAgIGhlYWRlcl9sZW4gPSA4ICMgc2l6ZSBvZiBhIHBhY2tlZCB1bnNpZ25lZCBsb25nIGxvbmcKICAgIGRhdGEgPSB0b19ieXRlcygiIikKICAgIHdoaWxlIGxlbihkYXRhKSA8IGhlYWRlcl9sZW46CiAgICAgICAgZCA9IHMucmVjdihoZWFkZXJfbGVuIC0gbGVuKGRhdGEpKQogICAgICAgIGlmIG5vdCBkOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGRhdGEgKz0gZAogICAgZGF0YV9sZW4gPSBzdHJ1Y3QudW5wYWNrKCchUScsZGF0YVs6aGVhZGVyX2xlbl0pWzBdCiAgICBkYXRhID0gZGF0YVtoZWFkZXJfbGVuOl0KICAgIHdoaWxlIGxlbihkYXRhKSA8IGRhdGFfbGVuOgogICAgICAgIGQgPSBzLnJlY3YoZGF0YV9sZW4gLSBsZW4oZGF0YSkpCiAgICAgICAgaWYgbm90IGQ6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgZGF0YSArPSBkCiAgICByZXR1cm4gZGF0YQoKZGVmIGV4ZWNfY29tbWFuZChtb2R1bGUsIGNvbW1hbmQpOgogICAgdHJ5OgogICAgICAgIHNmID0gc29ja2V0LnNvY2tldChzb2NrZXQuQUZfVU5JWCwgc29ja2V0LlNPQ0tfU1RSRUFNKQogICAgICAgIHNmLmNvbm5lY3QobW9kdWxlLl9zb2NrZXRfcGF0aCkKCiAgICAgICAgZGF0YSA9ICJFWEVDOiAlcyIgJSBjb21tYW5kCiAgICAgICAgc2VuZF9kYXRhKHNmLCB0b19ieXRlcyhkYXRhLnN0cmlwKCkpKQoKICAgICAgICByYyA9IGludChyZWN2X2RhdGEoc2YpLCAxMCkKICAgICAgICBzdGRvdXQgPSByZWN2X2RhdGEoc2YpCiAgICAgICAgc3RkZXJyID0gcmVjdl9kYXRhKHNmKQogICAgZXhjZXB0IHNvY2tldC5lcnJvcjoKICAgICAgICBleGMgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICBzZi5jbG9zZSgpCiAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9J3VuYWJsZSB0byBjb25uZWN0IHRvIHNvY2tldCcsIGVycj1zdHIoZXhjKSkKCiAgICBzZi5jbG9zZSgpCgogICAgcmV0dXJuIChyYywgdG9fbmF0aXZlKHN0ZG91dCksIHRvX25hdGl2ZShzdGRlcnIpKQpQSwMEFAAAAAAA1LsrSzeqZkL6FwAA+hcAACYAAABhbnNpYmxlL21vZHVsZV91dGlscy9uZXR3b3JrX2NvbW1vbi5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyAoYykgMjAxNiBSZWQgSGF0IEluYy4KIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dCBtb2RpZmljYXRpb24sCiMgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAojICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5ECiMgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRUQKIyBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuCiMgSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsCiMgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLAojIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUwojIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QKIyBMSUFCSUxJVFksIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUKIyBVU0UgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpbXBvcnQgaXRlcml0ZW1zCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuYmFzaWMgaW1wb3J0IEFuc2libGVGYWxsYmFja05vdEZvdW5kCgpkZWYgdG9fbGlzdCh2YWwpOgogICAgaWYgaXNpbnN0YW5jZSh2YWwsIChsaXN0LCB0dXBsZSwgc2V0KSk6CiAgICAgICAgcmV0dXJuIGxpc3QodmFsKQogICAgZWxpZiB2YWwgaXMgbm90IE5vbmU6CiAgICAgICAgcmV0dXJuIFt2YWxdCiAgICBlbHNlOgogICAgICAgIHJldHVybiBsaXN0KCkKCmNsYXNzIENvbXBsZXhEaWN0KG9iamVjdCk6CiAgICAiIiJUcmFuc2Zvcm1zIGEgZGljdCB0byB3aXRoIGFuIGFyZ3VtZW50IHNwZWMKCiAgICBUaGlzIGNsYXNzIHdpbGwgdGFrZSBhIGRpY3QgYW5kIGFwcGx5IGFuIEFuc2libGUgYXJndW1lbnQgc3BlYyB0byB0aGUKICAgIHZhbHVlcy4gIFRoZSByZXN1bHRpbmcgZGljdCB3aWxsIGNvbnRhaW4gYWxsIG9mIHRoZSBrZXlzIGluIHRoZSBwYXJhbQogICAgd2l0aCBhcHByb3ByaWF0ZSB2YWx1ZXMgc2V0LgoKICAgIEV4YW1wbGU6OgoKICAgICAgICBhcmd1bWVudF9zcGVjID0gZGljdCgKICAgICAgICAgICAgY29tbWFuZD1kaWN0KGtleT1UcnVlKSwKICAgICAgICAgICAgZGlzcGxheT1kaWN0KGRlZmF1bHQ9J3RleHQnLCBjaG9pY2VzPVsndGV4dCcsICdqc29uJ10pLAogICAgICAgICAgICB2YWxpZGF0ZT1kaWN0KHR5cGU9J2Jvb2wnKQogICAgICAgICkKICAgICAgICB0cmFuc2Zvcm0gPSBDb21wbGV4RGljdChhcmd1bWVudF9zcGVjLCBtb2R1bGUpCiAgICAgICAgdmFsdWUgPSBkaWN0KGNvbW1hbmQ9J2ZvbycpCiAgICAgICAgcmVzdWx0ID0gdHJhbnNmb3JtKHZhbHVlKQogICAgICAgIHByaW50IHJlc3VsdAogICAgICAgIHsnY29tbWFuZCc6ICdmb28nLCAnZGlzcGxheSc6ICd0ZXh0JywgJ3ZhbGlkYXRlJzogTm9uZX0KCiAgICBTdXBwb3J0ZWQgYXJndW1lbnQgc3BlYzoKICAgICAgICAqIGtleSAtIHNwZWNpZmllcyBob3cgdG8gbWFwIGEgc2luZ2xlIHZhbHVlIHRvIGEgZGljdAogICAgICAgICogcmVhZF9mcm9tIC0gcmVhZCBhbmQgYXBwbHkgdGhlIGFyZ3VtZW50X3NwZWMgZnJvbSB0aGUgbW9kdWxlCiAgICAgICAgKiByZXF1aXJlZCAtIGEgdmFsdWUgaXMgcmVxdWlyZWQKICAgICAgICAqIHR5cGUgLSB0eXBlIG9mIHZhbHVlICh1c2VzIEFuc2libGVNb2R1bGUgdHlwZSBjaGVja2VyKQogICAgICAgICogZmFsbGJhY2sgLSBpbXBsZW1lbnRzIGZhbGxiYWNrIGZ1bmN0aW9uCiAgICAgICAgKiBjaG9pY2VzIC0gc2V0IG9mIHZhbGlkIG9wdGlvbnMKICAgICAgICAqIGRlZmF1bHQgLSBkZWZhdWx0IHZhbHVlCgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGF0dHJzLCBtb2R1bGUpOgogICAgICAgIHNlbGYuX2F0dHJpYnV0ZXMgPSBhdHRycwogICAgICAgIHNlbGYuX21vZHVsZSA9IG1vZHVsZQogICAgICAgIHNlbGYuYXR0cl9uYW1lcyA9IGZyb3plbnNldChzZWxmLl9hdHRyaWJ1dGVzLmtleXMoKSkKCiAgICAgICAgc2VsZi5faGFzX2tleSA9IEZhbHNlCiAgICAgICAgZm9yIG5hbWUsIGF0dHIgaW4gaXRlcml0ZW1zKHNlbGYuX2F0dHJpYnV0ZXMpOgogICAgICAgICAgICBpZiBhdHRyLmdldCgncmVhZF9mcm9tJyk6CiAgICAgICAgICAgICAgICBzcGVjID0gc2VsZi5fbW9kdWxlLmFyZ3VtZW50X3NwZWMuZ2V0KGF0dHJbJ3JlYWRfZnJvbSddKQogICAgICAgICAgICAgICAgaWYgbm90IHNwZWM6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignYXJndW1lbnRfc3BlYyAlcyBkb2VzIG5vdCBleGlzdCcgJSAgYXR0clsncmVhZF9mcm9tJ10pCiAgICAgICAgICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBpdGVyaXRlbXMoc3BlYyk6CiAgICAgICAgICAgICAgICAgICAgaWYga2V5IG5vdCBpbiBhdHRyOgogICAgICAgICAgICAgICAgICAgICAgICBhdHRyW2tleV0gPSB2YWx1ZQoKICAgICAgICAgICAgaWYgYXR0ci5nZXQoJ2tleScpOgogICAgICAgICAgICAgICAgaWYgc2VsZi5faGFzX2tleToKICAgICAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdvbmx5IG9uZSBrZXkgdmFsdWUgY2FuIGJlIHNwZWNpZmllZCcpCiAgICAgICAgICAgICAgICBzZWxmX2hhc19rZXkgPSBUcnVlCiAgICAgICAgICAgICAgICBhdHRyWydyZXF1aXJlZCddID0gVHJ1ZQoKCiAgICBkZWYgX2RpY3Qoc2VsZiwgdmFsdWUpOgogICAgICAgIG9iaiA9IHt9CiAgICAgICAgZm9yIG5hbWUsIGF0dHIgaW4gaXRlcml0ZW1zKHNlbGYuX2F0dHJpYnV0ZXMpOgogICAgICAgICAgICBpZiBhdHRyLmdldCgna2V5Jyk6CiAgICAgICAgICAgICAgICBvYmpbbmFtZV0gPSB2YWx1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb2JqW25hbWVdID0gYXR0ci5nZXQoJ2RlZmF1bHQnKQogICAgICAgIHJldHVybiBvYmoKCiAgICBkZWYgX19jYWxsX18oc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHZhbHVlLCBkaWN0KToKICAgICAgICAgICAgdmFsdWUgPSBzZWxmLl9kaWN0KHZhbHVlKQoKICAgICAgICB1bmtub3duID0gc2V0KHZhbHVlKS5kaWZmZXJlbmNlKHNlbGYuYXR0cl9uYW1lcykKICAgICAgICBpZiB1bmtub3duOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdpbnZhbGlkIGtleXM6ICVzJyAlICcsJy5qb2luKHVua25vd24pKQoKICAgICAgICBmb3IgbmFtZSwgYXR0ciBpbiBpdGVyaXRlbXMoc2VsZi5fYXR0cmlidXRlcyk6CiAgICAgICAgICAgIGlmIG5vdCB2YWx1ZS5nZXQobmFtZSk6CiAgICAgICAgICAgICAgICB2YWx1ZVtuYW1lXSA9IGF0dHIuZ2V0KCdkZWZhdWx0JykKCiAgICAgICAgICAgIGlmIGF0dHIuZ2V0KCdmYWxsYmFjaycpIGFuZCBub3QgdmFsdWUuZ2V0KG5hbWUpOgogICAgICAgICAgICAgICAgZmFsbGJhY2sgPSBhdHRyLmdldCgnZmFsbGJhY2snLCAoTm9uZSwpKQogICAgICAgICAgICAgICAgZmFsbGJhY2tfc3RyYXRlZ3kgPSBmYWxsYmFja1swXQogICAgICAgICAgICAgICAgZmFsbGJhY2tfYXJncyA9IFtdCiAgICAgICAgICAgICAgICBmYWxsYmFja19rd2FyZ3MgPSB7fQogICAgICAgICAgICAgICAgaWYgZmFsbGJhY2tfc3RyYXRlZ3kgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgZm9yIGl0ZW0gaW4gZmFsbGJhY2tbMTpdOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGl0ZW0sIGRpY3QpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tfa3dhcmdzID0gaXRlbQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tfYXJncyA9IGl0ZW0KICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlW25hbWVdID0gZmFsbGJhY2tfc3RyYXRlZ3koKmZhbGxiYWNrX2FyZ3MsICoqZmFsbGJhY2tfa3dhcmdzKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBBbnNpYmxlRmFsbGJhY2tOb3RGb3VuZDoKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGlmIGF0dHIuZ2V0KCdyZXF1aXJlZCcpIGFuZCB2YWx1ZS5nZXQobmFtZSkgaXMgTm9uZToKICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ21pc3NpbmcgcmVxdWlyZWQgYXR0cmlidXRlICVzJyAlIG5hbWUpCgogICAgICAgICAgICBpZiAnY2hvaWNlcycgaW4gYXR0cjoKICAgICAgICAgICAgICAgIGlmIHZhbHVlW25hbWVdIG5vdCBpbiBhdHRyWydjaG9pY2VzJ106CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignJXMgbXVzdCBiZSBvbmUgb2YgJXMsIGdvdCAlcycgJSBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAobmFtZSwgJywgJy5qb2luKGF0dHJbJ2Nob2ljZXMnXSksIHZhbHVlW25hbWVdKSkKCiAgICAgICAgICAgIGlmIHZhbHVlW25hbWVdIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdmFsdWVfdHlwZSA9IGF0dHIuZ2V0KCd0eXBlJywgJ3N0cicpCiAgICAgICAgICAgICAgICB0eXBlX2NoZWNrZXIgPSBzZWxmLl9tb2R1bGUuX0NIRUNLX0FSR1VNRU5UX1RZUEVTX0RJU1BBVENIRVJbdmFsdWVfdHlwZV0KICAgICAgICAgICAgICAgIHR5cGVfY2hlY2tlcih2YWx1ZVtuYW1lXSkKCiAgICAgICAgcmV0dXJuIHZhbHVlCgpjbGFzcyBDb21wbGV4TGlzdChDb21wbGV4RGljdCk6CiAgICAiIiJFeHRlbmRzIGBgYENvbXBsZXhEaWN0YGBgIHRvIGhhbmRsZSBhICBsaXN0IG9mIGRpY3RzICIiIgoKICAgIGRlZiBfX2NhbGxfXyhzZWxmLCB2YWx1ZXMpOgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHZhbHVlcywgKGxpc3QsIHR1cGxlKSk6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigndmFsdWUgbXVzdCBiZSBhbiBvcmRlcmVkIGl0ZXJhYmxlJykKICAgICAgICByZXR1cm4gWyhzdXBlcihDb21wbGV4TGlzdCwgc2VsZikuX19jYWxsX18odikpIGZvciB2IGluIHZhbHVlc10KClBLAQIUAxQAAAAAANS7K0uPp/FSdwAAAHcAAAATAAAAAAAAAAAAAACAAQAAAABhbnNpYmxlL19faW5pdF9fLnB5UEsBAhQDFAAAAAAA1LsrS53F8WtIAAAASAAAACAAAAAAAAAAAAAAAIABqAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL19faW5pdF9fLnB5UEsBAhQDFAAAAAAA1LsrS4AJ7erEoAEAxKABACQAAAAAAAAAAAAAAIABLgEAAGFuc2libGVfbW9kdWxlX2NlX2FhYV9zZXJ2ZXJfaG9zdC5weVBLAQIUAxQAAAAAANS7K0s73zmVMIoBADCKAQAdAAAAAAAAAAAAAACAATSiAQBhbnNpYmxlL21vZHVsZV91dGlscy9iYXNpYy5weVBLAQIUAxQAAAAAANS7K0s70kPTYDUAAGA1AAAaAAAAAAAAAAAAAACAAZ8sAwBhbnNpYmxlL21vZHVsZV91dGlscy9jZS5weVBLAQIUAxQAAAAAANS7K0u12AQGJTAAACUwAAAdAAAAAAAAAAAAAACAATdiAwBhbnNpYmxlL21vZHVsZV91dGlscy9fdGV4dC5weVBLAQIUAxQAAAAAANS7K0sl3LR+ExAAABMQAAAiAAAAAAAAAAAAAACAAZeSAwBhbnNpYmxlL21vZHVsZV91dGlscy9weWNvbXBhdDI0LnB5UEsBAhQDFAAAAAAA1LsrSxgXcvUBEQAAAREAACQAAAAAAAAAAAAAAIAB6qIDAGFuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fX2luaXRfXy5weVBLAQIUAxQAAAAAANS7K0s44sfRkXUAAJF1AAAgAAAAAAAAAAAAAACAAS20AwBhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeC5weVBLAQIUAxQAAAAAANS7K0umzEeScQsAAHELAAAiAAAAAAAAAAAAAACAAfwpBABhbnNpYmxlL21vZHVsZV91dGlscy9jb25uZWN0aW9uLnB5UEsBAhQDFAAAAAAA1LsrSzeqZkL6FwAA+hcAACYAAAAAAAAAAAAAAIABrTUEAGFuc2libGUvbW9kdWxlX3V0aWxzL25ldHdvcmtfY29tbW9uLnB5UEsFBgAAAAALAAsAUwMAAOtNBAAAAA=="""
def invoke_module(module, modlib_path, json_params):
    pythonpath = os.environ.get('PYTHONPATH')
    if pythonpath:
        os.environ['PYTHONPATH'] = ':'.join((modlib_path, pythonpath))
    else:
        os.environ['PYTHONPATH'] = modlib_path
    p = subprocess.Popen(['/usr/bin/python', module], env=os.environ, shell=False, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
    (stdout, stderr) = p.communicate(json_params)
    if not isinstance(stderr, (bytes, unicode)):
        stderr = stderr.read()
    if not isinstance(stdout, (bytes, unicode)):
        stdout = stdout.read()
    if PY3:
        sys.stderr.buffer.write(stderr)
        sys.stdout.buffer.write(stdout)
    else:
        sys.stderr.write(stderr)
        sys.stdout.write(stdout)
    return p.returncode
def debug(command, zipped_mod, json_params):
    basedir = os.path.join(os.path.abspath(os.path.dirname(__file__)), 'debug_dir')
    args_path = os.path.join(basedir, 'args')
    script_path = os.path.join(basedir, 'ansible_module_ce_aaa_server_host.py')
    if command == 'explode':
        z = zipfile.ZipFile(zipped_mod)
        for filename in z.namelist():
            if filename.startswith('/'):
                raise Exception('Something wrong with this module zip file: should not contain absolute paths')
            dest_filename = os.path.join(basedir, filename)
            if dest_filename.endswith(os.path.sep) and not os.path.exists(dest_filename):
                os.makedirs(dest_filename)
            else:
                directory = os.path.dirname(dest_filename)
                if not os.path.exists(directory):
                    os.makedirs(directory)
                f = open(dest_filename, 'wb')
                f.write(z.read(filename))
                f.close()
        f = open(args_path, 'wb')
        f.write(json_params)
        f.close()
        print('Module expanded into:')
        print('%s' % basedir)
        exitcode = 0
    elif command == 'execute':
        pythonpath = os.environ.get('PYTHONPATH')
        if pythonpath:
            os.environ['PYTHONPATH'] = ':'.join((basedir, pythonpath))
        else:
            os.environ['PYTHONPATH'] = basedir
        p = subprocess.Popen(['/usr/bin/python', script_path, args_path],
                env=os.environ, shell=False, stdout=subprocess.PIPE,
                stderr=subprocess.PIPE, stdin=subprocess.PIPE)
        (stdout, stderr) = p.communicate()
        if not isinstance(stderr, (bytes, unicode)):
            stderr = stderr.read()
        if not isinstance(stdout, (bytes, unicode)):
            stdout = stdout.read()
        if PY3:
            sys.stderr.buffer.write(stderr)
            sys.stdout.buffer.write(stdout)
        else:
            sys.stderr.write(stderr)
            sys.stdout.write(stdout)
        return p.returncode
    elif command == 'excommunicate':
        sys.argv = ['ce_aaa_server_host', args_path]
        sys.path.insert(0, basedir)
        from ansible_module_ce_aaa_server_host import main
        main()
        print('WARNING: Module returned to wrapper instead of exiting')
        sys.exit(1)
    else:
        print('WARNING: Unknown debug command.  Doing nothing.')
        exitcode = 0
    return exitcode
if __name__ == '__main__':
    ANSIBALLZ_PARAMS = json.dumps({"ANSIBLE_MODULE_ARGS": json.load(sys.stdin)})
    if PY3:
        ANSIBALLZ_PARAMS = ANSIBALLZ_PARAMS.encode('utf-8')
    try:
        temp_path = tempfile.mkdtemp(prefix='ansible_')
        zipped_mod = os.path.join(temp_path, 'ansible_modlib.zip')
        modlib = open(zipped_mod, 'wb')
        modlib.write(base64.b64decode(ZIPDATA))
        modlib.close()
        if len(sys.argv) == 2:
            exitcode = debug(sys.argv[1], zipped_mod, ANSIBALLZ_PARAMS)
        else:
            z = zipfile.ZipFile(zipped_mod, mode='r')
            module = os.path.join(temp_path, 'ansible_module_ce_aaa_server_host.py')
            f = open(module, 'wb')
            f.write(z.read('ansible_module_ce_aaa_server_host.py'))
            f.close()
            z = zipfile.ZipFile(zipped_mod, mode='a')
            sitecustomize = u'import sys\nsys.path.insert(0,"%s")\n' %  zipped_mod
            sitecustomize = sitecustomize.encode('utf-8')
            zinfo = zipfile.ZipInfo()
            zinfo.filename = 'sitecustomize.py'
            zinfo.date_time = ( 2017, 9, 11, 23, 30, 40)
            z.writestr(zinfo, sitecustomize)
            z.close()
            exitcode = invoke_module(module, zipped_mod, ANSIBALLZ_PARAMS)
    finally:
        try:
            shutil.rmtree(temp_path)
        except OSError:
            pass
    sys.exit(exitcode)