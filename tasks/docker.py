#!/usr/bin/python
# -*- coding: utf-8 -*-
ANSIBALLZ_WRAPPER = True # For test-module script to tell this is a ANSIBALLZ_WRAPPER
import os
import os.path
import sys
import __main__
scriptdir = None
try:
    scriptdir = os.path.dirname(os.path.abspath(__main__.__file__))
except (AttributeError, OSError):
    pass
if scriptdir is not None:
    sys.path = [p for p in sys.path if p != scriptdir]
import base64
import json
import shutil
import zipfile
import tempfile
import subprocess
if sys.version_info < (3,):
    bytes = str
    PY3 = False
else:
    unicode = str
    PY3 = True
try:
    from io import BytesIO as IOStream
except ImportError:
    from StringIO import StringIO as IOStream
ZIPDATA = """UEsDBBQAAAAAAPe7K0uPp/FSdwAAAHcAAAATAAAAYW5zaWJsZS9fX2luaXRfXy5weWZyb20gcGtndXRpbCBpbXBvcnQgZXh0ZW5kX3BhdGgKX19wYXRoX189ZXh0ZW5kX3BhdGgoX19wYXRoX18sX19uYW1lX18pCl9fdmVyc2lvbl9fPSIyLjQuMCIKX19hdXRob3JfXz0iQW5zaWJsZSwgSW5jLiIKUEsDBBQAAAAAAPe7K0udxfFrSAAAAEgAAAAgAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX19pbml0X18ucHlmcm9tIHBrZ3V0aWwgaW1wb3J0IGV4dGVuZF9wYXRoCl9fcGF0aF9fPWV4dGVuZF9wYXRoKF9fcGF0aF9fLF9fbmFtZV9fKQpQSwMEFAAAAAAA97srS6z2Np87JQEAOyUBABgAAABhbnNpYmxlX21vZHVsZV9kb2NrZXIucHkjIS91c3IvYmluL3B5dGhvbgoKIyAoYykgMjAxMywgQ292ZSBTY2huZWlkZXIKIyAoYykgMjAxNCwgSm9zaHVhIENvbm5lciA8am9zaHVhLmNvbm5lckBnbWFpbC5jb20+CiMgKGMpIDIwMTQsIFBhdmVsIEFudG9ub3YgPGFudG9ub3ZAYWR3ei5ydT4KIwojIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUsCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgpBTlNJQkxFX01FVEFEQVRBID0geydtZXRhZGF0YV92ZXJzaW9uJzogJzEuMCcsCiAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cyc6IFsnZGVwcmVjYXRlZCddLAogICAgICAgICAgICAgICAgICAgICdzdXBwb3J0ZWRfYnknOiAnY29tbXVuaXR5J30KCgpET0NVTUVOVEFUSU9OID0gJycnCi0tLQptb2R1bGU6IGRvY2tlcgp2ZXJzaW9uX2FkZGVkOiAiMS40IgpzaG9ydF9kZXNjcmlwdGlvbjogbWFuYWdlIGRvY2tlciBjb250YWluZXJzCmRlcHJlY2F0ZWQ6IEluIDIuMiB1c2UgTShkb2NrZXJfY29udGFpbmVyKSBhbmQgTShkb2NrZXJfaW1hZ2UpIGluc3RlYWQuCmRlc2NyaXB0aW9uOgogIC0gVGhpcyBpcyB0aGUgb3JpZ2luYWwgQW5zaWJsZSBtb2R1bGUgZm9yIG1hbmFnaW5nIHRoZSBEb2NrZXIgY29udGFpbmVyIGxpZmUgY3ljbGUuCiAgLSAiTk9URTogQWRkaXRpb25hbCBhbmQgbmV3ZXIgbW9kdWxlcyBhcmUgYXZhaWxhYmxlLiBGb3IgdGhlIGxhdGVzdCBvbiBvcmNoZXN0cmF0aW5nIGNvbnRhaW5lcnMgd2l0aCBBbnNpYmxlCiAgICB2aXNpdCBvdXIgR2V0dGluZyBTdGFydGVkIHdpdGggRG9ja2VyIEd1aWRlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9hbnNpYmxlL2Fuc2libGUvYmxvYi9kZXZlbC9kb2NzaXRlL3JzdC9ndWlkZV9kb2NrZXIucnN0LiIKb3B0aW9uczoKICBjb3VudDoKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIE51bWJlciBvZiBtYXRjaGluZyBjb250YWluZXJzIHRoYXQgc2hvdWxkIGJlIGluIHRoZSBkZXNpcmVkIHN0YXRlLgogICAgZGVmYXVsdDogMQogIGltYWdlOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gQ29udGFpbmVyIGltYWdlIHVzZWQgdG8gbWF0Y2ggYW5kIGxhdW5jaCBjb250YWluZXJzLgogICAgcmVxdWlyZWQ6IHRydWUKICBwdWxsOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gQ29udHJvbCB3aGVuIGNvbnRhaW5lciBpbWFnZXMgYXJlIHVwZGF0ZWQgZnJvbSB0aGUgQyhkb2NrZXJfdXJsKSByZWdpc3RyeS4KICAgICAgICBJZiAibWlzc2luZywiIGltYWdlcyB3aWxsIGJlIHB1bGxlZCBvbmx5IHdoZW4gbWlzc2luZyBmcm9tIHRoZSBob3N0OwogICAgICAgIGlmICciYWx3YXlzLCIgdGhlIHJlZ2lzdHJ5IHdpbGwgYmUgY2hlY2tlZCBmb3IgYSBuZXdlciB2ZXJzaW9uIG9mIHRoZQogICAgICAgIGltYWdlJyBlYWNoIHRpbWUgdGhlIHRhc2sgZXhlY3V0ZXMuCiAgICBkZWZhdWx0OiBtaXNzaW5nCiAgICBjaG9pY2VzOiBbICJtaXNzaW5nIiwgImFsd2F5cyIgXQogICAgdmVyc2lvbl9hZGRlZDogIjEuOSIKICBlbnRyeXBvaW50OgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gQ29ycmVzcG9uZHMgdG8gYGAtLWVudHJ5cG9pbnRgYCBvcHRpb24gb2YgYGBkb2NrZXIgcnVuYGAgY29tbWFuZCBhbmQKICAgICAgICBgYEVOVFJZUE9JTlRgYCBkaXJlY3RpdmUgb2YgRG9ja2VyZmlsZS4KICAgICAgICBVc2VkIHRvIG1hdGNoIGFuZCBsYXVuY2ggY29udGFpbmVycy4KICAgIGRlZmF1bHQ6IG51bGwKICAgIHJlcXVpcmVkOiBmYWxzZQogICAgdmVyc2lvbl9hZGRlZDogIjIuMSIKICBjb21tYW5kOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gQ29tbWFuZCB1c2VkIHRvIG1hdGNoIGFuZCBsYXVuY2ggY29udGFpbmVycy4KICAgIGRlZmF1bHQ6IG51bGwKICBuYW1lOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gTmFtZSB1c2VkIHRvIG1hdGNoIGFuZCB1bmlxdWVseSBuYW1lIGxhdW5jaGVkIGNvbnRhaW5lcnMuIEV4cGxpY2l0IG5hbWVzCiAgICAgICAgYXJlIHVzZWQgdG8gdW5pcXVlbHkgaWRlbnRpZnkgYSBzaW5nbGUgY29udGFpbmVyIG9yIHRvIGxpbmsgYW1vbmcKICAgICAgICBjb250YWluZXJzLiBNdXR1YWxseSBleGNsdXNpdmUgd2l0aCBhICJjb3VudCIgb3RoZXIgdGhhbiAiMSIuCiAgICBkZWZhdWx0OiBudWxsCiAgICB2ZXJzaW9uX2FkZGVkOiAiMS41IgogIHBvcnRzOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gIkxpc3QgY29udGFpbmluZyBwcml2YXRlIHRvIHB1YmxpYyBwb3J0IG1hcHBpbmcgc3BlY2lmaWNhdGlvbi4KICAgICAgICBVc2UgZG9ja2VyICdDTEktc3R5bGUgc3ludGF4OiBDKDgwMDApLCBDKDkwMDA6ODAwMCksIG9yIEMoMC4wLjAuMDo5MDAwOjgwMDApJwogICAgICAgIHdoZXJlIDgwMDAgaXMgYSBjb250YWluZXIgcG9ydCwgOTAwMCBpcyBhIGhvc3QgcG9ydCwgYW5kIDAuMC4wLjAgaXMgLSBhIGhvc3QgaW50ZXJmYWNlLgogICAgICAgIFRoZSBjb250YWluZXIgcG9ydHMgbmVlZCB0byBiZSBleHBvc2VkIGVpdGhlciBpbiB0aGUgRG9ja2VyZmlsZSBvciB2aWEgdGhlIEMoZXhwb3NlKSBvcHRpb24uIgogICAgZGVmYXVsdDogbnVsbAogICAgdmVyc2lvbl9hZGRlZDogIjEuNSIKICBleHBvc2U6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBMaXN0IG9mIGFkZGl0aW9uYWwgY29udGFpbmVyIHBvcnRzIHRvIGV4cG9zZSBmb3IgcG9ydCBtYXBwaW5ncyBvciBsaW5rcy4KICAgICAgICBJZiB0aGUgcG9ydCBpcyBhbHJlYWR5IGV4cG9zZWQgdXNpbmcgRVhQT1NFIGluIGEgRG9ja2VyZmlsZSwgeW91IGRvbid0CiAgICAgICAgbmVlZCB0byBleHBvc2UgaXQgYWdhaW4uCiAgICBkZWZhdWx0OiBudWxsCiAgICB2ZXJzaW9uX2FkZGVkOiAiMS41IgogIHB1Ymxpc2hfYWxsX3BvcnRzOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gUHVibGlzaCBhbGwgZXhwb3NlZCBwb3J0cyB0byB0aGUgaG9zdCBpbnRlcmZhY2VzLgogICAgZGVmYXVsdDogZmFsc2UKICAgIHZlcnNpb25fYWRkZWQ6ICIxLjUiCiAgdm9sdW1lczoKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIExpc3Qgb2Ygdm9sdW1lcyB0byBtb3VudCB3aXRoaW4gdGhlIGNvbnRhaW5lcgogICAgICAtICdVc2UgZG9ja2VyIENMSS1zdHlsZSBzeW50YXg6IEMoL2hvc3Q6L2NvbnRhaW5lcls6bW9kZV0pJwogICAgICAtIFlvdSBjYW4gc3BlY2lmeSBhIHJlYWQgbW9kZSBmb3IgdGhlIG1vdW50IHdpdGggZWl0aGVyIEMocm8pIG9yIEMocncpLgogICAgICAgIFN0YXJ0aW5nIGF0IHZlcnNpb24gMi4xLCBTRUxpbnV4IGhvc3RzIGNhbiBhZGRpdGlvbmFsbHkgdXNlIEMoeikgb3IgQyhaKQogICAgICAgIG1vdW50IG9wdGlvbnMgdG8gdXNlIGEgc2hhcmVkIG9yIHByaXZhdGUgbGFiZWwgZm9yIHRoZSB2b2x1bWUuCiAgICBkZWZhdWx0OiBudWxsCiAgdm9sdW1lc19mcm9tOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gTGlzdCBvZiBuYW1lcyBvZiBjb250YWluZXJzIHRvIG1vdW50IHZvbHVtZXMgZnJvbS4KICAgIGRlZmF1bHQ6IG51bGwKICBsaW5rczoKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIExpc3Qgb2Ygb3RoZXIgY29udGFpbmVycyB0byBsaW5rIHdpdGhpbiB0aGlzIGNvbnRhaW5lciB3aXRoIGFuIG9wdGlvbmFsCiAgICAgIC0gJ2FsaWFzLiBVc2UgZG9ja2VyIENMSS1zdHlsZSBzeW50YXg6IEMocmVkaXM6bXlyZWRpcykuJwogICAgZGVmYXVsdDogbnVsbAogICAgdmVyc2lvbl9hZGRlZDogIjEuNSIKICBkZXZpY2VzOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gTGlzdCBvZiBob3N0IGRldmljZXMgdG8gZXhwb3NlIHRvIGNvbnRhaW5lcgogICAgZGVmYXVsdDogbnVsbAogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICB2ZXJzaW9uX2FkZGVkOiAiMi4xIgogIGxvZ19kcml2ZXI6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBZb3UgY2FuIHNwZWNpZnkgYSBkaWZmZXJlbnQgbG9nZ2luZyBkcml2ZXIgZm9yIHRoZSBjb250YWluZXIgdGhhbiBmb3IgdGhlIGRhZW1vbi4KICAgICAgICAianNvbi1maWxlIiBEZWZhdWx0IGxvZ2dpbmcgZHJpdmVyIGZvciBEb2NrZXIuIFdyaXRlcyBKU09OIG1lc3NhZ2VzIHRvIGZpbGUuCiAgICAgICAgZG9ja2VyIGxvZ3MgY29tbWFuZCBpcyBhdmFpbGFibGUgb25seSBmb3IgdGhpcyBsb2dnaW5nIGRyaXZlci4KICAgICAgICAibm9uZSIgZGlzYWJsZXMgYW55IGxvZ2dpbmcgZm9yIHRoZSBjb250YWluZXIuCiAgICAgICAgInN5c2xvZyIgU3lzbG9nIGxvZ2dpbmcgZHJpdmVyIGZvciBEb2NrZXIuIFdyaXRlcyBsb2cgbWVzc2FnZXMgdG8gc3lzbG9nLgogICAgICAgIGRvY2tlciBsb2dzIGNvbW1hbmQgaXMgbm90IGF2YWlsYWJsZSBmb3IgdGhpcyBsb2dnaW5nIGRyaXZlci4KICAgICAgICAiam91cm5hbGQiIEpvdXJuYWxkIGxvZ2dpbmcgZHJpdmVyIGZvciBEb2NrZXIuIFdyaXRlcyBsb2cgbWVzc2FnZXMgdG8gImpvdXJuYWxkIi4KICAgICAgICAiZ2VsZiIgR3JheWxvZyBFeHRlbmRlZCBMb2cgRm9ybWF0IChHRUxGKSBsb2dnaW5nIGRyaXZlciBmb3IgRG9ja2VyLiBXcml0ZXMgbG9nIG1lc3NhZ2VzIHRvIGEgR0VMRiBlbmRwb2ludCBsaWtlR3JheWxvZyBvciBMb2dzdGFzaC4KICAgICAgICAiZmx1ZW50ZCIgRmx1ZW50ZCBsb2dnaW5nIGRyaXZlciBmb3IgRG9ja2VyLiBXcml0ZXMgbG9nIG1lc3NhZ2VzIHRvICJmbHVlbnRkIiAoZm9yd2FyZCBpbnB1dCkuCiAgICAgICAgImF3c2xvZ3MiIChhZGRlZCBpbiAyLjEpIEF3c2xvZ3MgbG9nZ2luZyBkcml2ZXIgZm9yIERvY2tlci4gV3JpdGVzIGxvZyBtZXNzYWdlcyB0byBBV1MgQ2xvdWR3YXRjaCBMb2dzLgogICAgICAgIElmIG5vdCBkZWZpbmVkIGV4cGxpY2l0bHksIHRoZSBEb2NrZXIgZGFlbW9uJ3MgZGVmYXVsdCAoImpzb24tZmlsZSIpIHdpbGwgYXBwbHkuCiAgICAgICAgUmVxdWlyZXMgZG9ja2VyID49IDEuNi4wLgogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICBkZWZhdWx0OiBqc29uLWZpbGUKICAgIGNob2ljZXM6CiAgICAgIC0ganNvbi1maWxlCiAgICAgIC0gbm9uZQogICAgICAtIHN5c2xvZwogICAgICAtIGpvdXJuYWxkCiAgICAgIC0gZ2VsZgogICAgICAtIGZsdWVudGQKICAgICAgLSBhd3Nsb2dzCiAgICB2ZXJzaW9uX2FkZGVkOiAiMi4wIgogIGxvZ19vcHQ6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBBZGRpdGlvbmFsIG9wdGlvbnMgdG8gcGFzcyB0byB0aGUgbG9nZ2luZyBkcml2ZXIgc2VsZWN0ZWQgYWJvdmUuIFNlZSBEb2NrZXIgYGxvZy1kcml2ZXIKICAgICAgICA8aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vcmVmZXJlbmNlL2xvZ2dpbmcvb3ZlcnZpZXcvPmAgZG9jdW1lbnRhdGlvbiBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAgICBSZXF1aXJlcyBkb2NrZXIgPj0xLjcuMC4KICAgIHJlcXVpcmVkOiBmYWxzZQogICAgZGVmYXVsdDogbnVsbAogICAgdmVyc2lvbl9hZGRlZDogIjIuMCIKICBtZW1vcnlfbGltaXQ6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBSQU0gYWxsb2NhdGVkIHRvIHRoZSBjb250YWluZXIgYXMgYSBudW1iZXIgb2YgYnl0ZXMgb3IgYXMgYSBodW1hbi1yZWFkYWJsZQogICAgICAgIHN0cmluZyBsaWtlICI1MTJNQiIuIExlYXZlIGFzICIwIiB0byBzcGVjaWZ5IG5vIGxpbWl0LgogICAgZGVmYXVsdDogMAogIGRvY2tlcl91cmw6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBVUkwgb2YgdGhlIGhvc3QgcnVubmluZyB0aGUgZG9ja2VyIGRhZW1vbi4gVGhpcyB3aWxsIGRlZmF1bHQgdG8gdGhlIGVudgogICAgICAgIHZhciBET0NLRVJfSE9TVCBpZiB1bnNwZWNpZmllZC4KICAgIGRlZmF1bHQ6ICR7RE9DS0VSX0hPU1R9IG9yIHVuaXg6Ly92YXIvcnVuL2RvY2tlci5zb2NrCiAgdXNlX3RsczoKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIFdoZXRoZXIgdG8gdXNlIHRscyB0byBjb25uZWN0IHRvIHRoZSBkb2NrZXIgc2VydmVyLiAgIm5vIiBtZWFucyBub3QgdG8KICAgICAgICB1c2UgdGxzIChhbmQgaWdub3JlIGFueSBvdGhlciB0bHMgcmVsYXRlZCBwYXJhbWV0ZXJzKS4gImVuY3J5cHQiIG1lYW5zCiAgICAgICAgdG8gdXNlIHRscyB0byBlbmNyeXB0IHRoZSBjb25uZWN0aW9uIHRvIHRoZSBzZXJ2ZXIuICAidmVyaWZ5IiBtZWFucyB0bwogICAgICAgIGFsc28gdmVyaWZ5IHRoYXQgdGhlIHNlcnZlcidzIGNlcnRpZmljYXRlIGlzIHZhbGlkIGZvciB0aGUgc2VydmVyCiAgICAgICAgKHRoaXMgYm90aCB2ZXJpZmllcyB0aGUgY2VydGlmaWNhdGUgYWdhaW5zdCB0aGUgQ0EgYW5kIHRoYXQgdGhlCiAgICAgICAgY2VydGlmaWNhdGUgd2FzIGlzc3VlZCBmb3IgdGhhdCBob3N0LiBJZiB0aGlzIGlzIHVuc3BlY2lmaWVkLCB0bHMgd2lsbAogICAgICAgIG9ubHkgYmUgdXNlZCBpZiBvbmUgb2YgdGhlIG90aGVyIHRscyBvcHRpb25zIHJlcXVpcmUgaXQuCiAgICBjaG9pY2VzOiBbICJubyIsICJlbmNyeXB0IiwgInZlcmlmeSIgXQogICAgdmVyc2lvbl9hZGRlZDogIjEuOSIKICB0bHNfY2xpZW50X2NlcnQ6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBQYXRoIHRvIHRoZSBQRU0tZW5jb2RlZCBjZXJ0aWZpY2F0ZSB1c2VkIHRvIGF1dGhlbnRpY2F0ZSBkb2NrZXIgY2xpZW50LgogICAgICAgIElmIHNwZWNpZmllZCB0bHNfY2xpZW50X2tleSBtdXN0IGJlIHZhbGlkCiAgICBkZWZhdWx0OiAke0RPQ0tFUl9DRVJUX1BBVEh9L2NlcnQucGVtCiAgICB2ZXJzaW9uX2FkZGVkOiAiMS45IgogIHRsc19jbGllbnRfa2V5OgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gUGF0aCB0byB0aGUgUEVNLWVuY29kZWQga2V5IHVzZWQgdG8gYXV0aGVudGljYXRlIGRvY2tlciBjbGllbnQuIElmCiAgICAgICAgc3BlY2lmaWVkIHRsc19jbGllbnRfY2VydCBtdXN0IGJlIHZhbGlkCiAgICBkZWZhdWx0OiAke0RPQ0tFUl9DRVJUX1BBVEh9L2tleS5wZW0KICAgIHZlcnNpb25fYWRkZWQ6ICIxLjkiCiAgdGxzX2NhX2NlcnQ6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBQYXRoIHRvIGEgUEVNLWVuY29kZWQgY2VydGlmaWNhdGUgYXV0aG9yaXR5IHRvIHNlY3VyZSB0aGUgRG9ja2VyIGNvbm5lY3Rpb24uCiAgICAgICAgVGhpcyBoYXMgbm8gZWZmZWN0IGlmIHVzZV90bHMgaXMgZW5jcnlwdC4KICAgIGRlZmF1bHQ6ICR7RE9DS0VSX0NFUlRfUEFUSH0vY2EucGVtCiAgICB2ZXJzaW9uX2FkZGVkOiAiMS45IgogIHRsc19ob3N0bmFtZToKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIEEgaG9zdG5hbWUgdG8gY2hlY2sgbWF0Y2hlcyB3aGF0J3Mgc3VwcGxpZWQgaW4gdGhlIGRvY2tlciBzZXJ2ZXIncwogICAgICAgIGNlcnRpZmljYXRlLiAgSWYgdW5zcGVjaWZpZWQsIHRoZSBob3N0bmFtZSBpcyB0YWtlbiBmcm9tIHRoZSBkb2NrZXJfdXJsLgogICAgZGVmYXVsdDogVGFrZW4gZnJvbSBkb2NrZXJfdXJsCiAgICB2ZXJzaW9uX2FkZGVkOiAiMS45IgogIGRvY2tlcl9hcGlfdmVyc2lvbjoKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIFJlbW90ZSBBUEkgdmVyc2lvbiB0byB1c2UuIFRoaXMgZGVmYXVsdHMgdG8gdGhlIGN1cnJlbnQgZGVmYXVsdCBhcwogICAgICAgIHNwZWNpZmllZCBieSBkb2NrZXItcHkuCiAgICBkZWZhdWx0OiBkb2NrZXItcHkgZGVmYXVsdCByZW1vdGUgQVBJIHZlcnNpb24KICAgIHZlcnNpb25fYWRkZWQ6ICIxLjgiCiAgZG9ja2VyX3VzZXI6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBVc2VybmFtZSBvciBVSUQgdG8gdXNlIHdpdGhpbiB0aGUgY29udGFpbmVyCiAgICByZXF1aXJlZDogZmFsc2UKICAgIGRlZmF1bHQ6IG51bGwKICAgIHZlcnNpb25fYWRkZWQ6ICIyLjAiCiAgdXNlcm5hbWU6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBSZW1vdGUgQVBJIHVzZXJuYW1lLgogICAgZGVmYXVsdDogbnVsbAogIHBhc3N3b3JkOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gUmVtb3RlIEFQSSBwYXNzd29yZC4KICAgIGRlZmF1bHQ6IG51bGwKICBlbWFpbDoKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIFJlbW90ZSBBUEkgZW1haWwuCiAgICBkZWZhdWx0OiBudWxsCiAgaG9zdG5hbWU6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBDb250YWluZXIgaG9zdG5hbWUuCiAgICBkZWZhdWx0OiBudWxsCiAgZG9tYWlubmFtZToKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIENvbnRhaW5lciBkb21haW4gbmFtZS4KICAgIGRlZmF1bHQ6IG51bGwKICBlbnY6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBQYXNzIGEgZGljdCBvZiBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdG8gdGhlIGNvbnRhaW5lci4KICAgIGRlZmF1bHQ6IG51bGwKICBlbnZfZmlsZToKICAgIHZlcnNpb25fYWRkZWQ6ICIyLjEiCiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBQYXNzIGluIGEgcGF0aCB0byBhIGZpbGUgd2l0aCBlbnZpcm9ubWVudCB2YXJpYWJsZSAoRk9PPUJBUikuCiAgICAgICAgSWYgYSBrZXkgdmFsdWUgaXMgcHJlc2VudCBpbiBib3RoIGV4cGxpY2l0bHkgcHJlc2VudGVkIChpLmUuIGFzICdlbnYnKQogICAgICAgIGFuZCBpbiB0aGUgZW52aXJvbm1lbnQgZmlsZSwgdGhlIGV4cGxpY2l0IHZhbHVlIHdpbGwgb3ZlcnJpZGUuCiAgICAgICAgUmVxdWlyZXMgZG9ja2VyLXB5ID49IDEuNC4wLgogICAgZGVmYXVsdDogbnVsbAogICAgcmVxdWlyZWQ6IGZhbHNlCiAgZG5zOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gTGlzdCBvZiBjdXN0b20gRE5TIHNlcnZlcnMgZm9yIHRoZSBjb250YWluZXIuCiAgICByZXF1aXJlZDogZmFsc2UKICAgIGRlZmF1bHQ6IG51bGwKICBkZXRhY2g6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBFbmFibGUgZGV0YWNoZWQgbW9kZSB0byBsZWF2ZSB0aGUgY29udGFpbmVyIHJ1bm5pbmcgaW4gYmFja2dyb3VuZC4gSWYKICAgICAgICBkaXNhYmxlZCwgZmFpbCB1bmxlc3MgdGhlIHByb2Nlc3MgZXhpdHMgY2xlYW5seS4KICAgIGRlZmF1bHQ6IHRydWUKICBzaWduYWw6CiAgICB2ZXJzaW9uX2FkZGVkOiAiMi4wIgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gV2l0aCB0aGUgc3RhdGUgImtpbGxlZCIsIHlvdSBjYW4gYWx0ZXIgdGhlIHNpZ25hbCBzZW50IHRvIHRoZQogICAgICAgIGNvbnRhaW5lci4KICAgIHJlcXVpcmVkOiBmYWxzZQogICAgZGVmYXVsdDogS0lMTAogIHN0YXRlOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gQXNzZXJ0IHRoZSBjb250YWluZXIncyBkZXNpcmVkIHN0YXRlLiAicHJlc2VudCIgb25seSBhc3NlcnRzIHRoYXQgdGhlCiAgICAgICAgbWF0Y2hpbmcgY29udGFpbmVycyBleGlzdC4gInN0YXJ0ZWQiIGFzc2VydHMgdGhhdCB0aGUgbWF0Y2hpbmcKICAgICAgICBjb250YWluZXJzIGJvdGggZXhpc3QgYW5kIGFyZSBydW5uaW5nLCBidXQgdGFrZXMgbm8gYWN0aW9uIGlmIGFueQogICAgICAgIGNvbmZpZ3VyYXRpb24gaGFzIGNoYW5nZWQuICJyZWxvYWRlZCIgKGFkZGVkIGluIEFuc2libGUgMS45KSBhc3NlcnRzIHRoYXQgYWxsIG1hdGNoaW5nCiAgICAgICAgY29udGFpbmVycyBhcmUgcnVubmluZyBhbmQgcmVzdGFydHMgYW55IHRoYXQgaGF2ZSBhbnkgaW1hZ2VzIG9yCiAgICAgICAgY29uZmlndXJhdGlvbiBvdXQgb2YgZGF0ZS4gInJlc3RhcnRlZCIgdW5jb25kaXRpb25hbGx5IHJlc3RhcnRzIChvcgogICAgICAgIHN0YXJ0cykgdGhlIG1hdGNoaW5nIGNvbnRhaW5lcnMuICJzdG9wcGVkIiBhbmQgJyJraWxsZWQiIHN0b3AgYW5kIGtpbGwKICAgICAgICBhbGwgbWF0Y2hpbmcgY29udGFpbmVycy4gImFic2VudCIgc3RvcHMgYW5kIHRoZW4nIHJlbW92ZXMgYW55IG1hdGNoaW5nCiAgICAgICAgY29udGFpbmVycy4KICAgIHJlcXVpcmVkOiBmYWxzZQogICAgZGVmYXVsdDogc3RhcnRlZAogICAgY2hvaWNlczoKICAgICAgLSBwcmVzZW50CiAgICAgIC0gc3RhcnRlZAogICAgICAtIHJlbG9hZGVkCiAgICAgIC0gcmVzdGFydGVkCiAgICAgIC0gc3RvcHBlZAogICAgICAtIGtpbGxlZAogICAgICAtIGFic2VudAogIHByaXZpbGVnZWQ6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBXaGV0aGVyIHRoZSBjb250YWluZXIgc2hvdWxkIHJ1biBpbiBwcml2aWxlZ2VkIG1vZGUgb3Igbm90LgogICAgZGVmYXVsdDogZmFsc2UKICBseGNfY29uZjoKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIExYQyBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMsIHN1Y2ggYXMgQyhseGMuYWFfcHJvZmlsZTp1bmNvbmZpbmVkKS4KICAgIGRlZmF1bHQ6IG51bGwKICBzdGRpbl9vcGVuOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gS2VlcCBzdGRpbiBvcGVuIGFmdGVyIGEgY29udGFpbmVyIGlzIGxhdW5jaGVkLgogICAgZGVmYXVsdDogZmFsc2UKICAgIHZlcnNpb25fYWRkZWQ6ICIxLjYiCiAgdHR5OgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gQWxsb2NhdGUgYSBwc2V1ZG8tdHR5IHdpdGhpbiB0aGUgY29udGFpbmVyLgogICAgZGVmYXVsdDogZmFsc2UKICAgIHZlcnNpb25fYWRkZWQ6ICIxLjYiCiAgbmV0OgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gJ05ldHdvcmsgbW9kZSBmb3IgdGhlIGxhdW5jaGVkIGNvbnRhaW5lcjogYnJpZGdlLCBub25lLCBjb250YWluZXI6PG5hbWV8aWQ+JwogICAgICAtIG9yIGhvc3QuIFJlcXVpcmVzIGRvY2tlciA+PSAwLjExLgogICAgZGVmYXVsdDogZmFsc2UKICAgIHZlcnNpb25fYWRkZWQ6ICIxLjgiCiAgcGlkOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gU2V0IHRoZSBQSUQgbmFtZXNwYWNlIG1vZGUgZm9yIHRoZSBjb250YWluZXIgKGN1cnJlbnRseSBvbmx5IHN1cHBvcnRzICdob3N0JykuIFJlcXVpcmVzIGRvY2tlci1weSA+PSAxLjAuMCBhbmQgZG9ja2VyID49IDEuNS4wCiAgICByZXF1aXJlZDogZmFsc2UKICAgIGRlZmF1bHQ6IE5vbmUKICAgIGFsaWFzZXM6IFtdCiAgICB2ZXJzaW9uX2FkZGVkOiAiMS45IgogIHJlZ2lzdHJ5OgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gUmVtb3RlIHJlZ2lzdHJ5IFVSTCB0byBwdWxsIGltYWdlcyBmcm9tLgogICAgZGVmYXVsdDogRG9ja2VySHViCiAgICBhbGlhc2VzOiBbXQogICAgdmVyc2lvbl9hZGRlZDogIjEuOCIKICByZWFkX29ubHk6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBNb3VudCB0aGUgY29udGFpbmVyJ3Mgcm9vdCBmaWxlc3lzdGVtIGFzIHJlYWQgb25seQogICAgZGVmYXVsdDogbnVsbAogICAgYWxpYXNlczogW10KICAgIHZlcnNpb25fYWRkZWQ6ICIyLjAiCiAgcmVzdGFydF9wb2xpY3k6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBDb250YWluZXIgcmVzdGFydCBwb2xpY3kuCiAgICAgIC0gVGhlICd1bmxlc3Mtc3RvcHBlZCcgY2hvaWNlIGlzIG9ubHkgYXZhaWxhYmxlIHN0YXJ0aW5nIGluIEFuc2libGUgMi4xIGFuZCBmb3IgRG9ja2VyIDEuOSBhbmQgYWJvdmUuCiAgICBjaG9pY2VzOiBbIm5vIiwgIm9uLWZhaWx1cmUiLCAiYWx3YXlzIiwgInVubGVzcy1zdG9wcGVkIl0KICAgIGRlZmF1bHQ6IG51bGwKICAgIHZlcnNpb25fYWRkZWQ6ICIxLjkiCiAgcmVzdGFydF9wb2xpY3lfcmV0cnk6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBNYXhpbXVtIG51bWJlciBvZiB0aW1lcyB0byByZXN0YXJ0IGEgY29udGFpbmVyLiBMZWF2ZSBhcyAiMCIgZm9yIHVubGltaXRlZAogICAgICAgIHJldHJpZXMuCiAgICBkZWZhdWx0OiAwCiAgICB2ZXJzaW9uX2FkZGVkOiAiMS45IgogIGV4dHJhX2hvc3RzOgogICAgdmVyc2lvbl9hZGRlZDogIjIuMCIKICAgIGRlc2NyaXB0aW9uOgogICAgLSBEaWN0IG9mIGN1c3RvbSBob3N0LXRvLUlQIG1hcHBpbmdzIHRvIGJlIGRlZmluZWQgaW4gdGhlIGNvbnRhaW5lcgogIGluc2VjdXJlX3JlZ2lzdHJ5OgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gVXNlIGluc2VjdXJlIHByaXZhdGUgcmVnaXN0cnkgYnkgSFRUUCBpbnN0ZWFkIG9mIEhUVFBTLiBOZWVkZWQgZm9yCiAgICAgICAgZG9ja2VyLXB5ID49IDAuNS4wLgogICAgZGVmYXVsdDogZmFsc2UKICAgIHZlcnNpb25fYWRkZWQ6ICIxLjkiCiAgY3B1X3NldDoKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIENQVXMgaW4gd2hpY2ggdG8gYWxsb3cgZXhlY3V0aW9uLiBSZXF1aXJlcyBkb2NrZXItcHkgPj0gMC42LjAuCiAgICByZXF1aXJlZDogZmFsc2UKICAgIGRlZmF1bHQ6IG51bGwKICAgIHZlcnNpb25fYWRkZWQ6ICIyLjAiCiAgY2FwX2FkZDoKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIEFkZCBjYXBhYmlsaXRpZXMgZm9yIHRoZSBjb250YWluZXIuIFJlcXVpcmVzIGRvY2tlci1weSA+PSAwLjUuMC4KICAgIHJlcXVpcmVkOiBmYWxzZQogICAgZGVmYXVsdDogZmFsc2UKICAgIHZlcnNpb25fYWRkZWQ6ICIyLjAiCiAgY2FwX2Ryb3A6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBEcm9wIGNhcGFiaWxpdGllcyBmb3IgdGhlIGNvbnRhaW5lci4gUmVxdWlyZXMgZG9ja2VyLXB5ID49IDAuNS4wLgogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICBkZWZhdWx0OiBmYWxzZQogICAgYWxpYXNlczogW10KICAgIHZlcnNpb25fYWRkZWQ6ICIyLjAiCiAgbGFiZWxzOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gU2V0IGNvbnRhaW5lciBsYWJlbHMuIFJlcXVpcmVzIGRvY2tlciA+PSAxLjYgYW5kIGRvY2tlci1weSA+PSAxLjIuMC4KICAgIHJlcXVpcmVkOiBmYWxzZQogICAgZGVmYXVsdDogbnVsbAogICAgdmVyc2lvbl9hZGRlZDogIjIuMSIKICBzdG9wX3RpbWVvdXQ6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBIb3cgbWFueSBzZWNvbmRzIHRvIHdhaXQgZm9yIHRoZSBjb250YWluZXIgdG8gc3RvcCBiZWZvcmUga2lsbGluZyBpdC4KICAgIHJlcXVpcmVkOiBmYWxzZQogICAgZGVmYXVsdDogMTAKICAgIHZlcnNpb25fYWRkZWQ6ICIyLjAiCiAgdGltZW91dDoKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIERvY2tlciBkYWVtb24gcmVzcG9uc2UgdGltZW91dCBpbiBzZWNvbmRzLgogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICBkZWZhdWx0OiA2MAogICAgdmVyc2lvbl9hZGRlZDogIjIuMSIKICBjcHVfc2hhcmVzOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gQ1BVIHNoYXJlcyAocmVsYXRpdmUgd2VpZ2h0KS4gUmVxdWlyZXMgZG9ja2VyLXB5ID49IDAuNi4wLgogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICBkZWZhdWx0OiAwCiAgICB2ZXJzaW9uX2FkZGVkOiAiMi4xIgogIHVsaW1pdHM6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSB1bGltaXRzLCBsaXN0IHVsaW1pdHMgd2l0aCBuYW1lLCBzb2Z0IGFuZCBvcHRpb25hbGx5CiAgICAgICAgaGFyZCBsaW1pdCBzZXBhcmF0ZWQgYnkgY29sb25zLiBlLmcuIG5vZmlsZToxMDI0OjIwNDgKICAgICAgICBSZXF1aXJlcyBkb2NrZXItcHkgPj0gMS4yLjAgYW5kIGRvY2tlciA+PSAxLjYuMAogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICBkZWZhdWx0OiBudWxsCiAgICB2ZXJzaW9uX2FkZGVkOiAiMi4xIgoKYXV0aG9yOgogICAgLSAiQ292ZSBTY2huZWlkZXIgKEBjb3ZlKSIKICAgIC0gIkpvc2h1YSBDb25uZXIgKEBqb3NodWFjb25uZXIpIgogICAgLSAiUGF2ZWwgQW50b25vdiAoQHNvZnR6aWxsYSkiCiAgICAtICJUaG9tYXMgU3RlaW5iYWNoIChAVGhvbWFzU3RlaW5iYWNoKSIKICAgIC0gIlBoaWxpcHBlIEphbmRvdCAoQHpmaWwpIgogICAgLSAiRGFhbiBPb3N0ZXJ2ZWxkIChAZHVzZGFuaWcpIgpyZXF1aXJlbWVudHM6CiAgICAtICJweXRob24gPj0gMi42IgogICAgLSAiZG9ja2VyLXB5ID49IDAuMy4wIgogICAgLSAiVGhlIGRvY2tlciBzZXJ2ZXIgPj0gMC4xMC4wIgonJycKCkVYQU1QTEVTID0gJycnCiMgQ29udGFpbmVycyBhcmUgbWF0Y2hlZCBlaXRoZXIgYnkgbmFtZSAoaWYgcHJvdmlkZWQpIG9yIGJ5IGFuIGV4YWN0IG1hdGNoIG9mCiMgdGhlIGltYWdlIHRoZXkgd2VyZSBsYXVuY2hlZCB3aXRoIGFuZCB0aGUgY29tbWFuZCB0aGV5J3JlIHJ1bm5pbmcuIFRoZSBtb2R1bGUKIyBjYW4gYWNjZXB0IGVpdGhlciBhIG5hbWUgdG8gdGFyZ2V0IGEgY29udGFpbmVyIHVuaXF1ZWx5LCBvciBhIGNvdW50IHRvIG9wZXJhdGUKIyBvbiBtdWx0aXBsZSBjb250YWluZXJzIGF0IG9uY2Ugd2hlbiBpdCBtYWtlcyBzZW5zZSB0byBkbyBzby4KCiMgRW5zdXJlIHRoYXQgYSBkYXRhIGNvbnRhaW5lciB3aXRoIHRoZSBuYW1lICJteWRhdGEiIGV4aXN0cy4gSWYgbm8gY29udGFpbmVyCiMgYnkgdGhpcyBuYW1lIGV4aXN0cywgaXQgd2lsbCBiZSBjcmVhdGVkLCBidXQgbm90IHN0YXJ0ZWQuCgotIG5hbWU6IGRhdGEgY29udGFpbmVyCiAgZG9ja2VyOgogICAgbmFtZTogbXlkYXRhCiAgICBpbWFnZTogYnVzeWJveAogICAgc3RhdGU6IHByZXNlbnQKICAgIHZvbHVtZXM6CiAgICAtIC9kYXRhCgojIEVuc3VyZSB0aGF0IGEgUmVkaXMgc2VydmVyIGlzIHJ1bm5pbmcsIHVzaW5nIHRoZSB2b2x1bWUgZnJvbSB0aGUgZGF0YQojIGNvbnRhaW5lci4gRXhwb3NlIHRoZSBkZWZhdWx0IFJlZGlzIHBvcnQuCgotIG5hbWU6IHJlZGlzIGNvbnRhaW5lcgogIGRvY2tlcjoKICAgIG5hbWU6IG15cmVkaXMKICAgIGltYWdlOiByZWRpcwogICAgY29tbWFuZDogcmVkaXMtc2VydmVyIC0tYXBwZW5kb25seSB5ZXMKICAgIHN0YXRlOiBzdGFydGVkCiAgICBleHBvc2U6CiAgICAtIDYzNzkKICAgIHZvbHVtZXNfZnJvbToKICAgIC0gbXlkYXRhCgojIEVuc3VyZSB0aGF0IGEgY29udGFpbmVyIG9mIHlvdXIgYXBwbGljYXRpb24gc2VydmVyIGlzIHJ1bm5pbmcuIFRoaXMgd2lsbDoKIyAtIHB1bGwgdGhlIGxhdGVzdCB2ZXJzaW9uIG9mIHlvdXIgYXBwbGljYXRpb24gaW1hZ2UgZnJvbSBEb2NrZXJIdWIuCiMgLSBlbnN1cmUgdGhhdCBhIGNvbnRhaW5lciBpcyBydW5uaW5nIHdpdGggdGhlIHNwZWNpZmllZCBuYW1lIGFuZCBleGFjdCBpbWFnZS4KIyAgIElmIGFueSBjb25maWd1cmF0aW9uIG9wdGlvbnMgaGF2ZSBjaGFuZ2VkLCB0aGUgZXhpc3RpbmcgY29udGFpbmVyIHdpbGwgYmUKIyAgIHN0b3BwZWQgYW5kIHJlbW92ZWQsIGFuZCBhIG5ldyBvbmUgd2lsbCBiZSBsYXVuY2hlZCBpbiBpdHMgcGxhY2UuCiMgLSBsaW5rIHRoaXMgY29udGFpbmVyIHRvIHRoZSBleGlzdGluZyByZWRpcyBjb250YWluZXIgbGF1bmNoZWQgYWJvdmUgd2l0aAojICAgYW4gYWxpYXMuCiMgLSBncmFudCB0aGUgY29udGFpbmVyIHJlYWQgd3JpdGUgcGVybWlzc2lvbnMgZm9yIHRoZSBob3N0J3MgL2Rldi9zZGEgZGV2aWNlCiMgICB0aHJvdWdoIGEgbm9kZSBuYW1lZCAvZGV2L3h2ZGEKIyAtIGJpbmQgVENQIHBvcnQgOTAwMCB3aXRoaW4gdGhlIGNvbnRhaW5lciB0byBwb3J0IDgwODAgb24gYWxsIGludGVyZmFjZXMKIyAgIG9uIHRoZSBob3N0LgojIC0gYmluZCBVRFAgcG9ydCA5MDAxIHdpdGhpbiB0aGUgY29udGFpbmVyIHRvIHBvcnQgODA4MSBvbiB0aGUgaG9zdCwgb25seQojICAgbGlzdGVuaW5nIG9uIGxvY2FsaG9zdC4KIyAtIHNwZWNpZnkgMiBpcCByZXNvbHV0aW9ucy4KIyAtIHNldCB0aGUgZW52aXJvbm1lbnQgdmFyaWFibGUgU0VDUkVUX0tFWSB0byAic3Nzc2giLgoKLSBuYW1lOiBhcHBsaWNhdGlvbiBjb250YWluZXIKICBkb2NrZXI6CiAgICBuYW1lOiBteWFwcGxpY2F0aW9uCiAgICBpbWFnZTogc29tZXVzZXIvYXBwaW1hZ2UKICAgIHN0YXRlOiByZWxvYWRlZAogICAgcHVsbDogYWx3YXlzCiAgICBsaW5rczoKICAgIC0gIm15cmVkaXM6YWxpYXNlZHJlZGlzIgogICAgZGV2aWNlczoKICAgIC0gIi9kZXYvc2RhOi9kZXYveHZkYTpyd20iCiAgICBwb3J0czoKICAgIC0gIjgwODA6OTAwMCIKICAgIC0gIjEyNy4wLjAuMTo4MDgxOjkwMDEvdWRwIgogICAgZXh0cmFfaG9zdHM6CiAgICAgIGhvc3QxOiAiMTkyLjE2OC4wLjEiCiAgICAgIGhvc3QyOiAiMTkyLjE2OC4wLjIiCiAgICBlbnY6CiAgICAgICAgU0VDUkVUX0tFWTogc3Nzc2gKCiMgRW5zdXJlIHRoYXQgZXhhY3RseSBmaXZlIGNvbnRhaW5lcnMgb2YgYW5vdGhlciBzZXJ2ZXIgYXJlIHJ1bm5pbmcgd2l0aCB0aGlzCiMgZXhhY3QgaW1hZ2UgYW5kIGNvbW1hbmQuIElmIGZld2VyIHRoYW4gZml2ZSBhcmUgcnVubmluZywgbW9yZSB3aWxsIGJlIGxhdW5jaGVkOwojIGlmIG1vcmUgYXJlIHJ1bm5pbmcsIHRoZSBleGNlc3Mgd2lsbCBiZSBzdG9wcGVkLgoKLSBuYW1lOiBsb2FkLWJhbGFuY2VkIGNvbnRhaW5lcnMKICBkb2NrZXI6CiAgICBzdGF0ZTogcmVsb2FkZWQKICAgIGNvdW50OiA1CiAgICBpbWFnZTogc29tZXVzZXIvYW5vdGhlcmFwcGltYWdlCiAgICBjb21tYW5kOiBzbGVlcCAxZAoKIyBVbmNvbmRpdGlvbmFsbHkgcmVzdGFydCBhIHNlcnZpY2UgY29udGFpbmVyLiBUaGlzIG1heSBiZSB1c2VmdWwgd2l0aGluIGEKIyBoYW5kbGVyLCBmb3IgZXhhbXBsZS4KCi0gbmFtZTogYXBwbGljYXRpb24gc2VydmljZQogIGRvY2tlcjoKICAgIG5hbWU6IG15c2VydmljZQogICAgaW1hZ2U6IHNvbWV1c2VyL3NlcnZpY2VpbWFnZQogICAgc3RhdGU6IHJlc3RhcnRlZAoKIyBTdG9wIGFsbCBjb250YWluZXJzIHJ1bm5pbmcgdGhlIHNwZWNpZmllZCBpbWFnZS4KCi0gbmFtZTogb2Jzb2xldGUgY29udGFpbmVyCiAgZG9ja2VyOgogICAgaW1hZ2U6IHNvbWV1c2VyL29sZGFuZGJ1c3RlZAogICAgc3RhdGU6IHN0b3BwZWQKCiMgU3RvcCBhbmQgcmVtb3ZlIGEgY29udGFpbmVyIHdpdGggdGhlIHNwZWNpZmllZCBuYW1lLgoKLSBuYW1lOiBvYnNvbGV0ZSBjb250YWluZXIKICBkb2NrZXI6CiAgICBuYW1lOiBvaG5vCiAgICBpbWFnZTogc29tZXVzZXIvb2xkYW5kYnVzdGVkCiAgICBzdGF0ZTogYWJzZW50CgojIEV4YW1wbGUgU3lzbG9nZ2luZyBPdXRwdXQKCi0gbmFtZTogbXlzZXJ2aWNlIGNvbnRhaW5lcgogIGRvY2tlcjoKICAgIG5hbWU6IG15c2VydmljZQogICAgaW1hZ2U6IHNvbWVzZXJ2aWNlL3NvbWVpbWFnZQogICAgc3RhdGU6IHJlbG9hZGVkCiAgICBsb2dfZHJpdmVyOiBzeXNsb2cKICAgIGxvZ19vcHQ6CiAgICAgIHN5c2xvZy1hZGRyZXNzOiB0Y3A6Ly9teS1zeXNsb2ctc2VydmVyOjUxNAogICAgICBzeXNsb2ctZmFjaWxpdHk6IGRhZW1vbgogICAgICBzeXNsb2ctdGFnOiBteXNlcnZpY2UKJycnCgpIQVNfRE9DS0VSX1BZID0gVHJ1ZQpERUZBVUxUX0RPQ0tFUl9BUElfVkVSU0lPTiA9IE5vbmUKREVGQVVMVF9USU1FT1VUX1NFQ09ORFMgPSA2MAoKaW1wb3J0IHN5cwppbXBvcnQganNvbgppbXBvcnQgb3MKaW1wb3J0IHNobGV4CnRyeToKICAgIGZyb20gdXJscGFyc2UgaW1wb3J0IHVybHBhcnNlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICMgcHl0aG9uMwogICAgZnJvbSB1cmxsaWIucGFyc2UgaW1wb3J0IHVybHBhcnNlCgp0cnk6CiAgICBpbXBvcnQgZG9ja2VyLmNsaWVudAogICAgaW1wb3J0IGRvY2tlci51dGlscwogICAgaW1wb3J0IGRvY2tlci5lcnJvcnMKICAgIGZyb20gcmVxdWVzdHMuZXhjZXB0aW9ucyBpbXBvcnQgUmVxdWVzdEV4Y2VwdGlvbgpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBIQVNfRE9DS0VSX1BZID0gRmFsc2UKCmlmIEhBU19ET0NLRVJfUFk6CiAgICB0cnk6CiAgICAgICAgZnJvbSBkb2NrZXIuZXJyb3JzIGltcG9ydCBBUElFcnJvciBhcyBEb2NrZXJBUElFcnJvcgogICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgIGZyb20gZG9ja2VyLmNsaWVudCBpbXBvcnQgQVBJRXJyb3IgYXMgRG9ja2VyQVBJRXJyb3IKICAgIHRyeToKICAgICAgICAjIGRvY2tlci1weSAxLjIrCiAgICAgICAgaW1wb3J0IGRvY2tlci5jb25zdGFudHMKICAgICAgICBERUZBVUxUX0RPQ0tFUl9BUElfVkVSU0lPTiA9IGRvY2tlci5jb25zdGFudHMuREVGQVVMVF9ET0NLRVJfQVBJX1ZFUlNJT04KICAgICAgICBERUZBVUxUX1RJTUVPVVRfU0VDT05EUyA9IGRvY2tlci5jb25zdGFudHMuREVGQVVMVF9USU1FT1VUX1NFQ09ORFMKICAgIGV4Y2VwdCAoSW1wb3J0RXJyb3IsIEF0dHJpYnV0ZUVycm9yKToKICAgICAgICAjIGRvY2tlci1weSBsZXNzIHRoYW4gMS4yCiAgICAgICAgREVGQVVMVF9ET0NLRVJfQVBJX1ZFUlNJT04gPSBkb2NrZXIuY2xpZW50LkRFRkFVTFRfRE9DS0VSX0FQSV9WRVJTSU9OCiAgICAgICAgREVGQVVMVF9USU1FT1VUX1NFQ09ORFMgPSBkb2NrZXIuY2xpZW50LkRFRkFVTFRfVElNRU9VVF9TRUNPTkRTCgoKZGVmIF9odW1hbl90b19ieXRlcyhudW1iZXIpOgogICAgc3VmZml4ZXMgPSBbJ0InLCAnS0InLCAnTUInLCAnR0InLCAnVEInLCAnUEInXQoKICAgIGlmIGlzaW5zdGFuY2UobnVtYmVyLCBpbnQpOgogICAgICAgIHJldHVybiBudW1iZXIKICAgIGlmIG51bWJlci5pc2RpZ2l0KCk6CiAgICAgICAgcmV0dXJuIGludChudW1iZXIpCiAgICBpZiBudW1iZXJbLTFdID09IHN1ZmZpeGVzWzBdIGFuZCBudW1iZXJbLTJdLmlzZGlnaXQoKToKICAgICAgICByZXR1cm4gbnVtYmVyWzotMV0KCiAgICBpID0gMQogICAgZm9yIGVhY2ggaW4gc3VmZml4ZXNbMTpdOgogICAgICAgIGlmIG51bWJlclstbGVuKGVhY2gpOl0gPT0gc3VmZml4ZXNbaV06CiAgICAgICAgICAgIHJldHVybiBpbnQobnVtYmVyWzotbGVuKGVhY2gpXSkgKiAoMTAyNCAqKiBpKQogICAgICAgIGkgPSBpICsgMQoKICAgIHJhaXNlIFZhbHVlRXJyb3IoJ0NvdWxkIG5vdCBjb252ZXJ0ICVzIHRvIGludGVnZXInICUgKG51bWJlciwpKQoKCmRlZiBfYW5zaWJsZV9mYWN0cyhjb250YWluZXJfbGlzdCk6CiAgICByZXR1cm4geyJkb2NrZXJfY29udGFpbmVycyI6IGNvbnRhaW5lcl9saXN0fQoKCmRlZiBfZG9ja2VyX2lkX3F1aXJrKGluc3BlY3QpOgogICAgIyBYWFg6IHNvbWUgcXVpcmsgaW4gZG9ja2VyCiAgICBpZiAnSUQnIGluIGluc3BlY3Q6CiAgICAgICAgaW5zcGVjdFsnSWQnXSA9IGluc3BlY3RbJ0lEJ10KICAgICAgICBkZWwgaW5zcGVjdFsnSUQnXQogICAgcmV0dXJuIGluc3BlY3QKCgpkZWYgZ2V0X3NwbGl0X2ltYWdlX3RhZyhpbWFnZSk6CiAgICAjIElmIGltYWdlIGNvbnRhaW5zIGEgaG9zdCBvciBvcmcgbmFtZSwgb21pdCB0aGF0IGZyb20gb3VyIGNoZWNrCiAgICBpZiAnLycgaW4gaW1hZ2U6CiAgICAgICAgcmVnaXN0cnksIHJlc291cmNlID0gaW1hZ2UucnNwbGl0KCcvJywgMSkKICAgIGVsc2U6CiAgICAgICAgcmVnaXN0cnksIHJlc291cmNlID0gTm9uZSwgaW1hZ2UKCiAgICAjIG5vdyB3ZSBjYW4gZGV0ZXJtaW5lIGlmIGltYWdlIGhhcyBhIHRhZyBvciBhIGRpZ2VzdAogICAgZm9yIHMgaW4gWydAJywnOiddOgogICAgICAgIGlmIHMgaW4gcmVzb3VyY2U6CiAgICAgICAgICAgIHJlc291cmNlLCB0YWcgPSByZXNvdXJjZS5zcGxpdChzLCAxKQogICAgICAgICAgICBpZiByZWdpc3RyeToKICAgICAgICAgICAgICAgIHJlc291cmNlID0gJy8nLmpvaW4oKHJlZ2lzdHJ5LCByZXNvdXJjZSkpCiAgICAgICAgICAgIGJyZWFrCiAgICBlbHNlOgogICAgICAgIHRhZyA9ICJsYXRlc3QiCiAgICAgICAgcmVzb3VyY2UgPSBpbWFnZQoKICAgIHJldHVybiByZXNvdXJjZSwgdGFnCgpkZWYgbm9ybWFsaXplX2ltYWdlKGltYWdlKToKICAgICIiIgogICAgTm9ybWFsaXplIGEgRG9ja2VyIGltYWdlIG5hbWUgdG8gaW5jbHVkZSB0aGUgaW1wbGllZCA6bGF0ZXN0IHRhZy4KICAgICIiIgoKICAgIHJldHVybiAiOiIuam9pbihnZXRfc3BsaXRfaW1hZ2VfdGFnKGltYWdlKSkKCgpkZWYgaXNfcnVubmluZyhjb250YWluZXIpOgogICAgJycnUmV0dXJuIFRydWUgaWYgYW4gaW5zcGVjdGVkIGNvbnRhaW5lciBpcyBpbiBhIHN0YXRlIHdlIGNvbnNpZGVyICJydW5uaW5nLiInJycKCiAgICByZXR1cm4gY29udGFpbmVyWydTdGF0ZSddWydSdW5uaW5nJ10gaXMgVHJ1ZSBhbmQgbm90IGNvbnRhaW5lclsnU3RhdGUnXS5nZXQoJ0dob3N0JywgRmFsc2UpCgoKZGVmIGdldF9kb2NrZXJfcHlfdmVyc2lvbmluZm8oKToKICAgIGlmIGhhc2F0dHIoZG9ja2VyLCAnX192ZXJzaW9uX18nKToKICAgICAgICAjIGEgJ19fdmVyc2lvbl9fJyBhdHRyaWJ1dGUgd2FzIGFkZGVkIHRvIHRoZSBtb2R1bGUgYnV0IG5vdCB1bnRpbAogICAgICAgICMgYWZ0ZXIgMC4zLjAgd2FzIHB1c2hlZCB0byBweXBpLiBJZiBpdCdzIHRoZXJlLCB1c2UgaXQuCiAgICAgICAgdmVyc2lvbiA9IFtdCiAgICAgICAgZm9yIHBhcnQgaW4gZG9ja2VyLl9fdmVyc2lvbl9fLnNwbGl0KCcuJyk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHZlcnNpb24uYXBwZW5kKGludChwYXJ0KSkKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICBmb3IgaWR4LCBjaGFyIGluIGVudW1lcmF0ZShwYXJ0KToKICAgICAgICAgICAgICAgICAgICBpZiBub3QgY2hhci5pc2RpZ2l0KCk6CiAgICAgICAgICAgICAgICAgICAgICAgIG5vbmRpZ2l0ID0gcGFydFtpZHg6XQogICAgICAgICAgICAgICAgICAgICAgICBkaWdpdCA9IHBhcnRbOmlkeF0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGlmIGRpZ2l0OgogICAgICAgICAgICAgICAgICAgIHZlcnNpb24uYXBwZW5kKGludChkaWdpdCkpCiAgICAgICAgICAgICAgICBpZiBub25kaWdpdDoKICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uLmFwcGVuZChub25kaWdpdCkKICAgIGVsaWYgaGFzYXR0cihkb2NrZXIuQ2xpZW50LCAnX2dldF9yYXdfcmVzcG9uc2Vfc29ja2V0Jyk6CiAgICAgICAgIyBIQUNLOiBpZiAnX192ZXJzaW9uX18nIGlzbid0IHRoZXJlLCB3ZSBjaGVjayBmb3IgdGhlIGV4aXN0ZW5jZSBvZgogICAgICAgICMgYF9nZXRfcmF3X3Jlc3BvbnNlX3NvY2tldGAgaW4gdGhlIGRvY2tlci5DbGllbnQgY2xhc3MsIHdoaWNoIHdhcwogICAgICAgICMgYWRkZWQgaW4gMC4zLjAKICAgICAgICB2ZXJzaW9uID0gKDAsIDMsIDApCiAgICBlbHNlOgogICAgICAgICMgVGhpcyBpcyB1bnRydWUgYnV0IHRoaXMgbW9kdWxlIGRvZXMgbm90IGZ1bmN0aW9uIHdpdGggYSB2ZXJzaW9uIGxlc3MKICAgICAgICAjIHRoYW4gMC4zLjAgc28gaXQncyBva2F5IHRvIGxpZSBoZXJlLgogICAgICAgIHZlcnNpb24gPSAoMCwpCgogICAgcmV0dXJuIHR1cGxlKHZlcnNpb24pCgoKZGVmIGNoZWNrX2RlcGVuZGVuY2llcyhtb2R1bGUpOgogICAgIiIiCiAgICBFbnN1cmUgYGRvY2tlci1weWAgPj0gMC4zLjAgaXMgaW5zdGFsbGVkLCBhbmQgY2FsbCBtb2R1bGUuZmFpbF9qc29uIHdpdGggYQogICAgaGVscGZ1bCBlcnJvciBtZXNzYWdlIGlmIGl0IGlzbid0LgogICAgIiIiCiAgICBpZiBub3QgSEFTX0RPQ0tFUl9QWToKICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG1zZz0iYGRvY2tlci1weWAgZG9lc24ndCBzZWVtIHRvIGJlIGluc3RhbGxlZCwgYnV0IGlzIHJlcXVpcmVkIGZvciB0aGUgQW5zaWJsZSBEb2NrZXIgbW9kdWxlLiIpCiAgICBlbHNlOgogICAgICAgIHZlcnNpb25pbmZvID0gZ2V0X2RvY2tlcl9weV92ZXJzaW9uaW5mbygpCiAgICAgICAgaWYgdmVyc2lvbmluZm8gPCAoMCwgMywgMCk6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24obXNnPSJUaGUgQW5zaWJsZSBEb2NrZXIgbW9kdWxlIHJlcXVpcmVzIGBkb2NrZXItcHlgID49IDAuMy4wLiIpCgoKY2xhc3MgRG9ja2VyTWFuYWdlcihvYmplY3QpOgoKICAgIGNvdW50ZXJzID0gZGljdCgKICAgICAgICBjcmVhdGVkPTAsIHN0YXJ0ZWQ9MCwgc3RvcHBlZD0wLCBraWxsZWQ9MCwgcmVtb3ZlZD0wLCByZXN0YXJ0ZWQ9MCwgcHVsbGVkPTAKICAgICkKICAgIHJlbG9hZF9yZWFzb25zID0gW10KICAgIF9jYXBhYmlsaXRpZXMgPSBzZXQoKQoKICAgICMgTWFwIG9wdGlvbmFsIHBhcmFtZXRlcnMgdG8gbWluaW11bSAoZG9ja2VyLXB5IHZlcnNpb24sIHNlcnZlciBBUElWZXJzaW9uKQogICAgIyBkb2NrZXItcHkgdmVyc2lvbiBpcyBhIHR1cGxlIG9mIGludHMgYmVjYXVzZSB3ZSBoYXZlIHRvIGNvbXBhcmUgdGhlbQogICAgIyBzZXJ2ZXIgQVBJVmVyc2lvbiBpcyBwYXNzZWQgdG8gYSBkb2NrZXItcHkgZnVuY3Rpb24gdGhhdCB0YWtlcyBzdHJpbmdzCiAgICBfY2FwX3Zlcl9yZXEgPSB7CiAgICAgICAgJ2RldmljZXMnOiAoKDAsIDcsIDApLCAnMS4yJyksCiAgICAgICAgJ2Rucyc6ICgoMCwgMywgMCksICcxLjEwJyksCiAgICAgICAgJ3ZvbHVtZXNfZnJvbSc6ICgoMCwgMywgMCksICcxLjEwJyksCiAgICAgICAgJ3Jlc3RhcnRfcG9saWN5JzogKCgwLCA1LCAwKSwgJzEuMTQnKSwKICAgICAgICAnZXh0cmFfaG9zdHMnOiAoKDAsIDcsIDApLCAnMS4zLjEnKSwKICAgICAgICAncGlkJzogKCgxLCAwLCAwKSwgJzEuMTcnKSwKICAgICAgICAnbG9nX2RyaXZlcic6ICgoMSwgMiwgMCksICcxLjE4JyksCiAgICAgICAgJ2xvZ19vcHQnOiAoKDEsIDIsIDApLCAnMS4xOCcpLAogICAgICAgICdob3N0X2NvbmZpZyc6ICgoMCwgNywgMCksICcxLjE1JyksCiAgICAgICAgJ2NwdV9zZXQnOiAoKDAsIDYsIDApLCAnMS4xNCcpLAogICAgICAgICdjYXBfYWRkJzogKCgwLCA1LCAwKSwgJzEuMTQnKSwKICAgICAgICAnY2FwX2Ryb3AnOiAoKDAsIDUsIDApLCAnMS4xNCcpLAogICAgICAgICdyZWFkX29ubHknOiAoKDEsIDAsIDApLCAnMS4xNycpLAogICAgICAgICdsYWJlbHMnOiAoKDEsIDIsIDApLCAnMS4xOCcpLAogICAgICAgICdzdG9wX3RpbWVvdXQnOiAoKDAsIDUsIDApLCAnMS4wJyksCiAgICAgICAgJ3VsaW1pdHMnOiAoKDEsIDIsIDApLCAnMS4xOCcpLAogICAgICAgICMgQ2xpZW50c2lkZSBvbmx5CiAgICAgICAgJ2luc2VjdXJlX3JlZ2lzdHJ5JzogKCgwLCA1LCAwKSwgJzAuMCcpLAogICAgICAgICdlbnZfZmlsZSc6ICgoMSwgNCwgMCksICcwLjAnKQogICAgICAgIH0KCiAgICBkZWYgX19pbml0X18oc2VsZiwgbW9kdWxlKToKICAgICAgICBzZWxmLm1vZHVsZSA9IG1vZHVsZQoKICAgICAgICBzZWxmLmJpbmRzID0gTm9uZQogICAgICAgIHNlbGYudm9sdW1lcyA9IE5vbmUKICAgICAgICBpZiBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCd2b2x1bWVzJyk6CiAgICAgICAgICAgIHNlbGYuYmluZHMgPSBbXQogICAgICAgICAgICBzZWxmLnZvbHVtZXMgPSBbXQogICAgICAgICAgICB2b2xzID0gc2VsZi5tb2R1bGUucGFyYW1zLmdldCgndm9sdW1lcycpCiAgICAgICAgICAgIGZvciB2b2wgaW4gdm9sczoKICAgICAgICAgICAgICAgIHBhcnRzID0gdm9sLnNwbGl0KCI6IikKICAgICAgICAgICAgICAgICMgcmVndWxhciB2b2x1bWUKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPT0gMToKICAgICAgICAgICAgICAgICAgICBzZWxmLnZvbHVtZXMuYXBwZW5kKHBhcnRzWzBdKQogICAgICAgICAgICAgICAgIyBob3N0IG1vdW50IChlLmcuIC9tbnQ6L3RtcCwgYmluZCBtb3VudHMgaG9zdCdzIC90bXAgdG8gL21udCBpbiB0aGUgY29udGFpbmVyKQogICAgICAgICAgICAgICAgZWxpZiAyIDw9IGxlbihwYXJ0cykgPD0gMzoKICAgICAgICAgICAgICAgICAgICAjIGRlZmF1bHQgdG8gcmVhZC13cml0ZQogICAgICAgICAgICAgICAgICAgIG1vZGUgPSAncncnCiAgICAgICAgICAgICAgICAgICAgIyB3aXRoIHN1cHBsaWVkIGJpbmQgbW9kZQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPT0gMzoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcGFydHNbMl0gbm90IGluIFsicnciLCAicncsWiIsICJydyx6IiwgInoscnciLCAiWixydyIsICJaIiwgInoiLCAicm8iLCAicm8sWiIsICJybyx6IiwgInoscm8iLCAiWixybyJdOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0naW52YWxpZCBiaW5kIG1vZGUgJyArIHBhcnRzWzJdKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZSA9IHBhcnRzWzJdCiAgICAgICAgICAgICAgICAgICAgc2VsZi5iaW5kcy5hcHBlbmQoIiVzOiVzOiVzIiAlIChwYXJ0c1swXSwgcGFydHNbMV0sIG1vZGUpKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSd2b2x1bWVzIHN1cHBvcnQgMSB0byAzIGFyZ3VtZW50cycpCgogICAgICAgIHNlbGYubHhjX2NvbmYgPSBOb25lCiAgICAgICAgaWYgc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnbHhjX2NvbmYnKToKICAgICAgICAgICAgc2VsZi5seGNfY29uZiA9IFtdCiAgICAgICAgICAgIG9wdGlvbnMgPSBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdseGNfY29uZicpCiAgICAgICAgICAgIGZvciBvcHRpb24gaW4gb3B0aW9uczoKICAgICAgICAgICAgICAgIHBhcnRzID0gb3B0aW9uLnNwbGl0KCc6JywgMSkKICAgICAgICAgICAgICAgIHNlbGYubHhjX2NvbmYuYXBwZW5kKHsiS2V5IjogcGFydHNbMF0sICJWYWx1ZSI6IHBhcnRzWzFdfSkKCiAgICAgICAgc2VsZi5leHBvc2VkX3BvcnRzID0gTm9uZQogICAgICAgIGlmIHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2V4cG9zZScpOgogICAgICAgICAgICBzZWxmLmV4cG9zZWRfcG9ydHMgPSBzZWxmLmdldF9leHBvc2VkX3BvcnRzKHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2V4cG9zZScpKQoKICAgICAgICBzZWxmLnBvcnRfYmluZGluZ3MgPSBOb25lCiAgICAgICAgaWYgc2VsZi5tb2R1bGUucGFyYW1zLmdldCgncG9ydHMnKToKICAgICAgICAgICAgc2VsZi5wb3J0X2JpbmRpbmdzID0gc2VsZi5nZXRfcG9ydF9iaW5kaW5ncyhzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdwb3J0cycpKQoKICAgICAgICBzZWxmLmxpbmtzID0gTm9uZQogICAgICAgIGlmIHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2xpbmtzJyk6CiAgICAgICAgICAgIHNlbGYubGlua3MgPSBzZWxmLmdldF9saW5rcyhzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdsaW5rcycpKQoKICAgICAgICBzZWxmLnVsaW1pdHMgPSBOb25lCiAgICAgICAgaWYgc2VsZi5tb2R1bGUucGFyYW1zLmdldCgndWxpbWl0cycpOgogICAgICAgICAgICBzZWxmLnVsaW1pdHMgPSBbXQogICAgICAgICAgICB1bGltaXRzID0gc2VsZi5tb2R1bGUucGFyYW1zLmdldCgndWxpbWl0cycpCiAgICAgICAgICAgIGZvciB1bGltaXQgaW4gdWxpbWl0czoKICAgICAgICAgICAgICAgIHBhcnRzID0gdWxpbWl0LnNwbGl0KCI6IikKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPT0gMjoKICAgICAgICAgICAgICAgICAgICBzZWxmLnVsaW1pdHMuYXBwZW5kKHsnbmFtZSc6IHBhcnRzWzBdLCAnc29mdCc6IGludChwYXJ0c1sxXSksICdoYXJkJzogaW50KHBhcnRzWzFdKX0pCiAgICAgICAgICAgICAgICBlbGlmIGxlbihwYXJ0cykgPT0gMzoKICAgICAgICAgICAgICAgICAgICBzZWxmLnVsaW1pdHMuYXBwZW5kKHsnbmFtZSc6IHBhcnRzWzBdLCAnc29mdCc6IGludChwYXJ0c1sxXSksICdoYXJkJzogaW50KHBhcnRzWzJdKX0pCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubW9kdWxlLmZhaWxfanNvbihtc2c9J3VsaW1pdHMgc3VwcG9ydCAyIHRvIDMgYXJndW1lbnRzJykKCiAgICAgICAgIyBDb25uZWN0IHRvIHRoZSBkb2NrZXIgc2VydmVyIHVzaW5nIGFueSBjb25maWd1cmVkIGhvc3QgYW5kIFRMUyBzZXR0aW5ncy4KCiAgICAgICAgZW52X2hvc3QgPSBvcy5nZXRlbnYoJ0RPQ0tFUl9IT1NUJykKICAgICAgICBlbnZfZG9ja2VyX3ZlcmlmeSA9IG9zLmdldGVudignRE9DS0VSX1RMU19WRVJJRlknKQogICAgICAgIGVudl9jZXJ0X3BhdGggPSBvcy5nZXRlbnYoJ0RPQ0tFUl9DRVJUX1BBVEgnKQogICAgICAgIGVudl9kb2NrZXJfaG9zdG5hbWUgPSBvcy5nZXRlbnYoJ0RPQ0tFUl9UTFNfSE9TVE5BTUUnKQoKICAgICAgICBkb2NrZXJfdXJsID0gbW9kdWxlLnBhcmFtcy5nZXQoJ2RvY2tlcl91cmwnKQogICAgICAgIGlmIG5vdCBkb2NrZXJfdXJsOgogICAgICAgICAgICBpZiBlbnZfaG9zdDoKICAgICAgICAgICAgICAgIGRvY2tlcl91cmwgPSBlbnZfaG9zdAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZG9ja2VyX3VybCA9ICd1bml4Oi8vdmFyL3J1bi9kb2NrZXIuc29jaycKCiAgICAgICAgZG9ja2VyX2FwaV92ZXJzaW9uID0gbW9kdWxlLnBhcmFtcy5nZXQoJ2RvY2tlcl9hcGlfdmVyc2lvbicpCiAgICAgICAgdGltZW91dCA9IG1vZHVsZS5wYXJhbXMuZ2V0KCd0aW1lb3V0JykKCiAgICAgICAgdGxzX2NsaWVudF9jZXJ0ID0gbW9kdWxlLnBhcmFtcy5nZXQoJ3Rsc19jbGllbnRfY2VydCcsIE5vbmUpCiAgICAgICAgaWYgbm90IHRsc19jbGllbnRfY2VydCBhbmQgZW52X2NlcnRfcGF0aDoKICAgICAgICAgICAgdGxzX2NsaWVudF9jZXJ0ID0gb3MucGF0aC5qb2luKGVudl9jZXJ0X3BhdGgsICdjZXJ0LnBlbScpCgogICAgICAgIHRsc19jbGllbnRfa2V5ID0gbW9kdWxlLnBhcmFtcy5nZXQoJ3Rsc19jbGllbnRfa2V5JywgTm9uZSkKICAgICAgICBpZiBub3QgdGxzX2NsaWVudF9rZXkgYW5kIGVudl9jZXJ0X3BhdGg6CiAgICAgICAgICAgIHRsc19jbGllbnRfa2V5ID0gb3MucGF0aC5qb2luKGVudl9jZXJ0X3BhdGgsICdrZXkucGVtJykKCiAgICAgICAgdGxzX2NhX2NlcnQgPSBtb2R1bGUucGFyYW1zLmdldCgndGxzX2NhX2NlcnQnKQogICAgICAgIGlmIG5vdCB0bHNfY2FfY2VydCBhbmQgZW52X2NlcnRfcGF0aDoKICAgICAgICAgICAgdGxzX2NhX2NlcnQgPSBvcy5wYXRoLmpvaW4oZW52X2NlcnRfcGF0aCwgJ2NhLnBlbScpCgogICAgICAgIHRsc19ob3N0bmFtZSA9IG1vZHVsZS5wYXJhbXMuZ2V0KCd0bHNfaG9zdG5hbWUnKQogICAgICAgIGlmIHRsc19ob3N0bmFtZSBpcyBOb25lOgogICAgICAgICAgICBpZiBlbnZfZG9ja2VyX2hvc3RuYW1lOgogICAgICAgICAgICAgICAgdGxzX2hvc3RuYW1lID0gZW52X2RvY2tlcl9ob3N0bmFtZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcGFyc2VkX3VybCA9IHVybHBhcnNlKGRvY2tlcl91cmwpCiAgICAgICAgICAgICAgICBpZiAnOicgaW4gcGFyc2VkX3VybC5uZXRsb2M6CiAgICAgICAgICAgICAgICAgICAgdGxzX2hvc3RuYW1lID0gcGFyc2VkX3VybC5uZXRsb2NbOnBhcnNlZF91cmwubmV0bG9jLnJpbmRleCgnOicpXQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB0bHNfaG9zdG5hbWUgPSBwYXJzZWRfdXJsCiAgICAgICAgaWYgbm90IHRsc19ob3N0bmFtZToKICAgICAgICAgICAgdGxzX2hvc3RuYW1lID0gVHJ1ZQoKICAgICAgICAjIHVzZV90bHMgY2FuIGJlIG9uZSBvZiBmb3VyIHZhbHVlczoKICAgICAgICAjIG5vOiBEbyBub3QgdXNlIHRscwogICAgICAgICMgZW5jcnlwdDogVXNlIHRscy4gIFdlIG1heSBkbyBjbGllbnQgYXV0aC4gIFdlIHdpbGwgbm90IHZlcmlmeSB0aGUgc2VydmVyCiAgICAgICAgIyB2ZXJpZnk6IFVzZSB0bHMuICBXZSBtYXkgZG8gY2xpZW50IGF1dGguICBXZSB3aWxsIHZlcmlmeSB0aGUgc2VydmVyCiAgICAgICAgIyBOb25lOiBPbmx5IHVzZSB0bHMgaWYgdGhlIHBhcmFtZXRlcnMgZm9yIGNsaWVudCBhdXRoIHdlcmUgc3BlY2lmaWVkCiAgICAgICAgIyAgIG9yIHRsc19jYV9jZXJ0ICh3aGljaCByZXF1ZXN0cyB2ZXJpZnlpbmcgdGhlIHNlcnZlciB3aXRoCiAgICAgICAgIyAgIGEgc3BlY2lmaWMgY2EgY2VydGlmaWNhdGUpCiAgICAgICAgdXNlX3RscyA9IG1vZHVsZS5wYXJhbXMuZ2V0KCd1c2VfdGxzJykKICAgICAgICBpZiB1c2VfdGxzIGlzIE5vbmUgYW5kIGVudl9kb2NrZXJfdmVyaWZ5IGlzIG5vdCBOb25lOgogICAgICAgICAgICB1c2VfdGxzID0gJ3ZlcmlmeScKCiAgICAgICAgdGxzX2NvbmZpZyA9IE5vbmUKICAgICAgICBpZiB1c2VfdGxzICE9ICdubyc6CiAgICAgICAgICAgIHBhcmFtcyA9IHt9CgogICAgICAgICAgICAjIFNldHVwIGNsaWVudCBhdXRoCiAgICAgICAgICAgIGlmIHRsc19jbGllbnRfY2VydCBhbmQgdGxzX2NsaWVudF9rZXk6CiAgICAgICAgICAgICAgICBwYXJhbXNbJ2NsaWVudF9jZXJ0J10gPSAodGxzX2NsaWVudF9jZXJ0LCB0bHNfY2xpZW50X2tleSkKCiAgICAgICAgICAgICMgV2UncmUgYWxsb3dlZCB0byB2ZXJpZnkgdGhlIGNvbm5lY3Rpb24gdG8gdGhlIHNlcnZlcgogICAgICAgICAgICBpZiB1c2VfdGxzID09ICd2ZXJpZnknIG9yICh1c2VfdGxzIGlzIE5vbmUgYW5kIHRsc19jYV9jZXJ0KToKICAgICAgICAgICAgICAgIGlmIHRsc19jYV9jZXJ0OgogICAgICAgICAgICAgICAgICAgIHBhcmFtc1snY2FfY2VydCddID0gdGxzX2NhX2NlcnQKICAgICAgICAgICAgICAgICAgICBwYXJhbXNbJ3ZlcmlmeSddID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIHBhcmFtc1snYXNzZXJ0X2hvc3RuYW1lJ10gPSB0bHNfaG9zdG5hbWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcGFyYW1zWyd2ZXJpZnknXSA9IFRydWUKICAgICAgICAgICAgICAgICAgICBwYXJhbXNbJ2Fzc2VydF9ob3N0bmFtZSddID0gdGxzX2hvc3RuYW1lCiAgICAgICAgICAgIGVsaWYgdXNlX3RscyA9PSAnZW5jcnlwdCc6CiAgICAgICAgICAgICAgICBwYXJhbXNbJ3ZlcmlmeSddID0gRmFsc2UKCiAgICAgICAgICAgIGlmIHBhcmFtczoKICAgICAgICAgICAgICAgICMgU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9kb2NrZXIvZG9ja2VyLXB5L2Jsb2IvZDM5ZGExMS9kb2NrZXIvdXRpbHMvdXRpbHMucHkjTDI3OS1MMjk2CiAgICAgICAgICAgICAgICBkb2NrZXJfdXJsID0gZG9ja2VyX3VybC5yZXBsYWNlKCd0Y3A6Ly8nLCAnaHR0cHM6Ly8nKQogICAgICAgICAgICAgICAgdGxzX2NvbmZpZyA9IGRvY2tlci50bHMuVExTQ29uZmlnKCoqcGFyYW1zKQoKICAgICAgICBzZWxmLmNsaWVudCA9IGRvY2tlci5DbGllbnQoYmFzZV91cmw9ZG9ja2VyX3VybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmVyc2lvbj1kb2NrZXJfYXBpX3ZlcnNpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRscz10bHNfY29uZmlnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0PXRpbWVvdXQpCgogICAgICAgIHNlbGYuZG9ja2VyX3B5X3ZlcnNpb25pbmZvID0gZ2V0X2RvY2tlcl9weV92ZXJzaW9uaW5mbygpCgogICAgICAgIGVudiA9IHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2VudicsIE5vbmUpCiAgICAgICAgZW52X2ZpbGUgPSBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdlbnZfZmlsZScsIE5vbmUpCiAgICAgICAgc2VsZi5lbnZpcm9ubWVudCA9IHNlbGYuZ2V0X2Vudmlyb25tZW50KGVudiwgZW52X2ZpbGUpCgogICAgZGVmIF9jaGVja19jYXBhYmlsaXRpZXMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQ3JlYXRlIGEgbGlzdCBvZiBhdmFpbGFibGUgY2FwYWJpbGl0aWVzCiAgICAgICAgIiIiCiAgICAgICAgYXBpX3ZlcnNpb24gPSBzZWxmLmNsaWVudC52ZXJzaW9uKClbJ0FwaVZlcnNpb24nXQogICAgICAgIGZvciBjYXAsIHJlcV92ZXJzIGluIHNlbGYuX2NhcF92ZXJfcmVxLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIChzZWxmLmRvY2tlcl9weV92ZXJzaW9uaW5mbyA+PSByZXFfdmVyc1swXSBhbmQKICAgICAgICAgICAgICAgICAgICBkb2NrZXIudXRpbHMuY29tcGFyZV92ZXJzaW9uKHJlcV92ZXJzWzFdLCBhcGlfdmVyc2lvbikgPj0gMCk6CiAgICAgICAgICAgICAgICBzZWxmLl9jYXBhYmlsaXRpZXMuYWRkKGNhcCkKCiAgICBkZWYgZW5zdXJlX2NhcGFiaWxpdHkoc2VsZiwgY2FwYWJpbGl0eSwgZmFpbD1UcnVlKToKICAgICAgICAiIiIKICAgICAgICBTb21lIG9mIHRoZSBmdW5jdGlvbmFsaXR5IHRoaXMgYW5zaWJsZSBtb2R1bGUgaW1wbGVtZW50cyBhcmUgb25seQogICAgICAgIGF2YWlsYWJsZSBpbiBuZXdlciB2ZXJzaW9ucyBvZiBkb2NrZXIuICBFbnN1cmUgdGhhdCB0aGUgY2FwYWJpbGl0eQogICAgICAgIGlzIGF2YWlsYWJsZSBoZXJlLgoKICAgICAgICBJZiBmYWlsIGlzIHNldCB0byBGYWxzZSB0aGVuIHJldHVybiBUcnVlIG9yIEZhbHNlIGRlcGVuZGluZyBvbiB3aGV0aGVyCiAgICAgICAgd2UgaGF2ZSB0aGUgY2FwYWJpbGl0eS4gIE90aGVyd2lzZSwgc2ltcGx5IGZhaWwgYW5kIGV4aXQgdGhlIG1vZHVsZSBpZgogICAgICAgIHdlIGxhY2sgdGhlIGNhcGFiaWxpdHkuCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuX2NhcGFiaWxpdGllczoKICAgICAgICAgICAgc2VsZi5fY2hlY2tfY2FwYWJpbGl0aWVzKCkKCiAgICAgICAgaWYgY2FwYWJpbGl0eSBpbiBzZWxmLl9jYXBhYmlsaXRpZXM6CiAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgIGlmIG5vdCBmYWlsOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgYXBpX3ZlcnNpb24gPSBzZWxmLmNsaWVudC52ZXJzaW9uKClbJ0FwaVZlcnNpb24nXQogICAgICAgIHNlbGYubW9kdWxlLmZhaWxfanNvbihtc2c9J1NwZWNpZnlpbmcgdGhlIGAlc2AgcGFyYW1ldGVyIHJlcXVpcmVzJwogICAgICAgICAgICAgICAgJyBkb2NrZXItcHk6ICVzLCBkb2NrZXIgc2VydmVyIGFwaXZlcnNpb24gJXM7IGZvdW5kJwogICAgICAgICAgICAgICAgJyBkb2NrZXItcHk6ICVzLCBzZXJ2ZXI6ICVzJyAlICgKICAgICAgICAgICAgICAgICAgICBjYXBhYmlsaXR5LAogICAgICAgICAgICAgICAgICAgICcuJy5qb2luKG1hcChzdHIsIHNlbGYuX2NhcF92ZXJfcmVxW2NhcGFiaWxpdHldWzBdKSksCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2FwX3Zlcl9yZXFbY2FwYWJpbGl0eV1bMV0sCiAgICAgICAgICAgICAgICAgICAgJy4nLmpvaW4obWFwKHN0ciwgc2VsZi5kb2NrZXJfcHlfdmVyc2lvbmluZm8pKSwKICAgICAgICAgICAgICAgICAgICBhcGlfdmVyc2lvbikpCgogICAgZGVmIGdldF9lbnZpcm9ubWVudChzZWxmLCBlbnYsIGVudl9maWxlKToKICAgICAgICAiIiIKICAgICAgICBJZiBlbnZpcm9ubWVudCBmaWxlcyBhcmUgY29tYmluZWQgd2l0aCBleHBsaWNpdCBlbnZpcm9ubWVudCB2YXJpYWJsZXMsIHRoZSBleHBsaWNpdCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgd2lsbCBvdmVycmlkZSB0aGUga2V5IGZyb20gdGhlIGVudiBmaWxlLgogICAgICAgICIiIgogICAgICAgIGZpbmFsX2VudiA9IHt9CgogICAgICAgIGlmIGVudl9maWxlOgogICAgICAgICAgICBzZWxmLmVuc3VyZV9jYXBhYmlsaXR5KCdlbnZfZmlsZScpCiAgICAgICAgICAgIHBhcnNlZF9lbnZfZmlsZSA9IGRvY2tlci51dGlscy5wYXJzZV9lbnZfZmlsZShlbnZfZmlsZSkKCiAgICAgICAgICAgIGZvciBuYW1lLCB2YWx1ZSBpbiBwYXJzZWRfZW52X2ZpbGUuaXRlbXMoKToKICAgICAgICAgICAgICAgIGZpbmFsX2VudltuYW1lXSA9IHN0cih2YWx1ZSkKCiAgICAgICAgaWYgZW52OgogICAgICAgICAgICBmb3IgbmFtZSwgdmFsdWUgaW4gZW52Lml0ZW1zKCk6CiAgICAgICAgICAgICAgICBmaW5hbF9lbnZbbmFtZV0gPSBzdHIodmFsdWUpCgogICAgICAgIHJldHVybiBmaW5hbF9lbnYKCiAgICBkZWYgZ2V0X2xpbmtzKHNlbGYsIGxpbmtzKToKICAgICAgICAiIiIKICAgICAgICBQYXJzZSB0aGUgbGlua3MgcGFzc2VkLCBpZiBhIGxpbmsgaXMgc3BlY2lmaWVkIHdpdGhvdXQgYW4gYWxpYXMgdGhlbiBqdXN0IGNyZWF0ZSB0aGUgYWxpYXMgb2YgdGhlIHNhbWUgbmFtZSBhcyB0aGUgbGluawogICAgICAgICIiIgogICAgICAgIHByb2Nlc3NlZF9saW5rcyA9IHt9CgogICAgICAgIGZvciBsaW5rIGluIGxpbmtzOgogICAgICAgICAgICBwYXJzZWRfbGluayA9IGxpbmsuc3BsaXQoJzonLCAxKQogICAgICAgICAgICBpZihsZW4ocGFyc2VkX2xpbmspID09IDIpOgogICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2xpbmtzW3BhcnNlZF9saW5rWzBdXSA9IHBhcnNlZF9saW5rWzFdCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcm9jZXNzZWRfbGlua3NbcGFyc2VkX2xpbmtbMF1dID0gcGFyc2VkX2xpbmtbMF0KCiAgICAgICAgcmV0dXJuIHByb2Nlc3NlZF9saW5rcwoKICAgIGRlZiBnZXRfZXhwb3NlZF9wb3J0cyhzZWxmLCBleHBvc2VfbGlzdCk6CiAgICAgICAgIiIiCiAgICAgICAgUGFyc2UgdGhlIHBvcnRzIGFuZCBwcm90b2NvbHMgKFRDUC9VRFApIHRvIGV4cG9zZSBpbiB0aGUgZG9ja2VyLXB5IGBjcmVhdGVfY29udGFpbmVyYCBjYWxsIGZyb20gdGhlIGRvY2tlciBDTEktc3R5bGUgc3ludGF4LgogICAgICAgICIiIgogICAgICAgIGlmIGV4cG9zZV9saXN0OgogICAgICAgICAgICBleHBvc2VkID0gW10KICAgICAgICAgICAgZm9yIHBvcnQgaW4gZXhwb3NlX2xpc3Q6CiAgICAgICAgICAgICAgICBwb3J0ID0gc3RyKHBvcnQpLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIHBvcnQuZW5kc3dpdGgoJy90Y3AnKSBvciBwb3J0LmVuZHN3aXRoKCcvdWRwJyk6CiAgICAgICAgICAgICAgICAgICAgcG9ydF93aXRoX3Byb3RvID0gdHVwbGUocG9ydC5zcGxpdCgnLycpKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIGFzc3VtZSB0Y3AgcHJvdG9jb2wgaWYgbm90IHNwZWNpZmllZAogICAgICAgICAgICAgICAgICAgIHBvcnRfd2l0aF9wcm90byA9IChwb3J0LCAndGNwJykKICAgICAgICAgICAgICAgIGV4cG9zZWQuYXBwZW5kKHBvcnRfd2l0aF9wcm90bykKICAgICAgICAgICAgcmV0dXJuIGV4cG9zZWQKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBnZXRfc3RhcnRfcGFyYW1zKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIENyZWF0ZSBzdGFydCBwYXJhbXMKICAgICAgICAiIiIKICAgICAgICBwYXJhbXMgPSB7CiAgICAgICAgICAgICdseGNfY29uZic6IHNlbGYubHhjX2NvbmYsCiAgICAgICAgICAgICdiaW5kcyc6IHNlbGYuYmluZHMsCiAgICAgICAgICAgICdwb3J0X2JpbmRpbmdzJzogc2VsZi5wb3J0X2JpbmRpbmdzLAogICAgICAgICAgICAncHVibGlzaF9hbGxfcG9ydHMnOiBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdwdWJsaXNoX2FsbF9wb3J0cycpLAogICAgICAgICAgICAncHJpdmlsZWdlZCc6IHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ3ByaXZpbGVnZWQnKSwKICAgICAgICAgICAgJ2xpbmtzJzogc2VsZi5saW5rcywKICAgICAgICAgICAgJ25ldHdvcmtfbW9kZSc6IHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ25ldCcpLAogICAgICAgIH0KCiAgICAgICAgb3B0aW9uYWxzID0ge30KICAgICAgICBmb3Igb3B0aW9uYWxfcGFyYW0gaW4gKCdkZXZpY2VzJywgJ2RucycsICd2b2x1bWVzX2Zyb20nLAogICAgICAgICAgICAgICAgJ3Jlc3RhcnRfcG9saWN5JywgJ3Jlc3RhcnRfcG9saWN5X3JldHJ5JywgJ3BpZCcsICdleHRyYV9ob3N0cycsCiAgICAgICAgICAgICAgICAnbG9nX2RyaXZlcicsICdjYXBfYWRkJywgJ2NhcF9kcm9wJywgJ3JlYWRfb25seScsICdsb2dfb3B0Jyk6CiAgICAgICAgICAgIG9wdGlvbmFsc1tvcHRpb25hbF9wYXJhbV0gPSBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KG9wdGlvbmFsX3BhcmFtKQoKICAgICAgICBpZiBvcHRpb25hbHNbJ2RldmljZXMnXSBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5lbnN1cmVfY2FwYWJpbGl0eSgnZGV2aWNlcycpCiAgICAgICAgICAgIHBhcmFtc1snZGV2aWNlcyddID0gb3B0aW9uYWxzWydkZXZpY2VzJ10KCiAgICAgICAgaWYgb3B0aW9uYWxzWydkbnMnXSBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5lbnN1cmVfY2FwYWJpbGl0eSgnZG5zJykKICAgICAgICAgICAgcGFyYW1zWydkbnMnXSA9IG9wdGlvbmFsc1snZG5zJ10KCiAgICAgICAgaWYgb3B0aW9uYWxzWyd2b2x1bWVzX2Zyb20nXSBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5lbnN1cmVfY2FwYWJpbGl0eSgndm9sdW1lc19mcm9tJykKICAgICAgICAgICAgcGFyYW1zWyd2b2x1bWVzX2Zyb20nXSA9IG9wdGlvbmFsc1sndm9sdW1lc19mcm9tJ10KCiAgICAgICAgaWYgb3B0aW9uYWxzWydyZXN0YXJ0X3BvbGljeSddIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLmVuc3VyZV9jYXBhYmlsaXR5KCdyZXN0YXJ0X3BvbGljeScpCiAgICAgICAgICAgIHBhcmFtc1sncmVzdGFydF9wb2xpY3knXSA9IHsgJ05hbWUnOiBvcHRpb25hbHNbJ3Jlc3RhcnRfcG9saWN5J10gfQogICAgICAgICAgICBpZiBwYXJhbXNbJ3Jlc3RhcnRfcG9saWN5J11bJ05hbWUnXSA9PSAnb24tZmFpbHVyZSc6CiAgICAgICAgICAgICAgICBwYXJhbXNbJ3Jlc3RhcnRfcG9saWN5J11bJ01heGltdW1SZXRyeUNvdW50J10gPSBvcHRpb25hbHNbJ3Jlc3RhcnRfcG9saWN5X3JldHJ5J10KCiAgICAgICAgIyBkb2NrZXJfcHkgb25seSBhY2NlcHRzICdob3N0JyBvciBOb25lCiAgICAgICAgaWYgJ3BpZCcgaW4gb3B0aW9uYWxzIGFuZCBub3Qgb3B0aW9uYWxzWydwaWQnXToKICAgICAgICAgICAgb3B0aW9uYWxzWydwaWQnXSA9IE5vbmUKCiAgICAgICAgaWYgb3B0aW9uYWxzWydwaWQnXSBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5lbnN1cmVfY2FwYWJpbGl0eSgncGlkJykKICAgICAgICAgICAgcGFyYW1zWydwaWRfbW9kZSddID0gb3B0aW9uYWxzWydwaWQnXQoKICAgICAgICBpZiBvcHRpb25hbHNbJ2V4dHJhX2hvc3RzJ10gaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuZW5zdXJlX2NhcGFiaWxpdHkoJ2V4dHJhX2hvc3RzJykKICAgICAgICAgICAgcGFyYW1zWydleHRyYV9ob3N0cyddID0gb3B0aW9uYWxzWydleHRyYV9ob3N0cyddCgogICAgICAgIGlmIG9wdGlvbmFsc1snbG9nX2RyaXZlciddIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLmVuc3VyZV9jYXBhYmlsaXR5KCdsb2dfZHJpdmVyJykKICAgICAgICAgICAgbG9nX2NvbmZpZyA9IGRvY2tlci51dGlscy5Mb2dDb25maWcodHlwZT1kb2NrZXIudXRpbHMuTG9nQ29uZmlnLnR5cGVzLkpTT04pCiAgICAgICAgICAgIGlmIG9wdGlvbmFsc1snbG9nX29wdCddIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgZm9yIGssIHYgaW4gb3B0aW9uYWxzWydsb2dfb3B0J10uaXRlbXMoKToKICAgICAgICAgICAgICAgICAgICBsb2dfY29uZmlnLnNldF9jb25maWdfdmFsdWUoaywgdikKICAgICAgICAgICAgbG9nX2NvbmZpZy50eXBlID0gb3B0aW9uYWxzWydsb2dfZHJpdmVyJ10KICAgICAgICAgICAgcGFyYW1zWydsb2dfY29uZmlnJ10gPSBsb2dfY29uZmlnCgogICAgICAgIGlmIG9wdGlvbmFsc1snY2FwX2FkZCddIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLmVuc3VyZV9jYXBhYmlsaXR5KCdjYXBfYWRkJykKICAgICAgICAgICAgcGFyYW1zWydjYXBfYWRkJ10gPSBvcHRpb25hbHNbJ2NhcF9hZGQnXQoKICAgICAgICBpZiBvcHRpb25hbHNbJ2NhcF9kcm9wJ10gaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuZW5zdXJlX2NhcGFiaWxpdHkoJ2NhcF9kcm9wJykKICAgICAgICAgICAgcGFyYW1zWydjYXBfZHJvcCddID0gb3B0aW9uYWxzWydjYXBfZHJvcCddCgogICAgICAgIGlmIG9wdGlvbmFsc1sncmVhZF9vbmx5J10gaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuZW5zdXJlX2NhcGFiaWxpdHkoJ3JlYWRfb25seScpCiAgICAgICAgICAgIHBhcmFtc1sncmVhZF9vbmx5J10gPSBvcHRpb25hbHNbJ3JlYWRfb25seSddCgogICAgICAgIHJldHVybiBwYXJhbXMKCiAgICBkZWYgY3JlYXRlX2hvc3RfY29uZmlnKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIENyZWF0ZSBIb3N0Q29uZmlnIG9iamVjdAogICAgICAgICIiIgogICAgICAgIHBhcmFtcyA9IHNlbGYuZ2V0X3N0YXJ0X3BhcmFtcygpCiAgICAgICAgcmV0dXJuIGRvY2tlci51dGlscy5jcmVhdGVfaG9zdF9jb25maWcoKipwYXJhbXMpCgogICAgZGVmIGdldF9wb3J0X2JpbmRpbmdzKHNlbGYsIHBvcnRzKToKICAgICAgICAiIiIKICAgICAgICBQYXJzZSB0aGUgYHBvcnRzYCBzdHJpbmcgaW50byBhIHBvcnQgYmluZGluZ3MgZGljdCBmb3IgdGhlIGBzdGFydF9jb250YWluZXJgIGNhbGwuCiAgICAgICAgIiIiCiAgICAgICAgYmluZHMgPSB7fQogICAgICAgIGZvciBwb3J0IGluIHBvcnRzOgogICAgICAgICAgICAjIHBvcnRzIGNvdWxkIHBvdGVudGlhbGx5IGJlIGFuIGFycmF5IGxpa2UgWzgwLCA0NDNdLCBzbyB3ZSBtYWtlIHN1cmUgdGhleSdyZSBzdHJpbmdzCiAgICAgICAgICAgICMgYmVmb3JlIHNwbGl0dGluZwogICAgICAgICAgICBwYXJ0cyA9IHN0cihwb3J0KS5zcGxpdCgnOicpCiAgICAgICAgICAgIGNvbnRhaW5lcl9wb3J0ID0gcGFydHNbLTFdCiAgICAgICAgICAgIGlmICcvJyBub3QgaW4gY29udGFpbmVyX3BvcnQ6CiAgICAgICAgICAgICAgICBjb250YWluZXJfcG9ydCA9IGludChwYXJ0c1stMV0pCgogICAgICAgICAgICBwX2xlbiA9IGxlbihwYXJ0cykKICAgICAgICAgICAgaWYgcF9sZW4gPT0gMToKICAgICAgICAgICAgICAgICMgQmluZCBgY29udGFpbmVyX3BvcnRgIG9mIHRoZSBjb250YWluZXIgdG8gYSBkeW5hbWljYWxseQogICAgICAgICAgICAgICAgIyBhbGxvY2F0ZWQgVENQIHBvcnQgb24gYWxsIGF2YWlsYWJsZSBpbnRlcmZhY2VzIG9mIHRoZSBob3N0CiAgICAgICAgICAgICAgICAjIG1hY2hpbmUuCiAgICAgICAgICAgICAgICBiaW5kID0gKCcwLjAuMC4wJywpCiAgICAgICAgICAgIGVsaWYgcF9sZW4gPT0gMjoKICAgICAgICAgICAgICAgICMgQmluZCBgY29udGFpbmVyX3BvcnRgIG9mIHRoZSBjb250YWluZXIgdG8gcG9ydCBgcGFydHNbMF1gIG9uCiAgICAgICAgICAgICAgICAjIGFsbCBhdmFpbGFibGUgaW50ZXJmYWNlcyBvZiB0aGUgaG9zdCBtYWNoaW5lLgogICAgICAgICAgICAgICAgYmluZCA9ICgnMC4wLjAuMCcsIGludChwYXJ0c1swXSkpCiAgICAgICAgICAgIGVsaWYgcF9sZW4gPT0gMzoKICAgICAgICAgICAgICAgICMgQmluZCBgY29udGFpbmVyX3BvcnRgIG9mIHRoZSBjb250YWluZXIgdG8gcG9ydCBgcGFydHNbMV1gIG9uCiAgICAgICAgICAgICAgICAjIElQIGBwYXJ0c1swXWAgb2YgdGhlIGhvc3QgbWFjaGluZS4gSWYgYHBhcnRzWzFdYCBlbXB0eSBiaW5kCiAgICAgICAgICAgICAgICAjIHRvIGEgZHluYW1pY2FsbHkgYWxsb2NhdGVkIHBvcnQgb2YgSVAgYHBhcnRzWzBdYC4KICAgICAgICAgICAgICAgIGJpbmQgPSAocGFydHNbMF0sIGludChwYXJ0c1sxXSkpIGlmIHBhcnRzWzFdIGVsc2UgKHBhcnRzWzBdLCkKCiAgICAgICAgICAgIGlmIGNvbnRhaW5lcl9wb3J0IGluIGJpbmRzOgogICAgICAgICAgICAgICAgb2xkX2JpbmQgPSBiaW5kc1tjb250YWluZXJfcG9ydF0KICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uob2xkX2JpbmQsIGxpc3QpOgogICAgICAgICAgICAgICAgICAgICMgYXBwZW5kIHRvIGxpc3QgaWYgaXQgYWxyZWFkeSBleGlzdHMKICAgICAgICAgICAgICAgICAgICBvbGRfYmluZC5hcHBlbmQoYmluZCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBvdGhlcndpc2UgY3JlYXRlIGxpc3QgdGhhdCBjb250YWlucyB0aGUgb2xkIGFuZCBuZXcgYmluZHMKICAgICAgICAgICAgICAgICAgICBiaW5kc1tjb250YWluZXJfcG9ydF0gPSBbYmluZHNbY29udGFpbmVyX3BvcnRdLCBiaW5kXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYmluZHNbY29udGFpbmVyX3BvcnRdID0gYmluZAoKICAgICAgICByZXR1cm4gYmluZHMKCiAgICBkZWYgZ2V0X3N1bW1hcnlfbWVzc2FnZShzZWxmKToKICAgICAgICAnJycKICAgICAgICBHZW5lcmF0ZSBhIG1lc3NhZ2UgdGhhdCBicmllZmx5IGRlc2NyaWJlcyB0aGUgYWN0aW9ucyB0YWtlbiBieSB0aGlzCiAgICAgICAgdGFzaywgaW4gRW5nbGlzaC4KICAgICAgICAnJycKCiAgICAgICAgcGFydHMgPSBbXQogICAgICAgIGZvciBrLCB2IGluIHNlbGYuY291bnRlcnMuaXRlbXMoKToKICAgICAgICAgICAgaWYgdiA9PSAwOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGlmIHYgPT0gMToKICAgICAgICAgICAgICAgIHBsdXJhbCA9ICIiCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwbHVyYWwgPSAicyIKICAgICAgICAgICAgcGFydHMuYXBwZW5kKCIlcyAlZCBjb250YWluZXIlcyIgJSAoaywgdiwgcGx1cmFsKSkKCiAgICAgICAgaWYgcGFydHM6CiAgICAgICAgICAgIHJldHVybiAiLCAiLmpvaW4ocGFydHMpICsgIi4iCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuICJObyBhY3Rpb24gdGFrZW4uIgoKICAgIGRlZiBnZXRfcmVsb2FkX3JlYXNvbl9tZXNzYWdlKHNlbGYpOgogICAgICAgICcnJwogICAgICAgIEdlbmVyYXRlIGEgbWVzc2FnZSBkZXNjcmliaW5nIHdoeSBhbnkgcmVsb2FkZWQgY29udGFpbmVycyB3ZXJlIHJlbG9hZGVkLgogICAgICAgICcnJwoKICAgICAgICBpZiBzZWxmLnJlbG9hZF9yZWFzb25zOgogICAgICAgICAgICByZXR1cm4gIiwgIi5qb2luKHNlbGYucmVsb2FkX3JlYXNvbnMpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgZ2V0X3N1bW1hcnlfY291bnRlcnNfbXNnKHNlbGYpOgogICAgICAgIG1zZyA9ICIiCiAgICAgICAgZm9yIGssIHYgaW4gc2VsZi5jb3VudGVycy5pdGVtcygpOgogICAgICAgICAgICBtc2cgPSBtc2cgKyAiJXMgJWQgIiAlIChrLCB2KQoKICAgICAgICByZXR1cm4gbXNnCgogICAgZGVmIGluY3JlbWVudF9jb3VudGVyKHNlbGYsIG5hbWUpOgogICAgICAgIHNlbGYuY291bnRlcnNbbmFtZV0gPSBzZWxmLmNvdW50ZXJzW25hbWVdICsgMQoKICAgIGRlZiBoYXNfY2hhbmdlZChzZWxmKToKICAgICAgICBmb3IgaywgdiBpbiBzZWxmLmNvdW50ZXJzLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIHYgPiAwOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdldF9pbnNwZWN0X2ltYWdlKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuY2xpZW50Lmluc3BlY3RfaW1hZ2Uoc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnaW1hZ2UnKSkKICAgICAgICBleGNlcHQgRG9ja2VyQVBJRXJyb3IgYXMgZToKICAgICAgICAgICAgaWYgZS5yZXNwb25zZS5zdGF0dXNfY29kZSA9PSA0MDQ6CiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgZQoKICAgIGRlZiBnZXRfaW1hZ2VfcmVwb190YWdzKHNlbGYpOgogICAgICAgIGltYWdlLCB0YWcgPSBnZXRfc3BsaXRfaW1hZ2VfdGFnKHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2ltYWdlJykpCiAgICAgICAgaWYgdGFnIGlzIE5vbmU6CiAgICAgICAgICAgIHRhZyA9ICdsYXRlc3QnCiAgICAgICAgcmVzb3VyY2UgPSAnJXM6JXMnICUgKGltYWdlLCB0YWcpCgogICAgICAgIGZvciBpbWFnZSBpbiBzZWxmLmNsaWVudC5pbWFnZXMobmFtZT1pbWFnZSk6CiAgICAgICAgICAgIGlmIHJlc291cmNlIGluIGltYWdlLmdldCgnUmVwb1RhZ3MnLCBbXSk6CiAgICAgICAgICAgICAgICByZXR1cm4gaW1hZ2VbJ1JlcG9UYWdzJ10KICAgICAgICByZXR1cm4gW10KCiAgICBkZWYgZ2V0X2luc3BlY3RfY29udGFpbmVycyhzZWxmLCBjb250YWluZXJzKToKICAgICAgICBpbnNwZWN0ID0gW10KICAgICAgICBmb3IgaSBpbiBjb250YWluZXJzOgogICAgICAgICAgICBkZXRhaWxzID0gc2VsZi5jbGllbnQuaW5zcGVjdF9jb250YWluZXIoaVsnSWQnXSkKICAgICAgICAgICAgZGV0YWlscyA9IF9kb2NrZXJfaWRfcXVpcmsoZGV0YWlscykKICAgICAgICAgICAgaW5zcGVjdC5hcHBlbmQoZGV0YWlscykKCiAgICAgICAgcmV0dXJuIGluc3BlY3QKCiAgICBkZWYgZ2V0X2RpZmZlcmluZ19jb250YWluZXJzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEluc3BlY3QgYWxsIG1hdGNoaW5nLCBydW5uaW5nIGNvbnRhaW5lcnMsIGFuZCByZXR1cm4gdGhvc2UgdGhhdCB3ZXJlCiAgICAgICAgc3RhcnRlZCB3aXRoIHBhcmFtZXRlcnMgdGhhdCBkaWZmZXIgZnJvbSB0aGUgb25lcyB0aGF0IGFyZSBwcm92aWRlZAogICAgICAgIGR1cmluZyB0aGlzIG1vZHVsZSBydW4uIEEgbGlzdCBjb250YWluaW5nIHRoZSBkaWZmZXJpbmcKICAgICAgICBjb250YWluZXJzIHdpbGwgYmUgcmV0dXJuZWQsIGFuZCBhIHNob3J0IHN0cmluZyBkZXNjcmliaW5nIHRoZSBzcGVjaWZpYwogICAgICAgIGRpZmZlcmVuY2UgZW5jb3VudGVyZWQgaW4gZWFjaCBjb250YWluZXIgd2lsbCBiZSBhcHBlbmRlZCB0bwogICAgICAgIHJlbG9hZF9yZWFzb25zLgoKICAgICAgICBUaGlzIGdlbmVyYXRlcyB0aGUgc2V0IG9mIGNvbnRhaW5lcnMgdGhhdCBuZWVkIHRvIGJlIHN0b3BwZWQgYW5kCiAgICAgICAgc3RhcnRlZCB3aXRoIG5ldyBwYXJhbWV0ZXJzIHdpdGggc3RhdGU9cmVsb2FkZWQuCiAgICAgICAgIiIiCgogICAgICAgIHJ1bm5pbmcgPSBzZWxmLmdldF9ydW5uaW5nX2NvbnRhaW5lcnMoKQogICAgICAgIGN1cnJlbnQgPSBzZWxmLmdldF9pbnNwZWN0X2NvbnRhaW5lcnMocnVubmluZykKICAgICAgICBkZWZhdWx0cyA9IHNlbGYuY2xpZW50LmluZm8oKQoKICAgICAgICAjR2V0IEFQSSB2ZXJzaW9uCiAgICAgICAgYXBpX3ZlcnNpb24gPSBzZWxmLmNsaWVudC52ZXJzaW9uKClbJ0FwaVZlcnNpb24nXQoKICAgICAgICBpbWFnZSA9IHNlbGYuZ2V0X2luc3BlY3RfaW1hZ2UoKQogICAgICAgIGlmIGltYWdlIGlzIE5vbmU6CiAgICAgICAgICAgICMgVGhlIGltYWdlIGlzbid0IHByZXNlbnQuIEFzc3VtZSB0aGF0IHdlJ3JlIGFib3V0IHRvIHB1bGwgYSBuZXcKICAgICAgICAgICAgIyB0YWcgYW5kICpldmVyeXRoaW5nKiB3aWxsIGJlIHJlc3RhcnRlZC4KICAgICAgICAgICAgIwogICAgICAgICAgICAjIFRoaXMgd2lsbCBnaXZlIGZhbHNlIHBvc2l0aXZlcyBpZiB5b3UgdW50YWcgYW4gaW1hZ2Ugb24gdGhlIGhvc3QKICAgICAgICAgICAgIyBhbmQgdGhlcmUncyBub3RoaW5nIG1vcmUgdG8gcHVsbC4KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQKCiAgICAgICAgZGlmZmVyaW5nID0gW10KCiAgICAgICAgZm9yIGNvbnRhaW5lciBpbiBjdXJyZW50OgoKICAgICAgICAgICAgIyBJTUFHRQogICAgICAgICAgICAjIENvbXBhcmUgdGhlIGltYWdlIGJ5IElEIHJhdGhlciB0aGFuIG5hbWUsIHNvIHRoYXQgY29udGFpbmVycwogICAgICAgICAgICAjIHdpbGwgYmUgcmVzdGFydGVkIHdoZW4gbmV3IHZlcnNpb25zIG9mIGFuIGV4aXN0aW5nIGltYWdlIGFyZQogICAgICAgICAgICAjIHB1bGxlZC4KICAgICAgICAgICAgaWYgY29udGFpbmVyWydJbWFnZSddICE9IGltYWdlWydJZCddOgogICAgICAgICAgICAgICAgc2VsZi5yZWxvYWRfcmVhc29ucy5hcHBlbmQoJ2ltYWdlICh7MH0gPT4gezF9KScuZm9ybWF0KGNvbnRhaW5lclsnSW1hZ2UnXSwgaW1hZ2VbJ0lkJ10pKQogICAgICAgICAgICAgICAgZGlmZmVyaW5nLmFwcGVuZChjb250YWluZXIpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBFTlRSWVBPSU5UCgogICAgICAgICAgICBleHBlY3RlZF9lbnRyeXBvaW50ID0gc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnZW50cnlwb2ludCcpCiAgICAgICAgICAgIGlmIGV4cGVjdGVkX2VudHJ5cG9pbnQ6CiAgICAgICAgICAgICAgICBleHBlY3RlZF9lbnRyeXBvaW50ID0gc2hsZXguc3BsaXQoZXhwZWN0ZWRfZW50cnlwb2ludCkKICAgICAgICAgICAgICAgIGFjdHVhbF9lbnRyeXBvaW50ID0gY29udGFpbmVyWyJDb25maWciXVsiRW50cnlwb2ludCJdCgogICAgICAgICAgICAgICAgaWYgYWN0dWFsX2VudHJ5cG9pbnQgIT0gZXhwZWN0ZWRfZW50cnlwb2ludDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbG9hZF9yZWFzb25zLmFwcGVuZCgKICAgICAgICAgICAgICAgICAgICAgICAgJ2VudHJ5cG9pbnQgKHswfSA9PiB7MX0pJwogICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KGFjdHVhbF9lbnRyeXBvaW50LCBleHBlY3RlZF9lbnRyeXBvaW50KQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBkaWZmZXJpbmcuYXBwZW5kKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBDT01NQU5ECgogICAgICAgICAgICBleHBlY3RlZF9jb21tYW5kID0gc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnY29tbWFuZCcpCiAgICAgICAgICAgIGlmIGV4cGVjdGVkX2NvbW1hbmQ6CiAgICAgICAgICAgICAgICBleHBlY3RlZF9jb21tYW5kID0gc2hsZXguc3BsaXQoZXhwZWN0ZWRfY29tbWFuZCkKICAgICAgICAgICAgICAgIGFjdHVhbF9jb21tYW5kID0gY29udGFpbmVyWyJDb25maWciXVsiQ21kIl0KCiAgICAgICAgICAgICAgICBpZiBhY3R1YWxfY29tbWFuZCAhPSBleHBlY3RlZF9jb21tYW5kOgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVsb2FkX3JlYXNvbnMuYXBwZW5kKCdjb21tYW5kICh7MH0gPT4gezF9KScuZm9ybWF0KGFjdHVhbF9jb21tYW5kLCBleHBlY3RlZF9jb21tYW5kKSkKICAgICAgICAgICAgICAgICAgICBkaWZmZXJpbmcuYXBwZW5kKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBFWFBPU0VEIFBPUlRTCiAgICAgICAgICAgIGV4cGVjdGVkX2V4cG9zZWRfcG9ydHMgPSBzZXQoKGltYWdlWydDb250YWluZXJDb25maWcnXS5nZXQoJ0V4cG9zZWRQb3J0cycpIG9yIHt9KS5rZXlzKCkpCiAgICAgICAgICAgIGZvciBwIGluIChzZWxmLmV4cG9zZWRfcG9ydHMgb3IgW10pOgogICAgICAgICAgICAgICAgZXhwZWN0ZWRfZXhwb3NlZF9wb3J0cy5hZGQoIi8iLmpvaW4ocCkpCgogICAgICAgICAgICBhY3R1YWxseV9leHBvc2VkX3BvcnRzID0gc2V0KChjb250YWluZXJbIkNvbmZpZyJdLmdldCgiRXhwb3NlZFBvcnRzIikgb3Ige30pLmtleXMoKSkKCiAgICAgICAgICAgIGlmIGFjdHVhbGx5X2V4cG9zZWRfcG9ydHMgIT0gZXhwZWN0ZWRfZXhwb3NlZF9wb3J0czoKICAgICAgICAgICAgICAgIHNlbGYucmVsb2FkX3JlYXNvbnMuYXBwZW5kKCdleHBvc2VkX3BvcnRzICh7MH0gPT4gezF9KScuZm9ybWF0KGFjdHVhbGx5X2V4cG9zZWRfcG9ydHMsIGV4cGVjdGVkX2V4cG9zZWRfcG9ydHMpKQogICAgICAgICAgICAgICAgZGlmZmVyaW5nLmFwcGVuZChjb250YWluZXIpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBWT0xVTUVTCgogICAgICAgICAgICBleHBlY3RlZF92b2x1bWVfa2V5cyA9IHNldCgoaW1hZ2VbJ0NvbnRhaW5lckNvbmZpZyddWydWb2x1bWVzJ10gb3Ige30pLmtleXMoKSkKICAgICAgICAgICAgaWYgc2VsZi52b2x1bWVzOgogICAgICAgICAgICAgICAgZXhwZWN0ZWRfdm9sdW1lX2tleXMudXBkYXRlKHNlbGYudm9sdW1lcykKCiAgICAgICAgICAgIGFjdHVhbF92b2x1bWVfa2V5cyA9IHNldCgoY29udGFpbmVyWydDb25maWcnXVsnVm9sdW1lcyddIG9yIHt9KS5rZXlzKCkpCgogICAgICAgICAgICBpZiBhY3R1YWxfdm9sdW1lX2tleXMgIT0gZXhwZWN0ZWRfdm9sdW1lX2tleXM6CiAgICAgICAgICAgICAgICBzZWxmLnJlbG9hZF9yZWFzb25zLmFwcGVuZCgndm9sdW1lcyAoezB9ID0+IHsxfSknLmZvcm1hdChhY3R1YWxfdm9sdW1lX2tleXMsIGV4cGVjdGVkX3ZvbHVtZV9rZXlzKSkKICAgICAgICAgICAgICAgIGRpZmZlcmluZy5hcHBlbmQoY29udGFpbmVyKQogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgVUxJTUlUUwoKICAgICAgICAgICAgZXhwZWN0ZWRfdWxpbWl0X2tleXMgPSBzZXQobWFwKGxhbWJkYSB4OiAnJXM6JXM6JXMnICUgKHhbJ25hbWUnXSx4Wydzb2Z0J10seFsnaGFyZCddKSwgc2VsZi51bGltaXRzIG9yIFtdKSkKICAgICAgICAgICAgYWN0dWFsX3VsaW1pdF9rZXlzID0gc2V0KG1hcChsYW1iZGEgeDogJyVzOiVzOiVzJyAlICh4WydOYW1lJ10seFsnU29mdCddLHhbJ0hhcmQnXSksIChjb250YWluZXJbJ0hvc3RDb25maWcnXVsnVWxpbWl0cyddIG9yIFtdKSkpCgogICAgICAgICAgICBpZiBhY3R1YWxfdWxpbWl0X2tleXMgIT0gZXhwZWN0ZWRfdWxpbWl0X2tleXM6CiAgICAgICAgICAgICAgICBzZWxmLnJlbG9hZF9yZWFzb25zLmFwcGVuZCgndWxpbWl0cyAoezB9ID0+IHsxfSknLmZvcm1hdChhY3R1YWxfdWxpbWl0X2tleXMsIGV4cGVjdGVkX3VsaW1pdF9rZXlzKSkKICAgICAgICAgICAgICAgIGRpZmZlcmluZy5hcHBlbmQoY29udGFpbmVyKQogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgQ1BVX1NIQVJFUwoKICAgICAgICAgICAgZXhwZWN0ZWRfY3B1X3NoYXJlcyA9IHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2NwdV9zaGFyZXMnKQogICAgICAgICAgICBhY3R1YWxfY3B1X3NoYXJlcyA9IGNvbnRhaW5lclsnSG9zdENvbmZpZyddWydDcHVTaGFyZXMnXQoKICAgICAgICAgICAgaWYgZXhwZWN0ZWRfY3B1X3NoYXJlcyBhbmQgYWN0dWFsX2NwdV9zaGFyZXMgIT0gZXhwZWN0ZWRfY3B1X3NoYXJlczoKICAgICAgICAgICAgICAgIHNlbGYucmVsb2FkX3JlYXNvbnMuYXBwZW5kKCdjcHVfc2hhcmVzICh7MH0gPT4gezF9KScuZm9ybWF0KGFjdHVhbF9jcHVfc2hhcmVzLCBleHBlY3RlZF9jcHVfc2hhcmVzKSkKICAgICAgICAgICAgICAgIGRpZmZlcmluZy5hcHBlbmQoY29udGFpbmVyKQogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgTUVNX0xJTUlUCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBleHBlY3RlZF9tZW0gPSBfaHVtYW5fdG9fYnl0ZXMoc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnbWVtb3J5X2xpbWl0JykpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yIGFzIGU6CiAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPXN0cihlKSkKCiAgICAgICAgICAgICNGb3IgdjEuMTkgQVBJIGFuZCBhYm92ZSB1c2UgSG9zdENvbmZpZywgb3RoZXJ3aXNlIHVzZSBDb25maWcKICAgICAgICAgICAgaWYgZG9ja2VyLnV0aWxzLmNvbXBhcmVfdmVyc2lvbignMS4xOScsIGFwaV92ZXJzaW9uKSA+PSAwOgogICAgICAgICAgICAgICAgYWN0dWFsX21lbSA9IGNvbnRhaW5lclsnSG9zdENvbmZpZyddWydNZW1vcnknXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYWN0dWFsX21lbSA9IGNvbnRhaW5lclsnQ29uZmlnJ11bJ01lbW9yeSddCgogICAgICAgICAgICBpZiBleHBlY3RlZF9tZW0gYW5kIGFjdHVhbF9tZW0gIT0gZXhwZWN0ZWRfbWVtOgogICAgICAgICAgICAgICAgc2VsZi5yZWxvYWRfcmVhc29ucy5hcHBlbmQoJ21lbW9yeSAoezB9ID0+IHsxfSknLmZvcm1hdChhY3R1YWxfbWVtLCBleHBlY3RlZF9tZW0pKQogICAgICAgICAgICAgICAgZGlmZmVyaW5nLmFwcGVuZChjb250YWluZXIpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBFTlZJUk9OTUVOVAogICAgICAgICAgICAjIGFjdHVhbF9lbnYgaXMgbGlrZWx5IHRvIGluY2x1ZGUgZW52aXJvbm1lbnQgdmFyaWFibGVzIGluamVjdGVkIGJ5CiAgICAgICAgICAgICMgdGhlIERvY2tlcmZpbGUuCgogICAgICAgICAgICBleHBlY3RlZF9lbnYgPSB7fQoKICAgICAgICAgICAgZm9yIGltYWdlX2VudiBpbiBpbWFnZVsnQ29udGFpbmVyQ29uZmlnJ11bJ0VudiddIG9yIFtdOgogICAgICAgICAgICAgICAgbmFtZSwgdmFsdWUgPSBpbWFnZV9lbnYuc3BsaXQoJz0nLCAxKQogICAgICAgICAgICAgICAgZXhwZWN0ZWRfZW52W25hbWVdID0gdmFsdWUKCiAgICAgICAgICAgIGlmIHNlbGYuZW52aXJvbm1lbnQ6CiAgICAgICAgICAgICAgICBmb3IgbmFtZSwgdmFsdWUgaW4gc2VsZi5lbnZpcm9ubWVudC5pdGVtcygpOgogICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkX2VudltuYW1lXSA9IHN0cih2YWx1ZSkKCiAgICAgICAgICAgIGFjdHVhbF9lbnYgPSB7fQogICAgICAgICAgICBmb3IgY29udGFpbmVyX2VudiBpbiBjb250YWluZXJbJ0NvbmZpZyddWydFbnYnXSBvciBbXToKICAgICAgICAgICAgICAgIG5hbWUsIHZhbHVlID0gY29udGFpbmVyX2Vudi5zcGxpdCgnPScsIDEpCiAgICAgICAgICAgICAgICBhY3R1YWxfZW52W25hbWVdID0gdmFsdWUKCiAgICAgICAgICAgIGlmIGFjdHVhbF9lbnYgIT0gZXhwZWN0ZWRfZW52OgogICAgICAgICAgICAgICAgIyBEb24ndCBpbmNsdWRlIHRoZSBlbnZpcm9ubWVudCBkaWZmZXJlbmNlIGluIHRoZSBvdXRwdXQuCiAgICAgICAgICAgICAgICBzZWxmLnJlbG9hZF9yZWFzb25zLmFwcGVuZCgnZW52aXJvbm1lbnQgezB9ID0+IHsxfScuZm9ybWF0KGFjdHVhbF9lbnYsIGV4cGVjdGVkX2VudikpCiAgICAgICAgICAgICAgICBkaWZmZXJpbmcuYXBwZW5kKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIExBQkVMUwoKICAgICAgICAgICAgZXhwZWN0ZWRfbGFiZWxzID0ge30KICAgICAgICAgICAgZm9yIG5hbWUsIHZhbHVlIGluIHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2xhYmVscycpLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBleHBlY3RlZF9sYWJlbHNbbmFtZV0gPSBzdHIodmFsdWUpCgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGNvbnRhaW5lclsnQ29uZmlnJ11bJ0xhYmVscyddLCBkaWN0KToKICAgICAgICAgICAgICAgIGFjdHVhbF9sYWJlbHMgPSBjb250YWluZXJbJ0NvbmZpZyddWydMYWJlbHMnXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZm9yIGNvbnRhaW5lcl9sYWJlbCBpbiBjb250YWluZXJbJ0NvbmZpZyddWydMYWJlbHMnXSBvciBbXToKICAgICAgICAgICAgICAgICAgICBuYW1lLCB2YWx1ZSA9IGNvbnRhaW5lcl9sYWJlbC5zcGxpdCgnPScsIDEpCiAgICAgICAgICAgICAgICAgICAgYWN0dWFsX2xhYmVsc1tuYW1lXSA9IHZhbHVlCgogICAgICAgICAgICBpZiBhY3R1YWxfbGFiZWxzICE9IGV4cGVjdGVkX2xhYmVsczoKICAgICAgICAgICAgICAgIHNlbGYucmVsb2FkX3JlYXNvbnMuYXBwZW5kKCdsYWJlbHMgezB9ID0+IHsxfScuZm9ybWF0KGFjdHVhbF9sYWJlbHMsIGV4cGVjdGVkX2xhYmVscykpCiAgICAgICAgICAgICAgICBkaWZmZXJpbmcuYXBwZW5kKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIEhPU1ROQU1FCgogICAgICAgICAgICBleHBlY3RlZF9ob3N0bmFtZSA9IHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2hvc3RuYW1lJykKICAgICAgICAgICAgYWN0dWFsX2hvc3RuYW1lID0gY29udGFpbmVyWydDb25maWcnXVsnSG9zdG5hbWUnXQogICAgICAgICAgICBpZiBleHBlY3RlZF9ob3N0bmFtZSBhbmQgYWN0dWFsX2hvc3RuYW1lICE9IGV4cGVjdGVkX2hvc3RuYW1lOgogICAgICAgICAgICAgICAgc2VsZi5yZWxvYWRfcmVhc29ucy5hcHBlbmQoJ2hvc3RuYW1lICh7MH0gPT4gezF9KScuZm9ybWF0KGFjdHVhbF9ob3N0bmFtZSwgZXhwZWN0ZWRfaG9zdG5hbWUpKQogICAgICAgICAgICAgICAgZGlmZmVyaW5nLmFwcGVuZChjb250YWluZXIpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBET01BSU5OQU1FCgogICAgICAgICAgICBleHBlY3RlZF9kb21haW5uYW1lID0gc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnZG9tYWlubmFtZScpCiAgICAgICAgICAgIGFjdHVhbF9kb21haW5uYW1lID0gY29udGFpbmVyWydDb25maWcnXVsnRG9tYWlubmFtZSddCiAgICAgICAgICAgIGlmIGV4cGVjdGVkX2RvbWFpbm5hbWUgYW5kIGFjdHVhbF9kb21haW5uYW1lICE9IGV4cGVjdGVkX2RvbWFpbm5hbWU6CiAgICAgICAgICAgICAgICBzZWxmLnJlbG9hZF9yZWFzb25zLmFwcGVuZCgnZG9tYWlubmFtZSAoezB9ID0+IHsxfSknLmZvcm1hdChhY3R1YWxfZG9tYWlubmFtZSwgZXhwZWN0ZWRfZG9tYWlubmFtZSkpCiAgICAgICAgICAgICAgICBkaWZmZXJpbmcuYXBwZW5kKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIERFVEFDSAoKICAgICAgICAgICAgIyBXZSBkb24ndCBoYXZlIHRvIGNoZWNrIGZvciB1bmRldGFjaGVkIGNvbnRhaW5lcnMuIElmIGl0IHdhc24ndAogICAgICAgICAgICAjIGRldGFjaGVkLCBpdCB3b3VsZCBoYXZlIHN0b3BwZWQgYmVmb3JlIHRoZSBwbGF5Ym9vayBjb250aW51ZWQhCgogICAgICAgICAgICAjIE5BTUUKCiAgICAgICAgICAgICMgV2UgYWxzbyBkb24ndCBoYXZlIHRvIGNoZWNrIG5hbWUsIGJlY2F1c2UgdGhpcyBpcyBvbmUgb2YgdGhlCiAgICAgICAgICAgICMgY3JpdGVyaWEgdGhhdCdzIHVzZWQgdG8gZGV0ZXJtaW5lIHdoaWNoIGNvbnRhaW5lcihzKSBtYXRjaCBpbgogICAgICAgICAgICAjIHRoZSBmaXJzdCBwbGFjZS4KCiAgICAgICAgICAgICMgU1RESU5fT1BFTgoKICAgICAgICAgICAgZXhwZWN0ZWRfc3RkaW5fb3BlbiA9IHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ3N0ZGluX29wZW4nKQogICAgICAgICAgICBhY3R1YWxfc3RkaW5fb3BlbiA9IGNvbnRhaW5lclsnQ29uZmlnJ11bJ09wZW5TdGRpbiddCiAgICAgICAgICAgIGlmIGFjdHVhbF9zdGRpbl9vcGVuICE9IGV4cGVjdGVkX3N0ZGluX29wZW46CiAgICAgICAgICAgICAgICBzZWxmLnJlbG9hZF9yZWFzb25zLmFwcGVuZCgnc3RkaW5fb3BlbiAoezB9ID0+IHsxfSknLmZvcm1hdChhY3R1YWxfc3RkaW5fb3BlbiwgZXhwZWN0ZWRfc3RkaW5fb3BlbikpCiAgICAgICAgICAgICAgICBkaWZmZXJpbmcuYXBwZW5kKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIFRUWQoKICAgICAgICAgICAgZXhwZWN0ZWRfdHR5ID0gc2VsZi5tb2R1bGUucGFyYW1zLmdldCgndHR5JykKICAgICAgICAgICAgYWN0dWFsX3R0eSA9IGNvbnRhaW5lclsnQ29uZmlnJ11bJ1R0eSddCiAgICAgICAgICAgIGlmIGFjdHVhbF90dHkgIT0gZXhwZWN0ZWRfdHR5OgogICAgICAgICAgICAgICAgc2VsZi5yZWxvYWRfcmVhc29ucy5hcHBlbmQoJ3R0eSAoezB9ID0+IHsxfSknLmZvcm1hdChhY3R1YWxfdHR5LCBleHBlY3RlZF90dHkpKQogICAgICAgICAgICAgICAgZGlmZmVyaW5nLmFwcGVuZChjb250YWluZXIpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyAtLSAic3RhcnQiIGNhbGwgZGlmZmVyZW5jZXMgLS0KCiAgICAgICAgICAgICMgTFhDX0NPTkYKCiAgICAgICAgICAgIGlmIHNlbGYubHhjX2NvbmY6CiAgICAgICAgICAgICAgICBleHBlY3RlZF9seGMgPSBzZXQoc2VsZi5seGNfY29uZikKICAgICAgICAgICAgICAgIGFjdHVhbF9seGMgPSBzZXQoY29udGFpbmVyWydIb3N0Q29uZmlnJ11bJ0x4Y0NvbmYnXSBvciBbXSkKICAgICAgICAgICAgICAgIGlmIGFjdHVhbF9seGMgIT0gZXhwZWN0ZWRfbHhjOgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVsb2FkX3JlYXNvbnMuYXBwZW5kKCdseGNfY29uZiAoezB9ID0+IHsxfSknLmZvcm1hdChhY3R1YWxfbHhjLCBleHBlY3RlZF9seGMpKQogICAgICAgICAgICAgICAgICAgIGRpZmZlcmluZy5hcHBlbmQoY29udGFpbmVyKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIEJJTkRTCgogICAgICAgICAgICBleHBlY3RlZF9iaW5kcyA9IHNldCgpCiAgICAgICAgICAgIGlmIHNlbGYuYmluZHM6CiAgICAgICAgICAgICAgICBmb3IgYmluZCBpbiBzZWxmLmJpbmRzOgogICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkX2JpbmRzLmFkZChiaW5kKQoKICAgICAgICAgICAgYWN0dWFsX2JpbmRzID0gc2V0KCkKICAgICAgICAgICAgZm9yIGJpbmQgaW4gKGNvbnRhaW5lclsnSG9zdENvbmZpZyddWydCaW5kcyddIG9yIFtdKToKICAgICAgICAgICAgICAgIGlmIGxlbihiaW5kLnNwbGl0KCc6JykpID09IDI6CiAgICAgICAgICAgICAgICAgICAgYWN0dWFsX2JpbmRzLmFkZChiaW5kICsgIjpydyIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGFjdHVhbF9iaW5kcy5hZGQoYmluZCkKCiAgICAgICAgICAgIGlmIGFjdHVhbF9iaW5kcyAhPSBleHBlY3RlZF9iaW5kczoKICAgICAgICAgICAgICAgIHNlbGYucmVsb2FkX3JlYXNvbnMuYXBwZW5kKCdiaW5kcyAoezB9ID0+IHsxfSknLmZvcm1hdChhY3R1YWxfYmluZHMsIGV4cGVjdGVkX2JpbmRzKSkKICAgICAgICAgICAgICAgIGRpZmZlcmluZy5hcHBlbmQoY29udGFpbmVyKQogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgUE9SVCBCSU5ESU5HUwoKICAgICAgICAgICAgZXhwZWN0ZWRfYm91bmRfcG9ydHMgPSB7fQogICAgICAgICAgICBpZiBzZWxmLnBvcnRfYmluZGluZ3M6CiAgICAgICAgICAgICAgICBmb3IgY29udGFpbmVyX3BvcnQsIGNvbmZpZyBpbiBzZWxmLnBvcnRfYmluZGluZ3MuaXRlbXMoKToKICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGNvbnRhaW5lcl9wb3J0LCBpbnQpOgogICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJfcG9ydCA9ICJ7MH0vdGNwIi5mb3JtYXQoY29udGFpbmVyX3BvcnQpCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKGNvbmZpZykgPT0gMToKICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRfYm91bmRfcG9ydHNbY29udGFpbmVyX3BvcnRdID0gW3snSG9zdElwJzogIjAuMC4wLjAiLCAnSG9zdFBvcnQnOiAiIn1dCiAgICAgICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGNvbmZpZ1swXSwgdHVwbGUpOgogICAgICAgICAgICAgICAgICAgICAgICBleHBlY3RlZF9ib3VuZF9wb3J0c1tjb250YWluZXJfcG9ydF0gPSBbXQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgaG9zdGlwLCBob3N0cG9ydCBpbiBjb25maWc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBlY3RlZF9ib3VuZF9wb3J0c1tjb250YWluZXJfcG9ydF0uYXBwZW5kKHsgJ0hvc3RJcCc6IGhvc3RpcCwgJ0hvc3RQb3J0Jzogc3RyKGhvc3Rwb3J0KX0pCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRfYm91bmRfcG9ydHNbY29udGFpbmVyX3BvcnRdID0gW3snSG9zdElwJzogY29uZmlnWzBdLCAnSG9zdFBvcnQnOiBzdHIoY29uZmlnWzFdKX1dCgogICAgICAgICAgICBhY3R1YWxfYm91bmRfcG9ydHMgPSBjb250YWluZXJbJ0hvc3RDb25maWcnXVsnUG9ydEJpbmRpbmdzJ10gb3Ige30KCiAgICAgICAgICAgIGlmIGFjdHVhbF9ib3VuZF9wb3J0cyAhPSBleHBlY3RlZF9ib3VuZF9wb3J0czoKICAgICAgICAgICAgICAgIHNlbGYucmVsb2FkX3JlYXNvbnMuYXBwZW5kKCdwb3J0IGJpbmRpbmdzICh7MH0gPT4gezF9KScuZm9ybWF0KGFjdHVhbF9ib3VuZF9wb3J0cywgZXhwZWN0ZWRfYm91bmRfcG9ydHMpKQogICAgICAgICAgICAgICAgZGlmZmVyaW5nLmFwcGVuZChjb250YWluZXIpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBQVUJMSVNISU5HIEFMTCBQT1JUUwoKICAgICAgICAgICAgIyBXaGF0IHdlIHJlYWxseSBjYXJlIGFib3V0IGlzIHRoZSBzZXQgb2YgcG9ydHMgdGhhdCBpcyBhY3R1YWxseQogICAgICAgICAgICAjIHB1Ymxpc2hlZC4gVGhhdCBzaG91bGQgYmUgY2F1Z2h0IGFib3ZlLgoKICAgICAgICAgICAgIyBQUklWSUxFR0VECgogICAgICAgICAgICBleHBlY3RlZF9wcml2aWxlZ2VkID0gc2VsZi5tb2R1bGUucGFyYW1zLmdldCgncHJpdmlsZWdlZCcpCiAgICAgICAgICAgIGFjdHVhbF9wcml2aWxlZ2VkID0gY29udGFpbmVyWydIb3N0Q29uZmlnJ11bJ1ByaXZpbGVnZWQnXQogICAgICAgICAgICBpZiBhY3R1YWxfcHJpdmlsZWdlZCAhPSBleHBlY3RlZF9wcml2aWxlZ2VkOgogICAgICAgICAgICAgICAgc2VsZi5yZWxvYWRfcmVhc29ucy5hcHBlbmQoJ3ByaXZpbGVnZWQgKHswfSA9PiB7MX0pJy5mb3JtYXQoYWN0dWFsX3ByaXZpbGVnZWQsIGV4cGVjdGVkX3ByaXZpbGVnZWQpKQogICAgICAgICAgICAgICAgZGlmZmVyaW5nLmFwcGVuZChjb250YWluZXIpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBMSU5LUwoKICAgICAgICAgICAgZXhwZWN0ZWRfbGlua3MgPSBzZXQoKQogICAgICAgICAgICBmb3IgbGluaywgYWxpYXMgaW4gKHNlbGYubGlua3Mgb3Ige30pLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBleHBlY3RlZF9saW5rcy5hZGQoIi97MH06ezF9L3syfSIuZm9ybWF0KGxpbmssIGNvbnRhaW5lclsiTmFtZSJdLCBhbGlhcykpCgogICAgICAgICAgICBhY3R1YWxfbGlua3MgPSBzZXQoKQogICAgICAgICAgICBmb3IgbGluayBpbiAoY29udGFpbmVyWydIb3N0Q29uZmlnJ11bJ0xpbmtzJ10gb3IgW10pOgogICAgICAgICAgICAgICAgYWN0dWFsX2xpbmtzLmFkZChsaW5rKQoKICAgICAgICAgICAgaWYgYWN0dWFsX2xpbmtzICE9IGV4cGVjdGVkX2xpbmtzOgogICAgICAgICAgICAgICAgc2VsZi5yZWxvYWRfcmVhc29ucy5hcHBlbmQoJ2xpbmtzICh7MH0gPT4gezF9KScuZm9ybWF0KGFjdHVhbF9saW5rcywgZXhwZWN0ZWRfbGlua3MpKQogICAgICAgICAgICAgICAgZGlmZmVyaW5nLmFwcGVuZChjb250YWluZXIpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBORVRXT1JLIE1PREUKCiAgICAgICAgICAgIGV4cGVjdGVkX25ldG1vZGUgPSBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCduZXQnKSBvciAnYnJpZGdlJwogICAgICAgICAgICBhY3R1YWxfbmV0bW9kZSA9IGNvbnRhaW5lclsnSG9zdENvbmZpZyddWydOZXR3b3JrTW9kZSddIG9yICdicmlkZ2UnCiAgICAgICAgICAgIGlmIGFjdHVhbF9uZXRtb2RlICE9IGV4cGVjdGVkX25ldG1vZGU6CiAgICAgICAgICAgICAgICBzZWxmLnJlbG9hZF9yZWFzb25zLmFwcGVuZCgnbmV0ICh7MH0gPT4gezF9KScuZm9ybWF0KGFjdHVhbF9uZXRtb2RlLCBleHBlY3RlZF9uZXRtb2RlKSkKICAgICAgICAgICAgICAgIGRpZmZlcmluZy5hcHBlbmQoY29udGFpbmVyKQogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgREVWSUNFUwoKICAgICAgICAgICAgZXhwZWN0ZWRfZGV2aWNlcyA9IHNldCgpCiAgICAgICAgICAgIGZvciBkZXZpY2UgaW4gKHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2RldmljZXMnKSBvciBbXSk6CiAgICAgICAgICAgICAgICBpZiBsZW4oZGV2aWNlLnNwbGl0KCc6JykpID09IDI6CiAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRfZGV2aWNlcy5hZGQoZGV2aWNlICsgIjpyd20iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBleHBlY3RlZF9kZXZpY2VzLmFkZChkZXZpY2UpCgogICAgICAgICAgICBhY3R1YWxfZGV2aWNlcyA9IHNldCgpCiAgICAgICAgICAgIGZvciBkZXZpY2UgaW4gKGNvbnRhaW5lclsnSG9zdENvbmZpZyddWydEZXZpY2VzJ10gb3IgW10pOgogICAgICAgICAgICAgICAgYWN0dWFsX2RldmljZXMuYWRkKCJ7UGF0aE9uSG9zdH06e1BhdGhJbkNvbnRhaW5lcn06e0Nncm91cFBlcm1pc3Npb25zfSIuZm9ybWF0KCoqZGV2aWNlKSkKCiAgICAgICAgICAgIGlmIGFjdHVhbF9kZXZpY2VzICE9IGV4cGVjdGVkX2RldmljZXM6CiAgICAgICAgICAgICAgICBzZWxmLnJlbG9hZF9yZWFzb25zLmFwcGVuZCgnZGV2aWNlcyAoezB9ID0+IHsxfSknLmZvcm1hdChhY3R1YWxfZGV2aWNlcywgZXhwZWN0ZWRfZGV2aWNlcykpCiAgICAgICAgICAgICAgICBkaWZmZXJpbmcuYXBwZW5kKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIEROUwoKICAgICAgICAgICAgZXhwZWN0ZWRfZG5zID0gc2V0KHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2RucycpIG9yIFtdKQogICAgICAgICAgICBhY3R1YWxfZG5zID0gc2V0KGNvbnRhaW5lclsnSG9zdENvbmZpZyddWydEbnMnXSBvciBbXSkKICAgICAgICAgICAgaWYgYWN0dWFsX2RucyAhPSBleHBlY3RlZF9kbnM6CiAgICAgICAgICAgICAgICBzZWxmLnJlbG9hZF9yZWFzb25zLmFwcGVuZCgnZG5zICh7MH0gPT4gezF9KScuZm9ybWF0KGFjdHVhbF9kbnMsIGV4cGVjdGVkX2RucykpCiAgICAgICAgICAgICAgICBkaWZmZXJpbmcuYXBwZW5kKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIFZPTFVNRVNfRlJPTQoKICAgICAgICAgICAgZXhwZWN0ZWRfdm9sdW1lc19mcm9tID0gc2V0KHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ3ZvbHVtZXNfZnJvbScpIG9yIFtdKQogICAgICAgICAgICBhY3R1YWxfdm9sdW1lc19mcm9tID0gc2V0KGNvbnRhaW5lclsnSG9zdENvbmZpZyddWydWb2x1bWVzRnJvbSddIG9yIFtdKQogICAgICAgICAgICBpZiBhY3R1YWxfdm9sdW1lc19mcm9tICE9IGV4cGVjdGVkX3ZvbHVtZXNfZnJvbToKICAgICAgICAgICAgICAgIHNlbGYucmVsb2FkX3JlYXNvbnMuYXBwZW5kKCd2b2x1bWVzX2Zyb20gKHswfSA9PiB7MX0pJy5mb3JtYXQoYWN0dWFsX3ZvbHVtZXNfZnJvbSwgZXhwZWN0ZWRfdm9sdW1lc19mcm9tKSkKICAgICAgICAgICAgICAgIGRpZmZlcmluZy5hcHBlbmQoY29udGFpbmVyKQoKICAgICAgICAgICAgIyBMT0dfRFJJVkVSCgogICAgICAgICAgICBpZiBzZWxmLmVuc3VyZV9jYXBhYmlsaXR5KCdsb2dfZHJpdmVyJywgRmFsc2UpOgogICAgICAgICAgICAgICAgZXhwZWN0ZWRfbG9nX2RyaXZlciA9IHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2xvZ19kcml2ZXInKSBvciBkZWZhdWx0c1snTG9nZ2luZ0RyaXZlciddCiAgICAgICAgICAgICAgICBhY3R1YWxfbG9nX2RyaXZlciA9IGNvbnRhaW5lclsnSG9zdENvbmZpZyddWydMb2dDb25maWcnXVsnVHlwZSddCiAgICAgICAgICAgICAgICBpZiBhY3R1YWxfbG9nX2RyaXZlciAhPSBleHBlY3RlZF9sb2dfZHJpdmVyOgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVsb2FkX3JlYXNvbnMuYXBwZW5kKCdsb2dfZHJpdmVyICh7MH0gPT4gezF9KScuZm9ybWF0KGFjdHVhbF9sb2dfZHJpdmVyLCBleHBlY3RlZF9sb2dfZHJpdmVyKSkKICAgICAgICAgICAgICAgICAgICBkaWZmZXJpbmcuYXBwZW5kKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgaWYgc2VsZi5lbnN1cmVfY2FwYWJpbGl0eSgnbG9nX29wdCcsIEZhbHNlKToKICAgICAgICAgICAgICAgIGV4cGVjdGVkX2xvZ2dpbmdfb3B0cyA9IHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2xvZ19vcHQnKSBvciB7fQogICAgICAgICAgICAgICAgYWN0dWFsX2xvZ19vcHRzID0gY29udGFpbmVyWydIb3N0Q29uZmlnJ11bJ0xvZ0NvbmZpZyddWydDb25maWcnXQogICAgICAgICAgICAgICAgaWYgbGVuKHNldChleHBlY3RlZF9sb2dnaW5nX29wdHMuaXRlbXMoKSkgLSBzZXQoYWN0dWFsX2xvZ19vcHRzLml0ZW1zKCkpKSAhPSAwOgogICAgICAgICAgICAgICAgICAgIGxvZ19vcHRfcmVhc29ucyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2FkZGVkJzogZGljdChzZXQoZXhwZWN0ZWRfbG9nZ2luZ19vcHRzLml0ZW1zKCkpIC0gc2V0KGFjdHVhbF9sb2dfb3B0cy5pdGVtcygpKSksCiAgICAgICAgICAgICAgICAgICAgICAgICdyZW1vdmVkJzogZGljdChzZXQoYWN0dWFsX2xvZ19vcHRzLml0ZW1zKCkpIC0gc2V0KGV4cGVjdGVkX2xvZ2dpbmdfb3B0cy5pdGVtcygpKSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWxvYWRfcmVhc29ucy5hcHBlbmQoJ2xvZ19vcHQgKHswfSknLmZvcm1hdChsb2dfb3B0X3JlYXNvbnMpKQogICAgICAgICAgICAgICAgICAgIGRpZmZlcmluZy5hcHBlbmQoY29udGFpbmVyKQoKICAgICAgICByZXR1cm4gZGlmZmVyaW5nCgogICAgZGVmIGdldF9kZXBsb3llZF9jb250YWluZXJzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFJldHVybiBhbnkgbWF0Y2hpbmcgY29udGFpbmVycyB0aGF0IGFyZSBhbHJlYWR5IHByZXNlbnQuCiAgICAgICAgIiIiCgogICAgICAgIGVudHJ5cG9pbnQgPSBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdlbnRyeXBvaW50JykKICAgICAgICBpZiBlbnRyeXBvaW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBlbnRyeXBvaW50ID0gc2hsZXguc3BsaXQoZW50cnlwb2ludCkKICAgICAgICBjb21tYW5kID0gc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnY29tbWFuZCcpCiAgICAgICAgaWYgY29tbWFuZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgY29tbWFuZCA9IHNobGV4LnNwbGl0KGNvbW1hbmQpCiAgICAgICAgbmFtZSA9IHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ25hbWUnKQogICAgICAgIGlmIG5hbWUgYW5kIG5vdCBuYW1lLnN0YXJ0c3dpdGgoJy8nKToKICAgICAgICAgICAgbmFtZSA9ICcvJyArIG5hbWUKICAgICAgICBkZXBsb3llZCA9IFtdCgogICAgICAgICMgImltYWdlcyIgd2lsbCBiZSBhIGNvbGxlY3Rpb24gb2YgZXF1aXZhbGVudCAibmFtZTp0YWciIGltYWdlIG5hbWVzCiAgICAgICAgIyB0aGF0IG1hcCB0byB0aGUgc2FtZSBEb2NrZXIgaW1hZ2UuCiAgICAgICAgaW5zcGVjdGVkID0gc2VsZi5nZXRfaW5zcGVjdF9pbWFnZSgpCiAgICAgICAgaWYgaW5zcGVjdGVkOgogICAgICAgICAgICByZXBvX3RhZ3MgPSBzZWxmLmdldF9pbWFnZV9yZXBvX3RhZ3MoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJlcG9fdGFncyA9IFtub3JtYWxpemVfaW1hZ2Uoc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnaW1hZ2UnKSldCgogICAgICAgIGZvciBjb250YWluZXIgaW4gc2VsZi5jbGllbnQuY29udGFpbmVycyhhbGw9VHJ1ZSk6CiAgICAgICAgICAgIGRldGFpbHMgPSBOb25lCgogICAgICAgICAgICBpZiBuYW1lOgogICAgICAgICAgICAgICAgbmFtZV9saXN0ID0gY29udGFpbmVyLmdldCgnTmFtZXMnKQogICAgICAgICAgICAgICAgaWYgbmFtZV9saXN0IGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgbmFtZV9saXN0ID0gW10KICAgICAgICAgICAgICAgIG1hdGNoZXMgPSBuYW1lIGluIG5hbWVfbGlzdAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZGV0YWlscyA9IHNlbGYuY2xpZW50Lmluc3BlY3RfY29udGFpbmVyKGNvbnRhaW5lclsnSWQnXSkKICAgICAgICAgICAgICAgIGRldGFpbHMgPSBfZG9ja2VyX2lkX3F1aXJrKGRldGFpbHMpCgogICAgICAgICAgICAgICAgcnVubmluZ19pbWFnZSA9IG5vcm1hbGl6ZV9pbWFnZShkZXRhaWxzWydDb25maWcnXVsnSW1hZ2UnXSkKCiAgICAgICAgICAgICAgICBpbWFnZV9tYXRjaGVzID0gcnVubmluZ19pbWFnZSBpbiByZXBvX3RhZ3MKCiAgICAgICAgICAgICAgICBpZiBjb21tYW5kIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgY29tbWFuZF9tYXRjaGVzID0gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBjb21tYW5kX21hdGNoZXMgPSAoY29tbWFuZCA9PSBkZXRhaWxzWydDb25maWcnXVsnQ21kJ10pCgogICAgICAgICAgICAgICAgaWYgZW50cnlwb2ludCBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIGVudHJ5cG9pbnRfbWF0Y2hlcyA9IFRydWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZW50cnlwb2ludF9tYXRjaGVzID0gKAogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeXBvaW50ID09IGRldGFpbHNbJ0NvbmZpZyddWydFbnRyeXBvaW50J10KICAgICAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgbWF0Y2hlcyA9IChpbWFnZV9tYXRjaGVzIGFuZCBjb21tYW5kX21hdGNoZXMgYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5cG9pbnRfbWF0Y2hlcykKCiAgICAgICAgICAgIGlmIG1hdGNoZXM6CiAgICAgICAgICAgICAgICBpZiBub3QgZGV0YWlsczoKICAgICAgICAgICAgICAgICAgICBkZXRhaWxzID0gc2VsZi5jbGllbnQuaW5zcGVjdF9jb250YWluZXIoY29udGFpbmVyWydJZCddKQogICAgICAgICAgICAgICAgICAgIGRldGFpbHMgPSBfZG9ja2VyX2lkX3F1aXJrKGRldGFpbHMpCgogICAgICAgICAgICAgICAgZGVwbG95ZWQuYXBwZW5kKGRldGFpbHMpCgogICAgICAgIHJldHVybiBkZXBsb3llZAoKICAgIGRlZiBnZXRfcnVubmluZ19jb250YWluZXJzKHNlbGYpOgogICAgICAgIHJldHVybiBbYyBmb3IgYyBpbiBzZWxmLmdldF9kZXBsb3llZF9jb250YWluZXJzKCkgaWYgaXNfcnVubmluZyhjKV0KCiAgICBkZWYgcHVsbF9pbWFnZShzZWxmKToKICAgICAgICBleHRyYV9wYXJhbXMgPSB7fQogICAgICAgIGlmIHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2luc2VjdXJlX3JlZ2lzdHJ5Jyk6CiAgICAgICAgICAgIGlmIHNlbGYuZW5zdXJlX2NhcGFiaWxpdHkoJ2luc2VjdXJlX3JlZ2lzdHJ5JywgZmFpbD1GYWxzZSk6CiAgICAgICAgICAgICAgICBleHRyYV9wYXJhbXNbJ2luc2VjdXJlX3JlZ2lzdHJ5J10gPSBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdpbnNlY3VyZV9yZWdpc3RyeScpCgogICAgICAgIHJlc291cmNlID0gc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnaW1hZ2UnKQogICAgICAgIGltYWdlLCB0YWcgPSBnZXRfc3BsaXRfaW1hZ2VfdGFnKHJlc291cmNlKQogICAgICAgIGlmIHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ3VzZXJuYW1lJyk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuY2xpZW50LmxvZ2luKAogICAgICAgICAgICAgICAgICAgIHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ3VzZXJuYW1lJyksCiAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ9c2VsZi5tb2R1bGUucGFyYW1zLmdldCgncGFzc3dvcmQnKSwKICAgICAgICAgICAgICAgICAgICBlbWFpbD1zZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdlbWFpbCcpLAogICAgICAgICAgICAgICAgICAgIHJlZ2lzdHJ5PXNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ3JlZ2lzdHJ5JykKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iZmFpbGVkIHRvIGxvZ2luIHRvIHRoZSByZW1vdGUgcmVnaXN0cnksIGNoZWNrIHlvdXIgdXNlcm5hbWUvcGFzc3dvcmQuIiwgZXJyb3I9cmVwcihlKSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNoYW5nZXMgPSBsaXN0KHNlbGYuY2xpZW50LnB1bGwoaW1hZ2UsIHRhZz10YWcsIHN0cmVhbT1UcnVlLCAqKmV4dHJhX3BhcmFtcykpCiAgICAgICAgICAgIHB1bGxfc3VjY2VzcyA9IEZhbHNlCiAgICAgICAgICAgIGZvciBjaGFuZ2UgaW4gY2hhbmdlczoKICAgICAgICAgICAgICAgIHN0YXR1cyA9IGpzb24ubG9hZHMoY2hhbmdlKS5nZXQoJ3N0YXR1cycsICcnKQogICAgICAgICAgICAgICAgaWYgc3RhdHVzLnN0YXJ0c3dpdGgoJ1N0YXR1czogSW1hZ2UgaXMgdXAgdG8gZGF0ZSBmb3InKToKICAgICAgICAgICAgICAgICAgICAjIEltYWdlIGlzIGFscmVhZHkgdXAgdG8gZGF0ZS4gRG9uJ3QgaW5jcmVtZW50IHRoZSBjb3VudGVyLgogICAgICAgICAgICAgICAgICAgIHB1bGxfc3VjY2VzcyA9IFRydWUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgZWxpZiAoc3RhdHVzLnN0YXJ0c3dpdGgoJ1N0YXR1czogRG93bmxvYWRlZCBuZXdlciBpbWFnZSBmb3InKSBvcgogICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMuc3RhcnRzd2l0aCgnRG93bmxvYWQgY29tcGxldGUnKSk6CiAgICAgICAgICAgICAgICAgICAgIyBJbWFnZSB3YXMgdXBkYXRlZC4gSW5jcmVtZW50IHRoZSBwdWxsIGNvdW50ZXIuCiAgICAgICAgICAgICAgICAgICAgc2VsZi5pbmNyZW1lbnRfY291bnRlcigncHVsbGVkJykKICAgICAgICAgICAgICAgICAgICBwdWxsX3N1Y2Nlc3MgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgaWYgbm90IHB1bGxfc3VjY2VzczoKICAgICAgICAgICAgICAgICMgVW5yZWNvZ25pemVkIHN0YXR1cyBzdHJpbmcuCiAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSJVbnJlY29nbml6ZWQgc3RhdHVzIGZyb20gcHVsbC4iLCBzdGF0dXM9c3RhdHVzLCBjaGFuZ2VzPWNoYW5nZXMpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSJGYWlsZWQgdG8gcHVsbCB0aGUgc3BlY2lmaWVkIGltYWdlOiAlcyIgJSByZXNvdXJjZSwgZXJyb3I9cmVwcihlKSkKCiAgICBkZWYgY3JlYXRlX2NvbnRhaW5lcnMoc2VsZiwgY291bnQ9MSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBtZW1fbGltaXQgPSBfaHVtYW5fdG9fYnl0ZXMoc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnbWVtb3J5X2xpbWl0JykpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3IgYXMgZToKICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz1zdHIoZSkpCiAgICAgICAgYXBpX3ZlcnNpb24gPSBzZWxmLmNsaWVudC52ZXJzaW9uKClbJ0FwaVZlcnNpb24nXQoKICAgICAgICBwYXJhbXMgPSB7J2ltYWdlJzogICAgICAgIHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2ltYWdlJyksCiAgICAgICAgICAgICAgICAgICdlbnRyeXBvaW50JzogICBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdlbnRyeXBvaW50JyksCiAgICAgICAgICAgICAgICAgICdjb21tYW5kJzogICAgICBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdjb21tYW5kJyksCiAgICAgICAgICAgICAgICAgICdwb3J0cyc6ICAgICAgICBzZWxmLmV4cG9zZWRfcG9ydHMsCiAgICAgICAgICAgICAgICAgICd2b2x1bWVzJzogICAgICBzZWxmLnZvbHVtZXMsCiAgICAgICAgICAgICAgICAgICdlbnZpcm9ubWVudCc6ICBzZWxmLmVudmlyb25tZW50LAogICAgICAgICAgICAgICAgICAnbGFiZWxzJzogICAgICAgc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnbGFiZWxzJyksCiAgICAgICAgICAgICAgICAgICdob3N0bmFtZSc6ICAgICBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdob3N0bmFtZScpLAogICAgICAgICAgICAgICAgICAnZG9tYWlubmFtZSc6ICAgc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnZG9tYWlubmFtZScpLAogICAgICAgICAgICAgICAgICAnZGV0YWNoJzogICAgICAgc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnZGV0YWNoJyksCiAgICAgICAgICAgICAgICAgICduYW1lJzogICAgICAgICBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCduYW1lJyksCiAgICAgICAgICAgICAgICAgICdzdGRpbl9vcGVuJzogICBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCdzdGRpbl9vcGVuJyksCiAgICAgICAgICAgICAgICAgICd0dHknOiAgICAgICAgICBzZWxmLm1vZHVsZS5wYXJhbXMuZ2V0KCd0dHknKSwKICAgICAgICAgICAgICAgICAgJ2NwdXNldCc6ICAgICAgIHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2NwdV9zZXQnKSwKICAgICAgICAgICAgICAgICAgJ2NwdV9zaGFyZXMnOiAgIHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2NwdV9zaGFyZXMnKSwKICAgICAgICAgICAgICAgICAgJ3VzZXInOiAgICAgICAgIHNlbGYubW9kdWxlLnBhcmFtcy5nZXQoJ2RvY2tlcl91c2VyJyksCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICBpZiBzZWxmLmVuc3VyZV9jYXBhYmlsaXR5KCdob3N0X2NvbmZpZycsIGZhaWw9RmFsc2UpOgogICAgICAgICAgICBwYXJhbXNbJ2hvc3RfY29uZmlnJ10gPSBzZWxmLmNyZWF0ZV9ob3N0X2NvbmZpZygpCgogICAgICAgICNGb3IgdjEuMTkgQVBJIGFuZCBhYm92ZSB1c2UgSG9zdENvbmZpZywgb3RoZXJ3aXNlIHVzZSBDb25maWcKICAgICAgICBpZiBkb2NrZXIudXRpbHMuY29tcGFyZV92ZXJzaW9uKCcxLjE5JywgYXBpX3ZlcnNpb24pIDwgMDoKICAgICAgICAgICAgcGFyYW1zWydtZW1fbGltaXQnXSA9IG1lbV9saW1pdAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHBhcmFtc1snaG9zdF9jb25maWcnXVsnTWVtb3J5J10gPSBtZW1fbGltaXQKCiAgICAgICAgaWYgc2VsZi51bGltaXRzIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLmVuc3VyZV9jYXBhYmlsaXR5KCd1bGltaXRzJykKICAgICAgICAgICAgcGFyYW1zWydob3N0X2NvbmZpZyddWyd1bGltaXRzJ10gPSBzZWxmLnVsaW1pdHMKCiAgICAgICAgZGVmIGRvX2NyZWF0ZShjb3VudCwgcGFyYW1zKToKICAgICAgICAgICAgcmVzdWx0cyA9IFtdCiAgICAgICAgICAgIGZvciBfIGluIHJhbmdlKGNvdW50KToKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuY2xpZW50LmNyZWF0ZV9jb250YWluZXIoKipwYXJhbXMpCiAgICAgICAgICAgICAgICBzZWxmLmluY3JlbWVudF9jb3VudGVyKCdjcmVhdGVkJykKICAgICAgICAgICAgICAgIHJlc3VsdHMuYXBwZW5kKHJlc3VsdCkKCiAgICAgICAgICAgIHJldHVybiByZXN1bHRzCgogICAgICAgIHRyeToKICAgICAgICAgICAgY29udGFpbmVycyA9IGRvX2NyZWF0ZShjb3VudCwgcGFyYW1zKQogICAgICAgIGV4Y2VwdCBkb2NrZXIuZXJyb3JzLkFQSUVycm9yIGFzIGU6CiAgICAgICAgICAgIGlmIGUucmVzcG9uc2Uuc3RhdHVzX2NvZGUgIT0gNDA0OgogICAgICAgICAgICAgICAgcmFpc2UKCiAgICAgICAgICAgIHNlbGYucHVsbF9pbWFnZSgpCiAgICAgICAgICAgIGNvbnRhaW5lcnMgPSBkb19jcmVhdGUoY291bnQsIHBhcmFtcykKCiAgICAgICAgcmV0dXJuIGNvbnRhaW5lcnMKCiAgICBkZWYgc3RhcnRfY29udGFpbmVycyhzZWxmLCBjb250YWluZXJzKToKICAgICAgICBwYXJhbXMgPSB7fQoKICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfY2FwYWJpbGl0eSgnaG9zdF9jb25maWcnLCBmYWlsPUZhbHNlKToKICAgICAgICAgICAgcGFyYW1zID0gc2VsZi5nZXRfc3RhcnRfcGFyYW1zKCkKCiAgICAgICAgZm9yIGkgaW4gY29udGFpbmVyczoKICAgICAgICAgICAgc2VsZi5jbGllbnQuc3RhcnQoaSkKICAgICAgICAgICAgc2VsZi5pbmNyZW1lbnRfY291bnRlcignc3RhcnRlZCcpCgogICAgICAgICAgICBpZiBub3Qgc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnZGV0YWNoJyk6CiAgICAgICAgICAgICAgICBzdGF0dXMgPSBzZWxmLmNsaWVudC53YWl0KGlbJ0lkJ10pCiAgICAgICAgICAgICAgICBpZiBzdGF0dXMgIT0gMDoKICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSBzZWxmLmNsaWVudC5sb2dzKGlbJ0lkJ10sIHN0ZG91dD1UcnVlLCBzdGRlcnI9VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbT1GYWxzZSwgdGltZXN0YW1wcz1GYWxzZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24oc3RhdHVzPXN0YXR1cywgbXNnPW91dHB1dCkKCiAgICBkZWYgc3RvcF9jb250YWluZXJzKHNlbGYsIGNvbnRhaW5lcnMpOgogICAgICAgIGZvciBpIGluIGNvbnRhaW5lcnM6CiAgICAgICAgICAgIHNlbGYuY2xpZW50LnN0b3AoaVsnSWQnXSwgc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnc3RvcF90aW1lb3V0JykpCiAgICAgICAgICAgIHNlbGYuaW5jcmVtZW50X2NvdW50ZXIoJ3N0b3BwZWQnKQoKICAgICAgICByZXR1cm4gW3NlbGYuY2xpZW50LndhaXQoaVsnSWQnXSkgZm9yIGkgaW4gY29udGFpbmVyc10KCiAgICBkZWYgcmVtb3ZlX2NvbnRhaW5lcnMoc2VsZiwgY29udGFpbmVycyk6CiAgICAgICAgZm9yIGkgaW4gY29udGFpbmVyczoKICAgICAgICAgICAgc2VsZi5jbGllbnQucmVtb3ZlX2NvbnRhaW5lcihpWydJZCddKQogICAgICAgICAgICBzZWxmLmluY3JlbWVudF9jb3VudGVyKCdyZW1vdmVkJykKCiAgICBkZWYga2lsbF9jb250YWluZXJzKHNlbGYsIGNvbnRhaW5lcnMpOgogICAgICAgIGZvciBpIGluIGNvbnRhaW5lcnM6CiAgICAgICAgICAgIHNlbGYuY2xpZW50LmtpbGwoaVsnSWQnXSwgc2VsZi5tb2R1bGUucGFyYW1zLmdldCgnc2lnbmFsJykpCiAgICAgICAgICAgIHNlbGYuaW5jcmVtZW50X2NvdW50ZXIoJ2tpbGxlZCcpCgogICAgZGVmIHJlc3RhcnRfY29udGFpbmVycyhzZWxmLCBjb250YWluZXJzKToKICAgICAgICBmb3IgaSBpbiBjb250YWluZXJzOgogICAgICAgICAgICBzZWxmLmNsaWVudC5yZXN0YXJ0KGlbJ0lkJ10pCiAgICAgICAgICAgIHNlbGYuaW5jcmVtZW50X2NvdW50ZXIoJ3Jlc3RhcnRlZCcpCgoKY2xhc3MgQ29udGFpbmVyU2V0OgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBtYW5hZ2VyKToKICAgICAgICBzZWxmLm1hbmFnZXIgPSBtYW5hZ2VyCiAgICAgICAgc2VsZi5ydW5uaW5nID0gW10KICAgICAgICBzZWxmLmRlcGxveWVkID0gW10KICAgICAgICBzZWxmLmNoYW5nZWQgPSBbXQoKICAgIGRlZiByZWZyZXNoKHNlbGYpOgogICAgICAgICcnJwogICAgICAgIFVwZGF0ZSBvdXIgdmlldyBvZiB0aGUgbWF0Y2hpbmcgY29udGFpbmVycyBmcm9tIHRoZSBEb2NrZXIgZGFlbW9uLgogICAgICAgICcnJwoKCiAgICAgICAgc2VsZi5kZXBsb3llZCA9IHNlbGYubWFuYWdlci5nZXRfZGVwbG95ZWRfY29udGFpbmVycygpCiAgICAgICAgc2VsZi5ydW5uaW5nID0gW2MgZm9yIGMgaW4gc2VsZi5kZXBsb3llZCBpZiBpc19ydW5uaW5nKGMpXQoKICAgIGRlZiBub3RpY2VfY2hhbmdlZChzZWxmLCBjb250YWluZXJzKToKICAgICAgICAnJycKICAgICAgICBSZWNvcmQgYSBjb2xsZWN0aW9uIG9mIGNvbnRhaW5lcnMgYXMgImNoYW5nZWQiLgogICAgICAgICcnJwoKICAgICAgICBzZWxmLmNoYW5nZWQuZXh0ZW5kKGNvbnRhaW5lcnMpCgoKZGVmIHByZXNlbnQobWFuYWdlciwgY29udGFpbmVycywgY291bnQsIG5hbWUpOgogICAgJycnRW5zdXJlIHRoYXQgZXhhY3RseSBgY291bnRgIG1hdGNoaW5nIGNvbnRhaW5lcnMgZXhpc3QgaW4gYW55IHN0YXRlLicnJwoKICAgIGNvbnRhaW5lcnMucmVmcmVzaCgpCiAgICBkZWx0YSA9IGNvdW50IC0gbGVuKGNvbnRhaW5lcnMuZGVwbG95ZWQpCgogICAgaWYgZGVsdGEgPiAwOgogICAgICAgIGNyZWF0ZWQgPSBtYW5hZ2VyLmNyZWF0ZV9jb250YWluZXJzKGRlbHRhKQogICAgICAgIGNvbnRhaW5lcnMubm90aWNlX2NoYW5nZWQobWFuYWdlci5nZXRfaW5zcGVjdF9jb250YWluZXJzKGNyZWF0ZWQpKQoKICAgIGlmIGRlbHRhIDwgMDoKICAgICAgICAjIElmIGJvdGggcnVubmluZyBhbmQgc3RvcHBlZCBjb250YWluZXJzIGV4aXN0LCByZW1vdmUKICAgICAgICAjIHN0b3BwZWQgY29udGFpbmVycyBmaXJzdC4KICAgICAgICAjIFVzZSBrZXkgcGFyYW0gZm9yIHB5dGhvbiAyLzMgY29tcGF0aWJpbGl0eS4KICAgICAgICBjb250YWluZXJzLmRlcGxveWVkLnNvcnQoa2V5PWlzX3J1bm5pbmcpCgogICAgICAgIHRvX3N0b3AgPSBbXQogICAgICAgIHRvX3JlbW92ZSA9IFtdCiAgICAgICAgZm9yIGMgaW4gY29udGFpbmVycy5kZXBsb3llZFswOi1kZWx0YV06CiAgICAgICAgICAgIGlmIGlzX3J1bm5pbmcoYyk6CiAgICAgICAgICAgICAgICB0b19zdG9wLmFwcGVuZChjKQogICAgICAgICAgICB0b19yZW1vdmUuYXBwZW5kKGMpCgogICAgICAgIG1hbmFnZXIuc3RvcF9jb250YWluZXJzKHRvX3N0b3ApCiAgICAgICAgY29udGFpbmVycy5ub3RpY2VfY2hhbmdlZChtYW5hZ2VyLmdldF9pbnNwZWN0X2NvbnRhaW5lcnModG9fcmVtb3ZlKSkKICAgICAgICBtYW5hZ2VyLnJlbW92ZV9jb250YWluZXJzKHRvX3JlbW92ZSkKCmRlZiBzdGFydGVkKG1hbmFnZXIsIGNvbnRhaW5lcnMsIGNvdW50LCBuYW1lKToKICAgICcnJ0Vuc3VyZSB0aGF0IGV4YWN0bHkgYGNvdW50YCBtYXRjaGluZyBjb250YWluZXJzIGV4aXN0IGFuZCBhcmUgcnVubmluZy4nJycKCiAgICBjb250YWluZXJzLnJlZnJlc2goKQogICAgZGVsdGEgPSBjb3VudCAtIGxlbihjb250YWluZXJzLnJ1bm5pbmcpCgogICAgaWYgZGVsdGEgPiAwOgogICAgICAgIGlmIG5hbWUgYW5kIGNvbnRhaW5lcnMuZGVwbG95ZWQ6CiAgICAgICAgICAgICMgQSBzdG9wcGVkIGNvbnRhaW5lciBleGlzdHMgd2l0aCB0aGUgcmVxdWVzdGVkIG5hbWUuCiAgICAgICAgICAgICMgQ2xlYW4gaXQgdXAgYmVmb3JlIGF0dGVtcHRpbmcgdG8gc3RhcnQgYSBuZXcgb25lLgogICAgICAgICAgICBtYW5hZ2VyLnJlbW92ZV9jb250YWluZXJzKGNvbnRhaW5lcnMuZGVwbG95ZWQpCgogICAgICAgIGNyZWF0ZWQgPSBtYW5hZ2VyLmNyZWF0ZV9jb250YWluZXJzKGRlbHRhKQogICAgICAgIG1hbmFnZXIuc3RhcnRfY29udGFpbmVycyhjcmVhdGVkKQogICAgICAgIGNvbnRhaW5lcnMubm90aWNlX2NoYW5nZWQobWFuYWdlci5nZXRfaW5zcGVjdF9jb250YWluZXJzKGNyZWF0ZWQpKQoKICAgIGlmIGRlbHRhIDwgMDoKICAgICAgICBleGNlc3MgPSBjb250YWluZXJzLnJ1bm5pbmdbMDotZGVsdGFdCiAgICAgICAgY29udGFpbmVycy5ub3RpY2VfY2hhbmdlZChtYW5hZ2VyLmdldF9pbnNwZWN0X2NvbnRhaW5lcnMoZXhjZXNzKSkKICAgICAgICBtYW5hZ2VyLnN0b3BfY29udGFpbmVycyhleGNlc3MpCiAgICAgICAgbWFuYWdlci5yZW1vdmVfY29udGFpbmVycyhleGNlc3MpCgpkZWYgcmVsb2FkZWQobWFuYWdlciwgY29udGFpbmVycywgY291bnQsIG5hbWUpOgogICAgJycnCiAgICBFbnN1cmUgdGhhdCBleGFjdGx5IGBjb3VudGAgbWF0Y2hpbmcgY29udGFpbmVycyBleGlzdCBhbmQgYXJlCiAgICBydW5uaW5nLiBJZiBhbnkgYXNzb2NpYXRlZCBzZXR0aW5ncyBoYXZlIGJlZW4gY2hhbmdlZCAodm9sdW1lcywKICAgIHBvcnRzIG9yIHNvIG9uKSwgcmVzdGFydCB0aG9zZSBjb250YWluZXJzLgogICAgJycnCgogICAgY29udGFpbmVycy5yZWZyZXNoKCkKCiAgICBmb3IgY29udGFpbmVyIGluIG1hbmFnZXIuZ2V0X2RpZmZlcmluZ19jb250YWluZXJzKCk6CiAgICAgICAgbWFuYWdlci5zdG9wX2NvbnRhaW5lcnMoW2NvbnRhaW5lcl0pCiAgICAgICAgbWFuYWdlci5yZW1vdmVfY29udGFpbmVycyhbY29udGFpbmVyXSkKCiAgICBzdGFydGVkKG1hbmFnZXIsIGNvbnRhaW5lcnMsIGNvdW50LCBuYW1lKQoKZGVmIHJlc3RhcnRlZChtYW5hZ2VyLCBjb250YWluZXJzLCBjb3VudCwgbmFtZSk6CiAgICAnJycKICAgIEVuc3VyZSB0aGF0IGV4YWN0bHkgYGNvdW50YCBtYXRjaGluZyBjb250YWluZXJzIGV4aXN0IGFuZCBhcmUKICAgIHJ1bm5pbmcuIFVuY29uZGl0aW9uYWxseSByZXN0YXJ0IGFueSB0aGF0IHdlcmUgYWxyZWFkeSBydW5uaW5nLgogICAgJycnCgogICAgY29udGFpbmVycy5yZWZyZXNoKCkKCiAgICBmb3IgY29udGFpbmVyIGluIG1hbmFnZXIuZ2V0X2RpZmZlcmluZ19jb250YWluZXJzKCk6CiAgICAgICAgbWFuYWdlci5zdG9wX2NvbnRhaW5lcnMoW2NvbnRhaW5lcl0pCiAgICAgICAgbWFuYWdlci5yZW1vdmVfY29udGFpbmVycyhbY29udGFpbmVyXSkKCiAgICBjb250YWluZXJzLnJlZnJlc2goKQoKICAgIG1hbmFnZXIucmVzdGFydF9jb250YWluZXJzKGNvbnRhaW5lcnMucnVubmluZykKICAgIHN0YXJ0ZWQobWFuYWdlciwgY29udGFpbmVycywgY291bnQsIG5hbWUpCgpkZWYgc3RvcHBlZChtYW5hZ2VyLCBjb250YWluZXJzLCBjb3VudCwgbmFtZSk6CiAgICAnJydTdG9wIGFueSBtYXRjaGluZyBjb250YWluZXJzIHRoYXQgYXJlIHJ1bm5pbmcuJycnCgogICAgY29udGFpbmVycy5yZWZyZXNoKCkKCiAgICBtYW5hZ2VyLnN0b3BfY29udGFpbmVycyhjb250YWluZXJzLnJ1bm5pbmcpCiAgICBjb250YWluZXJzLm5vdGljZV9jaGFuZ2VkKG1hbmFnZXIuZ2V0X2luc3BlY3RfY29udGFpbmVycyhjb250YWluZXJzLnJ1bm5pbmcpKQoKZGVmIGtpbGxlZChtYW5hZ2VyLCBjb250YWluZXJzLCBjb3VudCwgbmFtZSk6CiAgICAnJydLaWxsIGFueSBtYXRjaGluZyBjb250YWluZXJzIHRoYXQgYXJlIHJ1bm5pbmcuJycnCgogICAgY29udGFpbmVycy5yZWZyZXNoKCkKCiAgICBtYW5hZ2VyLmtpbGxfY29udGFpbmVycyhjb250YWluZXJzLnJ1bm5pbmcpCiAgICBjb250YWluZXJzLm5vdGljZV9jaGFuZ2VkKG1hbmFnZXIuZ2V0X2luc3BlY3RfY29udGFpbmVycyhjb250YWluZXJzLnJ1bm5pbmcpKQoKZGVmIGFic2VudChtYW5hZ2VyLCBjb250YWluZXJzLCBjb3VudCwgbmFtZSk6CiAgICAnJydTdG9wIGFuZCByZW1vdmUgYW55IG1hdGNoaW5nIGNvbnRhaW5lcnMuJycnCgogICAgY29udGFpbmVycy5yZWZyZXNoKCkKCiAgICBtYW5hZ2VyLnN0b3BfY29udGFpbmVycyhjb250YWluZXJzLnJ1bm5pbmcpCiAgICBjb250YWluZXJzLm5vdGljZV9jaGFuZ2VkKG1hbmFnZXIuZ2V0X2luc3BlY3RfY29udGFpbmVycyhjb250YWluZXJzLmRlcGxveWVkKSkKICAgIG1hbmFnZXIucmVtb3ZlX2NvbnRhaW5lcnMoY29udGFpbmVycy5kZXBsb3llZCkKCmRlZiBtYWluKCk6CiAgICBtb2R1bGUgPSBBbnNpYmxlTW9kdWxlKAogICAgICAgIGFyZ3VtZW50X3NwZWMgPSBkaWN0KAogICAgICAgICAgICBjb3VudCAgICAgICAgICAgPSBkaWN0KGRlZmF1bHQ9MSwgdHlwZT0naW50JyksCiAgICAgICAgICAgIGltYWdlICAgICAgICAgICA9IGRpY3QocmVxdWlyZWQ9VHJ1ZSksCiAgICAgICAgICAgIHB1bGwgICAgICAgICAgICA9IGRpY3QocmVxdWlyZWQ9RmFsc2UsIGRlZmF1bHQ9J21pc3NpbmcnLCBjaG9pY2VzPVsnbWlzc2luZycsICdhbHdheXMnXSksCiAgICAgICAgICAgIGVudHJ5cG9pbnQgICAgICA9IGRpY3QocmVxdWlyZWQ9RmFsc2UsIGRlZmF1bHQ9Tm9uZSwgdHlwZT0nc3RyJyksCiAgICAgICAgICAgIGNvbW1hbmQgICAgICAgICA9IGRpY3QocmVxdWlyZWQ9RmFsc2UsIGRlZmF1bHQ9Tm9uZSksCiAgICAgICAgICAgIGV4cG9zZSAgICAgICAgICA9IGRpY3QocmVxdWlyZWQ9RmFsc2UsIGRlZmF1bHQ9Tm9uZSwgdHlwZT0nbGlzdCcpLAogICAgICAgICAgICBwb3J0cyAgICAgICAgICAgPSBkaWN0KHJlcXVpcmVkPUZhbHNlLCBkZWZhdWx0PU5vbmUsIHR5cGU9J2xpc3QnKSwKICAgICAgICAgICAgcHVibGlzaF9hbGxfcG9ydHMgPSBkaWN0KGRlZmF1bHQ9RmFsc2UsIHR5cGU9J2Jvb2wnKSwKICAgICAgICAgICAgdm9sdW1lcyAgICAgICAgID0gZGljdChkZWZhdWx0PU5vbmUsIHR5cGU9J2xpc3QnKSwKICAgICAgICAgICAgdm9sdW1lc19mcm9tICAgID0gZGljdChkZWZhdWx0PU5vbmUsIHR5cGU9J2xpc3QnKSwKICAgICAgICAgICAgbGlua3MgICAgICAgICAgID0gZGljdChkZWZhdWx0PU5vbmUsIHR5cGU9J2xpc3QnKSwKICAgICAgICAgICAgZGV2aWNlcyAgICAgICAgID0gZGljdChkZWZhdWx0PU5vbmUsIHR5cGU9J2xpc3QnKSwKICAgICAgICAgICAgbWVtb3J5X2xpbWl0ICAgID0gZGljdChkZWZhdWx0PTApLAogICAgICAgICAgICBtZW1vcnlfc3dhcCAgICAgPSBkaWN0KGRlZmF1bHQ9MCwgdHlwZT0naW50JyksCiAgICAgICAgICAgIGNwdV9zaGFyZXMgICAgICA9IGRpY3QoZGVmYXVsdD0wLCB0eXBlPSdpbnQnKSwKICAgICAgICAgICAgZG9ja2VyX3VybCAgICAgID0gZGljdCgpLAogICAgICAgICAgICB1c2VfdGxzICAgICAgICAgPSBkaWN0KGRlZmF1bHQ9Tm9uZSwgY2hvaWNlcz1bJ25vJywgJ2VuY3J5cHQnLCAndmVyaWZ5J10pLAogICAgICAgICAgICB0bHNfY2xpZW50X2NlcnQgPSBkaWN0KHJlcXVpcmVkPUZhbHNlLCBkZWZhdWx0PU5vbmUsIHR5cGU9J3BhdGgnKSwKICAgICAgICAgICAgdGxzX2NsaWVudF9rZXkgID0gZGljdChyZXF1aXJlZD1GYWxzZSwgZGVmYXVsdD1Ob25lLCB0eXBlPSdwYXRoJyksCiAgICAgICAgICAgIHRsc19jYV9jZXJ0ICAgICA9IGRpY3QocmVxdWlyZWQ9RmFsc2UsIGRlZmF1bHQ9Tm9uZSwgdHlwZT0ncGF0aCcpLAogICAgICAgICAgICB0bHNfaG9zdG5hbWUgICAgPSBkaWN0KHJlcXVpcmVkPUZhbHNlLCB0eXBlPSdzdHInLCBkZWZhdWx0PU5vbmUpLAogICAgICAgICAgICBkb2NrZXJfYXBpX3ZlcnNpb24gPSBkaWN0KHJlcXVpcmVkPUZhbHNlLCBkZWZhdWx0PURFRkFVTFRfRE9DS0VSX0FQSV9WRVJTSU9OLCB0eXBlPSdzdHInKSwKICAgICAgICAgICAgZG9ja2VyX3VzZXIgICAgID0gZGljdChkZWZhdWx0PU5vbmUpLAogICAgICAgICAgICB1c2VybmFtZSAgICAgICAgPSBkaWN0KGRlZmF1bHQ9Tm9uZSksCiAgICAgICAgICAgIHBhc3N3b3JkICAgICAgICA9IGRpY3Qobm9fbG9nPVRydWUpLAogICAgICAgICAgICBlbWFpbCAgICAgICAgICAgPSBkaWN0KCksCiAgICAgICAgICAgIHJlZ2lzdHJ5ICAgICAgICA9IGRpY3QoKSwKICAgICAgICAgICAgaG9zdG5hbWUgICAgICAgID0gZGljdChkZWZhdWx0PU5vbmUpLAogICAgICAgICAgICBkb21haW5uYW1lICAgICAgPSBkaWN0KGRlZmF1bHQ9Tm9uZSksCiAgICAgICAgICAgIGVudiAgICAgICAgICAgICA9IGRpY3QodHlwZT0nZGljdCcpLAogICAgICAgICAgICBlbnZfZmlsZSAgICAgICAgPSBkaWN0KGRlZmF1bHQ9Tm9uZSksCiAgICAgICAgICAgIGRucyAgICAgICAgICAgICA9IGRpY3QoZGVmYXVsdD1Ob25lLCB0eXBlPSdsaXN0JyksCiAgICAgICAgICAgIGRldGFjaCAgICAgICAgICA9IGRpY3QoZGVmYXVsdD1UcnVlLCB0eXBlPSdib29sJyksCiAgICAgICAgICAgIHN0YXRlICAgICAgICAgICA9IGRpY3QoZGVmYXVsdD0nc3RhcnRlZCcsIGNob2ljZXM9WydwcmVzZW50JywgJ3N0YXJ0ZWQnLCAncmVsb2FkZWQnLCAncmVzdGFydGVkJywgJ3N0b3BwZWQnLCAna2lsbGVkJywgJ2Fic2VudCcsICdydW5uaW5nJ10pLAogICAgICAgICAgICBzaWduYWwgICAgICAgICAgPSBkaWN0KGRlZmF1bHQ9Tm9uZSksCiAgICAgICAgICAgIHJlc3RhcnRfcG9saWN5ICA9IGRpY3QoZGVmYXVsdD1Ob25lLCBjaG9pY2VzPVsnYWx3YXlzJywgJ29uLWZhaWx1cmUnLCAnbm8nLCAndW5sZXNzLXN0b3BwZWQnXSksCiAgICAgICAgICAgIHJlc3RhcnRfcG9saWN5X3JldHJ5ID0gZGljdChkZWZhdWx0PTAsIHR5cGU9J2ludCcpLAogICAgICAgICAgICBleHRyYV9ob3N0cyAgICAgPSBkaWN0KHR5cGU9J2RpY3QnKSwKICAgICAgICAgICAgZGVidWcgICAgICAgICAgID0gZGljdChkZWZhdWx0PUZhbHNlLCB0eXBlPSdib29sJyksCiAgICAgICAgICAgIHByaXZpbGVnZWQgICAgICA9IGRpY3QoZGVmYXVsdD1GYWxzZSwgdHlwZT0nYm9vbCcpLAogICAgICAgICAgICBzdGRpbl9vcGVuICAgICAgPSBkaWN0KGRlZmF1bHQ9RmFsc2UsIHR5cGU9J2Jvb2wnKSwKICAgICAgICAgICAgdHR5ICAgICAgICAgICAgID0gZGljdChkZWZhdWx0PUZhbHNlLCB0eXBlPSdib29sJyksCiAgICAgICAgICAgIGx4Y19jb25mICAgICAgICA9IGRpY3QoZGVmYXVsdD1Ob25lLCB0eXBlPSdsaXN0JyksCiAgICAgICAgICAgIG5hbWUgICAgICAgICAgICA9IGRpY3QoZGVmYXVsdD1Ob25lKSwKICAgICAgICAgICAgbmV0ICAgICAgICAgICAgID0gZGljdChkZWZhdWx0PU5vbmUpLAogICAgICAgICAgICBwaWQgICAgICAgICAgICAgPSBkaWN0KGRlZmF1bHQ9Tm9uZSksCiAgICAgICAgICAgIGluc2VjdXJlX3JlZ2lzdHJ5ID0gZGljdChkZWZhdWx0PUZhbHNlLCB0eXBlPSdib29sJyksCiAgICAgICAgICAgIGxvZ19kcml2ZXIgICAgICA9IGRpY3QoZGVmYXVsdD1Ob25lLCBjaG9pY2VzPVsnanNvbi1maWxlJywgJ25vbmUnLCAnc3lzbG9nJywgJ2pvdXJuYWxkJywgJ2dlbGYnLCAnZmx1ZW50ZCcsICdhd3Nsb2dzJ10pLAogICAgICAgICAgICBsb2dfb3B0ICAgICAgICAgPSBkaWN0KGRlZmF1bHQ9Tm9uZSwgdHlwZT0nZGljdCcpLAogICAgICAgICAgICBjcHVfc2V0ICAgICAgICAgPSBkaWN0KGRlZmF1bHQ9Tm9uZSksCiAgICAgICAgICAgIGNhcF9hZGQgICAgICAgICA9IGRpY3QoZGVmYXVsdD1Ob25lLCB0eXBlPSdsaXN0JyksCiAgICAgICAgICAgIGNhcF9kcm9wICAgICAgICA9IGRpY3QoZGVmYXVsdD1Ob25lLCB0eXBlPSdsaXN0JyksCiAgICAgICAgICAgIHJlYWRfb25seSAgICAgICA9IGRpY3QoZGVmYXVsdD1Ob25lLCB0eXBlPSdib29sJyksCiAgICAgICAgICAgIGxhYmVscyAgICAgICAgICA9IGRpY3QoZGVmYXVsdD17fSwgdHlwZT0nZGljdCcpLAogICAgICAgICAgICBzdG9wX3RpbWVvdXQgICAgPSBkaWN0KGRlZmF1bHQ9MTAsIHR5cGU9J2ludCcpLAogICAgICAgICAgICB0aW1lb3V0ICAgICAgICAgPSBkaWN0KHJlcXVpcmVkPUZhbHNlLCBkZWZhdWx0PURFRkFVTFRfVElNRU9VVF9TRUNPTkRTLCB0eXBlPSdpbnQnKSwKICAgICAgICAgICAgdWxpbWl0cyAgICAgICAgID0gZGljdChkZWZhdWx0PU5vbmUsIHR5cGU9J2xpc3QnKSwKICAgICAgICApLAogICAgICAgIHJlcXVpcmVkX3RvZ2V0aGVyID0gKAogICAgICAgICAgICBbJ3Rsc19jbGllbnRfY2VydCcsICd0bHNfY2xpZW50X2tleSddLAogICAgICAgICksCiAgICApCgogICAgY2hlY2tfZGVwZW5kZW5jaWVzKG1vZHVsZSkKCiAgICB0cnk6CiAgICAgICAgbWFuYWdlciA9IERvY2tlck1hbmFnZXIobW9kdWxlKQogICAgICAgIGNvdW50ID0gbW9kdWxlLnBhcmFtcy5nZXQoJ2NvdW50JykKICAgICAgICBuYW1lID0gbW9kdWxlLnBhcmFtcy5nZXQoJ25hbWUnKQogICAgICAgIHB1bGwgPSBtb2R1bGUucGFyYW1zLmdldCgncHVsbCcpCgogICAgICAgIHN0YXRlID0gbW9kdWxlLnBhcmFtcy5nZXQoJ3N0YXRlJykKICAgICAgICBpZiBzdGF0ZSA9PSAncnVubmluZyc6CiAgICAgICAgICAgICMgUmVuYW1lZCBydW5uaW5nIHRvIHN0YXJ0ZWQgaW4gMS45CiAgICAgICAgICAgIHN0YXRlID0gJ3N0YXJ0ZWQnCgogICAgICAgIGlmIGNvdW50IDwgMDoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9IkNvdW50IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8iKQoKICAgICAgICBpZiBjb3VudCA+IDEgYW5kIG5hbWU6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24obXNnPSJDb3VudCBhbmQgbmFtZSBtdXN0IG5vdCBiZSB1c2VkIHRvZ2V0aGVyIikKCiAgICAgICAgIyBFeHBsaWNpdGx5IHB1bGwgbmV3IGNvbnRhaW5lciBpbWFnZXMsIGlmIHJlcXVlc3RlZC4gRG8gdGhpcyBiZWZvcmUKICAgICAgICAjIG5vdGljaW5nIHJ1bm5pbmcgYW5kIGRlcGxveWVkIGNvbnRhaW5lcnMgc28gdGhhdCB0aGUgaW1hZ2UgbmFtZXMKICAgICAgICAjIHdpbGwgZGlmZmVyIGlmIGEgbmV3ZXIgaW1hZ2UgaGFzIGJlZW4gcHVsbGVkLgogICAgICAgICMgTWlzc2luZyBpbWFnZXMgc2hvdWxkIGJlIHB1bGxlZCBmaXJzdCB0byBhdm9pZCBkb3dudGltZSB3aGVuIG9sZAogICAgICAgICMgY29udGFpbmVyIGlzIHN0b3BwZWQsIGJ1dCBpbWFnZSBmb3IgbmV3IG9uZSBpcyBub3cgZG93bmxvYWRlZCB5ZXQuCiAgICAgICAgIyBJdCBhbHNvIHByZXZlbnRzIHJlbW92YWwgb2YgcnVubmluZyBjb250YWluZXIgYmVmb3JlIHJlYWxpemluZwogICAgICAgICMgdGhhdCByZXF1ZXN0ZWQgaW1hZ2UgY2Fubm90IGJlIHJldHJpZXZlZC4KICAgICAgICBpZiBwdWxsID09ICJhbHdheXMiIG9yIChzdGF0ZSA9PSAncmVsb2FkZWQnIGFuZCBtYW5hZ2VyLmdldF9pbnNwZWN0X2ltYWdlKCkgaXMgTm9uZSk6CiAgICAgICAgICAgIG1hbmFnZXIucHVsbF9pbWFnZSgpCgogICAgICAgIGNvbnRhaW5lcnMgPSBDb250YWluZXJTZXQobWFuYWdlcikKCiAgICAgICAgaWYgc3RhdGUgPT0gJ3ByZXNlbnQnOgogICAgICAgICAgICBwcmVzZW50KG1hbmFnZXIsIGNvbnRhaW5lcnMsIGNvdW50LCBuYW1lKQogICAgICAgIGVsaWYgc3RhdGUgPT0gJ3N0YXJ0ZWQnOgogICAgICAgICAgICBzdGFydGVkKG1hbmFnZXIsIGNvbnRhaW5lcnMsIGNvdW50LCBuYW1lKQogICAgICAgIGVsaWYgc3RhdGUgPT0gJ3JlbG9hZGVkJzoKICAgICAgICAgICAgcmVsb2FkZWQobWFuYWdlciwgY29udGFpbmVycywgY291bnQsIG5hbWUpCiAgICAgICAgZWxpZiBzdGF0ZSA9PSAncmVzdGFydGVkJzoKICAgICAgICAgICAgcmVzdGFydGVkKG1hbmFnZXIsIGNvbnRhaW5lcnMsIGNvdW50LCBuYW1lKQogICAgICAgIGVsaWYgc3RhdGUgPT0gJ3N0b3BwZWQnOgogICAgICAgICAgICBzdG9wcGVkKG1hbmFnZXIsIGNvbnRhaW5lcnMsIGNvdW50LCBuYW1lKQogICAgICAgIGVsaWYgc3RhdGUgPT0gJ2tpbGxlZCc6CiAgICAgICAgICAgIGtpbGxlZChtYW5hZ2VyLCBjb250YWluZXJzLCBjb3VudCwgbmFtZSkKICAgICAgICBlbGlmIHN0YXRlID09ICdhYnNlbnQnOgogICAgICAgICAgICBhYnNlbnQobWFuYWdlciwgY29udGFpbmVycywgY291bnQsIG5hbWUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9J1VucmVjb2duaXplZCBzdGF0ZSAlcy4gTXVzdCBiZSBvbmUgb2Y6ICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3ByZXNlbnQ7IHN0YXJ0ZWQ7IHJlbG9hZGVkOyByZXN0YXJ0ZWQ7ICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N0b3BwZWQ7IGtpbGxlZDsgYWJzZW50LicgJSBzdGF0ZSkKCiAgICAgICAgbW9kdWxlLmV4aXRfanNvbihjaGFuZ2VkPW1hbmFnZXIuaGFzX2NoYW5nZWQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgIG1zZz1tYW5hZ2VyLmdldF9zdW1tYXJ5X21lc3NhZ2UoKSwKICAgICAgICAgICAgICAgICAgICAgICAgIHN1bW1hcnk9bWFuYWdlci5jb3VudGVycywKICAgICAgICAgICAgICAgICAgICAgICAgIHJlbG9hZF9yZWFzb25zPW1hbmFnZXIuZ2V0X3JlbG9hZF9yZWFzb25fbWVzc2FnZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgYW5zaWJsZV9mYWN0cz1fYW5zaWJsZV9mYWN0cyhjb250YWluZXJzLmNoYW5nZWQpKQoKICAgIGV4Y2VwdCBEb2NrZXJBUElFcnJvciBhcyBlOgogICAgICAgIG1vZHVsZS5mYWlsX2pzb24oY2hhbmdlZD1tYW5hZ2VyLmhhc19jaGFuZ2VkKCksIG1zZz0iRG9ja2VyIEFQSSBFcnJvcjogJXMiICUgZS5leHBsYW5hdGlvbikKCiAgICBleGNlcHQgUmVxdWVzdEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIG1vZHVsZS5mYWlsX2pzb24oY2hhbmdlZD1tYW5hZ2VyLmhhc19jaGFuZ2VkKCksIG1zZz1yZXByKGUpKQoKIyBpbXBvcnQgbW9kdWxlIHNuaXBwZXRzCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuYmFzaWMgaW1wb3J0ICoKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICBtYWluKCkKUEsDBBQAAAAAAPe7K0s73zmVMIoBADCKAQAdAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvYmFzaWMucHkjIFRoaXMgY29kZSBpcyBwYXJ0IG9mIEFuc2libGUsIGJ1dCBpcyBhbiBpbmRlcGVuZGVudCBjb21wb25lbnQuCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgQ29weXJpZ2h0IChjKSwgTWljaGFlbCBEZUhhYW4gPG1pY2hhZWwuZGVoYWFuQGdtYWlsLmNvbT4sIDIwMTItMjAxMwojIENvcHlyaWdodCAoYyksIFRvc2hpbyBLdXJhdG9taSA8dGt1cmF0b21pQGFuc2libGUuY29tPiAyMDE2CiMgQWxsIHJpZ2h0cyByZXNlcnZlZC4KIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dCBtb2RpZmljYXRpb24sCiMgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAojICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5ECiMgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRUQKIyBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuCiMgSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsCiMgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLAojIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUwojIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QKIyBMSUFCSUxJVFksIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUKIyBVU0UgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwoKQk9PTEVBTlNfVFJVRSA9IFsneScsICd5ZXMnLCAnb24nLCAnMScsICd0cnVlJywgMSwgVHJ1ZV0KQk9PTEVBTlNfRkFMU0UgPSBbJ24nLCAnbm8nLCAnb2ZmJywgJzAnLCAnZmFsc2UnLCAwLCBGYWxzZV0KQk9PTEVBTlMgPSBCT09MRUFOU19UUlVFICsgQk9PTEVBTlNfRkFMU0UKClNJWkVfUkFOR0VTID0geyAnWSc6IDE8PDgwLCAnWic6IDE8PDcwLCAnRSc6IDE8PDYwLCAnUCc6IDE8PDUwLCAnVCc6IDE8PDQwLCAnRyc6IDE8PDMwLCAnTSc6IDE8PDIwLCAnSyc6IDE8PDEwLCAnQic6IDEgfQoKRklMRV9BVFRSSUJVVEVTID0gewogICAgJ0EnOiAnbm9hdGltZScsCiAgICAnYSc6ICdhcHBlbmQnLAogICAgJ2MnOiAnY29tcHJlc3NlZCcsCiAgICAnQyc6ICdub2NvdycsCiAgICAnZCc6ICdub2R1bXAnLAogICAgJ0QnOiAnZGlyc3luYycsCiAgICAnZSc6ICdleHRlbnRzJywKICAgICdFJzogJ2VuY3J5cHRlZCcsCiAgICAnaCc6ICdibG9ja3NpemUnLAogICAgJ2knOiAnaW1tdXRhYmxlJywKICAgICdJJzogJ2luZGV4ZWQnLAogICAgJ2onOiAnam91cm5hbGxlZCcsCiAgICAnTic6ICdpbmxpbmUnLAogICAgJ3MnOiAnemVybycsCiAgICAnUyc6ICdzeW5jaHJvbm91cycsCiAgICAndCc6ICdub3RhaWwnLAogICAgJ1QnOiAnYmxvY2tyb290JywKICAgICd1JzogJ3VuZGVsZXRlJywKICAgICdYJzogJ2NvbXByZXNzZWRyYXcnLAogICAgJ1onOiAnY29tcHJlc3NlZGRpcnR5JywKfQoKIyBhbnNpYmxlIG1vZHVsZXMgY2FuIGJlIHdyaXR0ZW4gaW4gYW55IGxhbmd1YWdlLiAgVG8gc2ltcGxpZnkKIyBkZXZlbG9wbWVudCBvZiBQeXRob24gbW9kdWxlcywgdGhlIGZ1bmN0aW9ucyBhdmFpbGFibGUgaGVyZSBjYW4KIyBiZSB1c2VkIHRvIGRvIG1hbnkgY29tbW9uIHRhc2tzCgppbXBvcnQgbG9jYWxlCmltcG9ydCBvcwppbXBvcnQgcmUKaW1wb3J0IHNobGV4CmltcG9ydCBzdWJwcm9jZXNzCmltcG9ydCBzeXMKaW1wb3J0IHR5cGVzCmltcG9ydCB0aW1lCmltcG9ydCBzZWxlY3QKaW1wb3J0IHNodXRpbAppbXBvcnQgc3RhdAppbXBvcnQgdGVtcGZpbGUKaW1wb3J0IHRyYWNlYmFjawppbXBvcnQgZ3JwCmltcG9ydCBwd2QKaW1wb3J0IHBsYXRmb3JtCmltcG9ydCBlcnJubwppbXBvcnQgZGF0ZXRpbWUKZnJvbSBpdGVydG9vbHMgaW1wb3J0IHJlcGVhdCwgY2hhaW4KCnRyeToKICAgIGltcG9ydCBzeXNsb2cKICAgIEhBU19TWVNMT0c9VHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBIQVNfU1lTTE9HPUZhbHNlCgp0cnk6CiAgICBmcm9tIHN5c3RlbWQgaW1wb3J0IGpvdXJuYWwKICAgIGhhc19qb3VybmFsID0gVHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBoYXNfam91cm5hbCA9IEZhbHNlCgpIQVZFX1NFTElOVVg9RmFsc2UKdHJ5OgogICAgaW1wb3J0IHNlbGludXgKICAgIEhBVkVfU0VMSU5VWD1UcnVlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIHBhc3MKCiMgUHl0aG9uMiAmIDMgd2F5IHRvIGdldCBOb25lVHlwZQpOb25lVHlwZSA9IHR5cGUoTm9uZSkKCnRyeToKICAgIGZyb20gY29sbGVjdGlvbnMgaW1wb3J0IFNlcXVlbmNlLCBNYXBwaW5nCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICMgcHl0aG9uMi41CiAgICBTZXF1ZW5jZSA9IChsaXN0LCB0dXBsZSkKICAgIE1hcHBpbmcgPSAoZGljdCwpCgojIE5vdGU6IFdoZW4gZ2V0dGluZyBTZXF1ZW5jZSBmcm9tIGNvbGxlY3Rpb25zLCBpdCBtYXRjaGVzIHdpdGggc3RyaW5ncy4gIElmCiMgdGhpcyBtYXR0ZXJzLCBtYWtlIHN1cmUgdG8gY2hlY2sgZm9yIHN0cmluZ3MgYmVmb3JlIGNoZWNraW5nIGZvciBzZXF1ZW5jZXR5cGUKdHJ5OgogICAgZnJvbSBjb2xsZWN0aW9ucy5hYmMgaW1wb3J0IEtleXNWaWV3CiAgICBTRVFVRU5DRVRZUEUgPSAoU2VxdWVuY2UsIEtleXNWaWV3KQpleGNlcHQ6CiAgICBTRVFVRU5DRVRZUEUgPSBTZXF1ZW5jZQoKdHJ5OgogICAgaW1wb3J0IGpzb24KICAgICMgRGV0ZWN0IHRoZSBweXRob24tanNvbiBsaWJyYXJ5IHdoaWNoIGlzIGluY29tcGF0aWJsZQogICAgIyBMb29rIGZvciBzaW1wbGVqc29uIGlmIHRoYXQncyB0aGUgY2FzZQogICAgdHJ5OgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGpzb24ubG9hZHMsIHR5cGVzLkZ1bmN0aW9uVHlwZSkgb3Igbm90IGlzaW5zdGFuY2UoanNvbi5kdW1wcywgdHlwZXMuRnVuY3Rpb25UeXBlKToKICAgICAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IKICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICByYWlzZSBJbXBvcnRFcnJvcgpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICB0cnk6CiAgICAgICAgaW1wb3J0IHNpbXBsZWpzb24gYXMganNvbgogICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgIHByaW50KCdcbnsibXNnIjogIkVycm9yOiBhbnNpYmxlIHJlcXVpcmVzIHRoZSBzdGRsaWIganNvbiBvciBzaW1wbGVqc29uIG1vZHVsZSwgbmVpdGhlciB3YXMgZm91bmQhIiwgImZhaWxlZCI6IHRydWV9JykKICAgICAgICBzeXMuZXhpdCgxKQogICAgZXhjZXB0IFN5bnRheEVycm9yOgogICAgICAgIHByaW50KCdcbnsibXNnIjogIlN5bnRheEVycm9yOiBwcm9iYWJseSBkdWUgdG8gaW5zdGFsbGVkIHNpbXBsZWpzb24gYmVpbmcgZm9yIGEgZGlmZmVyZW50IHB5dGhvbiB2ZXJzaW9uIiwgImZhaWxlZCI6IHRydWV9JykKICAgICAgICBzeXMuZXhpdCgxKQoKQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNUyA9IGRpY3QoKQp0cnk6CiAgICBpbXBvcnQgaGFzaGxpYgoKICAgICMgcHl0aG9uIDIuNy45KyBhbmQgMi43LjArCiAgICBmb3IgYXR0cmlidXRlIGluICgnYXZhaWxhYmxlX2FsZ29yaXRobXMnLCAnYWxnb3JpdGhtcycpOgogICAgICAgIGFsZ29yaXRobXMgPSBnZXRhdHRyKGhhc2hsaWIsIGF0dHJpYnV0ZSwgTm9uZSkKICAgICAgICBpZiBhbGdvcml0aG1zOgogICAgICAgICAgICBicmVhawogICAgaWYgYWxnb3JpdGhtcyBpcyBOb25lOgogICAgICAgICMgcHl0aG9uIDIuNSsKICAgICAgICBhbGdvcml0aG1zID0gKCdtZDUnLCAnc2hhMScsICdzaGEyMjQnLCAnc2hhMjU2JywgJ3NoYTM4NCcsICdzaGE1MTInKQogICAgZm9yIGFsZ29yaXRobSBpbiBhbGdvcml0aG1zOgogICAgICAgIEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVNbYWxnb3JpdGhtXSA9IGdldGF0dHIoaGFzaGxpYiwgYWxnb3JpdGhtKQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBpbXBvcnQgc2hhCiAgICBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TID0geydzaGExJzogc2hhLnNoYX0KICAgIHRyeToKICAgICAgICBpbXBvcnQgbWQ1CiAgICAgICAgQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNU1snbWQ1J10gPSBtZDUubWQ1CiAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgcGFzcwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5weWNvbXBhdDI0IGltcG9ydCBnZXRfZXhjZXB0aW9uLCBsaXRlcmFsX2V2YWwKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IChQWTIsIFBZMywgYiwgYmluYXJ5X3R5cGUsIGludGVnZXJfdHlwZXMsCiAgICAgICAgaXRlcml0ZW1zLCB0ZXh0X3R5cGUsIHN0cmluZ190eXBlcykKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXgubW92ZXMgaW1wb3J0IG1hcCwgcmVkdWNlLCBzaGxleF9xdW90ZQpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLl90ZXh0IGltcG9ydCB0b19uYXRpdmUsIHRvX2J5dGVzLCB0b190ZXh0CgpQQVNTV09SRF9NQVRDSCA9IHJlLmNvbXBpbGUocideKD86LitbLV9cc10pP3Bhc3MoPzpbLV9cc10/KD86d29yZHxwaHJhc2V8d3JkfHdkKT8pKD86Wy1fXHNdLispPyQnLCByZS5JKQoKX05VTUJFUlRZUEVTID0gdHVwbGUobGlzdChpbnRlZ2VyX3R5cGVzKSArIFtmbG9hdF0pCgojIERlcHJlY2F0ZWQgY29tcGF0LiAgT25seSBrZXB0IGluIGNhc2UgYW5vdGhlciBtb2R1bGUgdXNlZCB0aGVzZSBuYW1lcyAgVXNpbmcKIyBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaXMgcHJlZmVycmVkCgpOVU1CRVJUWVBFUyA9IF9OVU1CRVJUWVBFUwoKaW1hcCA9IG1hcAoKdHJ5OgogICAgIyBQeXRob24gMgogICAgdW5pY29kZQpleGNlcHQgTmFtZUVycm9yOgogICAgIyBQeXRob24gMwogICAgdW5pY29kZSA9IHRleHRfdHlwZQoKdHJ5OgogICAgIyBQeXRob24gMi42KwogICAgYnl0ZXMKZXhjZXB0IE5hbWVFcnJvcjoKICAgICMgUHl0aG9uIDIuNAogICAgYnl0ZXMgPSBiaW5hcnlfdHlwZQoKdHJ5OgogICAgIyBQeXRob24gMgogICAgYmFzZXN0cmluZwpleGNlcHQgTmFtZUVycm9yOgogICAgIyBQeXRob24gMwogICAgYmFzZXN0cmluZyA9IHN0cmluZ190eXBlcwoKX2xpdGVyYWxfZXZhbCA9IGxpdGVyYWxfZXZhbAoKIyBFbmQgb2YgZGVwcmVjYXRlZCBuYW1lcwoKIyBJbnRlcm5hbCBnbG9iYWwgaG9sZGluZyBwYXNzZWQgaW4gcGFyYW1zLiAgVGhpcyBpcyBjb25zdWx0ZWQgaW4gY2FzZQojIG11bHRpcGxlIEFuc2libGVNb2R1bGVzIGFyZSBjcmVhdGVkLiAgT3RoZXJ3aXNlIGVhY2ggQW5zaWJsZU1vZHVsZSB3b3VsZAojIGF0dGVtcHQgdG8gcmVhZCBmcm9tIHN0ZGluLiAgT3RoZXIgY29kZSBzaG91bGQgbm90IHVzZSB0aGlzIGRpcmVjdGx5IGFzIGl0CiMgaXMgYW4gaW50ZXJuYWwgaW1wbGVtZW50YXRpb24gZGV0YWlsCl9BTlNJQkxFX0FSR1MgPSBOb25lCgpGSUxFX0NPTU1PTl9BUkdVTUVOVFM9ZGljdCgKICAgIHNyYyA9IGRpY3QoKSwKICAgIG1vZGUgPSBkaWN0KHR5cGU9J3JhdycpLAogICAgb3duZXIgPSBkaWN0KCksCiAgICBncm91cCA9IGRpY3QoKSwKICAgIHNldXNlciA9IGRpY3QoKSwKICAgIHNlcm9sZSA9IGRpY3QoKSwKICAgIHNlbGV2ZWwgPSBkaWN0KCksCiAgICBzZXR5cGUgPSBkaWN0KCksCiAgICBmb2xsb3cgPSBkaWN0KHR5cGU9J2Jvb2wnLCBkZWZhdWx0PUZhbHNlKSwKICAgICMgbm90IHRha2VuIGJ5IHRoZSBmaWxlIG1vZHVsZSwgYnV0IG90aGVyIG1vZHVsZXMgY2FsbCBmaWxlIHNvIGl0IG11c3QgaWdub3JlIHRoZW0uCiAgICBjb250ZW50ID0gZGljdChub19sb2c9VHJ1ZSksCiAgICBiYWNrdXAgPSBkaWN0KCksCiAgICBmb3JjZSA9IGRpY3QoKSwKICAgIHJlbW90ZV9zcmMgPSBkaWN0KCksICMgdXNlZCBieSBhc3NlbWJsZQogICAgcmVnZXhwID0gZGljdCgpLCAjIHVzZWQgYnkgYXNzZW1ibGUKICAgIGRlbGltaXRlciA9IGRpY3QoKSwgIyB1c2VkIGJ5IGFzc2VtYmxlCiAgICBkaXJlY3RvcnlfbW9kZSA9IGRpY3QoKSwgIyB1c2VkIGJ5IGNvcHkKICAgIHVuc2FmZV93cml0ZXMgID0gZGljdCh0eXBlPSdib29sJyksICMgc2hvdWxkIGJlIGF2YWlsYWJsZSB0byBhbnkgbW9kdWxlIHVzaW5nIGF0b21pY19tb3ZlCiAgICBhdHRyaWJ1dGVzID0gZGljdChhbGlhc2VzPVsnYXR0ciddKSwKKQoKUEFTU1dEX0FSR19SRSA9IHJlLmNvbXBpbGUocideWy1dezAsMn1wYXNzWy1dPyh3b3JkfHdkKT8nKQoKIyBDYW4ndCB1c2UgMDc3Nzcgb24gUHl0aG9uIDMsIGNhbid0IHVzZSAwbzc3Nzcgb24gUHl0aG9uIDIuNApQRVJNX0JJVFMgPSBpbnQoJzA3Nzc3JywgOCkgICAgICAjIGZpbGUgbW9kZSBwZXJtaXNzaW9uIGJpdHMKRVhFQ19QRVJNX0JJVFMgPSBpbnQoJzAwMTExJywgOCkgIyBleGVjdXRlIHBlcm1pc3Npb24gYml0cwpERUZBVUxUX1BFUk0gPSBpbnQoJzA2NjYnLCA4KSAgICAjIGRlZmF1bHQgZmlsZSBwZXJtaXNzaW9uIGJpdHMKCgpkZWYgZ2V0X3BsYXRmb3JtKCk6CiAgICAnJycgd2hhdCdzIHRoZSBwbGF0Zm9ybT8gIGV4YW1wbGU6IExpbnV4IGlzIGEgcGxhdGZvcm0uICcnJwogICAgcmV0dXJuIHBsYXRmb3JtLnN5c3RlbSgpCgpkZWYgZ2V0X2Rpc3RyaWJ1dGlvbigpOgogICAgJycnIHJldHVybiB0aGUgZGlzdHJpYnV0aW9uIG5hbWUgJycnCiAgICBpZiBwbGF0Zm9ybS5zeXN0ZW0oKSA9PSAnTGludXgnOgogICAgICAgIHRyeToKICAgICAgICAgICAgc3VwcG9ydGVkX2Rpc3RzID0gcGxhdGZvcm0uX3N1cHBvcnRlZF9kaXN0cyArICgnYXJjaCcsJ2FscGluZScpCiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9IHBsYXRmb3JtLmxpbnV4X2Rpc3RyaWJ1dGlvbihzdXBwb3J0ZWRfZGlzdHM9c3VwcG9ydGVkX2Rpc3RzKVswXS5jYXBpdGFsaXplKCkKICAgICAgICAgICAgaWYgbm90IGRpc3RyaWJ1dGlvbiBhbmQgb3MucGF0aC5pc2ZpbGUoJy9ldGMvc3lzdGVtLXJlbGVhc2UnKToKICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9IHBsYXRmb3JtLmxpbnV4X2Rpc3RyaWJ1dGlvbihzdXBwb3J0ZWRfZGlzdHM9WydzeXN0ZW0nXSlbMF0uY2FwaXRhbGl6ZSgpCiAgICAgICAgICAgICAgICBpZiAnQW1hem9uJyBpbiBkaXN0cmlidXRpb246CiAgICAgICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gJ0FtYXpvbicKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gJ090aGVyTGludXgnCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAjIEZJWE1FOiBNZXRob2RNaXNzaW5nLCBJIGFzc3VtZT8KICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gcGxhdGZvcm0uZGlzdCgpWzBdLmNhcGl0YWxpemUoKQogICAgZWxzZToKICAgICAgICBkaXN0cmlidXRpb24gPSBOb25lCiAgICByZXR1cm4gZGlzdHJpYnV0aW9uCgpkZWYgZ2V0X2Rpc3RyaWJ1dGlvbl92ZXJzaW9uKCk6CiAgICAnJycgcmV0dXJuIHRoZSBkaXN0cmlidXRpb24gdmVyc2lvbiAnJycKICAgIGlmIHBsYXRmb3JtLnN5c3RlbSgpID09ICdMaW51eCc6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IHBsYXRmb3JtLmxpbnV4X2Rpc3RyaWJ1dGlvbigpWzFdCiAgICAgICAgICAgIGlmIG5vdCBkaXN0cmlidXRpb25fdmVyc2lvbiBhbmQgb3MucGF0aC5pc2ZpbGUoJy9ldGMvc3lzdGVtLXJlbGVhc2UnKToKICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbl92ZXJzaW9uID0gcGxhdGZvcm0ubGludXhfZGlzdHJpYnV0aW9uKHN1cHBvcnRlZF9kaXN0cz1bJ3N5c3RlbSddKVsxXQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgIyBGSVhNRTogTWV0aG9kTWlzc2luZywgSSBhc3N1bWU/CiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbl92ZXJzaW9uID0gcGxhdGZvcm0uZGlzdCgpWzFdCiAgICBlbHNlOgogICAgICAgIGRpc3RyaWJ1dGlvbl92ZXJzaW9uID0gTm9uZQogICAgcmV0dXJuIGRpc3RyaWJ1dGlvbl92ZXJzaW9uCgpkZWYgZ2V0X2FsbF9zdWJjbGFzc2VzKGNscyk6CiAgICAnJycKICAgIHVzZWQgYnkgbW9kdWxlcyBsaWtlIEhhcmR3YXJlIG9yIE5ldHdvcmsgZmFjdCBjbGFzc2VzIHRvIHJldHJpZXZlIGFsbCBzdWJjbGFzc2VzIG9mIGEgZ2l2ZW4gY2xhc3MuCiAgICBfX3N1YmNsYXNzZXNfXyByZXR1cm4gb25seSBkaXJlY3Qgc3ViIGNsYXNzZXMuIFRoaXMgb25lIGdvIGRvd24gaW50byB0aGUgY2xhc3MgdHJlZS4KICAgICcnJwogICAgIyBSZXRyaWV2ZSBkaXJlY3Qgc3ViY2xhc3NlcwogICAgc3ViY2xhc3NlcyA9IGNscy5fX3N1YmNsYXNzZXNfXygpCiAgICB0b192aXNpdCA9IGxpc3Qoc3ViY2xhc3NlcykKICAgICMgVGhlbiB2aXNpdCBhbGwgc3ViY2xhc3NlcwogICAgd2hpbGUgdG9fdmlzaXQ6CiAgICAgICAgZm9yIHNjIGluIHRvX3Zpc2l0OgogICAgICAgICAgICAjIFRoZSBjdXJyZW50IGNsYXNzIGlzIG5vdyB2aXNpdGVkLCBzbyByZW1vdmUgaXQgZnJvbSBsaXN0CiAgICAgICAgICAgIHRvX3Zpc2l0LnJlbW92ZShzYykKICAgICAgICAgICAgIyBBcHBlbmRpbmcgYWxsIHN1YmNsYXNzZXMgdG8gdmlzaXQgYW5kIGtlZXAgYSByZWZlcmVuY2Ugb2YgYXZhaWxhYmxlIGNsYXNzCiAgICAgICAgICAgIGZvciBzc2MgaW4gc2MuX19zdWJjbGFzc2VzX18oKToKICAgICAgICAgICAgICAgIHN1YmNsYXNzZXMuYXBwZW5kKHNzYykKICAgICAgICAgICAgICAgIHRvX3Zpc2l0LmFwcGVuZChzc2MpCiAgICByZXR1cm4gc3ViY2xhc3NlcwoKCmRlZiBsb2FkX3BsYXRmb3JtX3N1YmNsYXNzKGNscywgKmFyZ3MsICoqa3dhcmdzKToKICAgICcnJwogICAgdXNlZCBieSBtb2R1bGVzIGxpa2UgVXNlciB0byBoYXZlIGRpZmZlcmVudCBpbXBsZW1lbnRhdGlvbnMgYmFzZWQgb24gZGV0ZWN0ZWQgcGxhdGZvcm0uICBTZWUgVXNlcgogICAgbW9kdWxlIGZvciBhbiBleGFtcGxlLgogICAgJycnCgogICAgdGhpc19wbGF0Zm9ybSA9IGdldF9wbGF0Zm9ybSgpCiAgICBkaXN0cmlidXRpb24gPSBnZXRfZGlzdHJpYnV0aW9uKCkKICAgIHN1YmNsYXNzID0gTm9uZQoKICAgICMgZ2V0IHRoZSBtb3N0IHNwZWNpZmljIHN1cGVyY2xhc3MgZm9yIHRoaXMgcGxhdGZvcm0KICAgIGlmIGRpc3RyaWJ1dGlvbiBpcyBub3QgTm9uZToKICAgICAgICBmb3Igc2MgaW4gZ2V0X2FsbF9zdWJjbGFzc2VzKGNscyk6CiAgICAgICAgICAgIGlmIHNjLmRpc3RyaWJ1dGlvbiBpcyBub3QgTm9uZSBhbmQgc2MuZGlzdHJpYnV0aW9uID09IGRpc3RyaWJ1dGlvbiBhbmQgc2MucGxhdGZvcm0gPT0gdGhpc19wbGF0Zm9ybToKICAgICAgICAgICAgICAgIHN1YmNsYXNzID0gc2MKICAgIGlmIHN1YmNsYXNzIGlzIE5vbmU6CiAgICAgICAgZm9yIHNjIGluIGdldF9hbGxfc3ViY2xhc3NlcyhjbHMpOgogICAgICAgICAgICBpZiBzYy5wbGF0Zm9ybSA9PSB0aGlzX3BsYXRmb3JtIGFuZCBzYy5kaXN0cmlidXRpb24gaXMgTm9uZToKICAgICAgICAgICAgICAgIHN1YmNsYXNzID0gc2MKICAgIGlmIHN1YmNsYXNzIGlzIE5vbmU6CiAgICAgICAgc3ViY2xhc3MgPSBjbHMKCiAgICByZXR1cm4gc3VwZXIoY2xzLCBzdWJjbGFzcykuX19uZXdfXyhzdWJjbGFzcykKCgpkZWYganNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMoZCwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0Jyk6CiAgICAnJycgUmVjdXJzaXZlbHkgY29udmVydCBkaWN0IGtleXMgYW5kIHZhbHVlcyB0byBieXRlIHN0cgoKICAgICAgICBTcGVjaWFsaXplZCBmb3IganNvbiByZXR1cm4gYmVjYXVzZSB0aGlzIG9ubHkgaGFuZGxlcywgbGlzdHMsIHR1cGxlcywKICAgICAgICBhbmQgZGljdCBjb250YWluZXIgdHlwZXMgKHRoZSBjb250YWluZXJzIHRoYXQgdGhlIGpzb24gbW9kdWxlIHJldHVybnMpCiAgICAnJycKCiAgICBpZiBpc2luc3RhbmNlKGQsIHRleHRfdHlwZSk6CiAgICAgICAgcmV0dXJuIHRvX2J5dGVzKGQsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIGRpY3QpOgogICAgICAgIHJldHVybiBkaWN0KG1hcChqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcywgaXRlcml0ZW1zKGQpLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgbGlzdCk6CiAgICAgICAgcmV0dXJuIGxpc3QobWFwKGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzLCBkLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgdHVwbGUpOgogICAgICAgIHJldHVybiB0dXBsZShtYXAoanNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMsIGQsIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIGQKCmRlZiBqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZShkLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKToKICAgICcnJyBSZWN1cnNpdmVseSBjb252ZXJ0IGRpY3Qga2V5cyBhbmQgdmFsdWVzIHRvIGJ5dGUgc3RyCgogICAgICAgIFNwZWNpYWxpemVkIGZvciBqc29uIHJldHVybiBiZWNhdXNlIHRoaXMgb25seSBoYW5kbGVzLCBsaXN0cywgdHVwbGVzLAogICAgICAgIGFuZCBkaWN0IGNvbnRhaW5lciB0eXBlcyAodGhlIGNvbnRhaW5lcnMgdGhhdCB0aGUganNvbiBtb2R1bGUgcmV0dXJucykKICAgICcnJwoKICAgIGlmIGlzaW5zdGFuY2UoZCwgYmluYXJ5X3R5cGUpOgogICAgICAgICMgV2FybmluZywgY2FuIHRyYWNlYmFjawogICAgICAgIHJldHVybiB0b190ZXh0KGQsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIGRpY3QpOgogICAgICAgIHJldHVybiBkaWN0KG1hcChqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZSwgaXRlcml0ZW1zKGQpLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgbGlzdCk6CiAgICAgICAgcmV0dXJuIGxpc3QobWFwKGpzb25fZGljdF9ieXRlc190b191bmljb2RlLCBkLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgdHVwbGUpOgogICAgICAgIHJldHVybiB0dXBsZShtYXAoanNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUsIGQsIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIGQKCmRlZiByZXR1cm5fdmFsdWVzKG9iaik6CiAgICAiIiIgUmV0dXJuIG5hdGl2ZSBzdHJpbmdpZmllZCB2YWx1ZXMgZnJvbSBkYXRhc3RydWN0dXJlcy4KCiAgICBGb3IgdXNlIHdpdGggcmVtb3Zpbmcgc2Vuc2l0aXZlIHZhbHVlcyBwcmUtanNvbmlmaWNhdGlvbi4iIiIKICAgIGlmIGlzaW5zdGFuY2Uob2JqLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgIGlmIG9iajoKICAgICAgICAgICAgeWllbGQgdG9fbmF0aXZlKG9iaiwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICByZXR1cm4KICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIFNFUVVFTkNFVFlQRSk6CiAgICAgICAgZm9yIGVsZW1lbnQgaW4gb2JqOgogICAgICAgICAgICBmb3Igc3ViZWxlbWVudCBpbiByZXR1cm5fdmFsdWVzKGVsZW1lbnQpOgogICAgICAgICAgICAgICAgeWllbGQgc3ViZWxlbWVudAogICAgZWxpZiBpc2luc3RhbmNlKG9iaiwgTWFwcGluZyk6CiAgICAgICAgZm9yIGVsZW1lbnQgaW4gb2JqLml0ZW1zKCk6CiAgICAgICAgICAgIGZvciBzdWJlbGVtZW50IGluIHJldHVybl92YWx1ZXMoZWxlbWVudFsxXSk6CiAgICAgICAgICAgICAgICB5aWVsZCBzdWJlbGVtZW50CiAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCAoYm9vbCwgTm9uZVR5cGUpKToKICAgICAgICAjIFRoaXMgbXVzdCBjb21lIGJlZm9yZSBpbnQgYmVjYXVzZSBib29scyBhcmUgYWxzbyBpbnRzCiAgICAgICAgcmV0dXJuCiAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCBOVU1CRVJUWVBFUyk6CiAgICAgICAgeWllbGQgdG9fbmF0aXZlKG9iaiwgbm9uc3RyaW5nPSdzaW1wbGVyZXByJykKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdVbmtub3duIHBhcmFtZXRlciB0eXBlOiAlcywgJXMnICUgKHR5cGUob2JqKSwgb2JqKSkKCmRlZiByZW1vdmVfdmFsdWVzKHZhbHVlLCBub19sb2dfc3RyaW5ncyk6CiAgICAiIiIgUmVtb3ZlIHN0cmluZ3MgaW4gbm9fbG9nX3N0cmluZ3MgZnJvbSB2YWx1ZS4gIElmIHZhbHVlIGlzIGEgY29udGFpbmVyCiAgICB0eXBlLCB0aGVuIHJlbW92ZSBhIGxvdCBtb3JlIiIiCiAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgICMgTmVlZCBuYXRpdmUgc3RyIHR5cGUKICAgICAgICBuYXRpdmVfc3RyX3ZhbHVlID0gdmFsdWUKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICB2YWx1ZV9pc190ZXh0ID0gVHJ1ZQogICAgICAgICAgICBpZiBQWTI6CiAgICAgICAgICAgICAgICBuYXRpdmVfc3RyX3ZhbHVlID0gdG9fYnl0ZXModmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgIHZhbHVlX2lzX3RleHQgPSBGYWxzZQogICAgICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgICAgICBuYXRpdmVfc3RyX3ZhbHVlID0gdG9fdGV4dCh2YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKCiAgICAgICAgaWYgbmF0aXZlX3N0cl92YWx1ZSBpbiBub19sb2dfc3RyaW5nczoKICAgICAgICAgICAgcmV0dXJuICdWQUxVRV9TUEVDSUZJRURfSU5fTk9fTE9HX1BBUkFNRVRFUicKICAgICAgICBmb3Igb21pdF9tZSBpbiBub19sb2dfc3RyaW5nczoKICAgICAgICAgICAgbmF0aXZlX3N0cl92YWx1ZSA9IG5hdGl2ZV9zdHJfdmFsdWUucmVwbGFjZShvbWl0X21lLCAnKicgKiA4KQoKICAgICAgICBpZiB2YWx1ZV9pc190ZXh0IGFuZCBpc2luc3RhbmNlKG5hdGl2ZV9zdHJfdmFsdWUsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgdmFsdWUgPSB0b190ZXh0KG5hdGl2ZV9zdHJfdmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fcmVwbGFjZScpCiAgICAgICAgZWxpZiBub3QgdmFsdWVfaXNfdGV4dCBhbmQgaXNpbnN0YW5jZShuYXRpdmVfc3RyX3ZhbHVlLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICB2YWx1ZSA9IHRvX2J5dGVzKG5hdGl2ZV9zdHJfdmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fcmVwbGFjZScpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdmFsdWUgPSBuYXRpdmVfc3RyX3ZhbHVlCiAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIFNFUVVFTkNFVFlQRSk6CiAgICAgICAgcmV0dXJuIFtyZW1vdmVfdmFsdWVzKGVsZW0sIG5vX2xvZ19zdHJpbmdzKSBmb3IgZWxlbSBpbiB2YWx1ZV0KICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgTWFwcGluZyk6CiAgICAgICAgcmV0dXJuIGRpY3QoKGssIHJlbW92ZV92YWx1ZXModiwgbm9fbG9nX3N0cmluZ3MpKSBmb3IgaywgdiBpbiB2YWx1ZS5pdGVtcygpKQogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCB0dXBsZShjaGFpbihOVU1CRVJUWVBFUywgKGJvb2wsIE5vbmVUeXBlKSkpKToKICAgICAgICBzdHJpbmd5X3ZhbHVlID0gdG9fbmF0aXZlKHZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGlmIHN0cmluZ3lfdmFsdWUgaW4gbm9fbG9nX3N0cmluZ3M6CiAgICAgICAgICAgIHJldHVybiAnVkFMVUVfU1BFQ0lGSUVEX0lOX05PX0xPR19QQVJBTUVURVInCiAgICAgICAgZm9yIG9taXRfbWUgaW4gbm9fbG9nX3N0cmluZ3M6CiAgICAgICAgICAgIGlmIG9taXRfbWUgaW4gc3RyaW5neV92YWx1ZToKICAgICAgICAgICAgICAgIHJldHVybiAnVkFMVUVfU1BFQ0lGSUVEX0lOX05PX0xPR19QQVJBTUVURVInCiAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICB2YWx1ZSA9IHZhbHVlLmlzb2Zvcm1hdCgpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignVmFsdWUgb2YgdW5rbm93biB0eXBlOiAlcywgJXMnICUgKHR5cGUodmFsdWUpLCB2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWUKCgpkZWYgaGV1cmlzdGljX2xvZ19zYW5pdGl6ZShkYXRhLCBub19sb2dfdmFsdWVzPU5vbmUpOgogICAgJycnIFJlbW92ZSBzdHJpbmdzIHRoYXQgbG9vayBsaWtlIHBhc3N3b3JkcyBmcm9tIGxvZyBtZXNzYWdlcyAnJycKICAgICMgQ3VycmVudGx5IGZpbHRlcnM6CiAgICAjIHVzZXI6cGFzc0Bmb28vd2hhdGV2ZXIgYW5kIGh0dHA6Ly91c2VybmFtZTpwYXNzQHdoZXJldmVyL2ZvbwogICAgIyBUaGlzIGNvZGUgaGFzIGZhbHNlIHBvc2l0aXZlcyBhbmQgY29uc3VtZXMgcGFydHMgb2YgbG9ncyB0aGF0IGFyZQogICAgIyBub3QgcGFzc3dkcwoKICAgICMgYmVnaW46IHN0YXJ0IG9mIGEgcGFzc3dkIGNvbnRhaW5pbmcgc3RyaW5nCiAgICAjIGVuZDogZW5kIG9mIGEgcGFzc3dkIGNvbnRhaW5pbmcgc3RyaW5nCiAgICAjIHNlcDogY2hhciBiZXR3ZWVuIHVzZXIgYW5kIHBhc3N3ZAogICAgIyBwcmV2X2JlZ2luOiB3aGVyZSBpbiB0aGUgb3ZlcmFsbCBzdHJpbmcgdG8gc3RhcnQgYSBzZWFyY2ggZm9yCiAgICAjICAgYSBwYXNzd2QKICAgICMgc2VwX3NlYXJjaF9lbmQ6IHdoZXJlIGluIHRoZSBzdHJpbmcgdG8gZW5kIGEgc2VhcmNoIGZvciB0aGUgc2VwCiAgICBkYXRhID0gdG9fbmF0aXZlKGRhdGEpCgogICAgb3V0cHV0ID0gW10KICAgIGJlZ2luID0gbGVuKGRhdGEpCiAgICBwcmV2X2JlZ2luID0gYmVnaW4KICAgIHNlcCA9IDEKICAgIHdoaWxlIHNlcDoKICAgICAgICAjIEZpbmQgdGhlIHBvdGVudGlhbCBlbmQgb2YgYSBwYXNzd2QKICAgICAgICB0cnk6CiAgICAgICAgICAgIGVuZCA9IGRhdGEucmluZGV4KCdAJywgMCwgYmVnaW4pCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICMgTm8gcGFzc3dkIGluIHRoZSByZXN0IG9mIHRoZSBkYXRhCiAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgZGF0YVswOmJlZ2luXSkKICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgIyBTZWFyY2ggZm9yIHRoZSBiZWdpbm5pbmcgb2YgYSBwYXNzd2QKICAgICAgICBzZXAgPSBOb25lCiAgICAgICAgc2VwX3NlYXJjaF9lbmQgPSBlbmQKICAgICAgICB3aGlsZSBub3Qgc2VwOgogICAgICAgICAgICAjIFVSTC1zdHlsZSB1c2VybmFtZStwYXNzd29yZAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBiZWdpbiA9IGRhdGEucmluZGV4KCc6Ly8nLCAwLCBzZXBfc2VhcmNoX2VuZCkKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAjIE5vIHVybCBzdHlsZSBpbiB0aGUgZGF0YSwgY2hlY2sgZm9yIHNzaCBzdHlsZSBpbiB0aGUKICAgICAgICAgICAgICAgICMgcmVzdCBvZiB0aGUgc3RyaW5nCiAgICAgICAgICAgICAgICBiZWdpbiA9IDAKICAgICAgICAgICAgIyBTZWFyY2ggZm9yIHNlcGFyYXRvcgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZXAgPSBkYXRhLmluZGV4KCc6JywgYmVnaW4gKyAzLCBlbmQpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgIyBObyBzZXBhcmF0b3I7IGNob2ljZXM6CiAgICAgICAgICAgICAgICBpZiBiZWdpbiA9PSAwOgogICAgICAgICAgICAgICAgICAgICMgU2VhcmNoZWQgdGhlIHdob2xlIHN0cmluZyBzbyB0aGVyZSdzIG5vIHBhc3N3b3JkCiAgICAgICAgICAgICAgICAgICAgIyBoZXJlLiAgUmV0dXJuIHRoZSByZW1haW5pbmcgZGF0YQogICAgICAgICAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgZGF0YVswOmJlZ2luXSkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgIyBTZWFyY2ggZm9yIGEgZGlmZmVyZW50IGJlZ2lubmluZyBvZiB0aGUgcGFzc3dvcmQgZmllbGQuCiAgICAgICAgICAgICAgICBzZXBfc2VhcmNoX2VuZCA9IGJlZ2luCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgIGlmIHNlcDoKICAgICAgICAgICAgIyBQYXNzd29yZCB3YXMgZm91bmQ7IHJlbW92ZSBpdC4KICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCBkYXRhW2VuZDpwcmV2X2JlZ2luXSkKICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCAnKioqKioqKionKQogICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsIGRhdGFbYmVnaW46c2VwICsgMV0pCiAgICAgICAgICAgIHByZXZfYmVnaW4gPSBiZWdpbgoKICAgIG91dHB1dCA9ICcnLmpvaW4ob3V0cHV0KQogICAgaWYgbm9fbG9nX3ZhbHVlczoKICAgICAgICBvdXRwdXQgPSByZW1vdmVfdmFsdWVzKG91dHB1dCwgbm9fbG9nX3ZhbHVlcykKICAgIHJldHVybiBvdXRwdXQKCmRlZiBieXRlc190b19odW1hbihzaXplLCBpc2JpdHM9RmFsc2UsIHVuaXQ9Tm9uZSk6CgogICAgYmFzZSA9ICdCeXRlcycKICAgIGlmIGlzYml0czoKICAgICAgICBiYXNlID0gJ2JpdHMnCiAgICBzdWZmaXggPSAnJwoKICAgIGZvciBzdWZmaXgsIGxpbWl0IGluIHNvcnRlZChpdGVyaXRlbXMoU0laRV9SQU5HRVMpLCBrZXk9bGFtYmRhIGl0ZW06IC1pdGVtWzFdKToKICAgICAgICBpZiAodW5pdCBpcyBOb25lIGFuZCBzaXplID49IGxpbWl0KSBvciB1bml0IGlzIG5vdCBOb25lIGFuZCB1bml0LnVwcGVyKCkgPT0gc3VmZml4WzBdOgogICAgICAgICAgICBicmVhawoKICAgIGlmIGxpbWl0ICE9IDE6CiAgICAgICAgc3VmZml4ICs9IGJhc2VbMF0KICAgIGVsc2U6CiAgICAgICAgc3VmZml4ID0gYmFzZQoKICAgIHJldHVybiAnJS4yZiAlcycgJSAoZmxvYXQoc2l6ZSkvIGxpbWl0LCBzdWZmaXgpCgpkZWYgaHVtYW5fdG9fYnl0ZXMobnVtYmVyLCBkZWZhdWx0X3VuaXQ9Tm9uZSwgaXNiaXRzPUZhbHNlKToKCiAgICAnJycKICAgIENvbnZlcnQgbnVtYmVyIGluIHN0cmluZyBmb3JtYXQgaW50byBieXRlcyAoZXg6ICcySycgPT4gMjA0OCkgb3IgdXNpbmcgdW5pdCBhcmd1bWVudAogICAgZXg6CiAgICAgIGh1bWFuX3RvX2J5dGVzKCcxME0nKSA8PT4gaHVtYW5fdG9fYnl0ZXMoMTAsICdNJykKICAgICcnJwogICAgbSA9IHJlLnNlYXJjaCgnXlxzKihcZCpcLj9cZCopXHMqKFtBLVphLXpdKyk/Jywgc3RyKG51bWJlciksIGZsYWdzPXJlLklHTk9SRUNBU0UpCiAgICBpZiBtIGlzIE5vbmU6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaHVtYW5fdG9fYnl0ZXMoKSBjYW4ndCBpbnRlcnByZXQgZm9sbG93aW5nIHN0cmluZzogJXMiICUgc3RyKG51bWJlcikpCiAgICB0cnk6CiAgICAgICAgbnVtID0gZmxvYXQobS5ncm91cCgxKSkKICAgIGV4Y2VwdDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJodW1hbl90b19ieXRlcygpIGNhbid0IGludGVycHJldCBmb2xsb3dpbmcgbnVtYmVyOiAlcyAob3JpZ2luYWwgaW5wdXQgc3RyaW5nOiAlcykiICUgKG0uZ3JvdXAoMSksIG51bWJlcikpCgogICAgdW5pdCA9IG0uZ3JvdXAoMikKICAgIGlmIHVuaXQgaXMgTm9uZToKICAgICAgICB1bml0ID0gZGVmYXVsdF91bml0CgogICAgaWYgdW5pdCBpcyBOb25lOgogICAgICAgICcnJyBObyB1bml0IGdpdmVuLCByZXR1cm5pbmcgcmF3IG51bWJlciAnJycKICAgICAgICByZXR1cm4gaW50KHJvdW5kKG51bSkpCiAgICByYW5nZV9rZXkgPSB1bml0WzBdLnVwcGVyKCkKICAgIHRyeToKICAgICAgICBsaW1pdCA9IFNJWkVfUkFOR0VTW3JhbmdlX2tleV0KICAgIGV4Y2VwdDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJodW1hbl90b19ieXRlcygpIGZhaWxlZCB0byBjb252ZXJ0ICVzICh1bml0ID0gJXMpLiBUaGUgc3VmZml4IG11c3QgYmUgb25lIG9mICVzIiAlIChudW1iZXIsIHVuaXQsICIsICIuam9pbihTSVpFX1JBTkdFUy5rZXlzKCkpKSkKCiAgICAjIGRlZmF1bHQgdmFsdWUKICAgIHVuaXRfY2xhc3MgPSAnQicKICAgIHVuaXRfY2xhc3NfbmFtZSA9ICdieXRlJwogICAgIyBoYW5kbGluZyBiaXRzIGNhc2UKICAgIGlmIGlzYml0czoKICAgICAgICB1bml0X2NsYXNzID0gJ2InCiAgICAgICAgdW5pdF9jbGFzc19uYW1lID0gJ2JpdCcKICAgICMgY2hlY2sgdW5pdCB2YWx1ZSBpZiBtb3JlIHRoYW4gb25lIGNoYXJhY3RlciAoS0IsIE1CKQogICAgaWYgbGVuKHVuaXQpID4gMToKICAgICAgICBleHBlY3RfbWVzc2FnZSA9ICdleHBlY3QgJXMlcyBvciAlcycgJSAocmFuZ2Vfa2V5LCB1bml0X2NsYXNzLCByYW5nZV9rZXkpCiAgICAgICAgaWYgcmFuZ2Vfa2V5ID09ICdCJzoKICAgICAgICAgICAgZXhwZWN0X21lc3NhZ2UgPSAnZXhwZWN0ICVzIG9yICVzJyAlICh1bml0X2NsYXNzLCB1bml0X2NsYXNzX25hbWUpCgogICAgICAgIGlmIHVuaXRfY2xhc3NfbmFtZSBpbiB1bml0Lmxvd2VyKCk6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBlbGlmIHVuaXRbMV0gIT0gdW5pdF9jbGFzczoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaHVtYW5fdG9fYnl0ZXMoKSBmYWlsZWQgdG8gY29udmVydCAlcy4gVmFsdWUgaXMgbm90IGEgdmFsaWQgc3RyaW5nICglcykiICUgKG51bWJlciwgZXhwZWN0X21lc3NhZ2UpKQoKICAgIHJldHVybiBpbnQocm91bmQobnVtICogbGltaXQpKQoKZGVmIGlzX2V4ZWN1dGFibGUocGF0aCk6CiAgICAnJydpcyB0aGUgZ2l2ZW4gcGF0aCBleGVjdXRhYmxlPwoKICAgIExpbWl0YXRpb25zOgogICAgKiBEb2VzIG5vdCBhY2NvdW50IGZvciBGU0FDTHMuCiAgICAqIE1vc3QgdGltZXMgd2UgcmVhbGx5IHdhbnQgdG8ga25vdyAiQ2FuIHRoZSBjdXJyZW50IHVzZXIgZXhlY3V0ZSB0aGlzCiAgICAgIGZpbGUiICBUaGlzIGZ1bmN0aW9uIGRvZXMgbm90IHRlbGwgdXMgdGhhdCwgb25seSBpZiBhbiBleGVjdXRlIGJpdCBpcyBzZXQuCiAgICAnJycKICAgICMgVGhlc2UgYXJlIGFsbCBiaXRmaWVsZHMgc28gZmlyc3QgYml0d2lzZS1vciBhbGwgdGhlIHBlcm1pc3Npb25zIHdlJ3JlCiAgICAjIGxvb2tpbmcgZm9yLCB0aGVuIGJpdHdpc2UtYW5kIHdpdGggdGhlIGZpbGUncyBtb2RlIHRvIGRldGVybWluZSBpZiBhbnkKICAgICMgZXhlY3V0ZSBiaXRzIGFyZSBzZXQuCiAgICByZXR1cm4gKChzdGF0LlNfSVhVU1IgfCBzdGF0LlNfSVhHUlAgfCBzdGF0LlNfSVhPVEgpICYgb3Muc3RhdChwYXRoKVtzdGF0LlNUX01PREVdKQoKZGVmIF9sb2FkX3BhcmFtcygpOgogICAgJycnIHJlYWQgdGhlIG1vZHVsZXMgcGFyYW1ldGVycyBhbmQgc3RvcmUgdGhlbSBnbG9iYWxseS4KCiAgICBUaGlzIGZ1bmN0aW9uIG1heSBiZSBuZWVkZWQgZm9yIGNlcnRhaW4gdmVyeSBkeW5hbWljIGN1c3RvbSBtb2R1bGVzIHdoaWNoCiAgICB3YW50IHRvIHByb2Nlc3MgdGhlIHBhcmFtZXRlcnMgdGhhdCBhcmUgYmVpbmcgaGFuZGVkIHRoZSBtb2R1bGUuICBTaW5jZQogICAgdGhpcyBpcyBzbyBjbG9zZWx5IHRpZWQgdG8gdGhlIGltcGxlbWVudGF0aW9uIG9mIG1vZHVsZXMgd2UgY2Fubm90CiAgICBndWFyYW50ZWUgQVBJIHN0YWJpbGl0eSBmb3IgaXQgKGl0IG1heSBjaGFuZ2UgYmV0d2VlbiB2ZXJzaW9ucykgaG93ZXZlciB3ZQogICAgd2lsbCB0cnkgbm90IHRvIGJyZWFrIGl0IGdyYXR1aXRvdXNseS4gIEl0IGlzIGNlcnRhaW5seSBtb3JlIGZ1dHVyZS1wcm9vZgogICAgdG8gY2FsbCB0aGlzIGZ1bmN0aW9uIGFuZCBjb25zdW1lIGl0cyBvdXRwdXRzIHRoYW4gdG8gaW1wbGVtZW50IHRoZSBsb2dpYwogICAgaW5zaWRlIGl0IGFzIGEgY29weSBpbiB5b3VyIG93biBjb2RlLgogICAgJycnCiAgICBnbG9iYWwgX0FOU0lCTEVfQVJHUwogICAgaWYgX0FOU0lCTEVfQVJHUyBpcyBub3QgTm9uZToKICAgICAgICBidWZmZXIgPSBfQU5TSUJMRV9BUkdTCiAgICBlbHNlOgogICAgICAgICMgZGVidWcgb3ZlcnJpZGVzIHRvIHJlYWQgYXJncyBmcm9tIGZpbGUgb3IgY21kbGluZQoKICAgICAgICAjIEF2b2lkIHRyYWNlYmFja3Mgd2hlbiBsb2NhbGUgaXMgbm9uLXV0ZjgKICAgICAgICAjIFdlIGNvbnRyb2wgdGhlIGFyZ3MgYW5kIHdlIHBhc3MgdGhlbSBhcyB1dGY4CiAgICAgICAgaWYgbGVuKHN5cy5hcmd2KSA+IDE6CiAgICAgICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKHN5cy5hcmd2WzFdKToKICAgICAgICAgICAgICAgIGZkID0gb3BlbihzeXMuYXJndlsxXSwgJ3JiJykKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IGZkLnJlYWQoKQogICAgICAgICAgICAgICAgZmQuY2xvc2UoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYnVmZmVyID0gc3lzLmFyZ3ZbMV0KICAgICAgICAgICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBidWZmZXIuZW5jb2RlKCd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlZXNjYXBlJykKICAgICAgICAjIGRlZmF1bHQgY2FzZSwgcmVhZCBmcm9tIHN0ZGluCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgUFkyOgogICAgICAgICAgICAgICAgYnVmZmVyID0gc3lzLnN0ZGluLnJlYWQoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYnVmZmVyID0gc3lzLnN0ZGluLmJ1ZmZlci5yZWFkKCkKICAgICAgICBfQU5TSUJMRV9BUkdTID0gYnVmZmVyCgogICAgdHJ5OgogICAgICAgIHBhcmFtcyA9IGpzb24ubG9hZHMoYnVmZmVyLmRlY29kZSgndXRmLTgnKSkKICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICMgVGhpcyBoZWxwZXIgdXNlZCB0b28gZWFybHkgZm9yIGZhaWxfanNvbiB0byB3b3JrLgogICAgICAgIHByaW50KCdcbnsibXNnIjogIkVycm9yOiBNb2R1bGUgdW5hYmxlIHRvIGRlY29kZSB2YWxpZCBKU09OIG9uIHN0ZGluLiAgVW5hYmxlIHRvIGZpZ3VyZSBvdXQgd2hhdCBwYXJhbWV0ZXJzIHdlcmUgcGFzc2VkIiwgImZhaWxlZCI6IHRydWV9JykKICAgICAgICBzeXMuZXhpdCgxKQoKICAgIGlmIFBZMjoKICAgICAgICBwYXJhbXMgPSBqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcyhwYXJhbXMpCgogICAgdHJ5OgogICAgICAgIHJldHVybiBwYXJhbXNbJ0FOU0lCTEVfTU9EVUxFX0FSR1MnXQogICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICMgVGhpcyBoZWxwZXIgZG9lcyBub3QgaGF2ZSBhY2Nlc3MgdG8gZmFpbF9qc29uIHNvIHdlIGhhdmUgdG8gcHJpbnQKICAgICAgICAjIGpzb24gb3V0cHV0IG9uIG91ciBvd24uCiAgICAgICAgcHJpbnQoJ1xueyJtc2ciOiAiRXJyb3I6IE1vZHVsZSB1bmFibGUgdG8gbG9jYXRlIEFOU0lCTEVfTU9EVUxFX0FSR1MgaW4ganNvbiBkYXRhIGZyb20gc3RkaW4uICBVbmFibGUgdG8gZmlndXJlIG91dCB3aGF0IHBhcmFtZXRlcnMgd2VyZSBwYXNzZWQiLCAnCiAgICAgICAgICAgICAgJyJmYWlsZWQiOiB0cnVlfScpCiAgICAgICAgc3lzLmV4aXQoMSkKCmRlZiBlbnZfZmFsbGJhY2soKmFyZ3MsICoqa3dhcmdzKToKICAgICcnJyBMb2FkIHZhbHVlIGZyb20gZW52aXJvbm1lbnQgJycnCiAgICBmb3IgYXJnIGluIGFyZ3M6CiAgICAgICAgaWYgYXJnIGluIG9zLmVudmlyb246CiAgICAgICAgICAgIHJldHVybiBvcy5lbnZpcm9uW2FyZ10KICAgIGVsc2U6CiAgICAgICAgcmFpc2UgQW5zaWJsZUZhbGxiYWNrTm90Rm91bmQKCmRlZiBfbGVuaWVudF9sb3dlcmNhc2UobHN0KToKICAgICIiIkxvd2VyY2FzZSBlbGVtZW50cyBvZiBhIGxpc3QuCgogICAgSWYgYW4gZWxlbWVudCBpcyBub3QgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCB1bnRvdWNoZWQuCiAgICAiIiIKICAgIGxvd2VyZWQgPSBbXQogICAgZm9yIHZhbHVlIGluIGxzdDoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvd2VyZWQuYXBwZW5kKHZhbHVlLmxvd2VyKCkpCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICBsb3dlcmVkLmFwcGVuZCh2YWx1ZSkKICAgIHJldHVybiBsb3dlcmVkCgpkZWYgZm9ybWF0X2F0dHJpYnV0ZXMoYXR0cmlidXRlcyk6CiAgICBhdHRyaWJ1dGVfbGlzdCA9IFtdCiAgICBmb3IgYXR0ciBpbiBhdHRyaWJ1dGVzOgogICAgICAgIGlmIGF0dHIgaW4gRklMRV9BVFRSSUJVVEVTOgogICAgICAgICAgICBhdHRyaWJ1dGVfbGlzdC5hcHBlbmQoRklMRV9BVFRSSUJVVEVTW2F0dHJdKQogICAgcmV0dXJuIGF0dHJpYnV0ZV9saXN0CgpkZWYgZ2V0X2ZsYWdzX2Zyb21fYXR0cmlidXRlcyhhdHRyaWJ1dGVzKToKICAgIGZsYWdzID0gW10KICAgIGZvciBrZXksYXR0ciBpbiBGSUxFX0FUVFJJQlVURVMuaXRlbXMoKToKICAgICAgICBpZiBhdHRyIGluIGF0dHJpYnV0ZXM6CiAgICAgICAgICAgIGZsYWdzLmFwcGVuZChrZXkpCiAgICByZXR1cm4gJycuam9pbihmbGFncykKCmNsYXNzIEFuc2libGVGYWxsYmFja05vdEZvdW5kKEV4Y2VwdGlvbik6CiAgICBwYXNzCgoKY2xhc3MgQW5zaWJsZU1vZHVsZShvYmplY3QpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFyZ3VtZW50X3NwZWMsIGJ5cGFzc19jaGVja3M9RmFsc2UsIG5vX2xvZz1GYWxzZSwKICAgICAgICAgICAgICAgICBjaGVja19pbnZhbGlkX2FyZ3VtZW50cz1UcnVlLCBtdXR1YWxseV9leGNsdXNpdmU9Tm9uZSwgcmVxdWlyZWRfdG9nZXRoZXI9Tm9uZSwKICAgICAgICAgICAgICAgICByZXF1aXJlZF9vbmVfb2Y9Tm9uZSwgYWRkX2ZpbGVfY29tbW9uX2FyZ3M9RmFsc2UsIHN1cHBvcnRzX2NoZWNrX21vZGU9RmFsc2UsCiAgICAgICAgICAgICAgICAgcmVxdWlyZWRfaWY9Tm9uZSk6CgogICAgICAgICcnJwogICAgICAgIGNvbW1vbiBjb2RlIGZvciBxdWlja2x5IGJ1aWxkaW5nIGFuIGFuc2libGUgbW9kdWxlIGluIFB5dGhvbgogICAgICAgIChhbHRob3VnaCB5b3UgY2FuIHdyaXRlIG1vZHVsZXMgaW4gYW55dGhpbmcgdGhhdCBjYW4gcmV0dXJuIEpTT04pCiAgICAgICAgc2VlIGxpYnJhcnkvKiBmb3IgZXhhbXBsZXMKICAgICAgICAnJycKCiAgICAgICAgc2VsZi5fbmFtZSA9IG9zLnBhdGguYmFzZW5hbWUoX19maWxlX18pICNpbml0aWFsaXplIG5hbWUgdW50aWwgd2UgY2FuIHBhcnNlIGZyb20gb3B0aW9ucwogICAgICAgIHNlbGYuYXJndW1lbnRfc3BlYyA9IGFyZ3VtZW50X3NwZWMKICAgICAgICBzZWxmLnN1cHBvcnRzX2NoZWNrX21vZGUgPSBzdXBwb3J0c19jaGVja19tb2RlCiAgICAgICAgc2VsZi5jaGVja19tb2RlID0gRmFsc2UKICAgICAgICBzZWxmLm5vX2xvZyA9IG5vX2xvZwogICAgICAgIHNlbGYuY2xlYW51cF9maWxlcyA9IFtdCiAgICAgICAgc2VsZi5fZGVidWcgPSBGYWxzZQogICAgICAgIHNlbGYuX2RpZmYgPSBGYWxzZQogICAgICAgIHNlbGYuX3NvY2tldF9wYXRoID0gTm9uZQogICAgICAgIHNlbGYuX3ZlcmJvc2l0eSA9IDAKICAgICAgICAjIE1heSBiZSB1c2VkIHRvIHNldCBtb2RpZmljYXRpb25zIHRvIHRoZSBlbnZpcm9ubWVudCBmb3IgYW55CiAgICAgICAgIyBydW5fY29tbWFuZCBpbnZvY2F0aW9uCiAgICAgICAgc2VsZi5ydW5fY29tbWFuZF9lbnZpcm9uX3VwZGF0ZSA9IHt9CiAgICAgICAgc2VsZi5fd2FybmluZ3MgPSBbXQogICAgICAgIHNlbGYuX2RlcHJlY2F0aW9ucyA9IFtdCgogICAgICAgIHNlbGYuYWxpYXNlcyA9IHt9CiAgICAgICAgc2VsZi5fbGVnYWxfaW5wdXRzID0gWydfYW5zaWJsZV9jaGVja19tb2RlJywgJ19hbnNpYmxlX25vX2xvZycsICdfYW5zaWJsZV9kZWJ1ZycsICdfYW5zaWJsZV9kaWZmJywgJ19hbnNpYmxlX3ZlcmJvc2l0eScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdfYW5zaWJsZV9zZWxpbnV4X3NwZWNpYWxfZnMnLCAnX2Fuc2libGVfbW9kdWxlX25hbWUnLCAnX2Fuc2libGVfdmVyc2lvbicsICdfYW5zaWJsZV9zeXNsb2dfZmFjaWxpdHknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnX2Fuc2libGVfc29ja2V0J10KCiAgICAgICAgaWYgYWRkX2ZpbGVfY29tbW9uX2FyZ3M6CiAgICAgICAgICAgIGZvciBrLCB2IGluIEZJTEVfQ09NTU9OX0FSR1VNRU5UUy5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYgayBub3QgaW4gc2VsZi5hcmd1bWVudF9zcGVjOgogICAgICAgICAgICAgICAgICAgIHNlbGYuYXJndW1lbnRfc3BlY1trXSA9IHYKCiAgICAgICAgc2VsZi5fbG9hZF9wYXJhbXMoKQogICAgICAgIHNlbGYuX3NldF9mYWxsYmFja3MoKQoKICAgICAgICAjIGFwcGVuZCB0byBsZWdhbF9pbnB1dHMgYW5kIHRoZW4gcG9zc2libHkgY2hlY2sgYWdhaW5zdCB0aGVtCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmFsaWFzZXMgPSBzZWxmLl9oYW5kbGVfYWxpYXNlcygpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAjIFVzZSBleGNlcHRpb25zIGhlcmUgYmVjYXVzZSBpdCBpc24ndCBzYWZlIHRvIGNhbGwgZmFpbF9qc29uIHVudGlsIG5vX2xvZyBpcyBwcm9jZXNzZWQKICAgICAgICAgICAgcHJpbnQoJ1xueyJmYWlsZWQiOiB0cnVlLCAibXNnIjogIk1vZHVsZSBhbGlhcyBlcnJvcjogJXMifScgJSBzdHIoZSkpCiAgICAgICAgICAgIHN5cy5leGl0KDEpCgogICAgICAgICMgU2F2ZSBwYXJhbWV0ZXIgdmFsdWVzIHRoYXQgc2hvdWxkIG5ldmVyIGJlIGxvZ2dlZAogICAgICAgIHNlbGYubm9fbG9nX3ZhbHVlcyA9IHNldCgpCiAgICAgICAgIyBVc2UgdGhlIGFyZ3NwZWMgdG8gZGV0ZXJtaW5lIHdoaWNoIGFyZ3MgYXJlIG5vX2xvZwogICAgICAgIGZvciBhcmdfbmFtZSwgYXJnX29wdHMgaW4gc2VsZi5hcmd1bWVudF9zcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIGFyZ19vcHRzLmdldCgnbm9fbG9nJywgRmFsc2UpOgogICAgICAgICAgICAgICAgIyBGaW5kIHRoZSB2YWx1ZSBmb3IgdGhlIG5vX2xvZydkIHBhcmFtCiAgICAgICAgICAgICAgICBub19sb2dfb2JqZWN0ID0gc2VsZi5wYXJhbXMuZ2V0KGFyZ19uYW1lLCBOb25lKQogICAgICAgICAgICAgICAgaWYgbm9fbG9nX29iamVjdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLm5vX2xvZ192YWx1ZXMudXBkYXRlKHJldHVybl92YWx1ZXMobm9fbG9nX29iamVjdCkpCgogICAgICAgICAgICBpZiBhcmdfb3B0cy5nZXQoJ3JlbW92ZWRfaW5fdmVyc2lvbicpIGlzIG5vdCBOb25lIGFuZCBhcmdfbmFtZSBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgICAgIHNlbGYuX2RlcHJlY2F0aW9ucy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICdtc2cnOiAiUGFyYW0gJyVzJyBpcyBkZXByZWNhdGVkLiBTZWUgdGhlIG1vZHVsZSBkb2NzIGZvciBtb3JlIGluZm9ybWF0aW9uIiAlIGFyZ19uYW1lLAogICAgICAgICAgICAgICAgICAgICd2ZXJzaW9uJzogYXJnX29wdHMuZ2V0KCdyZW1vdmVkX2luX3ZlcnNpb24nKQogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgIyBjaGVjayB0aGUgbG9jYWxlIGFzIHNldCBieSB0aGUgY3VycmVudCBlbnZpcm9ubWVudCwgYW5kIHJlc2V0IHRvCiAgICAgICAgIyBhIGtub3duIHZhbGlkIChMQU5HPUMpIGlmIGl0J3MgYW4gaW52YWxpZC91bmF2YWlsYWJsZSBsb2NhbGUKICAgICAgICBzZWxmLl9jaGVja19sb2NhbGUoKQoKICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudHMoY2hlY2tfaW52YWxpZF9hcmd1bWVudHMpCgogICAgICAgICMgY2hlY2sgZXhjbHVzaXZlIGVhcmx5CiAgICAgICAgaWYgbm90IGJ5cGFzc19jaGVja3M6CiAgICAgICAgICAgIHNlbGYuX2NoZWNrX211dHVhbGx5X2V4Y2x1c2l2ZShtdXR1YWxseV9leGNsdXNpdmUpCgogICAgICAgIHNlbGYuX3NldF9kZWZhdWx0cyhwcmU9VHJ1ZSkKCiAgICAgICAgc2VsZi5fQ0hFQ0tfQVJHVU1FTlRfVFlQRVNfRElTUEFUQ0hFUiA9IHsKICAgICAgICAgICAgJ3N0cic6IHNlbGYuX2NoZWNrX3R5cGVfc3RyLAogICAgICAgICAgICAnbGlzdCc6IHNlbGYuX2NoZWNrX3R5cGVfbGlzdCwKICAgICAgICAgICAgJ2RpY3QnOiBzZWxmLl9jaGVja190eXBlX2RpY3QsCiAgICAgICAgICAgICdib29sJzogc2VsZi5fY2hlY2tfdHlwZV9ib29sLAogICAgICAgICAgICAnaW50Jzogc2VsZi5fY2hlY2tfdHlwZV9pbnQsCiAgICAgICAgICAgICdmbG9hdCc6IHNlbGYuX2NoZWNrX3R5cGVfZmxvYXQsCiAgICAgICAgICAgICdwYXRoJzogc2VsZi5fY2hlY2tfdHlwZV9wYXRoLAogICAgICAgICAgICAncmF3Jzogc2VsZi5fY2hlY2tfdHlwZV9yYXcsCiAgICAgICAgICAgICdqc29uYXJnJzogc2VsZi5fY2hlY2tfdHlwZV9qc29uYXJnLAogICAgICAgICAgICAnanNvbic6IHNlbGYuX2NoZWNrX3R5cGVfanNvbmFyZywKICAgICAgICAgICAgJ2J5dGVzJzogc2VsZi5fY2hlY2tfdHlwZV9ieXRlcywKICAgICAgICAgICAgJ2JpdHMnOiBzZWxmLl9jaGVja190eXBlX2JpdHMsCiAgICAgICAgfQogICAgICAgIGlmIG5vdCBieXBhc3NfY2hlY2tzOgogICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF9hcmd1bWVudHMoKQogICAgICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudF90eXBlcygpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50X3ZhbHVlcygpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX3RvZ2V0aGVyKHJlcXVpcmVkX3RvZ2V0aGVyKQogICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF9vbmVfb2YocmVxdWlyZWRfb25lX29mKQogICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF9pZihyZXF1aXJlZF9pZikKCiAgICAgICAgc2VsZi5fc2V0X2RlZmF1bHRzKHByZT1GYWxzZSkKCiAgICAgICAgaWYgbm90IHNlbGYubm9fbG9nOgogICAgICAgICAgICBzZWxmLl9sb2dfaW52b2NhdGlvbigpCgogICAgICAgICMgZmluYWxseSwgbWFrZSBzdXJlIHdlJ3JlIGluIGEgc2FuZSB3b3JraW5nIGRpcgogICAgICAgIHNlbGYuX3NldF9jd2QoKQoKICAgIGRlZiB3YXJuKHNlbGYsIHdhcm5pbmcpOgoKICAgICAgICBpZiBpc2luc3RhbmNlKHdhcm5pbmcsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHNlbGYuX3dhcm5pbmdzLmFwcGVuZCh3YXJuaW5nKQogICAgICAgICAgICBzZWxmLmxvZygnW1dBUk5JTkddICVzJyAlIHdhcm5pbmcpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJ3YXJuIHJlcXVpcmVzIGEgc3RyaW5nIG5vdCBhICVzIiAlIHR5cGUod2FybmluZykpCgogICAgZGVmIGRlcHJlY2F0ZShzZWxmLCBtc2csIHZlcnNpb249Tm9uZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZShtc2csIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHNlbGYuX2RlcHJlY2F0aW9ucy5hcHBlbmQoewogICAgICAgICAgICAgICAgJ21zZyc6IG1zZywKICAgICAgICAgICAgICAgICd2ZXJzaW9uJzogdmVyc2lvbgogICAgICAgICAgICB9KQogICAgICAgICAgICBzZWxmLmxvZygnW0RFUFJFQ0FUSU9OIFdBUk5JTkddICVzICVzJyAlIChtc2csIHZlcnNpb24pKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiZGVwcmVjYXRlIHJlcXVpcmVzIGEgc3RyaW5nIG5vdCBhICVzIiAlIHR5cGUobXNnKSkKCiAgICBkZWYgbG9hZF9maWxlX2NvbW1vbl9hcmd1bWVudHMoc2VsZiwgcGFyYW1zKToKICAgICAgICAnJycKICAgICAgICBtYW55IG1vZHVsZXMgZGVhbCB3aXRoIGZpbGVzLCB0aGlzIGVuY2Fwc3VsYXRlcyBjb21tb24KICAgICAgICBvcHRpb25zIHRoYXQgdGhlIGZpbGUgbW9kdWxlIGFjY2VwdHMgc3VjaCB0aGF0IGl0IGlzIGRpcmVjdGx5CiAgICAgICAgYXZhaWxhYmxlIHRvIGFsbCBtb2R1bGVzIGFuZCB0aGV5IGNhbiBzaGFyZSBjb2RlLgogICAgICAgICcnJwoKICAgICAgICBwYXRoID0gcGFyYW1zLmdldCgncGF0aCcsIHBhcmFtcy5nZXQoJ2Rlc3QnLCBOb25lKSkKICAgICAgICBpZiBwYXRoIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHBhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKHBhdGgpKQoKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgICMgaWYgdGhlIHBhdGggaXMgYSBzeW1saW5rLCBhbmQgd2UncmUgZm9sbG93aW5nIGxpbmtzLCBnZXQKICAgICAgICAjIHRoZSB0YXJnZXQgb2YgdGhlIGxpbmsgaW5zdGVhZCBmb3IgdGVzdGluZwogICAgICAgIGlmIHBhcmFtcy5nZXQoJ2ZvbGxvdycsIEZhbHNlKSBhbmQgb3MucGF0aC5pc2xpbmsoYl9wYXRoKToKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5yZWFscGF0aChiX3BhdGgpCiAgICAgICAgICAgIHBhdGggPSB0b19uYXRpdmUoYl9wYXRoKQoKICAgICAgICBtb2RlICAgPSBwYXJhbXMuZ2V0KCdtb2RlJywgTm9uZSkKICAgICAgICBvd25lciAgPSBwYXJhbXMuZ2V0KCdvd25lcicsIE5vbmUpCiAgICAgICAgZ3JvdXAgID0gcGFyYW1zLmdldCgnZ3JvdXAnLCBOb25lKQoKICAgICAgICAjIHNlbGludXggcmVsYXRlZCBvcHRpb25zCiAgICAgICAgc2V1c2VyICAgID0gcGFyYW1zLmdldCgnc2V1c2VyJywgTm9uZSkKICAgICAgICBzZXJvbGUgICAgPSBwYXJhbXMuZ2V0KCdzZXJvbGUnLCBOb25lKQogICAgICAgIHNldHlwZSAgICA9IHBhcmFtcy5nZXQoJ3NldHlwZScsIE5vbmUpCiAgICAgICAgc2VsZXZlbCAgID0gcGFyYW1zLmdldCgnc2VsZXZlbCcsIE5vbmUpCiAgICAgICAgc2Vjb250ZXh0ID0gW3NldXNlciwgc2Vyb2xlLCBzZXR5cGVdCgogICAgICAgIGlmIHNlbGYuc2VsaW51eF9tbHNfZW5hYmxlZCgpOgogICAgICAgICAgICBzZWNvbnRleHQuYXBwZW5kKHNlbGV2ZWwpCgogICAgICAgIGRlZmF1bHRfc2Vjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2RlZmF1bHRfY29udGV4dChwYXRoKQogICAgICAgIGZvciBpIGluIHJhbmdlKGxlbihkZWZhdWx0X3NlY29udGV4dCkpOgogICAgICAgICAgICBpZiBpIGlzIG5vdCBOb25lIGFuZCBzZWNvbnRleHRbaV0gPT0gJ19kZWZhdWx0JzoKICAgICAgICAgICAgICAgIHNlY29udGV4dFtpXSA9IGRlZmF1bHRfc2Vjb250ZXh0W2ldCgogICAgICAgIGF0dHJpYnV0ZXMgPSBwYXJhbXMuZ2V0KCdhdHRyaWJ1dGVzJywgTm9uZSkKICAgICAgICByZXR1cm4gZGljdCgKICAgICAgICAgICAgcGF0aD1wYXRoLCBtb2RlPW1vZGUsIG93bmVyPW93bmVyLCBncm91cD1ncm91cCwKICAgICAgICAgICAgc2V1c2VyPXNldXNlciwgc2Vyb2xlPXNlcm9sZSwgc2V0eXBlPXNldHlwZSwKICAgICAgICAgICAgc2VsZXZlbD1zZWxldmVsLCBzZWNvbnRleHQ9c2Vjb250ZXh0LCBhdHRyaWJ1dGVzPWF0dHJpYnV0ZXMsCiAgICAgICAgKQoKCiAgICAjIERldGVjdCB3aGV0aGVyIHVzaW5nIHNlbGludXggdGhhdCBpcyBNTFMtYXdhcmUuCiAgICAjIFdoaWxlIHRoaXMgbWVhbnMgeW91IGNhbiBzZXQgdGhlIGxldmVsL3JhbmdlIHdpdGgKICAgICMgc2VsaW51eC5sc2V0ZmlsZWNvbigpLCBpdCBtYXkgb3IgbWF5IG5vdCBtZWFuIHRoYXQgeW91CiAgICAjIHdpbGwgZ2V0IHRoZSBzZWxldmVsIGFzIHBhcnQgb2YgdGhlIGNvbnRleHQgcmV0dXJuZWQKICAgICMgYnkgc2VsaW51eC5sZ2V0ZmlsZWNvbigpLgoKICAgIGRlZiBzZWxpbnV4X21sc19lbmFibGVkKHNlbGYpOgogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVg6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGlmIHNlbGludXguaXNfc2VsaW51eF9tbHNfZW5hYmxlZCgpID09IDE6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHNlbGludXhfZW5hYmxlZChzZWxmKToKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYOgogICAgICAgICAgICBzZWVuYWJsZWQgPSBzZWxmLmdldF9iaW5fcGF0aCgnc2VsaW51eGVuYWJsZWQnKQogICAgICAgICAgICBpZiBzZWVuYWJsZWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAocmMsb3V0LGVycikgPSBzZWxmLnJ1bl9jb21tYW5kKHNlZW5hYmxlZCkKICAgICAgICAgICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJBYm9ydGluZywgdGFyZ2V0IHVzZXMgc2VsaW51eCBidXQgcHl0aG9uIGJpbmRpbmdzIChsaWJzZWxpbnV4LXB5dGhvbikgYXJlbid0IGluc3RhbGxlZCEiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBpZiBzZWxpbnV4LmlzX3NlbGludXhfZW5hYmxlZCgpID09IDE6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgIyBEZXRlcm1pbmUgd2hldGhlciB3ZSBuZWVkIGEgcGxhY2Vob2xkZXIgZm9yIHNlbGV2ZWwvbWxzCiAgICBkZWYgc2VsaW51eF9pbml0aWFsX2NvbnRleHQoc2VsZik6CiAgICAgICAgY29udGV4dCA9IFtOb25lLCBOb25lLCBOb25lXQogICAgICAgIGlmIHNlbGYuc2VsaW51eF9tbHNfZW5hYmxlZCgpOgogICAgICAgICAgICBjb250ZXh0LmFwcGVuZChOb25lKQogICAgICAgIHJldHVybiBjb250ZXh0CgogICAgIyBJZiBzZWxpbnV4IGZhaWxzIHRvIGZpbmQgYSBkZWZhdWx0LCByZXR1cm4gYW4gYXJyYXkgb2YgTm9uZQogICAgZGVmIHNlbGludXhfZGVmYXVsdF9jb250ZXh0KHNlbGYsIHBhdGgsIG1vZGU9MCk6CiAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9pbml0aWFsX2NvbnRleHQoKQogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVggb3Igbm90IHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXQgPSBzZWxpbnV4Lm1hdGNocGF0aGNvbih0b19uYXRpdmUocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JyksIG1vZGUpCiAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgaWYgcmV0WzBdID09IC0xOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgICMgTGltaXQgc3BsaXQgdG8gNCBiZWNhdXNlIHRoZSBzZWxldmVsLCB0aGUgbGFzdCBpbiB0aGUgbGlzdCwKICAgICAgICAjIG1heSBjb250YWluICc6JyBjaGFyYWN0ZXJzCiAgICAgICAgY29udGV4dCA9IHJldFsxXS5zcGxpdCgnOicsIDMpCiAgICAgICAgcmV0dXJuIGNvbnRleHQKCiAgICBkZWYgc2VsaW51eF9jb250ZXh0KHNlbGYsIHBhdGgpOgogICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfaW5pdGlhbF9jb250ZXh0KCkKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYIG9yIG5vdCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0ID0gc2VsaW51eC5sZ2V0ZmlsZWNvbl9yYXcodG9fbmF0aXZlKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpKQogICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIGlmIGUuZXJybm8gPT0gZXJybm8uRU5PRU5UOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J3BhdGggJXMgZG9lcyBub3QgZXhpc3QnICUgcGF0aCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdmYWlsZWQgdG8gcmV0cmlldmUgc2VsaW51eCBjb250ZXh0JykKICAgICAgICBpZiByZXRbMF0gPT0gLTE6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgIyBMaW1pdCBzcGxpdCB0byA0IGJlY2F1c2UgdGhlIHNlbGV2ZWwsIHRoZSBsYXN0IGluIHRoZSBsaXN0LAogICAgICAgICMgbWF5IGNvbnRhaW4gJzonIGNoYXJhY3RlcnMKICAgICAgICBjb250ZXh0ID0gcmV0WzFdLnNwbGl0KCc6JywgMykKICAgICAgICByZXR1cm4gY29udGV4dAoKICAgIGRlZiB1c2VyX2FuZF9ncm91cChzZWxmLCBwYXRoLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHN0ID0gb3MubHN0YXQoYl9wYXRoKQogICAgICAgIHVpZCA9IHN0LnN0X3VpZAogICAgICAgIGdpZCA9IHN0LnN0X2dpZAogICAgICAgIHJldHVybiAodWlkLCBnaWQpCgogICAgZGVmIGZpbmRfbW91bnRfcG9pbnQoc2VsZiwgcGF0aCk6CiAgICAgICAgcGF0aF9pc19ieXRlcyA9IEZhbHNlCiAgICAgICAgaWYgaXNpbnN0YW5jZShwYXRoLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgIHBhdGhfaXNfYnl0ZXMgPSBUcnVlCgogICAgICAgIGJfcGF0aCA9IG9zLnBhdGgucmVhbHBhdGgodG9fYnl0ZXMob3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhwYXRoKSksIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpKQogICAgICAgIHdoaWxlIG5vdCBvcy5wYXRoLmlzbW91bnQoYl9wYXRoKToKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5kaXJuYW1lKGJfcGF0aCkKCiAgICAgICAgaWYgcGF0aF9pc19ieXRlczoKICAgICAgICAgICAgcmV0dXJuIGJfcGF0aAoKICAgICAgICByZXR1cm4gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCgogICAgZGVmIGlzX3NwZWNpYWxfc2VsaW51eF9wYXRoKHNlbGYsIHBhdGgpOgogICAgICAgICIiIgogICAgICAgIFJldHVybnMgYSB0dXBsZSBjb250YWluaW5nIChUcnVlLCBzZWxpbnV4X2NvbnRleHQpIGlmIHRoZSBnaXZlbiBwYXRoIGlzIG9uIGEKICAgICAgICBORlMgb3Igb3RoZXIgJ3NwZWNpYWwnIGZzICBtb3VudCBwb2ludCwgb3RoZXJ3aXNlIHRoZSByZXR1cm4gd2lsbCBiZSAoRmFsc2UsIE5vbmUpLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgZiA9IG9wZW4oJy9wcm9jL21vdW50cycsICdyJykKICAgICAgICAgICAgbW91bnRfZGF0YSA9IGYucmVhZGxpbmVzKCkKICAgICAgICAgICAgZi5jbG9zZSgpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4gKEZhbHNlLCBOb25lKQogICAgICAgIHBhdGhfbW91bnRfcG9pbnQgPSBzZWxmLmZpbmRfbW91bnRfcG9pbnQocGF0aCkKICAgICAgICBmb3IgbGluZSBpbiBtb3VudF9kYXRhOgogICAgICAgICAgICAoZGV2aWNlLCBtb3VudF9wb2ludCwgZnN0eXBlLCBvcHRpb25zLCByZXN0KSA9IGxpbmUuc3BsaXQoJyAnLCA0KQoKICAgICAgICAgICAgaWYgcGF0aF9tb3VudF9wb2ludCA9PSBtb3VudF9wb2ludDoKICAgICAgICAgICAgICAgIGZvciBmcyBpbiBzZWxmLl9zZWxpbnV4X3NwZWNpYWxfZnM6CiAgICAgICAgICAgICAgICAgICAgaWYgZnMgaW4gZnN0eXBlOgogICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWFsX2NvbnRleHQgPSBzZWxmLnNlbGludXhfY29udGV4dChwYXRoX21vdW50X3BvaW50KQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKFRydWUsIHNwZWNpYWxfY29udGV4dCkKCiAgICAgICAgcmV0dXJuIChGYWxzZSwgTm9uZSkKCiAgICBkZWYgc2V0X2RlZmF1bHRfc2VsaW51eF9jb250ZXh0KHNlbGYsIHBhdGgsIGNoYW5nZWQpOgogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVggb3Igbm90IHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCiAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9kZWZhdWx0X2NvbnRleHQocGF0aCkKICAgICAgICByZXR1cm4gc2VsZi5zZXRfY29udGV4dF9pZl9kaWZmZXJlbnQocGF0aCwgY29udGV4dCwgRmFsc2UpCgogICAgZGVmIHNldF9jb250ZXh0X2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBjb250ZXh0LCBjaGFuZ2VkLCBkaWZmPU5vbmUpOgoKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYIG9yIG5vdCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAogICAgICAgIGN1cl9jb250ZXh0ID0gc2VsZi5zZWxpbnV4X2NvbnRleHQocGF0aCkKICAgICAgICBuZXdfY29udGV4dCA9IGxpc3QoY3VyX2NvbnRleHQpCiAgICAgICAgIyBJdGVyYXRlIG92ZXIgdGhlIGN1cnJlbnQgY29udGV4dCBpbnN0ZWFkIG9mIHRoZQogICAgICAgICMgYXJndW1lbnQgY29udGV4dCwgd2hpY2ggbWF5IGhhdmUgc2VsZXZlbC4KCiAgICAgICAgKGlzX3NwZWNpYWxfc2UsIHNwX2NvbnRleHQpID0gc2VsZi5pc19zcGVjaWFsX3NlbGludXhfcGF0aChwYXRoKQogICAgICAgIGlmIGlzX3NwZWNpYWxfc2U6CiAgICAgICAgICAgIG5ld19jb250ZXh0ID0gc3BfY29udGV4dAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKGxlbihjdXJfY29udGV4dCkpOgogICAgICAgICAgICAgICAgaWYgbGVuKGNvbnRleHQpID4gaToKICAgICAgICAgICAgICAgICAgICBpZiBjb250ZXh0W2ldIGlzIG5vdCBOb25lIGFuZCBjb250ZXh0W2ldICE9IGN1cl9jb250ZXh0W2ldOgogICAgICAgICAgICAgICAgICAgICAgICBuZXdfY29udGV4dFtpXSA9IGNvbnRleHRbaV0KICAgICAgICAgICAgICAgICAgICBlbGlmIGNvbnRleHRbaV0gaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2NvbnRleHRbaV0gPSBjdXJfY29udGV4dFtpXQoKICAgICAgICBpZiBjdXJfY29udGV4dCAhPSBuZXdfY29udGV4dDoKICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmICdiZWZvcmUnIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydzZWNvbnRleHQnXSA9IGN1cl9jb250ZXh0CiAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnc2Vjb250ZXh0J10gPSBuZXdfY29udGV4dAoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICByYyA9IHNlbGludXgubHNldGZpbGVjb24odG9fbmF0aXZlKHBhdGgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cignOicuam9pbihuZXdfY29udGV4dCkpKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdpbnZhbGlkIHNlbGludXggY29udGV4dDogJXMnICUgc3RyKGUpLCBuZXdfY29udGV4dD1uZXdfY29udGV4dCwgY3VyX2NvbnRleHQ9Y3VyX2NvbnRleHQsIGlucHV0X3dhcz1jb250ZXh0KQogICAgICAgICAgICBpZiByYyAhPSAwOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J3NldCBzZWxpbnV4IGNvbnRleHQgZmFpbGVkJykKICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfb3duZXJfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIG93bmVyLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgcGF0aCA9IHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgb3duZXIgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKICAgICAgICBvcmlnX3VpZCwgb3JpZ19naWQgPSBzZWxmLnVzZXJfYW5kX2dyb3VwKHBhdGgsIGV4cGFuZCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHVpZCA9IGludChvd25lcikKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdWlkID0gcHdkLmdldHB3bmFtKG93bmVyKS5wd191aWQKICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2Nob3duIGZhaWxlZDogZmFpbGVkIHRvIGxvb2sgdXAgdXNlciAlcycgJSBvd25lcikKICAgICAgICBpZiBvcmlnX3VpZCAhPSB1aWQ6CgogICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ293bmVyJ10gPSBvcmlnX3VpZAogICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ293bmVyJ10gPSB1aWQKCiAgICAgICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLmxjaG93bihiX3BhdGgsIHVpZCwgLTEpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2Nob3duIGZhaWxlZCcpCiAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X2dyb3VwX2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBncm91cCwgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHBhdGggPSB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGdyb3VwIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCiAgICAgICAgb3JpZ191aWQsIG9yaWdfZ2lkID0gc2VsZi51c2VyX2FuZF9ncm91cChiX3BhdGgsIGV4cGFuZCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGdpZCA9IGludChncm91cCkKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZ2lkID0gZ3JwLmdldGdybmFtKGdyb3VwKS5ncl9naWQKICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2NoZ3JwIGZhaWxlZDogZmFpbGVkIHRvIGxvb2sgdXAgZ3JvdXAgJXMnICUgZ3JvdXApCiAgICAgICAgaWYgb3JpZ19naWQgIT0gZ2lkOgoKICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmICdiZWZvcmUnIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydncm91cCddID0gb3JpZ19naWQKICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydncm91cCddID0gZ2lkCgogICAgICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5sY2hvd24oYl9wYXRoLCAtMSwgZ2lkKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaGdycCBmYWlsZWQnKQogICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9tb2RlX2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBtb2RlLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgcGF0aCA9IHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgcGF0aF9zdGF0ID0gb3MubHN0YXQoYl9wYXRoKQoKICAgICAgICBpZiBtb2RlIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG1vZGUsIGludCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG1vZGUgPSBpbnQobW9kZSwgOCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBtb2RlID0gc2VsZi5fc3ltYm9saWNfbW9kZV90b19vY3RhbChwYXRoX3N0YXQsIG1vZGUpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnPSJtb2RlIG11c3QgYmUgaW4gb2N0YWwgb3Igc3ltYm9saWMgZm9ybSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlscz1zdHIoZSkpCgogICAgICAgICAgICAgICAgaWYgbW9kZSAhPSBzdGF0LlNfSU1PREUobW9kZSk6CiAgICAgICAgICAgICAgICAgICAgIyBwcmV2ZW50IG1vZGUgZnJvbSBoYXZpbmcgZXh0cmEgaW5mbyBvcmJlaW5nIGludmFsaWQgbG9uZyBudW1iZXIKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0iSW52YWxpZCBtb2RlIHN1cHBsaWVkLCBvbmx5IHBlcm1pc3Npb24gaW5mbyBpcyBhbGxvd2VkIiwgZGV0YWlscz1tb2RlKQoKICAgICAgICBwcmV2X21vZGUgPSBzdGF0LlNfSU1PREUocGF0aF9zdGF0LnN0X21vZGUpCgogICAgICAgIGlmIHByZXZfbW9kZSAhPSBtb2RlOgoKICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmICdiZWZvcmUnIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydtb2RlJ10gPSAnMCUwM28nICUgcHJldl9tb2RlCiAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnbW9kZSddID0gJzAlMDNvJyAlIG1vZGUKCiAgICAgICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICMgRklYTUU6IGNvbXBhcmlzb24gYWdhaW5zdCBzdHJpbmcgYWJvdmUgd2lsbCBjYXVzZSB0aGlzIHRvIGJlIGV4ZWN1dGVkCiAgICAgICAgICAgICMgZXZlcnkgdGltZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKG9zLCAnbGNobW9kJyk6CiAgICAgICAgICAgICAgICAgICAgb3MubGNobW9kKGJfcGF0aCwgbW9kZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguaXNsaW5rKGJfcGF0aCk6CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNobW9kKGJfcGF0aCwgbW9kZSkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIEF0dGVtcHQgdG8gc2V0IHRoZSBwZXJtcyBvZiB0aGUgc3ltbGluayBidXQgYmUKICAgICAgICAgICAgICAgICAgICAgICAgIyBjYXJlZnVsIG5vdCB0byBjaGFuZ2UgdGhlIHBlcm1zIG9mIHRoZSB1bmRlcmx5aW5nCiAgICAgICAgICAgICAgICAgICAgICAgICMgZmlsZSB3aGlsZSB0cnlpbmcKICAgICAgICAgICAgICAgICAgICAgICAgdW5kZXJseWluZ19zdGF0ID0gb3Muc3RhdChiX3BhdGgpCiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNobW9kKGJfcGF0aCwgbW9kZSkKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X3VuZGVybHlpbmdfc3RhdCA9IG9zLnN0YXQoYl9wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiB1bmRlcmx5aW5nX3N0YXQuc3RfbW9kZSAhPSBuZXdfdW5kZXJseWluZ19zdGF0LnN0X21vZGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy5jaG1vZChiX3BhdGgsIHN0YXQuU19JTU9ERSh1bmRlcmx5aW5nX3N0YXQuc3RfbW9kZSkpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5pc2xpbmsoYl9wYXRoKSBhbmQgZS5lcnJubyA9PSBlcnJuby5FUEVSTTogICMgQ2FuJ3Qgc2V0IG1vZGUgb24gc3ltYm9saWMgbGlua3MKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBlbGlmIGUuZXJybm8gaW4gKGVycm5vLkVOT0VOVCwgZXJybm8uRUxPT1ApOiAjIENhbid0IHNldCBtb2RlIG9uIGJyb2tlbiBzeW1ib2xpYyBsaW5rcwogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2NobW9kIGZhaWxlZCcsIGRldGFpbHM9c3RyKGUpKQoKICAgICAgICAgICAgcGF0aF9zdGF0ID0gb3MubHN0YXQoYl9wYXRoKQogICAgICAgICAgICBuZXdfbW9kZSA9IHN0YXQuU19JTU9ERShwYXRoX3N0YXQuc3RfbW9kZSkKCiAgICAgICAgICAgIGlmIG5ld19tb2RlICE9IHByZXZfbW9kZToKICAgICAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIGF0dHJpYnV0ZXMsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgoKICAgICAgICBpZiBhdHRyaWJ1dGVzIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBwYXRoID0gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKCiAgICAgICAgZXhpc3RpbmcgPSBzZWxmLmdldF9maWxlX2F0dHJpYnV0ZXMoYl9wYXRoKQoKICAgICAgICBpZiBleGlzdGluZy5nZXQoJ2F0dHJfZmxhZ3MnLCcnKSAhPSBhdHRyaWJ1dGVzOgogICAgICAgICAgICBhdHRyY21kID0gc2VsZi5nZXRfYmluX3BhdGgoJ2NoYXR0cicpCiAgICAgICAgICAgIGlmIGF0dHJjbWQ6CiAgICAgICAgICAgICAgICBhdHRyY21kID0gW2F0dHJjbWQsICc9JXMnICUgYXR0cmlidXRlcywgYl9wYXRoXQogICAgICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKCiAgICAgICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIGlmICdiZWZvcmUnIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ2F0dHJpYnV0ZXMnXSA9IGV4aXN0aW5nLmdldCgnYXR0cl9mbGFncycpCiAgICAgICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnYXR0cmlidXRlcyddID0gYXR0cmlidXRlcwoKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLnJ1bl9jb21tYW5kKGF0dHJjbWQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJjICE9IDAgb3IgZXJyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJFcnJvciB3aGlsZSBzZXR0aW5nIGF0dHJpYnV0ZXM6ICVzIiAlIChvdXQgKyBlcnIpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hhdHRyIGZhaWxlZCcsIGRldGFpbHM9c3RyKGUpKQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIGdldF9maWxlX2F0dHJpYnV0ZXMoc2VsZiwgcGF0aCk6CiAgICAgICAgb3V0cHV0ID0ge30KICAgICAgICBhdHRyY21kID0gc2VsZi5nZXRfYmluX3BhdGgoJ2xzYXR0cicsIEZhbHNlKQogICAgICAgIGlmIGF0dHJjbWQ6CiAgICAgICAgICAgIGF0dHJjbWQgPSBbYXR0cmNtZCwgJy12ZCcsIHBhdGhdCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYucnVuX2NvbW1hbmQoYXR0cmNtZCkKICAgICAgICAgICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgICAgICAgICAgcmVzID0gb3V0LnNwbGl0KCcgJylbMDoyXQogICAgICAgICAgICAgICAgICAgIG91dHB1dFsnYXR0cl9mbGFncyddID0gIHJlc1sxXS5yZXBsYWNlKCctJywnJykuc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIG91dHB1dFsndmVyc2lvbiddID0gcmVzWzBdLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBvdXRwdXRbJ2F0dHJpYnV0ZXMnXSA9IGZvcm1hdF9hdHRyaWJ1dGVzKG91dHB1dFsnYXR0cl9mbGFncyddKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIG91dHB1dAoKCiAgICBkZWYgX3N5bWJvbGljX21vZGVfdG9fb2N0YWwoc2VsZiwgcGF0aF9zdGF0LCBzeW1ib2xpY19tb2RlKToKICAgICAgICBuZXdfbW9kZSA9IHN0YXQuU19JTU9ERShwYXRoX3N0YXQuc3RfbW9kZSkKCiAgICAgICAgbW9kZV9yZSA9IHJlLmNvbXBpbGUocideKD9QPHVzZXJzPlt1Z29hXSspKD9QPG9wZXJhdG9yPlstKz1dKSg/UDxwZXJtcz5bcnd4WHN0LV0qfFt1Z29dKSQnKQogICAgICAgIGZvciBtb2RlIGluIHN5bWJvbGljX21vZGUuc3BsaXQoJywnKToKICAgICAgICAgICAgbWF0Y2ggPSBtb2RlX3JlLm1hdGNoKG1vZGUpCiAgICAgICAgICAgIGlmIG1hdGNoOgogICAgICAgICAgICAgICAgdXNlcnMgPSBtYXRjaC5ncm91cCgndXNlcnMnKQogICAgICAgICAgICAgICAgb3BlcmF0b3IgPSBtYXRjaC5ncm91cCgnb3BlcmF0b3InKQogICAgICAgICAgICAgICAgcGVybXMgPSBtYXRjaC5ncm91cCgncGVybXMnKQoKICAgICAgICAgICAgICAgIGlmIHVzZXJzID09ICdhJzoKICAgICAgICAgICAgICAgICAgICB1c2VycyA9ICd1Z28nCgogICAgICAgICAgICAgICAgZm9yIHVzZXIgaW4gdXNlcnM6CiAgICAgICAgICAgICAgICAgICAgbW9kZV90b19hcHBseSA9IHNlbGYuX2dldF9vY3RhbF9tb2RlX2Zyb21fc3ltYm9saWNfcGVybXMocGF0aF9zdGF0LCB1c2VyLCBwZXJtcykKICAgICAgICAgICAgICAgICAgICBuZXdfbW9kZSA9IHNlbGYuX2FwcGx5X29wZXJhdGlvbl90b19tb2RlKHVzZXIsIG9wZXJhdG9yLCBtb2RlX3RvX2FwcGx5LCBuZXdfbW9kZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImJhZCBzeW1ib2xpYyBwZXJtaXNzaW9uIGZvciBtb2RlOiAlcyIgJSBtb2RlKQogICAgICAgIHJldHVybiBuZXdfbW9kZQoKICAgIGRlZiBfYXBwbHlfb3BlcmF0aW9uX3RvX21vZGUoc2VsZiwgdXNlciwgb3BlcmF0b3IsIG1vZGVfdG9fYXBwbHksIGN1cnJlbnRfbW9kZSk6CiAgICAgICAgaWYgb3BlcmF0b3IgID09ICAnPSc6CiAgICAgICAgICAgIGlmIHVzZXIgPT0gJ3UnOgogICAgICAgICAgICAgICAgbWFzayA9IHN0YXQuU19JUldYVSB8IHN0YXQuU19JU1VJRAogICAgICAgICAgICBlbGlmIHVzZXIgPT0gJ2cnOgogICAgICAgICAgICAgICAgbWFzayA9IHN0YXQuU19JUldYRyB8IHN0YXQuU19JU0dJRAogICAgICAgICAgICBlbGlmIHVzZXIgPT0gJ28nOgogICAgICAgICAgICAgICAgbWFzayA9IHN0YXQuU19JUldYTyB8IHN0YXQuU19JU1ZUWAoKICAgICAgICAgICAgIyBtYXNrIG91dCB1LCBnLCBvciBvIHBlcm1pc3Npb25zIGZyb20gY3VycmVudF9tb2RlIGFuZCBhcHBseSBuZXcgcGVybWlzc2lvbnMKICAgICAgICAgICAgaW52ZXJzZV9tYXNrID0gbWFzayBeIFBFUk1fQklUUwogICAgICAgICAgICBuZXdfbW9kZSA9IChjdXJyZW50X21vZGUgJiBpbnZlcnNlX21hc2spIHwgbW9kZV90b19hcHBseQogICAgICAgIGVsaWYgb3BlcmF0b3IgPT0gJysnOgogICAgICAgICAgICBuZXdfbW9kZSA9IGN1cnJlbnRfbW9kZSB8IG1vZGVfdG9fYXBwbHkKICAgICAgICBlbGlmIG9wZXJhdG9yID09ICctJzoKICAgICAgICAgICAgbmV3X21vZGUgPSBjdXJyZW50X21vZGUgLSAoY3VycmVudF9tb2RlICYgbW9kZV90b19hcHBseSkKICAgICAgICByZXR1cm4gbmV3X21vZGUKCiAgICBkZWYgX2dldF9vY3RhbF9tb2RlX2Zyb21fc3ltYm9saWNfcGVybXMoc2VsZiwgcGF0aF9zdGF0LCB1c2VyLCBwZXJtcyk6CiAgICAgICAgcHJldl9tb2RlID0gc3RhdC5TX0lNT0RFKHBhdGhfc3RhdC5zdF9tb2RlKQoKICAgICAgICBpc19kaXJlY3RvcnkgPSBzdGF0LlNfSVNESVIocGF0aF9zdGF0LnN0X21vZGUpCiAgICAgICAgaGFzX3hfcGVybWlzc2lvbnMgPSAocHJldl9tb2RlICYgRVhFQ19QRVJNX0JJVFMpID4gMAogICAgICAgIGFwcGx5X1hfcGVybWlzc2lvbiA9IGlzX2RpcmVjdG9yeSBvciBoYXNfeF9wZXJtaXNzaW9ucwoKICAgICAgICAjIFBlcm1pc3Npb24gYml0cyBjb25zdGFudHMgZG9jdW1lbnRlZCBhdDoKICAgICAgICAjIGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvMi9saWJyYXJ5L3N0YXQuaHRtbCNzdGF0LlNfSVNVSUQKICAgICAgICBpZiBhcHBseV9YX3Blcm1pc3Npb246CiAgICAgICAgICAgIFhfcGVybXMgPSB7CiAgICAgICAgICAgICAgICAndSc6IHsnWCc6IHN0YXQuU19JWFVTUn0sCiAgICAgICAgICAgICAgICAnZyc6IHsnWCc6IHN0YXQuU19JWEdSUH0sCiAgICAgICAgICAgICAgICAnbyc6IHsnWCc6IHN0YXQuU19JWE9USH0KICAgICAgICAgICAgfQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIFhfcGVybXMgPSB7CiAgICAgICAgICAgICAgICAndSc6IHsnWCc6IDB9LAogICAgICAgICAgICAgICAgJ2cnOiB7J1gnOiAwfSwKICAgICAgICAgICAgICAgICdvJzogeydYJzogMH0KICAgICAgICAgICAgfQoKICAgICAgICB1c2VyX3Blcm1zX3RvX21vZGVzID0gewogICAgICAgICAgICAndSc6IHsKICAgICAgICAgICAgICAgICdyJzogc3RhdC5TX0lSVVNSLAogICAgICAgICAgICAgICAgJ3cnOiBzdGF0LlNfSVdVU1IsCiAgICAgICAgICAgICAgICAneCc6IHN0YXQuU19JWFVTUiwKICAgICAgICAgICAgICAgICdzJzogc3RhdC5TX0lTVUlELAogICAgICAgICAgICAgICAgJ3QnOiAwLAogICAgICAgICAgICAgICAgJ3UnOiBwcmV2X21vZGUgJiBzdGF0LlNfSVJXWFUsCiAgICAgICAgICAgICAgICAnZyc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWEcpIDw8IDMsCiAgICAgICAgICAgICAgICAnbyc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWE8pIDw8IDYgfSwKICAgICAgICAgICAgJ2cnOiB7CiAgICAgICAgICAgICAgICAncic6IHN0YXQuU19JUkdSUCwKICAgICAgICAgICAgICAgICd3Jzogc3RhdC5TX0lXR1JQLAogICAgICAgICAgICAgICAgJ3gnOiBzdGF0LlNfSVhHUlAsCiAgICAgICAgICAgICAgICAncyc6IHN0YXQuU19JU0dJRCwKICAgICAgICAgICAgICAgICd0JzogMCwKICAgICAgICAgICAgICAgICd1JzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYVSkgPj4gMywKICAgICAgICAgICAgICAgICdnJzogcHJldl9tb2RlICYgc3RhdC5TX0lSV1hHLAogICAgICAgICAgICAgICAgJ28nOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hPKSA8PCAzIH0sCiAgICAgICAgICAgICdvJzogewogICAgICAgICAgICAgICAgJ3InOiBzdGF0LlNfSVJPVEgsCiAgICAgICAgICAgICAgICAndyc6IHN0YXQuU19JV09USCwKICAgICAgICAgICAgICAgICd4Jzogc3RhdC5TX0lYT1RILAogICAgICAgICAgICAgICAgJ3MnOiAwLAogICAgICAgICAgICAgICAgJ3QnOiBzdGF0LlNfSVNWVFgsCiAgICAgICAgICAgICAgICAndSc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWFUpID4+IDYsCiAgICAgICAgICAgICAgICAnZyc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWEcpID4+IDMsCiAgICAgICAgICAgICAgICAnbyc6IHByZXZfbW9kZSAmIHN0YXQuU19JUldYTyB9CiAgICAgICAgfQoKICAgICAgICAjIEluc2VydCBYX3Blcm1zIGludG8gdXNlcl9wZXJtc190b19tb2RlcwogICAgICAgIGZvciBrZXksIHZhbHVlIGluIFhfcGVybXMuaXRlbXMoKToKICAgICAgICAgICAgdXNlcl9wZXJtc190b19tb2Rlc1trZXldLnVwZGF0ZSh2YWx1ZSkKCiAgICAgICAgb3JfcmVkdWNlID0gbGFtYmRhIG1vZGUsIHBlcm06IG1vZGUgfCB1c2VyX3Blcm1zX3RvX21vZGVzW3VzZXJdW3Blcm1dCiAgICAgICAgcmV0dXJuIHJlZHVjZShvcl9yZWR1Y2UsIHBlcm1zLCAwKQoKICAgIGRlZiBzZXRfZnNfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoc2VsZiwgZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICAjIHNldCBtb2RlcyBvd25lcnMgYW5kIGNvbnRleHQgYXMgbmVlZGVkCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydzZWNvbnRleHQnXSwgY2hhbmdlZCwgZGlmZgogICAgICAgICkKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfb3duZXJfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydvd25lciddLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQKICAgICAgICApCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X2dyb3VwX2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snZ3JvdXAnXSwgY2hhbmdlZCwgZGlmZiwgZXhwYW5kCiAgICAgICAgKQogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9tb2RlX2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snbW9kZSddLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQKICAgICAgICApCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydhdHRyaWJ1dGVzJ10sIGNoYW5nZWQsIGRpZmYsIGV4cGFuZAogICAgICAgICkKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfZGlyZWN0b3J5X2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KHNlbGYsIGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgcmV0dXJuIHNlbGYuc2V0X2ZzX2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZiwgZXhwYW5kKQoKICAgIGRlZiBzZXRfZmlsZV9hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChzZWxmLCBmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIHJldHVybiBzZWxmLnNldF9mc19hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmYsIGV4cGFuZCkKCiAgICBkZWYgYWRkX3BhdGhfaW5mbyhzZWxmLCBrd2FyZ3MpOgogICAgICAgICcnJwogICAgICAgIGZvciByZXN1bHRzIHRoYXQgYXJlIGZpbGVzLCBzdXBwbGVtZW50IHRoZSBpbmZvIGFib3V0IHRoZSBmaWxlCiAgICAgICAgaW4gdGhlIHJldHVybiBwYXRoIHdpdGggc3RhdHMgYWJvdXQgdGhlIGZpbGUgcGF0aC4KICAgICAgICAnJycKCiAgICAgICAgcGF0aCA9IGt3YXJncy5nZXQoJ3BhdGgnLCBrd2FyZ3MuZ2V0KCdkZXN0JywgTm9uZSkpCiAgICAgICAgaWYgcGF0aCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4ga3dhcmdzCiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhiX3BhdGgpOgogICAgICAgICAgICAodWlkLCBnaWQpID0gc2VsZi51c2VyX2FuZF9ncm91cChwYXRoKQogICAgICAgICAgICBrd2FyZ3NbJ3VpZCddID0gdWlkCiAgICAgICAgICAgIGt3YXJnc1snZ2lkJ10gPSBnaWQKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdXNlciA9IHB3ZC5nZXRwd3VpZCh1aWQpWzBdCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHVzZXIgPSBzdHIodWlkKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBncm91cCA9IGdycC5nZXRncmdpZChnaWQpWzBdCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIGdyb3VwID0gc3RyKGdpZCkKICAgICAgICAgICAga3dhcmdzWydvd25lciddID0gdXNlcgogICAgICAgICAgICBrd2FyZ3NbJ2dyb3VwJ10gPSBncm91cAogICAgICAgICAgICBzdCA9IG9zLmxzdGF0KGJfcGF0aCkKICAgICAgICAgICAga3dhcmdzWydtb2RlJ10gPSAnMCUwM28nICUgc3RhdC5TX0lNT0RFKHN0W3N0YXQuU1RfTU9ERV0pCiAgICAgICAgICAgICMgc2Vjb250ZXh0IG5vdCB5ZXQgc3VwcG9ydGVkCiAgICAgICAgICAgIGlmIG9zLnBhdGguaXNsaW5rKGJfcGF0aCk6CiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnbGluaycKICAgICAgICAgICAgZWxpZiBvcy5wYXRoLmlzZGlyKGJfcGF0aCk6CiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnZGlyZWN0b3J5JwogICAgICAgICAgICBlbGlmIG9zLnN0YXQoYl9wYXRoKS5zdF9ubGluayA+IDE6CiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnaGFyZCcKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdmaWxlJwogICAgICAgICAgICBpZiBIQVZFX1NFTElOVVggYW5kIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3NlY29udGV4dCddID0gJzonLmpvaW4oc2VsZi5zZWxpbnV4X2NvbnRleHQocGF0aCkpCiAgICAgICAgICAgIGt3YXJnc1snc2l6ZSddID0gc3Rbc3RhdC5TVF9TSVpFXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdhYnNlbnQnCiAgICAgICAgcmV0dXJuIGt3YXJncwoKICAgIGRlZiBfY2hlY2tfbG9jYWxlKHNlbGYpOgogICAgICAgICcnJwogICAgICAgIFVzZXMgdGhlIGxvY2FsZSBtb2R1bGUgdG8gdGVzdCB0aGUgY3VycmVudGx5IHNldCBsb2NhbGUKICAgICAgICAocGVyIHRoZSBMQU5HIGFuZCBMQ19DVFlQRSBlbnZpcm9ubWVudCBzZXR0aW5ncykKICAgICAgICAnJycKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgc2V0dGluZyB0aGUgbG9jYWxlIHRvICcnIHVzZXMgdGhlIGRlZmF1bHQgbG9jYWxlCiAgICAgICAgICAgICMgYXMgaXQgd291bGQgYmUgcmV0dXJuZWQgYnkgbG9jYWxlLmdldGRlZmF1bHRsb2NhbGUoKQogICAgICAgICAgICBsb2NhbGUuc2V0bG9jYWxlKGxvY2FsZS5MQ19BTEwsICcnKQogICAgICAgIGV4Y2VwdCBsb2NhbGUuRXJyb3I6CiAgICAgICAgICAgICMgZmFsbGJhY2sgdG8gdGhlICdDJyBsb2NhbGUsIHdoaWNoIG1heSBjYXVzZSB1bmljb2RlCiAgICAgICAgICAgICMgaXNzdWVzIGJ1dCBpcyBwcmVmZXJhYmxlIHRvIHNpbXBseSBmYWlsaW5nIGJlY2F1c2UKICAgICAgICAgICAgIyBvZiBhbiB1bmtub3duIGxvY2FsZQogICAgICAgICAgICBsb2NhbGUuc2V0bG9jYWxlKGxvY2FsZS5MQ19BTEwsICdDJykKICAgICAgICAgICAgb3MuZW52aXJvblsnTEFORyddID0gJ0MnCiAgICAgICAgICAgIG9zLmVudmlyb25bJ0xDX0FMTCddID0gJ0MnCiAgICAgICAgICAgIG9zLmVudmlyb25bJ0xDX01FU1NBR0VTJ10gPSAnQycKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iQW4gdW5rbm93biBlcnJvciB3YXMgZW5jb3VudGVyZWQgd2hpbGUgYXR0ZW1wdGluZyB0byB2YWxpZGF0ZSB0aGUgbG9jYWxlOiAlcyIgJSBlKQoKICAgIGRlZiBfaGFuZGxlX2FsaWFzZXMoc2VsZiwgc3BlYz1Ob25lKToKICAgICAgICAjIHRoaXMgdXNlcyBleGNlcHRpb25zIGFzIGl0IGhhcHBlbnMgYmVmb3JlIHdlIGNhbiBzYWZlbHkgY2FsbCBmYWlsX2pzb24KICAgICAgICBhbGlhc2VzX3Jlc3VsdHMgPSB7fSAjYWxpYXM6Y2Fub24KICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHNwZWMgPSBzZWxmLmFyZ3VtZW50X3NwZWMKICAgICAgICBmb3IgKGssdikgaW4gc3BlYy5pdGVtcygpOgogICAgICAgICAgICBzZWxmLl9sZWdhbF9pbnB1dHMuYXBwZW5kKGspCiAgICAgICAgICAgIGFsaWFzZXMgPSB2LmdldCgnYWxpYXNlcycsIE5vbmUpCiAgICAgICAgICAgIGRlZmF1bHQgPSB2LmdldCgnZGVmYXVsdCcsIE5vbmUpCiAgICAgICAgICAgIHJlcXVpcmVkID0gdi5nZXQoJ3JlcXVpcmVkJywgRmFsc2UpCiAgICAgICAgICAgIGlmIGRlZmF1bHQgaXMgbm90IE5vbmUgYW5kIHJlcXVpcmVkOgogICAgICAgICAgICAgICAgIyBub3QgYWxpYXMgc3BlY2lmaWMgYnV0IHRoaXMgaXMgYSBnb29kIHBsYWNlIHRvIGNoZWNrIHRoaXMKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiaW50ZXJuYWwgZXJyb3I6IHJlcXVpcmVkIGFuZCBkZWZhdWx0IGFyZSBtdXR1YWxseSBleGNsdXNpdmUgZm9yICVzIiAlIGspCiAgICAgICAgICAgIGlmIGFsaWFzZXMgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGFsaWFzZXMsIFNFUVVFTkNFVFlQRSkgb3IgaXNpbnN0YW5jZShhbGlhc2VzLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpOgogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCdpbnRlcm5hbCBlcnJvcjogYWxpYXNlcyBtdXN0IGJlIGEgbGlzdCBvciB0dXBsZScpCiAgICAgICAgICAgIGZvciBhbGlhcyBpbiBhbGlhc2VzOgogICAgICAgICAgICAgICAgc2VsZi5fbGVnYWxfaW5wdXRzLmFwcGVuZChhbGlhcykKICAgICAgICAgICAgICAgIGFsaWFzZXNfcmVzdWx0c1thbGlhc10gPSBrCiAgICAgICAgICAgICAgICBpZiBhbGlhcyBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcmFtc1trXSA9IHNlbGYucGFyYW1zW2FsaWFzXQoKICAgICAgICByZXR1cm4gYWxpYXNlc19yZXN1bHRzCgogICAgZGVmIF9jaGVja19hcmd1bWVudHMoc2VsZiwgY2hlY2tfaW52YWxpZF9hcmd1bWVudHMpOgogICAgICAgIHNlbGYuX3N5c2xvZ19mYWNpbGl0eSA9ICdMT0dfVVNFUicKICAgICAgICB1bnN1cHBvcnRlZF9wYXJhbWV0ZXJzID0gc2V0KCkKICAgICAgICBmb3IgKGssdikgaW4gbGlzdChzZWxmLnBhcmFtcy5pdGVtcygpKToKCiAgICAgICAgICAgIGlmIGsgPT0gJ19hbnNpYmxlX2NoZWNrX21vZGUnIGFuZCB2OgogICAgICAgICAgICAgICAgc2VsZi5jaGVja19tb2RlID0gVHJ1ZQoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9ub19sb2cnOgogICAgICAgICAgICAgICAgc2VsZi5ub19sb2cgPSBzZWxmLmJvb2xlYW4odikKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfZGVidWcnOgogICAgICAgICAgICAgICAgc2VsZi5fZGVidWcgPSBzZWxmLmJvb2xlYW4odikKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfZGlmZic6CiAgICAgICAgICAgICAgICBzZWxmLl9kaWZmID0gc2VsZi5ib29sZWFuKHYpCgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX3ZlcmJvc2l0eSc6CiAgICAgICAgICAgICAgICBzZWxmLl92ZXJib3NpdHkgPSB2CgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX3NlbGludXhfc3BlY2lhbF9mcyc6CiAgICAgICAgICAgICAgICBzZWxmLl9zZWxpbnV4X3NwZWNpYWxfZnMgPSB2CgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX3N5c2xvZ19mYWNpbGl0eSc6CiAgICAgICAgICAgICAgICBzZWxmLl9zeXNsb2dfZmFjaWxpdHkgPSB2CgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX3ZlcnNpb24nOgogICAgICAgICAgICAgICAgc2VsZi5hbnNpYmxlX3ZlcnNpb24gPSB2CgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX21vZHVsZV9uYW1lJzoKICAgICAgICAgICAgICAgIHNlbGYuX25hbWUgPSB2CgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX3NvY2tldCc6CiAgICAgICAgICAgICAgICBzZWxmLl9zb2NrZXRfcGF0aCA9IHYKCiAgICAgICAgICAgIGVsaWYgY2hlY2tfaW52YWxpZF9hcmd1bWVudHMgYW5kIGsgbm90IGluIHNlbGYuX2xlZ2FsX2lucHV0czoKICAgICAgICAgICAgICAgIHVuc3VwcG9ydGVkX3BhcmFtZXRlcnMuYWRkKGspCgogICAgICAgICAgICAjY2xlYW4gdXAgaW50ZXJuYWwgcGFyYW1zOgogICAgICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoJ19hbnNpYmxlXycpOgogICAgICAgICAgICAgICAgZGVsIHNlbGYucGFyYW1zW2tdCgogICAgICAgIGlmIHVuc3VwcG9ydGVkX3BhcmFtZXRlcnM6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iVW5zdXBwb3J0ZWQgcGFyYW1ldGVycyBmb3IgKCVzKSBtb2R1bGU6ICVzLiBTdXBwb3J0ZWQgcGFyYW1ldGVycyBpbmNsdWRlOiAlcyIgJSAoc2VsZi5fbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLCcuam9pbihzb3J0ZWQobGlzdCh1bnN1cHBvcnRlZF9wYXJhbWV0ZXJzKSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcsJy5qb2luKHNvcnRlZChzZWxmLmFyZ3VtZW50X3NwZWMua2V5cygpKSkpKQogICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZSBhbmQgbm90IHNlbGYuc3VwcG9ydHNfY2hlY2tfbW9kZToKICAgICAgICAgICAgc2VsZi5leGl0X2pzb24oc2tpcHBlZD1UcnVlLCBtc2c9InJlbW90ZSBtb2R1bGUgKCVzKSBkb2VzIG5vdCBzdXBwb3J0IGNoZWNrIG1vZGUiICUgc2VsZi5fbmFtZSkKCiAgICBkZWYgX2NvdW50X3Rlcm1zKHNlbGYsIGNoZWNrKToKICAgICAgICBjb3VudCA9IDAKICAgICAgICBmb3IgdGVybSBpbiBjaGVjazoKICAgICAgICAgICAgaWYgdGVybSBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgICAgIGNvdW50ICs9IDEKICAgICAgICByZXR1cm4gY291bnQKCiAgICBkZWYgX2NoZWNrX211dHVhbGx5X2V4Y2x1c2l2ZShzZWxmLCBzcGVjKToKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciBjaGVjayBpbiBzcGVjOgogICAgICAgICAgICBjb3VudCA9IHNlbGYuX2NvdW50X3Rlcm1zKGNoZWNrKQogICAgICAgICAgICBpZiBjb3VudCA+IDE6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9InBhcmFtZXRlcnMgYXJlIG11dHVhbGx5IGV4Y2x1c2l2ZTogJXMiICUgKGNoZWNrLCkpCgogICAgZGVmIF9jaGVja19yZXF1aXJlZF9vbmVfb2Yoc2VsZiwgc3BlYyk6CiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3IgY2hlY2sgaW4gc3BlYzoKICAgICAgICAgICAgY291bnQgPSBzZWxmLl9jb3VudF90ZXJtcyhjaGVjaykKICAgICAgICAgICAgaWYgY291bnQgPT0gMDoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0ib25lIG9mIHRoZSBmb2xsb3dpbmcgaXMgcmVxdWlyZWQ6ICVzIiAlICcsJy5qb2luKGNoZWNrKSkKCiAgICBkZWYgX2NoZWNrX3JlcXVpcmVkX3RvZ2V0aGVyKHNlbGYsIHNwZWMpOgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZm9yIGNoZWNrIGluIHNwZWM6CiAgICAgICAgICAgIGNvdW50cyA9IFsgc2VsZi5fY291bnRfdGVybXMoW2ZpZWxkXSkgZm9yIGZpZWxkIGluIGNoZWNrIF0KICAgICAgICAgICAgbm9uX3plcm8gPSBbIGMgZm9yIGMgaW4gY291bnRzIGlmIGMgPiAwIF0KICAgICAgICAgICAgaWYgbGVuKG5vbl96ZXJvKSA+IDA6CiAgICAgICAgICAgICAgICBpZiAwIGluIGNvdW50czoKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9InBhcmFtZXRlcnMgYXJlIHJlcXVpcmVkIHRvZ2V0aGVyOiAlcyIgJSAoY2hlY2ssKSkKCiAgICBkZWYgX2NoZWNrX3JlcXVpcmVkX2FyZ3VtZW50cyhzZWxmLCBzcGVjPU5vbmUsIHBhcmFtPU5vbmUgKToKICAgICAgICAnJycgZW5zdXJlIGFsbCByZXF1aXJlZCBhcmd1bWVudHMgYXJlIHByZXNlbnQgJycnCiAgICAgICAgbWlzc2luZyA9IFtdCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICBzcGVjID0gc2VsZi5hcmd1bWVudF9zcGVjCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToKICAgICAgICAgICAgcGFyYW0gPSBzZWxmLnBhcmFtcwogICAgICAgIGZvciAoayx2KSBpbiBzcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIHJlcXVpcmVkID0gdi5nZXQoJ3JlcXVpcmVkJywgRmFsc2UpCiAgICAgICAgICAgIGlmIHJlcXVpcmVkIGFuZCBrIG5vdCBpbiBwYXJhbToKICAgICAgICAgICAgICAgIG1pc3NpbmcuYXBwZW5kKGspCiAgICAgICAgaWYgbGVuKG1pc3NpbmcpID4gMDoKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJtaXNzaW5nIHJlcXVpcmVkIGFyZ3VtZW50czogJXMiICUgIiwiLmpvaW4obWlzc2luZykpCgogICAgZGVmIF9jaGVja19yZXF1aXJlZF9pZihzZWxmLCBzcGVjKToKICAgICAgICAnJycgZW5zdXJlIHRoYXQgcGFyYW1ldGVycyB3aGljaCBjb25kaXRpb25hbGx5IHJlcXVpcmVkIGFyZSBwcmVzZW50ICcnJwogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZm9yIHNwIGluIHNwZWM6CiAgICAgICAgICAgIG1pc3NpbmcgPSBbXQogICAgICAgICAgICBtYXhfbWlzc2luZ19jb3VudCA9IDAKICAgICAgICAgICAgaXNfb25lX29mID0gRmFsc2UKICAgICAgICAgICAgaWYgbGVuKHNwKSA9PSA0OgogICAgICAgICAgICAgICAga2V5LCB2YWwsIHJlcXVpcmVtZW50cywgaXNfb25lX29mID0gc3AKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGtleSwgdmFsLCByZXF1aXJlbWVudHMgPSBzcAoKICAgICAgICAgICAgIyBpc19vbmVfb2YgaXMgVHJ1ZSBhdCBsZWFzdCBvbmUgcmVxdWlyZW1lbnQgc2hvdWxkIGJlCiAgICAgICAgICAgICMgcHJlc2VudCwgZWxzZSBhbGwgcmVxdWlyZW1lbnRzIHNob3VsZCBiZSBwcmVzZW50LgogICAgICAgICAgICBpZiBpc19vbmVfb2Y6CiAgICAgICAgICAgICAgICBtYXhfbWlzc2luZ19jb3VudCA9IGxlbihyZXF1aXJlbWVudHMpCgogICAgICAgICAgICBpZiBrZXkgaW4gc2VsZi5wYXJhbXMgYW5kIHNlbGYucGFyYW1zW2tleV0gPT0gdmFsOgogICAgICAgICAgICAgICAgZm9yIGNoZWNrIGluIHJlcXVpcmVtZW50czoKICAgICAgICAgICAgICAgICAgICBjb3VudCA9IHNlbGYuX2NvdW50X3Rlcm1zKChjaGVjaywpKQogICAgICAgICAgICAgICAgICAgIGlmIGNvdW50ID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIG1pc3NpbmcuYXBwZW5kKGNoZWNrKQogICAgICAgICAgICBpZiBsZW4obWlzc2luZykgYW5kIGxlbihtaXNzaW5nKSA+PSBtYXhfbWlzc2luZ19jb3VudDoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iJXMgaXMgJXMgYnV0IHRoZSBmb2xsb3dpbmcgYXJlIG1pc3Npbmc6ICVzIiAlIChrZXksIHZhbCwgJywnLmpvaW4obWlzc2luZykpKQoKICAgIGRlZiBfY2hlY2tfYXJndW1lbnRfdmFsdWVzKHNlbGYsIHNwZWM9Tm9uZSwgcGFyYW09Tm9uZSk6CiAgICAgICAgJycnIGVuc3VyZSBhbGwgYXJndW1lbnRzIGhhdmUgdGhlIHJlcXVlc3RlZCB2YWx1ZXMsIGFuZCB0aGVyZSBhcmUgbm8gc3RyYXkgYXJndW1lbnRzICcnJwogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgc3BlYyA9IHNlbGYuYXJndW1lbnRfc3BlYwogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAgICAgIHBhcmFtID0gc2VsZi5wYXJhbXMKICAgICAgICBmb3IgKGssdikgaW4gc3BlYy5pdGVtcygpOgogICAgICAgICAgICBjaG9pY2VzID0gdi5nZXQoJ2Nob2ljZXMnLE5vbmUpCiAgICAgICAgICAgIGlmIGNob2ljZXMgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoY2hvaWNlcywgU0VRVUVOQ0VUWVBFKSBhbmQgbm90IGlzaW5zdGFuY2UoY2hvaWNlcywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKToKICAgICAgICAgICAgICAgIGlmIGsgaW4gcGFyYW06CiAgICAgICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gbm90IGluIGNob2ljZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICMgUHlZYW1sIGNvbnZlcnRzIGNlcnRhaW4gc3RyaW5ncyB0byBib29scy4gIElmIHdlIGNhbiB1bmFtYmlndW91c2x5IGNvbnZlcnQgYmFjaywgZG8gc28gYmVmb3JlIGNoZWNraW5nCiAgICAgICAgICAgICAgICAgICAgICAgICMgdGhlIHZhbHVlLiAgSWYgd2UgY2FuJ3QgZmlndXJlIHRoaXMgb3V0LCBtb2R1bGUgYXV0aG9yIGlzIHJlc3BvbnNpYmxlLgogICAgICAgICAgICAgICAgICAgICAgICBsb3dlcmVkX2Nob2ljZXMgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdID09ICdGYWxzZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb3dlcmVkX2Nob2ljZXMgPSBfbGVuaWVudF9sb3dlcmNhc2UoY2hvaWNlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZBTFNFWSA9IGZyb3plbnNldChCT09MRUFOU19GQUxTRSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJsYXAgPSBGQUxTRVkuaW50ZXJzZWN0aW9uKGNob2ljZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4ob3ZlcmxhcCkgPT0gMToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEV4dHJhY3QgZnJvbSBhIHNldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChwYXJhbVtrXSwpID0gb3ZlcmxhcAoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gPT0gJ1RydWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbG93ZXJlZF9jaG9pY2VzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJlZF9jaG9pY2VzID0gX2xlbmllbnRfbG93ZXJjYXNlKGNob2ljZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBUUlVUSFkgPSBmcm96ZW5zZXQoQk9PTEVBTlNfVFJVRSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJsYXAgPSBUUlVUSFkuaW50ZXJzZWN0aW9uKGNob2ljZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4ob3ZlcmxhcCkgPT0gMToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAocGFyYW1ba10sKSA9IG92ZXJsYXAKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdIG5vdCBpbiBjaG9pY2VzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlc19zdHI9IiwiLmpvaW4oW3RvX25hdGl2ZShjKSBmb3IgYyBpbiBjaG9pY2VzXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZz0idmFsdWUgb2YgJXMgbXVzdCBiZSBvbmUgb2Y6ICVzLCBnb3Q6ICVzIiAlIChrLCBjaG9pY2VzX3N0ciwgcGFyYW1ba10pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9bXNnKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJpbnRlcm5hbCBlcnJvcjogY2hvaWNlcyBmb3IgYXJndW1lbnQgJXMgYXJlIG5vdCBpdGVyYWJsZTogJXMiICUgKGssIGNob2ljZXMpKQoKICAgIGRlZiBzYWZlX2V2YWwoc2VsZiwgdmFsdWUsIGxvY2Fscz1Ob25lLCBpbmNsdWRlX2V4Y2VwdGlvbnM9RmFsc2UpOgoKICAgICAgICAjIGRvIG5vdCBhbGxvdyBtZXRob2QgY2FsbHMgdG8gbW9kdWxlcwogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICAjIGFscmVhZHkgdGVtcGxhdGVkIHRvIGEgZGF0YXZhbHVlc3RydWN0dXJlLCBwZXJoYXBzPwogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHZhbHVlLCBOb25lKQogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICBpZiByZS5zZWFyY2gocidcd1wuXHcrXCgnLCB2YWx1ZSk6CiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAodmFsdWUsIE5vbmUpCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgICMgZG8gbm90IGFsbG93IGltcG9ydHMKICAgICAgICBpZiByZS5zZWFyY2gocidpbXBvcnQgXHcrJywgdmFsdWUpOgogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHZhbHVlLCBOb25lKQogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3VsdCA9IGxpdGVyYWxfZXZhbCh2YWx1ZSkKICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuIChyZXN1bHQsIE5vbmUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHZhbHVlLCBlKQogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICBkZWYgX2NoZWNrX3R5cGVfc3RyKHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICAjIE5vdGU6IFRoaXMgY291bGQgdGhyb3cgYSB1bmljb2RlIGVycm9yIGlmIHZhbHVlJ3MgX19zdHJfXygpIG1ldGhvZAogICAgICAgICMgcmV0dXJucyBub24tYXNjaWkuICBIYXZlIHRvIHBvcnQgdXRpbHMudG9fYnl0ZXMoKSBpZiB0aGF0IGhhcHBlbnMKICAgICAgICByZXR1cm4gc3RyKHZhbHVlKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9saXN0KHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBsaXN0KToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5zcGxpdCgiLCIpCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBpbnQpIG9yIGlzaW5zdGFuY2UodmFsdWUsIGZsb2F0KToKICAgICAgICAgICAgcmV0dXJuIFsgc3RyKHZhbHVlKSBdCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGxpc3QnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2RpY3Qoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGRpY3QpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgaWYgdmFsdWUuc3RhcnRzd2l0aCgieyIpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmxvYWRzKHZhbHVlKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIChyZXN1bHQsIGV4YykgPSBzZWxmLnNhZmVfZXZhbCh2YWx1ZSwgZGljdCgpLCBpbmNsdWRlX2V4Y2VwdGlvbnM9VHJ1ZSkKICAgICAgICAgICAgICAgICAgICBpZiBleGMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigndW5hYmxlIHRvIGV2YWx1YXRlIHN0cmluZyBhcyBkaWN0aW9uYXJ5JykKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0CiAgICAgICAgICAgIGVsaWYgJz0nIGluIHZhbHVlOgogICAgICAgICAgICAgICAgZmllbGRzID0gW10KICAgICAgICAgICAgICAgIGZpZWxkX2J1ZmZlciA9IFtdCiAgICAgICAgICAgICAgICBpbl9xdW90ZSA9IEZhbHNlCiAgICAgICAgICAgICAgICBpbl9lc2NhcGUgPSBGYWxzZQogICAgICAgICAgICAgICAgZm9yIGMgaW4gdmFsdWUuc3RyaXAoKToKICAgICAgICAgICAgICAgICAgICBpZiBpbl9lc2NhcGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkX2J1ZmZlci5hcHBlbmQoYykKICAgICAgICAgICAgICAgICAgICAgICAgaW5fZXNjYXBlID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBlbGlmIGMgPT0gJ1xcJzoKICAgICAgICAgICAgICAgICAgICAgICAgaW5fZXNjYXBlID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGVsaWYgbm90IGluX3F1b3RlIGFuZCBjIGluICgnXCcnLCAnIicpOgogICAgICAgICAgICAgICAgICAgICAgICBpbl9xdW90ZSA9IGMKICAgICAgICAgICAgICAgICAgICBlbGlmIGluX3F1b3RlIGFuZCBpbl9xdW90ZSA9PSBjOgogICAgICAgICAgICAgICAgICAgICAgICBpbl9xdW90ZSA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgZWxpZiBub3QgaW5fcXVvdGUgYW5kIGMgaW4gKCcsJywgJyAnKToKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQgPSAnJy5qb2luKGZpZWxkX2J1ZmZlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZmllbGQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHMuYXBwZW5kKGZpZWxkKQogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZF9idWZmZXIgPSBbXQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkX2J1ZmZlci5hcHBlbmQoYykKCiAgICAgICAgICAgICAgICBmaWVsZCA9ICcnLmpvaW4oZmllbGRfYnVmZmVyKQogICAgICAgICAgICAgICAgaWYgZmllbGQ6CiAgICAgICAgICAgICAgICAgICAgZmllbGRzLmFwcGVuZChmaWVsZCkKICAgICAgICAgICAgICAgIHJldHVybiBkaWN0KHguc3BsaXQoIj0iLCAxKSBmb3IgeCBpbiBmaWVsZHMpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoImRpY3Rpb25hcnkgcmVxdWVzdGVkLCBjb3VsZCBub3QgcGFyc2UgSlNPTiBvciBrZXk9dmFsdWUiKQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBkaWN0JyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9ib29sKHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBib29sKToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcykgb3IgaXNpbnN0YW5jZSh2YWx1ZSwgaW50KToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuYm9vbGVhbih2YWx1ZSkKCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgYm9vbCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfaW50KHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBpbnQpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgcmV0dXJuIGludCh2YWx1ZSkKCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGFuIGludCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfZmxvYXQoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGZsb2F0KToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlLCBpbnQpKToKICAgICAgICAgICAgcmV0dXJuIGZsb2F0KHZhbHVlKQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBmbG9hdCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfcGF0aChzZWxmLCB2YWx1ZSk6CiAgICAgICAgdmFsdWUgPSBzZWxmLl9jaGVja190eXBlX3N0cih2YWx1ZSkKICAgICAgICByZXR1cm4gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2pzb25hcmcoc2VsZiwgdmFsdWUpOgogICAgICAgICMgUmV0dXJuIGEganNvbmlmaWVkIHN0cmluZy4gIFNvbWV0aW1lcyB0aGUgY29udHJvbGxlciB0dXJucyBhIGpzb24KICAgICAgICAjIHN0cmluZyBpbnRvIGEgZGljdC9saXN0IHNvIHRyYW5zZm9ybSBpdCBiYWNrIGludG8ganNvbiBoZXJlCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnN0cmlwKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCAobGlzdCwgdHVwbGUsIGRpY3QpKToKICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmR1bXBzKHZhbHVlKQogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGpzb24gc3RyaW5nJyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9yYXcoc2VsZiwgdmFsdWUpOgogICAgICAgIHJldHVybiB2YWx1ZQoKCiAgICBkZWYgX2NoZWNrX3R5cGVfYnl0ZXMoc2VsZiwgdmFsdWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5odW1hbl90b19ieXRlcyh2YWx1ZSkKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgQnl0ZSB2YWx1ZScgJSB0eXBlKHZhbHVlKSkKCgogICAgZGVmIF9jaGVja190eXBlX2JpdHMoc2VsZiwgdmFsdWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5odW1hbl90b19ieXRlcyh2YWx1ZSwgaXNiaXRzPVRydWUpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIEJpdCB2YWx1ZScgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX2FyZ3VtZW50X3R5cGVzKHNlbGYsIHNwZWM9Tm9uZSwgcGFyYW09Tm9uZSk6CiAgICAgICAgJycnIGVuc3VyZSBhbGwgYXJndW1lbnRzIGhhdmUgdGhlIHJlcXVlc3RlZCB0eXBlICcnJwoKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHNwZWMgPSBzZWxmLmFyZ3VtZW50X3NwZWMKICAgICAgICBpZiBwYXJhbSBpcyBOb25lOgogICAgICAgICAgICBwYXJhbSA9IHNlbGYucGFyYW1zCgogICAgICAgIGZvciAoaywgdikgaW4gc3BlYy5pdGVtcygpOgogICAgICAgICAgICB3YW50ZWQgPSB2LmdldCgndHlwZScsIE5vbmUpCiAgICAgICAgICAgIGlmIGsgbm90IGluIHBhcmFtOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgd2FudGVkIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAjIE1vc3RseSB3ZSB3YW50IHRvIGRlZmF1bHQgdG8gc3RyLgogICAgICAgICAgICAgICAgIyBGb3IgdmFsdWVzIHNldCB0byBOb25lIGV4cGxpY2l0bHksIHJldHVybiBOb25lIGluc3RlYWQgYXMKICAgICAgICAgICAgICAgICMgdGhhdCBhbGxvd3MgYSB1c2VyIHRvIHVuc2V0IGEgcGFyYW1ldGVyCiAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB3YW50ZWQgPSAnc3RyJwoKICAgICAgICAgICAgdmFsdWUgPSBwYXJhbVtrXQogICAgICAgICAgICBpZiB2YWx1ZSBpcyBOb25lOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHR5cGVfY2hlY2tlciA9IHNlbGYuX0NIRUNLX0FSR1VNRU5UX1RZUEVTX0RJU1BBVENIRVJbd2FudGVkXQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImltcGxlbWVudGF0aW9uIGVycm9yOiB1bmtub3duIHR5cGUgJXMgcmVxdWVzdGVkIGZvciAlcyIgJSAod2FudGVkLCBrKSkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcGFyYW1ba10gPSB0eXBlX2NoZWNrZXIodmFsdWUpCiAgICAgICAgICAgIGV4Y2VwdCAoVHlwZUVycm9yLCBWYWx1ZUVycm9yKToKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iYXJndW1lbnQgJXMgaXMgb2YgdHlwZSAlcyBhbmQgd2Ugd2VyZSB1bmFibGUgdG8gY29udmVydCB0byAlczogJXMiICUgKGssIHR5cGUodmFsdWUpLCB3YW50ZWQsIGUpKQoKICAgICAgICAgICAgIyBkZWFsIHdpdGggc3ViIG9wdGlvbnMgdG8gY3JlYXRlIHN1YiBzcGVjCiAgICAgICAgICAgIHNwZWMgPSBOb25lCiAgICAgICAgICAgIGlmIHdhbnRlZCA9PSAnZGljdCcgb3IgKHdhbnRlZCA9PSAnbGlzdCcgYW5kIHYuZ2V0KCdlbGVtZW50cycsICcnKSA9PSAnZGljdCcpOgogICAgICAgICAgICAgICAgc3BlYyA9IHYuZ2V0KCdvcHRpb25zJywgTm9uZSkKICAgICAgICAgICAgICAgIGlmIHNwZWM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfYXJndW1lbnRzKHNwZWMsIHBhcmFtW2tdKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50X3R5cGVzKHNwZWMsIHBhcmFtW2tdKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50X3ZhbHVlcyhzcGVjLCBwYXJhbVtrXSkKCiAgICBkZWYgX3NldF9kZWZhdWx0cyhzZWxmLCBwcmU9VHJ1ZSk6CiAgICAgICAgZm9yIChrLHYpIGluIHNlbGYuYXJndW1lbnRfc3BlYy5pdGVtcygpOgogICAgICAgICAgICBkZWZhdWx0ID0gdi5nZXQoJ2RlZmF1bHQnLCBOb25lKQogICAgICAgICAgICBpZiBwcmUgaXMgVHJ1ZToKICAgICAgICAgICAgICAgICMgdGhpcyBwcmV2ZW50cyBzZXR0aW5nIGRlZmF1bHRzIG9uIHJlcXVpcmVkIGl0ZW1zCiAgICAgICAgICAgICAgICBpZiBkZWZhdWx0IGlzIG5vdCBOb25lIGFuZCBrIG5vdCBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcmFtc1trXSA9IGRlZmF1bHQKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgbWFrZSBzdXJlIHRoaW5ncyB3aXRob3V0IGEgZGVmYXVsdCBzdGlsbCBnZXQgc2V0IE5vbmUKICAgICAgICAgICAgICAgIGlmIGsgbm90IGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyYW1zW2tdID0gZGVmYXVsdAoKICAgIGRlZiBfc2V0X2ZhbGxiYWNrcyhzZWxmKToKICAgICAgICBmb3Igayx2IGluIHNlbGYuYXJndW1lbnRfc3BlYy5pdGVtcygpOgogICAgICAgICAgICBmYWxsYmFjayA9IHYuZ2V0KCdmYWxsYmFjaycsIChOb25lLCkpCiAgICAgICAgICAgIGZhbGxiYWNrX3N0cmF0ZWd5ID0gZmFsbGJhY2tbMF0KICAgICAgICAgICAgZmFsbGJhY2tfYXJncyA9IFtdCiAgICAgICAgICAgIGZhbGxiYWNrX2t3YXJncyA9IHt9CiAgICAgICAgICAgIGlmIGsgbm90IGluIHNlbGYucGFyYW1zIGFuZCBmYWxsYmFja19zdHJhdGVneSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGZvciBpdGVtIGluIGZhbGxiYWNrWzE6XToKICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGl0ZW0sIGRpY3QpOgogICAgICAgICAgICAgICAgICAgICAgICBmYWxsYmFja19rd2FyZ3MgPSBpdGVtCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tfYXJncyA9IGl0ZW0KICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcmFtc1trXSA9IGZhbGxiYWNrX3N0cmF0ZWd5KCpmYWxsYmFja19hcmdzLCAqKmZhbGxiYWNrX2t3YXJncykKICAgICAgICAgICAgICAgIGV4Y2VwdCBBbnNpYmxlRmFsbGJhY2tOb3RGb3VuZDoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgIGRlZiBfbG9hZF9wYXJhbXMoc2VsZik6CiAgICAgICAgJycnIHJlYWQgdGhlIGlucHV0IGFuZCBzZXQgdGhlIHBhcmFtcyBhdHRyaWJ1dGUuCgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4gIFRoZSBndXRzIG9mIHRoZSBmdW5jdGlvbgogICAgICAgIHdlcmUgbW92ZWQgb3V0IGluIDIuMSBzbyB0aGF0IGN1c3RvbSBtb2R1bGVzIGNvdWxkIHJlYWQgdGhlIHBhcmFtZXRlcnMuCiAgICAgICAgJycnCiAgICAgICAgIyBkZWJ1ZyBvdmVycmlkZXMgdG8gcmVhZCBhcmdzIGZyb20gZmlsZSBvciBjbWRsaW5lCiAgICAgICAgc2VsZi5wYXJhbXMgPSBfbG9hZF9wYXJhbXMoKQoKICAgIGRlZiBfbG9nX3RvX3N5c2xvZyhzZWxmLCBtc2cpOgogICAgICAgIGlmIEhBU19TWVNMT0c6CiAgICAgICAgICAgIG1vZHVsZSA9ICdhbnNpYmxlLSVzJyAlIHNlbGYuX25hbWUKICAgICAgICAgICAgZmFjaWxpdHkgPSBnZXRhdHRyKHN5c2xvZywgc2VsZi5fc3lzbG9nX2ZhY2lsaXR5LCBzeXNsb2cuTE9HX1VTRVIpCiAgICAgICAgICAgIHN5c2xvZy5vcGVubG9nKHN0cihtb2R1bGUpLCAwLCBmYWNpbGl0eSkKICAgICAgICAgICAgc3lzbG9nLnN5c2xvZyhzeXNsb2cuTE9HX0lORk8sIG1zZykKCiAgICBkZWYgZGVidWcoc2VsZiwgbXNnKToKICAgICAgICBpZiBzZWxmLl9kZWJ1ZzoKICAgICAgICAgICAgc2VsZi5sb2coJ1tkZWJ1Z10gJXMnICUgbXNnKQoKICAgIGRlZiBsb2coc2VsZiwgbXNnLCBsb2dfYXJncz1Ob25lKToKCiAgICAgICAgaWYgbm90IHNlbGYubm9fbG9nOgoKICAgICAgICAgICAgaWYgbG9nX2FyZ3MgaXMgTm9uZToKICAgICAgICAgICAgICAgIGxvZ19hcmdzID0gZGljdCgpCgogICAgICAgICAgICBtb2R1bGUgPSAnYW5zaWJsZS0lcycgJSBzZWxmLl9uYW1lCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UobW9kdWxlLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgICAgICBtb2R1bGUgPSBtb2R1bGUuZGVjb2RlKCd1dGYtOCcsICdyZXBsYWNlJykKCiAgICAgICAgICAgICMgNjY1NSAtIGFsbG93IGZvciBhY2NlbnRlZCBjaGFyYWN0ZXJzCiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG1zZywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigibXNnIHNob3VsZCBiZSBhIHN0cmluZyAoZ290ICVzKSIgJSB0eXBlKG1zZykpCgogICAgICAgICAgICAjIFdlIHdhbnQgam91cm5hbCB0byBhbHdheXMgdGFrZSB0ZXh0IHR5cGUKICAgICAgICAgICAgIyBzeXNsb2cgdGFrZXMgYnl0ZXMgb24gcHkyLCB0ZXh0IHR5cGUgb24gcHkzCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UobXNnLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgICAgICBqb3VybmFsX21zZyA9IHJlbW92ZV92YWx1ZXMobXNnLmRlY29kZSgndXRmLTgnLCAncmVwbGFjZScpLCBzZWxmLm5vX2xvZ192YWx1ZXMpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFRPRE86IHN1cnJvZ2F0ZWVzY2FwZSBpcyBhIGRhbmdlciBoZXJlIG9uIFB5MwogICAgICAgICAgICAgICAgam91cm5hbF9tc2cgPSByZW1vdmVfdmFsdWVzKG1zZywgc2VsZi5ub19sb2dfdmFsdWVzKQoKICAgICAgICAgICAgaWYgUFkzOgogICAgICAgICAgICAgICAgc3lzbG9nX21zZyA9IGpvdXJuYWxfbXNnCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzeXNsb2dfbXNnID0gam91cm5hbF9tc2cuZW5jb2RlKCd1dGYtOCcsICdyZXBsYWNlJykKCiAgICAgICAgICAgIGlmIGhhc19qb3VybmFsOgogICAgICAgICAgICAgICAgam91cm5hbF9hcmdzID0gWygiTU9EVUxFIiwgb3MucGF0aC5iYXNlbmFtZShfX2ZpbGVfXykpXQogICAgICAgICAgICAgICAgZm9yIGFyZyBpbiBsb2dfYXJnczoKICAgICAgICAgICAgICAgICAgICBqb3VybmFsX2FyZ3MuYXBwZW5kKChhcmcudXBwZXIoKSwgc3RyKGxvZ19hcmdzW2FyZ10pKSkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBqb3VybmFsLnNlbmQodSIlcyAlcyIgJSAobW9kdWxlLCBqb3VybmFsX21zZyksICoqZGljdChqb3VybmFsX2FyZ3MpKQogICAgICAgICAgICAgICAgZXhjZXB0IElPRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgIyBmYWxsIGJhY2sgdG8gc3lzbG9nIHNpbmNlIGxvZ2dpbmcgdG8gam91cm5hbCBmYWlsZWQKICAgICAgICAgICAgICAgICAgICBzZWxmLl9sb2dfdG9fc3lzbG9nKHN5c2xvZ19tc2cpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLl9sb2dfdG9fc3lzbG9nKHN5c2xvZ19tc2cpCgogICAgZGVmIF9sb2dfaW52b2NhdGlvbihzZWxmKToKICAgICAgICAnJycgbG9nIHRoYXQgYW5zaWJsZSByYW4gdGhlIG1vZHVsZSAnJycKICAgICAgICAjIFRPRE86IGdlbmVyYWxpemUgYSBzZXBhcmF0ZSBsb2cgZnVuY3Rpb24gYW5kIG1ha2UgbG9nX2ludm9jYXRpb24gdXNlIGl0CiAgICAgICAgIyBTYW5pdGl6ZSBwb3NzaWJsZSBwYXNzd29yZCBhcmd1bWVudCB3aGVuIGxvZ2dpbmcuCiAgICAgICAgbG9nX2FyZ3MgPSBkaWN0KCkKCiAgICAgICAgZm9yIHBhcmFtIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICBjYW5vbiAgPSBzZWxmLmFsaWFzZXMuZ2V0KHBhcmFtLCBwYXJhbSkKICAgICAgICAgICAgYXJnX29wdHMgPSBzZWxmLmFyZ3VtZW50X3NwZWMuZ2V0KGNhbm9uLCB7fSkKICAgICAgICAgICAgbm9fbG9nID0gYXJnX29wdHMuZ2V0KCdub19sb2cnLCBGYWxzZSkKCiAgICAgICAgICAgIGlmIHNlbGYuYm9vbGVhbihub19sb2cpOgogICAgICAgICAgICAgICAgbG9nX2FyZ3NbcGFyYW1dID0gJ05PVF9MT0dHSU5HX1BBUkFNRVRFUicKICAgICAgICAgICAgIyB0cnkgdG8gY2FwdHVyZSBhbGwgcGFzc3dvcmRzL3Bhc3NwaHJhc2UgbmFtZWQgZmllbGRzIG1pc3NlZCBieSBub19sb2cKICAgICAgICAgICAgZWxpZiBQQVNTV09SRF9NQVRDSC5zZWFyY2gocGFyYW0pIGFuZCBcCiAgICAgICAgICAgICAgYXJnX29wdHMuZ2V0KCd0eXBlJywgJ3N0cicpICE9ICdib29sJyBhbmQgXAogICAgICAgICAgICAgIG5vdCBhcmdfb3B0cy5nZXQoJ2Nob2ljZXMnLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAjIHNraXAgYm9vbGVhbiBhbmQgZW51bXMgYXMgdGhleSBhcmUgYWJvdXQgJ3Bhc3N3b3JkJyBzdGF0ZQogICAgICAgICAgICAgICAgbG9nX2FyZ3NbcGFyYW1dID0gJ05PVF9MT0dHSU5HX1BBU1NXT1JEJwogICAgICAgICAgICAgICAgc2VsZi53YXJuKCdNb2R1bGUgZGlkIG5vdCBzZXQgbm9fbG9nIGZvciAlcycgJSBwYXJhbSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHBhcmFtX3ZhbCA9IHNlbGYucGFyYW1zW3BhcmFtXQogICAgICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UocGFyYW1fdmFsLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgICAgICAgICAgICAgIHBhcmFtX3ZhbCA9IHN0cihwYXJhbV92YWwpCiAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UocGFyYW1fdmFsLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICAgICAgICAgIHBhcmFtX3ZhbCA9IHBhcmFtX3ZhbC5lbmNvZGUoJ3V0Zi04JykKICAgICAgICAgICAgICAgIGxvZ19hcmdzW3BhcmFtXSA9IGhldXJpc3RpY19sb2dfc2FuaXRpemUocGFyYW1fdmFsLCBzZWxmLm5vX2xvZ192YWx1ZXMpCgogICAgICAgIG1zZyA9IFsnJXM9JXMnICUgKHRvX25hdGl2ZShhcmcpLCB0b19uYXRpdmUodmFsKSkgZm9yIGFyZywgdmFsIGluIGxvZ19hcmdzLml0ZW1zKCldCiAgICAgICAgaWYgbXNnOgogICAgICAgICAgICBtc2cgPSAnSW52b2tlZCB3aXRoICVzJyAlICcgJy5qb2luKG1zZykKICAgICAgICBlbHNlOgogICAgICAgICAgICBtc2cgPSAnSW52b2tlZCcKCiAgICAgICAgc2VsZi5sb2cobXNnLCBsb2dfYXJncz1sb2dfYXJncykKCgogICAgZGVmIF9zZXRfY3dkKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgY3dkID0gb3MuZ2V0Y3dkKCkKICAgICAgICAgICAgaWYgbm90IG9zLmFjY2Vzcyhjd2QsIG9zLkZfT0t8b3MuUl9PSyk6CiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oKQogICAgICAgICAgICByZXR1cm4gY3dkCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAjIHdlIGRvbid0IGhhdmUgYWNjZXNzIHRvIHRoZSBjd2QsIHByb2JhYmx5IGJlY2F1c2Ugb2Ygc3Vkby4KICAgICAgICAgICAgIyBUcnkgYW5kIG1vdmUgdG8gYSBuZXV0cmFsIGxvY2F0aW9uIHRvIHByZXZlbnQgZXJyb3JzCiAgICAgICAgICAgIGZvciBjd2QgaW4gW29zLnBhdGguZXhwYW5kdmFycygnJEhPTUUnKSwgdGVtcGZpbGUuZ2V0dGVtcGRpcigpXToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBvcy5hY2Nlc3MoY3dkLCBvcy5GX09LfG9zLlJfT0spOgogICAgICAgICAgICAgICAgICAgICAgICBvcy5jaGRpcihjd2QpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjd2QKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgIyB3ZSB3b24ndCBlcnJvciBoZXJlLCBhcyBpdCBtYXkgKm5vdCogYmUgYSBwcm9ibGVtLAogICAgICAgICMgYW5kIHdlIGRvbid0IHdhbnQgdG8gYnJlYWsgbW9kdWxlcyB1bm5lY2Vzc2FyaWx5CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgZ2V0X2Jpbl9wYXRoKHNlbGYsIGFyZywgcmVxdWlyZWQ9RmFsc2UsIG9wdF9kaXJzPVtdKToKICAgICAgICAnJycKICAgICAgICBmaW5kIHN5c3RlbSBleGVjdXRhYmxlIGluIFBBVEguCiAgICAgICAgT3B0aW9uYWwgYXJndW1lbnRzOgogICAgICAgICAgIC0gcmVxdWlyZWQ6ICBpZiBleGVjdXRhYmxlIGlzIG5vdCBmb3VuZCBhbmQgcmVxdWlyZWQgaXMgdHJ1ZSwgZmFpbF9qc29uCiAgICAgICAgICAgLSBvcHRfZGlyczogIG9wdGlvbmFsIGxpc3Qgb2YgZGlyZWN0b3JpZXMgdG8gc2VhcmNoIGluIGFkZGl0aW9uIHRvIFBBVEgKICAgICAgICBpZiBmb3VuZCByZXR1cm4gZnVsbCBwYXRoOyBvdGhlcndpc2UgcmV0dXJuIE5vbmUKICAgICAgICAnJycKICAgICAgICBzYmluX3BhdGhzID0gWycvc2JpbicsICcvdXNyL3NiaW4nLCAnL3Vzci9sb2NhbC9zYmluJ10KICAgICAgICBwYXRocyA9IFtdCiAgICAgICAgZm9yIGQgaW4gb3B0X2RpcnM6CiAgICAgICAgICAgIGlmIGQgaXMgbm90IE5vbmUgYW5kIG9zLnBhdGguZXhpc3RzKGQpOgogICAgICAgICAgICAgICAgcGF0aHMuYXBwZW5kKGQpCiAgICAgICAgcGF0aHMgKz0gb3MuZW52aXJvbi5nZXQoJ1BBVEgnLCAnJykuc3BsaXQob3MucGF0aHNlcCkKICAgICAgICBiaW5fcGF0aCA9IE5vbmUKICAgICAgICAjIG1hbmdsZSBQQVRIIHRvIGluY2x1ZGUgL3NiaW4gZGlycwogICAgICAgIGZvciBwIGluIHNiaW5fcGF0aHM6CiAgICAgICAgICAgIGlmIHAgbm90IGluIHBhdGhzIGFuZCBvcy5wYXRoLmV4aXN0cyhwKToKICAgICAgICAgICAgICAgIHBhdGhzLmFwcGVuZChwKQogICAgICAgIGZvciBkIGluIHBhdGhzOgogICAgICAgICAgICBpZiBub3QgZDoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIHBhdGggPSBvcy5wYXRoLmpvaW4oZCwgYXJnKQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhwYXRoKSBhbmQgbm90IG9zLnBhdGguaXNkaXIocGF0aCkgYW5kIGlzX2V4ZWN1dGFibGUocGF0aCk6CiAgICAgICAgICAgICAgICBiaW5fcGF0aCA9IHBhdGgKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgaWYgcmVxdWlyZWQgYW5kIGJpbl9wYXRoIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nRmFpbGVkIHRvIGZpbmQgcmVxdWlyZWQgZXhlY3V0YWJsZSAlcyBpbiBwYXRoczogJXMnICUgKGFyZywgb3MucGF0aHNlcC5qb2luKHBhdGhzKSkpCiAgICAgICAgcmV0dXJuIGJpbl9wYXRoCgogICAgZGVmIGJvb2xlYW4oc2VsZiwgYXJnKToKICAgICAgICAnJycgcmV0dXJuIGEgYm9vbCBmb3IgdGhlIGFyZyAnJycKICAgICAgICBpZiBhcmcgaXMgTm9uZSBvciBpc2luc3RhbmNlKGFyZywgYm9vbCk6CiAgICAgICAgICAgIHJldHVybiBhcmcKICAgICAgICBpZiBpc2luc3RhbmNlKGFyZywgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgYXJnID0gYXJnLmxvd2VyKCkKICAgICAgICBpZiBhcmcgaW4gQk9PTEVBTlNfVFJVRToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbGlmIGFyZyBpbiBCT09MRUFOU19GQUxTRToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSclcyBpcyBub3QgYSB2YWxpZCBib29sZWFuLiBWYWxpZCBib29sZWFucyBpbmNsdWRlOiAlcycgJSAodG9fdGV4dChhcmcpLCAnLCcuam9pbihbJyVzJyAlIHggZm9yIHggaW4gQk9PTEVBTlNdKSkpCgogICAgZGVmIGpzb25pZnkoc2VsZiwgZGF0YSk6CiAgICAgICAgZm9yIGVuY29kaW5nIGluICgidXRmLTgiLCAibGF0aW4tMSIpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5kdW1wcyhkYXRhLCBlbmNvZGluZz1lbmNvZGluZykKICAgICAgICAgICAgIyBPbGQgc3lzdGVtcyB1c2luZyBvbGQgc2ltcGxlanNvbiBtb2R1bGUgZG9lcyBub3Qgc3VwcG9ydCBlbmNvZGluZyBrZXl3b3JkLgogICAgICAgICAgICBleGNlcHQgVHlwZUVycm9yOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG5ld19kYXRhID0ganNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUoZGF0YSwgZW5jb2Rpbmc9ZW5jb2RpbmcpCiAgICAgICAgICAgICAgICBleGNlcHQgVW5pY29kZURlY29kZUVycm9yOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5kdW1wcyhuZXdfZGF0YSkKICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVEZWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdJbnZhbGlkIHVuaWNvZGUgZW5jb2RpbmcgZW5jb3VudGVyZWQnKQoKICAgIGRlZiBmcm9tX2pzb24oc2VsZiwgZGF0YSk6CiAgICAgICAgcmV0dXJuIGpzb24ubG9hZHMoZGF0YSkKCiAgICBkZWYgYWRkX2NsZWFudXBfZmlsZShzZWxmLCBwYXRoKToKICAgICAgICBpZiBwYXRoIG5vdCBpbiBzZWxmLmNsZWFudXBfZmlsZXM6CiAgICAgICAgICAgIHNlbGYuY2xlYW51cF9maWxlcy5hcHBlbmQocGF0aCkKCiAgICBkZWYgZG9fY2xlYW51cF9maWxlcyhzZWxmKToKICAgICAgICBmb3IgcGF0aCBpbiBzZWxmLmNsZWFudXBfZmlsZXM6CiAgICAgICAgICAgIHNlbGYuY2xlYW51cChwYXRoKQoKICAgIGRlZiBfcmV0dXJuX2Zvcm1hdHRlZChzZWxmLCBrd2FyZ3MpOgoKICAgICAgICBzZWxmLmFkZF9wYXRoX2luZm8oa3dhcmdzKQoKICAgICAgICBpZiAnaW52b2NhdGlvbicgbm90IGluIGt3YXJnczoKICAgICAgICAgICAga3dhcmdzWydpbnZvY2F0aW9uJ10gPSB7J21vZHVsZV9hcmdzJzogc2VsZi5wYXJhbXN9CgogICAgICAgIGlmICd3YXJuaW5ncycgaW4ga3dhcmdzOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGt3YXJnc1snd2FybmluZ3MnXSwgbGlzdCk6CiAgICAgICAgICAgICAgICBmb3IgdyBpbiBrd2FyZ3NbJ3dhcm5pbmdzJ106CiAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJuKHcpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLndhcm4oa3dhcmdzWyd3YXJuaW5ncyddKQoKICAgICAgICBpZiBzZWxmLl93YXJuaW5nczoKICAgICAgICAgICAga3dhcmdzWyd3YXJuaW5ncyddID0gc2VsZi5fd2FybmluZ3MKCiAgICAgICAgaWYgJ2RlcHJlY2F0aW9ucycgaW4ga3dhcmdzOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGt3YXJnc1snZGVwcmVjYXRpb25zJ10sIGxpc3QpOgogICAgICAgICAgICAgICAgZm9yIGQgaW4ga3dhcmdzWydkZXByZWNhdGlvbnMnXToKICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGQsIFNFUVVFTkNFVFlQRSkgYW5kIGxlbihkKSA9PSAyOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRlcHJlY2F0ZShkWzBdLCB2ZXJzaW9uPWRbMV0pCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kZXByZWNhdGUoZCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuZGVwcmVjYXRlKGt3YXJnc1snZGVwcmVjYXRpb25zJ10pCgogICAgICAgIGlmIHNlbGYuX2RlcHJlY2F0aW9uczoKICAgICAgICAgICAga3dhcmdzWydkZXByZWNhdGlvbnMnXSA9IHNlbGYuX2RlcHJlY2F0aW9ucwoKICAgICAgICBrd2FyZ3MgPSByZW1vdmVfdmFsdWVzKGt3YXJncywgc2VsZi5ub19sb2dfdmFsdWVzKQogICAgICAgIHByaW50KCdcbiVzJyAlIHNlbGYuanNvbmlmeShrd2FyZ3MpKQoKICAgIGRlZiBleGl0X2pzb24oc2VsZiwgKiprd2FyZ3MpOgogICAgICAgICcnJyByZXR1cm4gZnJvbSB0aGUgbW9kdWxlLCB3aXRob3V0IGVycm9yICcnJwoKICAgICAgICBpZiBub3QgJ2NoYW5nZWQnIGluIGt3YXJnczoKICAgICAgICAgICAga3dhcmdzWydjaGFuZ2VkJ10gPSBGYWxzZQoKICAgICAgICBzZWxmLmRvX2NsZWFudXBfZmlsZXMoKQogICAgICAgIHNlbGYuX3JldHVybl9mb3JtYXR0ZWQoa3dhcmdzKQogICAgICAgIHN5cy5leGl0KDApCgogICAgZGVmIGZhaWxfanNvbihzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgJycnIHJldHVybiBmcm9tIHRoZSBtb2R1bGUsIHdpdGggYW4gZXJyb3IgbWVzc2FnZSAnJycKCiAgICAgICAgYXNzZXJ0ICdtc2cnIGluIGt3YXJncywgImltcGxlbWVudGF0aW9uIGVycm9yIC0tIG1zZyB0byBleHBsYWluIHRoZSBlcnJvciBpcyByZXF1aXJlZCIKICAgICAgICBrd2FyZ3NbJ2ZhaWxlZCddID0gVHJ1ZQoKICAgICAgICBpZiBub3QgJ2NoYW5nZWQnIGluIGt3YXJnczoKICAgICAgICAgICAga3dhcmdzWydjaGFuZ2VkJ10gPSBGYWxzZQoKICAgICAgICBzZWxmLmRvX2NsZWFudXBfZmlsZXMoKQogICAgICAgIHNlbGYuX3JldHVybl9mb3JtYXR0ZWQoa3dhcmdzKQogICAgICAgIHN5cy5leGl0KDEpCgogICAgZGVmIGZhaWxfb25fbWlzc2luZ19wYXJhbXMoc2VsZiwgcmVxdWlyZWRfcGFyYW1zPU5vbmUpOgogICAgICAgICcnJyBUaGlzIGlzIGZvciBjaGVja2luZyBmb3IgcmVxdWlyZWQgcGFyYW1zIHdoZW4gd2UgY2FuIG5vdCBjaGVjayB2aWEgYXJnc3BlYyBiZWNhdXNlIHdlCiAgICAgICAgbmVlZCBtb3JlIGluZm9ybWF0aW9uIHRoYW4gaXMgc2ltcGx5IGdpdmVuIGluIHRoZSBhcmdzcGVjLgogICAgICAgICcnJwogICAgICAgIGlmIG5vdCByZXF1aXJlZF9wYXJhbXM6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIG1pc3NpbmdfcGFyYW1zID0gW10KICAgICAgICBmb3IgcmVxdWlyZWRfcGFyYW0gaW4gcmVxdWlyZWRfcGFyYW1zOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5wYXJhbXMuZ2V0KHJlcXVpcmVkX3BhcmFtKToKICAgICAgICAgICAgICAgIG1pc3NpbmdfcGFyYW1zLmFwcGVuZChyZXF1aXJlZF9wYXJhbSkKICAgICAgICBpZiBtaXNzaW5nX3BhcmFtczoKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJtaXNzaW5nIHJlcXVpcmVkIGFyZ3VtZW50czogJXMiICUgJywnLmpvaW4obWlzc2luZ19wYXJhbXMpKQoKICAgIGRlZiBkaWdlc3RfZnJvbV9maWxlKHNlbGYsIGZpbGVuYW1lLCBhbGdvcml0aG0pOgogICAgICAgICcnJyBSZXR1cm4gaGV4IGRpZ2VzdCBvZiBsb2NhbCBmaWxlIGZvciBhIGRpZ2VzdF9tZXRob2Qgc3BlY2lmaWVkIGJ5IG5hbWUsIG9yIE5vbmUgaWYgZmlsZSBpcyBub3QgcHJlc2VudC4gJycnCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVuYW1lKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBpZiBvcy5wYXRoLmlzZGlyKGZpbGVuYW1lKToKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJhdHRlbXB0ZWQgdG8gdGFrZSBjaGVja3N1bSBvZiBkaXJlY3Rvcnk6ICVzIiAlIGZpbGVuYW1lKQoKICAgICAgICAjIHByZXNlcnZlIG9sZCBiZWhhdmlvdXIgd2hlcmUgdGhlIHRoaXJkIHBhcmFtZXRlciB3YXMgYSBoYXNoIGFsZ29yaXRobSBvYmplY3QKICAgICAgICBpZiBoYXNhdHRyKGFsZ29yaXRobSwgJ2hleGRpZ2VzdCcpOgogICAgICAgICAgICBkaWdlc3RfbWV0aG9kID0gYWxnb3JpdGhtCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGlnZXN0X21ldGhvZCA9IEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVNbYWxnb3JpdGhtXSgpCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iQ291bGQgbm90IGhhc2ggZmlsZSAnJXMnIHdpdGggYWxnb3JpdGhtICclcycuIEF2YWlsYWJsZSBhbGdvcml0aG1zOiAlcyIgJQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmaWxlbmFtZSwgYWxnb3JpdGhtLCAnLCAnLmpvaW4oQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNUykpKQoKICAgICAgICBibG9ja3NpemUgPSA2NCAqIDEwMjQKICAgICAgICBpbmZpbGUgPSBvcGVuKG9zLnBhdGgucmVhbHBhdGgoZmlsZW5hbWUpLCAncmInKQogICAgICAgIGJsb2NrID0gaW5maWxlLnJlYWQoYmxvY2tzaXplKQogICAgICAgIHdoaWxlIGJsb2NrOgogICAgICAgICAgICBkaWdlc3RfbWV0aG9kLnVwZGF0ZShibG9jaykKICAgICAgICAgICAgYmxvY2sgPSBpbmZpbGUucmVhZChibG9ja3NpemUpCiAgICAgICAgaW5maWxlLmNsb3NlKCkKICAgICAgICByZXR1cm4gZGlnZXN0X21ldGhvZC5oZXhkaWdlc3QoKQoKICAgIGRlZiBtZDUoc2VsZiwgZmlsZW5hbWUpOgogICAgICAgICcnJyBSZXR1cm4gTUQ1IGhleCBkaWdlc3Qgb2YgbG9jYWwgZmlsZSB1c2luZyBkaWdlc3RfZnJvbV9maWxlKCkuCgogICAgICAgIERvIG5vdCB1c2UgdGhpcyBmdW5jdGlvbiB1bmxlc3MgeW91IGhhdmUgbm8gb3RoZXIgY2hvaWNlIGZvcjoKICAgICAgICAgICAgMSkgT3B0aW9uYWwgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgMikgQ29tcGF0aWJpbGl0eSB3aXRoIGEgdGhpcmQgcGFydHkgcHJvdG9jb2wKCiAgICAgICAgVGhpcyBmdW5jdGlvbiB3aWxsIG5vdCB3b3JrIG9uIHN5c3RlbXMgY29tcGx5aW5nIHdpdGggRklQUy0xNDAtMi4KCiAgICAgICAgTW9zdCB1c2VzIG9mIHRoaXMgZnVuY3Rpb24gY2FuIHVzZSB0aGUgbW9kdWxlLnNoYTEgZnVuY3Rpb24gaW5zdGVhZC4KICAgICAgICAnJycKICAgICAgICBpZiAnbWQ1JyBub3QgaW4gQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNUzoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignTUQ1IG5vdCBhdmFpbGFibGUuICBQb3NzaWJseSBydW5uaW5nIGluIEZJUFMgbW9kZScpCiAgICAgICAgcmV0dXJuIHNlbGYuZGlnZXN0X2Zyb21fZmlsZShmaWxlbmFtZSwgJ21kNScpCgogICAgZGVmIHNoYTEoc2VsZiwgZmlsZW5hbWUpOgogICAgICAgICcnJyBSZXR1cm4gU0hBMSBoZXggZGlnZXN0IG9mIGxvY2FsIGZpbGUgdXNpbmcgZGlnZXN0X2Zyb21fZmlsZSgpLiAnJycKICAgICAgICByZXR1cm4gc2VsZi5kaWdlc3RfZnJvbV9maWxlKGZpbGVuYW1lLCAnc2hhMScpCgogICAgZGVmIHNoYTI1NihzZWxmLCBmaWxlbmFtZSk6CiAgICAgICAgJycnIFJldHVybiBTSEEtMjU2IGhleCBkaWdlc3Qgb2YgbG9jYWwgZmlsZSB1c2luZyBkaWdlc3RfZnJvbV9maWxlKCkuICcnJwogICAgICAgIHJldHVybiBzZWxmLmRpZ2VzdF9mcm9tX2ZpbGUoZmlsZW5hbWUsICdzaGEyNTYnKQoKICAgIGRlZiBiYWNrdXBfbG9jYWwoc2VsZiwgZm4pOgogICAgICAgICcnJ21ha2UgYSBkYXRlLW1hcmtlZCBiYWNrdXAgb2YgdGhlIHNwZWNpZmllZCBmaWxlLCByZXR1cm4gVHJ1ZSBvciBGYWxzZSBvbiBzdWNjZXNzIG9yIGZhaWx1cmUnJycKCiAgICAgICAgYmFja3VwZGVzdCA9ICcnCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZm4pOgogICAgICAgICAgICAjIGJhY2t1cHMgbmFtZWQgYmFzZW5hbWUuUElELllZWVktTU0tRERASEg6TU06U1N+CiAgICAgICAgICAgIGV4dCA9IHRpbWUuc3RyZnRpbWUoIiVZLSVtLSVkQCVIOiVNOiVTfiIsIHRpbWUubG9jYWx0aW1lKHRpbWUudGltZSgpKSkKICAgICAgICAgICAgYmFja3VwZGVzdCA9ICclcy4lcy4lcycgJSAoZm4sIG9zLmdldHBpZCgpLCBleHQpCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzaHV0aWwuY29weTIoZm4sIGJhY2t1cGRlc3QpCiAgICAgICAgICAgIGV4Y2VwdCAoc2h1dGlsLkVycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nQ291bGQgbm90IG1ha2UgYmFja3VwIG9mICVzIHRvICVzOiAlcycgJSAoZm4sIGJhY2t1cGRlc3QsIGUpKQoKICAgICAgICByZXR1cm4gYmFja3VwZGVzdAoKICAgIGRlZiBjbGVhbnVwKHNlbGYsIHRtcGZpbGUpOgogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHRtcGZpbGUpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy51bmxpbmsodG1wZmlsZSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzeXMuc3RkZXJyLndyaXRlKCJjb3VsZCBub3QgY2xlYW51cCAlczogJXMiICUgKHRtcGZpbGUsIGUpKQoKICAgIGRlZiBhdG9taWNfbW92ZShzZWxmLCBzcmMsIGRlc3QsIHVuc2FmZV93cml0ZXM9RmFsc2UpOgogICAgICAgICcnJ2F0b21pY2FsbHkgbW92ZSBzcmMgdG8gZGVzdCwgY29weWluZyBhdHRyaWJ1dGVzIGZyb20gZGVzdCwgcmV0dXJucyB0cnVlIG9uIHN1Y2Nlc3MKICAgICAgICBpdCB1c2VzIG9zLnJlbmFtZSB0byBlbnN1cmUgdGhpcyBhcyBpdCBpcyBhbiBhdG9taWMgb3BlcmF0aW9uLCByZXN0IG9mIHRoZSBmdW5jdGlvbiBpcwogICAgICAgIHRvIHdvcmsgYXJvdW5kIGxpbWl0YXRpb25zLCBjb3JuZXIgY2FzZXMgYW5kIGVuc3VyZSBzZWxpbnV4IGNvbnRleHQgaXMgc2F2ZWQgaWYgcG9zc2libGUnJycKICAgICAgICBjb250ZXh0ID0gTm9uZQogICAgICAgIGRlc3Rfc3RhdCA9IE5vbmUKICAgICAgICBiX3NyYyA9IHRvX2J5dGVzKHNyYywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBiX2Rlc3QgPSB0b19ieXRlcyhkZXN0LCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGJfZGVzdCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRlc3Rfc3RhdCA9IG9zLnN0YXQoYl9kZXN0KQoKICAgICAgICAgICAgICAgICMgY29weSBtb2RlIGFuZCBvd25lcnNoaXAKICAgICAgICAgICAgICAgIG9zLmNobW9kKGJfc3JjLCBkZXN0X3N0YXQuc3RfbW9kZSAmIFBFUk1fQklUUykKICAgICAgICAgICAgICAgIG9zLmNob3duKGJfc3JjLCBkZXN0X3N0YXQuc3RfdWlkLCBkZXN0X3N0YXQuc3RfZ2lkKQoKICAgICAgICAgICAgICAgICMgdHJ5IHRvIGNvcHkgZmxhZ3MgaWYgcG9zc2libGUKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIob3MsICdjaGZsYWdzJykgYW5kIGhhc2F0dHIoZGVzdF9zdGF0LCAnc3RfZmxhZ3MnKToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNoZmxhZ3MoYl9zcmMsIGRlc3Rfc3RhdC5zdF9mbGFncykKICAgICAgICAgICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgZXJyIGluICdFT1BOT1RTVVBQJywgJ0VOT1RTVVAnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgaGFzYXR0cihlcnJubywgZXJyKSBhbmQgZS5lcnJubyA9PSBnZXRhdHRyKGVycm5vLCBlcnIpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIGlmIGUuZXJybm8gIT0gZXJybm8uRVBFUk06CiAgICAgICAgICAgICAgICAgICAgcmFpc2UKICAgICAgICAgICAgaWYgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfY29udGV4dChkZXN0KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2RlZmF1bHRfY29udGV4dChkZXN0KQoKICAgICAgICBjcmVhdGluZyA9IG5vdCBvcy5wYXRoLmV4aXN0cyhiX2Rlc3QpCgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBPcHRpbWlzdGljYWxseSB0cnkgYSByZW5hbWUsIHNvbHZlcyBzb21lIGNvcm5lciBjYXNlcyBhbmQgY2FuIGF2b2lkIHVzZWxlc3Mgd29yaywgdGhyb3dzIGV4Y2VwdGlvbiBpZiBub3QgYXRvbWljLgogICAgICAgICAgICBvcy5yZW5hbWUoYl9zcmMsIGJfZGVzdCkKICAgICAgICBleGNlcHQgKElPRXJyb3IsIE9TRXJyb3IpOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIGlmIGUuZXJybm8gbm90IGluIFtlcnJuby5FUEVSTSwgZXJybm8uRVhERVYsIGVycm5vLkVBQ0NFUywgZXJybm8uRVRYVEJTWSwgZXJybm8uRUJVU1ldOgogICAgICAgICAgICAgICAgIyBvbmx5IHRyeSB3b3JrYXJvdW5kcyBmb3IgZXJybm8gMTggKGNyb3NzIGRldmljZSksIDEgKG5vdCBwZXJtaXR0ZWQpLCAgMTMgKHBlcm1pc3Npb24gZGVuaWVkKQogICAgICAgICAgICAgICAgIyBhbmQgMjYgKHRleHQgZmlsZSBidXN5KSB3aGljaCBoYXBwZW5zIG9uIHZhZ3JhbnQgc3luY2VkIGZvbGRlcnMgYW5kIG90aGVyICdleG90aWMnIG5vbiBwb3NpeCBmaWxlIHN5c3RlbXMKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nQ291bGQgbm90IHJlcGxhY2UgZmlsZTogJXMgdG8gJXM6ICVzJyAlIChzcmMsIGRlc3QsIGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJfZGVzdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUoYl9kZXN0KQogICAgICAgICAgICAgICAgIyBVc2UgYnl0ZXMgaGVyZS4gIEluIHRoZSBzaGlwcGFibGUgQ0ksIHRoaXMgZmFpbHMgd2l0aAogICAgICAgICAgICAgICAgIyBhIFVuaWNvZGVFcnJvciB3aXRoIHN1cnJvZ2F0ZWVzY2FwZSdkIHN0cmluZ3MgZm9yIGFuIHVua25vd24KICAgICAgICAgICAgICAgICMgcmVhc29uIChkb2Vzbid0IGhhcHBlbiBpbiBhIGxvY2FsIFVidW50dTE2LjA0IFZNKQogICAgICAgICAgICAgICAgbmF0aXZlX2Rlc3RfZGlyID0gYl9kZXN0X2RpcgogICAgICAgICAgICAgICAgbmF0aXZlX3N1ZmZpeCA9IG9zLnBhdGguYmFzZW5hbWUoYl9kZXN0KQogICAgICAgICAgICAgICAgbmF0aXZlX3ByZWZpeCA9IGIoJy5hbnNpYmxlX3RtcCcpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdG1wX2Rlc3RfZmQsIHRtcF9kZXN0X25hbWUgPSB0ZW1wZmlsZS5ta3N0ZW1wKCBwcmVmaXg9bmF0aXZlX3ByZWZpeCwgZGlyPW5hdGl2ZV9kZXN0X2Rpciwgc3VmZml4PW5hdGl2ZV9zdWZmaXgpCiAgICAgICAgICAgICAgICBleGNlcHQgKE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J1RoZSBkZXN0aW5hdGlvbiBkaXJlY3RvcnkgKCVzKSBpcyBub3Qgd3JpdGFibGUgYnkgdGhlIGN1cnJlbnQgdXNlci4gRXJyb3Igd2FzOiAlcycgJSAob3MucGF0aC5kaXJuYW1lKGRlc3QpLCBlKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBUeXBlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgIyBXZSBleHBlY3QgdGhhdCB0aGlzIGlzIGhhcHBlbmluZyBiZWNhdXNlIHB5dGhvbjMuNC54IGFuZAogICAgICAgICAgICAgICAgICAgICMgYmVsb3cgY2FuJ3QgaGFuZGxlIGJ5dGUgc3RyaW5ncyBpbiBta3N0ZW1wKCkuICBUcmFjZWJhY2sKICAgICAgICAgICAgICAgICAgICAjIHdvdWxkIGVuZCBpbiBzb21ldGhpbmcgbGlrZToKICAgICAgICAgICAgICAgICAgICAjICAgICBmaWxlID0gX29zLnBhdGguam9pbihkaXIsIHByZSArIG5hbWUgKyBzdWYpCiAgICAgICAgICAgICAgICAgICAgIyBUeXBlRXJyb3I6IGNhbid0IGNvbmNhdCBieXRlcyB0byBzdHIKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0ZhaWxlZCBjcmVhdGluZyB0ZW1wIGZpbGUgZm9yIGF0b21pYyBtb3ZlLiAgVGhpcyB1c3VhbGx5IGhhcHBlbnMgd2hlbiB1c2luZyBQeXRob24zIGxlc3MgdGhhbiBQeXRob24zLjUuICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1BsZWFzZSB1c2UgUHl0aG9uMi54IG9yIFB5dGhvbjMuNSBvciBncmVhdGVyLicsIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQoKICAgICAgICAgICAgICAgIGJfdG1wX2Rlc3RfbmFtZSA9IHRvX2J5dGVzKHRtcF9kZXN0X25hbWUsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgIyBjbG9zZSB0bXAgZmlsZSBoYW5kbGUgYmVmb3JlIGZpbGUgb3BlcmF0aW9ucyB0byBwcmV2ZW50IHRleHQgZmlsZSBidXN5IGVycm9ycyBvbiB2Ym94ZnMgc3luY2VkIGZvbGRlcnMgKHdpbmRvd3MgaG9zdCkKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2xvc2UodG1wX2Rlc3RfZmQpCiAgICAgICAgICAgICAgICAgICAgICAgICMgbGVhdmVzIHRtcCBmaWxlIGJlaGluZCB3aGVuIHN1ZG8gYW5kIG5vdCByb290CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNodXRpbC5tb3ZlKGJfc3JjLCBiX3RtcF9kZXN0X25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBjbGVhbnVwIHdpbGwgaGFwcGVuIGJ5ICdybScgb2YgdGVtcGRpcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBjb3B5MiB3aWxsIHByZXNlcnZlIHNvbWUgbWV0YWRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5MihiX3NyYywgYl90bXBfZGVzdF9uYW1lKQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJfdG1wX2Rlc3RfbmFtZSwgY29udGV4dCwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcF9zdGF0ID0gb3Muc3RhdChiX3RtcF9kZXN0X25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkZXN0X3N0YXQgYW5kICh0bXBfc3RhdC5zdF91aWQgIT0gZGVzdF9zdGF0LnN0X3VpZCBvciB0bXBfc3RhdC5zdF9naWQgIT0gZGVzdF9zdGF0LnN0X2dpZCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2hvd24oYl90bXBfZGVzdF9uYW1lLCBkZXN0X3N0YXQuc3RfdWlkLCBkZXN0X3N0YXQuc3RfZ2lkKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGUuZXJybm8gIT0gZXJybm8uRVBFUk06CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MucmVuYW1lKGJfdG1wX2Rlc3RfbmFtZSwgYl9kZXN0KQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgKHNodXRpbC5FcnJvciwgT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB1bnNhZmVfd3JpdGVzIGFuZCBlLmVycm5vID09IGVycm5vLkVCVVNZOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3Vuc2FmZV93cml0ZXMoYl90bXBfZGVzdF9uYW1lLCBiX2Rlc3QpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nVW5hYmxlIHRvIHJlbmFtZSBmaWxlOiAlcyB0byAlczogJXMnICUgKHNyYywgZGVzdCwgZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCAoc2h1dGlsLkVycm9yLCBPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0ZhaWxlZCB0byByZXBsYWNlIGZpbGU6ICVzIHRvICVzOiAlcycgJSAoc3JjLCBkZXN0LCBlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCiAgICAgICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuY2xlYW51cChiX3RtcF9kZXN0X25hbWUpCgogICAgICAgIGlmIGNyZWF0aW5nOgogICAgICAgICAgICAjIG1ha2Ugc3VyZSB0aGUgZmlsZSBoYXMgdGhlIGNvcnJlY3QgcGVybWlzc2lvbnMKICAgICAgICAgICAgIyBiYXNlZCBvbiB0aGUgY3VycmVudCB2YWx1ZSBvZiB1bWFzawogICAgICAgICAgICB1bWFzayA9IG9zLnVtYXNrKDApCiAgICAgICAgICAgIG9zLnVtYXNrKHVtYXNrKQogICAgICAgICAgICBvcy5jaG1vZChiX2Rlc3QsIERFRkFVTFRfUEVSTSAmIH51bWFzaykKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MuY2hvd24oYl9kZXN0LCBvcy5nZXRldWlkKCksIG9zLmdldGVnaWQoKSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAjIFdlJ3JlIG9rYXkgd2l0aCB0cnlpbmcgb3VyIGJlc3QgaGVyZS4gIElmIHRoZSB1c2VyIGlzIG5vdAogICAgICAgICAgICAgICAgIyByb290IChvciBvbGQgVW5pY2VzKSB0aGV5IHdvbid0IGJlIGFibGUgdG8gY2hvd24uCiAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgIGlmIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICMgcmVuYW1lIG1pZ2h0IG5vdCBwcmVzZXJ2ZSBjb250ZXh0CiAgICAgICAgICAgIHNlbGYuc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KGRlc3QsIGNvbnRleHQsIEZhbHNlKQoKICAgIGRlZiBfdW5zYWZlX3dyaXRlcyhzZWxmLCBzcmMsIGRlc3QpOgogICAgICAgICMgc2FkbHkgdGhlcmUgYXJlIHNvbWUgc2l0dWF0aW9ucyB3aGVyZSB3ZSBjYW5ub3QgZW5zdXJlIGF0b21pY2l0eSwgYnV0IG9ubHkgaWYKICAgICAgICAjIHRoZSB1c2VyIGluc2lzdHMgYW5kIHdlIGdldCB0aGUgYXBwcm9wcmlhdGUgZXJyb3Igd2UgdXBkYXRlIHRoZSBmaWxlIHVuc2FmZWx5CiAgICAgICAgdHJ5OgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvdXRfZGVzdCA9IG9wZW4oZGVzdCwgJ3diJykKICAgICAgICAgICAgICAgIGluX3NyYyA9IG9wZW4oc3JjLCAncmInKQogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHlmaWxlb2JqKGluX3NyYywgb3V0X2Rlc3QpCiAgICAgICAgICAgIGZpbmFsbHk6ICAjIGFzc3VyaW5nIGNsb3NlZCBmaWxlcyBpbiAyLjQgY29tcGF0aWJsZSB3YXkKICAgICAgICAgICAgICAgIGlmIG91dF9kZXN0OgogICAgICAgICAgICAgICAgICAgIG91dF9kZXN0LmNsb3NlKCkKICAgICAgICAgICAgICAgIGlmIGluX3NyYzoKICAgICAgICAgICAgICAgICAgICBpbl9zcmMuY2xvc2UoKQogICAgICAgIGV4Y2VwdCAoc2h1dGlsLkVycm9yLCBPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0NvdWxkIG5vdCB3cml0ZSBkYXRhIHRvIGZpbGUgKCVzKSBmcm9tICglcyk6ICVzJyAlIChkZXN0LCBzcmMsIGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKCgogICAgZGVmIF9yZWFkX2Zyb21fcGlwZXMoc2VsZiwgcnBpcGVzLCByZmRzLCBmaWxlX2Rlc2NyaXB0b3IpOgogICAgICAgIGRhdGEgPSBiKCcnKQogICAgICAgIGlmIGZpbGVfZGVzY3JpcHRvciBpbiByZmRzOgogICAgICAgICAgICBkYXRhID0gb3MucmVhZChmaWxlX2Rlc2NyaXB0b3IuZmlsZW5vKCksIDkwMDApCiAgICAgICAgICAgIGlmIGRhdGEgPT0gYignJyk6CiAgICAgICAgICAgICAgICBycGlwZXMucmVtb3ZlKGZpbGVfZGVzY3JpcHRvcikKCiAgICAgICAgcmV0dXJuIGRhdGEKCiAgICBkZWYgcnVuX2NvbW1hbmQoc2VsZiwgYXJncywgY2hlY2tfcmM9RmFsc2UsIGNsb3NlX2Zkcz1UcnVlLCBleGVjdXRhYmxlPU5vbmUsIGRhdGE9Tm9uZSwgYmluYXJ5X2RhdGE9RmFsc2UsIHBhdGhfcHJlZml4PU5vbmUsIGN3ZD1Ob25lLAogICAgICAgICAgICAgICAgICAgIHVzZV91bnNhZmVfc2hlbGw9RmFsc2UsIHByb21wdF9yZWdleD1Ob25lLCBlbnZpcm9uX3VwZGF0ZT1Ob25lLCB1bWFzaz1Ob25lLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKToKICAgICAgICAnJycKICAgICAgICBFeGVjdXRlIGEgY29tbWFuZCwgcmV0dXJucyByYywgc3Rkb3V0LCBhbmQgc3RkZXJyLgoKICAgICAgICA6YXJnIGFyZ3M6IGlzIHRoZSBjb21tYW5kIHRvIHJ1bgogICAgICAgICAgICAqIElmIGFyZ3MgaXMgYSBsaXN0LCB0aGUgY29tbWFuZCB3aWxsIGJlIHJ1biB3aXRoIHNoZWxsPUZhbHNlLgogICAgICAgICAgICAqIElmIGFyZ3MgaXMgYSBzdHJpbmcgYW5kIHVzZV91bnNhZmVfc2hlbGw9RmFsc2UgaXQgd2lsbCBzcGxpdCBhcmdzIHRvIGEgbGlzdCBhbmQgcnVuIHdpdGggc2hlbGw9RmFsc2UKICAgICAgICAgICAgKiBJZiBhcmdzIGlzIGEgc3RyaW5nIGFuZCB1c2VfdW5zYWZlX3NoZWxsPVRydWUgaXQgcnVucyB3aXRoIHNoZWxsPVRydWUuCiAgICAgICAgOmt3IGNoZWNrX3JjOiBXaGV0aGVyIHRvIGNhbGwgZmFpbF9qc29uIGluIGNhc2Ugb2Ygbm9uIHplcm8gUkMuCiAgICAgICAgICAgIERlZmF1bHQgRmFsc2UKICAgICAgICA6a3cgY2xvc2VfZmRzOiBTZWUgZG9jdW1lbnRhdGlvbiBmb3Igc3VicHJvY2Vzcy5Qb3BlbigpLiBEZWZhdWx0IFRydWUKICAgICAgICA6a3cgZXhlY3V0YWJsZTogU2VlIGRvY3VtZW50YXRpb24gZm9yIHN1YnByb2Nlc3MuUG9wZW4oKS4gRGVmYXVsdCBOb25lCiAgICAgICAgOmt3IGRhdGE6IElmIGdpdmVuLCBpbmZvcm1hdGlvbiB0byB3cml0ZSB0byB0aGUgc3RkaW4gb2YgdGhlIGNvbW1hbmQKICAgICAgICA6a3cgYmluYXJ5X2RhdGE6IElmIEZhbHNlLCBhcHBlbmQgYSBuZXdsaW5lIHRvIHRoZSBkYXRhLiAgRGVmYXVsdCBGYWxzZQogICAgICAgIDprdyBwYXRoX3ByZWZpeDogSWYgZ2l2ZW4sIGFkZGl0aW9uYWwgcGF0aCB0byBmaW5kIHRoZSBjb21tYW5kIGluLgogICAgICAgICAgICBUaGlzIGFkZHMgdG8gdGhlIFBBVEggZW52aXJvbm1lbnQgdmFpcmFibGUgc28gaGVscGVyIGNvbW1hbmRzIGluCiAgICAgICAgICAgIHRoZSBzYW1lIGRpcmVjdG9yeSBjYW4gYWxzbyBiZSBmb3VuZAogICAgICAgIDprdyBjd2Q6IElmIGdpdmVuLCB3b3JraW5nIGRpcmVjdG9yeSB0byBydW4gdGhlIGNvbW1hbmQgaW5zaWRlCiAgICAgICAgOmt3IHVzZV91bnNhZmVfc2hlbGw6IFNlZSBgYXJnc2AgcGFyYW1ldGVyLiAgRGVmYXVsdCBGYWxzZQogICAgICAgIDprdyBwcm9tcHRfcmVnZXg6IFJlZ2V4IHN0cmluZyAobm90IGEgY29tcGlsZWQgcmVnZXgpIHdoaWNoIGNhbiBiZQogICAgICAgICAgICB1c2VkIHRvIGRldGVjdCBwcm9tcHRzIGluIHRoZSBzdGRvdXQgd2hpY2ggd291bGQgb3RoZXJ3aXNlIGNhdXNlCiAgICAgICAgICAgIHRoZSBleGVjdXRpb24gdG8gaGFuZyAoZXNwZWNpYWxseSBpZiBubyBpbnB1dCBkYXRhIGlzIHNwZWNpZmllZCkKICAgICAgICA6a3cgZW52aXJvbl91cGRhdGU6IGRpY3Rpb25hcnkgdG8gKnVwZGF0ZSogb3MuZW52aXJvbiB3aXRoCiAgICAgICAgOmt3IHVtYXNrOiBVbWFzayB0byBiZSB1c2VkIHdoZW4gcnVubmluZyB0aGUgY29tbWFuZC4gRGVmYXVsdCBOb25lCiAgICAgICAgOmt3IGVuY29kaW5nOiBTaW5jZSB3ZSByZXR1cm4gbmF0aXZlIHN0cmluZ3MsIG9uIHB5dGhvbjMgd2UgbmVlZCB0bwogICAgICAgICAgICBrbm93IHRoZSBlbmNvZGluZyB0byB1c2UgdG8gdHJhbnNmb3JtIGZyb20gYnl0ZXMgdG8gdGV4dC4gIElmIHlvdQogICAgICAgICAgICB3YW50IHRvIGFsd2F5cyBnZXQgYnl0ZXMgYmFjaywgdXNlIGVuY29kaW5nPU5vbmUuICBUaGUgZGVmYXVsdCBpcwogICAgICAgICAgICAidXRmLTgiLiAgVGhpcyBkb2VzIG5vdCBhZmZlY3QgdHJhbnNmb3JtYXRpb24gb2Ygc3RyaW5ncyBnaXZlbiBhcwogICAgICAgICAgICBhcmdzLgogICAgICAgIDprdyBlcnJvcnM6IFNpbmNlIHdlIHJldHVybiBuYXRpdmUgc3RyaW5ncywgb24gcHl0aG9uMyB3ZSBuZWVkIHRvCiAgICAgICAgICAgIHRyYW5zZm9ybSBzdGRvdXQgYW5kIHN0ZGVyciBmcm9tIGJ5dGVzIHRvIHRleHQuICBJZiB0aGUgYnl0ZXMgYXJlCiAgICAgICAgICAgIHVuZGVjb2RhYmxlIGluIHRoZSBgYGVuY29kaW5nYGAgc3BlY2lmaWVkLCB0aGVuIHVzZSB0aGlzIGVycm9yCiAgICAgICAgICAgIGhhbmRsZXIgdG8gZGVhbCB3aXRoIHRoZW0uICBUaGUgZGVmYXVsdCBpcyBgYHN1cnJvZ2F0ZV9vcl9zdHJpY3RgYAogICAgICAgICAgICB3aGljaCBtZWFucyB0aGF0IHRoZSBieXRlcyB3aWxsIGJlIGRlY29kZWQgdXNpbmcgdGhlCiAgICAgICAgICAgIHN1cnJvZ2F0ZWVzY2FwZSBlcnJvciBoYW5kbGVyIGlmIGF2YWlsYWJsZSAoYXZhaWxhYmxlIG9uIGFsbAogICAgICAgICAgICBweXRob24zIHZlcnNpb25zIHdlIHN1cHBvcnQpIG90aGVyd2lzZSBhIFVuaWNvZGVFcnJvciB0cmFjZWJhY2sKICAgICAgICAgICAgd2lsbCBiZSByYWlzZWQuICBUaGlzIGRvZXMgbm90IGFmZmVjdCB0cmFuc2Zvcm1hdGlvbnMgb2Ygc3RyaW5ncwogICAgICAgICAgICBnaXZlbiBhcyBhcmdzLgogICAgICAgIDpyZXR1cm5zOiBBIDMtdHVwbGUgb2YgcmV0dXJuIGNvZGUgKGludGVnZXIpLCBzdGRvdXQgKG5hdGl2ZSBzdHJpbmcpLAogICAgICAgICAgICBhbmQgc3RkZXJyIChuYXRpdmUgc3RyaW5nKS4gIE9uIHB5dGhvbjIsIHN0ZG91dCBhbmQgc3RkZXJyIGFyZSBib3RoCiAgICAgICAgICAgIGJ5dGUgc3RyaW5ncy4gIE9uIHB5dGhvbjMsIHN0ZG91dCBhbmQgc3RkZXJyIGFyZSB0ZXh0IHN0cmluZ3MgY29udmVydGVkCiAgICAgICAgICAgIGFjY29yZGluZyB0byB0aGUgZW5jb2RpbmcgYW5kIGVycm9ycyBwYXJhbWV0ZXJzLiAgSWYgeW91IHdhbnQgYnl0ZQogICAgICAgICAgICBzdHJpbmdzIG9uIHB5dGhvbjMsIHVzZSBlbmNvZGluZz1Ob25lIHRvIHR1cm4gZGVjb2RpbmcgdG8gdGV4dCBvZmYuCiAgICAgICAgJycnCgogICAgICAgIGlmIGlzaW5zdGFuY2UoYXJncywgbGlzdCk6CiAgICAgICAgICAgIGlmIHVzZV91bnNhZmVfc2hlbGw6CiAgICAgICAgICAgICAgICBhcmdzID0gIiAiLmpvaW4oW3NobGV4X3F1b3RlKHgpIGZvciB4IGluIGFyZ3NdKQogICAgICAgICAgICAgICAgc2hlbGwgPSBUcnVlCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGFyZ3MsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSkgYW5kIHVzZV91bnNhZmVfc2hlbGw6CiAgICAgICAgICAgIHNoZWxsID0gVHJ1ZQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShhcmdzLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpOgogICAgICAgICAgICBpZiBub3QgdXNlX3Vuc2FmZV9zaGVsbDoKICAgICAgICAgICAgICAgICMgT24gcHl0aG9uMi42IGFuZCBiZWxvdywgc2hsZXggaGFzIHByb2JsZW1zIHdpdGggdGV4dCB0eXBlCiAgICAgICAgICAgICAgICAjIE9uIHB5dGhvbjMsIHNobGV4IG5lZWRzIGEgdGV4dCB0eXBlLgogICAgICAgICAgICAgICAgaWYgUFkyOgogICAgICAgICAgICAgICAgICAgIGFyZ3MgPSB0b19ieXRlcyhhcmdzLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgICAgICAgICAgZWxpZiBQWTM6CiAgICAgICAgICAgICAgICAgICAgYXJncyA9IHRvX3RleHQoYXJncywgZXJyb3JzPSdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICAgICAgICAgYXJncyA9IHNobGV4LnNwbGl0KGFyZ3MpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbXNnID0gIkFyZ3VtZW50ICdhcmdzJyB0byBydW5fY29tbWFuZCBtdXN0IGJlIGxpc3Qgb3Igc3RyaW5nIgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihyYz0yNTcsIGNtZD1hcmdzLCBtc2c9bXNnKQoKICAgICAgICBzaGVsbCA9IEZhbHNlCiAgICAgICAgaWYgdXNlX3Vuc2FmZV9zaGVsbDoKICAgICAgICAgICAgaWYgZXhlY3V0YWJsZSBpcyBOb25lOgogICAgICAgICAgICAgICAgZXhlY3V0YWJsZSA9IG9zLmVudmlyb24uZ2V0KCdTSEVMTCcpCiAgICAgICAgICAgIGlmIGV4ZWN1dGFibGU6CiAgICAgICAgICAgICAgICBhcmdzID0gW2V4ZWN1dGFibGUsICctYycsIGFyZ3NdCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzaGVsbCA9IFRydWUKCiAgICAgICAgcHJvbXB0X3JlID0gTm9uZQogICAgICAgIGlmIHByb21wdF9yZWdleDoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShwcm9tcHRfcmVnZXgsIHRleHRfdHlwZSk6CiAgICAgICAgICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgICAgICAgICAgcHJvbXB0X3JlZ2V4ID0gdG9fYnl0ZXMocHJvbXB0X3JlZ2V4LCBlcnJvcnM9J3N1cnJvZ2F0ZWVzY2FwZScpCiAgICAgICAgICAgICAgICBlbGlmIFBZMjoKICAgICAgICAgICAgICAgICAgICBwcm9tcHRfcmVnZXggPSB0b19ieXRlcyhwcm9tcHRfcmVnZXgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHByb21wdF9yZSA9IHJlLmNvbXBpbGUocHJvbXB0X3JlZ2V4LCByZS5NVUxUSUxJTkUpCiAgICAgICAgICAgIGV4Y2VwdCByZS5lcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iaW52YWxpZCBwcm9tcHQgcmVndWxhciBleHByZXNzaW9uIGdpdmVuIHRvIHJ1bl9jb21tYW5kIikKCiAgICAgICAgIyBleHBhbmQgdGhpbmdzIGxpa2UgJEhPTUUgYW5kIH4KICAgICAgICBpZiBub3Qgc2hlbGw6CiAgICAgICAgICAgIGFyZ3MgPSBbIG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoeCkpIGZvciB4IGluIGFyZ3MgaWYgeCBpcyBub3QgTm9uZSBdCgogICAgICAgIHJjID0gMAogICAgICAgIG1zZyA9IE5vbmUKICAgICAgICBzdF9pbiA9IE5vbmUKCiAgICAgICAgIyBNYW5pcHVsYXRlIHRoZSBlbnZpcm9uIHdlJ2xsIHNlbmQgdG8gdGhlIG5ldyBwcm9jZXNzCiAgICAgICAgb2xkX2Vudl92YWxzID0ge30KICAgICAgICAjIFdlIGNhbiBzZXQgdGhpcyBmcm9tIGJvdGggYW4gYXR0cmlidXRlIGFuZCBwZXIgY2FsbAogICAgICAgIGZvciBrZXksIHZhbCBpbiBzZWxmLnJ1bl9jb21tYW5kX2Vudmlyb25fdXBkYXRlLml0ZW1zKCk6CiAgICAgICAgICAgIG9sZF9lbnZfdmFsc1trZXldID0gb3MuZW52aXJvbi5nZXQoa2V5LCBOb25lKQogICAgICAgICAgICBvcy5lbnZpcm9uW2tleV0gPSB2YWwKICAgICAgICBpZiBlbnZpcm9uX3VwZGF0ZToKICAgICAgICAgICAgZm9yIGtleSwgdmFsIGluIGVudmlyb25fdXBkYXRlLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBvbGRfZW52X3ZhbHNba2V5XSA9IG9zLmVudmlyb24uZ2V0KGtleSwgTm9uZSkKICAgICAgICAgICAgICAgIG9zLmVudmlyb25ba2V5XSA9IHZhbAogICAgICAgIGlmIHBhdGhfcHJlZml4OgogICAgICAgICAgICBvbGRfZW52X3ZhbHNbJ1BBVEgnXSA9IG9zLmVudmlyb25bJ1BBVEgnXQogICAgICAgICAgICBvcy5lbnZpcm9uWydQQVRIJ10gPSAiJXM6JXMiICUgKHBhdGhfcHJlZml4LCBvcy5lbnZpcm9uWydQQVRIJ10pCgogICAgICAgICMgSWYgdXNpbmcgdGVzdC1tb2R1bGUgYW5kIGV4cGxvZGUsIHRoZSByZW1vdGUgbGliIHBhdGggd2lsbCByZXNlbWJsZSAuLi4KICAgICAgICAjICAgL3RtcC90ZXN0X21vZHVsZV9zY3JhdGNoL2RlYnVnX2Rpci9hbnNpYmxlL21vZHVsZV91dGlscy9iYXNpYy5weQogICAgICAgICMgSWYgdXNpbmcgYW5zaWJsZSBvciBhbnNpYmxlLXBsYXlib29rIHdpdGggYSByZW1vdGUgc3lzdGVtIC4uLgogICAgICAgICMgICAvdG1wL2Fuc2libGVfdm13ZUxRL2Fuc2libGVfbW9kbGliLnppcC9hbnNpYmxlL21vZHVsZV91dGlscy9iYXNpYy5weQoKICAgICAgICAjIENsZWFuIG91dCBweXRob24gcGF0aHMgc2V0IGJ5IGFuc2liYWxsegogICAgICAgIGlmICdQWVRIT05QQVRIJyBpbiBvcy5lbnZpcm9uOgogICAgICAgICAgICBweXBhdGhzID0gb3MuZW52aXJvblsnUFlUSE9OUEFUSCddLnNwbGl0KCc6JykKICAgICAgICAgICAgcHlwYXRocyA9IFt4IGZvciB4IGluIHB5cGF0aHMgXAogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgeC5lbmRzd2l0aCgnL2Fuc2libGVfbW9kbGliLnppcCcpIFwKICAgICAgICAgICAgICAgICAgICAgICAgYW5kIG5vdCB4LmVuZHN3aXRoKCcvZGVidWdfZGlyJyldCiAgICAgICAgICAgIG9zLmVudmlyb25bJ1BZVEhPTlBBVEgnXSA9ICc6Jy5qb2luKHB5cGF0aHMpCiAgICAgICAgICAgIGlmIG5vdCBvcy5lbnZpcm9uWydQWVRIT05QQVRIJ106CiAgICAgICAgICAgICAgICBkZWwgb3MuZW52aXJvblsnUFlUSE9OUEFUSCddCgogICAgICAgICMgY3JlYXRlIGEgcHJpbnRhYmxlIHZlcnNpb24gb2YgdGhlIGNvbW1hbmQgZm9yIHVzZQogICAgICAgICMgaW4gcmVwb3J0aW5nIGxhdGVyLCB3aGljaCBzdHJpcHMgb3V0IHRoaW5ncyBsaWtlCiAgICAgICAgIyBwYXNzd29yZHMgZnJvbSB0aGUgYXJncyBsaXN0CiAgICAgICAgdG9fY2xlYW5fYXJncyA9IGFyZ3MKICAgICAgICBpZiBQWTI6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYXJncywgdGV4dF90eXBlKToKICAgICAgICAgICAgICAgIHRvX2NsZWFuX2FyZ3MgPSB0b19ieXRlcyhhcmdzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYXJncywgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICAgICAgdG9fY2xlYW5fYXJncyA9IHRvX3RleHQoYXJncykKICAgICAgICBpZiBpc2luc3RhbmNlKGFyZ3MsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgICAgIHRvX2NsZWFuX2FyZ3MgPSBzaGxleC5zcGxpdCh0b19jbGVhbl9hcmdzKQoKICAgICAgICBjbGVhbl9hcmdzID0gW10KICAgICAgICBpc19wYXNzd2QgPSBGYWxzZQogICAgICAgIGZvciBhcmcgaW4gdG9fY2xlYW5fYXJnczoKICAgICAgICAgICAgaWYgaXNfcGFzc3dkOgogICAgICAgICAgICAgICAgaXNfcGFzc3dkID0gRmFsc2UKICAgICAgICAgICAgICAgIGNsZWFuX2FyZ3MuYXBwZW5kKCcqKioqKioqKicpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBQQVNTV0RfQVJHX1JFLm1hdGNoKGFyZyk6CiAgICAgICAgICAgICAgICBzZXBfaWR4ID0gYXJnLmZpbmQoJz0nKQogICAgICAgICAgICAgICAgaWYgc2VwX2lkeCA+IC0xOgogICAgICAgICAgICAgICAgICAgIGNsZWFuX2FyZ3MuYXBwZW5kKCclcz0qKioqKioqKicgJSBhcmdbOnNlcF9pZHhdKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGlzX3Bhc3N3ZCA9IFRydWUKICAgICAgICAgICAgYXJnID0gaGV1cmlzdGljX2xvZ19zYW5pdGl6ZShhcmcsIHNlbGYubm9fbG9nX3ZhbHVlcykKICAgICAgICAgICAgY2xlYW5fYXJncy5hcHBlbmQoYXJnKQogICAgICAgIGNsZWFuX2FyZ3MgPSAnICcuam9pbihzaGxleF9xdW90ZShhcmcpIGZvciBhcmcgaW4gY2xlYW5fYXJncykKCiAgICAgICAgaWYgZGF0YToKICAgICAgICAgICAgc3RfaW4gPSBzdWJwcm9jZXNzLlBJUEUKCiAgICAgICAga3dhcmdzID0gZGljdCgKICAgICAgICAgICAgZXhlY3V0YWJsZT1leGVjdXRhYmxlLAogICAgICAgICAgICBzaGVsbD1zaGVsbCwKICAgICAgICAgICAgY2xvc2VfZmRzPWNsb3NlX2ZkcywKICAgICAgICAgICAgc3RkaW49c3RfaW4sCiAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsCiAgICAgICAgICAgIHN0ZGVycj1zdWJwcm9jZXNzLlBJUEUsCiAgICAgICAgKQoKICAgICAgICAjIHN0b3JlIHRoZSBwd2QKICAgICAgICBwcmV2X2RpciA9IG9zLmdldGN3ZCgpCgogICAgICAgICMgbWFrZSBzdXJlIHdlJ3JlIGluIHRoZSByaWdodCB3b3JraW5nIGRpcmVjdG9yeQogICAgICAgIGlmIGN3ZCBhbmQgb3MucGF0aC5pc2Rpcihjd2QpOgogICAgICAgICAgICBjd2QgPSBvcy5wYXRoLmFic3BhdGgob3MucGF0aC5leHBhbmR1c2VyKGN3ZCkpCiAgICAgICAgICAgIGt3YXJnc1snY3dkJ10gPSBjd2QKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MuY2hkaXIoY3dkKQogICAgICAgICAgICBleGNlcHQgKE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocmM9ZS5lcnJubywgbXNnPSJDb3VsZCBub3Qgb3BlbiAlcywgJXMiICUgKGN3ZCwgc3RyKGUpKSkKCiAgICAgICAgb2xkX3VtYXNrID0gTm9uZQogICAgICAgIGlmIHVtYXNrOgogICAgICAgICAgICBvbGRfdW1hc2sgPSBvcy51bWFzayh1bWFzaykKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLl9kZWJ1ZzoKICAgICAgICAgICAgICAgIHNlbGYubG9nKCdFeGVjdXRpbmc6ICcgKyBjbGVhbl9hcmdzKQogICAgICAgICAgICBjbWQgPSBzdWJwcm9jZXNzLlBvcGVuKGFyZ3MsICoqa3dhcmdzKQoKICAgICAgICAgICAgIyB0aGUgY29tbXVuaWNhdGlvbiBsb2dpYyBoZXJlIGlzIGVzc2VudGlhbGx5IHRha2VuIGZyb20gdGhhdAogICAgICAgICAgICAjIG9mIHRoZSBfY29tbXVuaWNhdGUoKSBmdW5jdGlvbiBpbiBzc2gucHkKCiAgICAgICAgICAgIHN0ZG91dCA9IGIoJycpCiAgICAgICAgICAgIHN0ZGVyciA9IGIoJycpCiAgICAgICAgICAgIHJwaXBlcyA9IFtjbWQuc3Rkb3V0LCBjbWQuc3RkZXJyXQoKICAgICAgICAgICAgaWYgZGF0YToKICAgICAgICAgICAgICAgIGlmIG5vdCBiaW5hcnlfZGF0YToKICAgICAgICAgICAgICAgICAgICBkYXRhICs9ICdcbicKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZGF0YSwgdGV4dF90eXBlKToKICAgICAgICAgICAgICAgICAgICBkYXRhID0gdG9fYnl0ZXMoZGF0YSkKICAgICAgICAgICAgICAgIGNtZC5zdGRpbi53cml0ZShkYXRhKQogICAgICAgICAgICAgICAgY21kLnN0ZGluLmNsb3NlKCkKCiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICByZmRzLCB3ZmRzLCBlZmRzID0gc2VsZWN0LnNlbGVjdChycGlwZXMsIFtdLCBycGlwZXMsIDEpCiAgICAgICAgICAgICAgICBzdGRvdXQgKz0gc2VsZi5fcmVhZF9mcm9tX3BpcGVzKHJwaXBlcywgcmZkcywgY21kLnN0ZG91dCkKICAgICAgICAgICAgICAgIHN0ZGVyciArPSBzZWxmLl9yZWFkX2Zyb21fcGlwZXMocnBpcGVzLCByZmRzLCBjbWQuc3RkZXJyKQogICAgICAgICAgICAgICAgIyBpZiB3ZSdyZSBjaGVja2luZyBmb3IgcHJvbXB0cywgZG8gaXQgbm93CiAgICAgICAgICAgICAgICBpZiBwcm9tcHRfcmU6CiAgICAgICAgICAgICAgICAgICAgaWYgcHJvbXB0X3JlLnNlYXJjaChzdGRvdXQpIGFuZCBub3QgZGF0YToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZW5jb2Rpbmc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQgPSB0b19uYXRpdmUoc3Rkb3V0LCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycykKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dCA9IHN0ZG91dAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKDI1Nywgc3Rkb3V0LCAiQSBwcm9tcHQgd2FzIGVuY291bnRlcmVkIHdoaWxlIHJ1bm5pbmcgYSBjb21tYW5kLCBidXQgbm8gaW5wdXQgZGF0YSB3YXMgc3BlY2lmaWVkIikKICAgICAgICAgICAgICAgICMgb25seSBicmVhayBvdXQgaWYgbm8gcGlwZXMgYXJlIGxlZnQgdG8gcmVhZCBvcgogICAgICAgICAgICAgICAgIyB0aGUgcGlwZXMgYXJlIGNvbXBsZXRlbHkgcmVhZCBhbmQKICAgICAgICAgICAgICAgICMgdGhlIHByb2Nlc3MgaXMgdGVybWluYXRlZAogICAgICAgICAgICAgICAgaWYgKG5vdCBycGlwZXMgb3Igbm90IHJmZHMpIGFuZCBjbWQucG9sbCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAjIE5vIHBpcGVzIGFyZSBsZWZ0IHRvIHJlYWQgYnV0IHByb2Nlc3MgaXMgbm90IHlldCB0ZXJtaW5hdGVkCiAgICAgICAgICAgICAgICAjIE9ubHkgdGhlbiBpdCBpcyBzYWZlIHRvIHdhaXQgZm9yIHRoZSBwcm9jZXNzIHRvIGJlIGZpbmlzaGVkCiAgICAgICAgICAgICAgICAjIE5PVEU6IEFjdHVhbGx5IGNtZC5wb2xsKCkgaXMgYWx3YXlzIE5vbmUgaGVyZSBpZiBycGlwZXMgaXMgZW1wdHkKICAgICAgICAgICAgICAgIGVsaWYgbm90IHJwaXBlcyBhbmQgY21kLnBvbGwoKSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIGNtZC53YWl0KCkKICAgICAgICAgICAgICAgICAgICAjIFRoZSBwcm9jZXNzIGlzIHRlcm1pbmF0ZWQuIFNpbmNlIG5vIHBpcGVzIHRvIHJlYWQgZnJvbSBhcmUKICAgICAgICAgICAgICAgICAgICAjIGxlZnQsIHRoZXJlIGlzIG5vIG5lZWQgdG8gY2FsbCBzZWxlY3QoKSBhZ2Fpbi4KICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgY21kLnN0ZG91dC5jbG9zZSgpCiAgICAgICAgICAgIGNtZC5zdGRlcnIuY2xvc2UoKQoKICAgICAgICAgICAgcmMgPSBjbWQucmV0dXJuY29kZQogICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5sb2coIkVycm9yIEV4ZWN1dGluZyBDTUQ6JXMgRXhjZXB0aW9uOiVzIiAlIChjbGVhbl9hcmdzLCB0b19uYXRpdmUoZSkpKQogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihyYz1lLmVycm5vLCBtc2c9dG9fbmF0aXZlKGUpLCBjbWQ9Y2xlYW5fYXJncykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYubG9nKCJFcnJvciBFeGVjdXRpbmcgQ01EOiVzIEV4Y2VwdGlvbjolcyIgJSAoY2xlYW5fYXJncyx0b19uYXRpdmUodHJhY2ViYWNrLmZvcm1hdF9leGMoKSkpKQogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihyYz0yNTcsIG1zZz10b19uYXRpdmUoZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpLCBjbWQ9Y2xlYW5fYXJncykKCiAgICAgICAgIyBSZXN0b3JlIGVudiBzZXR0aW5ncwogICAgICAgIGZvciBrZXksIHZhbCBpbiBvbGRfZW52X3ZhbHMuaXRlbXMoKToKICAgICAgICAgICAgaWYgdmFsIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBkZWwgb3MuZW52aXJvbltrZXldCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBvcy5lbnZpcm9uW2tleV0gPSB2YWwKCiAgICAgICAgaWYgb2xkX3VtYXNrOgogICAgICAgICAgICBvcy51bWFzayhvbGRfdW1hc2spCgogICAgICAgIGlmIHJjICE9IDAgYW5kIGNoZWNrX3JjOgogICAgICAgICAgICBtc2cgPSBoZXVyaXN0aWNfbG9nX3Nhbml0aXplKHN0ZGVyci5yc3RyaXAoKSwgc2VsZi5ub19sb2dfdmFsdWVzKQogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihjbWQ9Y2xlYW5fYXJncywgcmM9cmMsIHN0ZG91dD1zdGRvdXQsIHN0ZGVycj1zdGRlcnIsIG1zZz1tc2cpCgogICAgICAgICMgcmVzZXQgdGhlIHB3ZAogICAgICAgIG9zLmNoZGlyKHByZXZfZGlyKQoKICAgICAgICBpZiBlbmNvZGluZyBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0dXJuIChyYywgdG9fbmF0aXZlKHN0ZG91dCwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpLAogICAgICAgICAgICAgICAgICAgIHRvX25hdGl2ZShzdGRlcnIsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKSkKICAgICAgICByZXR1cm4gKHJjLCBzdGRvdXQsIHN0ZGVycikKCiAgICBkZWYgYXBwZW5kX3RvX2ZpbGUoc2VsZiwgZmlsZW5hbWUsIHN0cik6CiAgICAgICAgZmlsZW5hbWUgPSBvcy5wYXRoLmV4cGFuZHZhcnMob3MucGF0aC5leHBhbmR1c2VyKGZpbGVuYW1lKSkKICAgICAgICBmaCA9IG9wZW4oZmlsZW5hbWUsICdhJykKICAgICAgICBmaC53cml0ZShzdHIpCiAgICAgICAgZmguY2xvc2UoKQoKICAgIGRlZiBieXRlc190b19odW1hbihzZWxmLCBzaXplKToKICAgICAgICByZXR1cm4gYnl0ZXNfdG9faHVtYW4oc2l6ZSkKCiAgICAjIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQogICAgcHJldHR5X2J5dGVzID0gYnl0ZXNfdG9faHVtYW4KCiAgICBkZWYgaHVtYW5fdG9fYnl0ZXMoc2VsZiwgbnVtYmVyLCBpc2JpdHM9RmFsc2UpOgogICAgICAgIHJldHVybiBodW1hbl90b19ieXRlcyhudW1iZXIsIGlzYml0cykKCiAgICAjCiAgICAjIEJhY2t3YXJkcyBjb21wYXQKICAgICMKCiAgICAjIEluIDIuMCwgbW92ZWQgZnJvbSBpbnNpZGUgdGhlIG1vZHVsZSB0byB0aGUgdG9wbGV2ZWwKICAgIGlzX2V4ZWN1dGFibGUgPSBpc19leGVjdXRhYmxlCgoKZGVmIGdldF9tb2R1bGVfcGF0aCgpOgogICAgcmV0dXJuIG9zLnBhdGguZGlybmFtZShvcy5wYXRoLnJlYWxwYXRoKF9fZmlsZV9fKSkKUEsDBBQAAAAAAPe7K0u12AQGJTAAACUwAAAdAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX3RleHQucHkjIFRoaXMgY29kZSBpcyBwYXJ0IG9mIEFuc2libGUsIGJ1dCBpcyBhbiBpbmRlcGVuZGVudCBjb21wb25lbnQuCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgQ29weXJpZ2h0IChjKSwgVG9zaGlvIEt1cmF0b21pIDxhLmJhZGdlckBnbWFpbC5jb20+LCAyMDE2CiMKIyBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQgbW9kaWZpY2F0aW9uLAojIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKIwojICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKIyAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwKIyAgICAgIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24KIyAgICAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORAojIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVECiMgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRSBESVNDTEFJTUVELgojIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULAojIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywKIyBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MKIyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUCiMgTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFCiMgVVNFIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiMKCiIiIgouLiB3YXJuOjogVGhpcyBtb2R1bGVfdXRpbCBpcyBjdXJyZW50bHkgaW50ZXJuYWwgaW1wbGVtZW50YXRpb24uCiAgICBXZSB3YW50IHRvIGV2YWx1YXRlIHRoaXMgY29kZSBmb3Igc3RhYmlsaXR5IGFuZCBBUEkgc3VpdGFiaWxpdHkgYmVmb3JlCiAgICBtYWtpbmcgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgZ3VhcmFudGVlcy4gIFRoZSBBUEkgbWF5IGNoYW5nZSBiZXR3ZWVuCiAgICByZWxlYXNlcy4gIERvIG5vdCB1c2UgdGhpcyB1bmxlc3MgeW91IGFyZSB3aWxsaW5nIHRvIHBvcnQgeW91ciBtb2R1bGUgY29kZS4KIiIiCmltcG9ydCBjb2RlY3MKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGltcG9ydCBQWTMsIHRleHRfdHlwZSwgYmluYXJ5X3R5cGUKCgp0cnk6CiAgICBjb2RlY3MubG9va3VwX2Vycm9yKCdzdXJyb2dhdGVlc2NhcGUnKQogICAgSEFTX1NVUlJPR0FURUVTQ0FQRSA9IFRydWUKZXhjZXB0IExvb2t1cEVycm9yOgogICAgSEFTX1NVUlJPR0FURUVTQ0FQRSA9IEZhbHNlCgoKX0NPTVBPU0VEX0VSUk9SX0hBTkRMRVJTID0gZnJvemVuc2V0KChOb25lLCAnc3Vycm9nYXRlX29yX2VzY2FwZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3Vycm9nYXRlX29yX3N0cmljdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3Vycm9nYXRlX3RoZW5fcmVwbGFjZScpKQoKCmRlZiB0b19ieXRlcyhvYmosIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz1Ob25lLCBub25zdHJpbmc9J3NpbXBsZXJlcHInKToKICAgICIiIk1ha2Ugc3VyZSB0aGF0IGEgc3RyaW5nIGlzIGEgYnl0ZSBzdHJpbmcKCiAgICA6YXJnIG9iajogQW4gb2JqZWN0IHRvIG1ha2Ugc3VyZSBpcyBhIGJ5dGUgc3RyaW5nLiAgSW4gbW9zdCBjYXNlcyB0aGlzCiAgICAgICAgd2lsbCBiZSBlaXRoZXIgYSB0ZXh0IHN0cmluZyBvciBhIGJ5dGUgc3RyaW5nLiAgSG93ZXZlciwgd2l0aAogICAgICAgIGBgbm9uc3RyaW5nPSdzaW1wbGVyZXByJ2BgLCB0aGlzIGNhbiBiZSB1c2VkIGFzIGEgdHJhY2ViYWNrLWZyZWUKICAgICAgICB2ZXJzaW9uIG9mIGBgc3RyKG9iailgYC4KICAgIDprd2FyZyBlbmNvZGluZzogVGhlIGVuY29kaW5nIHRvIHVzZSB0byB0cmFuc2Zvcm0gZnJvbSBhIHRleHQgc3RyaW5nIHRvCiAgICAgICAgYSBieXRlIHN0cmluZy4gIERlZmF1bHRzIHRvIHVzaW5nICd1dGYtOCcuCiAgICA6a3dhcmcgZXJyb3JzOiBUaGUgZXJyb3IgaGFuZGxlciB0byB1c2UgaWYgdGhlIHRleHQgc3RyaW5nIGlzIG5vdAogICAgICAgIGVuY29kYWJsZSB1c2luZyB0aGUgc3BlY2lmaWVkIGVuY29kaW5nLiAgQW55IHZhbGlkIGBjb2RlY3MgZXJyb3IKICAgICAgICBoYW5kbGVyIDxodHRwczovL2RvY3MucHl0aG9uLm9yZy8yL2xpYnJhcnkvY29kZWNzLmh0bWwjY29kZWMtYmFzZS1jbGFzc2VzPmBfCiAgICAgICAgbWF5IGJlIHNwZWNpZmllZC4gVGhlcmUgYXJlIHRocmVlIGFkZGl0aW9uYWwgZXJyb3Igc3RyYXRlZ2llcwogICAgICAgIHNwZWNpZmljYWxseSBhaW1lZCBhdCBoZWxwaW5nIHBlb3BsZSB0byBwb3J0IGNvZGUuICBUaGUgZmlyc3QgdHdvIGFyZToKCiAgICAgICAgICAgIDpzdXJyb2dhdGVfb3Jfc3RyaWN0OiBXaWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSBgYHN0cmljdGBgCiAgICAgICAgICAgIDpzdXJyb2dhdGVfb3JfcmVwbGFjZTogV2lsbCB1c2UgYGBzdXJyb2dhdGVlc2NhcGVgYCBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLCBvdGhlcndpc2UgaXQgd2lsbCB1c2UgYGByZXBsYWNlYGAuCgogICAgICAgIEJlY2F1c2UgYGBzdXJyb2dhdGVlc2NhcGVgYCB3YXMgYWRkZWQgaW4gUHl0aG9uMyB0aGlzIHVzdWFsbHkgbWVhbnMgdGhhdAogICAgICAgIFB5dGhvbjMgd2lsbCB1c2UgYGBzdXJyb2dhdGVlc2NhcGVgYCBhbmQgUHl0aG9uMiB3aWxsIHVzZSB0aGUgZmFsbGJhY2sKICAgICAgICBlcnJvciBoYW5kbGVyLiBOb3RlIHRoYXQgdGhlIGNvZGUgY2hlY2tzIGZvciBgYHN1cnJvZ2F0ZWVzY2FwZWBgIHdoZW4gdGhlCiAgICAgICAgbW9kdWxlIGlzIGltcG9ydGVkLiAgSWYgeW91IGhhdmUgYSBiYWNrcG9ydCBvZiBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGZvcgogICAgICAgIFB5dGhvbjIsIGJlIHN1cmUgdG8gcmVnaXN0ZXIgdGhlIGVycm9yIGhhbmRsZXIgcHJpb3IgdG8gaW1wb3J0aW5nIHRoaXMKICAgICAgICBtb2R1bGUuCgogICAgICAgIFRoZSBsYXN0IGVycm9yIGhhbmRsZXIgaXM6CgogICAgICAgICAgICA6c3Vycm9nYXRlX3RoZW5fcmVwbGFjZTogV2lsbCB1c2UgYGBzdXJyb2dhdGVlc2NhcGVgYCBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLiAgSWYgZW5jb2Rpbmcgd2l0aCBgYHN1cnJvZ2F0ZWVzY2FwZWBgIHdvdWxkIHRyYWNlYmFjaywKICAgICAgICAgICAgICAgIHN1cnJvZ2F0ZXMgYXJlIGZpcnN0IHJlcGxhY2VkIHdpdGggYSByZXBsYWNlbWVudCBjaGFyYWN0ZXJzCiAgICAgICAgICAgICAgICBhbmQgdGhlbiB0aGUgc3RyaW5nIGlzIGVuY29kZWQgdXNpbmcgYGByZXBsYWNlYGAgKHdoaWNoIHJlcGxhY2VzCiAgICAgICAgICAgICAgICB0aGUgcmVzdCBvZiB0aGUgbm9uZW5jb2RhYmxlIGJ5dGVzKS4gIElmIGBgc3Vycm9nYXRlZXNjYXBlYGAgaXMKICAgICAgICAgICAgICAgIG5vdCBwcmVzZW50IGl0IHdpbGwgc2ltcGx5IHVzZSBgYHJlcGxhY2VgYC4gIChBZGRlZCBpbiBBbnNpYmxlIDIuMykKICAgICAgICAgICAgICAgIFRoaXMgc3RyYXRlZ3kgaXMgZGVzaWduZWQgdG8gbmV2ZXIgdHJhY2ViYWNrIHdoZW4gaXQgYXR0ZW1wdHMKICAgICAgICAgICAgICAgIHRvIGVuY29kZSBhIHN0cmluZy4KCiAgICAgICAgVGhlIGRlZmF1bHQgdW50aWwgQW5zaWJsZS0yLjIgd2FzIGBgc3Vycm9nYXRlX29yX3JlcGxhY2VgYAogICAgICAgIEZyb20gQW5zaWJsZS0yLjMgb253YXJkcywgdGhlIGRlZmF1bHQgaXMgYGBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlYGAuCgogICAgOmt3YXJnIG5vbnN0cmluZzogVGhlIHN0cmF0ZWd5IHRvIHVzZSBpZiBhIG5vbnN0cmluZyBpcyBzcGVjaWZpZWQgaW4KICAgICAgICBgYG9iamBgLiAgRGVmYXVsdCBpcyAnc2ltcGxlcmVwcicuICBWYWxpZCB2YWx1ZXMgYXJlOgoKICAgICAgICA6c2ltcGxlcmVwcjogVGhlIGRlZmF1bHQuICBUaGlzIHRha2VzIHRoZSBgYHN0cmBgIG9mIHRoZSBvYmplY3QgYW5kCiAgICAgICAgICAgIHRoZW4gcmV0dXJucyB0aGUgYnl0ZXMgdmVyc2lvbiBvZiB0aGF0IHN0cmluZy4KICAgICAgICA6ZW1wdHk6IFJldHVybiBhbiBlbXB0eSBieXRlIHN0cmluZwogICAgICAgIDpwYXNzdGhydTogUmV0dXJuIHRoZSBvYmplY3QgcGFzc2VkIGluCiAgICAgICAgOnN0cmljdDogUmFpc2UgYSA6ZXhjOmBUeXBlRXJyb3JgCgogICAgOnJldHVybnM6IFR5cGljYWxseSB0aGlzIHJldHVybnMgYSBieXRlIHN0cmluZy4gIElmIGEgbm9uc3RyaW5nIG9iamVjdCBpcwogICAgICAgIHBhc3NlZCBpbiB0aGlzIG1heSBiZSBhIGRpZmZlcmVudCB0eXBlIGRlcGVuZGluZyBvbiB0aGUgc3RyYXRlZ3kKICAgICAgICBzcGVjaWZpZWQgYnkgbm9uc3RyaW5nLiAgVGhpcyB3aWxsIG5ldmVyIHJldHVybiBhIHRleHQgc3RyaW5nLgoKICAgIC4uIG5vdGU6OiBJZiBwYXNzZWQgYSBieXRlIHN0cmluZywgdGhpcyBmdW5jdGlvbiBkb2VzIG5vdCBjaGVjayB0aGF0IHRoZQogICAgICAgIHN0cmluZyBpcyB2YWxpZCBpbiB0aGUgc3BlY2lmaWVkIGVuY29kaW5nLiAgSWYgaXQncyBpbXBvcnRhbnQgdGhhdCB0aGUKICAgICAgICBieXRlIHN0cmluZyBpcyBpbiB0aGUgc3BlY2lmaWVkIGVuY29kaW5nIGRvOjoKCiAgICAgICAgICAgIGVuY29kZWRfc3RyaW5nID0gdG9fYnl0ZXModG9fdGV4dChpbnB1dF9zdHJpbmcsICdsYXRpbi0xJyksICd1dGYtOCcpCgogICAgLi4gdmVyc2lvbl9jaGFuZ2VkOjogMi4zCgogICAgICAgIEFkZGVkIHRoZSBgYHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2VgYCBlcnJvciBoYW5kbGVyIGFuZCBtYWRlIGl0IHRoZSBkZWZhdWx0IGVycm9yIGhhbmRsZXIuCiAgICAiIiIKICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgcmV0dXJuIG9iagoKICAgICMgV2UncmUgZ2l2ZW4gYSB0ZXh0IHN0cmluZwogICAgIyBJZiBpdCBoYXMgc3Vycm9nYXRlcywgd2Uga25vdyBiZWNhdXNlIGl0IHdpbGwgZGVjb2RlCiAgICBvcmlnaW5hbF9lcnJvcnMgPSBlcnJvcnMKICAgIGlmIGVycm9ycyBpbiBfQ09NUE9TRURfRVJST1JfSEFORExFUlM6CiAgICAgICAgaWYgSEFTX1NVUlJPR0FURUVTQ0FQRToKICAgICAgICAgICAgZXJyb3JzID0gJ3N1cnJvZ2F0ZWVzY2FwZScKICAgICAgICBlbGlmIGVycm9ycyA9PSAnc3Vycm9nYXRlX29yX3N0cmljdCc6CiAgICAgICAgICAgIGVycm9ycyA9ICdzdHJpY3QnCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZXJyb3JzID0gJ3JlcGxhY2UnCgogICAgaWYgaXNpbnN0YW5jZShvYmosIHRleHRfdHlwZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFRyeSB0aGlzIGZpcnN0IGFzIGl0J3MgdGhlIGZhc3Rlc3QKICAgICAgICAgICAgcmV0dXJuIG9iai5lbmNvZGUoZW5jb2RpbmcsIGVycm9ycykKICAgICAgICBleGNlcHQgVW5pY29kZUVuY29kZUVycm9yOgogICAgICAgICAgICBpZiBvcmlnaW5hbF9lcnJvcnMgaW4gKE5vbmUsICdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJyk6CiAgICAgICAgICAgICAgICAjIFNsb3cgYnV0IHdvcmtzCiAgICAgICAgICAgICAgICByZXR1cm5fc3RyaW5nID0gb2JqLmVuY29kZSgndXRmLTgnLCAnc3Vycm9nYXRlZXNjYXBlJykKICAgICAgICAgICAgICAgIHJldHVybl9zdHJpbmcgPSByZXR1cm5fc3RyaW5nLmRlY29kZSgndXRmLTgnLCAncmVwbGFjZScpCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0dXJuX3N0cmluZy5lbmNvZGUoZW5jb2RpbmcsICdyZXBsYWNlJykKICAgICAgICAgICAgcmFpc2UKCiAgICAjIE5vdGU6IFdlIGRvIHRoZXNlIGxhc3QgZXZlbiB0aG91Z2ggd2UgaGF2ZSB0byBjYWxsIHRvX2J5dGVzIGFnYWluIG9uIHRoZQogICAgIyB2YWx1ZSBiZWNhdXNlIHdlJ3JlIG9wdGltaXppbmcgdGhlIGNvbW1vbiBjYXNlCiAgICBpZiBub25zdHJpbmcgPT0gJ3NpbXBsZXJlcHInOgogICAgICAgIHRyeToKICAgICAgICAgICAgdmFsdWUgPSBzdHIob2JqKQogICAgICAgIGV4Y2VwdCBVbmljb2RlRXJyb3I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHZhbHVlID0gcmVwcihvYmopCiAgICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRXJyb3I6CiAgICAgICAgICAgICAgICAjIEdpdmluZyB1cAogICAgICAgICAgICAgICAgcmV0dXJuIHRvX2J5dGVzKCcnKQogICAgZWxpZiBub25zdHJpbmcgPT0gJ3Bhc3N0aHJ1JzoKICAgICAgICByZXR1cm4gb2JqCiAgICBlbGlmIG5vbnN0cmluZyA9PSAnZW1wdHknOgogICAgICAgICMgcHl0aG9uMi40IGRvZXNuJ3QgaGF2ZSBiJycKICAgICAgICByZXR1cm4gdG9fYnl0ZXMoJycpCiAgICBlbGlmIG5vbnN0cmluZyA9PSAnc3RyaWN0JzoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ29iaiBtdXN0IGJlIGEgc3RyaW5nIHR5cGUnKQogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ0ludmFsaWQgdmFsdWUgJXMgZm9yIHRvX2J5dGVzXCcgbm9uc3RyaW5nIHBhcmFtZXRlcicgJSBub25zdHJpbmcpCgogICAgcmV0dXJuIHRvX2J5dGVzKHZhbHVlLCBlbmNvZGluZywgZXJyb3JzKQoKCmRlZiB0b190ZXh0KG9iaiwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPU5vbmUsIG5vbnN0cmluZz0nc2ltcGxlcmVwcicpOgogICAgIiIiTWFrZSBzdXJlIHRoYXQgYSBzdHJpbmcgaXMgYSB0ZXh0IHN0cmluZwoKICAgIDphcmcgb2JqOiBBbiBvYmplY3QgdG8gbWFrZSBzdXJlIGlzIGEgdGV4dCBzdHJpbmcuICBJbiBtb3N0IGNhc2VzIHRoaXMKICAgICAgICB3aWxsIGJlIGVpdGhlciBhIHRleHQgc3RyaW5nIG9yIGEgYnl0ZSBzdHJpbmcuICBIb3dldmVyLCB3aXRoCiAgICAgICAgYGBub25zdHJpbmc9J3NpbXBsZXJlcHInYGAsIHRoaXMgY2FuIGJlIHVzZWQgYXMgYSB0cmFjZWJhY2stZnJlZQogICAgICAgIHZlcnNpb24gb2YgYGBzdHIob2JqKWBgLgogICAgOmt3YXJnIGVuY29kaW5nOiBUaGUgZW5jb2RpbmcgdG8gdXNlIHRvIHRyYW5zZm9ybSBmcm9tIGEgYnl0ZSBzdHJpbmcgdG8KICAgICAgICBhIHRleHQgc3RyaW5nLiAgRGVmYXVsdHMgdG8gdXNpbmcgJ3V0Zi04Jy4KICAgIDprd2FyZyBlcnJvcnM6IFRoZSBlcnJvciBoYW5kbGVyIHRvIHVzZSBpZiB0aGUgYnl0ZSBzdHJpbmcgaXMgbm90CiAgICAgICAgZGVjb2RhYmxlIHVzaW5nIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcuICBBbnkgdmFsaWQgYGNvZGVjcyBlcnJvcgogICAgICAgIGhhbmRsZXIgPGh0dHBzOi8vZG9jcy5weXRob24ub3JnLzIvbGlicmFyeS9jb2RlY3MuaHRtbCNjb2RlYy1iYXNlLWNsYXNzZXM+YF8KICAgICAgICBtYXkgYmUgc3BlY2lmaWVkLiAgIFdlIHN1cHBvcnQgdGhyZWUgYWRkaXRpb25hbCBlcnJvciBzdHJhdGVnaWVzCiAgICAgICAgc3BlY2lmaWNhbGx5IGFpbWVkIGF0IGhlbHBpbmcgcGVvcGxlIHRvIHBvcnQgY29kZToKCiAgICAgICAgICAgIDpzdXJyb2dhdGVfb3Jfc3RyaWN0OiBXaWxsIHVzZSBzdXJyb2dhdGVlc2NhcGUgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlciwgb3RoZXJ3aXNlIGl0IHdpbGwgdXNlIHN0cmljdAogICAgICAgICAgICA6c3Vycm9nYXRlX29yX3JlcGxhY2U6IFdpbGwgdXNlIHN1cnJvZ2F0ZWVzY2FwZSBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLCBvdGhlcndpc2UgaXQgd2lsbCB1c2UgcmVwbGFjZS4KICAgICAgICAgICAgOnN1cnJvZ2F0ZV90aGVuX3JlcGxhY2U6IERvZXMgdGhlIHNhbWUgYXMgc3Vycm9nYXRlX29yX3JlcGxhY2UgYnV0CiAgICAgICAgICAgICAgICBgd2FzIGFkZGVkIGZvciBzeW1tZXRyeSB3aXRoIHRoZSBlcnJvciBoYW5kbGVycyBpbgogICAgICAgICAgICAgICAgOmZ1bmM6YGFuc2libGUubW9kdWxlX3V0aWxzLl90ZXh0LnRvX2J5dGVzYCAoQWRkZWQgaW4gQW5zaWJsZSAyLjMpCgogICAgICAgIEJlY2F1c2Ugc3Vycm9nYXRlZXNjYXBlIHdhcyBhZGRlZCBpbiBQeXRob24zIHRoaXMgdXN1YWxseSBtZWFucyB0aGF0CiAgICAgICAgUHl0aG9uMyB3aWxsIHVzZSBgc3Vycm9nYXRlZXNjYXBlYCBhbmQgUHl0aG9uMiB3aWxsIHVzZSB0aGUgZmFsbGJhY2sKICAgICAgICBlcnJvciBoYW5kbGVyLiBOb3RlIHRoYXQgdGhlIGNvZGUgY2hlY2tzIGZvciBzdXJyb2dhdGVlc2NhcGUgd2hlbiB0aGUKICAgICAgICBtb2R1bGUgaXMgaW1wb3J0ZWQuICBJZiB5b3UgaGF2ZSBhIGJhY2twb3J0IG9mIGBzdXJyb2dhdGVlc2NhcGVgIGZvcgogICAgICAgIHB5dGhvbjIsIGJlIHN1cmUgdG8gcmVnaXN0ZXIgdGhlIGVycm9yIGhhbmRsZXIgcHJpb3IgdG8gaW1wb3J0aW5nIHRoaXMKICAgICAgICBtb2R1bGUuCgogICAgICAgIFRoZSBkZWZhdWx0IHVudGlsIEFuc2libGUtMi4yIHdhcyBgc3Vycm9nYXRlX29yX3JlcGxhY2VgCiAgICAgICAgSW4gQW5zaWJsZS0yLjMgdGhpcyBkZWZhdWx0cyB0byBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWAgZm9yIHN5bW1ldHJ5CiAgICAgICAgd2l0aCA6ZnVuYzpgYW5zaWJsZS5tb2R1bGVfdXRpbHMuX3RleHQudG9fYnl0ZXNgIC4KICAgIDprd2FyZyBub25zdHJpbmc6IFRoZSBzdHJhdGVneSB0byB1c2UgaWYgYSBub25zdHJpbmcgaXMgc3BlY2lmaWVkIGluCiAgICAgICAgYGBvYmpgYC4gIERlZmF1bHQgaXMgJ3NpbXBsZXJlcHInLiAgVmFsaWQgdmFsdWVzIGFyZToKCiAgICAgICAgOnNpbXBsZXJlcHI6IFRoZSBkZWZhdWx0LiAgVGhpcyB0YWtlcyB0aGUgYGBzdHJgYCBvZiB0aGUgb2JqZWN0IGFuZAogICAgICAgICAgICB0aGVuIHJldHVybnMgdGhlIHRleHQgdmVyc2lvbiBvZiB0aGF0IHN0cmluZy4KICAgICAgICA6ZW1wdHk6IFJldHVybiBhbiBlbXB0eSB0ZXh0IHN0cmluZwogICAgICAgIDpwYXNzdGhydTogUmV0dXJuIHRoZSBvYmplY3QgcGFzc2VkIGluCiAgICAgICAgOnN0cmljdDogUmFpc2UgYSA6ZXhjOmBUeXBlRXJyb3JgCgogICAgOnJldHVybnM6IFR5cGljYWxseSB0aGlzIHJldHVybnMgYSB0ZXh0IHN0cmluZy4gIElmIGEgbm9uc3RyaW5nIG9iamVjdCBpcwogICAgICAgIHBhc3NlZCBpbiB0aGlzIG1heSBiZSBhIGRpZmZlcmVudCB0eXBlIGRlcGVuZGluZyBvbiB0aGUgc3RyYXRlZ3kKICAgICAgICBzcGVjaWZpZWQgYnkgbm9uc3RyaW5nLiAgVGhpcyB3aWxsIG5ldmVyIHJldHVybiBhIGJ5dGUgc3RyaW5nLgogICAgICAgIEZyb20gQW5zaWJsZS0yLjMgb253YXJkcywgdGhlIGRlZmF1bHQgaXMgYHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2VgLgoKICAgIC4uIHZlcnNpb25fY2hhbmdlZDo6IDIuMwoKICAgICAgICBBZGRlZCB0aGUgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZSBlcnJvciBoYW5kbGVyIGFuZCBtYWRlIGl0IHRoZSBkZWZhdWx0IGVycm9yIGhhbmRsZXIuCiAgICAiIiIKICAgIGlmIGlzaW5zdGFuY2Uob2JqLCB0ZXh0X3R5cGUpOgogICAgICAgIHJldHVybiBvYmoKCiAgICBpZiBlcnJvcnMgaW4gX0NPTVBPU0VEX0VSUk9SX0hBTkRMRVJTOgogICAgICAgIGlmIEhBU19TVVJST0dBVEVFU0NBUEU6CiAgICAgICAgICAgIGVycm9ycyA9ICdzdXJyb2dhdGVlc2NhcGUnCiAgICAgICAgZWxpZiBlcnJvcnMgPT0gJ3N1cnJvZ2F0ZV9vcl9zdHJpY3QnOgogICAgICAgICAgICBlcnJvcnMgPSAnc3RyaWN0JwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVycm9ycyA9ICdyZXBsYWNlJwoKICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgIyBOb3RlOiBXZSBkb24ndCBuZWVkIHNwZWNpYWwgaGFuZGxpbmcgZm9yIHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2UKICAgICAgICAjIGJlY2F1c2UgYWxsIGJ5dGVzIHdpbGwgZWl0aGVyIGJlIG1hZGUgaW50byBzdXJyb2dhdGVzIG9yIGFyZSB2YWxpZAogICAgICAgICMgdG8gZGVjb2RlLgogICAgICAgIHJldHVybiBvYmouZGVjb2RlKGVuY29kaW5nLCBlcnJvcnMpCgogICAgIyBOb3RlOiBXZSBkbyB0aGVzZSBsYXN0IGV2ZW4gdGhvdWdoIHdlIGhhdmUgdG8gY2FsbCB0b190ZXh0IGFnYWluIG9uIHRoZQogICAgIyB2YWx1ZSBiZWNhdXNlIHdlJ3JlIG9wdGltaXppbmcgdGhlIGNvbW1vbiBjYXNlCiAgICBpZiBub25zdHJpbmcgPT0gJ3NpbXBsZXJlcHInOgogICAgICAgIHRyeToKICAgICAgICAgICAgdmFsdWUgPSBzdHIob2JqKQogICAgICAgIGV4Y2VwdCBVbmljb2RlRXJyb3I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHZhbHVlID0gcmVwcihvYmopCiAgICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRXJyb3I6CiAgICAgICAgICAgICAgICAjIEdpdmluZyB1cAogICAgICAgICAgICAgICAgcmV0dXJuIHUnJwogICAgZWxpZiBub25zdHJpbmcgPT0gJ3Bhc3N0aHJ1JzoKICAgICAgICByZXR1cm4gb2JqCiAgICBlbGlmIG5vbnN0cmluZyA9PSAnZW1wdHknOgogICAgICAgIHJldHVybiB1JycKICAgIGVsaWYgbm9uc3RyaW5nID09ICdzdHJpY3QnOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignb2JqIG11c3QgYmUgYSBzdHJpbmcgdHlwZScpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignSW52YWxpZCB2YWx1ZSAlcyBmb3IgdG9fdGV4dFwncyBub25zdHJpbmcgcGFyYW1ldGVyJyAlIG5vbnN0cmluZykKCiAgICByZXR1cm4gdG9fdGV4dCh2YWx1ZSwgZW5jb2RpbmcsIGVycm9ycykKCgojOiA6cHk6ZnVuYzpgdG9fbmF0aXZlYAojOiAgICAgIFRyYW5zZm9ybSBhIHZhcmlhYmxlIGludG8gdGhlIG5hdGl2ZSBzdHIgdHlwZSBmb3IgdGhlIHB5dGhvbiB2ZXJzaW9uCiM6CiM6ICAgICAgT24gUHl0aG9uMiwgdGhpcyBpcyBhbiBhbGlhcyBmb3IKIzogICAgICA6ZnVuYzpgfmFuc2libGUubW9kdWxlX3V0aWxzLnRvX2J5dGVzYC4gIE9uIFB5dGhvbjMgaXQgaXMgYW4gYWxpYXMgZm9yCiM6ICAgICAgOmZ1bmM6YH5hbnNpYmxlLm1vZHVsZV91dGlscy50b190ZXh0YC4gIEl0IG1ha2VzIGl0IGVhc2llciB0bwojOiAgICAgIHRyYW5zZm9ybSBhIHZhcmlhYmxlIGludG8gdGhlIG5hdGl2ZSBzdHIgdHlwZSBmb3IgdGhlIHB5dGhvbiB2ZXJzaW9uCiM6ICAgICAgdGhlIGNvZGUgaXMgcnVubmluZyBvbi4gIFVzZSB0aGlzIHdoZW4gY29uc3RydWN0aW5nIHRoZSBtZXNzYWdlIHRvCiM6ICAgICAgc2VuZCB0byBleGNlcHRpb25zIG9yIHdoZW4gZGVhbGluZyB3aXRoIGFuIEFQSSB0aGF0IG5lZWRzIHRvIHRha2UKIzogICAgICBhIG5hdGl2ZSBzdHJpbmcuICBFeGFtcGxlOjoKIzoKIzogICAgICAgICAgdHJ5OgojOiAgICAgICAgICAgICAgMS8vMAojOiAgICAgICAgICBleGNlcHQgWmVyb0RpdmlzaW9uRXJyb3IgYXMgZToKIzogICAgICAgICAgICAgIHJhaXNlIE15RXhjZXB0aW9uKCdFbmNvdW50ZXJlZCBhbmQgZXJyb3I6ICVzJyAlIHRvX25hdGl2ZShlKSkKaWYgUFkzOgogICAgdG9fbmF0aXZlID0gdG9fdGV4dAplbHNlOgogICAgdG9fbmF0aXZlID0gdG9fYnl0ZXMKUEsDBBQAAAAAAPe7K0sl3LR+ExAAABMQAAAiAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvcHljb21wYXQyNC5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpIDIwMTYsIFRvc2hpbyBLdXJhdG9taSA8dGt1cmF0b21pQGFuc2libGUuY29tPgojIENvcHlyaWdodCAoYykgMjAxNSwgTWFyaXVzIEdlZG1pbmFzCiMKIyBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQgbW9kaWZpY2F0aW9uLAojIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKIwojICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKIyAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwKIyAgICAgIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24KIyAgICAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORAojIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVECiMgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRSBESVNDTEFJTUVELgojIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULAojIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywKIyBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MKIyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUCiMgTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFCiMgVVNFIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiMKCmltcG9ydCBzeXMKCmRlZiBnZXRfZXhjZXB0aW9uKCk6CiAgICAiIiJHZXQgdGhlIGN1cnJlbnQgZXhjZXB0aW9uLgoKICAgIFRoaXMgY29kZSBuZWVkcyB0byB3b3JrIG9uIFB5dGhvbiAyLjQgdGhyb3VnaCAzLngsIHNvIHdlIGNhbm5vdCB1c2UKICAgICJleGNlcHQgRXhjZXB0aW9uLCBlOiIgKFN5bnRheEVycm9yIG9uIFB5dGhvbiAzLngpIG5vcgogICAgImV4Y2VwdCBFeGNlcHRpb24gYXMgZToiIChTeW50YXhFcnJvciBvbiBQeXRob24gMi40LTIuNSkuCiAgICBJbnN0ZWFkIHdlIG11c3QgdXNlIDo6CgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKCiAgICAiIiIKICAgIHJldHVybiBzeXMuZXhjX2luZm8oKVsxXQoKdHJ5OgogICAgIyBQeXRob24gMi42KwogICAgZnJvbSBhc3QgaW1wb3J0IGxpdGVyYWxfZXZhbApleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAjIGEgcmVwbGFjZW1lbnQgZm9yIGxpdGVyYWxfZXZhbCB0aGF0IHdvcmtzIHdpdGggcHl0aG9uIDIuNC4gZnJvbToKICAgICMgaHR0cHM6Ly9tYWlsLnB5dGhvbi5vcmcvcGlwZXJtYWlsL3B5dGhvbi1saXN0LzIwMDktU2VwdGVtYmVyLzU1MTg4MC5odG1sCiAgICAjIHdoaWNoIGlzIGVzc2VudGlhbGx5IGEgY3V0L3Bhc3RlIGZyb20gYW4gZWFybGllciAoMi42KSB2ZXJzaW9uIG9mIHB5dGhvbidzCiAgICAjIGFzdC5weQogICAgZnJvbSBjb21waWxlciBpbXBvcnQgYXN0LCBwYXJzZQogICAgZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IGJpbmFyeV90eXBlLCBzdHJpbmdfdHlwZXMsIHRleHRfdHlwZQoKICAgIGRlZiBsaXRlcmFsX2V2YWwobm9kZV9vcl9zdHJpbmcpOgogICAgICAgICIiIgogICAgICAgIFNhZmVseSBldmFsdWF0ZSBhbiBleHByZXNzaW9uIG5vZGUgb3IgYSBzdHJpbmcgY29udGFpbmluZyBhIFB5dGhvbgogICAgICAgIGV4cHJlc3Npb24uICBUaGUgc3RyaW5nIG9yIG5vZGUgcHJvdmlkZWQgbWF5IG9ubHkgY29uc2lzdCBvZiB0aGUgIGZvbGxvd2luZwogICAgICAgIFB5dGhvbiBsaXRlcmFsIHN0cnVjdHVyZXM6IHN0cmluZ3MsIG51bWJlcnMsIHR1cGxlcywgbGlzdHMsIGRpY3RzLCAgYm9vbGVhbnMsCiAgICAgICAgYW5kIE5vbmUuCiAgICAgICAgIiIiCiAgICAgICAgX3NhZmVfbmFtZXMgPSB7J05vbmUnOiBOb25lLCAnVHJ1ZSc6IFRydWUsICdGYWxzZSc6IEZhbHNlfQogICAgICAgIGlmIGlzaW5zdGFuY2Uobm9kZV9vcl9zdHJpbmcsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIG5vZGVfb3Jfc3RyaW5nID0gcGFyc2Uobm9kZV9vcl9zdHJpbmcsIG1vZGU9J2V2YWwnKQogICAgICAgIGlmIGlzaW5zdGFuY2Uobm9kZV9vcl9zdHJpbmcsIGFzdC5FeHByZXNzaW9uKToKICAgICAgICAgICAgbm9kZV9vcl9zdHJpbmcgPSBub2RlX29yX3N0cmluZy5ub2RlCgogICAgICAgIGRlZiBfY29udmVydChub2RlKToKICAgICAgICAgICAgIyBPa2F5IHRvIHVzZSBsb25nIGhlcmUgYmVjYXVzZSB0aGlzIGlzIG9ubHkgZm9yIHB5dGhvbiAyLjQgYW5kIDIuNQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5Db25zdCkgYW5kIGlzaW5zdGFuY2Uobm9kZS52YWx1ZSwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUsIGludCwgZmxvYXQsIGxvbmcsIGNvbXBsZXgpKToKICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnZhbHVlCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuVHVwbGUpOgogICAgICAgICAgICAgICAgcmV0dXJuIHR1cGxlKG1hcChfY29udmVydCwgbm9kZS5ub2RlcykpCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuTGlzdCk6CiAgICAgICAgICAgICAgICByZXR1cm4gbGlzdChtYXAoX2NvbnZlcnQsIG5vZGUubm9kZXMpKQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0LkRpY3QpOgogICAgICAgICAgICAgICAgcmV0dXJuIGRpY3QoKF9jb252ZXJ0KGspLCBfY29udmVydCh2KSkgZm9yIGssIHYgaW4gbm9kZS5pdGVtcygpKQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0Lk5hbWUpOgogICAgICAgICAgICAgICAgaWYgbm9kZS5uYW1lIGluIF9zYWZlX25hbWVzOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBfc2FmZV9uYW1lc1tub2RlLm5hbWVdCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuVW5hcnlTdWIpOgogICAgICAgICAgICAgICAgcmV0dXJuIC1fY29udmVydChub2RlLmV4cHIpCiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ21hbGZvcm1lZCBzdHJpbmcnKQogICAgICAgIHJldHVybiBfY29udmVydChub2RlX29yX3N0cmluZykKCl9fYWxsX18gPSAoJ2dldF9leGNlcHRpb24nLCAnbGl0ZXJhbF9ldmFsJykKUEsDBBQAAAAAAPe7K0sYF3L1AREAAAERAAAkAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19faW5pdF9fLnB5IyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojIFRoaXMgcGFydGljdWxhciBmaWxlIHNuaXBwZXQsIGFuZCB0aGlzIGZpbGUgc25pcHBldCBvbmx5LCBpcyBCU0QgbGljZW5zZWQuCiMgTW9kdWxlcyB5b3Ugd3JpdGUgdXNpbmcgdGhpcyBzbmlwcGV0LCB3aGljaCBpcyBlbWJlZGRlZCBkeW5hbWljYWxseSBieSBBbnNpYmxlCiMgc3RpbGwgYmVsb25nIHRvIHRoZSBhdXRob3Igb2YgdGhlIG1vZHVsZSwgYW5kIG1heSBhc3NpZ24gdGhlaXIgb3duIGxpY2Vuc2UKIyB0byB0aGUgY29tcGxldGUgd29yay4KIwojIENvcHlyaWdodCAoYykgMjAxNywgVG9zaGlvIEt1cmF0b21pIDx0a3VyYXRvbWlAYW5zaWJsZS5jb20+CiMKIyBUaGlzIGNvZGUgaXMgYmFzZWQgb24gY29kZSBmcm9tIEFzdHJvcHkgYW5kIHJldGFpbnMgdGhlaXIgMy1jbGF1c2UgQlNEIGxpY2Vuc2UKIyByZXByb2R1Y2VkIGJlbG93OgojCiMgQ29weXJpZ2h0IChjKSAyMDExLTIwMTYsIEFzdHJvcHkgRGV2ZWxvcGVycwojCiMgQWxsIHJpZ2h0cyByZXNlcnZlZC4KIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dAojIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsIHRoaXMKIyAgIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMgKiBOZWl0aGVyIHRoZSBuYW1lIG9mIHRoZSBBc3Ryb3B5IFRlYW0gbm9yIHRoZSBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heQojICAgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHMgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dAojICAgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiCiMgQU5EIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRQojIElNUExJRUQgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRQojIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUKIyBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTAojIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SCiMgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIKIyBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLAojIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFCiMgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwojIEFzdHJvcHkgTGljZW5zZTogaHR0cHM6Ly9naXRodWIuY29tL2FzdHJvcHkvYXN0cm9weS9ibG9iL2NmMzI2NWU0MmEwZGI4ZTAwYmI5MDY0NGRiMzdjODE1MGY1YWMwMGMvbGljZW5zZXMvTElDRU5TRS5yc3QKIyBBc3Ryb3B5IENvZGU6IGh0dHBzOi8vZ2l0aHViLmNvbS9hc3Ryb3B5L2FzdHJvcHkvYmxvYi9jZjMyNjVlNDJhMGRiOGUwMGJiOTA2NDRkYjM3YzgxNTBmNWFjMDBjL2FzdHJvcHkvZXh0ZXJuL3NpeC5weQoKIiIiCkhhbmRsZSBsb2FkaW5nIHNpeCBwYWNrYWdlIGZyb20gc3lzdGVtIG9yIGZyb20gdGhlIGJ1bmRsZWQgY29weQoiIiIKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCBhYnNvbHV0ZV9pbXBvcnQKCmltcG9ydCBpbXAgYXMgX2ltcAppbXBvcnQgc3lzIGFzIF9zeXMKCnRyeToKICAgIGZyb20gZGlzdHV0aWxzLnZlcnNpb24gaW1wb3J0IExvb3NlVmVyc2lvbiBhcyBfTG9vc2VWZXJzaW9uCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICMgU29tZSBwbGF0Zm9ybXMgKmNvdWdoKlNvbGFyaXMqY291Z2gqIGRvbid0IHNoaXAgdGhlIHdob2xlIHN0ZGxpYgogICAgX0xvb3NlVmVyc2lvbiA9IE5vbmUKCnRyeToKICAgIGltcG9ydCBzaXggYXMgX3N5c3RlbV9zaXgKZXhjZXB0IEltcG9ydEVycm9yOgogICAgX3N5c3RlbV9zaXggPSBOb25lCgpmcm9tIC4gaW1wb3J0IF9zaXggYXMgX2J1bmRsZWRfc2l4CgoKZGVmIF9maW5kX21vZHVsZShuYW1lLCBwYXRoPU5vbmUpOgogICAgIiIiQWx0ZXJuYXRpdmUgdG8gYGltcC5maW5kX21vZHVsZWAgdGhhdCBjYW4gYWxzbyBzZWFyY2ggaW4gc3VicGFja2FnZXMiIiIKICAgIHBhcnRzID0gbmFtZS5zcGxpdCgnLicpCgogICAgZm9yIHBhcnQgaW4gcGFydHM6CiAgICAgICAgaWYgcGF0aCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGF0aCA9IFtwYXRoXQogICAgICAgIGZoLCBwYXRoLCBkZXNjciA9IF9pbXAuZmluZF9tb2R1bGUocGFydCwgcGF0aCkKICAgIHJldHVybiBmaCwgcGF0aCwgZGVzY3IKCgpkZWYgX2dldF9idW5kbGVkX3NpeF9zb3VyY2UoKToKICAgICMgU3BlY2lhbCBpbXBvcnQgbG9hZGVyICh6aXBpbXBvcnQgZm9yIGluc3RhbmNlKQogICAgZm91bmQgPSBGYWxzZQogICAgZm9yIHBhdGggaW4gX3N5cy5wYXRoOgogICAgICAgIGltcG9ydGVyID0gX3N5cy5wYXRoX2ltcG9ydGVyX2NhY2hlLmdldChwYXRoKQogICAgICAgIGlmIGltcG9ydGVyOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmb3VuZCA9IGltcG9ydGVyLmZpbmRfbW9kdWxlKCdhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeCcpCiAgICAgICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIGZvdW5kOgogICAgICAgICAgICAgICAgYnJlYWsKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoIkNvdWxkIG5vdCBmaW5kIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5fc2l4IikKCiAgICBtb2R1bGVfc291cmNlID0gaW1wb3J0ZXIuZ2V0X3NvdXJjZSgnYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19zaXgnKQogICAgcmV0dXJuIG1vZHVsZV9zb3VyY2UKCgpkZWYgX2dldF9zaXhfc291cmNlKCk6CiAgICAiIiJJbXBvcnQgdGhlIG5ld2VzdCB2ZXJzaW9uIG9mIHRoZSBzaXggbGlicmFyeSB0aGF0J3MgYXZhaWxhYmxlIiIiCiAgICBtb2RfaW5mbyA9IE5vbmUKICAgIHRyeToKICAgICAgICBpZiBfc3lzdGVtX3NpeCBhbmQgX0xvb3NlVmVyc2lvbiBhbmQgXAogICAgICAgICAgICAgICAgX0xvb3NlVmVyc2lvbihfc3lzdGVtX3NpeC5fX3ZlcnNpb25fXykgPj0gX0xvb3NlVmVyc2lvbihfYnVuZGxlZF9zaXguX192ZXJzaW9uX18pOgogICAgICAgICAgICBtb2RfaW5mbyA9IF9maW5kX21vZHVsZSgnc2l4JykKICAgIGV4Y2VwdDoKICAgICAgICAjIEFueSBlcnJvcnMgZmluZGluZyB0aGUgc3lzdGVtIGxpYnJhcnksIHVzZSBvdXIgYnVuZGxlZCBsaWIgaW5zdGVhZAogICAgICAgIHBhc3MKCiAgICBpZiBub3QgbW9kX2luZm86CiAgICAgICAgdHJ5OgogICAgICAgICAgICBtb2RfaW5mbyA9IF9maW5kX21vZHVsZSgnYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Ll9zaXgnKQogICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICAgICAgIyB6aXBpbXBvcnQKICAgICAgICAgICAgbW9kdWxlX3NvdXJjZSA9IF9nZXRfYnVuZGxlZF9zaXhfc291cmNlKCkKICAgICAgICAgICAgcmV0dXJuIG1vZHVsZV9zb3VyY2UKCiAgICByZXR1cm4gbW9kX2luZm9bMF0ucmVhZCgpCgpzb3VyY2UgPSBfZ2V0X3NpeF9zb3VyY2UoKQpleGVjKHNvdXJjZSkKUEsDBBQAAAAAAPe7K0s44sfRkXUAAJF1AAAgAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19zaXgucHkiIiJVdGlsaXRpZXMgZm9yIHdyaXRpbmcgY29kZSB0aGF0IHJ1bnMgb24gUHl0aG9uIDIgYW5kIDMiIiIKCiMgQ29weXJpZ2h0IChjKSAyMDEwLTIwMTUgQmVuamFtaW4gUGV0ZXJzb24KIwojIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKIyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAojIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKIyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiMgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKIwojIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbAojIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiMKIyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgojIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAojIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQojIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKIyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAojIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFCiMgU09GVFdBUkUuCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IGFic29sdXRlX2ltcG9ydAoKaW1wb3J0IGZ1bmN0b29scwppbXBvcnQgaXRlcnRvb2xzCmltcG9ydCBvcGVyYXRvcgppbXBvcnQgc3lzCmltcG9ydCB0eXBlcwoKX19hdXRob3JfXyA9ICJCZW5qYW1pbiBQZXRlcnNvbiA8YmVuamFtaW5AcHl0aG9uLm9yZz4iCl9fdmVyc2lvbl9fID0gIjEuMTAuMCIKCgojIFVzZWZ1bCBmb3IgdmVyeSBjb2Fyc2UgdmVyc2lvbiBkaWZmZXJlbnRpYXRpb24uClBZMiA9IHN5cy52ZXJzaW9uX2luZm9bMF0gPT0gMgpQWTMgPSBzeXMudmVyc2lvbl9pbmZvWzBdID09IDMKUFkzNCA9IHN5cy52ZXJzaW9uX2luZm9bMDoyXSA+PSAoMywgNCkKCmlmIFBZMzoKICAgIHN0cmluZ190eXBlcyA9IHN0ciwKICAgIGludGVnZXJfdHlwZXMgPSBpbnQsCiAgICBjbGFzc190eXBlcyA9IHR5cGUsCiAgICB0ZXh0X3R5cGUgPSBzdHIKICAgIGJpbmFyeV90eXBlID0gYnl0ZXMKICAgIE1BWFNJWkUgPSBzeXMubWF4c2l6ZQplbHNlOgogICAgc3RyaW5nX3R5cGVzID0gYmFzZXN0cmluZywKICAgIGludGVnZXJfdHlwZXMgPSAoaW50LCBsb25nKQogICAgY2xhc3NfdHlwZXMgPSAodHlwZSwgdHlwZXMuQ2xhc3NUeXBlKQogICAgdGV4dF90eXBlID0gdW5pY29kZQogICAgYmluYXJ5X3R5cGUgPSBzdHIKCiAgICBpZiBzeXMucGxhdGZvcm0uc3RhcnRzd2l0aCgiamF2YSIpOgogICAgICAgICMgSnl0aG9uIGFsd2F5cyB1c2VzIDMyIGJpdHMuCiAgICAgICAgTUFYU0laRSA9IGludCgoMSA8PCAzMSkgLSAxKQogICAgZWxzZToKICAgICAgICAjIEl0J3MgcG9zc2libGUgdG8gaGF2ZSBzaXplb2YobG9uZykgIT0gc2l6ZW9mKFB5X3NzaXplX3QpLgogICAgICAgIGNsYXNzIFgob2JqZWN0KToKCiAgICAgICAgICAgIGRlZiBfX2xlbl9fKHNlbGYpOgogICAgICAgICAgICAgICAgcmV0dXJuIDEgPDwgMzEKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxlbihYKCkpCiAgICAgICAgZXhjZXB0IE92ZXJmbG93RXJyb3I6CiAgICAgICAgICAgICMgMzItYml0CiAgICAgICAgICAgIE1BWFNJWkUgPSBpbnQoKDEgPDwgMzEpIC0gMSkKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIDY0LWJpdAogICAgICAgICAgICBNQVhTSVpFID0gaW50KCgxIDw8IDYzKSAtIDEpCiAgICAgICAgZGVsIFgKCgpkZWYgX2FkZF9kb2MoZnVuYywgZG9jKToKICAgICIiIkFkZCBkb2N1bWVudGF0aW9uIHRvIGEgZnVuY3Rpb24uIiIiCiAgICBmdW5jLl9fZG9jX18gPSBkb2MKCgpkZWYgX2ltcG9ydF9tb2R1bGUobmFtZSk6CiAgICAiIiJJbXBvcnQgbW9kdWxlLCByZXR1cm5pbmcgdGhlIG1vZHVsZSBhZnRlciB0aGUgbGFzdCBkb3QuIiIiCiAgICBfX2ltcG9ydF9fKG5hbWUpCiAgICByZXR1cm4gc3lzLm1vZHVsZXNbbmFtZV0KCgpjbGFzcyBfTGF6eURlc2NyKG9iamVjdCk6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUpOgogICAgICAgIHNlbGYubmFtZSA9IG5hbWUKCiAgICBkZWYgX19nZXRfXyhzZWxmLCBvYmosIHRwKToKICAgICAgICByZXN1bHQgPSBzZWxmLl9yZXNvbHZlKCkKICAgICAgICBzZXRhdHRyKG9iaiwgc2VsZi5uYW1lLCByZXN1bHQpICAjIEludm9rZXMgX19zZXRfXy4KICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVGhpcyBpcyBhIGJpdCB1Z2x5LCBidXQgaXQgYXZvaWRzIHJ1bm5pbmcgdGhpcyBhZ2FpbiBieQogICAgICAgICAgICAjIHJlbW92aW5nIHRoaXMgZGVzY3JpcHRvci4KICAgICAgICAgICAgZGVsYXR0cihvYmouX19jbGFzc19fLCBzZWxmLm5hbWUpCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIHJlc3VsdAoKCmNsYXNzIE1vdmVkTW9kdWxlKF9MYXp5RGVzY3IpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuYW1lLCBvbGQsIG5ldz1Ob25lKToKICAgICAgICBzdXBlcihNb3ZlZE1vZHVsZSwgc2VsZikuX19pbml0X18obmFtZSkKICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgIGlmIG5ldyBpcyBOb25lOgogICAgICAgICAgICAgICAgbmV3ID0gbmFtZQogICAgICAgICAgICBzZWxmLm1vZCA9IG5ldwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYubW9kID0gb2xkCgogICAgZGVmIF9yZXNvbHZlKHNlbGYpOgogICAgICAgIHJldHVybiBfaW1wb3J0X21vZHVsZShzZWxmLm1vZCkKCiAgICBkZWYgX19nZXRhdHRyX18oc2VsZiwgYXR0cik6CiAgICAgICAgX21vZHVsZSA9IHNlbGYuX3Jlc29sdmUoKQogICAgICAgIHZhbHVlID0gZ2V0YXR0cihfbW9kdWxlLCBhdHRyKQogICAgICAgIHNldGF0dHIoc2VsZiwgYXR0ciwgdmFsdWUpCiAgICAgICAgcmV0dXJuIHZhbHVlCgoKY2xhc3MgX0xhenlNb2R1bGUodHlwZXMuTW9kdWxlVHlwZSk6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUpOgogICAgICAgIHN1cGVyKF9MYXp5TW9kdWxlLCBzZWxmKS5fX2luaXRfXyhuYW1lKQogICAgICAgIHNlbGYuX19kb2NfXyA9IHNlbGYuX19jbGFzc19fLl9fZG9jX18KCiAgICBkZWYgX19kaXJfXyhzZWxmKToKICAgICAgICBhdHRycyA9IFsiX19kb2NfXyIsICJfX25hbWVfXyJdCiAgICAgICAgYXR0cnMgKz0gW2F0dHIubmFtZSBmb3IgYXR0ciBpbiBzZWxmLl9tb3ZlZF9hdHRyaWJ1dGVzXQogICAgICAgIHJldHVybiBhdHRycwoKICAgICMgU3ViY2xhc3NlcyBzaG91bGQgb3ZlcnJpZGUgdGhpcwogICAgX21vdmVkX2F0dHJpYnV0ZXMgPSBbXQoKCmNsYXNzIE1vdmVkQXR0cmlidXRlKF9MYXp5RGVzY3IpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuYW1lLCBvbGRfbW9kLCBuZXdfbW9kLCBvbGRfYXR0cj1Ob25lLCBuZXdfYXR0cj1Ob25lKToKICAgICAgICBzdXBlcihNb3ZlZEF0dHJpYnV0ZSwgc2VsZikuX19pbml0X18obmFtZSkKICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgIGlmIG5ld19tb2QgaXMgTm9uZToKICAgICAgICAgICAgICAgIG5ld19tb2QgPSBuYW1lCiAgICAgICAgICAgIHNlbGYubW9kID0gbmV3X21vZAogICAgICAgICAgICBpZiBuZXdfYXR0ciBpcyBOb25lOgogICAgICAgICAgICAgICAgaWYgb2xkX2F0dHIgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBuZXdfYXR0ciA9IG5hbWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbmV3X2F0dHIgPSBvbGRfYXR0cgogICAgICAgICAgICBzZWxmLmF0dHIgPSBuZXdfYXR0cgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYubW9kID0gb2xkX21vZAogICAgICAgICAgICBpZiBvbGRfYXR0ciBpcyBOb25lOgogICAgICAgICAgICAgICAgb2xkX2F0dHIgPSBuYW1lCiAgICAgICAgICAgIHNlbGYuYXR0ciA9IG9sZF9hdHRyCgogICAgZGVmIF9yZXNvbHZlKHNlbGYpOgogICAgICAgIG1vZHVsZSA9IF9pbXBvcnRfbW9kdWxlKHNlbGYubW9kKQogICAgICAgIHJldHVybiBnZXRhdHRyKG1vZHVsZSwgc2VsZi5hdHRyKQoKCmNsYXNzIF9TaXhNZXRhUGF0aEltcG9ydGVyKG9iamVjdCk6CgogICAgIiIiCiAgICBBIG1ldGEgcGF0aCBpbXBvcnRlciB0byBpbXBvcnQgc2l4Lm1vdmVzIGFuZCBpdHMgc3VibW9kdWxlcy4KCiAgICBUaGlzIGNsYXNzIGltcGxlbWVudHMgYSBQRVAzMDIgZmluZGVyIGFuZCBsb2FkZXIuIEl0IHNob3VsZCBiZSBjb21wYXRpYmxlCiAgICB3aXRoIFB5dGhvbiAyLjUgYW5kIGFsbCBleGlzdGluZyB2ZXJzaW9ucyBvZiBQeXRob24zCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgc2l4X21vZHVsZV9uYW1lKToKICAgICAgICBzZWxmLm5hbWUgPSBzaXhfbW9kdWxlX25hbWUKICAgICAgICBzZWxmLmtub3duX21vZHVsZXMgPSB7fQoKICAgIGRlZiBfYWRkX21vZHVsZShzZWxmLCBtb2QsICpmdWxsbmFtZXMpOgogICAgICAgIGZvciBmdWxsbmFtZSBpbiBmdWxsbmFtZXM6CiAgICAgICAgICAgIHNlbGYua25vd25fbW9kdWxlc1tzZWxmLm5hbWUgKyAiLiIgKyBmdWxsbmFtZV0gPSBtb2QKCiAgICBkZWYgX2dldF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgIHJldHVybiBzZWxmLmtub3duX21vZHVsZXNbc2VsZi5uYW1lICsgIi4iICsgZnVsbG5hbWVdCgogICAgZGVmIGZpbmRfbW9kdWxlKHNlbGYsIGZ1bGxuYW1lLCBwYXRoPU5vbmUpOgogICAgICAgIGlmIGZ1bGxuYW1lIGluIHNlbGYua25vd25fbW9kdWxlczoKICAgICAgICAgICAgcmV0dXJuIHNlbGYKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBfX2dldF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIHNlbGYua25vd25fbW9kdWxlc1tmdWxsbmFtZV0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHJhaXNlIEltcG9ydEVycm9yKCJUaGlzIGxvYWRlciBkb2VzIG5vdCBrbm93IG1vZHVsZSAiICsgZnVsbG5hbWUpCgogICAgZGVmIGxvYWRfbW9kdWxlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgaW4gY2FzZSBvZiBhIHJlbG9hZAogICAgICAgICAgICByZXR1cm4gc3lzLm1vZHVsZXNbZnVsbG5hbWVdCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgbW9kID0gc2VsZi5fX2dldF9tb2R1bGUoZnVsbG5hbWUpCiAgICAgICAgaWYgaXNpbnN0YW5jZShtb2QsIE1vdmVkTW9kdWxlKToKICAgICAgICAgICAgbW9kID0gbW9kLl9yZXNvbHZlKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBtb2QuX19sb2FkZXJfXyA9IHNlbGYKICAgICAgICBzeXMubW9kdWxlc1tmdWxsbmFtZV0gPSBtb2QKICAgICAgICByZXR1cm4gbW9kCgogICAgZGVmIGlzX3BhY2thZ2Uoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgICIiIgogICAgICAgIFJldHVybiB0cnVlLCBpZiB0aGUgbmFtZWQgbW9kdWxlIGlzIGEgcGFja2FnZS4KCiAgICAgICAgV2UgbmVlZCB0aGlzIG1ldGhvZCB0byBnZXQgY29ycmVjdCBzcGVjIG9iamVjdHMgd2l0aAogICAgICAgIFB5dGhvbiAzLjQgKHNlZSBQRVA0NTEpCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIGhhc2F0dHIoc2VsZi5fX2dldF9tb2R1bGUoZnVsbG5hbWUpLCAiX19wYXRoX18iKQoKICAgIGRlZiBnZXRfY29kZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgIiIiUmV0dXJuIE5vbmUKCiAgICAgICAgUmVxdWlyZWQsIGlmIGlzX3BhY2thZ2UgaXMgaW1wbGVtZW50ZWQiIiIKICAgICAgICBzZWxmLl9fZ2V0X21vZHVsZShmdWxsbmFtZSkgICMgZXZlbnR1YWxseSByYWlzZXMgSW1wb3J0RXJyb3IKICAgICAgICByZXR1cm4gTm9uZQogICAgZ2V0X3NvdXJjZSA9IGdldF9jb2RlICAjIHNhbWUgYXMgZ2V0X2NvZGUKCl9pbXBvcnRlciA9IF9TaXhNZXRhUGF0aEltcG9ydGVyKF9fbmFtZV9fKQoKCmNsYXNzIF9Nb3ZlZEl0ZW1zKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyIiIgogICAgX19wYXRoX18gPSBbXSAgIyBtYXJrIGFzIHBhY2thZ2UKCgpfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJjU3RyaW5nSU8iLCAiY1N0cmluZ0lPIiwgImlvIiwgIlN0cmluZ0lPIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZmlsdGVyIiwgIml0ZXJ0b29scyIsICJidWlsdGlucyIsICJpZmlsdGVyIiwgImZpbHRlciIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImZpbHRlcmZhbHNlIiwgIml0ZXJ0b29scyIsICJpdGVydG9vbHMiLCAiaWZpbHRlcmZhbHNlIiwgImZpbHRlcmZhbHNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiaW5wdXQiLCAiX19idWlsdGluX18iLCAiYnVpbHRpbnMiLCAicmF3X2lucHV0IiwgImlucHV0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiaW50ZXJuIiwgIl9fYnVpbHRpbl9fIiwgInN5cyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIm1hcCIsICJpdGVydG9vbHMiLCAiYnVpbHRpbnMiLCAiaW1hcCIsICJtYXAiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJnZXRjd2QiLCAib3MiLCAib3MiLCAiZ2V0Y3dkdSIsICJnZXRjd2QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJnZXRjd2RiIiwgIm9zIiwgIm9zIiwgImdldGN3ZCIsICJnZXRjd2RiIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicmFuZ2UiLCAiX19idWlsdGluX18iLCAiYnVpbHRpbnMiLCAieHJhbmdlIiwgInJhbmdlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicmVsb2FkX21vZHVsZSIsICJfX2J1aWx0aW5fXyIsICJpbXBvcnRsaWIiIGlmIFBZMzQgZWxzZSAiaW1wIiwgInJlbG9hZCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInJlZHVjZSIsICJfX2J1aWx0aW5fXyIsICJmdW5jdG9vbHMiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzaGxleF9xdW90ZSIsICJwaXBlcyIsICJzaGxleCIsICJxdW90ZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlN0cmluZ0lPIiwgIlN0cmluZ0lPIiwgImlvIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVXNlckRpY3QiLCAiVXNlckRpY3QiLCAiY29sbGVjdGlvbnMiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVc2VyTGlzdCIsICJVc2VyTGlzdCIsICJjb2xsZWN0aW9ucyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVzZXJTdHJpbmciLCAiVXNlclN0cmluZyIsICJjb2xsZWN0aW9ucyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInhyYW5nZSIsICJfX2J1aWx0aW5fXyIsICJidWlsdGlucyIsICJ4cmFuZ2UiLCAicmFuZ2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ6aXAiLCAiaXRlcnRvb2xzIiwgImJ1aWx0aW5zIiwgIml6aXAiLCAiemlwIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiemlwX2xvbmdlc3QiLCAiaXRlcnRvb2xzIiwgIml0ZXJ0b29scyIsICJpemlwX2xvbmdlc3QiLCAiemlwX2xvbmdlc3QiKSwKICAgIE1vdmVkTW9kdWxlKCJidWlsdGlucyIsICJfX2J1aWx0aW5fXyIpLAogICAgTW92ZWRNb2R1bGUoImNvbmZpZ3BhcnNlciIsICJDb25maWdQYXJzZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJjb3B5cmVnIiwgImNvcHlfcmVnIiksCiAgICBNb3ZlZE1vZHVsZSgiZGJtX2dudSIsICJnZGJtIiwgImRibS5nbnUiKSwKICAgIE1vdmVkTW9kdWxlKCJfZHVtbXlfdGhyZWFkIiwgImR1bW15X3RocmVhZCIsICJfZHVtbXlfdGhyZWFkIiksCiAgICBNb3ZlZE1vZHVsZSgiaHR0cF9jb29raWVqYXIiLCAiY29va2llbGliIiwgImh0dHAuY29va2llamFyIiksCiAgICBNb3ZlZE1vZHVsZSgiaHR0cF9jb29raWVzIiwgIkNvb2tpZSIsICJodHRwLmNvb2tpZXMiKSwKICAgIE1vdmVkTW9kdWxlKCJodG1sX2VudGl0aWVzIiwgImh0bWxlbnRpdHlkZWZzIiwgImh0bWwuZW50aXRpZXMiKSwKICAgIE1vdmVkTW9kdWxlKCJodG1sX3BhcnNlciIsICJIVE1MUGFyc2VyIiwgImh0bWwucGFyc2VyIiksCiAgICBNb3ZlZE1vZHVsZSgiaHR0cF9jbGllbnQiLCAiaHR0cGxpYiIsICJodHRwLmNsaWVudCIpLAogICAgTW92ZWRNb2R1bGUoImVtYWlsX21pbWVfbXVsdGlwYXJ0IiwgImVtYWlsLk1JTUVNdWx0aXBhcnQiLCAiZW1haWwubWltZS5tdWx0aXBhcnQiKSwKICAgIE1vdmVkTW9kdWxlKCJlbWFpbF9taW1lX25vbm11bHRpcGFydCIsICJlbWFpbC5NSU1FTm9uTXVsdGlwYXJ0IiwgImVtYWlsLm1pbWUubm9ubXVsdGlwYXJ0IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV90ZXh0IiwgImVtYWlsLk1JTUVUZXh0IiwgImVtYWlsLm1pbWUudGV4dCIpLAogICAgTW92ZWRNb2R1bGUoImVtYWlsX21pbWVfYmFzZSIsICJlbWFpbC5NSU1FQmFzZSIsICJlbWFpbC5taW1lLmJhc2UiKSwKICAgIE1vdmVkTW9kdWxlKCJCYXNlSFRUUFNlcnZlciIsICJCYXNlSFRUUFNlcnZlciIsICJodHRwLnNlcnZlciIpLAogICAgTW92ZWRNb2R1bGUoIkNHSUhUVFBTZXJ2ZXIiLCAiQ0dJSFRUUFNlcnZlciIsICJodHRwLnNlcnZlciIpLAogICAgTW92ZWRNb2R1bGUoIlNpbXBsZUhUVFBTZXJ2ZXIiLCAiU2ltcGxlSFRUUFNlcnZlciIsICJodHRwLnNlcnZlciIpLAogICAgTW92ZWRNb2R1bGUoImNQaWNrbGUiLCAiY1BpY2tsZSIsICJwaWNrbGUiKSwKICAgIE1vdmVkTW9kdWxlKCJxdWV1ZSIsICJRdWV1ZSIpLAogICAgTW92ZWRNb2R1bGUoInJlcHJsaWIiLCAicmVwciIpLAogICAgTW92ZWRNb2R1bGUoInNvY2tldHNlcnZlciIsICJTb2NrZXRTZXJ2ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJfdGhyZWFkIiwgInRocmVhZCIsICJfdGhyZWFkIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlciIsICJUa2ludGVyIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9kaWFsb2ciLCAiRGlhbG9nIiwgInRraW50ZXIuZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9maWxlZGlhbG9nIiwgIkZpbGVEaWFsb2ciLCAidGtpbnRlci5maWxlZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9zY3JvbGxlZHRleHQiLCAiU2Nyb2xsZWRUZXh0IiwgInRraW50ZXIuc2Nyb2xsZWR0ZXh0IiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9zaW1wbGVkaWFsb2ciLCAiU2ltcGxlRGlhbG9nIiwgInRraW50ZXIuc2ltcGxlZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl90aXgiLCAiVGl4IiwgInRraW50ZXIudGl4IiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl90dGsiLCAidHRrIiwgInRraW50ZXIudHRrIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9jb25zdGFudHMiLCAiVGtjb25zdGFudHMiLCAidGtpbnRlci5jb25zdGFudHMiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2RuZCIsICJUa2RuZCIsICJ0a2ludGVyLmRuZCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfY29sb3JjaG9vc2VyIiwgInRrQ29sb3JDaG9vc2VyIiwKICAgICAgICAgICAgICAgICJ0a2ludGVyLmNvbG9yY2hvb3NlciIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfY29tbW9uZGlhbG9nIiwgInRrQ29tbW9uRGlhbG9nIiwKICAgICAgICAgICAgICAgICJ0a2ludGVyLmNvbW1vbmRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfdGtmaWxlZGlhbG9nIiwgInRrRmlsZURpYWxvZyIsICJ0a2ludGVyLmZpbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2ZvbnQiLCAidGtGb250IiwgInRraW50ZXIuZm9udCIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfbWVzc2FnZWJveCIsICJ0a01lc3NhZ2VCb3giLCAidGtpbnRlci5tZXNzYWdlYm94IiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl90a3NpbXBsZWRpYWxvZyIsICJ0a1NpbXBsZURpYWxvZyIsCiAgICAgICAgICAgICAgICAidGtpbnRlci5zaW1wbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ1cmxsaWJfcGFyc2UiLCBfX25hbWVfXyArICIubW92ZXMudXJsbGliX3BhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYl9lcnJvciIsIF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWJfZXJyb3IiLCAidXJsbGliLmVycm9yIiksCiAgICBNb3ZlZE1vZHVsZSgidXJsbGliIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYiIsIF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIiKSwKICAgIE1vdmVkTW9kdWxlKCJ1cmxsaWJfcm9ib3RwYXJzZXIiLCAicm9ib3RwYXJzZXIiLCAidXJsbGliLnJvYm90cGFyc2VyIiksCiAgICBNb3ZlZE1vZHVsZSgieG1scnBjX2NsaWVudCIsICJ4bWxycGNsaWIiLCAieG1scnBjLmNsaWVudCIpLAogICAgTW92ZWRNb2R1bGUoInhtbHJwY19zZXJ2ZXIiLCAiU2ltcGxlWE1MUlBDU2VydmVyIiwgInhtbHJwYy5zZXJ2ZXIiKSwKXQojIEFkZCB3aW5kb3dzIHNwZWNpZmljIG1vZHVsZXMuCmlmIHN5cy5wbGF0Zm9ybSA9PSAid2luMzIiOgogICAgX21vdmVkX2F0dHJpYnV0ZXMgKz0gWwogICAgICAgIE1vdmVkTW9kdWxlKCJ3aW5yZWciLCAiX3dpbnJlZyIpLAogICAgXQoKZm9yIGF0dHIgaW4gX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKF9Nb3ZlZEl0ZW1zLCBhdHRyLm5hbWUsIGF0dHIpCiAgICBpZiBpc2luc3RhbmNlKGF0dHIsIE1vdmVkTW9kdWxlKToKICAgICAgICBfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoYXR0ciwgIm1vdmVzLiIgKyBhdHRyLm5hbWUpCmRlbCBhdHRyCgpfTW92ZWRJdGVtcy5fbW92ZWRfYXR0cmlidXRlcyA9IF9tb3ZlZF9hdHRyaWJ1dGVzCgptb3ZlcyA9IF9Nb3ZlZEl0ZW1zKF9fbmFtZV9fICsgIi5tb3ZlcyIpCl9pbXBvcnRlci5fYWRkX21vZHVsZShtb3ZlcywgIm1vdmVzIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9wYXJzZShfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9wYXJzZSIiIgoKCl91cmxsaWJfcGFyc2VfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJQYXJzZVJlc3VsdCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJTcGxpdFJlc3VsdCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwYXJzZV9xcyIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwYXJzZV9xc2wiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsZGVmcmFnIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybGpvaW4iLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJscGFyc2UiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsc3BsaXQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsdW5wYXJzZSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmx1bnNwbGl0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInF1b3RlIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJxdW90ZV9wbHVzIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1bnF1b3RlIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1bnF1b3RlX3BsdXMiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybGVuY29kZSIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgic3BsaXRxdWVyeSIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgic3BsaXR0YWciLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInNwbGl0dXNlciIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19mcmFnbWVudCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX25ldGxvYyIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX3BhcmFtcyIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX3F1ZXJ5IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfcmVsYXRpdmUiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9wYXJzZV9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9wYXJzZSwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcGFyc2UuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3BhcnNlX21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9wYXJzZShfX25hbWVfXyArICIubW92ZXMudXJsbGliX3BhcnNlIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3BhcnNlIiwgIm1vdmVzLnVybGxpYi5wYXJzZSIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfZXJyb3IoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfZXJyb3IiIiIKCgpfdXJsbGliX2Vycm9yX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVVJMRXJyb3IiLCAidXJsbGliMiIsICJ1cmxsaWIuZXJyb3IiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQRXJyb3IiLCAidXJsbGliMiIsICJ1cmxsaWIuZXJyb3IiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJDb250ZW50VG9vU2hvcnRFcnJvciIsICJ1cmxsaWIiLCAidXJsbGliLmVycm9yIiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9lcnJvcl9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvciwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfZXJyb3IuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX2Vycm9yX21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvcihfX25hbWVfXyArICIubW92ZXMudXJsbGliLmVycm9yIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX2Vycm9yIiwgIm1vdmVzLnVybGxpYi5lcnJvciIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVxdWVzdChfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9yZXF1ZXN0IiIiCgoKX3VybGxpYl9yZXF1ZXN0X21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsb3BlbiIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiaW5zdGFsbF9vcGVuZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImJ1aWxkX29wZW5lciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicGF0aG5hbWUydXJsIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybDJwYXRobmFtZSIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJnZXRwcm94aWVzIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlJlcXVlc3QiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIk9wZW5lckRpcmVjdG9yIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQRGVmYXVsdEVycm9ySGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUFJlZGlyZWN0SGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUENvb2tpZVByb2Nlc3NvciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUHJveHlIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJCYXNlSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUFBhc3N3b3JkTWdyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQUGFzc3dvcmRNZ3JXaXRoRGVmYXVsdFJlYWxtIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJBYnN0cmFjdEJhc2ljQXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBCYXNpY0F1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJQcm94eUJhc2ljQXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkFic3RyYWN0RGlnZXN0QXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBEaWdlc3RBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUHJveHlEaWdlc3RBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBTSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiRmlsZUhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkZUUEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkNhY2hlRlRQSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVW5rbm93bkhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBFcnJvclByb2Nlc3NvciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJscmV0cmlldmUiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsY2xlYW51cCIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVUkxvcGVuZXIiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiRmFuY3lVUkxvcGVuZXIiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicHJveHlfYnlwYXNzIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfcmVxdWVzdF9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXF1ZXN0LCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXF1ZXN0Ll9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9yZXF1ZXN0X21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXF1ZXN0KF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIucmVxdWVzdCIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9yZXF1ZXN0IiwgIm1vdmVzLnVybGxpYi5yZXF1ZXN0IikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZShfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9yZXNwb25zZSIiIgoKCl91cmxsaWJfcmVzcG9uc2VfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJhZGRiYXNlIiwgInVybGxpYiIsICJ1cmxsaWIucmVzcG9uc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJhZGRjbG9zZWhvb2siLCAidXJsbGliIiwgInVybGxpYi5yZXNwb25zZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGluZm8iLCAidXJsbGliIiwgInVybGxpYi5yZXNwb25zZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGluZm91cmwiLCAidXJsbGliIiwgInVybGxpYi5yZXNwb25zZSIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfcmVzcG9uc2VfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVzcG9uc2UsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3Jlc3BvbnNlLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9yZXNwb25zZV9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVzcG9uc2UoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5yZXNwb25zZSIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9yZXNwb25zZSIsICJtb3Zlcy51cmxsaWIucmVzcG9uc2UiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JvYm90cGFyc2VyKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3JvYm90cGFyc2VyIiIiCgoKX3VybGxpYl9yb2JvdHBhcnNlcl9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoIlJvYm90RmlsZVBhcnNlciIsICJyb2JvdHBhcnNlciIsICJ1cmxsaWIucm9ib3RwYXJzZXIiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX3JvYm90cGFyc2VyX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JvYm90cGFyc2VyLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yb2JvdHBhcnNlci5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfcm9ib3RwYXJzZXJfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JvYm90cGFyc2VyKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIucm9ib3RwYXJzZXIiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfcm9ib3RwYXJzZXIiLCAibW92ZXMudXJsbGliLnJvYm90cGFyc2VyIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYih0eXBlcy5Nb2R1bGVUeXBlKToKCiAgICAiIiJDcmVhdGUgYSBzaXgubW92ZXMudXJsbGliIG5hbWVzcGFjZSB0aGF0IHJlc2VtYmxlcyB0aGUgUHl0aG9uIDMgbmFtZXNwYWNlIiIiCiAgICBfX3BhdGhfXyA9IFtdICAjIG1hcmsgYXMgcGFja2FnZQogICAgcGFyc2UgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9wYXJzZSIpCiAgICBlcnJvciA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX2Vycm9yIikKICAgIHJlcXVlc3QgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9yZXF1ZXN0IikKICAgIHJlc3BvbnNlID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfcmVzcG9uc2UiKQogICAgcm9ib3RwYXJzZXIgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9yb2JvdHBhcnNlciIpCgogICAgZGVmIF9fZGlyX18oc2VsZik6CiAgICAgICAgcmV0dXJuIFsncGFyc2UnLCAnZXJyb3InLCAncmVxdWVzdCcsICdyZXNwb25zZScsICdyb2JvdHBhcnNlciddCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWIoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYiIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYiIpCgoKZGVmIGFkZF9tb3ZlKG1vdmUpOgogICAgIiIiQWRkIGFuIGl0ZW0gdG8gc2l4Lm1vdmVzLiIiIgogICAgc2V0YXR0cihfTW92ZWRJdGVtcywgbW92ZS5uYW1lLCBtb3ZlKQoKCmRlZiByZW1vdmVfbW92ZShuYW1lKToKICAgICIiIlJlbW92ZSBpdGVtIGZyb20gc2l4Lm1vdmVzLiIiIgogICAgdHJ5OgogICAgICAgIGRlbGF0dHIoX01vdmVkSXRlbXMsIG5hbWUpCiAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBkZWwgbW92ZXMuX19kaWN0X19bbmFtZV0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHJhaXNlIEF0dHJpYnV0ZUVycm9yKCJubyBzdWNoIG1vdmUsICVyIiAlIChuYW1lLCkpCgoKaWYgUFkzOgogICAgX21ldGhfZnVuYyA9ICJfX2Z1bmNfXyIKICAgIF9tZXRoX3NlbGYgPSAiX19zZWxmX18iCgogICAgX2Z1bmNfY2xvc3VyZSA9ICJfX2Nsb3N1cmVfXyIKICAgIF9mdW5jX2NvZGUgPSAiX19jb2RlX18iCiAgICBfZnVuY19kZWZhdWx0cyA9ICJfX2RlZmF1bHRzX18iCiAgICBfZnVuY19nbG9iYWxzID0gIl9fZ2xvYmFsc19fIgplbHNlOgogICAgX21ldGhfZnVuYyA9ICJpbV9mdW5jIgogICAgX21ldGhfc2VsZiA9ICJpbV9zZWxmIgoKICAgIF9mdW5jX2Nsb3N1cmUgPSAiZnVuY19jbG9zdXJlIgogICAgX2Z1bmNfY29kZSA9ICJmdW5jX2NvZGUiCiAgICBfZnVuY19kZWZhdWx0cyA9ICJmdW5jX2RlZmF1bHRzIgogICAgX2Z1bmNfZ2xvYmFscyA9ICJmdW5jX2dsb2JhbHMiCgoKdHJ5OgogICAgYWR2YW5jZV9pdGVyYXRvciA9IG5leHQKZXhjZXB0IE5hbWVFcnJvcjoKICAgIGRlZiBhZHZhbmNlX2l0ZXJhdG9yKGl0KToKICAgICAgICByZXR1cm4gaXQubmV4dCgpCm5leHQgPSBhZHZhbmNlX2l0ZXJhdG9yCgoKdHJ5OgogICAgY2FsbGFibGUgPSBjYWxsYWJsZQpleGNlcHQgTmFtZUVycm9yOgogICAgZGVmIGNhbGxhYmxlKG9iaik6CiAgICAgICAgcmV0dXJuIGFueSgiX19jYWxsX18iIGluIGtsYXNzLl9fZGljdF9fIGZvciBrbGFzcyBpbiB0eXBlKG9iaikuX19tcm9fXykKCgppZiBQWTM6CiAgICBkZWYgZ2V0X3VuYm91bmRfZnVuY3Rpb24odW5ib3VuZCk6CiAgICAgICAgcmV0dXJuIHVuYm91bmQKCiAgICBjcmVhdGVfYm91bmRfbWV0aG9kID0gdHlwZXMuTWV0aG9kVHlwZQoKICAgIGRlZiBjcmVhdGVfdW5ib3VuZF9tZXRob2QoZnVuYywgY2xzKToKICAgICAgICByZXR1cm4gZnVuYwoKICAgIEl0ZXJhdG9yID0gb2JqZWN0CmVsc2U6CiAgICBkZWYgZ2V0X3VuYm91bmRfZnVuY3Rpb24odW5ib3VuZCk6CiAgICAgICAgcmV0dXJuIHVuYm91bmQuaW1fZnVuYwoKICAgIGRlZiBjcmVhdGVfYm91bmRfbWV0aG9kKGZ1bmMsIG9iaik6CiAgICAgICAgcmV0dXJuIHR5cGVzLk1ldGhvZFR5cGUoZnVuYywgb2JqLCBvYmouX19jbGFzc19fKQoKICAgIGRlZiBjcmVhdGVfdW5ib3VuZF9tZXRob2QoZnVuYywgY2xzKToKICAgICAgICByZXR1cm4gdHlwZXMuTWV0aG9kVHlwZShmdW5jLCBOb25lLCBjbHMpCgogICAgY2xhc3MgSXRlcmF0b3Iob2JqZWN0KToKCiAgICAgICAgZGVmIG5leHQoc2VsZik6CiAgICAgICAgICAgIHJldHVybiB0eXBlKHNlbGYpLl9fbmV4dF9fKHNlbGYpCgogICAgY2FsbGFibGUgPSBjYWxsYWJsZQpfYWRkX2RvYyhnZXRfdW5ib3VuZF9mdW5jdGlvbiwKICAgICAgICAgIiIiR2V0IHRoZSBmdW5jdGlvbiBvdXQgb2YgYSBwb3NzaWJseSB1bmJvdW5kIGZ1bmN0aW9uIiIiKQoKCmdldF9tZXRob2RfZnVuY3Rpb24gPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9tZXRoX2Z1bmMpCmdldF9tZXRob2Rfc2VsZiA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX21ldGhfc2VsZikKZ2V0X2Z1bmN0aW9uX2Nsb3N1cmUgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9mdW5jX2Nsb3N1cmUpCmdldF9mdW5jdGlvbl9jb2RlID0gb3BlcmF0b3IuYXR0cmdldHRlcihfZnVuY19jb2RlKQpnZXRfZnVuY3Rpb25fZGVmYXVsdHMgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9mdW5jX2RlZmF1bHRzKQpnZXRfZnVuY3Rpb25fZ2xvYmFscyA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfZ2xvYmFscykKCgppZiBQWTM6CiAgICBkZWYgaXRlcmtleXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC5rZXlzKCoqa3cpKQoKICAgIGRlZiBpdGVydmFsdWVzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBpdGVyKGQudmFsdWVzKCoqa3cpKQoKICAgIGRlZiBpdGVyaXRlbXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC5pdGVtcygqKmt3KSkKCiAgICBkZWYgaXRlcmxpc3RzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBpdGVyKGQubGlzdHMoKiprdykpCgogICAgdmlld2tleXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoImtleXMiKQoKICAgIHZpZXd2YWx1ZXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZhbHVlcyIpCgogICAgdmlld2l0ZW1zID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJpdGVtcyIpCmVsc2U6CiAgICBkZWYgaXRlcmtleXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGQuaXRlcmtleXMoKiprdykKCiAgICBkZWYgaXRlcnZhbHVlcyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gZC5pdGVydmFsdWVzKCoqa3cpCgogICAgZGVmIGl0ZXJpdGVtcyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gZC5pdGVyaXRlbXMoKiprdykKCiAgICBkZWYgaXRlcmxpc3RzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJsaXN0cygqKmt3KQoKICAgIHZpZXdrZXlzID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJ2aWV3a2V5cyIpCgogICAgdmlld3ZhbHVlcyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigidmlld3ZhbHVlcyIpCgogICAgdmlld2l0ZW1zID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJ2aWV3aXRlbXMiKQoKX2FkZF9kb2MoaXRlcmtleXMsICJSZXR1cm4gYW4gaXRlcmF0b3Igb3ZlciB0aGUga2V5cyBvZiBhIGRpY3Rpb25hcnkuIikKX2FkZF9kb2MoaXRlcnZhbHVlcywgIlJldHVybiBhbiBpdGVyYXRvciBvdmVyIHRoZSB2YWx1ZXMgb2YgYSBkaWN0aW9uYXJ5LiIpCl9hZGRfZG9jKGl0ZXJpdGVtcywKICAgICAgICAgIlJldHVybiBhbiBpdGVyYXRvciBvdmVyIHRoZSAoa2V5LCB2YWx1ZSkgcGFpcnMgb2YgYSBkaWN0aW9uYXJ5LiIpCl9hZGRfZG9jKGl0ZXJsaXN0cywKICAgICAgICAgIlJldHVybiBhbiBpdGVyYXRvciBvdmVyIHRoZSAoa2V5LCBbdmFsdWVzXSkgcGFpcnMgb2YgYSBkaWN0aW9uYXJ5LiIpCgoKaWYgUFkzOgogICAgZGVmIGIocyk6CiAgICAgICAgcmV0dXJuIHMuZW5jb2RlKCJsYXRpbi0xIikKCiAgICBkZWYgdShzKToKICAgICAgICByZXR1cm4gcwogICAgdW5pY2hyID0gY2hyCiAgICBpbXBvcnQgc3RydWN0CiAgICBpbnQyYnl0ZSA9IHN0cnVjdC5TdHJ1Y3QoIj5CIikucGFjawogICAgZGVsIHN0cnVjdAogICAgYnl0ZTJpbnQgPSBvcGVyYXRvci5pdGVtZ2V0dGVyKDApCiAgICBpbmRleGJ5dGVzID0gb3BlcmF0b3IuZ2V0aXRlbQogICAgaXRlcmJ5dGVzID0gaXRlcgogICAgaW1wb3J0IGlvCiAgICBTdHJpbmdJTyA9IGlvLlN0cmluZ0lPCiAgICBCeXRlc0lPID0gaW8uQnl0ZXNJTwogICAgX2Fzc2VydENvdW50RXF1YWwgPSAiYXNzZXJ0Q291bnRFcXVhbCIKICAgIGlmIHN5cy52ZXJzaW9uX2luZm9bMV0gPD0gMToKICAgICAgICBfYXNzZXJ0UmFpc2VzUmVnZXggPSAiYXNzZXJ0UmFpc2VzUmVnZXhwIgogICAgICAgIF9hc3NlcnRSZWdleCA9ICJhc3NlcnRSZWdleHBNYXRjaGVzIgogICAgZWxzZToKICAgICAgICBfYXNzZXJ0UmFpc2VzUmVnZXggPSAiYXNzZXJ0UmFpc2VzUmVnZXgiCiAgICAgICAgX2Fzc2VydFJlZ2V4ID0gImFzc2VydFJlZ2V4IgplbHNlOgogICAgZGVmIGIocyk6CiAgICAgICAgcmV0dXJuIHMKICAgICMgV29ya2Fyb3VuZCBmb3Igc3RhbmRhbG9uZSBiYWNrc2xhc2gKCiAgICBkZWYgdShzKToKICAgICAgICByZXR1cm4gdW5pY29kZShzLnJlcGxhY2UocidcXCcsIHInXFxcXCcpLCAidW5pY29kZV9lc2NhcGUiKQogICAgdW5pY2hyID0gdW5pY2hyCiAgICBpbnQyYnl0ZSA9IGNocgoKICAgIGRlZiBieXRlMmludChicyk6CiAgICAgICAgcmV0dXJuIG9yZChic1swXSkKCiAgICBkZWYgaW5kZXhieXRlcyhidWYsIGkpOgogICAgICAgIHJldHVybiBvcmQoYnVmW2ldKQogICAgaXRlcmJ5dGVzID0gZnVuY3Rvb2xzLnBhcnRpYWwoaXRlcnRvb2xzLmltYXAsIG9yZCkKICAgIGltcG9ydCBTdHJpbmdJTwogICAgU3RyaW5nSU8gPSBCeXRlc0lPID0gU3RyaW5nSU8uU3RyaW5nSU8KICAgIF9hc3NlcnRDb3VudEVxdWFsID0gImFzc2VydEl0ZW1zRXF1YWwiCiAgICBfYXNzZXJ0UmFpc2VzUmVnZXggPSAiYXNzZXJ0UmFpc2VzUmVnZXhwIgogICAgX2Fzc2VydFJlZ2V4ID0gImFzc2VydFJlZ2V4cE1hdGNoZXMiCl9hZGRfZG9jKGIsICIiIkJ5dGUgbGl0ZXJhbCIiIikKX2FkZF9kb2ModSwgIiIiVGV4dCBsaXRlcmFsIiIiKQoKCmRlZiBhc3NlcnRDb3VudEVxdWFsKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICByZXR1cm4gZ2V0YXR0cihzZWxmLCBfYXNzZXJ0Q291bnRFcXVhbCkoKmFyZ3MsICoqa3dhcmdzKQoKCmRlZiBhc3NlcnRSYWlzZXNSZWdleChzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgcmV0dXJuIGdldGF0dHIoc2VsZiwgX2Fzc2VydFJhaXNlc1JlZ2V4KSgqYXJncywgKiprd2FyZ3MpCgoKZGVmIGFzc2VydFJlZ2V4KHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICByZXR1cm4gZ2V0YXR0cihzZWxmLCBfYXNzZXJ0UmVnZXgpKCphcmdzLCAqKmt3YXJncykKCgppZiBQWTM6CiAgICBleGVjXyA9IGdldGF0dHIobW92ZXMuYnVpbHRpbnMsICJleGVjIikKCiAgICBkZWYgcmVyYWlzZSh0cCwgdmFsdWUsIHRiPU5vbmUpOgogICAgICAgIGlmIHZhbHVlIGlzIE5vbmU6CiAgICAgICAgICAgIHZhbHVlID0gdHAoKQogICAgICAgIGlmIHZhbHVlLl9fdHJhY2ViYWNrX18gaXMgbm90IHRiOgogICAgICAgICAgICByYWlzZSB2YWx1ZS53aXRoX3RyYWNlYmFjayh0YikKICAgICAgICByYWlzZSB2YWx1ZQoKZWxzZToKICAgIGRlZiBleGVjXyhfY29kZV8sIF9nbG9ic189Tm9uZSwgX2xvY3NfPU5vbmUpOgogICAgICAgICIiIkV4ZWN1dGUgY29kZSBpbiBhIG5hbWVzcGFjZS4iIiIKICAgICAgICBpZiBfZ2xvYnNfIGlzIE5vbmU6CiAgICAgICAgICAgIGZyYW1lID0gc3lzLl9nZXRmcmFtZSgxKQogICAgICAgICAgICBfZ2xvYnNfID0gZnJhbWUuZl9nbG9iYWxzCiAgICAgICAgICAgIGlmIF9sb2NzXyBpcyBOb25lOgogICAgICAgICAgICAgICAgX2xvY3NfID0gZnJhbWUuZl9sb2NhbHMKICAgICAgICAgICAgZGVsIGZyYW1lCiAgICAgICAgZWxpZiBfbG9jc18gaXMgTm9uZToKICAgICAgICAgICAgX2xvY3NfID0gX2dsb2JzXwogICAgICAgIGV4ZWMoIiIiZXhlYyBfY29kZV8gaW4gX2dsb2JzXywgX2xvY3NfIiIiKQoKICAgIGV4ZWNfKCIiImRlZiByZXJhaXNlKHRwLCB2YWx1ZSwgdGI9Tm9uZSk6CiAgICByYWlzZSB0cCwgdmFsdWUsIHRiCiIiIikKCgppZiBzeXMudmVyc2lvbl9pbmZvWzoyXSA9PSAoMywgMik6CiAgICBleGVjXygiIiJkZWYgcmFpc2VfZnJvbSh2YWx1ZSwgZnJvbV92YWx1ZSk6CiAgICBpZiBmcm9tX3ZhbHVlIGlzIE5vbmU6CiAgICAgICAgcmFpc2UgdmFsdWUKICAgIHJhaXNlIHZhbHVlIGZyb20gZnJvbV92YWx1ZQoiIiIpCmVsaWYgc3lzLnZlcnNpb25faW5mb1s6Ml0gPiAoMywgMik6CiAgICBleGVjXygiIiJkZWYgcmFpc2VfZnJvbSh2YWx1ZSwgZnJvbV92YWx1ZSk6CiAgICByYWlzZSB2YWx1ZSBmcm9tIGZyb21fdmFsdWUKIiIiKQplbHNlOgogICAgZGVmIHJhaXNlX2Zyb20odmFsdWUsIGZyb21fdmFsdWUpOgogICAgICAgIHJhaXNlIHZhbHVlCgoKcHJpbnRfID0gZ2V0YXR0cihtb3Zlcy5idWlsdGlucywgInByaW50IiwgTm9uZSkKaWYgcHJpbnRfIGlzIE5vbmU6CiAgICBkZWYgcHJpbnRfKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgIiIiVGhlIG5ldy1zdHlsZSBwcmludCBmdW5jdGlvbiBmb3IgUHl0aG9uIDIuNCBhbmQgMi41LiIiIgogICAgICAgIGZwID0ga3dhcmdzLnBvcCgiZmlsZSIsIHN5cy5zdGRvdXQpCiAgICAgICAgaWYgZnAgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGRlZiB3cml0ZShkYXRhKToKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoZGF0YSwgYmFzZXN0cmluZyk6CiAgICAgICAgICAgICAgICBkYXRhID0gc3RyKGRhdGEpCiAgICAgICAgICAgICMgSWYgdGhlIGZpbGUgaGFzIGFuIGVuY29kaW5nLCBlbmNvZGUgdW5pY29kZSB3aXRoIGl0LgogICAgICAgICAgICBpZiAoaXNpbnN0YW5jZShmcCwgZmlsZSkgYW5kCiAgICAgICAgICAgICAgICAgICAgaXNpbnN0YW5jZShkYXRhLCB1bmljb2RlKSBhbmQKICAgICAgICAgICAgICAgICAgICBmcC5lbmNvZGluZyBpcyBub3QgTm9uZSk6CiAgICAgICAgICAgICAgICBlcnJvcnMgPSBnZXRhdHRyKGZwLCAiZXJyb3JzIiwgTm9uZSkKICAgICAgICAgICAgICAgIGlmIGVycm9ycyBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIGVycm9ycyA9ICJzdHJpY3QiCiAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5lbmNvZGUoZnAuZW5jb2RpbmcsIGVycm9ycykKICAgICAgICAgICAgZnAud3JpdGUoZGF0YSkKICAgICAgICB3YW50X3VuaWNvZGUgPSBGYWxzZQogICAgICAgIHNlcCA9IGt3YXJncy5wb3AoInNlcCIsIE5vbmUpCiAgICAgICAgaWYgc2VwIGlzIG5vdCBOb25lOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHNlcCwgdW5pY29kZSk6CiAgICAgICAgICAgICAgICB3YW50X3VuaWNvZGUgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2Uoc2VwLCBzdHIpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJzZXAgbXVzdCBiZSBOb25lIG9yIGEgc3RyaW5nIikKICAgICAgICBlbmQgPSBrd2FyZ3MucG9wKCJlbmQiLCBOb25lKQogICAgICAgIGlmIGVuZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShlbmQsIHVuaWNvZGUpOgogICAgICAgICAgICAgICAgd2FudF91bmljb2RlID0gVHJ1ZQogICAgICAgICAgICBlbGlmIG5vdCBpc2luc3RhbmNlKGVuZCwgc3RyKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiZW5kIG11c3QgYmUgTm9uZSBvciBhIHN0cmluZyIpCiAgICAgICAgaWYga3dhcmdzOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoImludmFsaWQga2V5d29yZCBhcmd1bWVudHMgdG8gcHJpbnQoKSIpCiAgICAgICAgaWYgbm90IHdhbnRfdW5pY29kZToKICAgICAgICAgICAgZm9yIGFyZyBpbiBhcmdzOgogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShhcmcsIHVuaWNvZGUpOgogICAgICAgICAgICAgICAgICAgIHdhbnRfdW5pY29kZSA9IFRydWUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGlmIHdhbnRfdW5pY29kZToKICAgICAgICAgICAgbmV3bGluZSA9IHVuaWNvZGUoIlxuIikKICAgICAgICAgICAgc3BhY2UgPSB1bmljb2RlKCIgIikKICAgICAgICBlbHNlOgogICAgICAgICAgICBuZXdsaW5lID0gIlxuIgogICAgICAgICAgICBzcGFjZSA9ICIgIgogICAgICAgIGlmIHNlcCBpcyBOb25lOgogICAgICAgICAgICBzZXAgPSBzcGFjZQogICAgICAgIGlmIGVuZCBpcyBOb25lOgogICAgICAgICAgICBlbmQgPSBuZXdsaW5lCiAgICAgICAgZm9yIGksIGFyZyBpbiBlbnVtZXJhdGUoYXJncyk6CiAgICAgICAgICAgIGlmIGk6CiAgICAgICAgICAgICAgICB3cml0ZShzZXApCiAgICAgICAgICAgIHdyaXRlKGFyZykKICAgICAgICB3cml0ZShlbmQpCmlmIHN5cy52ZXJzaW9uX2luZm9bOjJdIDwgKDMsIDMpOgogICAgX3ByaW50ID0gcHJpbnRfCgogICAgZGVmIHByaW50XygqYXJncywgKiprd2FyZ3MpOgogICAgICAgIGZwID0ga3dhcmdzLmdldCgiZmlsZSIsIHN5cy5zdGRvdXQpCiAgICAgICAgZmx1c2ggPSBrd2FyZ3MucG9wKCJmbHVzaCIsIEZhbHNlKQogICAgICAgIF9wcmludCgqYXJncywgKiprd2FyZ3MpCiAgICAgICAgaWYgZmx1c2ggYW5kIGZwIGlzIG5vdCBOb25lOgogICAgICAgICAgICBmcC5mbHVzaCgpCgpfYWRkX2RvYyhyZXJhaXNlLCAiIiJSZXJhaXNlIGFuIGV4Y2VwdGlvbi4iIiIpCgppZiBzeXMudmVyc2lvbl9pbmZvWzA6Ml0gPCAoMywgNCk6CiAgICBkZWYgd3JhcHMod3JhcHBlZCwgYXNzaWduZWQ9ZnVuY3Rvb2xzLldSQVBQRVJfQVNTSUdOTUVOVFMsCiAgICAgICAgICAgICAgdXBkYXRlZD1mdW5jdG9vbHMuV1JBUFBFUl9VUERBVEVTKToKICAgICAgICBkZWYgd3JhcHBlcihmKToKICAgICAgICAgICAgZiA9IGZ1bmN0b29scy53cmFwcyh3cmFwcGVkLCBhc3NpZ25lZCwgdXBkYXRlZCkoZikKICAgICAgICAgICAgZi5fX3dyYXBwZWRfXyA9IHdyYXBwZWQKICAgICAgICAgICAgcmV0dXJuIGYKICAgICAgICByZXR1cm4gd3JhcHBlcgplbHNlOgogICAgd3JhcHMgPSBmdW5jdG9vbHMud3JhcHMKCgpkZWYgd2l0aF9tZXRhY2xhc3MobWV0YSwgKmJhc2VzKToKICAgICIiIkNyZWF0ZSBhIGJhc2UgY2xhc3Mgd2l0aCBhIG1ldGFjbGFzcy4iIiIKICAgICMgVGhpcyByZXF1aXJlcyBhIGJpdCBvZiBleHBsYW5hdGlvbjogdGhlIGJhc2ljIGlkZWEgaXMgdG8gbWFrZSBhIGR1bW15CiAgICAjIG1ldGFjbGFzcyBmb3Igb25lIGxldmVsIG9mIGNsYXNzIGluc3RhbnRpYXRpb24gdGhhdCByZXBsYWNlcyBpdHNlbGYgd2l0aAogICAgIyB0aGUgYWN0dWFsIG1ldGFjbGFzcy4KICAgIGNsYXNzIG1ldGFjbGFzcyhtZXRhKToKCiAgICAgICAgZGVmIF9fbmV3X18oY2xzLCBuYW1lLCB0aGlzX2Jhc2VzLCBkKToKICAgICAgICAgICAgcmV0dXJuIG1ldGEobmFtZSwgYmFzZXMsIGQpCiAgICByZXR1cm4gdHlwZS5fX25ld19fKG1ldGFjbGFzcywgJ3RlbXBvcmFyeV9jbGFzcycsICgpLCB7fSkKCgpkZWYgYWRkX21ldGFjbGFzcyhtZXRhY2xhc3MpOgogICAgIiIiQ2xhc3MgZGVjb3JhdG9yIGZvciBjcmVhdGluZyBhIGNsYXNzIHdpdGggYSBtZXRhY2xhc3MuIiIiCiAgICBkZWYgd3JhcHBlcihjbHMpOgogICAgICAgIG9yaWdfdmFycyA9IGNscy5fX2RpY3RfXy5jb3B5KCkKICAgICAgICBzbG90cyA9IG9yaWdfdmFycy5nZXQoJ19fc2xvdHNfXycpCiAgICAgICAgaWYgc2xvdHMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc2xvdHMsIHN0cik6CiAgICAgICAgICAgICAgICBzbG90cyA9IFtzbG90c10KICAgICAgICAgICAgZm9yIHNsb3RzX3ZhciBpbiBzbG90czoKICAgICAgICAgICAgICAgIG9yaWdfdmFycy5wb3Aoc2xvdHNfdmFyKQogICAgICAgIG9yaWdfdmFycy5wb3AoJ19fZGljdF9fJywgTm9uZSkKICAgICAgICBvcmlnX3ZhcnMucG9wKCdfX3dlYWtyZWZfXycsIE5vbmUpCiAgICAgICAgcmV0dXJuIG1ldGFjbGFzcyhjbHMuX19uYW1lX18sIGNscy5fX2Jhc2VzX18sIG9yaWdfdmFycykKICAgIHJldHVybiB3cmFwcGVyCgoKZGVmIHB5dGhvbl8yX3VuaWNvZGVfY29tcGF0aWJsZShrbGFzcyk6CiAgICAiIiIKICAgIEEgZGVjb3JhdG9yIHRoYXQgZGVmaW5lcyBfX3VuaWNvZGVfXyBhbmQgX19zdHJfXyBtZXRob2RzIHVuZGVyIFB5dGhvbiAyLgogICAgVW5kZXIgUHl0aG9uIDMgaXQgZG9lcyBub3RoaW5nLgoKICAgIFRvIHN1cHBvcnQgUHl0aG9uIDIgYW5kIDMgd2l0aCBhIHNpbmdsZSBjb2RlIGJhc2UsIGRlZmluZSBhIF9fc3RyX18gbWV0aG9kCiAgICByZXR1cm5pbmcgdGV4dCBhbmQgYXBwbHkgdGhpcyBkZWNvcmF0b3IgdG8gdGhlIGNsYXNzLgogICAgIiIiCiAgICBpZiBQWTI6CiAgICAgICAgaWYgJ19fc3RyX18nIG5vdCBpbiBrbGFzcy5fX2RpY3RfXzoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiQHB5dGhvbl8yX3VuaWNvZGVfY29tcGF0aWJsZSBjYW5ub3QgYmUgYXBwbGllZCAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRvICVzIGJlY2F1c2UgaXQgZG9lc24ndCBkZWZpbmUgX19zdHJfXygpLiIgJQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtsYXNzLl9fbmFtZV9fKQogICAgICAgIGtsYXNzLl9fdW5pY29kZV9fID0ga2xhc3MuX19zdHJfXwogICAgICAgIGtsYXNzLl9fc3RyX18gPSBsYW1iZGEgc2VsZjogc2VsZi5fX3VuaWNvZGVfXygpLmVuY29kZSgndXRmLTgnKQogICAgcmV0dXJuIGtsYXNzCgoKIyBDb21wbGV0ZSB0aGUgbW92ZXMgaW1wbGVtZW50YXRpb24uCiMgVGhpcyBjb2RlIGlzIGF0IHRoZSBlbmQgb2YgdGhpcyBtb2R1bGUgdG8gc3BlZWQgdXAgbW9kdWxlIGxvYWRpbmcuCiMgVHVybiB0aGlzIG1vZHVsZSBpbnRvIGEgcGFja2FnZS4KX19wYXRoX18gPSBbXSAgIyByZXF1aXJlZCBmb3IgUEVQIDMwMiBhbmQgUEVQIDQ1MQpfX3BhY2thZ2VfXyA9IF9fbmFtZV9fICAjIHNlZSBQRVAgMzY2IEBSZXNlcnZlZEFzc2lnbm1lbnQKaWYgZ2xvYmFscygpLmdldCgiX19zcGVjX18iKSBpcyBub3QgTm9uZToKICAgIF9fc3BlY19fLnN1Ym1vZHVsZV9zZWFyY2hfbG9jYXRpb25zID0gW10gICMgUEVQIDQ1MSBAVW5kZWZpbmVkVmFyaWFibGUKIyBSZW1vdmUgb3RoZXIgc2l4IG1ldGEgcGF0aCBpbXBvcnRlcnMsIHNpbmNlIHRoZXkgY2F1c2UgcHJvYmxlbXMuIFRoaXMgY2FuCiMgaGFwcGVuIGlmIHNpeCBpcyByZW1vdmVkIGZyb20gc3lzLm1vZHVsZXMgYW5kIHRoZW4gcmVsb2FkZWQuIChTZXR1cHRvb2xzIGRvZXMKIyB0aGlzIGZvciBzb21lIHJlYXNvbi4pCmlmIHN5cy5tZXRhX3BhdGg6CiAgICBmb3IgaSwgaW1wb3J0ZXIgaW4gZW51bWVyYXRlKHN5cy5tZXRhX3BhdGgpOgogICAgICAgICMgSGVyZSdzIHNvbWUgcmVhbCBuYXN0aW5lc3M6IEFub3RoZXIgImluc3RhbmNlIiBvZiB0aGUgc2l4IG1vZHVsZSBtaWdodAogICAgICAgICMgYmUgZmxvYXRpbmcgYXJvdW5kLiBUaGVyZWZvcmUsIHdlIGNhbid0IHVzZSBpc2luc3RhbmNlKCkgdG8gY2hlY2sgZm9yCiAgICAgICAgIyB0aGUgc2l4IG1ldGEgcGF0aCBpbXBvcnRlciwgc2luY2UgdGhlIG90aGVyIHNpeCBpbnN0YW5jZSB3aWxsIGhhdmUKICAgICAgICAjIGluc2VydGVkIGFuIGltcG9ydGVyIHdpdGggZGlmZmVyZW50IGNsYXNzLgogICAgICAgIGlmICh0eXBlKGltcG9ydGVyKS5fX25hbWVfXyA9PSAiX1NpeE1ldGFQYXRoSW1wb3J0ZXIiIGFuZAogICAgICAgICAgICAgICAgaW1wb3J0ZXIubmFtZSA9PSBfX25hbWVfXyk6CiAgICAgICAgICAgIGRlbCBzeXMubWV0YV9wYXRoW2ldCiAgICAgICAgICAgIGJyZWFrCiAgICBkZWwgaSwgaW1wb3J0ZXIKIyBGaW5hbGx5LCBhZGQgdGhlIGltcG9ydGVyIHRvIHRoZSBtZXRhIHBhdGggaW1wb3J0IGhvb2suCnN5cy5tZXRhX3BhdGguYXBwZW5kKF9pbXBvcnRlcikKUEsBAhQDFAAAAAAA97srS4+n8VJ3AAAAdwAAABMAAAAAAAAAAAAAAIABAAAAAGFuc2libGUvX19pbml0X18ucHlQSwECFAMUAAAAAAD3uytLncXxa0gAAABIAAAAIAAAAAAAAAAAAAAAgAGoAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX19pbml0X18ucHlQSwECFAMUAAAAAAD3uytLrPY2nzslAQA7JQEAGAAAAAAAAAAAAAAAgAEuAQAAYW5zaWJsZV9tb2R1bGVfZG9ja2VyLnB5UEsBAhQDFAAAAAAA97srSzvfOZUwigEAMIoBAB0AAAAAAAAAAAAAAIABnyYBAGFuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5UEsBAhQDFAAAAAAA97srS7XYBAYlMAAAJTAAAB0AAAAAAAAAAAAAAIABCrECAGFuc2libGUvbW9kdWxlX3V0aWxzL190ZXh0LnB5UEsBAhQDFAAAAAAA97srSyXctH4TEAAAExAAACIAAAAAAAAAAAAAAIABauECAGFuc2libGUvbW9kdWxlX3V0aWxzL3B5Y29tcGF0MjQucHlQSwECFAMUAAAAAAD3uytLGBdy9QERAAABEQAAJAAAAAAAAAAAAAAAgAG98QIAYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19faW5pdF9fLnB5UEsBAhQDFAAAAAAA97srSzjix9GRdQAAkXUAACAAAAAAAAAAAAAAAIABAAMDAGFuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fc2l4LnB5UEsFBgAAAAAIAAgAWwIAAM94AwAAAA=="""
def invoke_module(module, modlib_path, json_params):
    pythonpath = os.environ.get('PYTHONPATH')
    if pythonpath:
        os.environ['PYTHONPATH'] = ':'.join((modlib_path, pythonpath))
    else:
        os.environ['PYTHONPATH'] = modlib_path
    p = subprocess.Popen(['/usr/bin/python', module], env=os.environ, shell=False, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
    (stdout, stderr) = p.communicate(json_params)
    if not isinstance(stderr, (bytes, unicode)):
        stderr = stderr.read()
    if not isinstance(stdout, (bytes, unicode)):
        stdout = stdout.read()
    if PY3:
        sys.stderr.buffer.write(stderr)
        sys.stdout.buffer.write(stdout)
    else:
        sys.stderr.write(stderr)
        sys.stdout.write(stdout)
    return p.returncode
def debug(command, zipped_mod, json_params):
    basedir = os.path.join(os.path.abspath(os.path.dirname(__file__)), 'debug_dir')
    args_path = os.path.join(basedir, 'args')
    script_path = os.path.join(basedir, 'ansible_module_docker.py')
    if command == 'explode':
        z = zipfile.ZipFile(zipped_mod)
        for filename in z.namelist():
            if filename.startswith('/'):
                raise Exception('Something wrong with this module zip file: should not contain absolute paths')
            dest_filename = os.path.join(basedir, filename)
            if dest_filename.endswith(os.path.sep) and not os.path.exists(dest_filename):
                os.makedirs(dest_filename)
            else:
                directory = os.path.dirname(dest_filename)
                if not os.path.exists(directory):
                    os.makedirs(directory)
                f = open(dest_filename, 'wb')
                f.write(z.read(filename))
                f.close()
        f = open(args_path, 'wb')
        f.write(json_params)
        f.close()
        print('Module expanded into:')
        print('%s' % basedir)
        exitcode = 0
    elif command == 'execute':
        pythonpath = os.environ.get('PYTHONPATH')
        if pythonpath:
            os.environ['PYTHONPATH'] = ':'.join((basedir, pythonpath))
        else:
            os.environ['PYTHONPATH'] = basedir
        p = subprocess.Popen(['/usr/bin/python', script_path, args_path],
                env=os.environ, shell=False, stdout=subprocess.PIPE,
                stderr=subprocess.PIPE, stdin=subprocess.PIPE)
        (stdout, stderr) = p.communicate()
        if not isinstance(stderr, (bytes, unicode)):
            stderr = stderr.read()
        if not isinstance(stdout, (bytes, unicode)):
            stdout = stdout.read()
        if PY3:
            sys.stderr.buffer.write(stderr)
            sys.stdout.buffer.write(stdout)
        else:
            sys.stderr.write(stderr)
            sys.stdout.write(stdout)
        return p.returncode
    elif command == 'excommunicate':
        sys.argv = ['docker', args_path]
        sys.path.insert(0, basedir)
        from ansible_module_docker import main
        main()
        print('WARNING: Module returned to wrapper instead of exiting')
        sys.exit(1)
    else:
        print('WARNING: Unknown debug command.  Doing nothing.')
        exitcode = 0
    return exitcode
if __name__ == '__main__':
    ANSIBALLZ_PARAMS = json.dumps({"ANSIBLE_MODULE_ARGS": json.load(sys.stdin)})
    if PY3:
        ANSIBALLZ_PARAMS = ANSIBALLZ_PARAMS.encode('utf-8')
    try:
        temp_path = tempfile.mkdtemp(prefix='ansible_')
        zipped_mod = os.path.join(temp_path, 'ansible_modlib.zip')
        modlib = open(zipped_mod, 'wb')
        modlib.write(base64.b64decode(ZIPDATA))
        modlib.close()
        if len(sys.argv) == 2:
            exitcode = debug(sys.argv[1], zipped_mod, ANSIBALLZ_PARAMS)
        else:
            z = zipfile.ZipFile(zipped_mod, mode='r')
            module = os.path.join(temp_path, 'ansible_module_docker.py')
            f = open(module, 'wb')
            f.write(z.read('ansible_module_docker.py'))
            f.close()
            z = zipfile.ZipFile(zipped_mod, mode='a')
            sitecustomize = u'import sys\nsys.path.insert(0,"%s")\n' %  zipped_mod
            sitecustomize = sitecustomize.encode('utf-8')
            zinfo = zipfile.ZipInfo()
            zinfo.filename = 'sitecustomize.py'
            zinfo.date_time = ( 2017, 9, 11, 23, 31, 46)
            z.writestr(zinfo, sitecustomize)
            z.close()
            exitcode = invoke_module(module, zipped_mod, ANSIBALLZ_PARAMS)
    finally:
        try:
            shutil.rmtree(temp_path)
        except OSError:
            pass
    sys.exit(exitcode)