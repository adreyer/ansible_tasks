#!/usr/bin/python
# -*- coding: utf-8 -*-
ANSIBALLZ_WRAPPER = True # For test-module script to tell this is a ANSIBALLZ_WRAPPER
import os
import os.path
import sys
import __main__
scriptdir = None
try:
    scriptdir = os.path.dirname(os.path.abspath(__main__.__file__))
except (AttributeError, OSError):
    pass
if scriptdir is not None:
    sys.path = [p for p in sys.path if p != scriptdir]
import base64
import json
import shutil
import zipfile
import tempfile
import subprocess
if sys.version_info < (3,):
    bytes = str
    PY3 = False
else:
    unicode = str
    PY3 = True
try:
    from io import BytesIO as IOStream
except ImportError:
    from StringIO import StringIO as IOStream
ZIPDATA = """UEsDBBQAAAAAAMy7K0uPp/FSdwAAAHcAAAATAAAAYW5zaWJsZS9fX2luaXRfXy5weWZyb20gcGtndXRpbCBpbXBvcnQgZXh0ZW5kX3BhdGgKX19wYXRoX189ZXh0ZW5kX3BhdGgoX19wYXRoX18sX19uYW1lX18pCl9fdmVyc2lvbl9fPSIyLjQuMCIKX19hdXRob3JfXz0iQW5zaWJsZSwgSW5jLiIKUEsDBBQAAAAAAMy7K0udxfFrSAAAAEgAAAAgAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX19pbml0X18ucHlmcm9tIHBrZ3V0aWwgaW1wb3J0IGV4dGVuZF9wYXRoCl9fcGF0aF9fPWV4dGVuZF9wYXRoKF9fcGF0aF9fLF9fbmFtZV9fKQpQSwMEFAAAAAAAzLsrS2+WWQpaLQAAWi0AACkAAABhbnNpYmxlX21vZHVsZV9uZXRhcHBfZV9zdG9yYWdlX3N5c3RlbS5weSMhL3Vzci9iaW4vcHl0aG9uCgojIChjKSAyMDE2LCBOZXRBcHAsIEluYwojCiMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgojCkFOU0lCTEVfTUVUQURBVEEgPSB7J21ldGFkYXRhX3ZlcnNpb24nOiAnMS4wJywKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJzogWydwcmV2aWV3J10sCiAgICAgICAgICAgICAgICAgICAgJ3N1cHBvcnRlZF9ieSc6ICdjb21tdW5pdHknfQoKCkRPQ1VNRU5UQVRJT04gPSAnJycKbW9kdWxlOiBuZXRhcHBfZV9zdG9yYWdlX3N5c3RlbQp2ZXJzaW9uX2FkZGVkOiAiMi4yIgpzaG9ydF9kZXNjcmlwdGlvbjogQWRkL3JlbW92ZSBhcnJheXMgZnJvbSB0aGUgV2ViIFNlcnZpY2VzIFByb3h5CmRlc2NyaXB0aW9uOgotIE1hbmFnZSB0aGUgYXJyYXlzIGFjY2Vzc2libGUgdmlhIGEgTmV0QXBwIFdlYiBTZXJ2aWNlcyBQcm94eSBmb3IgTmV0QXBwIEUtc2VyaWVzIHN0b3JhZ2UgYXJyYXlzLgpvcHRpb25zOgogIGFwaV91c2VybmFtZToKICAgIHJlcXVpcmVkOiB0cnVlCiAgICBkZXNjcmlwdGlvbjoKICAgIC0gVGhlIHVzZXJuYW1lIHRvIGF1dGhlbnRpY2F0ZSB3aXRoIHRoZSBTQU50cmljaXR5IFdlYlNlcnZpY2VzIFByb3h5IG9yIGVtYmVkZGVkIFJFU1QgQVBJLgogIGFwaV9wYXNzd29yZDoKICAgIHJlcXVpcmVkOiB0cnVlCiAgICBkZXNjcmlwdGlvbjoKICAgIC0gVGhlIHBhc3N3b3JkIHRvIGF1dGhlbnRpY2F0ZSB3aXRoIHRoZSBTQU50cmljaXR5IFdlYlNlcnZpY2VzIFByb3h5IG9yIGVtYmVkZGVkIFJFU1QgQVBJLgogIGFwaV91cmw6CiAgICByZXF1aXJlZDogdHJ1ZQogICAgZGVzY3JpcHRpb246CiAgICAtIFRoZSB1cmwgdG8gdGhlIFNBTnRyaWNpdHkgV2ViU2VydmljZXMgUHJveHkgb3IgZW1iZWRkZWQgUkVTVCBBUEkuCiAgdmFsaWRhdGVfY2VydHM6CiAgICByZXF1aXJlZDogZmFsc2UKICAgIGRlZmF1bHQ6IHRydWUKICAgIGRlc2NyaXB0aW9uOgogICAgLSBTaG91bGQgaHR0cHMgY2VydGlmaWNhdGVzIGJlIHZhbGlkYXRlZD8KICBzc2lkOgogICAgcmVxdWlyZWQ6IHRydWUKICAgIGRlc2NyaXB0aW9uOgogICAgLSBUaGUgSUQgb2YgdGhlIGFycmF5IHRvIG1hbmFnZS4gVGhpcyB2YWx1ZSBtdXN0IGJlIHVuaXF1ZSBmb3IgZWFjaCBhcnJheS4KICBzdGF0ZToKICAgIHJlcXVpcmVkOiB0cnVlCiAgICBkZXNjcmlwdGlvbjoKICAgIC0gV2hldGhlciB0aGUgc3BlY2lmaWVkIGFycmF5IHNob3VsZCBiZSBjb25maWd1cmVkIG9uIHRoZSBXZWIgU2VydmljZXMgUHJveHkgb3Igbm90LgogICAgY2hvaWNlczogWydwcmVzZW50JywgJ2Fic2VudCddCiAgY29udHJvbGxlcl9hZGRyZXNzZXM6CiAgICByZXF1aXJlZDogdHJ1ZQogICAgZGVzY3JpcHRpb246CiAgICAtIFRoZSBsaXN0IGFkZHJlc3NlcyBmb3IgdGhlIG91dC1vZi1iYW5kIG1hbmFnZW1lbnQgYWRhcHRlciBvciB0aGUgYWdlbnQgaG9zdC4gTXV0dWFsbHkgZXhjbHVzaXZlIG9mIGFycmF5X3d3biBwYXJhbWV0ZXIuCiAgYXJyYXlfd3duOgogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICBkZXNjcmlwdGlvbjoKICAgIC0gVGhlIFdXTiBvZiB0aGUgYXJyYXkgdG8gbWFuYWdlLiBPbmx5IG5lY2Vzc2FyeSBpZiBpbi1iYW5kIG1hbmFnaW5nIG11bHRpcGxlIGFycmF5cyBvbiB0aGUgc2FtZSBhZ2VudCBob3N0LiAgTXV0dWFsbHkgZXhjbHVzaXZlIG9mCiAgICAgIGNvbnRyb2xsZXJfYWRkcmVzc2VzIHBhcmFtZXRlci4KICBhcnJheV9wYXNzd29yZDoKICAgIHJlcXVpcmVkOiBmYWxzZQogICAgZGVzY3JpcHRpb246CiAgICAtIFRoZSBtYW5hZ2VtZW50IHBhc3N3b3JkIG9mIHRoZSBhcnJheSB0byBtYW5hZ2UsIGlmIHNldC4KICBlbmFibGVfdHJhY2U6CiAgICByZXF1aXJlZDogZmFsc2UKICAgIGRlZmF1bHQ6IGZhbHNlCiAgICBkZXNjcmlwdGlvbjoKICAgIC0gRW5hYmxlIHRyYWNlIGxvZ2dpbmcgZm9yIFNZTWJvbCBjYWxscyB0byB0aGUgc3RvcmFnZSBzeXN0ZW0uCiAgbWV0YV90YWdzOgogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICBkZWZhdWx0OiBOb25lCiAgICBkZXNjcmlwdGlvbjoKICAgIC0gT3B0aW9uYWwgbWV0YSB0YWdzIHRvIGFzc29jaWF0ZSB0byB0aGlzIHN0b3JhZ2Ugc3lzdGVtCmF1dGhvcjogS2V2aW4gSHVscXVlc3QgKEBodWxxdWVzdCkKJycnCgpFWEFNUExFUyA9ICcnJwotLS0KICAgIC0gbmFtZTogIFByZXNlbmNlIG9mIHN0b3JhZ2Ugc3lzdGVtCiAgICAgIG5ldGFwcF9lX3N0b3JhZ2Vfc3lzdGVtOgogICAgICAgIHNzaWQ6ICJ7eyBpdGVtLmtleSB9fSIKICAgICAgICBzdGF0ZTogcHJlc2VudAogICAgICAgIGFwaV91cmw6ICJ7eyBuZXRhcHBfYXBpX3VybCB9fSIKICAgICAgICBhcGlfdXNlcm5hbWU6ICJ7eyBuZXRhcHBfYXBpX3VzZXJuYW1lIH19IgogICAgICAgIGFwaV9wYXNzd29yZDogInt7IG5ldGFwcF9hcGlfcGFzc3dvcmQgfX0iCiAgICAgICAgdmFsaWRhdGVfY2VydHM6ICJ7eyBuZXRhcHBfYXBpX3ZhbGlkYXRlX2NlcnRzIH19IgogICAgICAgIGNvbnRyb2xsZXJfYWRkcmVzc2VzOgogICAgICAgICAgLSAie3sgaXRlbS52YWx1ZS5hZGRyZXNzMSB9fSIKICAgICAgICAgIC0gInt7IGl0ZW0udmFsdWUuYWRkcmVzczIgfX0iCiAgICAgIHdpdGhfZGljdDogInt7IHN0b3JhZ2Vfc3lzdGVtcyB9fSIKICAgICAgd2hlbjogY2hlY2tfc3RvcmFnZV9zeXN0ZW0KJycnCgpSRVRVUk4gPSAnJycKbXNnOgogICAgZGVzY3JpcHRpb246IFN0YXRlIG9mIHJlcXVlc3QKICAgIHR5cGU6IHN0cmluZwogICAgcmV0dXJuZWQ6IGFsd2F5cwogICAgc2FtcGxlOiAnU3RvcmFnZSBzeXN0ZW0gcmVtb3ZlZC4nCicnJwppbXBvcnQganNvbgpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSBhcyBkdCwgdGltZWRlbHRhCmZyb20gdGltZSBpbXBvcnQgc2xlZXAKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuYXBpIGltcG9ydCBiYXNpY19hdXRoX2FyZ3VtZW50X3NwZWMKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5iYXNpYyBpbXBvcnQgQW5zaWJsZU1vZHVsZQpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnB5Y29tcGF0MjQgaW1wb3J0IGdldF9leGNlcHRpb24KZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy51cmxzIGltcG9ydCBvcGVuX3VybApmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5tb3Zlcy51cmxsaWIuZXJyb3IgaW1wb3J0IEhUVFBFcnJvcgoKCmRlZiByZXF1ZXN0KHVybCwgZGF0YT1Ob25lLCBoZWFkZXJzPU5vbmUsIG1ldGhvZD0nR0VUJywgdXNlX3Byb3h5PVRydWUsCiAgICAgICAgICAgIGZvcmNlPUZhbHNlLCBsYXN0X21vZF90aW1lPU5vbmUsIHRpbWVvdXQ9MTAsIHZhbGlkYXRlX2NlcnRzPVRydWUsCiAgICAgICAgICAgIHVybF91c2VybmFtZT1Ob25lLCB1cmxfcGFzc3dvcmQ9Tm9uZSwgaHR0cF9hZ2VudD1Ob25lLCBmb3JjZV9iYXNpY19hdXRoPVRydWUsIGlnbm9yZV9lcnJvcnM9RmFsc2UpOgogICAgdHJ5OgogICAgICAgIHIgPSBvcGVuX3VybCh1cmw9dXJsLCBkYXRhPWRhdGEsIGhlYWRlcnM9aGVhZGVycywgbWV0aG9kPW1ldGhvZCwgdXNlX3Byb3h5PXVzZV9wcm94eSwKICAgICAgICAgICAgICAgICAgICAgZm9yY2U9Zm9yY2UsIGxhc3RfbW9kX3RpbWU9bGFzdF9tb2RfdGltZSwgdGltZW91dD10aW1lb3V0LCB2YWxpZGF0ZV9jZXJ0cz12YWxpZGF0ZV9jZXJ0cywKICAgICAgICAgICAgICAgICAgICAgdXJsX3VzZXJuYW1lPXVybF91c2VybmFtZSwgdXJsX3Bhc3N3b3JkPXVybF9wYXNzd29yZCwgaHR0cF9hZ2VudD1odHRwX2FnZW50LAogICAgICAgICAgICAgICAgICAgICBmb3JjZV9iYXNpY19hdXRoPWZvcmNlX2Jhc2ljX2F1dGgpCiAgICBleGNlcHQgSFRUUEVycm9yOgogICAgICAgIGVyciA9IGdldF9leGNlcHRpb24oKQogICAgICAgIHIgPSBlcnIuZnAKCiAgICB0cnk6CiAgICAgICAgcmF3X2RhdGEgPSByLnJlYWQoKQogICAgICAgIGlmIHJhd19kYXRhOgogICAgICAgICAgICBkYXRhID0ganNvbi5sb2FkcyhyYXdfZGF0YSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByYXdfZGF0YSA9IE5vbmUKICAgIGV4Y2VwdDoKICAgICAgICBpZiBpZ25vcmVfZXJyb3JzOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKHJhd19kYXRhKQoKICAgIHJlc3BfY29kZSA9IHIuZ2V0Y29kZSgpCgogICAgaWYgcmVzcF9jb2RlID49IDQwMCBhbmQgbm90IGlnbm9yZV9lcnJvcnM6CiAgICAgICAgcmFpc2UgRXhjZXB0aW9uKHJlc3BfY29kZSwgZGF0YSkKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIHJlc3BfY29kZSwgZGF0YQoKCmRlZiBkb19wb3N0KHNzaWQsIGFwaV91cmwsIHBvc3RfaGVhZGVycywgYXBpX3VzciwgYXBpX3B3ZCwgdmFsaWRhdGVfY2VydHMsIHJlcXVlc3RfYm9keSwgdGltZW91dCk6CiAgICAocmMsIHJlc3ApID0gcmVxdWVzdChhcGlfdXJsICsgIi9zdG9yYWdlLXN5c3RlbXMiLCBkYXRhPXJlcXVlc3RfYm9keSwgaGVhZGVycz1wb3N0X2hlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q9J1BPU1QnLCB1cmxfdXNlcm5hbWU9YXBpX3VzciwgdXJsX3Bhc3N3b3JkPWFwaV9wd2QsCiAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZV9jZXJ0cz12YWxpZGF0ZV9jZXJ0cykKICAgIHN0YXR1cyA9IE5vbmUKICAgIHJldHVybl9yZXNwID0gcmVzcAogICAgaWYgJ3N0YXR1cycgaW4gcmVzcDoKICAgICAgICBzdGF0dXMgPSByZXNwWydzdGF0dXMnXQoKICAgIGlmIHJjID09IDIwMToKICAgICAgICBzdGF0dXMgPSAnbmV2ZXJDb250YWN0ZWQnCiAgICAgICAgZmFpbF9hZnRlcl90aW1lID0gZHQudXRjbm93KCkgKyB0aW1lZGVsdGEoc2Vjb25kcz10aW1lb3V0KQoKICAgICAgICB3aGlsZSBzdGF0dXMgPT0gJ25ldmVyQ29udGFjdGVkJzoKICAgICAgICAgICAgaWYgZHQudXRjbm93KCkgPiBmYWlsX2FmdGVyX3RpbWU6CiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIndlYiBwcm94eSB0aW1lZCBvdXQgd2FpdGluZyBmb3IgYXJyYXkgc3RhdHVzIikKCiAgICAgICAgICAgIHNsZWVwKDEpCiAgICAgICAgICAgIChyYywgc3lzdGVtX3Jlc3ApID0gcmVxdWVzdChhcGlfdXJsICsgIi9zdG9yYWdlLXN5c3RlbXMvJXMiICUgc3NpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9ZGljdChBY2NlcHQ9ImFwcGxpY2F0aW9uL2pzb24iKSwgdXJsX3VzZXJuYW1lPWFwaV91c3IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmxfcGFzc3dvcmQ9YXBpX3B3ZCwgdmFsaWRhdGVfY2VydHM9dmFsaWRhdGVfY2VydHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZ25vcmVfZXJyb3JzPVRydWUpCiAgICAgICAgICAgIHN0YXR1cyA9IHN5c3RlbV9yZXNwWydzdGF0dXMnXQogICAgICAgICAgICByZXR1cm5fcmVzcCA9IHN5c3RlbV9yZXNwCgogICAgcmV0dXJuIHN0YXR1cywgcmV0dXJuX3Jlc3AKCgpkZWYgbWFpbigpOgogICAgYXJndW1lbnRfc3BlYyA9IGJhc2ljX2F1dGhfYXJndW1lbnRfc3BlYygpCiAgICBhcmd1bWVudF9zcGVjLnVwZGF0ZShkaWN0KAogICAgICAgIHN0YXRlPWRpY3QocmVxdWlyZWQ9VHJ1ZSwgY2hvaWNlcz1bJ3ByZXNlbnQnLCAnYWJzZW50J10pLAogICAgICAgIHNzaWQ9ZGljdChyZXF1aXJlZD1UcnVlLCB0eXBlPSdzdHInKSwKICAgICAgICBjb250cm9sbGVyX2FkZHJlc3Nlcz1kaWN0KHR5cGU9J2xpc3QnKSwKICAgICAgICBhcnJheV93d249ZGljdChyZXF1aXJlZD1GYWxzZSwgdHlwZT0nc3RyJyksCiAgICAgICAgYXJyYXlfcGFzc3dvcmQ9ZGljdChyZXF1aXJlZD1GYWxzZSwgdHlwZT0nc3RyJywgbm9fbG9nPVRydWUpLAogICAgICAgIGFycmF5X3N0YXR1c190aW1lb3V0X3NlYz1kaWN0KGRlZmF1bHQ9NjAsIHR5cGU9J2ludCcpLAogICAgICAgIGVuYWJsZV90cmFjZT1kaWN0KGRlZmF1bHQ9RmFsc2UsIHR5cGU9J2Jvb2wnKSwKICAgICAgICBtZXRhX3RhZ3M9ZGljdCh0eXBlPSdsaXN0JykKICAgICkpCiAgICBtb2R1bGUgPSBBbnNpYmxlTW9kdWxlKAogICAgICAgIGFyZ3VtZW50X3NwZWM9YXJndW1lbnRfc3BlYywKICAgICAgICBzdXBwb3J0c19jaGVja19tb2RlPVRydWUsCiAgICAgICAgbXV0dWFsbHlfZXhjbHVzaXZlPVtbJ2NvbnRyb2xsZXJfYWRkcmVzc2VzJywgJ2FycmF5X3d3biddXSwKICAgICAgICByZXF1aXJlZF9pZj1bKCdzdGF0ZScsICdwcmVzZW50JywgWydjb250cm9sbGVyX2FkZHJlc3NlcyddKV0KICAgICkKCiAgICBwID0gbW9kdWxlLnBhcmFtcwoKICAgIHN0YXRlID0gcFsnc3RhdGUnXQogICAgc3NpZCA9IHBbJ3NzaWQnXQogICAgY29udHJvbGxlcl9hZGRyZXNzZXMgPSBwWydjb250cm9sbGVyX2FkZHJlc3NlcyddCiAgICBhcnJheV93d24gPSBwWydhcnJheV93d24nXQogICAgYXJyYXlfcGFzc3dvcmQgPSBwWydhcnJheV9wYXNzd29yZCddCiAgICBhcnJheV9zdGF0dXNfdGltZW91dF9zZWMgPSBwWydhcnJheV9zdGF0dXNfdGltZW91dF9zZWMnXQogICAgdmFsaWRhdGVfY2VydHMgPSBwWyd2YWxpZGF0ZV9jZXJ0cyddCiAgICBtZXRhX3RhZ3MgPSBwWydtZXRhX3RhZ3MnXQogICAgZW5hYmxlX3RyYWNlID0gcFsnZW5hYmxlX3RyYWNlJ10KCiAgICBhcGlfdXNyID0gcFsnYXBpX3VzZXJuYW1lJ10KICAgIGFwaV9wd2QgPSBwWydhcGlfcGFzc3dvcmQnXQogICAgYXBpX3VybCA9IHBbJ2FwaV91cmwnXQoKICAgIGNoYW5nZWQgPSBGYWxzZQogICAgYXJyYXlfZXhpc3RzID0gRmFsc2UKCiAgICB0cnk6CiAgICAgICAgKHJjLCByZXNwKSA9IHJlcXVlc3QoYXBpX3VybCArICIvc3RvcmFnZS1zeXN0ZW1zLyVzIiAlIHNzaWQsIGhlYWRlcnM9ZGljdChBY2NlcHQ9ImFwcGxpY2F0aW9uL2pzb24iKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmxfdXNlcm5hbWU9YXBpX3VzciwgdXJsX3Bhc3N3b3JkPWFwaV9wd2QsIHZhbGlkYXRlX2NlcnRzPXZhbGlkYXRlX2NlcnRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlnbm9yZV9lcnJvcnM9VHJ1ZSkKICAgIGV4Y2VwdDoKICAgICAgICBlcnIgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG1zZz0iRXJyb3IgYWNjZXNzaW5nIHN0b3JhZ2Utc3lzdGVtIHdpdGggaWQgWyVzXS4gRXJyb3IgWyVzXSIgJSAoc3NpZCwgc3RyKGVycikpKQoKICAgIGFycmF5X2V4aXN0cyA9IFRydWUKICAgIGFycmF5X2RldGFpbCA9IHJlc3AKCiAgICBpZiByYyA9PSAyMDA6CiAgICAgICAgaWYgc3RhdGUgPT0gJ2Fic2VudCc6CiAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgICAgIGFycmF5X2V4aXN0cyA9IEZhbHNlCiAgICAgICAgZWxpZiBzdGF0ZSA9PSAncHJlc2VudCc6CiAgICAgICAgICAgIGN1cnJlbnRfYWRkcmVzc2VzID0gZnJvemVuc2V0KGkgZm9yIGkgaW4gKGFycmF5X2RldGFpbFsnaXAxJ10sIGFycmF5X2RldGFpbFsnaXAyJ10pIGlmIGkpCiAgICAgICAgICAgIGlmIHNldChjb250cm9sbGVyX2FkZHJlc3NlcykgIT0gY3VycmVudF9hZGRyZXNzZXM6CiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgICAgICBpZiBhcnJheV9kZXRhaWxbJ3d3biddICE9IGFycmF5X3d3biBhbmQgYXJyYXlfd3duIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgICAgICBtc2c9J0l0IHNlZW1zIHlvdSBtYXkgaGF2ZSBzcGVjaWZpZWQgYSBiYWQgV1dOLiBUaGUgc3RvcmFnZSBzeXN0ZW0gSUQgeW91IHNwZWNpZmllZCwgJXMsIGN1cnJlbnRseSBoYXMgdGhlIFdXTiBvZiAlcycgJQogICAgICAgICAgICAgICAgICAgICAgICAoc3NpZCwgYXJyYXlfZGV0YWlsWyd3d24nXSkKICAgICAgICAgICAgICAgICkKICAgIGVsaWYgcmMgPT0gNDA0OgogICAgICAgIGlmIHN0YXRlID09ICdwcmVzZW50JzoKICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICAgICAgYXJyYXlfZXhpc3RzID0gRmFsc2UKICAgICAgICBlbHNlOgogICAgICAgICAgICBjaGFuZ2VkID0gRmFsc2UKICAgICAgICAgICAgbW9kdWxlLmV4aXRfanNvbihjaGFuZ2VkPWNoYW5nZWQsIG1zZz0iU3RvcmFnZSBzeXN0ZW0gd2FzIG5vdCBwcmVzZW50LiIpCgogICAgaWYgY2hhbmdlZCBhbmQgbm90IG1vZHVsZS5jaGVja19tb2RlOgogICAgICAgIGlmIHN0YXRlID09ICdwcmVzZW50JzoKICAgICAgICAgICAgaWYgbm90IGFycmF5X2V4aXN0czoKICAgICAgICAgICAgICAgICMgYWRkIHRoZSBhcnJheQogICAgICAgICAgICAgICAgYXJyYXlfYWRkX3JlcSA9IGRpY3QoCiAgICAgICAgICAgICAgICAgICAgaWQ9c3NpZCwKICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyQWRkcmVzc2VzPWNvbnRyb2xsZXJfYWRkcmVzc2VzLAogICAgICAgICAgICAgICAgICAgIG1ldGFUYWdzPW1ldGFfdGFncywKICAgICAgICAgICAgICAgICAgICBlbmFibGVUcmFjZT1lbmFibGVfdHJhY2UKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICBpZiBhcnJheV93d246CiAgICAgICAgICAgICAgICAgICAgYXJyYXlfYWRkX3JlcVsnd3duJ10gPSBhcnJheV93d24KCiAgICAgICAgICAgICAgICBpZiBhcnJheV9wYXNzd29yZDoKICAgICAgICAgICAgICAgICAgICBhcnJheV9hZGRfcmVxWydwYXNzd29yZCddID0gYXJyYXlfcGFzc3dvcmQKCiAgICAgICAgICAgICAgICBwb3N0X2hlYWRlcnMgPSBkaWN0KEFjY2VwdD0iYXBwbGljYXRpb24vanNvbiIpCiAgICAgICAgICAgICAgICBwb3N0X2hlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gJ2FwcGxpY2F0aW9uL2pzb24nCiAgICAgICAgICAgICAgICByZXF1ZXN0X2RhdGEgPSBqc29uLmR1bXBzKGFycmF5X2FkZF9yZXEpCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIChyYywgcmVzcCkgPSBkb19wb3N0KHNzaWQsIGFwaV91cmwsIHBvc3RfaGVhZGVycywgYXBpX3VzciwgYXBpX3B3ZCwgdmFsaWRhdGVfY2VydHMsIHJlcXVlc3RfZGF0YSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheV9zdGF0dXNfdGltZW91dF9zZWMpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgZXJyID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9IkZhaWxlZCB0byBhZGQgc3RvcmFnZSBzeXN0ZW0uIElkWyVzXS4gUmVxdWVzdCBib2R5IFslc10uIEVycm9yWyVzXS4iICUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoc3NpZCwgcmVxdWVzdF9kYXRhLCBzdHIoZXJyKSkpCgogICAgICAgICAgICBlbHNlOiAgIyBhcnJheSBleGlzdHMsIG1vZGlmeS4uLgogICAgICAgICAgICAgICAgcG9zdF9oZWFkZXJzID0gZGljdChBY2NlcHQ9ImFwcGxpY2F0aW9uL2pzb24iKQogICAgICAgICAgICAgICAgcG9zdF9oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9ICdhcHBsaWNhdGlvbi9qc29uJwogICAgICAgICAgICAgICAgcG9zdF9ib2R5ID0gZGljdCgKICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyQWRkcmVzc2VzPWNvbnRyb2xsZXJfYWRkcmVzc2VzLAogICAgICAgICAgICAgICAgICAgIHJlbW92ZUFsbFRhZ3M9VHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlbmFibGVUcmFjZT1lbmFibGVfdHJhY2UsCiAgICAgICAgICAgICAgICAgICAgbWV0YVRhZ3M9bWV0YV90YWdzCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIChyYywgcmVzcCkgPSBkb19wb3N0KHNzaWQsIGFwaV91cmwsIHBvc3RfaGVhZGVycywgYXBpX3VzciwgYXBpX3B3ZCwgdmFsaWRhdGVfY2VydHMsIHBvc3RfYm9keSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheV9zdGF0dXNfdGltZW91dF9zZWMpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgZXJyID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9IkZhaWxlZCB0byB1cGRhdGUgc3RvcmFnZSBzeXN0ZW0uIElkWyVzXS4gUmVxdWVzdCBib2R5IFslc10uIEVycm9yWyVzXS4iICUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoc3NpZCwgcG9zdF9ib2R5LCBzdHIoZXJyKSkpCgogICAgICAgIGVsaWYgc3RhdGUgPT0gJ2Fic2VudCc6CiAgICAgICAgICAgICMgZGVsZXRlIHRoZSBhcnJheQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAocmMsIHJlc3ApID0gcmVxdWVzdChhcGlfdXJsICsgIi9zdG9yYWdlLXN5c3RlbXMvJXMiICUgc3NpZCwgbWV0aG9kPSdERUxFVEUnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsX3VzZXJuYW1lPWFwaV91c3IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmxfcGFzc3dvcmQ9YXBpX3B3ZCwgdmFsaWRhdGVfY2VydHM9dmFsaWRhdGVfY2VydHMpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIGVyciA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9IkZhaWxlZCB0byByZW1vdmUgc3RvcmFnZSBhcnJheS4gSWRbJXNdLiBFcnJvclslc10uIiAlIChzc2lkLCBzdHIoZXJyKSkpCgogICAgICAgICAgICBpZiByYyA9PSA0MjI6CiAgICAgICAgICAgICAgICBtb2R1bGUuZXhpdF9qc29uKGNoYW5nZWQ9Y2hhbmdlZCwgbXNnPSJTdG9yYWdlIHN5c3RlbSB3YXMgbm90IHByZXNudC4iKQogICAgICAgICAgICBpZiByYyA9PSAyMDQ6CiAgICAgICAgICAgICAgICBtb2R1bGUuZXhpdF9qc29uKGNoYW5nZWQ9Y2hhbmdlZCwgbXNnPSJTdG9yYWdlIHN5c3RlbSByZW1vdmVkLiIpCgogICAgbW9kdWxlLmV4aXRfanNvbihjaGFuZ2VkPWNoYW5nZWQsICoqcmVzcCkKCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgbWFpbigpClBLAwQUAAAAAADMuytLO985lTCKAQAwigEAHQAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5IyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojIFRoaXMgcGFydGljdWxhciBmaWxlIHNuaXBwZXQsIGFuZCB0aGlzIGZpbGUgc25pcHBldCBvbmx5LCBpcyBCU0QgbGljZW5zZWQuCiMgTW9kdWxlcyB5b3Ugd3JpdGUgdXNpbmcgdGhpcyBzbmlwcGV0LCB3aGljaCBpcyBlbWJlZGRlZCBkeW5hbWljYWxseSBieSBBbnNpYmxlCiMgc3RpbGwgYmVsb25nIHRvIHRoZSBhdXRob3Igb2YgdGhlIG1vZHVsZSwgYW5kIG1heSBhc3NpZ24gdGhlaXIgb3duIGxpY2Vuc2UKIyB0byB0aGUgY29tcGxldGUgd29yay4KIwojIENvcHlyaWdodCAoYyksIE1pY2hhZWwgRGVIYWFuIDxtaWNoYWVsLmRlaGFhbkBnbWFpbC5jb20+LCAyMDEyLTIwMTMKIyBDb3B5cmlnaHQgKGMpLCBUb3NoaW8gS3VyYXRvbWkgPHRrdXJhdG9taUBhbnNpYmxlLmNvbT4gMjAxNgojIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiMKIyBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQgbW9kaWZpY2F0aW9uLAojIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKIwojICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKIyAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwKIyAgICAgIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24KIyAgICAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORAojIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVECiMgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRSBESVNDTEFJTUVELgojIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULAojIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywKIyBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MKIyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUCiMgTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFCiMgVVNFIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiMKCkJPT0xFQU5TX1RSVUUgPSBbJ3knLCAneWVzJywgJ29uJywgJzEnLCAndHJ1ZScsIDEsIFRydWVdCkJPT0xFQU5TX0ZBTFNFID0gWyduJywgJ25vJywgJ29mZicsICcwJywgJ2ZhbHNlJywgMCwgRmFsc2VdCkJPT0xFQU5TID0gQk9PTEVBTlNfVFJVRSArIEJPT0xFQU5TX0ZBTFNFCgpTSVpFX1JBTkdFUyA9IHsgJ1knOiAxPDw4MCwgJ1onOiAxPDw3MCwgJ0UnOiAxPDw2MCwgJ1AnOiAxPDw1MCwgJ1QnOiAxPDw0MCwgJ0cnOiAxPDwzMCwgJ00nOiAxPDwyMCwgJ0snOiAxPDwxMCwgJ0InOiAxIH0KCkZJTEVfQVRUUklCVVRFUyA9IHsKICAgICdBJzogJ25vYXRpbWUnLAogICAgJ2EnOiAnYXBwZW5kJywKICAgICdjJzogJ2NvbXByZXNzZWQnLAogICAgJ0MnOiAnbm9jb3cnLAogICAgJ2QnOiAnbm9kdW1wJywKICAgICdEJzogJ2RpcnN5bmMnLAogICAgJ2UnOiAnZXh0ZW50cycsCiAgICAnRSc6ICdlbmNyeXB0ZWQnLAogICAgJ2gnOiAnYmxvY2tzaXplJywKICAgICdpJzogJ2ltbXV0YWJsZScsCiAgICAnSSc6ICdpbmRleGVkJywKICAgICdqJzogJ2pvdXJuYWxsZWQnLAogICAgJ04nOiAnaW5saW5lJywKICAgICdzJzogJ3plcm8nLAogICAgJ1MnOiAnc3luY2hyb25vdXMnLAogICAgJ3QnOiAnbm90YWlsJywKICAgICdUJzogJ2Jsb2Nrcm9vdCcsCiAgICAndSc6ICd1bmRlbGV0ZScsCiAgICAnWCc6ICdjb21wcmVzc2VkcmF3JywKICAgICdaJzogJ2NvbXByZXNzZWRkaXJ0eScsCn0KCiMgYW5zaWJsZSBtb2R1bGVzIGNhbiBiZSB3cml0dGVuIGluIGFueSBsYW5ndWFnZS4gIFRvIHNpbXBsaWZ5CiMgZGV2ZWxvcG1lbnQgb2YgUHl0aG9uIG1vZHVsZXMsIHRoZSBmdW5jdGlvbnMgYXZhaWxhYmxlIGhlcmUgY2FuCiMgYmUgdXNlZCB0byBkbyBtYW55IGNvbW1vbiB0YXNrcwoKaW1wb3J0IGxvY2FsZQppbXBvcnQgb3MKaW1wb3J0IHJlCmltcG9ydCBzaGxleAppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgc3lzCmltcG9ydCB0eXBlcwppbXBvcnQgdGltZQppbXBvcnQgc2VsZWN0CmltcG9ydCBzaHV0aWwKaW1wb3J0IHN0YXQKaW1wb3J0IHRlbXBmaWxlCmltcG9ydCB0cmFjZWJhY2sKaW1wb3J0IGdycAppbXBvcnQgcHdkCmltcG9ydCBwbGF0Zm9ybQppbXBvcnQgZXJybm8KaW1wb3J0IGRhdGV0aW1lCmZyb20gaXRlcnRvb2xzIGltcG9ydCByZXBlYXQsIGNoYWluCgp0cnk6CiAgICBpbXBvcnQgc3lzbG9nCiAgICBIQVNfU1lTTE9HPVRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgSEFTX1NZU0xPRz1GYWxzZQoKdHJ5OgogICAgZnJvbSBzeXN0ZW1kIGltcG9ydCBqb3VybmFsCiAgICBoYXNfam91cm5hbCA9IFRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaGFzX2pvdXJuYWwgPSBGYWxzZQoKSEFWRV9TRUxJTlVYPUZhbHNlCnRyeToKICAgIGltcG9ydCBzZWxpbnV4CiAgICBIQVZFX1NFTElOVVg9VHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBwYXNzCgojIFB5dGhvbjIgJiAzIHdheSB0byBnZXQgTm9uZVR5cGUKTm9uZVR5cGUgPSB0eXBlKE5vbmUpCgp0cnk6CiAgICBmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBTZXF1ZW5jZSwgTWFwcGluZwpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAjIHB5dGhvbjIuNQogICAgU2VxdWVuY2UgPSAobGlzdCwgdHVwbGUpCiAgICBNYXBwaW5nID0gKGRpY3QsKQoKIyBOb3RlOiBXaGVuIGdldHRpbmcgU2VxdWVuY2UgZnJvbSBjb2xsZWN0aW9ucywgaXQgbWF0Y2hlcyB3aXRoIHN0cmluZ3MuICBJZgojIHRoaXMgbWF0dGVycywgbWFrZSBzdXJlIHRvIGNoZWNrIGZvciBzdHJpbmdzIGJlZm9yZSBjaGVja2luZyBmb3Igc2VxdWVuY2V0eXBlCnRyeToKICAgIGZyb20gY29sbGVjdGlvbnMuYWJjIGltcG9ydCBLZXlzVmlldwogICAgU0VRVUVOQ0VUWVBFID0gKFNlcXVlbmNlLCBLZXlzVmlldykKZXhjZXB0OgogICAgU0VRVUVOQ0VUWVBFID0gU2VxdWVuY2UKCnRyeToKICAgIGltcG9ydCBqc29uCiAgICAjIERldGVjdCB0aGUgcHl0aG9uLWpzb24gbGlicmFyeSB3aGljaCBpcyBpbmNvbXBhdGlibGUKICAgICMgTG9vayBmb3Igc2ltcGxlanNvbiBpZiB0aGF0J3MgdGhlIGNhc2UKICAgIHRyeToKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShqc29uLmxvYWRzLCB0eXBlcy5GdW5jdGlvblR5cGUpIG9yIG5vdCBpc2luc3RhbmNlKGpzb24uZHVtcHMsIHR5cGVzLkZ1bmN0aW9uVHlwZSk6CiAgICAgICAgICAgIHJhaXNlIEltcG9ydEVycm9yCiAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IKZXhjZXB0IEltcG9ydEVycm9yOgogICAgdHJ5OgogICAgICAgIGltcG9ydCBzaW1wbGVqc29uIGFzIGpzb24KICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICBwcmludCgnXG57Im1zZyI6ICJFcnJvcjogYW5zaWJsZSByZXF1aXJlcyB0aGUgc3RkbGliIGpzb24gb3Igc2ltcGxlanNvbiBtb2R1bGUsIG5laXRoZXIgd2FzIGZvdW5kISIsICJmYWlsZWQiOiB0cnVlfScpCiAgICAgICAgc3lzLmV4aXQoMSkKICAgIGV4Y2VwdCBTeW50YXhFcnJvcjoKICAgICAgICBwcmludCgnXG57Im1zZyI6ICJTeW50YXhFcnJvcjogcHJvYmFibHkgZHVlIHRvIGluc3RhbGxlZCBzaW1wbGVqc29uIGJlaW5nIGZvciBhIGRpZmZlcmVudCBweXRob24gdmVyc2lvbiIsICJmYWlsZWQiOiB0cnVlfScpCiAgICAgICAgc3lzLmV4aXQoMSkKCkFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVMgPSBkaWN0KCkKdHJ5OgogICAgaW1wb3J0IGhhc2hsaWIKCiAgICAjIHB5dGhvbiAyLjcuOSsgYW5kIDIuNy4wKwogICAgZm9yIGF0dHJpYnV0ZSBpbiAoJ2F2YWlsYWJsZV9hbGdvcml0aG1zJywgJ2FsZ29yaXRobXMnKToKICAgICAgICBhbGdvcml0aG1zID0gZ2V0YXR0cihoYXNobGliLCBhdHRyaWJ1dGUsIE5vbmUpCiAgICAgICAgaWYgYWxnb3JpdGhtczoKICAgICAgICAgICAgYnJlYWsKICAgIGlmIGFsZ29yaXRobXMgaXMgTm9uZToKICAgICAgICAjIHB5dGhvbiAyLjUrCiAgICAgICAgYWxnb3JpdGhtcyA9ICgnbWQ1JywgJ3NoYTEnLCAnc2hhMjI0JywgJ3NoYTI1NicsICdzaGEzODQnLCAnc2hhNTEyJykKICAgIGZvciBhbGdvcml0aG0gaW4gYWxnb3JpdGhtczoKICAgICAgICBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TW2FsZ29yaXRobV0gPSBnZXRhdHRyKGhhc2hsaWIsIGFsZ29yaXRobSkKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaW1wb3J0IHNoYQogICAgQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNUyA9IHsnc2hhMSc6IHNoYS5zaGF9CiAgICB0cnk6CiAgICAgICAgaW1wb3J0IG1kNQogICAgICAgIEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVNbJ21kNSddID0gbWQ1Lm1kNQogICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgIHBhc3MKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMucHljb21wYXQyNCBpbXBvcnQgZ2V0X2V4Y2VwdGlvbiwgbGl0ZXJhbF9ldmFsCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGltcG9ydCAoUFkyLCBQWTMsIGIsIGJpbmFyeV90eXBlLCBpbnRlZ2VyX3R5cGVzLAogICAgICAgIGl0ZXJpdGVtcywgdGV4dF90eXBlLCBzdHJpbmdfdHlwZXMpCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Lm1vdmVzIGltcG9ydCBtYXAsIHJlZHVjZSwgc2hsZXhfcXVvdGUKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5fdGV4dCBpbXBvcnQgdG9fbmF0aXZlLCB0b19ieXRlcywgdG9fdGV4dAoKUEFTU1dPUkRfTUFUQ0ggPSByZS5jb21waWxlKHInXig/Oi4rWy1fXHNdKT9wYXNzKD86Wy1fXHNdPyg/OndvcmR8cGhyYXNlfHdyZHx3ZCk/KSg/OlstX1xzXS4rKT8kJywgcmUuSSkKCl9OVU1CRVJUWVBFUyA9IHR1cGxlKGxpc3QoaW50ZWdlcl90eXBlcykgKyBbZmxvYXRdKQoKIyBEZXByZWNhdGVkIGNvbXBhdC4gIE9ubHkga2VwdCBpbiBjYXNlIGFub3RoZXIgbW9kdWxlIHVzZWQgdGhlc2UgbmFtZXMgIFVzaW5nCiMgYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGlzIHByZWZlcnJlZAoKTlVNQkVSVFlQRVMgPSBfTlVNQkVSVFlQRVMKCmltYXAgPSBtYXAKCnRyeToKICAgICMgUHl0aG9uIDIKICAgIHVuaWNvZGUKZXhjZXB0IE5hbWVFcnJvcjoKICAgICMgUHl0aG9uIDMKICAgIHVuaWNvZGUgPSB0ZXh0X3R5cGUKCnRyeToKICAgICMgUHl0aG9uIDIuNisKICAgIGJ5dGVzCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICAjIFB5dGhvbiAyLjQKICAgIGJ5dGVzID0gYmluYXJ5X3R5cGUKCnRyeToKICAgICMgUHl0aG9uIDIKICAgIGJhc2VzdHJpbmcKZXhjZXB0IE5hbWVFcnJvcjoKICAgICMgUHl0aG9uIDMKICAgIGJhc2VzdHJpbmcgPSBzdHJpbmdfdHlwZXMKCl9saXRlcmFsX2V2YWwgPSBsaXRlcmFsX2V2YWwKCiMgRW5kIG9mIGRlcHJlY2F0ZWQgbmFtZXMKCiMgSW50ZXJuYWwgZ2xvYmFsIGhvbGRpbmcgcGFzc2VkIGluIHBhcmFtcy4gIFRoaXMgaXMgY29uc3VsdGVkIGluIGNhc2UKIyBtdWx0aXBsZSBBbnNpYmxlTW9kdWxlcyBhcmUgY3JlYXRlZC4gIE90aGVyd2lzZSBlYWNoIEFuc2libGVNb2R1bGUgd291bGQKIyBhdHRlbXB0IHRvIHJlYWQgZnJvbSBzdGRpbi4gIE90aGVyIGNvZGUgc2hvdWxkIG5vdCB1c2UgdGhpcyBkaXJlY3RseSBhcyBpdAojIGlzIGFuIGludGVybmFsIGltcGxlbWVudGF0aW9uIGRldGFpbApfQU5TSUJMRV9BUkdTID0gTm9uZQoKRklMRV9DT01NT05fQVJHVU1FTlRTPWRpY3QoCiAgICBzcmMgPSBkaWN0KCksCiAgICBtb2RlID0gZGljdCh0eXBlPSdyYXcnKSwKICAgIG93bmVyID0gZGljdCgpLAogICAgZ3JvdXAgPSBkaWN0KCksCiAgICBzZXVzZXIgPSBkaWN0KCksCiAgICBzZXJvbGUgPSBkaWN0KCksCiAgICBzZWxldmVsID0gZGljdCgpLAogICAgc2V0eXBlID0gZGljdCgpLAogICAgZm9sbG93ID0gZGljdCh0eXBlPSdib29sJywgZGVmYXVsdD1GYWxzZSksCiAgICAjIG5vdCB0YWtlbiBieSB0aGUgZmlsZSBtb2R1bGUsIGJ1dCBvdGhlciBtb2R1bGVzIGNhbGwgZmlsZSBzbyBpdCBtdXN0IGlnbm9yZSB0aGVtLgogICAgY29udGVudCA9IGRpY3Qobm9fbG9nPVRydWUpLAogICAgYmFja3VwID0gZGljdCgpLAogICAgZm9yY2UgPSBkaWN0KCksCiAgICByZW1vdGVfc3JjID0gZGljdCgpLCAjIHVzZWQgYnkgYXNzZW1ibGUKICAgIHJlZ2V4cCA9IGRpY3QoKSwgIyB1c2VkIGJ5IGFzc2VtYmxlCiAgICBkZWxpbWl0ZXIgPSBkaWN0KCksICMgdXNlZCBieSBhc3NlbWJsZQogICAgZGlyZWN0b3J5X21vZGUgPSBkaWN0KCksICMgdXNlZCBieSBjb3B5CiAgICB1bnNhZmVfd3JpdGVzICA9IGRpY3QodHlwZT0nYm9vbCcpLCAjIHNob3VsZCBiZSBhdmFpbGFibGUgdG8gYW55IG1vZHVsZSB1c2luZyBhdG9taWNfbW92ZQogICAgYXR0cmlidXRlcyA9IGRpY3QoYWxpYXNlcz1bJ2F0dHInXSksCikKClBBU1NXRF9BUkdfUkUgPSByZS5jb21waWxlKHInXlstXXswLDJ9cGFzc1stXT8od29yZHx3ZCk/JykKCiMgQ2FuJ3QgdXNlIDA3Nzc3IG9uIFB5dGhvbiAzLCBjYW4ndCB1c2UgMG83Nzc3IG9uIFB5dGhvbiAyLjQKUEVSTV9CSVRTID0gaW50KCcwNzc3NycsIDgpICAgICAgIyBmaWxlIG1vZGUgcGVybWlzc2lvbiBiaXRzCkVYRUNfUEVSTV9CSVRTID0gaW50KCcwMDExMScsIDgpICMgZXhlY3V0ZSBwZXJtaXNzaW9uIGJpdHMKREVGQVVMVF9QRVJNID0gaW50KCcwNjY2JywgOCkgICAgIyBkZWZhdWx0IGZpbGUgcGVybWlzc2lvbiBiaXRzCgoKZGVmIGdldF9wbGF0Zm9ybSgpOgogICAgJycnIHdoYXQncyB0aGUgcGxhdGZvcm0/ICBleGFtcGxlOiBMaW51eCBpcyBhIHBsYXRmb3JtLiAnJycKICAgIHJldHVybiBwbGF0Zm9ybS5zeXN0ZW0oKQoKZGVmIGdldF9kaXN0cmlidXRpb24oKToKICAgICcnJyByZXR1cm4gdGhlIGRpc3RyaWJ1dGlvbiBuYW1lICcnJwogICAgaWYgcGxhdGZvcm0uc3lzdGVtKCkgPT0gJ0xpbnV4JzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN1cHBvcnRlZF9kaXN0cyA9IHBsYXRmb3JtLl9zdXBwb3J0ZWRfZGlzdHMgKyAoJ2FyY2gnLCdhbHBpbmUnKQogICAgICAgICAgICBkaXN0cmlidXRpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oc3VwcG9ydGVkX2Rpc3RzPXN1cHBvcnRlZF9kaXN0cylbMF0uY2FwaXRhbGl6ZSgpCiAgICAgICAgICAgIGlmIG5vdCBkaXN0cmlidXRpb24gYW5kIG9zLnBhdGguaXNmaWxlKCcvZXRjL3N5c3RlbS1yZWxlYXNlJyk6CiAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oc3VwcG9ydGVkX2Rpc3RzPVsnc3lzdGVtJ10pWzBdLmNhcGl0YWxpemUoKQogICAgICAgICAgICAgICAgaWYgJ0FtYXpvbicgaW4gZGlzdHJpYnV0aW9uOgogICAgICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9ICdBbWF6b24nCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9ICdPdGhlckxpbnV4JwogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgIyBGSVhNRTogTWV0aG9kTWlzc2luZywgSSBhc3N1bWU/CiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9IHBsYXRmb3JtLmRpc3QoKVswXS5jYXBpdGFsaXplKCkKICAgIGVsc2U6CiAgICAgICAgZGlzdHJpYnV0aW9uID0gTm9uZQogICAgcmV0dXJuIGRpc3RyaWJ1dGlvbgoKZGVmIGdldF9kaXN0cmlidXRpb25fdmVyc2lvbigpOgogICAgJycnIHJldHVybiB0aGUgZGlzdHJpYnV0aW9uIHZlcnNpb24gJycnCiAgICBpZiBwbGF0Zm9ybS5zeXN0ZW0oKSA9PSAnTGludXgnOgogICAgICAgIHRyeToKICAgICAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oKVsxXQogICAgICAgICAgICBpZiBub3QgZGlzdHJpYnV0aW9uX3ZlcnNpb24gYW5kIG9zLnBhdGguaXNmaWxlKCcvZXRjL3N5c3RlbS1yZWxlYXNlJyk6CiAgICAgICAgICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IHBsYXRmb3JtLmxpbnV4X2Rpc3RyaWJ1dGlvbihzdXBwb3J0ZWRfZGlzdHM9WydzeXN0ZW0nXSlbMV0KICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICMgRklYTUU6IE1ldGhvZE1pc3NpbmcsIEkgYXNzdW1lPwogICAgICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IHBsYXRmb3JtLmRpc3QoKVsxXQogICAgZWxzZToKICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IE5vbmUKICAgIHJldHVybiBkaXN0cmlidXRpb25fdmVyc2lvbgoKZGVmIGdldF9hbGxfc3ViY2xhc3NlcyhjbHMpOgogICAgJycnCiAgICB1c2VkIGJ5IG1vZHVsZXMgbGlrZSBIYXJkd2FyZSBvciBOZXR3b3JrIGZhY3QgY2xhc3NlcyB0byByZXRyaWV2ZSBhbGwgc3ViY2xhc3NlcyBvZiBhIGdpdmVuIGNsYXNzLgogICAgX19zdWJjbGFzc2VzX18gcmV0dXJuIG9ubHkgZGlyZWN0IHN1YiBjbGFzc2VzLiBUaGlzIG9uZSBnbyBkb3duIGludG8gdGhlIGNsYXNzIHRyZWUuCiAgICAnJycKICAgICMgUmV0cmlldmUgZGlyZWN0IHN1YmNsYXNzZXMKICAgIHN1YmNsYXNzZXMgPSBjbHMuX19zdWJjbGFzc2VzX18oKQogICAgdG9fdmlzaXQgPSBsaXN0KHN1YmNsYXNzZXMpCiAgICAjIFRoZW4gdmlzaXQgYWxsIHN1YmNsYXNzZXMKICAgIHdoaWxlIHRvX3Zpc2l0OgogICAgICAgIGZvciBzYyBpbiB0b192aXNpdDoKICAgICAgICAgICAgIyBUaGUgY3VycmVudCBjbGFzcyBpcyBub3cgdmlzaXRlZCwgc28gcmVtb3ZlIGl0IGZyb20gbGlzdAogICAgICAgICAgICB0b192aXNpdC5yZW1vdmUoc2MpCiAgICAgICAgICAgICMgQXBwZW5kaW5nIGFsbCBzdWJjbGFzc2VzIHRvIHZpc2l0IGFuZCBrZWVwIGEgcmVmZXJlbmNlIG9mIGF2YWlsYWJsZSBjbGFzcwogICAgICAgICAgICBmb3Igc3NjIGluIHNjLl9fc3ViY2xhc3Nlc19fKCk6CiAgICAgICAgICAgICAgICBzdWJjbGFzc2VzLmFwcGVuZChzc2MpCiAgICAgICAgICAgICAgICB0b192aXNpdC5hcHBlbmQoc3NjKQogICAgcmV0dXJuIHN1YmNsYXNzZXMKCgpkZWYgbG9hZF9wbGF0Zm9ybV9zdWJjbGFzcyhjbHMsICphcmdzLCAqKmt3YXJncyk6CiAgICAnJycKICAgIHVzZWQgYnkgbW9kdWxlcyBsaWtlIFVzZXIgdG8gaGF2ZSBkaWZmZXJlbnQgaW1wbGVtZW50YXRpb25zIGJhc2VkIG9uIGRldGVjdGVkIHBsYXRmb3JtLiAgU2VlIFVzZXIKICAgIG1vZHVsZSBmb3IgYW4gZXhhbXBsZS4KICAgICcnJwoKICAgIHRoaXNfcGxhdGZvcm0gPSBnZXRfcGxhdGZvcm0oKQogICAgZGlzdHJpYnV0aW9uID0gZ2V0X2Rpc3RyaWJ1dGlvbigpCiAgICBzdWJjbGFzcyA9IE5vbmUKCiAgICAjIGdldCB0aGUgbW9zdCBzcGVjaWZpYyBzdXBlcmNsYXNzIGZvciB0aGlzIHBsYXRmb3JtCiAgICBpZiBkaXN0cmlidXRpb24gaXMgbm90IE5vbmU6CiAgICAgICAgZm9yIHNjIGluIGdldF9hbGxfc3ViY2xhc3NlcyhjbHMpOgogICAgICAgICAgICBpZiBzYy5kaXN0cmlidXRpb24gaXMgbm90IE5vbmUgYW5kIHNjLmRpc3RyaWJ1dGlvbiA9PSBkaXN0cmlidXRpb24gYW5kIHNjLnBsYXRmb3JtID09IHRoaXNfcGxhdGZvcm06CiAgICAgICAgICAgICAgICBzdWJjbGFzcyA9IHNjCiAgICBpZiBzdWJjbGFzcyBpcyBOb25lOgogICAgICAgIGZvciBzYyBpbiBnZXRfYWxsX3N1YmNsYXNzZXMoY2xzKToKICAgICAgICAgICAgaWYgc2MucGxhdGZvcm0gPT0gdGhpc19wbGF0Zm9ybSBhbmQgc2MuZGlzdHJpYnV0aW9uIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzdWJjbGFzcyA9IHNjCiAgICBpZiBzdWJjbGFzcyBpcyBOb25lOgogICAgICAgIHN1YmNsYXNzID0gY2xzCgogICAgcmV0dXJuIHN1cGVyKGNscywgc3ViY2xhc3MpLl9fbmV3X18oc3ViY2xhc3MpCgoKZGVmIGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzKGQsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpOgogICAgJycnIFJlY3Vyc2l2ZWx5IGNvbnZlcnQgZGljdCBrZXlzIGFuZCB2YWx1ZXMgdG8gYnl0ZSBzdHIKCiAgICAgICAgU3BlY2lhbGl6ZWQgZm9yIGpzb24gcmV0dXJuIGJlY2F1c2UgdGhpcyBvbmx5IGhhbmRsZXMsIGxpc3RzLCB0dXBsZXMsCiAgICAgICAgYW5kIGRpY3QgY29udGFpbmVyIHR5cGVzICh0aGUgY29udGFpbmVycyB0aGF0IHRoZSBqc29uIG1vZHVsZSByZXR1cm5zKQogICAgJycnCgogICAgaWYgaXNpbnN0YW5jZShkLCB0ZXh0X3R5cGUpOgogICAgICAgIHJldHVybiB0b19ieXRlcyhkLCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycykKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBkaWN0KToKICAgICAgICByZXR1cm4gZGljdChtYXAoanNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMsIGl0ZXJpdGVtcyhkKSwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIGxpc3QpOgogICAgICAgIHJldHVybiBsaXN0KG1hcChqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcywgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIHR1cGxlKToKICAgICAgICByZXR1cm4gdHVwbGUobWFwKGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzLCBkLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbHNlOgogICAgICAgIHJldHVybiBkCgpkZWYganNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUoZCwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0Jyk6CiAgICAnJycgUmVjdXJzaXZlbHkgY29udmVydCBkaWN0IGtleXMgYW5kIHZhbHVlcyB0byBieXRlIHN0cgoKICAgICAgICBTcGVjaWFsaXplZCBmb3IganNvbiByZXR1cm4gYmVjYXVzZSB0aGlzIG9ubHkgaGFuZGxlcywgbGlzdHMsIHR1cGxlcywKICAgICAgICBhbmQgZGljdCBjb250YWluZXIgdHlwZXMgKHRoZSBjb250YWluZXJzIHRoYXQgdGhlIGpzb24gbW9kdWxlIHJldHVybnMpCiAgICAnJycKCiAgICBpZiBpc2luc3RhbmNlKGQsIGJpbmFyeV90eXBlKToKICAgICAgICAjIFdhcm5pbmcsIGNhbiB0cmFjZWJhY2sKICAgICAgICByZXR1cm4gdG9fdGV4dChkLCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycykKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBkaWN0KToKICAgICAgICByZXR1cm4gZGljdChtYXAoanNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUsIGl0ZXJpdGVtcyhkKSwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIGxpc3QpOgogICAgICAgIHJldHVybiBsaXN0KG1hcChqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZSwgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIHR1cGxlKToKICAgICAgICByZXR1cm4gdHVwbGUobWFwKGpzb25fZGljdF9ieXRlc190b191bmljb2RlLCBkLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbHNlOgogICAgICAgIHJldHVybiBkCgpkZWYgcmV0dXJuX3ZhbHVlcyhvYmopOgogICAgIiIiIFJldHVybiBuYXRpdmUgc3RyaW5naWZpZWQgdmFsdWVzIGZyb20gZGF0YXN0cnVjdHVyZXMuCgogICAgRm9yIHVzZSB3aXRoIHJlbW92aW5nIHNlbnNpdGl2ZSB2YWx1ZXMgcHJlLWpzb25pZmljYXRpb24uIiIiCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICBpZiBvYmo6CiAgICAgICAgICAgIHlpZWxkIHRvX25hdGl2ZShvYmosIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgcmV0dXJuCiAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCBTRVFVRU5DRVRZUEUpOgogICAgICAgIGZvciBlbGVtZW50IGluIG9iajoKICAgICAgICAgICAgZm9yIHN1YmVsZW1lbnQgaW4gcmV0dXJuX3ZhbHVlcyhlbGVtZW50KToKICAgICAgICAgICAgICAgIHlpZWxkIHN1YmVsZW1lbnQKICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIE1hcHBpbmcpOgogICAgICAgIGZvciBlbGVtZW50IGluIG9iai5pdGVtcygpOgogICAgICAgICAgICBmb3Igc3ViZWxlbWVudCBpbiByZXR1cm5fdmFsdWVzKGVsZW1lbnRbMV0pOgogICAgICAgICAgICAgICAgeWllbGQgc3ViZWxlbWVudAogICAgZWxpZiBpc2luc3RhbmNlKG9iaiwgKGJvb2wsIE5vbmVUeXBlKSk6CiAgICAgICAgIyBUaGlzIG11c3QgY29tZSBiZWZvcmUgaW50IGJlY2F1c2UgYm9vbHMgYXJlIGFsc28gaW50cwogICAgICAgIHJldHVybgogICAgZWxpZiBpc2luc3RhbmNlKG9iaiwgTlVNQkVSVFlQRVMpOgogICAgICAgIHlpZWxkIHRvX25hdGl2ZShvYmosIG5vbnN0cmluZz0nc2ltcGxlcmVwcicpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignVW5rbm93biBwYXJhbWV0ZXIgdHlwZTogJXMsICVzJyAlICh0eXBlKG9iaiksIG9iaikpCgpkZWYgcmVtb3ZlX3ZhbHVlcyh2YWx1ZSwgbm9fbG9nX3N0cmluZ3MpOgogICAgIiIiIFJlbW92ZSBzdHJpbmdzIGluIG5vX2xvZ19zdHJpbmdzIGZyb20gdmFsdWUuICBJZiB2YWx1ZSBpcyBhIGNvbnRhaW5lcgogICAgdHlwZSwgdGhlbiByZW1vdmUgYSBsb3QgbW9yZSIiIgogICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICAjIE5lZWQgbmF0aXZlIHN0ciB0eXBlCiAgICAgICAgbmF0aXZlX3N0cl92YWx1ZSA9IHZhbHVlCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgdGV4dF90eXBlKToKICAgICAgICAgICAgdmFsdWVfaXNfdGV4dCA9IFRydWUKICAgICAgICAgICAgaWYgUFkyOgogICAgICAgICAgICAgICAgbmF0aXZlX3N0cl92YWx1ZSA9IHRvX2J5dGVzKHZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICB2YWx1ZV9pc190ZXh0ID0gRmFsc2UKICAgICAgICAgICAgaWYgUFkzOgogICAgICAgICAgICAgICAgbmF0aXZlX3N0cl92YWx1ZSA9IHRvX3RleHQodmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCgogICAgICAgIGlmIG5hdGl2ZV9zdHJfdmFsdWUgaW4gbm9fbG9nX3N0cmluZ3M6CiAgICAgICAgICAgIHJldHVybiAnVkFMVUVfU1BFQ0lGSUVEX0lOX05PX0xPR19QQVJBTUVURVInCiAgICAgICAgZm9yIG9taXRfbWUgaW4gbm9fbG9nX3N0cmluZ3M6CiAgICAgICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSBuYXRpdmVfc3RyX3ZhbHVlLnJlcGxhY2Uob21pdF9tZSwgJyonICogOCkKCiAgICAgICAgaWYgdmFsdWVfaXNfdGV4dCBhbmQgaXNpbnN0YW5jZShuYXRpdmVfc3RyX3ZhbHVlLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgIHZhbHVlID0gdG9fdGV4dChuYXRpdmVfc3RyX3ZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKQogICAgICAgIGVsaWYgbm90IHZhbHVlX2lzX3RleHQgYW5kIGlzaW5zdGFuY2UobmF0aXZlX3N0cl92YWx1ZSwgdGV4dF90eXBlKToKICAgICAgICAgICAgdmFsdWUgPSB0b19ieXRlcyhuYXRpdmVfc3RyX3ZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHZhbHVlID0gbmF0aXZlX3N0cl92YWx1ZQogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBTRVFVRU5DRVRZUEUpOgogICAgICAgIHJldHVybiBbcmVtb3ZlX3ZhbHVlcyhlbGVtLCBub19sb2dfc3RyaW5ncykgZm9yIGVsZW0gaW4gdmFsdWVdCiAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIE1hcHBpbmcpOgogICAgICAgIHJldHVybiBkaWN0KChrLCByZW1vdmVfdmFsdWVzKHYsIG5vX2xvZ19zdHJpbmdzKSkgZm9yIGssIHYgaW4gdmFsdWUuaXRlbXMoKSkKICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgdHVwbGUoY2hhaW4oTlVNQkVSVFlQRVMsIChib29sLCBOb25lVHlwZSkpKSk6CiAgICAgICAgc3RyaW5neV92YWx1ZSA9IHRvX25hdGl2ZSh2YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBpZiBzdHJpbmd5X3ZhbHVlIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICByZXR1cm4gJ1ZBTFVFX1NQRUNJRklFRF9JTl9OT19MT0dfUEFSQU1FVEVSJwogICAgICAgIGZvciBvbWl0X21lIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICBpZiBvbWl0X21lIGluIHN0cmluZ3lfdmFsdWU6CiAgICAgICAgICAgICAgICByZXR1cm4gJ1ZBTFVFX1NQRUNJRklFRF9JTl9OT19MT0dfUEFSQU1FVEVSJwogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBkYXRldGltZS5kYXRldGltZSk6CiAgICAgICAgdmFsdWUgPSB2YWx1ZS5pc29mb3JtYXQoKQogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ1ZhbHVlIG9mIHVua25vd24gdHlwZTogJXMsICVzJyAlICh0eXBlKHZhbHVlKSwgdmFsdWUpKQogICAgcmV0dXJuIHZhbHVlCgoKZGVmIGhldXJpc3RpY19sb2dfc2FuaXRpemUoZGF0YSwgbm9fbG9nX3ZhbHVlcz1Ob25lKToKICAgICcnJyBSZW1vdmUgc3RyaW5ncyB0aGF0IGxvb2sgbGlrZSBwYXNzd29yZHMgZnJvbSBsb2cgbWVzc2FnZXMgJycnCiAgICAjIEN1cnJlbnRseSBmaWx0ZXJzOgogICAgIyB1c2VyOnBhc3NAZm9vL3doYXRldmVyIGFuZCBodHRwOi8vdXNlcm5hbWU6cGFzc0B3aGVyZXZlci9mb28KICAgICMgVGhpcyBjb2RlIGhhcyBmYWxzZSBwb3NpdGl2ZXMgYW5kIGNvbnN1bWVzIHBhcnRzIG9mIGxvZ3MgdGhhdCBhcmUKICAgICMgbm90IHBhc3N3ZHMKCiAgICAjIGJlZ2luOiBzdGFydCBvZiBhIHBhc3N3ZCBjb250YWluaW5nIHN0cmluZwogICAgIyBlbmQ6IGVuZCBvZiBhIHBhc3N3ZCBjb250YWluaW5nIHN0cmluZwogICAgIyBzZXA6IGNoYXIgYmV0d2VlbiB1c2VyIGFuZCBwYXNzd2QKICAgICMgcHJldl9iZWdpbjogd2hlcmUgaW4gdGhlIG92ZXJhbGwgc3RyaW5nIHRvIHN0YXJ0IGEgc2VhcmNoIGZvcgogICAgIyAgIGEgcGFzc3dkCiAgICAjIHNlcF9zZWFyY2hfZW5kOiB3aGVyZSBpbiB0aGUgc3RyaW5nIHRvIGVuZCBhIHNlYXJjaCBmb3IgdGhlIHNlcAogICAgZGF0YSA9IHRvX25hdGl2ZShkYXRhKQoKICAgIG91dHB1dCA9IFtdCiAgICBiZWdpbiA9IGxlbihkYXRhKQogICAgcHJldl9iZWdpbiA9IGJlZ2luCiAgICBzZXAgPSAxCiAgICB3aGlsZSBzZXA6CiAgICAgICAgIyBGaW5kIHRoZSBwb3RlbnRpYWwgZW5kIG9mIGEgcGFzc3dkCiAgICAgICAgdHJ5OgogICAgICAgICAgICBlbmQgPSBkYXRhLnJpbmRleCgnQCcsIDAsIGJlZ2luKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAjIE5vIHBhc3N3ZCBpbiB0aGUgcmVzdCBvZiB0aGUgZGF0YQogICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsIGRhdGFbMDpiZWdpbl0pCiAgICAgICAgICAgIGJyZWFrCgogICAgICAgICMgU2VhcmNoIGZvciB0aGUgYmVnaW5uaW5nIG9mIGEgcGFzc3dkCiAgICAgICAgc2VwID0gTm9uZQogICAgICAgIHNlcF9zZWFyY2hfZW5kID0gZW5kCiAgICAgICAgd2hpbGUgbm90IHNlcDoKICAgICAgICAgICAgIyBVUkwtc3R5bGUgdXNlcm5hbWUrcGFzc3dvcmQKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYmVnaW4gPSBkYXRhLnJpbmRleCgnOi8vJywgMCwgc2VwX3NlYXJjaF9lbmQpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgIyBObyB1cmwgc3R5bGUgaW4gdGhlIGRhdGEsIGNoZWNrIGZvciBzc2ggc3R5bGUgaW4gdGhlCiAgICAgICAgICAgICAgICAjIHJlc3Qgb2YgdGhlIHN0cmluZwogICAgICAgICAgICAgICAgYmVnaW4gPSAwCiAgICAgICAgICAgICMgU2VhcmNoIGZvciBzZXBhcmF0b3IKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VwID0gZGF0YS5pbmRleCgnOicsIGJlZ2luICsgMywgZW5kKQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICMgTm8gc2VwYXJhdG9yOyBjaG9pY2VzOgogICAgICAgICAgICAgICAgaWYgYmVnaW4gPT0gMDoKICAgICAgICAgICAgICAgICAgICAjIFNlYXJjaGVkIHRoZSB3aG9sZSBzdHJpbmcgc28gdGhlcmUncyBubyBwYXNzd29yZAogICAgICAgICAgICAgICAgICAgICMgaGVyZS4gIFJldHVybiB0aGUgcmVtYWluaW5nIGRhdGEKICAgICAgICAgICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsIGRhdGFbMDpiZWdpbl0pCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICMgU2VhcmNoIGZvciBhIGRpZmZlcmVudCBiZWdpbm5pbmcgb2YgdGhlIHBhc3N3b3JkIGZpZWxkLgogICAgICAgICAgICAgICAgc2VwX3NlYXJjaF9lbmQgPSBiZWdpbgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICBpZiBzZXA6CiAgICAgICAgICAgICMgUGFzc3dvcmQgd2FzIGZvdW5kOyByZW1vdmUgaXQuCiAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgZGF0YVtlbmQ6cHJldl9iZWdpbl0pCiAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgJyoqKioqKioqJykKICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCBkYXRhW2JlZ2luOnNlcCArIDFdKQogICAgICAgICAgICBwcmV2X2JlZ2luID0gYmVnaW4KCiAgICBvdXRwdXQgPSAnJy5qb2luKG91dHB1dCkKICAgIGlmIG5vX2xvZ192YWx1ZXM6CiAgICAgICAgb3V0cHV0ID0gcmVtb3ZlX3ZhbHVlcyhvdXRwdXQsIG5vX2xvZ192YWx1ZXMpCiAgICByZXR1cm4gb3V0cHV0CgpkZWYgYnl0ZXNfdG9faHVtYW4oc2l6ZSwgaXNiaXRzPUZhbHNlLCB1bml0PU5vbmUpOgoKICAgIGJhc2UgPSAnQnl0ZXMnCiAgICBpZiBpc2JpdHM6CiAgICAgICAgYmFzZSA9ICdiaXRzJwogICAgc3VmZml4ID0gJycKCiAgICBmb3Igc3VmZml4LCBsaW1pdCBpbiBzb3J0ZWQoaXRlcml0ZW1zKFNJWkVfUkFOR0VTKSwga2V5PWxhbWJkYSBpdGVtOiAtaXRlbVsxXSk6CiAgICAgICAgaWYgKHVuaXQgaXMgTm9uZSBhbmQgc2l6ZSA+PSBsaW1pdCkgb3IgdW5pdCBpcyBub3QgTm9uZSBhbmQgdW5pdC51cHBlcigpID09IHN1ZmZpeFswXToKICAgICAgICAgICAgYnJlYWsKCiAgICBpZiBsaW1pdCAhPSAxOgogICAgICAgIHN1ZmZpeCArPSBiYXNlWzBdCiAgICBlbHNlOgogICAgICAgIHN1ZmZpeCA9IGJhc2UKCiAgICByZXR1cm4gJyUuMmYgJXMnICUgKGZsb2F0KHNpemUpLyBsaW1pdCwgc3VmZml4KQoKZGVmIGh1bWFuX3RvX2J5dGVzKG51bWJlciwgZGVmYXVsdF91bml0PU5vbmUsIGlzYml0cz1GYWxzZSk6CgogICAgJycnCiAgICBDb252ZXJ0IG51bWJlciBpbiBzdHJpbmcgZm9ybWF0IGludG8gYnl0ZXMgKGV4OiAnMksnID0+IDIwNDgpIG9yIHVzaW5nIHVuaXQgYXJndW1lbnQKICAgIGV4OgogICAgICBodW1hbl90b19ieXRlcygnMTBNJykgPD0+IGh1bWFuX3RvX2J5dGVzKDEwLCAnTScpCiAgICAnJycKICAgIG0gPSByZS5zZWFyY2goJ15ccyooXGQqXC4/XGQqKVxzKihbQS1aYS16XSspPycsIHN0cihudW1iZXIpLCBmbGFncz1yZS5JR05PUkVDQVNFKQogICAgaWYgbSBpcyBOb25lOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgY2FuJ3QgaW50ZXJwcmV0IGZvbGxvd2luZyBzdHJpbmc6ICVzIiAlIHN0cihudW1iZXIpKQogICAgdHJ5OgogICAgICAgIG51bSA9IGZsb2F0KG0uZ3JvdXAoMSkpCiAgICBleGNlcHQ6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaHVtYW5fdG9fYnl0ZXMoKSBjYW4ndCBpbnRlcnByZXQgZm9sbG93aW5nIG51bWJlcjogJXMgKG9yaWdpbmFsIGlucHV0IHN0cmluZzogJXMpIiAlIChtLmdyb3VwKDEpLCBudW1iZXIpKQoKICAgIHVuaXQgPSBtLmdyb3VwKDIpCiAgICBpZiB1bml0IGlzIE5vbmU6CiAgICAgICAgdW5pdCA9IGRlZmF1bHRfdW5pdAoKICAgIGlmIHVuaXQgaXMgTm9uZToKICAgICAgICAnJycgTm8gdW5pdCBnaXZlbiwgcmV0dXJuaW5nIHJhdyBudW1iZXIgJycnCiAgICAgICAgcmV0dXJuIGludChyb3VuZChudW0pKQogICAgcmFuZ2Vfa2V5ID0gdW5pdFswXS51cHBlcigpCiAgICB0cnk6CiAgICAgICAgbGltaXQgPSBTSVpFX1JBTkdFU1tyYW5nZV9rZXldCiAgICBleGNlcHQ6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaHVtYW5fdG9fYnl0ZXMoKSBmYWlsZWQgdG8gY29udmVydCAlcyAodW5pdCA9ICVzKS4gVGhlIHN1ZmZpeCBtdXN0IGJlIG9uZSBvZiAlcyIgJSAobnVtYmVyLCB1bml0LCAiLCAiLmpvaW4oU0laRV9SQU5HRVMua2V5cygpKSkpCgogICAgIyBkZWZhdWx0IHZhbHVlCiAgICB1bml0X2NsYXNzID0gJ0InCiAgICB1bml0X2NsYXNzX25hbWUgPSAnYnl0ZScKICAgICMgaGFuZGxpbmcgYml0cyBjYXNlCiAgICBpZiBpc2JpdHM6CiAgICAgICAgdW5pdF9jbGFzcyA9ICdiJwogICAgICAgIHVuaXRfY2xhc3NfbmFtZSA9ICdiaXQnCiAgICAjIGNoZWNrIHVuaXQgdmFsdWUgaWYgbW9yZSB0aGFuIG9uZSBjaGFyYWN0ZXIgKEtCLCBNQikKICAgIGlmIGxlbih1bml0KSA+IDE6CiAgICAgICAgZXhwZWN0X21lc3NhZ2UgPSAnZXhwZWN0ICVzJXMgb3IgJXMnICUgKHJhbmdlX2tleSwgdW5pdF9jbGFzcywgcmFuZ2Vfa2V5KQogICAgICAgIGlmIHJhbmdlX2tleSA9PSAnQic6CiAgICAgICAgICAgIGV4cGVjdF9tZXNzYWdlID0gJ2V4cGVjdCAlcyBvciAlcycgJSAodW5pdF9jbGFzcywgdW5pdF9jbGFzc19uYW1lKQoKICAgICAgICBpZiB1bml0X2NsYXNzX25hbWUgaW4gdW5pdC5sb3dlcigpOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxpZiB1bml0WzFdICE9IHVuaXRfY2xhc3M6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgZmFpbGVkIHRvIGNvbnZlcnQgJXMuIFZhbHVlIGlzIG5vdCBhIHZhbGlkIHN0cmluZyAoJXMpIiAlIChudW1iZXIsIGV4cGVjdF9tZXNzYWdlKSkKCiAgICByZXR1cm4gaW50KHJvdW5kKG51bSAqIGxpbWl0KSkKCmRlZiBpc19leGVjdXRhYmxlKHBhdGgpOgogICAgJycnaXMgdGhlIGdpdmVuIHBhdGggZXhlY3V0YWJsZT8KCiAgICBMaW1pdGF0aW9uczoKICAgICogRG9lcyBub3QgYWNjb3VudCBmb3IgRlNBQ0xzLgogICAgKiBNb3N0IHRpbWVzIHdlIHJlYWxseSB3YW50IHRvIGtub3cgIkNhbiB0aGUgY3VycmVudCB1c2VyIGV4ZWN1dGUgdGhpcwogICAgICBmaWxlIiAgVGhpcyBmdW5jdGlvbiBkb2VzIG5vdCB0ZWxsIHVzIHRoYXQsIG9ubHkgaWYgYW4gZXhlY3V0ZSBiaXQgaXMgc2V0LgogICAgJycnCiAgICAjIFRoZXNlIGFyZSBhbGwgYml0ZmllbGRzIHNvIGZpcnN0IGJpdHdpc2Utb3IgYWxsIHRoZSBwZXJtaXNzaW9ucyB3ZSdyZQogICAgIyBsb29raW5nIGZvciwgdGhlbiBiaXR3aXNlLWFuZCB3aXRoIHRoZSBmaWxlJ3MgbW9kZSB0byBkZXRlcm1pbmUgaWYgYW55CiAgICAjIGV4ZWN1dGUgYml0cyBhcmUgc2V0LgogICAgcmV0dXJuICgoc3RhdC5TX0lYVVNSIHwgc3RhdC5TX0lYR1JQIHwgc3RhdC5TX0lYT1RIKSAmIG9zLnN0YXQocGF0aClbc3RhdC5TVF9NT0RFXSkKCmRlZiBfbG9hZF9wYXJhbXMoKToKICAgICcnJyByZWFkIHRoZSBtb2R1bGVzIHBhcmFtZXRlcnMgYW5kIHN0b3JlIHRoZW0gZ2xvYmFsbHkuCgogICAgVGhpcyBmdW5jdGlvbiBtYXkgYmUgbmVlZGVkIGZvciBjZXJ0YWluIHZlcnkgZHluYW1pYyBjdXN0b20gbW9kdWxlcyB3aGljaAogICAgd2FudCB0byBwcm9jZXNzIHRoZSBwYXJhbWV0ZXJzIHRoYXQgYXJlIGJlaW5nIGhhbmRlZCB0aGUgbW9kdWxlLiAgU2luY2UKICAgIHRoaXMgaXMgc28gY2xvc2VseSB0aWVkIHRvIHRoZSBpbXBsZW1lbnRhdGlvbiBvZiBtb2R1bGVzIHdlIGNhbm5vdAogICAgZ3VhcmFudGVlIEFQSSBzdGFiaWxpdHkgZm9yIGl0IChpdCBtYXkgY2hhbmdlIGJldHdlZW4gdmVyc2lvbnMpIGhvd2V2ZXIgd2UKICAgIHdpbGwgdHJ5IG5vdCB0byBicmVhayBpdCBncmF0dWl0b3VzbHkuICBJdCBpcyBjZXJ0YWlubHkgbW9yZSBmdXR1cmUtcHJvb2YKICAgIHRvIGNhbGwgdGhpcyBmdW5jdGlvbiBhbmQgY29uc3VtZSBpdHMgb3V0cHV0cyB0aGFuIHRvIGltcGxlbWVudCB0aGUgbG9naWMKICAgIGluc2lkZSBpdCBhcyBhIGNvcHkgaW4geW91ciBvd24gY29kZS4KICAgICcnJwogICAgZ2xvYmFsIF9BTlNJQkxFX0FSR1MKICAgIGlmIF9BTlNJQkxFX0FSR1MgaXMgbm90IE5vbmU6CiAgICAgICAgYnVmZmVyID0gX0FOU0lCTEVfQVJHUwogICAgZWxzZToKICAgICAgICAjIGRlYnVnIG92ZXJyaWRlcyB0byByZWFkIGFyZ3MgZnJvbSBmaWxlIG9yIGNtZGxpbmUKCiAgICAgICAgIyBBdm9pZCB0cmFjZWJhY2tzIHdoZW4gbG9jYWxlIGlzIG5vbi11dGY4CiAgICAgICAgIyBXZSBjb250cm9sIHRoZSBhcmdzIGFuZCB3ZSBwYXNzIHRoZW0gYXMgdXRmOAogICAgICAgIGlmIGxlbihzeXMuYXJndikgPiAxOgogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShzeXMuYXJndlsxXSk6CiAgICAgICAgICAgICAgICBmZCA9IG9wZW4oc3lzLmFyZ3ZbMV0sICdyYicpCiAgICAgICAgICAgICAgICBidWZmZXIgPSBmZC5yZWFkKCkKICAgICAgICAgICAgICAgIGZkLmNsb3NlKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHN5cy5hcmd2WzFdCiAgICAgICAgICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gYnVmZmVyLmVuY29kZSgndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZWVzY2FwZScpCiAgICAgICAgIyBkZWZhdWx0IGNhc2UsIHJlYWQgZnJvbSBzdGRpbgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHN5cy5zdGRpbi5yZWFkKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHN5cy5zdGRpbi5idWZmZXIucmVhZCgpCiAgICAgICAgX0FOU0lCTEVfQVJHUyA9IGJ1ZmZlcgoKICAgIHRyeToKICAgICAgICBwYXJhbXMgPSBqc29uLmxvYWRzKGJ1ZmZlci5kZWNvZGUoJ3V0Zi04JykpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAjIFRoaXMgaGVscGVyIHVzZWQgdG9vIGVhcmx5IGZvciBmYWlsX2pzb24gdG8gd29yay4KICAgICAgICBwcmludCgnXG57Im1zZyI6ICJFcnJvcjogTW9kdWxlIHVuYWJsZSB0byBkZWNvZGUgdmFsaWQgSlNPTiBvbiBzdGRpbi4gIFVuYWJsZSB0byBmaWd1cmUgb3V0IHdoYXQgcGFyYW1ldGVycyB3ZXJlIHBhc3NlZCIsICJmYWlsZWQiOiB0cnVlfScpCiAgICAgICAgc3lzLmV4aXQoMSkKCiAgICBpZiBQWTI6CiAgICAgICAgcGFyYW1zID0ganNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMocGFyYW1zKQoKICAgIHRyeToKICAgICAgICByZXR1cm4gcGFyYW1zWydBTlNJQkxFX01PRFVMRV9BUkdTJ10KICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAjIFRoaXMgaGVscGVyIGRvZXMgbm90IGhhdmUgYWNjZXNzIHRvIGZhaWxfanNvbiBzbyB3ZSBoYXZlIHRvIHByaW50CiAgICAgICAgIyBqc29uIG91dHB1dCBvbiBvdXIgb3duLgogICAgICAgIHByaW50KCdcbnsibXNnIjogIkVycm9yOiBNb2R1bGUgdW5hYmxlIHRvIGxvY2F0ZSBBTlNJQkxFX01PRFVMRV9BUkdTIGluIGpzb24gZGF0YSBmcm9tIHN0ZGluLiAgVW5hYmxlIHRvIGZpZ3VyZSBvdXQgd2hhdCBwYXJhbWV0ZXJzIHdlcmUgcGFzc2VkIiwgJwogICAgICAgICAgICAgICciZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCgpkZWYgZW52X2ZhbGxiYWNrKCphcmdzLCAqKmt3YXJncyk6CiAgICAnJycgTG9hZCB2YWx1ZSBmcm9tIGVudmlyb25tZW50ICcnJwogICAgZm9yIGFyZyBpbiBhcmdzOgogICAgICAgIGlmIGFyZyBpbiBvcy5lbnZpcm9uOgogICAgICAgICAgICByZXR1cm4gb3MuZW52aXJvblthcmddCiAgICBlbHNlOgogICAgICAgIHJhaXNlIEFuc2libGVGYWxsYmFja05vdEZvdW5kCgpkZWYgX2xlbmllbnRfbG93ZXJjYXNlKGxzdCk6CiAgICAiIiJMb3dlcmNhc2UgZWxlbWVudHMgb2YgYSBsaXN0LgoKICAgIElmIGFuIGVsZW1lbnQgaXMgbm90IGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggdW50b3VjaGVkLgogICAgIiIiCiAgICBsb3dlcmVkID0gW10KICAgIGZvciB2YWx1ZSBpbiBsc3Q6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb3dlcmVkLmFwcGVuZCh2YWx1ZS5sb3dlcigpKQogICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgbG93ZXJlZC5hcHBlbmQodmFsdWUpCiAgICByZXR1cm4gbG93ZXJlZAoKZGVmIGZvcm1hdF9hdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpOgogICAgYXR0cmlidXRlX2xpc3QgPSBbXQogICAgZm9yIGF0dHIgaW4gYXR0cmlidXRlczoKICAgICAgICBpZiBhdHRyIGluIEZJTEVfQVRUUklCVVRFUzoKICAgICAgICAgICAgYXR0cmlidXRlX2xpc3QuYXBwZW5kKEZJTEVfQVRUUklCVVRFU1thdHRyXSkKICAgIHJldHVybiBhdHRyaWJ1dGVfbGlzdAoKZGVmIGdldF9mbGFnc19mcm9tX2F0dHJpYnV0ZXMoYXR0cmlidXRlcyk6CiAgICBmbGFncyA9IFtdCiAgICBmb3Iga2V5LGF0dHIgaW4gRklMRV9BVFRSSUJVVEVTLml0ZW1zKCk6CiAgICAgICAgaWYgYXR0ciBpbiBhdHRyaWJ1dGVzOgogICAgICAgICAgICBmbGFncy5hcHBlbmQoa2V5KQogICAgcmV0dXJuICcnLmpvaW4oZmxhZ3MpCgpjbGFzcyBBbnNpYmxlRmFsbGJhY2tOb3RGb3VuZChFeGNlcHRpb24pOgogICAgcGFzcwoKCmNsYXNzIEFuc2libGVNb2R1bGUob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhcmd1bWVudF9zcGVjLCBieXBhc3NfY2hlY2tzPUZhbHNlLCBub19sb2c9RmFsc2UsCiAgICAgICAgICAgICAgICAgY2hlY2tfaW52YWxpZF9hcmd1bWVudHM9VHJ1ZSwgbXV0dWFsbHlfZXhjbHVzaXZlPU5vbmUsIHJlcXVpcmVkX3RvZ2V0aGVyPU5vbmUsCiAgICAgICAgICAgICAgICAgcmVxdWlyZWRfb25lX29mPU5vbmUsIGFkZF9maWxlX2NvbW1vbl9hcmdzPUZhbHNlLCBzdXBwb3J0c19jaGVja19tb2RlPUZhbHNlLAogICAgICAgICAgICAgICAgIHJlcXVpcmVkX2lmPU5vbmUpOgoKICAgICAgICAnJycKICAgICAgICBjb21tb24gY29kZSBmb3IgcXVpY2tseSBidWlsZGluZyBhbiBhbnNpYmxlIG1vZHVsZSBpbiBQeXRob24KICAgICAgICAoYWx0aG91Z2ggeW91IGNhbiB3cml0ZSBtb2R1bGVzIGluIGFueXRoaW5nIHRoYXQgY2FuIHJldHVybiBKU09OKQogICAgICAgIHNlZSBsaWJyYXJ5LyogZm9yIGV4YW1wbGVzCiAgICAgICAgJycnCgogICAgICAgIHNlbGYuX25hbWUgPSBvcy5wYXRoLmJhc2VuYW1lKF9fZmlsZV9fKSAjaW5pdGlhbGl6ZSBuYW1lIHVudGlsIHdlIGNhbiBwYXJzZSBmcm9tIG9wdGlvbnMKICAgICAgICBzZWxmLmFyZ3VtZW50X3NwZWMgPSBhcmd1bWVudF9zcGVjCiAgICAgICAgc2VsZi5zdXBwb3J0c19jaGVja19tb2RlID0gc3VwcG9ydHNfY2hlY2tfbW9kZQogICAgICAgIHNlbGYuY2hlY2tfbW9kZSA9IEZhbHNlCiAgICAgICAgc2VsZi5ub19sb2cgPSBub19sb2cKICAgICAgICBzZWxmLmNsZWFudXBfZmlsZXMgPSBbXQogICAgICAgIHNlbGYuX2RlYnVnID0gRmFsc2UKICAgICAgICBzZWxmLl9kaWZmID0gRmFsc2UKICAgICAgICBzZWxmLl9zb2NrZXRfcGF0aCA9IE5vbmUKICAgICAgICBzZWxmLl92ZXJib3NpdHkgPSAwCiAgICAgICAgIyBNYXkgYmUgdXNlZCB0byBzZXQgbW9kaWZpY2F0aW9ucyB0byB0aGUgZW52aXJvbm1lbnQgZm9yIGFueQogICAgICAgICMgcnVuX2NvbW1hbmQgaW52b2NhdGlvbgogICAgICAgIHNlbGYucnVuX2NvbW1hbmRfZW52aXJvbl91cGRhdGUgPSB7fQogICAgICAgIHNlbGYuX3dhcm5pbmdzID0gW10KICAgICAgICBzZWxmLl9kZXByZWNhdGlvbnMgPSBbXQoKICAgICAgICBzZWxmLmFsaWFzZXMgPSB7fQogICAgICAgIHNlbGYuX2xlZ2FsX2lucHV0cyA9IFsnX2Fuc2libGVfY2hlY2tfbW9kZScsICdfYW5zaWJsZV9ub19sb2cnLCAnX2Fuc2libGVfZGVidWcnLCAnX2Fuc2libGVfZGlmZicsICdfYW5zaWJsZV92ZXJib3NpdHknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnX2Fuc2libGVfc2VsaW51eF9zcGVjaWFsX2ZzJywgJ19hbnNpYmxlX21vZHVsZV9uYW1lJywgJ19hbnNpYmxlX3ZlcnNpb24nLCAnX2Fuc2libGVfc3lzbG9nX2ZhY2lsaXR5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ19hbnNpYmxlX3NvY2tldCddCgogICAgICAgIGlmIGFkZF9maWxlX2NvbW1vbl9hcmdzOgogICAgICAgICAgICBmb3IgaywgdiBpbiBGSUxFX0NPTU1PTl9BUkdVTUVOVFMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGsgbm90IGluIHNlbGYuYXJndW1lbnRfc3BlYzoKICAgICAgICAgICAgICAgICAgICBzZWxmLmFyZ3VtZW50X3NwZWNba10gPSB2CgogICAgICAgIHNlbGYuX2xvYWRfcGFyYW1zKCkKICAgICAgICBzZWxmLl9zZXRfZmFsbGJhY2tzKCkKCiAgICAgICAgIyBhcHBlbmQgdG8gbGVnYWxfaW5wdXRzIGFuZCB0aGVuIHBvc3NpYmx5IGNoZWNrIGFnYWluc3QgdGhlbQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5hbGlhc2VzID0gc2VsZi5faGFuZGxlX2FsaWFzZXMoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgIyBVc2UgZXhjZXB0aW9ucyBoZXJlIGJlY2F1c2UgaXQgaXNuJ3Qgc2FmZSB0byBjYWxsIGZhaWxfanNvbiB1bnRpbCBub19sb2cgaXMgcHJvY2Vzc2VkCiAgICAgICAgICAgIHByaW50KCdcbnsiZmFpbGVkIjogdHJ1ZSwgIm1zZyI6ICJNb2R1bGUgYWxpYXMgZXJyb3I6ICVzIn0nICUgc3RyKGUpKQogICAgICAgICAgICBzeXMuZXhpdCgxKQoKICAgICAgICAjIFNhdmUgcGFyYW1ldGVyIHZhbHVlcyB0aGF0IHNob3VsZCBuZXZlciBiZSBsb2dnZWQKICAgICAgICBzZWxmLm5vX2xvZ192YWx1ZXMgPSBzZXQoKQogICAgICAgICMgVXNlIHRoZSBhcmdzcGVjIHRvIGRldGVybWluZSB3aGljaCBhcmdzIGFyZSBub19sb2cKICAgICAgICBmb3IgYXJnX25hbWUsIGFyZ19vcHRzIGluIHNlbGYuYXJndW1lbnRfc3BlYy5pdGVtcygpOgogICAgICAgICAgICBpZiBhcmdfb3B0cy5nZXQoJ25vX2xvZycsIEZhbHNlKToKICAgICAgICAgICAgICAgICMgRmluZCB0aGUgdmFsdWUgZm9yIHRoZSBub19sb2cnZCBwYXJhbQogICAgICAgICAgICAgICAgbm9fbG9nX29iamVjdCA9IHNlbGYucGFyYW1zLmdldChhcmdfbmFtZSwgTm9uZSkKICAgICAgICAgICAgICAgIGlmIG5vX2xvZ19vYmplY3Q6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5ub19sb2dfdmFsdWVzLnVwZGF0ZShyZXR1cm5fdmFsdWVzKG5vX2xvZ19vYmplY3QpKQoKICAgICAgICAgICAgaWYgYXJnX29wdHMuZ2V0KCdyZW1vdmVkX2luX3ZlcnNpb24nKSBpcyBub3QgTm9uZSBhbmQgYXJnX25hbWUgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICBzZWxmLl9kZXByZWNhdGlvbnMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAnbXNnJzogIlBhcmFtICclcycgaXMgZGVwcmVjYXRlZC4gU2VlIHRoZSBtb2R1bGUgZG9jcyBmb3IgbW9yZSBpbmZvcm1hdGlvbiIgJSBhcmdfbmFtZSwKICAgICAgICAgICAgICAgICAgICAndmVyc2lvbic6IGFyZ19vcHRzLmdldCgncmVtb3ZlZF9pbl92ZXJzaW9uJykKICAgICAgICAgICAgICAgIH0pCgogICAgICAgICMgY2hlY2sgdGhlIGxvY2FsZSBhcyBzZXQgYnkgdGhlIGN1cnJlbnQgZW52aXJvbm1lbnQsIGFuZCByZXNldCB0bwogICAgICAgICMgYSBrbm93biB2YWxpZCAoTEFORz1DKSBpZiBpdCdzIGFuIGludmFsaWQvdW5hdmFpbGFibGUgbG9jYWxlCiAgICAgICAgc2VsZi5fY2hlY2tfbG9jYWxlKCkKCiAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRzKGNoZWNrX2ludmFsaWRfYXJndW1lbnRzKQoKICAgICAgICAjIGNoZWNrIGV4Y2x1c2l2ZSBlYXJseQogICAgICAgIGlmIG5vdCBieXBhc3NfY2hlY2tzOgogICAgICAgICAgICBzZWxmLl9jaGVja19tdXR1YWxseV9leGNsdXNpdmUobXV0dWFsbHlfZXhjbHVzaXZlKQoKICAgICAgICBzZWxmLl9zZXRfZGVmYXVsdHMocHJlPVRydWUpCgogICAgICAgIHNlbGYuX0NIRUNLX0FSR1VNRU5UX1RZUEVTX0RJU1BBVENIRVIgPSB7CiAgICAgICAgICAgICdzdHInOiBzZWxmLl9jaGVja190eXBlX3N0ciwKICAgICAgICAgICAgJ2xpc3QnOiBzZWxmLl9jaGVja190eXBlX2xpc3QsCiAgICAgICAgICAgICdkaWN0Jzogc2VsZi5fY2hlY2tfdHlwZV9kaWN0LAogICAgICAgICAgICAnYm9vbCc6IHNlbGYuX2NoZWNrX3R5cGVfYm9vbCwKICAgICAgICAgICAgJ2ludCc6IHNlbGYuX2NoZWNrX3R5cGVfaW50LAogICAgICAgICAgICAnZmxvYXQnOiBzZWxmLl9jaGVja190eXBlX2Zsb2F0LAogICAgICAgICAgICAncGF0aCc6IHNlbGYuX2NoZWNrX3R5cGVfcGF0aCwKICAgICAgICAgICAgJ3Jhdyc6IHNlbGYuX2NoZWNrX3R5cGVfcmF3LAogICAgICAgICAgICAnanNvbmFyZyc6IHNlbGYuX2NoZWNrX3R5cGVfanNvbmFyZywKICAgICAgICAgICAgJ2pzb24nOiBzZWxmLl9jaGVja190eXBlX2pzb25hcmcsCiAgICAgICAgICAgICdieXRlcyc6IHNlbGYuX2NoZWNrX3R5cGVfYnl0ZXMsCiAgICAgICAgICAgICdiaXRzJzogc2VsZi5fY2hlY2tfdHlwZV9iaXRzLAogICAgICAgIH0KICAgICAgICBpZiBub3QgYnlwYXNzX2NoZWNrczoKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfYXJndW1lbnRzKCkKICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdHlwZXMoKQogICAgICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudF92YWx1ZXMoKQogICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF90b2dldGhlcihyZXF1aXJlZF90b2dldGhlcikKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfb25lX29mKHJlcXVpcmVkX29uZV9vZikKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfaWYocmVxdWlyZWRfaWYpCgogICAgICAgIHNlbGYuX3NldF9kZWZhdWx0cyhwcmU9RmFsc2UpCgogICAgICAgIGlmIG5vdCBzZWxmLm5vX2xvZzoKICAgICAgICAgICAgc2VsZi5fbG9nX2ludm9jYXRpb24oKQoKICAgICAgICAjIGZpbmFsbHksIG1ha2Ugc3VyZSB3ZSdyZSBpbiBhIHNhbmUgd29ya2luZyBkaXIKICAgICAgICBzZWxmLl9zZXRfY3dkKCkKCiAgICBkZWYgd2FybihzZWxmLCB3YXJuaW5nKToKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh3YXJuaW5nLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBzZWxmLl93YXJuaW5ncy5hcHBlbmQod2FybmluZykKICAgICAgICAgICAgc2VsZi5sb2coJ1tXQVJOSU5HXSAlcycgJSB3YXJuaW5nKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigid2FybiByZXF1aXJlcyBhIHN0cmluZyBub3QgYSAlcyIgJSB0eXBlKHdhcm5pbmcpKQoKICAgIGRlZiBkZXByZWNhdGUoc2VsZiwgbXNnLCB2ZXJzaW9uPU5vbmUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UobXNnLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBzZWxmLl9kZXByZWNhdGlvbnMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICdtc2cnOiBtc2csCiAgICAgICAgICAgICAgICAndmVyc2lvbic6IHZlcnNpb24KICAgICAgICAgICAgfSkKICAgICAgICAgICAgc2VsZi5sb2coJ1tERVBSRUNBVElPTiBXQVJOSU5HXSAlcyAlcycgJSAobXNnLCB2ZXJzaW9uKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoImRlcHJlY2F0ZSByZXF1aXJlcyBhIHN0cmluZyBub3QgYSAlcyIgJSB0eXBlKG1zZykpCgogICAgZGVmIGxvYWRfZmlsZV9jb21tb25fYXJndW1lbnRzKHNlbGYsIHBhcmFtcyk6CiAgICAgICAgJycnCiAgICAgICAgbWFueSBtb2R1bGVzIGRlYWwgd2l0aCBmaWxlcywgdGhpcyBlbmNhcHN1bGF0ZXMgY29tbW9uCiAgICAgICAgb3B0aW9ucyB0aGF0IHRoZSBmaWxlIG1vZHVsZSBhY2NlcHRzIHN1Y2ggdGhhdCBpdCBpcyBkaXJlY3RseQogICAgICAgIGF2YWlsYWJsZSB0byBhbGwgbW9kdWxlcyBhbmQgdGhleSBjYW4gc2hhcmUgY29kZS4KICAgICAgICAnJycKCiAgICAgICAgcGF0aCA9IHBhcmFtcy5nZXQoJ3BhdGgnLCBwYXJhbXMuZ2V0KCdkZXN0JywgTm9uZSkpCiAgICAgICAgaWYgcGF0aCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4ge30KICAgICAgICBlbHNlOgogICAgICAgICAgICBwYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhwYXRoKSkKCiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICAjIGlmIHRoZSBwYXRoIGlzIGEgc3ltbGluaywgYW5kIHdlJ3JlIGZvbGxvd2luZyBsaW5rcywgZ2V0CiAgICAgICAgIyB0aGUgdGFyZ2V0IG9mIHRoZSBsaW5rIGluc3RlYWQgZm9yIHRlc3RpbmcKICAgICAgICBpZiBwYXJhbXMuZ2V0KCdmb2xsb3cnLCBGYWxzZSkgYW5kIG9zLnBhdGguaXNsaW5rKGJfcGF0aCk6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGgucmVhbHBhdGgoYl9wYXRoKQogICAgICAgICAgICBwYXRoID0gdG9fbmF0aXZlKGJfcGF0aCkKCiAgICAgICAgbW9kZSAgID0gcGFyYW1zLmdldCgnbW9kZScsIE5vbmUpCiAgICAgICAgb3duZXIgID0gcGFyYW1zLmdldCgnb3duZXInLCBOb25lKQogICAgICAgIGdyb3VwICA9IHBhcmFtcy5nZXQoJ2dyb3VwJywgTm9uZSkKCiAgICAgICAgIyBzZWxpbnV4IHJlbGF0ZWQgb3B0aW9ucwogICAgICAgIHNldXNlciAgICA9IHBhcmFtcy5nZXQoJ3NldXNlcicsIE5vbmUpCiAgICAgICAgc2Vyb2xlICAgID0gcGFyYW1zLmdldCgnc2Vyb2xlJywgTm9uZSkKICAgICAgICBzZXR5cGUgICAgPSBwYXJhbXMuZ2V0KCdzZXR5cGUnLCBOb25lKQogICAgICAgIHNlbGV2ZWwgICA9IHBhcmFtcy5nZXQoJ3NlbGV2ZWwnLCBOb25lKQogICAgICAgIHNlY29udGV4dCA9IFtzZXVzZXIsIHNlcm9sZSwgc2V0eXBlXQoKICAgICAgICBpZiBzZWxmLnNlbGludXhfbWxzX2VuYWJsZWQoKToKICAgICAgICAgICAgc2Vjb250ZXh0LmFwcGVuZChzZWxldmVsKQoKICAgICAgICBkZWZhdWx0X3NlY29udGV4dCA9IHNlbGYuc2VsaW51eF9kZWZhdWx0X2NvbnRleHQocGF0aCkKICAgICAgICBmb3IgaSBpbiByYW5nZShsZW4oZGVmYXVsdF9zZWNvbnRleHQpKToKICAgICAgICAgICAgaWYgaSBpcyBub3QgTm9uZSBhbmQgc2Vjb250ZXh0W2ldID09ICdfZGVmYXVsdCc6CiAgICAgICAgICAgICAgICBzZWNvbnRleHRbaV0gPSBkZWZhdWx0X3NlY29udGV4dFtpXQoKICAgICAgICBhdHRyaWJ1dGVzID0gcGFyYW1zLmdldCgnYXR0cmlidXRlcycsIE5vbmUpCiAgICAgICAgcmV0dXJuIGRpY3QoCiAgICAgICAgICAgIHBhdGg9cGF0aCwgbW9kZT1tb2RlLCBvd25lcj1vd25lciwgZ3JvdXA9Z3JvdXAsCiAgICAgICAgICAgIHNldXNlcj1zZXVzZXIsIHNlcm9sZT1zZXJvbGUsIHNldHlwZT1zZXR5cGUsCiAgICAgICAgICAgIHNlbGV2ZWw9c2VsZXZlbCwgc2Vjb250ZXh0PXNlY29udGV4dCwgYXR0cmlidXRlcz1hdHRyaWJ1dGVzLAogICAgICAgICkKCgogICAgIyBEZXRlY3Qgd2hldGhlciB1c2luZyBzZWxpbnV4IHRoYXQgaXMgTUxTLWF3YXJlLgogICAgIyBXaGlsZSB0aGlzIG1lYW5zIHlvdSBjYW4gc2V0IHRoZSBsZXZlbC9yYW5nZSB3aXRoCiAgICAjIHNlbGludXgubHNldGZpbGVjb24oKSwgaXQgbWF5IG9yIG1heSBub3QgbWVhbiB0aGF0IHlvdQogICAgIyB3aWxsIGdldCB0aGUgc2VsZXZlbCBhcyBwYXJ0IG9mIHRoZSBjb250ZXh0IHJldHVybmVkCiAgICAjIGJ5IHNlbGludXgubGdldGZpbGVjb24oKS4KCiAgICBkZWYgc2VsaW51eF9tbHNfZW5hYmxlZChzZWxmKToKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBpZiBzZWxpbnV4LmlzX3NlbGludXhfbWxzX2VuYWJsZWQoKSA9PSAxOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBzZWxpbnV4X2VuYWJsZWQoc2VsZik6CiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWDoKICAgICAgICAgICAgc2VlbmFibGVkID0gc2VsZi5nZXRfYmluX3BhdGgoJ3NlbGludXhlbmFibGVkJykKICAgICAgICAgICAgaWYgc2VlbmFibGVkIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgKHJjLG91dCxlcnIpID0gc2VsZi5ydW5fY29tbWFuZChzZWVuYWJsZWQpCiAgICAgICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iQWJvcnRpbmcsIHRhcmdldCB1c2VzIHNlbGludXggYnV0IHB5dGhvbiBiaW5kaW5ncyAobGlic2VsaW51eC1weXRob24pIGFyZW4ndCBpbnN0YWxsZWQhIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgaWYgc2VsaW51eC5pc19zZWxpbnV4X2VuYWJsZWQoKSA9PSAxOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICMgRGV0ZXJtaW5lIHdoZXRoZXIgd2UgbmVlZCBhIHBsYWNlaG9sZGVyIGZvciBzZWxldmVsL21scwogICAgZGVmIHNlbGludXhfaW5pdGlhbF9jb250ZXh0KHNlbGYpOgogICAgICAgIGNvbnRleHQgPSBbTm9uZSwgTm9uZSwgTm9uZV0KICAgICAgICBpZiBzZWxmLnNlbGludXhfbWxzX2VuYWJsZWQoKToKICAgICAgICAgICAgY29udGV4dC5hcHBlbmQoTm9uZSkKICAgICAgICByZXR1cm4gY29udGV4dAoKICAgICMgSWYgc2VsaW51eCBmYWlscyB0byBmaW5kIGEgZGVmYXVsdCwgcmV0dXJuIGFuIGFycmF5IG9mIE5vbmUKICAgIGRlZiBzZWxpbnV4X2RlZmF1bHRfY29udGV4dChzZWxmLCBwYXRoLCBtb2RlPTApOgogICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfaW5pdGlhbF9jb250ZXh0KCkKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYIG9yIG5vdCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0ID0gc2VsaW51eC5tYXRjaHBhdGhjb24odG9fbmF0aXZlKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpLCBtb2RlKQogICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgIGlmIHJldFswXSA9PSAtMToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICAjIExpbWl0IHNwbGl0IHRvIDQgYmVjYXVzZSB0aGUgc2VsZXZlbCwgdGhlIGxhc3QgaW4gdGhlIGxpc3QsCiAgICAgICAgIyBtYXkgY29udGFpbiAnOicgY2hhcmFjdGVycwogICAgICAgIGNvbnRleHQgPSByZXRbMV0uc3BsaXQoJzonLCAzKQogICAgICAgIHJldHVybiBjb250ZXh0CgogICAgZGVmIHNlbGludXhfY29udGV4dChzZWxmLCBwYXRoKToKICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2luaXRpYWxfY29udGV4dCgpCiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldCA9IHNlbGludXgubGdldGZpbGVjb25fcmF3KHRvX25hdGl2ZShwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKSkKICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBpZiBlLmVycm5vID09IGVycm5vLkVOT0VOVDoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdwYXRoICVzIGRvZXMgbm90IGV4aXN0JyAlIHBhdGgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nZmFpbGVkIHRvIHJldHJpZXZlIHNlbGludXggY29udGV4dCcpCiAgICAgICAgaWYgcmV0WzBdID09IC0xOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgICMgTGltaXQgc3BsaXQgdG8gNCBiZWNhdXNlIHRoZSBzZWxldmVsLCB0aGUgbGFzdCBpbiB0aGUgbGlzdCwKICAgICAgICAjIG1heSBjb250YWluICc6JyBjaGFyYWN0ZXJzCiAgICAgICAgY29udGV4dCA9IHJldFsxXS5zcGxpdCgnOicsIDMpCiAgICAgICAgcmV0dXJuIGNvbnRleHQKCiAgICBkZWYgdXNlcl9hbmRfZ3JvdXAoc2VsZiwgcGF0aCwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBzdCA9IG9zLmxzdGF0KGJfcGF0aCkKICAgICAgICB1aWQgPSBzdC5zdF91aWQKICAgICAgICBnaWQgPSBzdC5zdF9naWQKICAgICAgICByZXR1cm4gKHVpZCwgZ2lkKQoKICAgIGRlZiBmaW5kX21vdW50X3BvaW50KHNlbGYsIHBhdGgpOgogICAgICAgIHBhdGhfaXNfYnl0ZXMgPSBGYWxzZQogICAgICAgIGlmIGlzaW5zdGFuY2UocGF0aCwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICBwYXRoX2lzX2J5dGVzID0gVHJ1ZQoKICAgICAgICBiX3BhdGggPSBvcy5wYXRoLnJlYWxwYXRoKHRvX2J5dGVzKG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMocGF0aCkpLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKSkKICAgICAgICB3aGlsZSBub3Qgb3MucGF0aC5pc21vdW50KGJfcGF0aCk6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZGlybmFtZShiX3BhdGgpCgogICAgICAgIGlmIHBhdGhfaXNfYnl0ZXM6CiAgICAgICAgICAgIHJldHVybiBiX3BhdGgKCiAgICAgICAgcmV0dXJuIHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQoKICAgIGRlZiBpc19zcGVjaWFsX3NlbGludXhfcGF0aChzZWxmLCBwYXRoKToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm5zIGEgdHVwbGUgY29udGFpbmluZyAoVHJ1ZSwgc2VsaW51eF9jb250ZXh0KSBpZiB0aGUgZ2l2ZW4gcGF0aCBpcyBvbiBhCiAgICAgICAgTkZTIG9yIG90aGVyICdzcGVjaWFsJyBmcyAgbW91bnQgcG9pbnQsIG90aGVyd2lzZSB0aGUgcmV0dXJuIHdpbGwgYmUgKEZhbHNlLCBOb25lKS4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGYgPSBvcGVuKCcvcHJvYy9tb3VudHMnLCAncicpCiAgICAgICAgICAgIG1vdW50X2RhdGEgPSBmLnJlYWRsaW5lcygpCiAgICAgICAgICAgIGYuY2xvc2UoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcmV0dXJuIChGYWxzZSwgTm9uZSkKICAgICAgICBwYXRoX21vdW50X3BvaW50ID0gc2VsZi5maW5kX21vdW50X3BvaW50KHBhdGgpCiAgICAgICAgZm9yIGxpbmUgaW4gbW91bnRfZGF0YToKICAgICAgICAgICAgKGRldmljZSwgbW91bnRfcG9pbnQsIGZzdHlwZSwgb3B0aW9ucywgcmVzdCkgPSBsaW5lLnNwbGl0KCcgJywgNCkKCiAgICAgICAgICAgIGlmIHBhdGhfbW91bnRfcG9pbnQgPT0gbW91bnRfcG9pbnQ6CiAgICAgICAgICAgICAgICBmb3IgZnMgaW4gc2VsZi5fc2VsaW51eF9zcGVjaWFsX2ZzOgogICAgICAgICAgICAgICAgICAgIGlmIGZzIGluIGZzdHlwZToKICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lhbF9jb250ZXh0ID0gc2VsZi5zZWxpbnV4X2NvbnRleHQocGF0aF9tb3VudF9wb2ludCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChUcnVlLCBzcGVjaWFsX2NvbnRleHQpCgogICAgICAgIHJldHVybiAoRmFsc2UsIE5vbmUpCgogICAgZGVmIHNldF9kZWZhdWx0X3NlbGludXhfY29udGV4dChzZWxmLCBwYXRoLCBjaGFuZ2VkKToKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYIG9yIG5vdCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAogICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfZGVmYXVsdF9jb250ZXh0KHBhdGgpCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KHBhdGgsIGNvbnRleHQsIEZhbHNlKQoKICAgIGRlZiBzZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgY29udGV4dCwgY2hhbmdlZCwgZGlmZj1Ob25lKToKCiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKICAgICAgICBjdXJfY29udGV4dCA9IHNlbGYuc2VsaW51eF9jb250ZXh0KHBhdGgpCiAgICAgICAgbmV3X2NvbnRleHQgPSBsaXN0KGN1cl9jb250ZXh0KQogICAgICAgICMgSXRlcmF0ZSBvdmVyIHRoZSBjdXJyZW50IGNvbnRleHQgaW5zdGVhZCBvZiB0aGUKICAgICAgICAjIGFyZ3VtZW50IGNvbnRleHQsIHdoaWNoIG1heSBoYXZlIHNlbGV2ZWwuCgogICAgICAgIChpc19zcGVjaWFsX3NlLCBzcF9jb250ZXh0KSA9IHNlbGYuaXNfc3BlY2lhbF9zZWxpbnV4X3BhdGgocGF0aCkKICAgICAgICBpZiBpc19zcGVjaWFsX3NlOgogICAgICAgICAgICBuZXdfY29udGV4dCA9IHNwX2NvbnRleHQKICAgICAgICBlbHNlOgogICAgICAgICAgICBmb3IgaSBpbiByYW5nZShsZW4oY3VyX2NvbnRleHQpKToKICAgICAgICAgICAgICAgIGlmIGxlbihjb250ZXh0KSA+IGk6CiAgICAgICAgICAgICAgICAgICAgaWYgY29udGV4dFtpXSBpcyBub3QgTm9uZSBhbmQgY29udGV4dFtpXSAhPSBjdXJfY29udGV4dFtpXToKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2NvbnRleHRbaV0gPSBjb250ZXh0W2ldCiAgICAgICAgICAgICAgICAgICAgZWxpZiBjb250ZXh0W2ldIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld19jb250ZXh0W2ldID0gY3VyX2NvbnRleHRbaV0KCiAgICAgICAgaWYgY3VyX2NvbnRleHQgIT0gbmV3X2NvbnRleHQ6CiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnc2Vjb250ZXh0J10gPSBjdXJfY29udGV4dAogICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ3NlY29udGV4dCddID0gbmV3X2NvbnRleHQKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgcmMgPSBzZWxpbnV4LmxzZXRmaWxlY29uKHRvX25hdGl2ZShwYXRoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHIoJzonLmpvaW4obmV3X2NvbnRleHQpKSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0naW52YWxpZCBzZWxpbnV4IGNvbnRleHQ6ICVzJyAlIHN0cihlKSwgbmV3X2NvbnRleHQ9bmV3X2NvbnRleHQsIGN1cl9jb250ZXh0PWN1cl9jb250ZXh0LCBpbnB1dF93YXM9Y29udGV4dCkKICAgICAgICAgICAgaWYgcmMgIT0gMDoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdzZXQgc2VsaW51eCBjb250ZXh0IGZhaWxlZCcpCiAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X293bmVyX2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBvd25lciwgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHBhdGggPSB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIG93bmVyIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCiAgICAgICAgb3JpZ191aWQsIG9yaWdfZ2lkID0gc2VsZi51c2VyX2FuZF9ncm91cChwYXRoLCBleHBhbmQpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB1aWQgPSBpbnQob3duZXIpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHVpZCA9IHB3ZC5nZXRwd25hbShvd25lcikucHdfdWlkCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaG93biBmYWlsZWQ6IGZhaWxlZCB0byBsb29rIHVwIHVzZXIgJXMnICUgb3duZXIpCiAgICAgICAgaWYgb3JpZ191aWQgIT0gdWlkOgoKICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmICdiZWZvcmUnIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydvd25lciddID0gb3JpZ191aWQKICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydvd25lciddID0gdWlkCgogICAgICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5sY2hvd24oYl9wYXRoLCB1aWQsIC0xKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaG93biBmYWlsZWQnKQogICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9ncm91cF9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgZ3JvdXAsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBwYXRoID0gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBncm91cCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAogICAgICAgIG9yaWdfdWlkLCBvcmlnX2dpZCA9IHNlbGYudXNlcl9hbmRfZ3JvdXAoYl9wYXRoLCBleHBhbmQpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBnaWQgPSBpbnQoZ3JvdXApCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGdpZCA9IGdycC5nZXRncm5hbShncm91cCkuZ3JfZ2lkCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaGdycCBmYWlsZWQ6IGZhaWxlZCB0byBsb29rIHVwIGdyb3VwICVzJyAlIGdyb3VwKQogICAgICAgIGlmIG9yaWdfZ2lkICE9IGdpZDoKCiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnZ3JvdXAnXSA9IG9yaWdfZ2lkCiAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnZ3JvdXAnXSA9IGdpZAoKICAgICAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MubGNob3duKGJfcGF0aCwgLTEsIGdpZCkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hncnAgZmFpbGVkJykKICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfbW9kZV9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgbW9kZSwgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHBhdGggPSB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIHBhdGhfc3RhdCA9IG9zLmxzdGF0KGJfcGF0aCkKCiAgICAgICAgaWYgbW9kZSBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShtb2RlLCBpbnQpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBtb2RlID0gaW50KG1vZGUsIDgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbW9kZSA9IHNlbGYuX3N5bWJvbGljX21vZGVfdG9fb2N0YWwocGF0aF9zdGF0LCBtb2RlKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZz0ibW9kZSBtdXN0IGJlIGluIG9jdGFsIG9yIHN5bWJvbGljIGZvcm0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldGFpbHM9c3RyKGUpKQoKICAgICAgICAgICAgICAgIGlmIG1vZGUgIT0gc3RhdC5TX0lNT0RFKG1vZGUpOgogICAgICAgICAgICAgICAgICAgICMgcHJldmVudCBtb2RlIGZyb20gaGF2aW5nIGV4dHJhIGluZm8gb3JiZWluZyBpbnZhbGlkIGxvbmcgbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9IkludmFsaWQgbW9kZSBzdXBwbGllZCwgb25seSBwZXJtaXNzaW9uIGluZm8gaXMgYWxsb3dlZCIsIGRldGFpbHM9bW9kZSkKCiAgICAgICAgcHJldl9tb2RlID0gc3RhdC5TX0lNT0RFKHBhdGhfc3RhdC5zdF9tb2RlKQoKICAgICAgICBpZiBwcmV2X21vZGUgIT0gbW9kZToKCiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnbW9kZSddID0gJzAlMDNvJyAlIHByZXZfbW9kZQogICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ21vZGUnXSA9ICcwJTAzbycgJSBtb2RlCgogICAgICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAjIEZJWE1FOiBjb21wYXJpc29uIGFnYWluc3Qgc3RyaW5nIGFib3ZlIHdpbGwgY2F1c2UgdGhpcyB0byBiZSBleGVjdXRlZAogICAgICAgICAgICAjIGV2ZXJ5IHRpbWUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihvcywgJ2xjaG1vZCcpOgogICAgICAgICAgICAgICAgICAgIG9zLmxjaG1vZChiX3BhdGgsIG1vZGUpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzbGluayhiX3BhdGgpOgogICAgICAgICAgICAgICAgICAgICAgICBvcy5jaG1vZChiX3BhdGgsIG1vZGUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBBdHRlbXB0IHRvIHNldCB0aGUgcGVybXMgb2YgdGhlIHN5bWxpbmsgYnV0IGJlCiAgICAgICAgICAgICAgICAgICAgICAgICMgY2FyZWZ1bCBub3QgdG8gY2hhbmdlIHRoZSBwZXJtcyBvZiB0aGUgdW5kZXJseWluZwogICAgICAgICAgICAgICAgICAgICAgICAjIGZpbGUgd2hpbGUgdHJ5aW5nCiAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVybHlpbmdfc3RhdCA9IG9zLnN0YXQoYl9wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICBvcy5jaG1vZChiX3BhdGgsIG1vZGUpCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld191bmRlcmx5aW5nX3N0YXQgPSBvcy5zdGF0KGJfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdW5kZXJseWluZ19zdGF0LnN0X21vZGUgIT0gbmV3X3VuZGVybHlpbmdfc3RhdC5zdF9tb2RlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2htb2QoYl9wYXRoLCBzdGF0LlNfSU1PREUodW5kZXJseWluZ19zdGF0LnN0X21vZGUpKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguaXNsaW5rKGJfcGF0aCkgYW5kIGUuZXJybm8gPT0gZXJybm8uRVBFUk06ICAjIENhbid0IHNldCBtb2RlIG9uIHN5bWJvbGljIGxpbmtzCiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgZWxpZiBlLmVycm5vIGluIChlcnJuby5FTk9FTlQsIGVycm5vLkVMT09QKTogIyBDYW4ndCBzZXQgbW9kZSBvbiBicm9rZW4gc3ltYm9saWMgbGlua3MKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIGUKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaG1vZCBmYWlsZWQnLCBkZXRhaWxzPXN0cihlKSkKCiAgICAgICAgICAgIHBhdGhfc3RhdCA9IG9zLmxzdGF0KGJfcGF0aCkKICAgICAgICAgICAgbmV3X21vZGUgPSBzdGF0LlNfSU1PREUocGF0aF9zdGF0LnN0X21vZGUpCgogICAgICAgICAgICBpZiBuZXdfbW9kZSAhPSBwcmV2X21vZGU6CiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBhdHRyaWJ1dGVzLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKCiAgICAgICAgaWYgYXR0cmlidXRlcyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgcGF0aCA9IHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCgogICAgICAgIGV4aXN0aW5nID0gc2VsZi5nZXRfZmlsZV9hdHRyaWJ1dGVzKGJfcGF0aCkKCiAgICAgICAgaWYgZXhpc3RpbmcuZ2V0KCdhdHRyX2ZsYWdzJywnJykgIT0gYXR0cmlidXRlczoKICAgICAgICAgICAgYXR0cmNtZCA9IHNlbGYuZ2V0X2Jpbl9wYXRoKCdjaGF0dHInKQogICAgICAgICAgICBpZiBhdHRyY21kOgogICAgICAgICAgICAgICAgYXR0cmNtZCA9IFthdHRyY21kLCAnPSVzJyAlIGF0dHJpYnV0ZXMsIGJfcGF0aF0KICAgICAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCgogICAgICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydhdHRyaWJ1dGVzJ10gPSBleGlzdGluZy5nZXQoJ2F0dHJfZmxhZ3MnKQogICAgICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ2F0dHJpYnV0ZXMnXSA9IGF0dHJpYnV0ZXMKCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5ydW5fY29tbWFuZChhdHRyY21kKQogICAgICAgICAgICAgICAgICAgICAgICBpZiByYyAhPSAwIG9yIGVycjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiRXJyb3Igd2hpbGUgc2V0dGluZyBhdHRyaWJ1dGVzOiAlcyIgJSAob3V0ICsgZXJyKSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2NoYXR0ciBmYWlsZWQnLCBkZXRhaWxzPXN0cihlKSkKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBnZXRfZmlsZV9hdHRyaWJ1dGVzKHNlbGYsIHBhdGgpOgogICAgICAgIG91dHB1dCA9IHt9CiAgICAgICAgYXR0cmNtZCA9IHNlbGYuZ2V0X2Jpbl9wYXRoKCdsc2F0dHInLCBGYWxzZSkKICAgICAgICBpZiBhdHRyY21kOgogICAgICAgICAgICBhdHRyY21kID0gW2F0dHJjbWQsICctdmQnLCBwYXRoXQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLnJ1bl9jb21tYW5kKGF0dHJjbWQpCiAgICAgICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgICAgIHJlcyA9IG91dC5zcGxpdCgnICcpWzA6Ml0KICAgICAgICAgICAgICAgICAgICBvdXRwdXRbJ2F0dHJfZmxhZ3MnXSA9ICByZXNbMV0ucmVwbGFjZSgnLScsJycpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBvdXRwdXRbJ3ZlcnNpb24nXSA9IHJlc1swXS5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0WydhdHRyaWJ1dGVzJ10gPSBmb3JtYXRfYXR0cmlidXRlcyhvdXRwdXRbJ2F0dHJfZmxhZ3MnXSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBvdXRwdXQKCgogICAgZGVmIF9zeW1ib2xpY19tb2RlX3RvX29jdGFsKHNlbGYsIHBhdGhfc3RhdCwgc3ltYm9saWNfbW9kZSk6CiAgICAgICAgbmV3X21vZGUgPSBzdGF0LlNfSU1PREUocGF0aF9zdGF0LnN0X21vZGUpCgogICAgICAgIG1vZGVfcmUgPSByZS5jb21waWxlKHInXig/UDx1c2Vycz5bdWdvYV0rKSg/UDxvcGVyYXRvcj5bLSs9XSkoP1A8cGVybXM+W3J3eFhzdC1dKnxbdWdvXSkkJykKICAgICAgICBmb3IgbW9kZSBpbiBzeW1ib2xpY19tb2RlLnNwbGl0KCcsJyk6CiAgICAgICAgICAgIG1hdGNoID0gbW9kZV9yZS5tYXRjaChtb2RlKQogICAgICAgICAgICBpZiBtYXRjaDoKICAgICAgICAgICAgICAgIHVzZXJzID0gbWF0Y2guZ3JvdXAoJ3VzZXJzJykKICAgICAgICAgICAgICAgIG9wZXJhdG9yID0gbWF0Y2guZ3JvdXAoJ29wZXJhdG9yJykKICAgICAgICAgICAgICAgIHBlcm1zID0gbWF0Y2guZ3JvdXAoJ3Blcm1zJykKCiAgICAgICAgICAgICAgICBpZiB1c2VycyA9PSAnYSc6CiAgICAgICAgICAgICAgICAgICAgdXNlcnMgPSAndWdvJwoKICAgICAgICAgICAgICAgIGZvciB1c2VyIGluIHVzZXJzOgogICAgICAgICAgICAgICAgICAgIG1vZGVfdG9fYXBwbHkgPSBzZWxmLl9nZXRfb2N0YWxfbW9kZV9mcm9tX3N5bWJvbGljX3Blcm1zKHBhdGhfc3RhdCwgdXNlciwgcGVybXMpCiAgICAgICAgICAgICAgICAgICAgbmV3X21vZGUgPSBzZWxmLl9hcHBseV9vcGVyYXRpb25fdG9fbW9kZSh1c2VyLCBvcGVyYXRvciwgbW9kZV90b19hcHBseSwgbmV3X21vZGUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJiYWQgc3ltYm9saWMgcGVybWlzc2lvbiBmb3IgbW9kZTogJXMiICUgbW9kZSkKICAgICAgICByZXR1cm4gbmV3X21vZGUKCiAgICBkZWYgX2FwcGx5X29wZXJhdGlvbl90b19tb2RlKHNlbGYsIHVzZXIsIG9wZXJhdG9yLCBtb2RlX3RvX2FwcGx5LCBjdXJyZW50X21vZGUpOgogICAgICAgIGlmIG9wZXJhdG9yICA9PSAgJz0nOgogICAgICAgICAgICBpZiB1c2VyID09ICd1JzoKICAgICAgICAgICAgICAgIG1hc2sgPSBzdGF0LlNfSVJXWFUgfCBzdGF0LlNfSVNVSUQKICAgICAgICAgICAgZWxpZiB1c2VyID09ICdnJzoKICAgICAgICAgICAgICAgIG1hc2sgPSBzdGF0LlNfSVJXWEcgfCBzdGF0LlNfSVNHSUQKICAgICAgICAgICAgZWxpZiB1c2VyID09ICdvJzoKICAgICAgICAgICAgICAgIG1hc2sgPSBzdGF0LlNfSVJXWE8gfCBzdGF0LlNfSVNWVFgKCiAgICAgICAgICAgICMgbWFzayBvdXQgdSwgZywgb3IgbyBwZXJtaXNzaW9ucyBmcm9tIGN1cnJlbnRfbW9kZSBhbmQgYXBwbHkgbmV3IHBlcm1pc3Npb25zCiAgICAgICAgICAgIGludmVyc2VfbWFzayA9IG1hc2sgXiBQRVJNX0JJVFMKICAgICAgICAgICAgbmV3X21vZGUgPSAoY3VycmVudF9tb2RlICYgaW52ZXJzZV9tYXNrKSB8IG1vZGVfdG9fYXBwbHkKICAgICAgICBlbGlmIG9wZXJhdG9yID09ICcrJzoKICAgICAgICAgICAgbmV3X21vZGUgPSBjdXJyZW50X21vZGUgfCBtb2RlX3RvX2FwcGx5CiAgICAgICAgZWxpZiBvcGVyYXRvciA9PSAnLSc6CiAgICAgICAgICAgIG5ld19tb2RlID0gY3VycmVudF9tb2RlIC0gKGN1cnJlbnRfbW9kZSAmIG1vZGVfdG9fYXBwbHkpCiAgICAgICAgcmV0dXJuIG5ld19tb2RlCgogICAgZGVmIF9nZXRfb2N0YWxfbW9kZV9mcm9tX3N5bWJvbGljX3Blcm1zKHNlbGYsIHBhdGhfc3RhdCwgdXNlciwgcGVybXMpOgogICAgICAgIHByZXZfbW9kZSA9IHN0YXQuU19JTU9ERShwYXRoX3N0YXQuc3RfbW9kZSkKCiAgICAgICAgaXNfZGlyZWN0b3J5ID0gc3RhdC5TX0lTRElSKHBhdGhfc3RhdC5zdF9tb2RlKQogICAgICAgIGhhc194X3Blcm1pc3Npb25zID0gKHByZXZfbW9kZSAmIEVYRUNfUEVSTV9CSVRTKSA+IDAKICAgICAgICBhcHBseV9YX3Blcm1pc3Npb24gPSBpc19kaXJlY3Rvcnkgb3IgaGFzX3hfcGVybWlzc2lvbnMKCiAgICAgICAgIyBQZXJtaXNzaW9uIGJpdHMgY29uc3RhbnRzIGRvY3VtZW50ZWQgYXQ6CiAgICAgICAgIyBodHRwOi8vZG9jcy5weXRob24ub3JnLzIvbGlicmFyeS9zdGF0Lmh0bWwjc3RhdC5TX0lTVUlECiAgICAgICAgaWYgYXBwbHlfWF9wZXJtaXNzaW9uOgogICAgICAgICAgICBYX3Blcm1zID0gewogICAgICAgICAgICAgICAgJ3UnOiB7J1gnOiBzdGF0LlNfSVhVU1J9LAogICAgICAgICAgICAgICAgJ2cnOiB7J1gnOiBzdGF0LlNfSVhHUlB9LAogICAgICAgICAgICAgICAgJ28nOiB7J1gnOiBzdGF0LlNfSVhPVEh9CiAgICAgICAgICAgIH0KICAgICAgICBlbHNlOgogICAgICAgICAgICBYX3Blcm1zID0gewogICAgICAgICAgICAgICAgJ3UnOiB7J1gnOiAwfSwKICAgICAgICAgICAgICAgICdnJzogeydYJzogMH0sCiAgICAgICAgICAgICAgICAnbyc6IHsnWCc6IDB9CiAgICAgICAgICAgIH0KCiAgICAgICAgdXNlcl9wZXJtc190b19tb2RlcyA9IHsKICAgICAgICAgICAgJ3UnOiB7CiAgICAgICAgICAgICAgICAncic6IHN0YXQuU19JUlVTUiwKICAgICAgICAgICAgICAgICd3Jzogc3RhdC5TX0lXVVNSLAogICAgICAgICAgICAgICAgJ3gnOiBzdGF0LlNfSVhVU1IsCiAgICAgICAgICAgICAgICAncyc6IHN0YXQuU19JU1VJRCwKICAgICAgICAgICAgICAgICd0JzogMCwKICAgICAgICAgICAgICAgICd1JzogcHJldl9tb2RlICYgc3RhdC5TX0lSV1hVLAogICAgICAgICAgICAgICAgJ2cnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hHKSA8PCAzLAogICAgICAgICAgICAgICAgJ28nOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hPKSA8PCA2IH0sCiAgICAgICAgICAgICdnJzogewogICAgICAgICAgICAgICAgJ3InOiBzdGF0LlNfSVJHUlAsCiAgICAgICAgICAgICAgICAndyc6IHN0YXQuU19JV0dSUCwKICAgICAgICAgICAgICAgICd4Jzogc3RhdC5TX0lYR1JQLAogICAgICAgICAgICAgICAgJ3MnOiBzdGF0LlNfSVNHSUQsCiAgICAgICAgICAgICAgICAndCc6IDAsCiAgICAgICAgICAgICAgICAndSc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWFUpID4+IDMsCiAgICAgICAgICAgICAgICAnZyc6IHByZXZfbW9kZSAmIHN0YXQuU19JUldYRywKICAgICAgICAgICAgICAgICdvJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYTykgPDwgMyB9LAogICAgICAgICAgICAnbyc6IHsKICAgICAgICAgICAgICAgICdyJzogc3RhdC5TX0lST1RILAogICAgICAgICAgICAgICAgJ3cnOiBzdGF0LlNfSVdPVEgsCiAgICAgICAgICAgICAgICAneCc6IHN0YXQuU19JWE9USCwKICAgICAgICAgICAgICAgICdzJzogMCwKICAgICAgICAgICAgICAgICd0Jzogc3RhdC5TX0lTVlRYLAogICAgICAgICAgICAgICAgJ3UnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hVKSA+PiA2LAogICAgICAgICAgICAgICAgJ2cnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hHKSA+PiAzLAogICAgICAgICAgICAgICAgJ28nOiBwcmV2X21vZGUgJiBzdGF0LlNfSVJXWE8gfQogICAgICAgIH0KCiAgICAgICAgIyBJbnNlcnQgWF9wZXJtcyBpbnRvIHVzZXJfcGVybXNfdG9fbW9kZXMKICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBYX3Blcm1zLml0ZW1zKCk6CiAgICAgICAgICAgIHVzZXJfcGVybXNfdG9fbW9kZXNba2V5XS51cGRhdGUodmFsdWUpCgogICAgICAgIG9yX3JlZHVjZSA9IGxhbWJkYSBtb2RlLCBwZXJtOiBtb2RlIHwgdXNlcl9wZXJtc190b19tb2Rlc1t1c2VyXVtwZXJtXQogICAgICAgIHJldHVybiByZWR1Y2Uob3JfcmVkdWNlLCBwZXJtcywgMCkKCiAgICBkZWYgc2V0X2ZzX2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KHNlbGYsIGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgIyBzZXQgbW9kZXMgb3duZXJzIGFuZCBjb250ZXh0IGFzIG5lZWRlZAogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snc2Vjb250ZXh0J10sIGNoYW5nZWQsIGRpZmYKICAgICAgICApCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X293bmVyX2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snb3duZXInXSwgY2hhbmdlZCwgZGlmZiwgZXhwYW5kCiAgICAgICAgKQogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9ncm91cF9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ2dyb3VwJ10sIGNoYW5nZWQsIGRpZmYsIGV4cGFuZAogICAgICAgICkKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfbW9kZV9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ21vZGUnXSwgY2hhbmdlZCwgZGlmZiwgZXhwYW5kCiAgICAgICAgKQogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snYXR0cmlidXRlcyddLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQKICAgICAgICApCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X2RpcmVjdG9yeV9hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChzZWxmLCBmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIHJldHVybiBzZWxmLnNldF9mc19hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmYsIGV4cGFuZCkKCiAgICBkZWYgc2V0X2ZpbGVfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoc2VsZiwgZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICByZXR1cm4gc2VsZi5zZXRfZnNfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQpCgogICAgZGVmIGFkZF9wYXRoX2luZm8oc2VsZiwga3dhcmdzKToKICAgICAgICAnJycKICAgICAgICBmb3IgcmVzdWx0cyB0aGF0IGFyZSBmaWxlcywgc3VwcGxlbWVudCB0aGUgaW5mbyBhYm91dCB0aGUgZmlsZQogICAgICAgIGluIHRoZSByZXR1cm4gcGF0aCB3aXRoIHN0YXRzIGFib3V0IHRoZSBmaWxlIHBhdGguCiAgICAgICAgJycnCgogICAgICAgIHBhdGggPSBrd2FyZ3MuZ2V0KCdwYXRoJywga3dhcmdzLmdldCgnZGVzdCcsIE5vbmUpKQogICAgICAgIGlmIHBhdGggaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGt3YXJncwogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoYl9wYXRoKToKICAgICAgICAgICAgKHVpZCwgZ2lkKSA9IHNlbGYudXNlcl9hbmRfZ3JvdXAocGF0aCkKICAgICAgICAgICAga3dhcmdzWyd1aWQnXSA9IHVpZAogICAgICAgICAgICBrd2FyZ3NbJ2dpZCddID0gZ2lkCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHVzZXIgPSBwd2QuZ2V0cHd1aWQodWlkKVswXQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICB1c2VyID0gc3RyKHVpZCkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZ3JvdXAgPSBncnAuZ2V0Z3JnaWQoZ2lkKVswXQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBncm91cCA9IHN0cihnaWQpCiAgICAgICAgICAgIGt3YXJnc1snb3duZXInXSA9IHVzZXIKICAgICAgICAgICAga3dhcmdzWydncm91cCddID0gZ3JvdXAKICAgICAgICAgICAgc3QgPSBvcy5sc3RhdChiX3BhdGgpCiAgICAgICAgICAgIGt3YXJnc1snbW9kZSddID0gJzAlMDNvJyAlIHN0YXQuU19JTU9ERShzdFtzdGF0LlNUX01PREVdKQogICAgICAgICAgICAjIHNlY29udGV4dCBub3QgeWV0IHN1cHBvcnRlZAogICAgICAgICAgICBpZiBvcy5wYXRoLmlzbGluayhiX3BhdGgpOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2xpbmsnCiAgICAgICAgICAgIGVsaWYgb3MucGF0aC5pc2RpcihiX3BhdGgpOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2RpcmVjdG9yeScKICAgICAgICAgICAgZWxpZiBvcy5zdGF0KGJfcGF0aCkuc3RfbmxpbmsgPiAxOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2hhcmQnCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnZmlsZScKICAgICAgICAgICAgaWYgSEFWRV9TRUxJTlVYIGFuZCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAga3dhcmdzWydzZWNvbnRleHQnXSA9ICc6Jy5qb2luKHNlbGYuc2VsaW51eF9jb250ZXh0KHBhdGgpKQogICAgICAgICAgICBrd2FyZ3NbJ3NpemUnXSA9IHN0W3N0YXQuU1RfU0laRV0KICAgICAgICBlbHNlOgogICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnYWJzZW50JwogICAgICAgIHJldHVybiBrd2FyZ3MKCiAgICBkZWYgX2NoZWNrX2xvY2FsZShzZWxmKToKICAgICAgICAnJycKICAgICAgICBVc2VzIHRoZSBsb2NhbGUgbW9kdWxlIHRvIHRlc3QgdGhlIGN1cnJlbnRseSBzZXQgbG9jYWxlCiAgICAgICAgKHBlciB0aGUgTEFORyBhbmQgTENfQ1RZUEUgZW52aXJvbm1lbnQgc2V0dGluZ3MpCiAgICAgICAgJycnCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIHNldHRpbmcgdGhlIGxvY2FsZSB0byAnJyB1c2VzIHRoZSBkZWZhdWx0IGxvY2FsZQogICAgICAgICAgICAjIGFzIGl0IHdvdWxkIGJlIHJldHVybmVkIGJ5IGxvY2FsZS5nZXRkZWZhdWx0bG9jYWxlKCkKICAgICAgICAgICAgbG9jYWxlLnNldGxvY2FsZShsb2NhbGUuTENfQUxMLCAnJykKICAgICAgICBleGNlcHQgbG9jYWxlLkVycm9yOgogICAgICAgICAgICAjIGZhbGxiYWNrIHRvIHRoZSAnQycgbG9jYWxlLCB3aGljaCBtYXkgY2F1c2UgdW5pY29kZQogICAgICAgICAgICAjIGlzc3VlcyBidXQgaXMgcHJlZmVyYWJsZSB0byBzaW1wbHkgZmFpbGluZyBiZWNhdXNlCiAgICAgICAgICAgICMgb2YgYW4gdW5rbm93biBsb2NhbGUKICAgICAgICAgICAgbG9jYWxlLnNldGxvY2FsZShsb2NhbGUuTENfQUxMLCAnQycpCiAgICAgICAgICAgIG9zLmVudmlyb25bJ0xBTkcnXSA9ICdDJwogICAgICAgICAgICBvcy5lbnZpcm9uWydMQ19BTEwnXSA9ICdDJwogICAgICAgICAgICBvcy5lbnZpcm9uWydMQ19NRVNTQUdFUyddID0gJ0MnCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IkFuIHVua25vd24gZXJyb3Igd2FzIGVuY291bnRlcmVkIHdoaWxlIGF0dGVtcHRpbmcgdG8gdmFsaWRhdGUgdGhlIGxvY2FsZTogJXMiICUgZSkKCiAgICBkZWYgX2hhbmRsZV9hbGlhc2VzKHNlbGYsIHNwZWM9Tm9uZSk6CiAgICAgICAgIyB0aGlzIHVzZXMgZXhjZXB0aW9ucyBhcyBpdCBoYXBwZW5zIGJlZm9yZSB3ZSBjYW4gc2FmZWx5IGNhbGwgZmFpbF9qc29uCiAgICAgICAgYWxpYXNlc19yZXN1bHRzID0ge30gI2FsaWFzOmNhbm9uCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICBzcGVjID0gc2VsZi5hcmd1bWVudF9zcGVjCiAgICAgICAgZm9yIChrLHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgc2VsZi5fbGVnYWxfaW5wdXRzLmFwcGVuZChrKQogICAgICAgICAgICBhbGlhc2VzID0gdi5nZXQoJ2FsaWFzZXMnLCBOb25lKQogICAgICAgICAgICBkZWZhdWx0ID0gdi5nZXQoJ2RlZmF1bHQnLCBOb25lKQogICAgICAgICAgICByZXF1aXJlZCA9IHYuZ2V0KCdyZXF1aXJlZCcsIEZhbHNlKQogICAgICAgICAgICBpZiBkZWZhdWx0IGlzIG5vdCBOb25lIGFuZCByZXF1aXJlZDoKICAgICAgICAgICAgICAgICMgbm90IGFsaWFzIHNwZWNpZmljIGJ1dCB0aGlzIGlzIGEgZ29vZCBwbGFjZSB0byBjaGVjayB0aGlzCiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oImludGVybmFsIGVycm9yOiByZXF1aXJlZCBhbmQgZGVmYXVsdCBhcmUgbXV0dWFsbHkgZXhjbHVzaXZlIGZvciAlcyIgJSBrKQogICAgICAgICAgICBpZiBhbGlhc2VzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShhbGlhc2VzLCBTRVFVRU5DRVRZUEUpIG9yIGlzaW5zdGFuY2UoYWxpYXNlcywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKToKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbignaW50ZXJuYWwgZXJyb3I6IGFsaWFzZXMgbXVzdCBiZSBhIGxpc3Qgb3IgdHVwbGUnKQogICAgICAgICAgICBmb3IgYWxpYXMgaW4gYWxpYXNlczoKICAgICAgICAgICAgICAgIHNlbGYuX2xlZ2FsX2lucHV0cy5hcHBlbmQoYWxpYXMpCiAgICAgICAgICAgICAgICBhbGlhc2VzX3Jlc3VsdHNbYWxpYXNdID0gawogICAgICAgICAgICAgICAgaWYgYWxpYXMgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBzZWxmLnBhcmFtc1thbGlhc10KCiAgICAgICAgcmV0dXJuIGFsaWFzZXNfcmVzdWx0cwoKICAgIGRlZiBfY2hlY2tfYXJndW1lbnRzKHNlbGYsIGNoZWNrX2ludmFsaWRfYXJndW1lbnRzKToKICAgICAgICBzZWxmLl9zeXNsb2dfZmFjaWxpdHkgPSAnTE9HX1VTRVInCiAgICAgICAgdW5zdXBwb3J0ZWRfcGFyYW1ldGVycyA9IHNldCgpCiAgICAgICAgZm9yIChrLHYpIGluIGxpc3Qoc2VsZi5wYXJhbXMuaXRlbXMoKSk6CgogICAgICAgICAgICBpZiBrID09ICdfYW5zaWJsZV9jaGVja19tb2RlJyBhbmQgdjoKICAgICAgICAgICAgICAgIHNlbGYuY2hlY2tfbW9kZSA9IFRydWUKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfbm9fbG9nJzoKICAgICAgICAgICAgICAgIHNlbGYubm9fbG9nID0gc2VsZi5ib29sZWFuKHYpCgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX2RlYnVnJzoKICAgICAgICAgICAgICAgIHNlbGYuX2RlYnVnID0gc2VsZi5ib29sZWFuKHYpCgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX2RpZmYnOgogICAgICAgICAgICAgICAgc2VsZi5fZGlmZiA9IHNlbGYuYm9vbGVhbih2KQoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV92ZXJib3NpdHknOgogICAgICAgICAgICAgICAgc2VsZi5fdmVyYm9zaXR5ID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9zZWxpbnV4X3NwZWNpYWxfZnMnOgogICAgICAgICAgICAgICAgc2VsZi5fc2VsaW51eF9zcGVjaWFsX2ZzID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9zeXNsb2dfZmFjaWxpdHknOgogICAgICAgICAgICAgICAgc2VsZi5fc3lzbG9nX2ZhY2lsaXR5ID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV92ZXJzaW9uJzoKICAgICAgICAgICAgICAgIHNlbGYuYW5zaWJsZV92ZXJzaW9uID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9tb2R1bGVfbmFtZSc6CiAgICAgICAgICAgICAgICBzZWxmLl9uYW1lID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9zb2NrZXQnOgogICAgICAgICAgICAgICAgc2VsZi5fc29ja2V0X3BhdGggPSB2CgogICAgICAgICAgICBlbGlmIGNoZWNrX2ludmFsaWRfYXJndW1lbnRzIGFuZCBrIG5vdCBpbiBzZWxmLl9sZWdhbF9pbnB1dHM6CiAgICAgICAgICAgICAgICB1bnN1cHBvcnRlZF9wYXJhbWV0ZXJzLmFkZChrKQoKICAgICAgICAgICAgI2NsZWFuIHVwIGludGVybmFsIHBhcmFtczoKICAgICAgICAgICAgaWYgay5zdGFydHN3aXRoKCdfYW5zaWJsZV8nKToKICAgICAgICAgICAgICAgIGRlbCBzZWxmLnBhcmFtc1trXQoKICAgICAgICBpZiB1bnN1cHBvcnRlZF9wYXJhbWV0ZXJzOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IlVuc3VwcG9ydGVkIHBhcmFtZXRlcnMgZm9yICglcykgbW9kdWxlOiAlcy4gU3VwcG9ydGVkIHBhcmFtZXRlcnMgaW5jbHVkZTogJXMiICUgKHNlbGYuX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJywnLmpvaW4oc29ydGVkKGxpc3QodW5zdXBwb3J0ZWRfcGFyYW1ldGVycykpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLCcuam9pbihzb3J0ZWQoc2VsZi5hcmd1bWVudF9zcGVjLmtleXMoKSkpKSkKICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGUgYW5kIG5vdCBzZWxmLnN1cHBvcnRzX2NoZWNrX21vZGU6CiAgICAgICAgICAgIHNlbGYuZXhpdF9qc29uKHNraXBwZWQ9VHJ1ZSwgbXNnPSJyZW1vdGUgbW9kdWxlICglcykgZG9lcyBub3Qgc3VwcG9ydCBjaGVjayBtb2RlIiAlIHNlbGYuX25hbWUpCgogICAgZGVmIF9jb3VudF90ZXJtcyhzZWxmLCBjaGVjayk6CiAgICAgICAgY291bnQgPSAwCiAgICAgICAgZm9yIHRlcm0gaW4gY2hlY2s6CiAgICAgICAgICAgIGlmIHRlcm0gaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICBjb3VudCArPSAxCiAgICAgICAgcmV0dXJuIGNvdW50CgogICAgZGVmIF9jaGVja19tdXR1YWxseV9leGNsdXNpdmUoc2VsZiwgc3BlYyk6CiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3IgY2hlY2sgaW4gc3BlYzoKICAgICAgICAgICAgY291bnQgPSBzZWxmLl9jb3VudF90ZXJtcyhjaGVjaykKICAgICAgICAgICAgaWYgY291bnQgPiAxOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJwYXJhbWV0ZXJzIGFyZSBtdXR1YWxseSBleGNsdXNpdmU6ICVzIiAlIChjaGVjaywpKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfb25lX29mKHNlbGYsIHNwZWMpOgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZm9yIGNoZWNrIGluIHNwZWM6CiAgICAgICAgICAgIGNvdW50ID0gc2VsZi5fY291bnRfdGVybXMoY2hlY2spCiAgICAgICAgICAgIGlmIGNvdW50ID09IDA6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9Im9uZSBvZiB0aGUgZm9sbG93aW5nIGlzIHJlcXVpcmVkOiAlcyIgJSAnLCcuam9pbihjaGVjaykpCgogICAgZGVmIF9jaGVja19yZXF1aXJlZF90b2dldGhlcihzZWxmLCBzcGVjKToKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciBjaGVjayBpbiBzcGVjOgogICAgICAgICAgICBjb3VudHMgPSBbIHNlbGYuX2NvdW50X3Rlcm1zKFtmaWVsZF0pIGZvciBmaWVsZCBpbiBjaGVjayBdCiAgICAgICAgICAgIG5vbl96ZXJvID0gWyBjIGZvciBjIGluIGNvdW50cyBpZiBjID4gMCBdCiAgICAgICAgICAgIGlmIGxlbihub25femVybykgPiAwOgogICAgICAgICAgICAgICAgaWYgMCBpbiBjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJwYXJhbWV0ZXJzIGFyZSByZXF1aXJlZCB0b2dldGhlcjogJXMiICUgKGNoZWNrLCkpCgogICAgZGVmIF9jaGVja19yZXF1aXJlZF9hcmd1bWVudHMoc2VsZiwgc3BlYz1Ob25lLCBwYXJhbT1Ob25lICk6CiAgICAgICAgJycnIGVuc3VyZSBhbGwgcmVxdWlyZWQgYXJndW1lbnRzIGFyZSBwcmVzZW50ICcnJwogICAgICAgIG1pc3NpbmcgPSBbXQogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgc3BlYyA9IHNlbGYuYXJndW1lbnRfc3BlYwogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAgICAgIHBhcmFtID0gc2VsZi5wYXJhbXMKICAgICAgICBmb3IgKGssdikgaW4gc3BlYy5pdGVtcygpOgogICAgICAgICAgICByZXF1aXJlZCA9IHYuZ2V0KCdyZXF1aXJlZCcsIEZhbHNlKQogICAgICAgICAgICBpZiByZXF1aXJlZCBhbmQgayBub3QgaW4gcGFyYW06CiAgICAgICAgICAgICAgICBtaXNzaW5nLmFwcGVuZChrKQogICAgICAgIGlmIGxlbihtaXNzaW5nKSA+IDA6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0ibWlzc2luZyByZXF1aXJlZCBhcmd1bWVudHM6ICVzIiAlICIsIi5qb2luKG1pc3NpbmcpKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfaWYoc2VsZiwgc3BlYyk6CiAgICAgICAgJycnIGVuc3VyZSB0aGF0IHBhcmFtZXRlcnMgd2hpY2ggY29uZGl0aW9uYWxseSByZXF1aXJlZCBhcmUgcHJlc2VudCAnJycKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciBzcCBpbiBzcGVjOgogICAgICAgICAgICBtaXNzaW5nID0gW10KICAgICAgICAgICAgbWF4X21pc3NpbmdfY291bnQgPSAwCiAgICAgICAgICAgIGlzX29uZV9vZiA9IEZhbHNlCiAgICAgICAgICAgIGlmIGxlbihzcCkgPT0gNDoKICAgICAgICAgICAgICAgIGtleSwgdmFsLCByZXF1aXJlbWVudHMsIGlzX29uZV9vZiA9IHNwCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBrZXksIHZhbCwgcmVxdWlyZW1lbnRzID0gc3AKCiAgICAgICAgICAgICMgaXNfb25lX29mIGlzIFRydWUgYXQgbGVhc3Qgb25lIHJlcXVpcmVtZW50IHNob3VsZCBiZQogICAgICAgICAgICAjIHByZXNlbnQsIGVsc2UgYWxsIHJlcXVpcmVtZW50cyBzaG91bGQgYmUgcHJlc2VudC4KICAgICAgICAgICAgaWYgaXNfb25lX29mOgogICAgICAgICAgICAgICAgbWF4X21pc3NpbmdfY291bnQgPSBsZW4ocmVxdWlyZW1lbnRzKQoKICAgICAgICAgICAgaWYga2V5IGluIHNlbGYucGFyYW1zIGFuZCBzZWxmLnBhcmFtc1trZXldID09IHZhbDoKICAgICAgICAgICAgICAgIGZvciBjaGVjayBpbiByZXF1aXJlbWVudHM6CiAgICAgICAgICAgICAgICAgICAgY291bnQgPSBzZWxmLl9jb3VudF90ZXJtcygoY2hlY2ssKSkKICAgICAgICAgICAgICAgICAgICBpZiBjb3VudCA9PSAwOgogICAgICAgICAgICAgICAgICAgICAgICBtaXNzaW5nLmFwcGVuZChjaGVjaykKICAgICAgICAgICAgaWYgbGVuKG1pc3NpbmcpIGFuZCBsZW4obWlzc2luZykgPj0gbWF4X21pc3NpbmdfY291bnQ6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IiVzIGlzICVzIGJ1dCB0aGUgZm9sbG93aW5nIGFyZSBtaXNzaW5nOiAlcyIgJSAoa2V5LCB2YWwsICcsJy5qb2luKG1pc3NpbmcpKSkKCiAgICBkZWYgX2NoZWNrX2FyZ3VtZW50X3ZhbHVlcyhzZWxmLCBzcGVjPU5vbmUsIHBhcmFtPU5vbmUpOgogICAgICAgICcnJyBlbnN1cmUgYWxsIGFyZ3VtZW50cyBoYXZlIHRoZSByZXF1ZXN0ZWQgdmFsdWVzLCBhbmQgdGhlcmUgYXJlIG5vIHN0cmF5IGFyZ3VtZW50cyAnJycKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHNwZWMgPSBzZWxmLmFyZ3VtZW50X3NwZWMKICAgICAgICBpZiBwYXJhbSBpcyBOb25lOgogICAgICAgICAgICBwYXJhbSA9IHNlbGYucGFyYW1zCiAgICAgICAgZm9yIChrLHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgY2hvaWNlcyA9IHYuZ2V0KCdjaG9pY2VzJyxOb25lKQogICAgICAgICAgICBpZiBjaG9pY2VzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGNob2ljZXMsIFNFUVVFTkNFVFlQRSkgYW5kIG5vdCBpc2luc3RhbmNlKGNob2ljZXMsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgICAgICBpZiBrIGluIHBhcmFtOgogICAgICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdIG5vdCBpbiBjaG9pY2VzOgogICAgICAgICAgICAgICAgICAgICAgICAjIFB5WWFtbCBjb252ZXJ0cyBjZXJ0YWluIHN0cmluZ3MgdG8gYm9vbHMuICBJZiB3ZSBjYW4gdW5hbWJpZ3VvdXNseSBjb252ZXJ0IGJhY2ssIGRvIHNvIGJlZm9yZSBjaGVja2luZwogICAgICAgICAgICAgICAgICAgICAgICAjIHRoZSB2YWx1ZS4gIElmIHdlIGNhbid0IGZpZ3VyZSB0aGlzIG91dCwgbW9kdWxlIGF1dGhvciBpcyByZXNwb25zaWJsZS4KICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJlZF9jaG9pY2VzID0gTm9uZQogICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSA9PSAnRmFsc2UnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJlZF9jaG9pY2VzID0gX2xlbmllbnRfbG93ZXJjYXNlKGNob2ljZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGQUxTRVkgPSBmcm96ZW5zZXQoQk9PTEVBTlNfRkFMU0UpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdmVybGFwID0gRkFMU0VZLmludGVyc2VjdGlvbihjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKG92ZXJsYXApID09IDE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBFeHRyYWN0IGZyb20gYSBzZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAocGFyYW1ba10sKSA9IG92ZXJsYXAKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdID09ICdUcnVlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxvd2VyZWRfY2hvaWNlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvd2VyZWRfY2hvaWNlcyA9IF9sZW5pZW50X2xvd2VyY2FzZShjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgVFJVVEhZID0gZnJvemVuc2V0KEJPT0xFQU5TX1RSVUUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdmVybGFwID0gVFJVVEhZLmludGVyc2VjdGlvbihjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKG92ZXJsYXApID09IDE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHBhcmFtW2tdLCkgPSBvdmVybGFwCgogICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSBub3QgaW4gY2hvaWNlczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXNfc3RyPSIsIi5qb2luKFt0b19uYXRpdmUoYykgZm9yIGMgaW4gY2hvaWNlc10pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2c9InZhbHVlIG9mICVzIG11c3QgYmUgb25lIG9mOiAlcywgZ290OiAlcyIgJSAoaywgY2hvaWNlc19zdHIsIHBhcmFtW2tdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPW1zZykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iaW50ZXJuYWwgZXJyb3I6IGNob2ljZXMgZm9yIGFyZ3VtZW50ICVzIGFyZSBub3QgaXRlcmFibGU6ICVzIiAlIChrLCBjaG9pY2VzKSkKCiAgICBkZWYgc2FmZV9ldmFsKHNlbGYsIHZhbHVlLCBsb2NhbHM9Tm9uZSwgaW5jbHVkZV9leGNlcHRpb25zPUZhbHNlKToKCiAgICAgICAgIyBkbyBub3QgYWxsb3cgbWV0aG9kIGNhbGxzIHRvIG1vZHVsZXMKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgIyBhbHJlYWR5IHRlbXBsYXRlZCB0byBhIGRhdGF2YWx1ZXN0cnVjdHVyZSwgcGVyaGFwcz8KICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgTm9uZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgaWYgcmUuc2VhcmNoKHInXHdcLlx3K1woJywgdmFsdWUpOgogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHZhbHVlLCBOb25lKQogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICAjIGRvIG5vdCBhbGxvdyBpbXBvcnRzCiAgICAgICAgaWYgcmUuc2VhcmNoKHInaW1wb3J0IFx3KycsIHZhbHVlKToKICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgTm9uZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXN1bHQgPSBsaXRlcmFsX2V2YWwodmFsdWUpCiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAocmVzdWx0LCBOb25lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgZGVmIF9jaGVja190eXBlX3N0cihzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgIyBOb3RlOiBUaGlzIGNvdWxkIHRocm93IGEgdW5pY29kZSBlcnJvciBpZiB2YWx1ZSdzIF9fc3RyX18oKSBtZXRob2QKICAgICAgICAjIHJldHVybnMgbm9uLWFzY2lpLiAgSGF2ZSB0byBwb3J0IHV0aWxzLnRvX2J5dGVzKCkgaWYgdGhhdCBoYXBwZW5zCiAgICAgICAgcmV0dXJuIHN0cih2YWx1ZSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfbGlzdChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgbGlzdCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUuc3BsaXQoIiwiKQogICAgICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgaW50KSBvciBpc2luc3RhbmNlKHZhbHVlLCBmbG9hdCk6CiAgICAgICAgICAgIHJldHVybiBbIHN0cih2YWx1ZSkgXQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBsaXN0JyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9kaWN0KHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBkaWN0KToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIGlmIHZhbHVlLnN0YXJ0c3dpdGgoInsiKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5sb2Fkcyh2YWx1ZSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAocmVzdWx0LCBleGMpID0gc2VsZi5zYWZlX2V2YWwodmFsdWUsIGRpY3QoKSwgaW5jbHVkZV9leGNlcHRpb25zPVRydWUpCiAgICAgICAgICAgICAgICAgICAgaWYgZXhjIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ3VuYWJsZSB0byBldmFsdWF0ZSBzdHJpbmcgYXMgZGljdGlvbmFyeScpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICAgICAgICBlbGlmICc9JyBpbiB2YWx1ZToKICAgICAgICAgICAgICAgIGZpZWxkcyA9IFtdCiAgICAgICAgICAgICAgICBmaWVsZF9idWZmZXIgPSBbXQogICAgICAgICAgICAgICAgaW5fcXVvdGUgPSBGYWxzZQogICAgICAgICAgICAgICAgaW5fZXNjYXBlID0gRmFsc2UKICAgICAgICAgICAgICAgIGZvciBjIGluIHZhbHVlLnN0cmlwKCk6CiAgICAgICAgICAgICAgICAgICAgaWYgaW5fZXNjYXBlOgogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZF9idWZmZXIuYXBwZW5kKGMpCiAgICAgICAgICAgICAgICAgICAgICAgIGluX2VzY2FwZSA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgZWxpZiBjID09ICdcXCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGluX2VzY2FwZSA9IFRydWUKICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBpbl9xdW90ZSBhbmQgYyBpbiAoJ1wnJywgJyInKToKICAgICAgICAgICAgICAgICAgICAgICAgaW5fcXVvdGUgPSBjCiAgICAgICAgICAgICAgICAgICAgZWxpZiBpbl9xdW90ZSBhbmQgaW5fcXVvdGUgPT0gYzoKICAgICAgICAgICAgICAgICAgICAgICAgaW5fcXVvdGUgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsaWYgbm90IGluX3F1b3RlIGFuZCBjIGluICgnLCcsICcgJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkID0gJycuam9pbihmaWVsZF9idWZmZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGZpZWxkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzLmFwcGVuZChmaWVsZCkKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyID0gW10KICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZF9idWZmZXIuYXBwZW5kKGMpCgogICAgICAgICAgICAgICAgZmllbGQgPSAnJy5qb2luKGZpZWxkX2J1ZmZlcikKICAgICAgICAgICAgICAgIGlmIGZpZWxkOgogICAgICAgICAgICAgICAgICAgIGZpZWxkcy5hcHBlbmQoZmllbGQpCiAgICAgICAgICAgICAgICByZXR1cm4gZGljdCh4LnNwbGl0KCI9IiwgMSkgZm9yIHggaW4gZmllbGRzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJkaWN0aW9uYXJ5IHJlcXVlc3RlZCwgY291bGQgbm90IHBhcnNlIEpTT04gb3Iga2V5PXZhbHVlIikKCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgZGljdCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfYm9vbChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgYm9vbCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpIG9yIGlzaW5zdGFuY2UodmFsdWUsIGludCk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmJvb2xlYW4odmFsdWUpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGJvb2wnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2ludChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgaW50KToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHJldHVybiBpbnQodmFsdWUpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhbiBpbnQnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2Zsb2F0KHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBmbG9hdCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSwgaW50KSk6CiAgICAgICAgICAgIHJldHVybiBmbG9hdCh2YWx1ZSkKCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgZmxvYXQnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX3BhdGgoc2VsZiwgdmFsdWUpOgogICAgICAgIHZhbHVlID0gc2VsZi5fY2hlY2tfdHlwZV9zdHIodmFsdWUpCiAgICAgICAgcmV0dXJuIG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnModmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9qc29uYXJnKHNlbGYsIHZhbHVlKToKICAgICAgICAjIFJldHVybiBhIGpzb25pZmllZCBzdHJpbmcuICBTb21ldGltZXMgdGhlIGNvbnRyb2xsZXIgdHVybnMgYSBqc29uCiAgICAgICAgIyBzdHJpbmcgaW50byBhIGRpY3QvbGlzdCBzbyB0cmFuc2Zvcm0gaXQgYmFjayBpbnRvIGpzb24gaGVyZQogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5zdHJpcCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgKGxpc3QsIHR1cGxlLCBkaWN0KSk6CiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5kdW1wcyh2YWx1ZSkKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBqc29uIHN0cmluZycgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfcmF3KHNlbGYsIHZhbHVlKToKICAgICAgICByZXR1cm4gdmFsdWUKCgogICAgZGVmIF9jaGVja190eXBlX2J5dGVzKHNlbGYsIHZhbHVlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuaHVtYW5fdG9fYnl0ZXModmFsdWUpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIEJ5dGUgdmFsdWUnICUgdHlwZSh2YWx1ZSkpCgoKICAgIGRlZiBfY2hlY2tfdHlwZV9iaXRzKHNlbGYsIHZhbHVlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuaHVtYW5fdG9fYnl0ZXModmFsdWUsIGlzYml0cz1UcnVlKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBCaXQgdmFsdWUnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja19hcmd1bWVudF90eXBlcyhzZWxmLCBzcGVjPU5vbmUsIHBhcmFtPU5vbmUpOgogICAgICAgICcnJyBlbnN1cmUgYWxsIGFyZ3VtZW50cyBoYXZlIHRoZSByZXF1ZXN0ZWQgdHlwZSAnJycKCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICBzcGVjID0gc2VsZi5hcmd1bWVudF9zcGVjCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToKICAgICAgICAgICAgcGFyYW0gPSBzZWxmLnBhcmFtcwoKICAgICAgICBmb3IgKGssIHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgd2FudGVkID0gdi5nZXQoJ3R5cGUnLCBOb25lKQogICAgICAgICAgICBpZiBrIG5vdCBpbiBwYXJhbToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIHdhbnRlZCBpcyBOb25lOgogICAgICAgICAgICAgICAgIyBNb3N0bHkgd2Ugd2FudCB0byBkZWZhdWx0IHRvIHN0ci4KICAgICAgICAgICAgICAgICMgRm9yIHZhbHVlcyBzZXQgdG8gTm9uZSBleHBsaWNpdGx5LCByZXR1cm4gTm9uZSBpbnN0ZWFkIGFzCiAgICAgICAgICAgICAgICAjIHRoYXQgYWxsb3dzIGEgdXNlciB0byB1bnNldCBhIHBhcmFtZXRlcgogICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgd2FudGVkID0gJ3N0cicKCiAgICAgICAgICAgIHZhbHVlID0gcGFyYW1ba10KICAgICAgICAgICAgaWYgdmFsdWUgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB0eXBlX2NoZWNrZXIgPSBzZWxmLl9DSEVDS19BUkdVTUVOVF9UWVBFU19ESVNQQVRDSEVSW3dhbnRlZF0KICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJpbXBsZW1lbnRhdGlvbiBlcnJvcjogdW5rbm93biB0eXBlICVzIHJlcXVlc3RlZCBmb3IgJXMiICUgKHdhbnRlZCwgaykpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHBhcmFtW2tdID0gdHlwZV9jaGVja2VyKHZhbHVlKQogICAgICAgICAgICBleGNlcHQgKFR5cGVFcnJvciwgVmFsdWVFcnJvcik6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImFyZ3VtZW50ICVzIGlzIG9mIHR5cGUgJXMgYW5kIHdlIHdlcmUgdW5hYmxlIHRvIGNvbnZlcnQgdG8gJXM6ICVzIiAlIChrLCB0eXBlKHZhbHVlKSwgd2FudGVkLCBlKSkKCiAgICAgICAgICAgICMgZGVhbCB3aXRoIHN1YiBvcHRpb25zIHRvIGNyZWF0ZSBzdWIgc3BlYwogICAgICAgICAgICBzcGVjID0gTm9uZQogICAgICAgICAgICBpZiB3YW50ZWQgPT0gJ2RpY3QnIG9yICh3YW50ZWQgPT0gJ2xpc3QnIGFuZCB2LmdldCgnZWxlbWVudHMnLCAnJykgPT0gJ2RpY3QnKToKICAgICAgICAgICAgICAgIHNwZWMgPSB2LmdldCgnb3B0aW9ucycsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBzcGVjOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX2FyZ3VtZW50cyhzcGVjLCBwYXJhbVtrXSkKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudF90eXBlcyhzcGVjLCBwYXJhbVtrXSkKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudF92YWx1ZXMoc3BlYywgcGFyYW1ba10pCgogICAgZGVmIF9zZXRfZGVmYXVsdHMoc2VsZiwgcHJlPVRydWUpOgogICAgICAgIGZvciAoayx2KSBpbiBzZWxmLmFyZ3VtZW50X3NwZWMuaXRlbXMoKToKICAgICAgICAgICAgZGVmYXVsdCA9IHYuZ2V0KCdkZWZhdWx0JywgTm9uZSkKICAgICAgICAgICAgaWYgcHJlIGlzIFRydWU6CiAgICAgICAgICAgICAgICAjIHRoaXMgcHJldmVudHMgc2V0dGluZyBkZWZhdWx0cyBvbiByZXF1aXJlZCBpdGVtcwogICAgICAgICAgICAgICAgaWYgZGVmYXVsdCBpcyBub3QgTm9uZSBhbmQgayBub3QgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBkZWZhdWx0CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIG1ha2Ugc3VyZSB0aGluZ3Mgd2l0aG91dCBhIGRlZmF1bHQgc3RpbGwgZ2V0IHNldCBOb25lCiAgICAgICAgICAgICAgICBpZiBrIG5vdCBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcmFtc1trXSA9IGRlZmF1bHQKCiAgICBkZWYgX3NldF9mYWxsYmFja3Moc2VsZik6CiAgICAgICAgZm9yIGssdiBpbiBzZWxmLmFyZ3VtZW50X3NwZWMuaXRlbXMoKToKICAgICAgICAgICAgZmFsbGJhY2sgPSB2LmdldCgnZmFsbGJhY2snLCAoTm9uZSwpKQogICAgICAgICAgICBmYWxsYmFja19zdHJhdGVneSA9IGZhbGxiYWNrWzBdCiAgICAgICAgICAgIGZhbGxiYWNrX2FyZ3MgPSBbXQogICAgICAgICAgICBmYWxsYmFja19rd2FyZ3MgPSB7fQogICAgICAgICAgICBpZiBrIG5vdCBpbiBzZWxmLnBhcmFtcyBhbmQgZmFsbGJhY2tfc3RyYXRlZ3kgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBmb3IgaXRlbSBpbiBmYWxsYmFja1sxOl06CiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShpdGVtLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tfa3dhcmdzID0gaXRlbQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrX2FyZ3MgPSBpdGVtCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBmYWxsYmFja19zdHJhdGVneSgqZmFsbGJhY2tfYXJncywgKipmYWxsYmFja19rd2FyZ3MpCiAgICAgICAgICAgICAgICBleGNlcHQgQW5zaWJsZUZhbGxiYWNrTm90Rm91bmQ6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICBkZWYgX2xvYWRfcGFyYW1zKHNlbGYpOgogICAgICAgICcnJyByZWFkIHRoZSBpbnB1dCBhbmQgc2V0IHRoZSBwYXJhbXMgYXR0cmlidXRlLgoKICAgICAgICBUaGlzIG1ldGhvZCBpcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuICBUaGUgZ3V0cyBvZiB0aGUgZnVuY3Rpb24KICAgICAgICB3ZXJlIG1vdmVkIG91dCBpbiAyLjEgc28gdGhhdCBjdXN0b20gbW9kdWxlcyBjb3VsZCByZWFkIHRoZSBwYXJhbWV0ZXJzLgogICAgICAgICcnJwogICAgICAgICMgZGVidWcgb3ZlcnJpZGVzIHRvIHJlYWQgYXJncyBmcm9tIGZpbGUgb3IgY21kbGluZQogICAgICAgIHNlbGYucGFyYW1zID0gX2xvYWRfcGFyYW1zKCkKCiAgICBkZWYgX2xvZ190b19zeXNsb2coc2VsZiwgbXNnKToKICAgICAgICBpZiBIQVNfU1lTTE9HOgogICAgICAgICAgICBtb2R1bGUgPSAnYW5zaWJsZS0lcycgJSBzZWxmLl9uYW1lCiAgICAgICAgICAgIGZhY2lsaXR5ID0gZ2V0YXR0cihzeXNsb2csIHNlbGYuX3N5c2xvZ19mYWNpbGl0eSwgc3lzbG9nLkxPR19VU0VSKQogICAgICAgICAgICBzeXNsb2cub3BlbmxvZyhzdHIobW9kdWxlKSwgMCwgZmFjaWxpdHkpCiAgICAgICAgICAgIHN5c2xvZy5zeXNsb2coc3lzbG9nLkxPR19JTkZPLCBtc2cpCgogICAgZGVmIGRlYnVnKHNlbGYsIG1zZyk6CiAgICAgICAgaWYgc2VsZi5fZGVidWc6CiAgICAgICAgICAgIHNlbGYubG9nKCdbZGVidWddICVzJyAlIG1zZykKCiAgICBkZWYgbG9nKHNlbGYsIG1zZywgbG9nX2FyZ3M9Tm9uZSk6CgogICAgICAgIGlmIG5vdCBzZWxmLm5vX2xvZzoKCiAgICAgICAgICAgIGlmIGxvZ19hcmdzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBsb2dfYXJncyA9IGRpY3QoKQoKICAgICAgICAgICAgbW9kdWxlID0gJ2Fuc2libGUtJXMnICUgc2VsZi5fbmFtZQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKG1vZHVsZSwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICAgICAgbW9kdWxlID0gbW9kdWxlLmRlY29kZSgndXRmLTgnLCAncmVwbGFjZScpCgogICAgICAgICAgICAjIDY2NTUgLSBhbGxvdyBmb3IgYWNjZW50ZWQgY2hhcmFjdGVycwogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShtc2csIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoIm1zZyBzaG91bGQgYmUgYSBzdHJpbmcgKGdvdCAlcykiICUgdHlwZShtc2cpKQoKICAgICAgICAgICAgIyBXZSB3YW50IGpvdXJuYWwgdG8gYWx3YXlzIHRha2UgdGV4dCB0eXBlCiAgICAgICAgICAgICMgc3lzbG9nIHRha2VzIGJ5dGVzIG9uIHB5MiwgdGV4dCB0eXBlIG9uIHB5MwogICAgICAgICAgICBpZiBpc2luc3RhbmNlKG1zZywgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICAgICAgam91cm5hbF9tc2cgPSByZW1vdmVfdmFsdWVzKG1zZy5kZWNvZGUoJ3V0Zi04JywgJ3JlcGxhY2UnKSwgc2VsZi5ub19sb2dfdmFsdWVzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBUT0RPOiBzdXJyb2dhdGVlc2NhcGUgaXMgYSBkYW5nZXIgaGVyZSBvbiBQeTMKICAgICAgICAgICAgICAgIGpvdXJuYWxfbXNnID0gcmVtb3ZlX3ZhbHVlcyhtc2csIHNlbGYubm9fbG9nX3ZhbHVlcykKCiAgICAgICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgICAgIHN5c2xvZ19tc2cgPSBqb3VybmFsX21zZwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc3lzbG9nX21zZyA9IGpvdXJuYWxfbXNnLmVuY29kZSgndXRmLTgnLCAncmVwbGFjZScpCgogICAgICAgICAgICBpZiBoYXNfam91cm5hbDoKICAgICAgICAgICAgICAgIGpvdXJuYWxfYXJncyA9IFsoIk1PRFVMRSIsIG9zLnBhdGguYmFzZW5hbWUoX19maWxlX18pKV0KICAgICAgICAgICAgICAgIGZvciBhcmcgaW4gbG9nX2FyZ3M6CiAgICAgICAgICAgICAgICAgICAgam91cm5hbF9hcmdzLmFwcGVuZCgoYXJnLnVwcGVyKCksIHN0cihsb2dfYXJnc1thcmddKSkpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgam91cm5hbC5zZW5kKHUiJXMgJXMiICUgKG1vZHVsZSwgam91cm5hbF9tc2cpLCAqKmRpY3Qoam91cm5hbF9hcmdzKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBJT0Vycm9yOgogICAgICAgICAgICAgICAgICAgICMgZmFsbCBiYWNrIHRvIHN5c2xvZyBzaW5jZSBsb2dnaW5nIHRvIGpvdXJuYWwgZmFpbGVkCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fbG9nX3RvX3N5c2xvZyhzeXNsb2dfbXNnKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5fbG9nX3RvX3N5c2xvZyhzeXNsb2dfbXNnKQoKICAgIGRlZiBfbG9nX2ludm9jYXRpb24oc2VsZik6CiAgICAgICAgJycnIGxvZyB0aGF0IGFuc2libGUgcmFuIHRoZSBtb2R1bGUgJycnCiAgICAgICAgIyBUT0RPOiBnZW5lcmFsaXplIGEgc2VwYXJhdGUgbG9nIGZ1bmN0aW9uIGFuZCBtYWtlIGxvZ19pbnZvY2F0aW9uIHVzZSBpdAogICAgICAgICMgU2FuaXRpemUgcG9zc2libGUgcGFzc3dvcmQgYXJndW1lbnQgd2hlbiBsb2dnaW5nLgogICAgICAgIGxvZ19hcmdzID0gZGljdCgpCgogICAgICAgIGZvciBwYXJhbSBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgY2Fub24gID0gc2VsZi5hbGlhc2VzLmdldChwYXJhbSwgcGFyYW0pCiAgICAgICAgICAgIGFyZ19vcHRzID0gc2VsZi5hcmd1bWVudF9zcGVjLmdldChjYW5vbiwge30pCiAgICAgICAgICAgIG5vX2xvZyA9IGFyZ19vcHRzLmdldCgnbm9fbG9nJywgRmFsc2UpCgogICAgICAgICAgICBpZiBzZWxmLmJvb2xlYW4obm9fbG9nKToKICAgICAgICAgICAgICAgIGxvZ19hcmdzW3BhcmFtXSA9ICdOT1RfTE9HR0lOR19QQVJBTUVURVInCiAgICAgICAgICAgICMgdHJ5IHRvIGNhcHR1cmUgYWxsIHBhc3N3b3Jkcy9wYXNzcGhyYXNlIG5hbWVkIGZpZWxkcyBtaXNzZWQgYnkgbm9fbG9nCiAgICAgICAgICAgIGVsaWYgUEFTU1dPUkRfTUFUQ0guc2VhcmNoKHBhcmFtKSBhbmQgXAogICAgICAgICAgICAgIGFyZ19vcHRzLmdldCgndHlwZScsICdzdHInKSAhPSAnYm9vbCcgYW5kIFwKICAgICAgICAgICAgICBub3QgYXJnX29wdHMuZ2V0KCdjaG9pY2VzJywgRmFsc2UpOgogICAgICAgICAgICAgICAgIyBza2lwIGJvb2xlYW4gYW5kIGVudW1zIGFzIHRoZXkgYXJlIGFib3V0ICdwYXNzd29yZCcgc3RhdGUKICAgICAgICAgICAgICAgIGxvZ19hcmdzW3BhcmFtXSA9ICdOT1RfTE9HR0lOR19QQVNTV09SRCcKICAgICAgICAgICAgICAgIHNlbGYud2FybignTW9kdWxlIGRpZCBub3Qgc2V0IG5vX2xvZyBmb3IgJXMnICUgcGFyYW0pCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwYXJhbV92YWwgPSBzZWxmLnBhcmFtc1twYXJhbV0KICAgICAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHBhcmFtX3ZhbCwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICAgICAgICAgICAgICBwYXJhbV92YWwgPSBzdHIocGFyYW1fdmFsKQogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKHBhcmFtX3ZhbCwgdGV4dF90eXBlKToKICAgICAgICAgICAgICAgICAgICBwYXJhbV92YWwgPSBwYXJhbV92YWwuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgICAgICBsb2dfYXJnc1twYXJhbV0gPSBoZXVyaXN0aWNfbG9nX3Nhbml0aXplKHBhcmFtX3ZhbCwgc2VsZi5ub19sb2dfdmFsdWVzKQoKICAgICAgICBtc2cgPSBbJyVzPSVzJyAlICh0b19uYXRpdmUoYXJnKSwgdG9fbmF0aXZlKHZhbCkpIGZvciBhcmcsIHZhbCBpbiBsb2dfYXJncy5pdGVtcygpXQogICAgICAgIGlmIG1zZzoKICAgICAgICAgICAgbXNnID0gJ0ludm9rZWQgd2l0aCAlcycgJSAnICcuam9pbihtc2cpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbXNnID0gJ0ludm9rZWQnCgogICAgICAgIHNlbGYubG9nKG1zZywgbG9nX2FyZ3M9bG9nX2FyZ3MpCgoKICAgIGRlZiBfc2V0X2N3ZChzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN3ZCA9IG9zLmdldGN3ZCgpCiAgICAgICAgICAgIGlmIG5vdCBvcy5hY2Nlc3MoY3dkLCBvcy5GX09LfG9zLlJfT0spOgogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCkKICAgICAgICAgICAgcmV0dXJuIGN3ZAogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgIyB3ZSBkb24ndCBoYXZlIGFjY2VzcyB0byB0aGUgY3dkLCBwcm9iYWJseSBiZWNhdXNlIG9mIHN1ZG8uCiAgICAgICAgICAgICMgVHJ5IGFuZCBtb3ZlIHRvIGEgbmV1dHJhbCBsb2NhdGlvbiB0byBwcmV2ZW50IGVycm9ycwogICAgICAgICAgICBmb3IgY3dkIGluIFtvcy5wYXRoLmV4cGFuZHZhcnMoJyRIT01FJyksIHRlbXBmaWxlLmdldHRlbXBkaXIoKV06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgb3MuYWNjZXNzKGN3ZCwgb3MuRl9PS3xvcy5SX09LKToKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2hkaXIoY3dkKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3dkCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICMgd2Ugd29uJ3QgZXJyb3IgaGVyZSwgYXMgaXQgbWF5ICpub3QqIGJlIGEgcHJvYmxlbSwKICAgICAgICAjIGFuZCB3ZSBkb24ndCB3YW50IHRvIGJyZWFrIG1vZHVsZXMgdW5uZWNlc3NhcmlseQogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGdldF9iaW5fcGF0aChzZWxmLCBhcmcsIHJlcXVpcmVkPUZhbHNlLCBvcHRfZGlycz1bXSk6CiAgICAgICAgJycnCiAgICAgICAgZmluZCBzeXN0ZW0gZXhlY3V0YWJsZSBpbiBQQVRILgogICAgICAgIE9wdGlvbmFsIGFyZ3VtZW50czoKICAgICAgICAgICAtIHJlcXVpcmVkOiAgaWYgZXhlY3V0YWJsZSBpcyBub3QgZm91bmQgYW5kIHJlcXVpcmVkIGlzIHRydWUsIGZhaWxfanNvbgogICAgICAgICAgIC0gb3B0X2RpcnM6ICBvcHRpb25hbCBsaXN0IG9mIGRpcmVjdG9yaWVzIHRvIHNlYXJjaCBpbiBhZGRpdGlvbiB0byBQQVRICiAgICAgICAgaWYgZm91bmQgcmV0dXJuIGZ1bGwgcGF0aDsgb3RoZXJ3aXNlIHJldHVybiBOb25lCiAgICAgICAgJycnCiAgICAgICAgc2Jpbl9wYXRocyA9IFsnL3NiaW4nLCAnL3Vzci9zYmluJywgJy91c3IvbG9jYWwvc2JpbiddCiAgICAgICAgcGF0aHMgPSBbXQogICAgICAgIGZvciBkIGluIG9wdF9kaXJzOgogICAgICAgICAgICBpZiBkIGlzIG5vdCBOb25lIGFuZCBvcy5wYXRoLmV4aXN0cyhkKToKICAgICAgICAgICAgICAgIHBhdGhzLmFwcGVuZChkKQogICAgICAgIHBhdGhzICs9IG9zLmVudmlyb24uZ2V0KCdQQVRIJywgJycpLnNwbGl0KG9zLnBhdGhzZXApCiAgICAgICAgYmluX3BhdGggPSBOb25lCiAgICAgICAgIyBtYW5nbGUgUEFUSCB0byBpbmNsdWRlIC9zYmluIGRpcnMKICAgICAgICBmb3IgcCBpbiBzYmluX3BhdGhzOgogICAgICAgICAgICBpZiBwIG5vdCBpbiBwYXRocyBhbmQgb3MucGF0aC5leGlzdHMocCk6CiAgICAgICAgICAgICAgICBwYXRocy5hcHBlbmQocCkKICAgICAgICBmb3IgZCBpbiBwYXRoczoKICAgICAgICAgICAgaWYgbm90IGQ6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBwYXRoID0gb3MucGF0aC5qb2luKGQsIGFyZykKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocGF0aCkgYW5kIG5vdCBvcy5wYXRoLmlzZGlyKHBhdGgpIGFuZCBpc19leGVjdXRhYmxlKHBhdGgpOgogICAgICAgICAgICAgICAgYmluX3BhdGggPSBwYXRoCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGlmIHJlcXVpcmVkIGFuZCBiaW5fcGF0aCBpcyBOb25lOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0ZhaWxlZCB0byBmaW5kIHJlcXVpcmVkIGV4ZWN1dGFibGUgJXMgaW4gcGF0aHM6ICVzJyAlIChhcmcsIG9zLnBhdGhzZXAuam9pbihwYXRocykpKQogICAgICAgIHJldHVybiBiaW5fcGF0aAoKICAgIGRlZiBib29sZWFuKHNlbGYsIGFyZyk6CiAgICAgICAgJycnIHJldHVybiBhIGJvb2wgZm9yIHRoZSBhcmcgJycnCiAgICAgICAgaWYgYXJnIGlzIE5vbmUgb3IgaXNpbnN0YW5jZShhcmcsIGJvb2wpOgogICAgICAgICAgICByZXR1cm4gYXJnCiAgICAgICAgaWYgaXNpbnN0YW5jZShhcmcsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIGFyZyA9IGFyZy5sb3dlcigpCiAgICAgICAgaWYgYXJnIGluIEJPT0xFQU5TX1RSVUU6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxpZiBhcmcgaW4gQk9PTEVBTlNfRkFMU0U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nJXMgaXMgbm90IGEgdmFsaWQgYm9vbGVhbi4gVmFsaWQgYm9vbGVhbnMgaW5jbHVkZTogJXMnICUgKHRvX3RleHQoYXJnKSwgJywnLmpvaW4oWyclcycgJSB4IGZvciB4IGluIEJPT0xFQU5TXSkpKQoKICAgIGRlZiBqc29uaWZ5KHNlbGYsIGRhdGEpOgogICAgICAgIGZvciBlbmNvZGluZyBpbiAoInV0Zi04IiwgImxhdGluLTEiKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24uZHVtcHMoZGF0YSwgZW5jb2Rpbmc9ZW5jb2RpbmcpCiAgICAgICAgICAgICMgT2xkIHN5c3RlbXMgdXNpbmcgb2xkIHNpbXBsZWpzb24gbW9kdWxlIGRvZXMgbm90IHN1cHBvcnQgZW5jb2Rpbmcga2V5d29yZC4KICAgICAgICAgICAgZXhjZXB0IFR5cGVFcnJvcjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBuZXdfZGF0YSA9IGpzb25fZGljdF9ieXRlc190b191bmljb2RlKGRhdGEsIGVuY29kaW5nPWVuY29kaW5nKQogICAgICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVEZWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24uZHVtcHMobmV3X2RhdGEpCiAgICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRGVjb2RlRXJyb3I6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nSW52YWxpZCB1bmljb2RlIGVuY29kaW5nIGVuY291bnRlcmVkJykKCiAgICBkZWYgZnJvbV9qc29uKHNlbGYsIGRhdGEpOgogICAgICAgIHJldHVybiBqc29uLmxvYWRzKGRhdGEpCgogICAgZGVmIGFkZF9jbGVhbnVwX2ZpbGUoc2VsZiwgcGF0aCk6CiAgICAgICAgaWYgcGF0aCBub3QgaW4gc2VsZi5jbGVhbnVwX2ZpbGVzOgogICAgICAgICAgICBzZWxmLmNsZWFudXBfZmlsZXMuYXBwZW5kKHBhdGgpCgogICAgZGVmIGRvX2NsZWFudXBfZmlsZXMoc2VsZik6CiAgICAgICAgZm9yIHBhdGggaW4gc2VsZi5jbGVhbnVwX2ZpbGVzOgogICAgICAgICAgICBzZWxmLmNsZWFudXAocGF0aCkKCiAgICBkZWYgX3JldHVybl9mb3JtYXR0ZWQoc2VsZiwga3dhcmdzKToKCiAgICAgICAgc2VsZi5hZGRfcGF0aF9pbmZvKGt3YXJncykKCiAgICAgICAgaWYgJ2ludm9jYXRpb24nIG5vdCBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGt3YXJnc1snaW52b2NhdGlvbiddID0geydtb2R1bGVfYXJncyc6IHNlbGYucGFyYW1zfQoKICAgICAgICBpZiAnd2FybmluZ3MnIGluIGt3YXJnczoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShrd2FyZ3NbJ3dhcm5pbmdzJ10sIGxpc3QpOgogICAgICAgICAgICAgICAgZm9yIHcgaW4ga3dhcmdzWyd3YXJuaW5ncyddOgogICAgICAgICAgICAgICAgICAgIHNlbGYud2Fybih3KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi53YXJuKGt3YXJnc1snd2FybmluZ3MnXSkKCiAgICAgICAgaWYgc2VsZi5fd2FybmluZ3M6CiAgICAgICAgICAgIGt3YXJnc1snd2FybmluZ3MnXSA9IHNlbGYuX3dhcm5pbmdzCgogICAgICAgIGlmICdkZXByZWNhdGlvbnMnIGluIGt3YXJnczoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddLCBsaXN0KToKICAgICAgICAgICAgICAgIGZvciBkIGluIGt3YXJnc1snZGVwcmVjYXRpb25zJ106CiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkLCBTRVFVRU5DRVRZUEUpIGFuZCBsZW4oZCkgPT0gMjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kZXByZWNhdGUoZFswXSwgdmVyc2lvbj1kWzFdKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGVwcmVjYXRlKGQpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmRlcHJlY2F0ZShrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddKQoKICAgICAgICBpZiBzZWxmLl9kZXByZWNhdGlvbnM6CiAgICAgICAgICAgIGt3YXJnc1snZGVwcmVjYXRpb25zJ10gPSBzZWxmLl9kZXByZWNhdGlvbnMKCiAgICAgICAga3dhcmdzID0gcmVtb3ZlX3ZhbHVlcyhrd2FyZ3MsIHNlbGYubm9fbG9nX3ZhbHVlcykKICAgICAgICBwcmludCgnXG4lcycgJSBzZWxmLmpzb25pZnkoa3dhcmdzKSkKCiAgICBkZWYgZXhpdF9qc29uKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAnJycgcmV0dXJuIGZyb20gdGhlIG1vZHVsZSwgd2l0aG91dCBlcnJvciAnJycKCiAgICAgICAgaWYgbm90ICdjaGFuZ2VkJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGt3YXJnc1snY2hhbmdlZCddID0gRmFsc2UKCiAgICAgICAgc2VsZi5kb19jbGVhbnVwX2ZpbGVzKCkKICAgICAgICBzZWxmLl9yZXR1cm5fZm9ybWF0dGVkKGt3YXJncykKICAgICAgICBzeXMuZXhpdCgwKQoKICAgIGRlZiBmYWlsX2pzb24oc2VsZiwgKiprd2FyZ3MpOgogICAgICAgICcnJyByZXR1cm4gZnJvbSB0aGUgbW9kdWxlLCB3aXRoIGFuIGVycm9yIG1lc3NhZ2UgJycnCgogICAgICAgIGFzc2VydCAnbXNnJyBpbiBrd2FyZ3MsICJpbXBsZW1lbnRhdGlvbiBlcnJvciAtLSBtc2cgdG8gZXhwbGFpbiB0aGUgZXJyb3IgaXMgcmVxdWlyZWQiCiAgICAgICAga3dhcmdzWydmYWlsZWQnXSA9IFRydWUKCiAgICAgICAgaWYgbm90ICdjaGFuZ2VkJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGt3YXJnc1snY2hhbmdlZCddID0gRmFsc2UKCiAgICAgICAgc2VsZi5kb19jbGVhbnVwX2ZpbGVzKCkKICAgICAgICBzZWxmLl9yZXR1cm5fZm9ybWF0dGVkKGt3YXJncykKICAgICAgICBzeXMuZXhpdCgxKQoKICAgIGRlZiBmYWlsX29uX21pc3NpbmdfcGFyYW1zKHNlbGYsIHJlcXVpcmVkX3BhcmFtcz1Ob25lKToKICAgICAgICAnJycgVGhpcyBpcyBmb3IgY2hlY2tpbmcgZm9yIHJlcXVpcmVkIHBhcmFtcyB3aGVuIHdlIGNhbiBub3QgY2hlY2sgdmlhIGFyZ3NwZWMgYmVjYXVzZSB3ZQogICAgICAgIG5lZWQgbW9yZSBpbmZvcm1hdGlvbiB0aGFuIGlzIHNpbXBseSBnaXZlbiBpbiB0aGUgYXJnc3BlYy4KICAgICAgICAnJycKICAgICAgICBpZiBub3QgcmVxdWlyZWRfcGFyYW1zOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBtaXNzaW5nX3BhcmFtcyA9IFtdCiAgICAgICAgZm9yIHJlcXVpcmVkX3BhcmFtIGluIHJlcXVpcmVkX3BhcmFtczoKICAgICAgICAgICAgaWYgbm90IHNlbGYucGFyYW1zLmdldChyZXF1aXJlZF9wYXJhbSk6CiAgICAgICAgICAgICAgICBtaXNzaW5nX3BhcmFtcy5hcHBlbmQocmVxdWlyZWRfcGFyYW0pCiAgICAgICAgaWYgbWlzc2luZ19wYXJhbXM6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0ibWlzc2luZyByZXF1aXJlZCBhcmd1bWVudHM6ICVzIiAlICcsJy5qb2luKG1pc3NpbmdfcGFyYW1zKSkKCiAgICBkZWYgZGlnZXN0X2Zyb21fZmlsZShzZWxmLCBmaWxlbmFtZSwgYWxnb3JpdGhtKToKICAgICAgICAnJycgUmV0dXJuIGhleCBkaWdlc3Qgb2YgbG9jYWwgZmlsZSBmb3IgYSBkaWdlc3RfbWV0aG9kIHNwZWNpZmllZCBieSBuYW1lLCBvciBOb25lIGlmIGZpbGUgaXMgbm90IHByZXNlbnQuICcnJwogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlbmFtZSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgaWYgb3MucGF0aC5pc2RpcihmaWxlbmFtZSk6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iYXR0ZW1wdGVkIHRvIHRha2UgY2hlY2tzdW0gb2YgZGlyZWN0b3J5OiAlcyIgJSBmaWxlbmFtZSkKCiAgICAgICAgIyBwcmVzZXJ2ZSBvbGQgYmVoYXZpb3VyIHdoZXJlIHRoZSB0aGlyZCBwYXJhbWV0ZXIgd2FzIGEgaGFzaCBhbGdvcml0aG0gb2JqZWN0CiAgICAgICAgaWYgaGFzYXR0cihhbGdvcml0aG0sICdoZXhkaWdlc3QnKToKICAgICAgICAgICAgZGlnZXN0X21ldGhvZCA9IGFsZ29yaXRobQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRpZ2VzdF9tZXRob2QgPSBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TW2FsZ29yaXRobV0oKQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IkNvdWxkIG5vdCBoYXNoIGZpbGUgJyVzJyB3aXRoIGFsZ29yaXRobSAnJXMnLiBBdmFpbGFibGUgYWxnb3JpdGhtczogJXMiICUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZmlsZW5hbWUsIGFsZ29yaXRobSwgJywgJy5qb2luKEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVMpKSkKCiAgICAgICAgYmxvY2tzaXplID0gNjQgKiAxMDI0CiAgICAgICAgaW5maWxlID0gb3Blbihvcy5wYXRoLnJlYWxwYXRoKGZpbGVuYW1lKSwgJ3JiJykKICAgICAgICBibG9jayA9IGluZmlsZS5yZWFkKGJsb2Nrc2l6ZSkKICAgICAgICB3aGlsZSBibG9jazoKICAgICAgICAgICAgZGlnZXN0X21ldGhvZC51cGRhdGUoYmxvY2spCiAgICAgICAgICAgIGJsb2NrID0gaW5maWxlLnJlYWQoYmxvY2tzaXplKQogICAgICAgIGluZmlsZS5jbG9zZSgpCiAgICAgICAgcmV0dXJuIGRpZ2VzdF9tZXRob2QuaGV4ZGlnZXN0KCkKCiAgICBkZWYgbWQ1KHNlbGYsIGZpbGVuYW1lKToKICAgICAgICAnJycgUmV0dXJuIE1ENSBoZXggZGlnZXN0IG9mIGxvY2FsIGZpbGUgdXNpbmcgZGlnZXN0X2Zyb21fZmlsZSgpLgoKICAgICAgICBEbyBub3QgdXNlIHRoaXMgZnVuY3Rpb24gdW5sZXNzIHlvdSBoYXZlIG5vIG90aGVyIGNob2ljZSBmb3I6CiAgICAgICAgICAgIDEpIE9wdGlvbmFsIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CiAgICAgICAgICAgIDIpIENvbXBhdGliaWxpdHkgd2l0aCBhIHRoaXJkIHBhcnR5IHByb3RvY29sCgogICAgICAgIFRoaXMgZnVuY3Rpb24gd2lsbCBub3Qgd29yayBvbiBzeXN0ZW1zIGNvbXBseWluZyB3aXRoIEZJUFMtMTQwLTIuCgogICAgICAgIE1vc3QgdXNlcyBvZiB0aGlzIGZ1bmN0aW9uIGNhbiB1c2UgdGhlIG1vZHVsZS5zaGExIGZ1bmN0aW9uIGluc3RlYWQuCiAgICAgICAgJycnCiAgICAgICAgaWYgJ21kNScgbm90IGluIEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVM6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ01ENSBub3QgYXZhaWxhYmxlLiAgUG9zc2libHkgcnVubmluZyBpbiBGSVBTIG1vZGUnKQogICAgICAgIHJldHVybiBzZWxmLmRpZ2VzdF9mcm9tX2ZpbGUoZmlsZW5hbWUsICdtZDUnKQoKICAgIGRlZiBzaGExKHNlbGYsIGZpbGVuYW1lKToKICAgICAgICAnJycgUmV0dXJuIFNIQTEgaGV4IGRpZ2VzdCBvZiBsb2NhbCBmaWxlIHVzaW5nIGRpZ2VzdF9mcm9tX2ZpbGUoKS4gJycnCiAgICAgICAgcmV0dXJuIHNlbGYuZGlnZXN0X2Zyb21fZmlsZShmaWxlbmFtZSwgJ3NoYTEnKQoKICAgIGRlZiBzaGEyNTYoc2VsZiwgZmlsZW5hbWUpOgogICAgICAgICcnJyBSZXR1cm4gU0hBLTI1NiBoZXggZGlnZXN0IG9mIGxvY2FsIGZpbGUgdXNpbmcgZGlnZXN0X2Zyb21fZmlsZSgpLiAnJycKICAgICAgICByZXR1cm4gc2VsZi5kaWdlc3RfZnJvbV9maWxlKGZpbGVuYW1lLCAnc2hhMjU2JykKCiAgICBkZWYgYmFja3VwX2xvY2FsKHNlbGYsIGZuKToKICAgICAgICAnJydtYWtlIGEgZGF0ZS1tYXJrZWQgYmFja3VwIG9mIHRoZSBzcGVjaWZpZWQgZmlsZSwgcmV0dXJuIFRydWUgb3IgRmFsc2Ugb24gc3VjY2VzcyBvciBmYWlsdXJlJycnCgogICAgICAgIGJhY2t1cGRlc3QgPSAnJwogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGZuKToKICAgICAgICAgICAgIyBiYWNrdXBzIG5hbWVkIGJhc2VuYW1lLlBJRC5ZWVlZLU1NLUREQEhIOk1NOlNTfgogICAgICAgICAgICBleHQgPSB0aW1lLnN0cmZ0aW1lKCIlWS0lbS0lZEAlSDolTTolU34iLCB0aW1lLmxvY2FsdGltZSh0aW1lLnRpbWUoKSkpCiAgICAgICAgICAgIGJhY2t1cGRlc3QgPSAnJXMuJXMuJXMnICUgKGZuLCBvcy5nZXRwaWQoKSwgZXh0KQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHkyKGZuLCBiYWNrdXBkZXN0KQogICAgICAgICAgICBleGNlcHQgKHNodXRpbC5FcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0NvdWxkIG5vdCBtYWtlIGJhY2t1cCBvZiAlcyB0byAlczogJXMnICUgKGZuLCBiYWNrdXBkZXN0LCBlKSkKCiAgICAgICAgcmV0dXJuIGJhY2t1cGRlc3QKCiAgICBkZWYgY2xlYW51cChzZWxmLCB0bXBmaWxlKToKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh0bXBmaWxlKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MudW5saW5rKHRtcGZpbGUpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc3lzLnN0ZGVyci53cml0ZSgiY291bGQgbm90IGNsZWFudXAgJXM6ICVzIiAlICh0bXBmaWxlLCBlKSkKCiAgICBkZWYgYXRvbWljX21vdmUoc2VsZiwgc3JjLCBkZXN0LCB1bnNhZmVfd3JpdGVzPUZhbHNlKToKICAgICAgICAnJydhdG9taWNhbGx5IG1vdmUgc3JjIHRvIGRlc3QsIGNvcHlpbmcgYXR0cmlidXRlcyBmcm9tIGRlc3QsIHJldHVybnMgdHJ1ZSBvbiBzdWNjZXNzCiAgICAgICAgaXQgdXNlcyBvcy5yZW5hbWUgdG8gZW5zdXJlIHRoaXMgYXMgaXQgaXMgYW4gYXRvbWljIG9wZXJhdGlvbiwgcmVzdCBvZiB0aGUgZnVuY3Rpb24gaXMKICAgICAgICB0byB3b3JrIGFyb3VuZCBsaW1pdGF0aW9ucywgY29ybmVyIGNhc2VzIGFuZCBlbnN1cmUgc2VsaW51eCBjb250ZXh0IGlzIHNhdmVkIGlmIHBvc3NpYmxlJycnCiAgICAgICAgY29udGV4dCA9IE5vbmUKICAgICAgICBkZXN0X3N0YXQgPSBOb25lCiAgICAgICAgYl9zcmMgPSB0b19ieXRlcyhzcmMsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgYl9kZXN0ID0gdG9fYnl0ZXMoZGVzdCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhiX2Rlc3QpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZXN0X3N0YXQgPSBvcy5zdGF0KGJfZGVzdCkKCiAgICAgICAgICAgICAgICAjIGNvcHkgbW9kZSBhbmQgb3duZXJzaGlwCiAgICAgICAgICAgICAgICBvcy5jaG1vZChiX3NyYywgZGVzdF9zdGF0LnN0X21vZGUgJiBQRVJNX0JJVFMpCiAgICAgICAgICAgICAgICBvcy5jaG93bihiX3NyYywgZGVzdF9zdGF0LnN0X3VpZCwgZGVzdF9zdGF0LnN0X2dpZCkKCiAgICAgICAgICAgICAgICAjIHRyeSB0byBjb3B5IGZsYWdzIGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKG9zLCAnY2hmbGFncycpIGFuZCBoYXNhdHRyKGRlc3Rfc3RhdCwgJ3N0X2ZsYWdzJyk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBvcy5jaGZsYWdzKGJfc3JjLCBkZXN0X3N0YXQuc3RfZmxhZ3MpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGVyciBpbiAnRU9QTk9UU1VQUCcsICdFTk9UU1VQJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoZXJybm8sIGVycikgYW5kIGUuZXJybm8gPT0gZ2V0YXR0cihlcnJubywgZXJyKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBpZiBlLmVycm5vICE9IGVycm5vLkVQRVJNOgogICAgICAgICAgICAgICAgICAgIHJhaXNlCiAgICAgICAgICAgIGlmIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2NvbnRleHQoZGVzdCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9kZWZhdWx0X2NvbnRleHQoZGVzdCkKCiAgICAgICAgY3JlYXRpbmcgPSBub3Qgb3MucGF0aC5leGlzdHMoYl9kZXN0KQoKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgT3B0aW1pc3RpY2FsbHkgdHJ5IGEgcmVuYW1lLCBzb2x2ZXMgc29tZSBjb3JuZXIgY2FzZXMgYW5kIGNhbiBhdm9pZCB1c2VsZXNzIHdvcmssIHRocm93cyBleGNlcHRpb24gaWYgbm90IGF0b21pYy4KICAgICAgICAgICAgb3MucmVuYW1lKGJfc3JjLCBiX2Rlc3QpCiAgICAgICAgZXhjZXB0IChJT0Vycm9yLCBPU0Vycm9yKToKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBpZiBlLmVycm5vIG5vdCBpbiBbZXJybm8uRVBFUk0sIGVycm5vLkVYREVWLCBlcnJuby5FQUNDRVMsIGVycm5vLkVUWFRCU1ksIGVycm5vLkVCVVNZXToKICAgICAgICAgICAgICAgICMgb25seSB0cnkgd29ya2Fyb3VuZHMgZm9yIGVycm5vIDE4IChjcm9zcyBkZXZpY2UpLCAxIChub3QgcGVybWl0dGVkKSwgIDEzIChwZXJtaXNzaW9uIGRlbmllZCkKICAgICAgICAgICAgICAgICMgYW5kIDI2ICh0ZXh0IGZpbGUgYnVzeSkgd2hpY2ggaGFwcGVucyBvbiB2YWdyYW50IHN5bmNlZCBmb2xkZXJzIGFuZCBvdGhlciAnZXhvdGljJyBub24gcG9zaXggZmlsZSBzeXN0ZW1zCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0NvdWxkIG5vdCByZXBsYWNlIGZpbGU6ICVzIHRvICVzOiAlcycgJSAoc3JjLCBkZXN0LCBlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBiX2Rlc3RfZGlyID0gb3MucGF0aC5kaXJuYW1lKGJfZGVzdCkKICAgICAgICAgICAgICAgICMgVXNlIGJ5dGVzIGhlcmUuICBJbiB0aGUgc2hpcHBhYmxlIENJLCB0aGlzIGZhaWxzIHdpdGgKICAgICAgICAgICAgICAgICMgYSBVbmljb2RlRXJyb3Igd2l0aCBzdXJyb2dhdGVlc2NhcGUnZCBzdHJpbmdzIGZvciBhbiB1bmtub3duCiAgICAgICAgICAgICAgICAjIHJlYXNvbiAoZG9lc24ndCBoYXBwZW4gaW4gYSBsb2NhbCBVYnVudHUxNi4wNCBWTSkKICAgICAgICAgICAgICAgIG5hdGl2ZV9kZXN0X2RpciA9IGJfZGVzdF9kaXIKICAgICAgICAgICAgICAgIG5hdGl2ZV9zdWZmaXggPSBvcy5wYXRoLmJhc2VuYW1lKGJfZGVzdCkKICAgICAgICAgICAgICAgIG5hdGl2ZV9wcmVmaXggPSBiKCcuYW5zaWJsZV90bXAnKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHRtcF9kZXN0X2ZkLCB0bXBfZGVzdF9uYW1lID0gdGVtcGZpbGUubWtzdGVtcCggcHJlZml4PW5hdGl2ZV9wcmVmaXgsIGRpcj1uYXRpdmVfZGVzdF9kaXIsIHN1ZmZpeD1uYXRpdmVfc3VmZml4KQogICAgICAgICAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdUaGUgZGVzdGluYXRpb24gZGlyZWN0b3J5ICglcykgaXMgbm90IHdyaXRhYmxlIGJ5IHRoZSBjdXJyZW50IHVzZXIuIEVycm9yIHdhczogJXMnICUgKG9zLnBhdGguZGlybmFtZShkZXN0KSwgZSkpCiAgICAgICAgICAgICAgICBleGNlcHQgVHlwZUVycm9yOgogICAgICAgICAgICAgICAgICAgICMgV2UgZXhwZWN0IHRoYXQgdGhpcyBpcyBoYXBwZW5pbmcgYmVjYXVzZSBweXRob24zLjQueCBhbmQKICAgICAgICAgICAgICAgICAgICAjIGJlbG93IGNhbid0IGhhbmRsZSBieXRlIHN0cmluZ3MgaW4gbWtzdGVtcCgpLiAgVHJhY2ViYWNrCiAgICAgICAgICAgICAgICAgICAgIyB3b3VsZCBlbmQgaW4gc29tZXRoaW5nIGxpa2U6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgZmlsZSA9IF9vcy5wYXRoLmpvaW4oZGlyLCBwcmUgKyBuYW1lICsgc3VmKQogICAgICAgICAgICAgICAgICAgICMgVHlwZUVycm9yOiBjYW4ndCBjb25jYXQgYnl0ZXMgdG8gc3RyCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdGYWlsZWQgY3JlYXRpbmcgdGVtcCBmaWxlIGZvciBhdG9taWMgbW92ZS4gIFRoaXMgdXN1YWxseSBoYXBwZW5zIHdoZW4gdXNpbmcgUHl0aG9uMyBsZXNzIHRoYW4gUHl0aG9uMy41LiAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdQbGVhc2UgdXNlIFB5dGhvbjIueCBvciBQeXRob24zLjUgb3IgZ3JlYXRlci4nLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKCiAgICAgICAgICAgICAgICBiX3RtcF9kZXN0X25hbWUgPSB0b19ieXRlcyh0bXBfZGVzdF9uYW1lLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgY2xvc2UgdG1wIGZpbGUgaGFuZGxlIGJlZm9yZSBmaWxlIG9wZXJhdGlvbnMgdG8gcHJldmVudCB0ZXh0IGZpbGUgYnVzeSBlcnJvcnMgb24gdmJveGZzIHN5bmNlZCBmb2xkZXJzICh3aW5kb3dzIGhvc3QpCiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNsb3NlKHRtcF9kZXN0X2ZkKQogICAgICAgICAgICAgICAgICAgICAgICAjIGxlYXZlcyB0bXAgZmlsZSBiZWhpbmQgd2hlbiBzdWRvIGFuZCBub3Qgcm9vdAogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaHV0aWwubW92ZShiX3NyYywgYl90bXBfZGVzdF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgY2xlYW51cCB3aWxsIGhhcHBlbiBieSAncm0nIG9mIHRlbXBkaXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgY29weTIgd2lsbCBwcmVzZXJ2ZSBzb21lIG1ldGFkYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaHV0aWwuY29weTIoYl9zcmMsIGJfdG1wX2Rlc3RfbmFtZSkKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiX3RtcF9kZXN0X25hbWUsIGNvbnRleHQsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBfc3RhdCA9IG9zLnN0YXQoYl90bXBfZGVzdF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZGVzdF9zdGF0IGFuZCAodG1wX3N0YXQuc3RfdWlkICE9IGRlc3Rfc3RhdC5zdF91aWQgb3IgdG1wX3N0YXQuc3RfZ2lkICE9IGRlc3Rfc3RhdC5zdF9naWQpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNob3duKGJfdG1wX2Rlc3RfbmFtZSwgZGVzdF9zdGF0LnN0X3VpZCwgZGVzdF9zdGF0LnN0X2dpZCkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBlLmVycm5vICE9IGVycm5vLkVQRVJNOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLnJlbmFtZShiX3RtcF9kZXN0X25hbWUsIGJfZGVzdCkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdW5zYWZlX3dyaXRlcyBhbmQgZS5lcnJubyA9PSBlcnJuby5FQlVTWToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91bnNhZmVfd3JpdGVzKGJfdG1wX2Rlc3RfbmFtZSwgYl9kZXN0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J1VuYWJsZSB0byByZW5hbWUgZmlsZTogJXMgdG8gJXM6ICVzJyAlIChzcmMsIGRlc3QsIGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgKHNodXRpbC5FcnJvciwgT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdGYWlsZWQgdG8gcmVwbGFjZSBmaWxlOiAlcyB0byAlczogJXMnICUgKHNyYywgZGVzdCwgZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQogICAgICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgICAgICBzZWxmLmNsZWFudXAoYl90bXBfZGVzdF9uYW1lKQoKICAgICAgICBpZiBjcmVhdGluZzoKICAgICAgICAgICAgIyBtYWtlIHN1cmUgdGhlIGZpbGUgaGFzIHRoZSBjb3JyZWN0IHBlcm1pc3Npb25zCiAgICAgICAgICAgICMgYmFzZWQgb24gdGhlIGN1cnJlbnQgdmFsdWUgb2YgdW1hc2sKICAgICAgICAgICAgdW1hc2sgPSBvcy51bWFzaygwKQogICAgICAgICAgICBvcy51bWFzayh1bWFzaykKICAgICAgICAgICAgb3MuY2htb2QoYl9kZXN0LCBERUZBVUxUX1BFUk0gJiB+dW1hc2spCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLmNob3duKGJfZGVzdCwgb3MuZ2V0ZXVpZCgpLCBvcy5nZXRlZ2lkKCkpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgIyBXZSdyZSBva2F5IHdpdGggdHJ5aW5nIG91ciBiZXN0IGhlcmUuICBJZiB0aGUgdXNlciBpcyBub3QKICAgICAgICAgICAgICAgICMgcm9vdCAob3Igb2xkIFVuaWNlcykgdGhleSB3b24ndCBiZSBhYmxlIHRvIGNob3duLgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAjIHJlbmFtZSBtaWdodCBub3QgcHJlc2VydmUgY29udGV4dAogICAgICAgICAgICBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudChkZXN0LCBjb250ZXh0LCBGYWxzZSkKCiAgICBkZWYgX3Vuc2FmZV93cml0ZXMoc2VsZiwgc3JjLCBkZXN0KToKICAgICAgICAjIHNhZGx5IHRoZXJlIGFyZSBzb21lIHNpdHVhdGlvbnMgd2hlcmUgd2UgY2Fubm90IGVuc3VyZSBhdG9taWNpdHksIGJ1dCBvbmx5IGlmCiAgICAgICAgIyB0aGUgdXNlciBpbnNpc3RzIGFuZCB3ZSBnZXQgdGhlIGFwcHJvcHJpYXRlIGVycm9yIHdlIHVwZGF0ZSB0aGUgZmlsZSB1bnNhZmVseQogICAgICAgIHRyeToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3V0X2Rlc3QgPSBvcGVuKGRlc3QsICd3YicpCiAgICAgICAgICAgICAgICBpbl9zcmMgPSBvcGVuKHNyYywgJ3JiJykKICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5ZmlsZW9iaihpbl9zcmMsIG91dF9kZXN0KQogICAgICAgICAgICBmaW5hbGx5OiAgIyBhc3N1cmluZyBjbG9zZWQgZmlsZXMgaW4gMi40IGNvbXBhdGlibGUgd2F5CiAgICAgICAgICAgICAgICBpZiBvdXRfZGVzdDoKICAgICAgICAgICAgICAgICAgICBvdXRfZGVzdC5jbG9zZSgpCiAgICAgICAgICAgICAgICBpZiBpbl9zcmM6CiAgICAgICAgICAgICAgICAgICAgaW5fc3JjLmNsb3NlKCkKICAgICAgICBleGNlcHQgKHNodXRpbC5FcnJvciwgT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdDb3VsZCBub3Qgd3JpdGUgZGF0YSB0byBmaWxlICglcykgZnJvbSAoJXMpOiAlcycgJSAoZGVzdCwgc3JjLCBlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCgoKICAgIGRlZiBfcmVhZF9mcm9tX3BpcGVzKHNlbGYsIHJwaXBlcywgcmZkcywgZmlsZV9kZXNjcmlwdG9yKToKICAgICAgICBkYXRhID0gYignJykKICAgICAgICBpZiBmaWxlX2Rlc2NyaXB0b3IgaW4gcmZkczoKICAgICAgICAgICAgZGF0YSA9IG9zLnJlYWQoZmlsZV9kZXNjcmlwdG9yLmZpbGVubygpLCA5MDAwKQogICAgICAgICAgICBpZiBkYXRhID09IGIoJycpOgogICAgICAgICAgICAgICAgcnBpcGVzLnJlbW92ZShmaWxlX2Rlc2NyaXB0b3IpCgogICAgICAgIHJldHVybiBkYXRhCgogICAgZGVmIHJ1bl9jb21tYW5kKHNlbGYsIGFyZ3MsIGNoZWNrX3JjPUZhbHNlLCBjbG9zZV9mZHM9VHJ1ZSwgZXhlY3V0YWJsZT1Ob25lLCBkYXRhPU5vbmUsIGJpbmFyeV9kYXRhPUZhbHNlLCBwYXRoX3ByZWZpeD1Ob25lLCBjd2Q9Tm9uZSwKICAgICAgICAgICAgICAgICAgICB1c2VfdW5zYWZlX3NoZWxsPUZhbHNlLCBwcm9tcHRfcmVnZXg9Tm9uZSwgZW52aXJvbl91cGRhdGU9Tm9uZSwgdW1hc2s9Tm9uZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0Jyk6CiAgICAgICAgJycnCiAgICAgICAgRXhlY3V0ZSBhIGNvbW1hbmQsIHJldHVybnMgcmMsIHN0ZG91dCwgYW5kIHN0ZGVyci4KCiAgICAgICAgOmFyZyBhcmdzOiBpcyB0aGUgY29tbWFuZCB0byBydW4KICAgICAgICAgICAgKiBJZiBhcmdzIGlzIGEgbGlzdCwgdGhlIGNvbW1hbmQgd2lsbCBiZSBydW4gd2l0aCBzaGVsbD1GYWxzZS4KICAgICAgICAgICAgKiBJZiBhcmdzIGlzIGEgc3RyaW5nIGFuZCB1c2VfdW5zYWZlX3NoZWxsPUZhbHNlIGl0IHdpbGwgc3BsaXQgYXJncyB0byBhIGxpc3QgYW5kIHJ1biB3aXRoIHNoZWxsPUZhbHNlCiAgICAgICAgICAgICogSWYgYXJncyBpcyBhIHN0cmluZyBhbmQgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlIGl0IHJ1bnMgd2l0aCBzaGVsbD1UcnVlLgogICAgICAgIDprdyBjaGVja19yYzogV2hldGhlciB0byBjYWxsIGZhaWxfanNvbiBpbiBjYXNlIG9mIG5vbiB6ZXJvIFJDLgogICAgICAgICAgICBEZWZhdWx0IEZhbHNlCiAgICAgICAgOmt3IGNsb3NlX2ZkczogU2VlIGRvY3VtZW50YXRpb24gZm9yIHN1YnByb2Nlc3MuUG9wZW4oKS4gRGVmYXVsdCBUcnVlCiAgICAgICAgOmt3IGV4ZWN1dGFibGU6IFNlZSBkb2N1bWVudGF0aW9uIGZvciBzdWJwcm9jZXNzLlBvcGVuKCkuIERlZmF1bHQgTm9uZQogICAgICAgIDprdyBkYXRhOiBJZiBnaXZlbiwgaW5mb3JtYXRpb24gdG8gd3JpdGUgdG8gdGhlIHN0ZGluIG9mIHRoZSBjb21tYW5kCiAgICAgICAgOmt3IGJpbmFyeV9kYXRhOiBJZiBGYWxzZSwgYXBwZW5kIGEgbmV3bGluZSB0byB0aGUgZGF0YS4gIERlZmF1bHQgRmFsc2UKICAgICAgICA6a3cgcGF0aF9wcmVmaXg6IElmIGdpdmVuLCBhZGRpdGlvbmFsIHBhdGggdG8gZmluZCB0aGUgY29tbWFuZCBpbi4KICAgICAgICAgICAgVGhpcyBhZGRzIHRvIHRoZSBQQVRIIGVudmlyb25tZW50IHZhaXJhYmxlIHNvIGhlbHBlciBjb21tYW5kcyBpbgogICAgICAgICAgICB0aGUgc2FtZSBkaXJlY3RvcnkgY2FuIGFsc28gYmUgZm91bmQKICAgICAgICA6a3cgY3dkOiBJZiBnaXZlbiwgd29ya2luZyBkaXJlY3RvcnkgdG8gcnVuIHRoZSBjb21tYW5kIGluc2lkZQogICAgICAgIDprdyB1c2VfdW5zYWZlX3NoZWxsOiBTZWUgYGFyZ3NgIHBhcmFtZXRlci4gIERlZmF1bHQgRmFsc2UKICAgICAgICA6a3cgcHJvbXB0X3JlZ2V4OiBSZWdleCBzdHJpbmcgKG5vdCBhIGNvbXBpbGVkIHJlZ2V4KSB3aGljaCBjYW4gYmUKICAgICAgICAgICAgdXNlZCB0byBkZXRlY3QgcHJvbXB0cyBpbiB0aGUgc3Rkb3V0IHdoaWNoIHdvdWxkIG90aGVyd2lzZSBjYXVzZQogICAgICAgICAgICB0aGUgZXhlY3V0aW9uIHRvIGhhbmcgKGVzcGVjaWFsbHkgaWYgbm8gaW5wdXQgZGF0YSBpcyBzcGVjaWZpZWQpCiAgICAgICAgOmt3IGVudmlyb25fdXBkYXRlOiBkaWN0aW9uYXJ5IHRvICp1cGRhdGUqIG9zLmVudmlyb24gd2l0aAogICAgICAgIDprdyB1bWFzazogVW1hc2sgdG8gYmUgdXNlZCB3aGVuIHJ1bm5pbmcgdGhlIGNvbW1hbmQuIERlZmF1bHQgTm9uZQogICAgICAgIDprdyBlbmNvZGluZzogU2luY2Ugd2UgcmV0dXJuIG5hdGl2ZSBzdHJpbmdzLCBvbiBweXRob24zIHdlIG5lZWQgdG8KICAgICAgICAgICAga25vdyB0aGUgZW5jb2RpbmcgdG8gdXNlIHRvIHRyYW5zZm9ybSBmcm9tIGJ5dGVzIHRvIHRleHQuICBJZiB5b3UKICAgICAgICAgICAgd2FudCB0byBhbHdheXMgZ2V0IGJ5dGVzIGJhY2ssIHVzZSBlbmNvZGluZz1Ob25lLiAgVGhlIGRlZmF1bHQgaXMKICAgICAgICAgICAgInV0Zi04Ii4gIFRoaXMgZG9lcyBub3QgYWZmZWN0IHRyYW5zZm9ybWF0aW9uIG9mIHN0cmluZ3MgZ2l2ZW4gYXMKICAgICAgICAgICAgYXJncy4KICAgICAgICA6a3cgZXJyb3JzOiBTaW5jZSB3ZSByZXR1cm4gbmF0aXZlIHN0cmluZ3MsIG9uIHB5dGhvbjMgd2UgbmVlZCB0bwogICAgICAgICAgICB0cmFuc2Zvcm0gc3Rkb3V0IGFuZCBzdGRlcnIgZnJvbSBieXRlcyB0byB0ZXh0LiAgSWYgdGhlIGJ5dGVzIGFyZQogICAgICAgICAgICB1bmRlY29kYWJsZSBpbiB0aGUgYGBlbmNvZGluZ2BgIHNwZWNpZmllZCwgdGhlbiB1c2UgdGhpcyBlcnJvcgogICAgICAgICAgICBoYW5kbGVyIHRvIGRlYWwgd2l0aCB0aGVtLiAgVGhlIGRlZmF1bHQgaXMgYGBzdXJyb2dhdGVfb3Jfc3RyaWN0YGAKICAgICAgICAgICAgd2hpY2ggbWVhbnMgdGhhdCB0aGUgYnl0ZXMgd2lsbCBiZSBkZWNvZGVkIHVzaW5nIHRoZQogICAgICAgICAgICBzdXJyb2dhdGVlc2NhcGUgZXJyb3IgaGFuZGxlciBpZiBhdmFpbGFibGUgKGF2YWlsYWJsZSBvbiBhbGwKICAgICAgICAgICAgcHl0aG9uMyB2ZXJzaW9ucyB3ZSBzdXBwb3J0KSBvdGhlcndpc2UgYSBVbmljb2RlRXJyb3IgdHJhY2ViYWNrCiAgICAgICAgICAgIHdpbGwgYmUgcmFpc2VkLiAgVGhpcyBkb2VzIG5vdCBhZmZlY3QgdHJhbnNmb3JtYXRpb25zIG9mIHN0cmluZ3MKICAgICAgICAgICAgZ2l2ZW4gYXMgYXJncy4KICAgICAgICA6cmV0dXJuczogQSAzLXR1cGxlIG9mIHJldHVybiBjb2RlIChpbnRlZ2VyKSwgc3Rkb3V0IChuYXRpdmUgc3RyaW5nKSwKICAgICAgICAgICAgYW5kIHN0ZGVyciAobmF0aXZlIHN0cmluZykuICBPbiBweXRob24yLCBzdGRvdXQgYW5kIHN0ZGVyciBhcmUgYm90aAogICAgICAgICAgICBieXRlIHN0cmluZ3MuICBPbiBweXRob24zLCBzdGRvdXQgYW5kIHN0ZGVyciBhcmUgdGV4dCBzdHJpbmdzIGNvbnZlcnRlZAogICAgICAgICAgICBhY2NvcmRpbmcgdG8gdGhlIGVuY29kaW5nIGFuZCBlcnJvcnMgcGFyYW1ldGVycy4gIElmIHlvdSB3YW50IGJ5dGUKICAgICAgICAgICAgc3RyaW5ncyBvbiBweXRob24zLCB1c2UgZW5jb2Rpbmc9Tm9uZSB0byB0dXJuIGRlY29kaW5nIHRvIHRleHQgb2ZmLgogICAgICAgICcnJwoKICAgICAgICBpZiBpc2luc3RhbmNlKGFyZ3MsIGxpc3QpOgogICAgICAgICAgICBpZiB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICAgICAgYXJncyA9ICIgIi5qb2luKFtzaGxleF9xdW90ZSh4KSBmb3IgeCBpbiBhcmdzXSkKICAgICAgICAgICAgICAgIHNoZWxsID0gVHJ1ZQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShhcmdzLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpIGFuZCB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICBzaGVsbCA9IFRydWUKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoYXJncywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKToKICAgICAgICAgICAgaWYgbm90IHVzZV91bnNhZmVfc2hlbGw6CiAgICAgICAgICAgICAgICAjIE9uIHB5dGhvbjIuNiBhbmQgYmVsb3csIHNobGV4IGhhcyBwcm9ibGVtcyB3aXRoIHRleHQgdHlwZQogICAgICAgICAgICAgICAgIyBPbiBweXRob24zLCBzaGxleCBuZWVkcyBhIHRleHQgdHlwZS4KICAgICAgICAgICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgICAgICAgICBhcmdzID0gdG9fYnl0ZXMoYXJncywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICAgICAgICAgIGVsaWYgUFkzOgogICAgICAgICAgICAgICAgICAgIGFyZ3MgPSB0b190ZXh0KGFyZ3MsIGVycm9ycz0nc3Vycm9nYXRlZXNjYXBlJykKICAgICAgICAgICAgICAgIGFyZ3MgPSBzaGxleC5zcGxpdChhcmdzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1zZyA9ICJBcmd1bWVudCAnYXJncycgdG8gcnVuX2NvbW1hbmQgbXVzdCBiZSBsaXN0IG9yIHN0cmluZyIKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocmM9MjU3LCBjbWQ9YXJncywgbXNnPW1zZykKCiAgICAgICAgc2hlbGwgPSBGYWxzZQogICAgICAgIGlmIHVzZV91bnNhZmVfc2hlbGw6CiAgICAgICAgICAgIGlmIGV4ZWN1dGFibGUgaXMgTm9uZToKICAgICAgICAgICAgICAgIGV4ZWN1dGFibGUgPSBvcy5lbnZpcm9uLmdldCgnU0hFTEwnKQogICAgICAgICAgICBpZiBleGVjdXRhYmxlOgogICAgICAgICAgICAgICAgYXJncyA9IFtleGVjdXRhYmxlLCAnLWMnLCBhcmdzXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2hlbGwgPSBUcnVlCgogICAgICAgIHByb21wdF9yZSA9IE5vbmUKICAgICAgICBpZiBwcm9tcHRfcmVnZXg6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocHJvbXB0X3JlZ2V4LCB0ZXh0X3R5cGUpOgogICAgICAgICAgICAgICAgaWYgUFkzOgogICAgICAgICAgICAgICAgICAgIHByb21wdF9yZWdleCA9IHRvX2J5dGVzKHByb21wdF9yZWdleCwgZXJyb3JzPSdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICAgICAgICAgZWxpZiBQWTI6CiAgICAgICAgICAgICAgICAgICAgcHJvbXB0X3JlZ2V4ID0gdG9fYnl0ZXMocHJvbXB0X3JlZ2V4LCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwcm9tcHRfcmUgPSByZS5jb21waWxlKHByb21wdF9yZWdleCwgcmUuTVVMVElMSU5FKQogICAgICAgICAgICBleGNlcHQgcmUuZXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImludmFsaWQgcHJvbXB0IHJlZ3VsYXIgZXhwcmVzc2lvbiBnaXZlbiB0byBydW5fY29tbWFuZCIpCgogICAgICAgICMgZXhwYW5kIHRoaW5ncyBsaWtlICRIT01FIGFuZCB+CiAgICAgICAgaWYgbm90IHNoZWxsOgogICAgICAgICAgICBhcmdzID0gWyBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKHgpKSBmb3IgeCBpbiBhcmdzIGlmIHggaXMgbm90IE5vbmUgXQoKICAgICAgICByYyA9IDAKICAgICAgICBtc2cgPSBOb25lCiAgICAgICAgc3RfaW4gPSBOb25lCgogICAgICAgICMgTWFuaXB1bGF0ZSB0aGUgZW52aXJvbiB3ZSdsbCBzZW5kIHRvIHRoZSBuZXcgcHJvY2VzcwogICAgICAgIG9sZF9lbnZfdmFscyA9IHt9CiAgICAgICAgIyBXZSBjYW4gc2V0IHRoaXMgZnJvbSBib3RoIGFuIGF0dHJpYnV0ZSBhbmQgcGVyIGNhbGwKICAgICAgICBmb3Iga2V5LCB2YWwgaW4gc2VsZi5ydW5fY29tbWFuZF9lbnZpcm9uX3VwZGF0ZS5pdGVtcygpOgogICAgICAgICAgICBvbGRfZW52X3ZhbHNba2V5XSA9IG9zLmVudmlyb24uZ2V0KGtleSwgTm9uZSkKICAgICAgICAgICAgb3MuZW52aXJvbltrZXldID0gdmFsCiAgICAgICAgaWYgZW52aXJvbl91cGRhdGU6CiAgICAgICAgICAgIGZvciBrZXksIHZhbCBpbiBlbnZpcm9uX3VwZGF0ZS5pdGVtcygpOgogICAgICAgICAgICAgICAgb2xkX2Vudl92YWxzW2tleV0gPSBvcy5lbnZpcm9uLmdldChrZXksIE5vbmUpCiAgICAgICAgICAgICAgICBvcy5lbnZpcm9uW2tleV0gPSB2YWwKICAgICAgICBpZiBwYXRoX3ByZWZpeDoKICAgICAgICAgICAgb2xkX2Vudl92YWxzWydQQVRIJ10gPSBvcy5lbnZpcm9uWydQQVRIJ10KICAgICAgICAgICAgb3MuZW52aXJvblsnUEFUSCddID0gIiVzOiVzIiAlIChwYXRoX3ByZWZpeCwgb3MuZW52aXJvblsnUEFUSCddKQoKICAgICAgICAjIElmIHVzaW5nIHRlc3QtbW9kdWxlIGFuZCBleHBsb2RlLCB0aGUgcmVtb3RlIGxpYiBwYXRoIHdpbGwgcmVzZW1ibGUgLi4uCiAgICAgICAgIyAgIC90bXAvdGVzdF9tb2R1bGVfc2NyYXRjaC9kZWJ1Z19kaXIvYW5zaWJsZS9tb2R1bGVfdXRpbHMvYmFzaWMucHkKICAgICAgICAjIElmIHVzaW5nIGFuc2libGUgb3IgYW5zaWJsZS1wbGF5Ym9vayB3aXRoIGEgcmVtb3RlIHN5c3RlbSAuLi4KICAgICAgICAjICAgL3RtcC9hbnNpYmxlX3Ztd2VMUS9hbnNpYmxlX21vZGxpYi56aXAvYW5zaWJsZS9tb2R1bGVfdXRpbHMvYmFzaWMucHkKCiAgICAgICAgIyBDbGVhbiBvdXQgcHl0aG9uIHBhdGhzIHNldCBieSBhbnNpYmFsbHoKICAgICAgICBpZiAnUFlUSE9OUEFUSCcgaW4gb3MuZW52aXJvbjoKICAgICAgICAgICAgcHlwYXRocyA9IG9zLmVudmlyb25bJ1BZVEhPTlBBVEgnXS5zcGxpdCgnOicpCiAgICAgICAgICAgIHB5cGF0aHMgPSBbeCBmb3IgeCBpbiBweXBhdGhzIFwKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHguZW5kc3dpdGgoJy9hbnNpYmxlX21vZGxpYi56aXAnKSBcCiAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBub3QgeC5lbmRzd2l0aCgnL2RlYnVnX2RpcicpXQogICAgICAgICAgICBvcy5lbnZpcm9uWydQWVRIT05QQVRIJ10gPSAnOicuam9pbihweXBhdGhzKQogICAgICAgICAgICBpZiBub3Qgb3MuZW52aXJvblsnUFlUSE9OUEFUSCddOgogICAgICAgICAgICAgICAgZGVsIG9zLmVudmlyb25bJ1BZVEhPTlBBVEgnXQoKICAgICAgICAjIGNyZWF0ZSBhIHByaW50YWJsZSB2ZXJzaW9uIG9mIHRoZSBjb21tYW5kIGZvciB1c2UKICAgICAgICAjIGluIHJlcG9ydGluZyBsYXRlciwgd2hpY2ggc3RyaXBzIG91dCB0aGluZ3MgbGlrZQogICAgICAgICMgcGFzc3dvcmRzIGZyb20gdGhlIGFyZ3MgbGlzdAogICAgICAgIHRvX2NsZWFuX2FyZ3MgPSBhcmdzCiAgICAgICAgaWYgUFkyOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGFyZ3MsIHRleHRfdHlwZSk6CiAgICAgICAgICAgICAgICB0b19jbGVhbl9hcmdzID0gdG9fYnl0ZXMoYXJncykKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGFyZ3MsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgICAgIHRvX2NsZWFuX2FyZ3MgPSB0b190ZXh0KGFyZ3MpCiAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgICAgICB0b19jbGVhbl9hcmdzID0gc2hsZXguc3BsaXQodG9fY2xlYW5fYXJncykKCiAgICAgICAgY2xlYW5fYXJncyA9IFtdCiAgICAgICAgaXNfcGFzc3dkID0gRmFsc2UKICAgICAgICBmb3IgYXJnIGluIHRvX2NsZWFuX2FyZ3M6CiAgICAgICAgICAgIGlmIGlzX3Bhc3N3ZDoKICAgICAgICAgICAgICAgIGlzX3Bhc3N3ZCA9IEZhbHNlCiAgICAgICAgICAgICAgICBjbGVhbl9hcmdzLmFwcGVuZCgnKioqKioqKionKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgUEFTU1dEX0FSR19SRS5tYXRjaChhcmcpOgogICAgICAgICAgICAgICAgc2VwX2lkeCA9IGFyZy5maW5kKCc9JykKICAgICAgICAgICAgICAgIGlmIHNlcF9pZHggPiAtMToKICAgICAgICAgICAgICAgICAgICBjbGVhbl9hcmdzLmFwcGVuZCgnJXM9KioqKioqKionICUgYXJnWzpzZXBfaWR4XSkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBpc19wYXNzd2QgPSBUcnVlCiAgICAgICAgICAgIGFyZyA9IGhldXJpc3RpY19sb2dfc2FuaXRpemUoYXJnLCBzZWxmLm5vX2xvZ192YWx1ZXMpCiAgICAgICAgICAgIGNsZWFuX2FyZ3MuYXBwZW5kKGFyZykKICAgICAgICBjbGVhbl9hcmdzID0gJyAnLmpvaW4oc2hsZXhfcXVvdGUoYXJnKSBmb3IgYXJnIGluIGNsZWFuX2FyZ3MpCgogICAgICAgIGlmIGRhdGE6CiAgICAgICAgICAgIHN0X2luID0gc3VicHJvY2Vzcy5QSVBFCgogICAgICAgIGt3YXJncyA9IGRpY3QoCiAgICAgICAgICAgIGV4ZWN1dGFibGU9ZXhlY3V0YWJsZSwKICAgICAgICAgICAgc2hlbGw9c2hlbGwsCiAgICAgICAgICAgIGNsb3NlX2Zkcz1jbG9zZV9mZHMsCiAgICAgICAgICAgIHN0ZGluPXN0X2luLAogICAgICAgICAgICBzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICkKCiAgICAgICAgIyBzdG9yZSB0aGUgcHdkCiAgICAgICAgcHJldl9kaXIgPSBvcy5nZXRjd2QoKQoKICAgICAgICAjIG1ha2Ugc3VyZSB3ZSdyZSBpbiB0aGUgcmlnaHQgd29ya2luZyBkaXJlY3RvcnkKICAgICAgICBpZiBjd2QgYW5kIG9zLnBhdGguaXNkaXIoY3dkKToKICAgICAgICAgICAgY3dkID0gb3MucGF0aC5hYnNwYXRoKG9zLnBhdGguZXhwYW5kdXNlcihjd2QpKQogICAgICAgICAgICBrd2FyZ3NbJ2N3ZCddID0gY3dkCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLmNoZGlyKGN3ZCkKICAgICAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPWUuZXJybm8sIG1zZz0iQ291bGQgbm90IG9wZW4gJXMsICVzIiAlIChjd2QsIHN0cihlKSkpCgogICAgICAgIG9sZF91bWFzayA9IE5vbmUKICAgICAgICBpZiB1bWFzazoKICAgICAgICAgICAgb2xkX3VtYXNrID0gb3MudW1hc2sodW1hc2spCgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5fZGVidWc6CiAgICAgICAgICAgICAgICBzZWxmLmxvZygnRXhlY3V0aW5nOiAnICsgY2xlYW5fYXJncykKICAgICAgICAgICAgY21kID0gc3VicHJvY2Vzcy5Qb3BlbihhcmdzLCAqKmt3YXJncykKCiAgICAgICAgICAgICMgdGhlIGNvbW11bmljYXRpb24gbG9naWMgaGVyZSBpcyBlc3NlbnRpYWxseSB0YWtlbiBmcm9tIHRoYXQKICAgICAgICAgICAgIyBvZiB0aGUgX2NvbW11bmljYXRlKCkgZnVuY3Rpb24gaW4gc3NoLnB5CgogICAgICAgICAgICBzdGRvdXQgPSBiKCcnKQogICAgICAgICAgICBzdGRlcnIgPSBiKCcnKQogICAgICAgICAgICBycGlwZXMgPSBbY21kLnN0ZG91dCwgY21kLnN0ZGVycl0KCiAgICAgICAgICAgIGlmIGRhdGE6CiAgICAgICAgICAgICAgICBpZiBub3QgYmluYXJ5X2RhdGE6CiAgICAgICAgICAgICAgICAgICAgZGF0YSArPSAnXG4nCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGRhdGEsIHRleHRfdHlwZSk6CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHRvX2J5dGVzKGRhdGEpCiAgICAgICAgICAgICAgICBjbWQuc3RkaW4ud3JpdGUoZGF0YSkKICAgICAgICAgICAgICAgIGNtZC5zdGRpbi5jbG9zZSgpCgogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgcmZkcywgd2ZkcywgZWZkcyA9IHNlbGVjdC5zZWxlY3QocnBpcGVzLCBbXSwgcnBpcGVzLCAxKQogICAgICAgICAgICAgICAgc3Rkb3V0ICs9IHNlbGYuX3JlYWRfZnJvbV9waXBlcyhycGlwZXMsIHJmZHMsIGNtZC5zdGRvdXQpCiAgICAgICAgICAgICAgICBzdGRlcnIgKz0gc2VsZi5fcmVhZF9mcm9tX3BpcGVzKHJwaXBlcywgcmZkcywgY21kLnN0ZGVycikKICAgICAgICAgICAgICAgICMgaWYgd2UncmUgY2hlY2tpbmcgZm9yIHByb21wdHMsIGRvIGl0IG5vdwogICAgICAgICAgICAgICAgaWYgcHJvbXB0X3JlOgogICAgICAgICAgICAgICAgICAgIGlmIHByb21wdF9yZS5zZWFyY2goc3Rkb3V0KSBhbmQgbm90IGRhdGE6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGVuY29kaW5nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Rkb3V0ID0gdG9fbmF0aXZlKHN0ZG91dCwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQgPSBzdGRvdXQKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgyNTcsIHN0ZG91dCwgIkEgcHJvbXB0IHdhcyBlbmNvdW50ZXJlZCB3aGlsZSBydW5uaW5nIGEgY29tbWFuZCwgYnV0IG5vIGlucHV0IGRhdGEgd2FzIHNwZWNpZmllZCIpCiAgICAgICAgICAgICAgICAjIG9ubHkgYnJlYWsgb3V0IGlmIG5vIHBpcGVzIGFyZSBsZWZ0IHRvIHJlYWQgb3IKICAgICAgICAgICAgICAgICMgdGhlIHBpcGVzIGFyZSBjb21wbGV0ZWx5IHJlYWQgYW5kCiAgICAgICAgICAgICAgICAjIHRoZSBwcm9jZXNzIGlzIHRlcm1pbmF0ZWQKICAgICAgICAgICAgICAgIGlmIChub3QgcnBpcGVzIG9yIG5vdCByZmRzKSBhbmQgY21kLnBvbGwoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgIyBObyBwaXBlcyBhcmUgbGVmdCB0byByZWFkIGJ1dCBwcm9jZXNzIGlzIG5vdCB5ZXQgdGVybWluYXRlZAogICAgICAgICAgICAgICAgIyBPbmx5IHRoZW4gaXQgaXMgc2FmZSB0byB3YWl0IGZvciB0aGUgcHJvY2VzcyB0byBiZSBmaW5pc2hlZAogICAgICAgICAgICAgICAgIyBOT1RFOiBBY3R1YWxseSBjbWQucG9sbCgpIGlzIGFsd2F5cyBOb25lIGhlcmUgaWYgcnBpcGVzIGlzIGVtcHR5CiAgICAgICAgICAgICAgICBlbGlmIG5vdCBycGlwZXMgYW5kIGNtZC5wb2xsKCkgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBjbWQud2FpdCgpCiAgICAgICAgICAgICAgICAgICAgIyBUaGUgcHJvY2VzcyBpcyB0ZXJtaW5hdGVkLiBTaW5jZSBubyBwaXBlcyB0byByZWFkIGZyb20gYXJlCiAgICAgICAgICAgICAgICAgICAgIyBsZWZ0LCB0aGVyZSBpcyBubyBuZWVkIHRvIGNhbGwgc2VsZWN0KCkgYWdhaW4uCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIGNtZC5zdGRvdXQuY2xvc2UoKQogICAgICAgICAgICBjbWQuc3RkZXJyLmNsb3NlKCkKCiAgICAgICAgICAgIHJjID0gY21kLnJldHVybmNvZGUKICAgICAgICBleGNlcHQgKE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYubG9nKCJFcnJvciBFeGVjdXRpbmcgQ01EOiVzIEV4Y2VwdGlvbjolcyIgJSAoY2xlYW5fYXJncywgdG9fbmF0aXZlKGUpKSkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocmM9ZS5lcnJubywgbXNnPXRvX25hdGl2ZShlKSwgY21kPWNsZWFuX2FyZ3MpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLmxvZygiRXJyb3IgRXhlY3V0aW5nIENNRDolcyBFeGNlcHRpb246JXMiICUgKGNsZWFuX2FyZ3MsdG9fbmF0aXZlKHRyYWNlYmFjay5mb3JtYXRfZXhjKCkpKSkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocmM9MjU3LCBtc2c9dG9fbmF0aXZlKGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSwgY21kPWNsZWFuX2FyZ3MpCgogICAgICAgICMgUmVzdG9yZSBlbnYgc2V0dGluZ3MKICAgICAgICBmb3Iga2V5LCB2YWwgaW4gb2xkX2Vudl92YWxzLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIHZhbCBpcyBOb25lOgogICAgICAgICAgICAgICAgZGVsIG9zLmVudmlyb25ba2V5XQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb3MuZW52aXJvbltrZXldID0gdmFsCgogICAgICAgIGlmIG9sZF91bWFzazoKICAgICAgICAgICAgb3MudW1hc2sob2xkX3VtYXNrKQoKICAgICAgICBpZiByYyAhPSAwIGFuZCBjaGVja19yYzoKICAgICAgICAgICAgbXNnID0gaGV1cmlzdGljX2xvZ19zYW5pdGl6ZShzdGRlcnIucnN0cmlwKCksIHNlbGYubm9fbG9nX3ZhbHVlcykKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24oY21kPWNsZWFuX2FyZ3MsIHJjPXJjLCBzdGRvdXQ9c3Rkb3V0LCBzdGRlcnI9c3RkZXJyLCBtc2c9bXNnKQoKICAgICAgICAjIHJlc2V0IHRoZSBwd2QKICAgICAgICBvcy5jaGRpcihwcmV2X2RpcikKCiAgICAgICAgaWYgZW5jb2RpbmcgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldHVybiAocmMsIHRvX25hdGl2ZShzdGRvdXQsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKSwKICAgICAgICAgICAgICAgICAgICB0b19uYXRpdmUoc3RkZXJyLCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycykpCiAgICAgICAgcmV0dXJuIChyYywgc3Rkb3V0LCBzdGRlcnIpCgogICAgZGVmIGFwcGVuZF90b19maWxlKHNlbGYsIGZpbGVuYW1lLCBzdHIpOgogICAgICAgIGZpbGVuYW1lID0gb3MucGF0aC5leHBhbmR2YXJzKG9zLnBhdGguZXhwYW5kdXNlcihmaWxlbmFtZSkpCiAgICAgICAgZmggPSBvcGVuKGZpbGVuYW1lLCAnYScpCiAgICAgICAgZmgud3JpdGUoc3RyKQogICAgICAgIGZoLmNsb3NlKCkKCiAgICBkZWYgYnl0ZXNfdG9faHVtYW4oc2VsZiwgc2l6ZSk6CiAgICAgICAgcmV0dXJuIGJ5dGVzX3RvX2h1bWFuKHNpemUpCgogICAgIyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkKICAgIHByZXR0eV9ieXRlcyA9IGJ5dGVzX3RvX2h1bWFuCgogICAgZGVmIGh1bWFuX3RvX2J5dGVzKHNlbGYsIG51bWJlciwgaXNiaXRzPUZhbHNlKToKICAgICAgICByZXR1cm4gaHVtYW5fdG9fYnl0ZXMobnVtYmVyLCBpc2JpdHMpCgogICAgIwogICAgIyBCYWNrd2FyZHMgY29tcGF0CiAgICAjCgogICAgIyBJbiAyLjAsIG1vdmVkIGZyb20gaW5zaWRlIHRoZSBtb2R1bGUgdG8gdGhlIHRvcGxldmVsCiAgICBpc19leGVjdXRhYmxlID0gaXNfZXhlY3V0YWJsZQoKCmRlZiBnZXRfbW9kdWxlX3BhdGgoKToKICAgIHJldHVybiBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5yZWFscGF0aChfX2ZpbGVfXykpClBLAwQUAAAAAADMuytLBPWOi+gNAADoDQAAGwAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2FwaS5weSMKIyAoYykgMjAxNSBCcmlhbiBDY29hLCA8YmNvY2FAYW5zaWJsZS5jb20+CiMKIyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCiMKIiIiClRoaXMgbW9kdWxlIGFkZHMgc2hhcmVkIHN1cHBvcnQgZm9yIGdlbmVyaWMgYXBpIG1vZHVsZXMKCkluIG9yZGVyIHRvIHVzZSB0aGlzIG1vZHVsZSwgaW5jbHVkZSBpdCBhcyBwYXJ0IG9mIGEgY3VzdG9tCm1vZHVsZSBhcyBzaG93biBiZWxvdy4KCioqIE5vdGU6IFRoZSBvcmRlciBvZiB0aGUgaW1wb3J0IHN0YXRlbWVudHMgZG9lcyBtYXR0ZXIuICoqCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmJhc2ljIGltcG9ydCAqCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuYXBpIGltcG9ydCAqCgpUaGUgJ2FwaScgbW9kdWxlIHByb3ZpZGVzIHRoZSBmb2xsb3dpbmcgY29tbW9uIGFyZ3VtZW50IHNwZWNzOgoKICAgICogcmF0ZSBsaW1pdCBzcGVjCiAgICAgICAgLSByYXRlOiBudW1iZXIgb2YgcmVxdWVzdHMgcGVyIHRpbWUgdW5pdCAoaW50KQogICAgICAgIC0gcmF0ZV9saW1pdDogdGltZSB3aW5kb3cgaW4gd2hpY2ggdGhlIGxpbWl0IGlzIGFwcGxpZWQgaW4gc2Vjb25kcwoKICAgICogcmV0cnkgc3BlYwogICAgICAgIC0gcmV0cmllczogbnVtYmVyIG9mIGF0dGVtcHRzCiAgICAgICAgLSByZXRyeV9wYXVzZTogZGVsYXkgYmV0d2VlbiBhdHRlbXB0cyBpbiBzZWNvbmRzCgoiIiIKaW1wb3J0IHRpbWUKCmRlZiByYXRlX2xpbWl0X2FyZ3VtZW50X3NwZWMoc3BlYz1Ob25lKToKICAgICIiIkNyZWF0ZXMgYW4gYXJndW1lbnQgc3BlYyBmb3Igd29ya2luZyB3aXRoIHJhdGUgbGltaXRpbmciIiIKICAgIGFyZ19zcGVjID0gKGRpY3QoCiAgICAgICAgcmF0ZT1kaWN0KHR5cGU9J2ludCcpLAogICAgICAgIHJhdGVfbGltaXQ9ZGljdCh0eXBlPSdpbnQnKSwKICAgICkpCiAgICBpZiBzcGVjOgogICAgICAgIGFyZ19zcGVjLnVwZGF0ZShzcGVjKQogICAgcmV0dXJuIGFyZ19zcGVjCgpkZWYgcmV0cnlfYXJndW1lbnRfc3BlYyhzcGVjPU5vbmUpOgogICAgIiIiQ3JlYXRlcyBhbiBhcmd1bWVudCBzcGVjIGZvciB3b3JraW5nIHdpdGggcmV0cnlpbmciIiIKICAgIGFyZ19zcGVjID0gKGRpY3QoCiAgICAgICAgcmV0cmllcz1kaWN0KHR5cGU9J2ludCcpLAogICAgICAgIHJldHJ5X3BhdXNlPWRpY3QodHlwZT0nZmxvYXQnLCBkZWZhdWx0PTEpLAogICAgKSkKICAgIGlmIHNwZWM6CiAgICAgICAgYXJnX3NwZWMudXBkYXRlKHNwZWMpCiAgICByZXR1cm4gYXJnX3NwZWMKCmRlZiBiYXNpY19hdXRoX2FyZ3VtZW50X3NwZWMoc3BlYz1Ob25lKToKICAgIGFyZ19zcGVjID0gKGRpY3QoCiAgICAgICAgYXBpX3VzZXJuYW1lPWRpY3QodHlwZT0nc3RyJywgcmVxdWlyZWQ9RmFsc2UpLAogICAgICAgIGFwaV9wYXNzd29yZD1kaWN0KHR5cGU9J3N0cicsIHJlcXVpcmVkPUZhbHNlLCBub19sb2c9VHJ1ZSksCiAgICAgICAgYXBpX3VybD1kaWN0KHR5cGU9J3N0cicsIHJlcXVpcmVkPUZhbHNlKSwKICAgICAgICB2YWxpZGF0ZV9jZXJ0cz1kaWN0KHR5cGU9J2Jvb2wnLCBkZWZhdWx0PVRydWUpCiAgICApKQogICAgaWYgc3BlYzoKICAgICAgICBhcmdfc3BlYy51cGRhdGUoc3BlYykKICAgIHJldHVybiBhcmdfc3BlYwoKZGVmIHJhdGVfbGltaXQocmF0ZT1Ob25lLCByYXRlX2xpbWl0PU5vbmUpOgogICAgIiIicmF0ZSBsaW1pdGluZyBkZWNvcmF0b3IiIiIKICAgIG1pbnJhdGUgPSBOb25lCiAgICBpZiByYXRlIGlzIG5vdCBOb25lIGFuZCByYXRlX2xpbWl0IGlzIG5vdCBOb25lOgogICAgICAgIG1pbnJhdGUgPSBmbG9hdChyYXRlX2xpbWl0KSAvIGZsb2F0KHJhdGUpCiAgICBkZWYgd3JhcHBlcihmKToKICAgICAgICBsYXN0ID0gWzAuMF0KICAgICAgICBkZWYgcmF0ZWxpbWl0ZWQoKmFyZ3MsKiprd2FyZ3MpOgogICAgICAgICAgICBpZiBtaW5yYXRlIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgZWxhcHNlZCA9IHRpbWUuY2xvY2soKSAtIGxhc3RbMF0KICAgICAgICAgICAgICAgIGxlZnQgPSBtaW5yYXRlIC0gZWxhcHNlZAogICAgICAgICAgICAgICAgaWYgbGVmdCA+IDA6CiAgICAgICAgICAgICAgICAgICAgdGltZS5zbGVlcChsZWZ0KQogICAgICAgICAgICAgICAgbGFzdFswXSA9IHRpbWUuY2xvY2soKQogICAgICAgICAgICByZXQgPSBmKCphcmdzLCoqa3dhcmdzKQogICAgICAgICAgICByZXR1cm4gcmV0CiAgICAgICAgcmV0dXJuIHJhdGVsaW1pdGVkCiAgICByZXR1cm4gd3JhcHBlcgoKZGVmIHJldHJ5KHJldHJpZXM9Tm9uZSwgcmV0cnlfcGF1c2U9MSk6CiAgICAiIiJSZXRyeSBkZWNvcmF0b3IiIiIKICAgIGRlZiB3cmFwcGVyKGYpOgogICAgICAgIHJldHJ5X2NvdW50ID0gMAogICAgICAgIGRlZiByZXRyaWVkKCphcmdzLCoqa3dhcmdzKToKICAgICAgICAgICAgaWYgcmV0cmllcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHJldCA9IE5vbmUKICAgICAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICAgICAgcmV0cnlfY291bnQgKz0gMQogICAgICAgICAgICAgICAgICAgIGlmIHJldHJ5X2NvdW50ID49IHJldHJpZXM6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiUmV0cnkgbGltaXQgZXhjZWVkZWQ6ICVkIiAlIHJldHJpZXMpCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBmKCphcmdzLCoqa3dhcmdzKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgIGlmIHJldDoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKHJldHJ5X3BhdXNlKQogICAgICAgICAgICAgICAgcmV0dXJuIHJldAogICAgICAgIHJldHVybiByZXRyaWVkCiAgICByZXR1cm4gd3JhcHBlcgoKUEsDBBQAAAAAAMy7K0sl3LR+ExAAABMQAAAiAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvcHljb21wYXQyNC5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpIDIwMTYsIFRvc2hpbyBLdXJhdG9taSA8dGt1cmF0b21pQGFuc2libGUuY29tPgojIENvcHlyaWdodCAoYykgMjAxNSwgTWFyaXVzIEdlZG1pbmFzCiMKIyBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQgbW9kaWZpY2F0aW9uLAojIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKIwojICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKIyAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwKIyAgICAgIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24KIyAgICAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORAojIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVECiMgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRSBESVNDTEFJTUVELgojIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULAojIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywKIyBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MKIyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUCiMgTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFCiMgVVNFIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiMKCmltcG9ydCBzeXMKCmRlZiBnZXRfZXhjZXB0aW9uKCk6CiAgICAiIiJHZXQgdGhlIGN1cnJlbnQgZXhjZXB0aW9uLgoKICAgIFRoaXMgY29kZSBuZWVkcyB0byB3b3JrIG9uIFB5dGhvbiAyLjQgdGhyb3VnaCAzLngsIHNvIHdlIGNhbm5vdCB1c2UKICAgICJleGNlcHQgRXhjZXB0aW9uLCBlOiIgKFN5bnRheEVycm9yIG9uIFB5dGhvbiAzLngpIG5vcgogICAgImV4Y2VwdCBFeGNlcHRpb24gYXMgZToiIChTeW50YXhFcnJvciBvbiBQeXRob24gMi40LTIuNSkuCiAgICBJbnN0ZWFkIHdlIG11c3QgdXNlIDo6CgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKCiAgICAiIiIKICAgIHJldHVybiBzeXMuZXhjX2luZm8oKVsxXQoKdHJ5OgogICAgIyBQeXRob24gMi42KwogICAgZnJvbSBhc3QgaW1wb3J0IGxpdGVyYWxfZXZhbApleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAjIGEgcmVwbGFjZW1lbnQgZm9yIGxpdGVyYWxfZXZhbCB0aGF0IHdvcmtzIHdpdGggcHl0aG9uIDIuNC4gZnJvbToKICAgICMgaHR0cHM6Ly9tYWlsLnB5dGhvbi5vcmcvcGlwZXJtYWlsL3B5dGhvbi1saXN0LzIwMDktU2VwdGVtYmVyLzU1MTg4MC5odG1sCiAgICAjIHdoaWNoIGlzIGVzc2VudGlhbGx5IGEgY3V0L3Bhc3RlIGZyb20gYW4gZWFybGllciAoMi42KSB2ZXJzaW9uIG9mIHB5dGhvbidzCiAgICAjIGFzdC5weQogICAgZnJvbSBjb21waWxlciBpbXBvcnQgYXN0LCBwYXJzZQogICAgZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IGJpbmFyeV90eXBlLCBzdHJpbmdfdHlwZXMsIHRleHRfdHlwZQoKICAgIGRlZiBsaXRlcmFsX2V2YWwobm9kZV9vcl9zdHJpbmcpOgogICAgICAgICIiIgogICAgICAgIFNhZmVseSBldmFsdWF0ZSBhbiBleHByZXNzaW9uIG5vZGUgb3IgYSBzdHJpbmcgY29udGFpbmluZyBhIFB5dGhvbgogICAgICAgIGV4cHJlc3Npb24uICBUaGUgc3RyaW5nIG9yIG5vZGUgcHJvdmlkZWQgbWF5IG9ubHkgY29uc2lzdCBvZiB0aGUgIGZvbGxvd2luZwogICAgICAgIFB5dGhvbiBsaXRlcmFsIHN0cnVjdHVyZXM6IHN0cmluZ3MsIG51bWJlcnMsIHR1cGxlcywgbGlzdHMsIGRpY3RzLCAgYm9vbGVhbnMsCiAgICAgICAgYW5kIE5vbmUuCiAgICAgICAgIiIiCiAgICAgICAgX3NhZmVfbmFtZXMgPSB7J05vbmUnOiBOb25lLCAnVHJ1ZSc6IFRydWUsICdGYWxzZSc6IEZhbHNlfQogICAgICAgIGlmIGlzaW5zdGFuY2Uobm9kZV9vcl9zdHJpbmcsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIG5vZGVfb3Jfc3RyaW5nID0gcGFyc2Uobm9kZV9vcl9zdHJpbmcsIG1vZGU9J2V2YWwnKQogICAgICAgIGlmIGlzaW5zdGFuY2Uobm9kZV9vcl9zdHJpbmcsIGFzdC5FeHByZXNzaW9uKToKICAgICAgICAgICAgbm9kZV9vcl9zdHJpbmcgPSBub2RlX29yX3N0cmluZy5ub2RlCgogICAgICAgIGRlZiBfY29udmVydChub2RlKToKICAgICAgICAgICAgIyBPa2F5IHRvIHVzZSBsb25nIGhlcmUgYmVjYXVzZSB0aGlzIGlzIG9ubHkgZm9yIHB5dGhvbiAyLjQgYW5kIDIuNQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5Db25zdCkgYW5kIGlzaW5zdGFuY2Uobm9kZS52YWx1ZSwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUsIGludCwgZmxvYXQsIGxvbmcsIGNvbXBsZXgpKToKICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnZhbHVlCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuVHVwbGUpOgogICAgICAgICAgICAgICAgcmV0dXJuIHR1cGxlKG1hcChfY29udmVydCwgbm9kZS5ub2RlcykpCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuTGlzdCk6CiAgICAgICAgICAgICAgICByZXR1cm4gbGlzdChtYXAoX2NvbnZlcnQsIG5vZGUubm9kZXMpKQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0LkRpY3QpOgogICAgICAgICAgICAgICAgcmV0dXJuIGRpY3QoKF9jb252ZXJ0KGspLCBfY29udmVydCh2KSkgZm9yIGssIHYgaW4gbm9kZS5pdGVtcygpKQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0Lk5hbWUpOgogICAgICAgICAgICAgICAgaWYgbm9kZS5uYW1lIGluIF9zYWZlX25hbWVzOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBfc2FmZV9uYW1lc1tub2RlLm5hbWVdCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuVW5hcnlTdWIpOgogICAgICAgICAgICAgICAgcmV0dXJuIC1fY29udmVydChub2RlLmV4cHIpCiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ21hbGZvcm1lZCBzdHJpbmcnKQogICAgICAgIHJldHVybiBfY29udmVydChub2RlX29yX3N0cmluZykKCl9fYWxsX18gPSAoJ2dldF9leGNlcHRpb24nLCAnbGl0ZXJhbF9ldmFsJykKUEsDBBQAAAAAAMy7K0tdhrVvO60AADutAAAcAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvdXJscy5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpLCBNaWNoYWVsIERlSGFhbiA8bWljaGFlbC5kZWhhYW5AZ21haWwuY29tPiwgMjAxMi0yMDEzCiMgQ29weXJpZ2h0IChjKSwgVG9zaGlvIEt1cmF0b21pIDx0a3VyYXRvbWlAYW5zaWJsZS5jb20+LCAyMDE1CiMgQWxsIHJpZ2h0cyByZXNlcnZlZC4KIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dCBtb2RpZmljYXRpb24sCiMgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAojICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5ECiMgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRUQKIyBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuCiMgSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsCiMgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLAojIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUwojIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QKIyBMSUFCSUxJVFksIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUKIyBVU0UgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwojIFRoZSBtYXRjaF9ob3N0bmFtZSBmdW5jdGlvbiBhbmQgc3VwcG9ydGluZyBjb2RlIGlzIHVuZGVyIHRoZSB0ZXJtcyBhbmQKIyBjb25kaXRpb25zIG9mIHRoZSBQeXRob24gU29mdHdhcmUgRm91bmRhdGlvbiBMaWNlbnNlLiAgVGhleSB3ZXJlIHRha2VuIGZyb20KIyB0aGUgUHl0aG9uMyBzdGFuZGFyZCBsaWJyYXJ5IGFuZCBhZGFwdGVkIGZvciB1c2UgaW4gUHl0aG9uMi4gIFNlZSBjb21tZW50cyBpbiB0aGUKIyBzb3VyY2UgZm9yIHdoaWNoIGNvZGUgcHJlY2lzZWx5IGlzIHVuZGVyIHRoaXMgTGljZW5zZS4gIFBTRiBMaWNlbnNlIHRleHQKIyBmb2xsb3dzOgojCiMgUFlUSE9OIFNPRlRXQVJFIEZPVU5EQVRJT04gTElDRU5TRSBWRVJTSU9OIDIKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojCiMgMS4gVGhpcyBMSUNFTlNFIEFHUkVFTUVOVCBpcyBiZXR3ZWVuIHRoZSBQeXRob24gU29mdHdhcmUgRm91bmRhdGlvbgojICgiUFNGIiksIGFuZCB0aGUgSW5kaXZpZHVhbCBvciBPcmdhbml6YXRpb24gKCJMaWNlbnNlZSIpIGFjY2Vzc2luZyBhbmQKIyBvdGhlcndpc2UgdXNpbmcgdGhpcyBzb2Z0d2FyZSAoIlB5dGhvbiIpIGluIHNvdXJjZSBvciBiaW5hcnkgZm9ybSBhbmQKIyBpdHMgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uLgojCiMgMi4gU3ViamVjdCB0byB0aGUgdGVybXMgYW5kIGNvbmRpdGlvbnMgb2YgdGhpcyBMaWNlbnNlIEFncmVlbWVudCwgUFNGIGhlcmVieQojIGdyYW50cyBMaWNlbnNlZSBhIG5vbmV4Y2x1c2l2ZSwgcm95YWx0eS1mcmVlLCB3b3JsZC13aWRlIGxpY2Vuc2UgdG8gcmVwcm9kdWNlLAojIGFuYWx5emUsIHRlc3QsIHBlcmZvcm0gYW5kL29yIGRpc3BsYXkgcHVibGljbHksIHByZXBhcmUgZGVyaXZhdGl2ZSB3b3JrcywKIyBkaXN0cmlidXRlLCBhbmQgb3RoZXJ3aXNlIHVzZSBQeXRob24gYWxvbmUgb3IgaW4gYW55IGRlcml2YXRpdmUgdmVyc2lvbiwKIyBwcm92aWRlZCwgaG93ZXZlciwgdGhhdCBQU0YncyBMaWNlbnNlIEFncmVlbWVudCBhbmQgUFNGJ3Mgbm90aWNlIG9mIGNvcHlyaWdodCwKIyBpLmUuLCAiQ29weXJpZ2h0IChjKSAyMDAxLCAyMDAyLCAyMDAzLCAyMDA0LCAyMDA1LCAyMDA2LCAyMDA3LCAyMDA4LCAyMDA5LCAyMDEwLAojIDIwMTEsIDIwMTIsIDIwMTMsIDIwMTQgUHl0aG9uIFNvZnR3YXJlIEZvdW5kYXRpb247IEFsbCBSaWdodHMgUmVzZXJ2ZWQiIGFyZQojIHJldGFpbmVkIGluIFB5dGhvbiBhbG9uZSBvciBpbiBhbnkgZGVyaXZhdGl2ZSB2ZXJzaW9uIHByZXBhcmVkIGJ5IExpY2Vuc2VlLgojCiMgMy4gSW4gdGhlIGV2ZW50IExpY2Vuc2VlIHByZXBhcmVzIGEgZGVyaXZhdGl2ZSB3b3JrIHRoYXQgaXMgYmFzZWQgb24KIyBvciBpbmNvcnBvcmF0ZXMgUHl0aG9uIG9yIGFueSBwYXJ0IHRoZXJlb2YsIGFuZCB3YW50cyB0byBtYWtlCiMgdGhlIGRlcml2YXRpdmUgd29yayBhdmFpbGFibGUgdG8gb3RoZXJzIGFzIHByb3ZpZGVkIGhlcmVpbiwgdGhlbgojIExpY2Vuc2VlIGhlcmVieSBhZ3JlZXMgdG8gaW5jbHVkZSBpbiBhbnkgc3VjaCB3b3JrIGEgYnJpZWYgc3VtbWFyeSBvZgojIHRoZSBjaGFuZ2VzIG1hZGUgdG8gUHl0aG9uLgojCiMgNC4gUFNGIGlzIG1ha2luZyBQeXRob24gYXZhaWxhYmxlIHRvIExpY2Vuc2VlIG9uIGFuICJBUyBJUyIKIyBiYXNpcy4gIFBTRiBNQUtFUyBOTyBSRVBSRVNFTlRBVElPTlMgT1IgV0FSUkFOVElFUywgRVhQUkVTUyBPUgojIElNUExJRUQuICBCWSBXQVkgT0YgRVhBTVBMRSwgQlVUIE5PVCBMSU1JVEFUSU9OLCBQU0YgTUFLRVMgTk8gQU5ECiMgRElTQ0xBSU1TIEFOWSBSRVBSRVNFTlRBVElPTiBPUiBXQVJSQU5UWSBPRiBNRVJDSEFOVEFCSUxJVFkgT1IgRklUTkVTUwojIEZPUiBBTlkgUEFSVElDVUxBUiBQVVJQT1NFIE9SIFRIQVQgVEhFIFVTRSBPRiBQWVRIT04gV0lMTCBOT1QKIyBJTkZSSU5HRSBBTlkgVEhJUkQgUEFSVFkgUklHSFRTLgojCiMgNS4gUFNGIFNIQUxMIE5PVCBCRSBMSUFCTEUgVE8gTElDRU5TRUUgT1IgQU5ZIE9USEVSIFVTRVJTIE9GIFBZVEhPTgojIEZPUiBBTlkgSU5DSURFTlRBTCwgU1BFQ0lBTCwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIE9SIExPU1MgQVMKIyBBIFJFU1VMVCBPRiBNT0RJRllJTkcsIERJU1RSSUJVVElORywgT1IgT1RIRVJXSVNFIFVTSU5HIFBZVEhPTiwKIyBPUiBBTlkgREVSSVZBVElWRSBUSEVSRU9GLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIFRIRVJFT0YuCiMKIyA2LiBUaGlzIExpY2Vuc2UgQWdyZWVtZW50IHdpbGwgYXV0b21hdGljYWxseSB0ZXJtaW5hdGUgdXBvbiBhIG1hdGVyaWFsCiMgYnJlYWNoIG9mIGl0cyB0ZXJtcyBhbmQgY29uZGl0aW9ucy4KIwojIDcuIE5vdGhpbmcgaW4gdGhpcyBMaWNlbnNlIEFncmVlbWVudCBzaGFsbCBiZSBkZWVtZWQgdG8gY3JlYXRlIGFueQojIHJlbGF0aW9uc2hpcCBvZiBhZ2VuY3ksIHBhcnRuZXJzaGlwLCBvciBqb2ludCB2ZW50dXJlIGJldHdlZW4gUFNGIGFuZAojIExpY2Vuc2VlLiAgVGhpcyBMaWNlbnNlIEFncmVlbWVudCBkb2VzIG5vdCBncmFudCBwZXJtaXNzaW9uIHRvIHVzZSBQU0YKIyB0cmFkZW1hcmtzIG9yIHRyYWRlIG5hbWUgaW4gYSB0cmFkZW1hcmsgc2Vuc2UgdG8gZW5kb3JzZSBvciBwcm9tb3RlCiMgcHJvZHVjdHMgb3Igc2VydmljZXMgb2YgTGljZW5zZWUsIG9yIGFueSB0aGlyZCBwYXJ0eS4KIwojIDguIEJ5IGNvcHlpbmcsIGluc3RhbGxpbmcgb3Igb3RoZXJ3aXNlIHVzaW5nIFB5dGhvbiwgTGljZW5zZWUKIyBhZ3JlZXMgdG8gYmUgYm91bmQgYnkgdGhlIHRlcm1zIGFuZCBjb25kaXRpb25zIG9mIHRoaXMgTGljZW5zZQojIEFncmVlbWVudC4KCicnJwpUaGUgKip1cmxzKiogdXRpbHMgbW9kdWxlIG9mZmVycyBhIHJlcGxhY2VtZW50IGZvciB0aGUgdXJsbGliMiBweXRob24gbGlicmFyeS4KCnVybGxpYjIgaXMgdGhlIHB5dGhvbiBzdGRsaWIgd2F5IHRvIHJldHJpZXZlIGZpbGVzIGZyb20gdGhlIEludGVybmV0IGJ1dCBpdApsYWNrcyBzb21lIHNlY3VyaXR5IGZlYXR1cmVzIChhcm91bmQgdmVyaWZ5aW5nIFNTTCBjZXJ0aWZpY2F0ZXMpIHRoYXQgdXNlcnMKc2hvdWxkIGNhcmUgYWJvdXQgaW4gbW9zdCBzaXR1YXRpb25zLiBVc2luZyB0aGUgZnVuY3Rpb25zIGluIHRoaXMgbW9kdWxlIGNvcnJlY3RzCmRlZmljaWVuY2llcyBpbiB0aGUgdXJsbGliMiBtb2R1bGUgd2hlcmV2ZXIgcG9zc2libGUuCgpUaGVyZSBhcmUgYWxzbyB0aGlyZC1wYXJ0eSBsaWJyYXJpZXMgKGZvciBpbnN0YW5jZSwgcmVxdWVzdHMpIHdoaWNoIGNhbiBiZSB1c2VkCnRvIHJlcGxhY2UgdXJsbGliMiB3aXRoIGEgbW9yZSBzZWN1cmUgbGlicmFyeS4gSG93ZXZlciwgYWxsIHRoaXJkIHBhcnR5IGxpYnJhcmllcwpyZXF1aXJlIHRoYXQgdGhlIGxpYnJhcnkgYmUgaW5zdGFsbGVkIG9uIHRoZSBtYW5hZ2VkIG1hY2hpbmUuIFRoYXQgaXMgYW4gZXh0cmEgc3RlcApmb3IgdXNlcnMgbWFraW5nIHVzZSBvZiBhIG1vZHVsZS4gSWYgcG9zc2libGUsIGF2b2lkIHRoaXJkIHBhcnR5IGxpYnJhcmllcyBieSB1c2luZwp0aGlzIGNvZGUgaW5zdGVhZC4KJycnCgppbXBvcnQgbmV0cmMKaW1wb3J0IG9zCmltcG9ydCByZQppbXBvcnQgc3lzCmltcG9ydCBzb2NrZXQKaW1wb3J0IHBsYXRmb3JtCmltcG9ydCB0ZW1wZmlsZQppbXBvcnQgYmFzZTY0Cgp0cnk6CiAgICBpbXBvcnQgaHR0cGxpYgpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAjIFB5dGhvbiAzCiAgICBpbXBvcnQgaHR0cC5jbGllbnQgYXMgaHR0cGxpYgoKaW1wb3J0IGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5tb3Zlcy51cmxsaWIucmVxdWVzdCBhcyB1cmxsaWJfcmVxdWVzdAppbXBvcnQgYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Lm1vdmVzLnVybGxpYi5lcnJvciBhcyB1cmxsaWJfZXJyb3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5iYXNpYyBpbXBvcnQgZ2V0X2Rpc3RyaWJ1dGlvbiwgZ2V0X2V4Y2VwdGlvbgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpbXBvcnQgYgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLl90ZXh0IGltcG9ydCB0b19ieXRlcywgdG9fbmF0aXZlLCB0b190ZXh0Cgp0cnk6CiAgICAjIHB5dGhvbjMKICAgIGltcG9ydCB1cmxsaWIucmVxdWVzdCBhcyB1cmxsaWJfcmVxdWVzdAogICAgZnJvbSB1cmxsaWIucmVxdWVzdCBpbXBvcnQgQWJzdHJhY3RIVFRQSGFuZGxlcgpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAjIHB5dGhvbjIKICAgIGltcG9ydCB1cmxsaWIyIGFzIHVybGxpYl9yZXF1ZXN0CiAgICBmcm9tIHVybGxpYjIgaW1wb3J0IEFic3RyYWN0SFRUUEhhbmRsZXIKCnRyeToKICAgIGZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Lm1vdmVzLnVybGxpYi5wYXJzZSBpbXBvcnQgdXJscGFyc2UsIHVybHVucGFyc2UKICAgIEhBU19VUkxQQVJTRSA9IFRydWUKZXhjZXB0OgogICAgSEFTX1VSTFBBUlNFID0gRmFsc2UKCnRyeToKICAgIGltcG9ydCBzc2wKICAgIEhBU19TU0wgPSBUcnVlCmV4Y2VwdDoKICAgIEhBU19TU0wgPSBGYWxzZQoKdHJ5OgogICAgIyBTTkkgSGFuZGxpbmcgbmVlZHMgcHl0aG9uMi43LjkncyBTU0xDb250ZXh0CiAgICBmcm9tIHNzbCBpbXBvcnQgY3JlYXRlX2RlZmF1bHRfY29udGV4dCwgU1NMQ29udGV4dAogICAgSEFTX1NTTENPTlRFWFQgPSBUcnVlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIEhBU19TU0xDT05URVhUID0gRmFsc2UKCiMgU05JIEhhbmRsaW5nIGZvciBweXRob24gPCAyLjcuOSB3aXRoIHVybGxpYjMgc3VwcG9ydAp0cnk6CiAgICAjIHVybGxpYjM+PTEuMTUKICAgIEhBU19VUkxMSUIzX1NTTF9XUkFQX1NPQ0tFVCA9IEZhbHNlCiAgICB0cnk6CiAgICAgICAgZnJvbSB1cmxsaWIzLmNvbnRyaWIucHlvcGVuc3NsIGltcG9ydCBQeU9wZW5TU0xDb250ZXh0CiAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgZnJvbSByZXF1ZXN0cy5wYWNrYWdlcy51cmxsaWIzLmNvbnRyaWIucHlvcGVuc3NsIGltcG9ydCBQeU9wZW5TU0xDb250ZXh0CiAgICBIQVNfVVJMTElCM19QWU9QRU5TU0xDT05URVhUID0gVHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAjIHVybGxpYjM8MS4xNSw+PTEuNgogICAgSEFTX1VSTExJQjNfUFlPUEVOU1NMQ09OVEVYVCA9IEZhbHNlCiAgICB0cnk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBmcm9tIHVybGxpYjMuY29udHJpYi5weW9wZW5zc2wgaW1wb3J0IHNzbF93cmFwX3NvY2tldAogICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICAgICAgZnJvbSByZXF1ZXN0cy5wYWNrYWdlcy51cmxsaWIzLmNvbnRyaWIucHlvcGVuc3NsIGltcG9ydCBzc2xfd3JhcF9zb2NrZXQKICAgICAgICBIQVNfVVJMTElCM19TU0xfV1JBUF9TT0NLRVQgPSBUcnVlCiAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgcGFzcwoKIyBTZWxlY3QgYSBwcm90b2NvbCB0aGF0IGluY2x1ZGVzIGFsbCBzZWN1cmUgdGxzIHByb3RvY29scwojIEV4Y2x1ZGUgaW5zZWN1cmUgc3NsIHByb3RvY29scyBpZiBwb3NzaWJsZQoKaWYgSEFTX1NTTDoKICAgICMgSWYgd2UgY2FuJ3QgZmluZCBleHRyYSB0bHMgbWV0aG9kcywgc3NsLlBST1RPQ09MX1RMU3YxIGlzIHN1ZmZpY2llbnQKICAgIFBST1RPQ09MID0gc3NsLlBST1RPQ09MX1RMU3YxCmlmIG5vdCBIQVNfU1NMQ09OVEVYVCBhbmQgSEFTX1NTTDoKICAgIHRyeToKICAgICAgICBpbXBvcnQgY3R5cGVzCiAgICAgICAgaW1wb3J0IGN0eXBlcy51dGlsCiAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgIyBweXRob24gMi40IChsaWtlbHkgcmhlbDUgd2hpY2ggZG9lc24ndCBoYXZlIHRsczEuMSBzdXBwb3J0IGluIGl0cyBvcGVuc3NsKQogICAgICAgIHBhc3MKICAgIGVsc2U6CiAgICAgICAgbGlic3NsX25hbWUgPSBjdHlwZXMudXRpbC5maW5kX2xpYnJhcnkoJ3NzbCcpCiAgICAgICAgbGlic3NsID0gY3R5cGVzLkNETEwobGlic3NsX25hbWUpCiAgICAgICAgZm9yIG1ldGhvZCBpbiAoJ1RMU3YxXzFfbWV0aG9kJywgJ1RMU3YxXzJfbWV0aG9kJyk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxpYnNzbFttZXRob2RdCiAgICAgICAgICAgICAgICAjIEZvdW5kIHNvbWV0aGluZyAtIHdlJ2xsIGxldCBvcGVuc3NsIGF1dG9uZWdvdGlhdGUgYW5kIGhvcGUKICAgICAgICAgICAgICAgICMgdGhlIHNlcnZlciBoYXMgZGlzYWJsZWQgc3NsdjIgYW5kIDMuICBiZXN0IHdlIGNhbiBkby4KICAgICAgICAgICAgICAgIFBST1RPQ09MID0gc3NsLlBST1RPQ09MX1NTTHYyMwogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGRlbCBsaWJzc2wKCgpMT0FERURfVkVSSUZZX0xPQ0FUSU9OUyA9IHNldCgpCgpIQVNfTUFUQ0hfSE9TVE5BTUUgPSBUcnVlCnRyeToKICAgIGZyb20gc3NsIGltcG9ydCBtYXRjaF9ob3N0bmFtZSwgQ2VydGlmaWNhdGVFcnJvcgpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICB0cnk6CiAgICAgICAgZnJvbSBiYWNrcG9ydHMuc3NsX21hdGNoX2hvc3RuYW1lIGltcG9ydCBtYXRjaF9ob3N0bmFtZSwgQ2VydGlmaWNhdGVFcnJvcgogICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgIEhBU19NQVRDSF9IT1NUTkFNRSA9IEZhbHNlCgppZiBub3QgSEFTX01BVENIX0hPU1ROQU1FOgogICAgIyMjCiAgICAjIyMgVGhlIGZvbGxvd2luZyBibG9jayBvZiBjb2RlIGlzIHVuZGVyIHRoZSB0ZXJtcyBhbmQgY29uZGl0aW9ucyBvZiB0aGUKICAgICMjIyBQeXRob24gU29mdHdhcmUgRm91bmRhdGlvbiBMaWNlbnNlCiAgICAjIyMKCiAgICAiIiJUaGUgbWF0Y2hfaG9zdG5hbWUoKSBmdW5jdGlvbiBmcm9tIFB5dGhvbiAzLjQsIGVzc2VudGlhbCB3aGVuIHVzaW5nIFNTTC4iIiIKCiAgICBjbGFzcyBDZXJ0aWZpY2F0ZUVycm9yKFZhbHVlRXJyb3IpOgogICAgICAgIHBhc3MKCgogICAgZGVmIF9kbnNuYW1lX21hdGNoKGRuLCBob3N0bmFtZSwgbWF4X3dpbGRjYXJkcz0xKToKICAgICAgICAiIiJNYXRjaGluZyBhY2NvcmRpbmcgdG8gUkZDIDYxMjUsIHNlY3Rpb24gNi40LjMKCiAgICAgICAgaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjNjEyNSNzZWN0aW9uLTYuNC4zCiAgICAgICAgIiIiCiAgICAgICAgcGF0cyA9IFtdCiAgICAgICAgaWYgbm90IGRuOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgIyBQb3J0ZWQgZnJvbSBweXRob24zLXN5bnRheDoKICAgICAgICAjIGxlZnRtb3N0LCAqcmVtYWluZGVyID0gZG4uc3BsaXQocicuJykKICAgICAgICBwYXJ0cyA9IGRuLnNwbGl0KHInLicpCiAgICAgICAgbGVmdG1vc3QgPSBwYXJ0c1swXQogICAgICAgIHJlbWFpbmRlciA9IHBhcnRzWzE6XQoKICAgICAgICB3aWxkY2FyZHMgPSBsZWZ0bW9zdC5jb3VudCgnKicpCiAgICAgICAgaWYgd2lsZGNhcmRzID4gbWF4X3dpbGRjYXJkczoKICAgICAgICAgICAgIyBJc3N1ZSAjMTc5ODA6IGF2b2lkIGRlbmlhbHMgb2Ygc2VydmljZSBieSByZWZ1c2luZyBtb3JlCiAgICAgICAgICAgICMgdGhhbiBvbmUgd2lsZGNhcmQgcGVyIGZyYWdtZW50LiAgQSBzdXJ2ZXkgb2YgZXN0YWJsaXNoZWQKICAgICAgICAgICAgIyBwb2xpY3kgYW1vbmcgU1NMIGltcGxlbWVudGF0aW9ucyBzaG93ZWQgaXQgdG8gYmUgYQogICAgICAgICAgICAjIHJlYXNvbmFibGUgY2hvaWNlLgogICAgICAgICAgICByYWlzZSBDZXJ0aWZpY2F0ZUVycm9yKAogICAgICAgICAgICAgICAgInRvbyBtYW55IHdpbGRjYXJkcyBpbiBjZXJ0aWZpY2F0ZSBETlMgbmFtZTogIiArIHJlcHIoZG4pKQoKICAgICAgICAjIHNwZWVkIHVwIGNvbW1vbiBjYXNlIHcvbyB3aWxkY2FyZHMKICAgICAgICBpZiBub3Qgd2lsZGNhcmRzOgogICAgICAgICAgICByZXR1cm4gZG4ubG93ZXIoKSA9PSBob3N0bmFtZS5sb3dlcigpCgogICAgICAgICMgUkZDIDYxMjUsIHNlY3Rpb24gNi40LjMsIHN1Yml0ZW0gMS4KICAgICAgICAjIFRoZSBjbGllbnQgU0hPVUxEIE5PVCBhdHRlbXB0IHRvIG1hdGNoIGEgcHJlc2VudGVkIGlkZW50aWZpZXIgaW4gd2hpY2gKICAgICAgICAjIHRoZSB3aWxkY2FyZCBjaGFyYWN0ZXIgY29tcHJpc2VzIGEgbGFiZWwgb3RoZXIgdGhhbiB0aGUgbGVmdC1tb3N0IGxhYmVsLgogICAgICAgIGlmIGxlZnRtb3N0ID09ICcqJzoKICAgICAgICAgICAgIyBXaGVuICcqJyBpcyBhIGZyYWdtZW50IGJ5IGl0c2VsZiwgaXQgbWF0Y2hlcyBhIG5vbi1lbXB0eSBkb3RsZXNzCiAgICAgICAgICAgICMgZnJhZ21lbnQuCiAgICAgICAgICAgIHBhdHMuYXBwZW5kKCdbXi5dKycpCiAgICAgICAgZWxpZiBsZWZ0bW9zdC5zdGFydHN3aXRoKCd4bi0tJykgb3IgaG9zdG5hbWUuc3RhcnRzd2l0aCgneG4tLScpOgogICAgICAgICAgICAjIFJGQyA2MTI1LCBzZWN0aW9uIDYuNC4zLCBzdWJpdGVtIDMuCiAgICAgICAgICAgICMgVGhlIGNsaWVudCBTSE9VTEQgTk9UIGF0dGVtcHQgdG8gbWF0Y2ggYSBwcmVzZW50ZWQgaWRlbnRpZmllcgogICAgICAgICAgICAjIHdoZXJlIHRoZSB3aWxkY2FyZCBjaGFyYWN0ZXIgaXMgZW1iZWRkZWQgd2l0aGluIGFuIEEtbGFiZWwgb3IKICAgICAgICAgICAgIyBVLWxhYmVsIG9mIGFuIGludGVybmF0aW9uYWxpemVkIGRvbWFpbiBuYW1lLgogICAgICAgICAgICBwYXRzLmFwcGVuZChyZS5lc2NhcGUobGVmdG1vc3QpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgT3RoZXJ3aXNlLCAnKicgbWF0Y2hlcyBhbnkgZG90bGVzcyBzdHJpbmcsIGUuZy4gd3d3KgogICAgICAgICAgICBwYXRzLmFwcGVuZChyZS5lc2NhcGUobGVmdG1vc3QpLnJlcGxhY2UocidcKicsICdbXi5dKicpKQoKICAgICAgICAjIGFkZCB0aGUgcmVtYWluaW5nIGZyYWdtZW50cywgaWdub3JlIGFueSB3aWxkY2FyZHMKICAgICAgICBmb3IgZnJhZyBpbiByZW1haW5kZXI6CiAgICAgICAgICAgIHBhdHMuYXBwZW5kKHJlLmVzY2FwZShmcmFnKSkKCiAgICAgICAgcGF0ID0gcmUuY29tcGlsZShyJ1xBJyArIHInXC4nLmpvaW4ocGF0cykgKyByJ1xaJywgcmUuSUdOT1JFQ0FTRSkKICAgICAgICByZXR1cm4gcGF0Lm1hdGNoKGhvc3RuYW1lKQoKCiAgICBkZWYgbWF0Y2hfaG9zdG5hbWUoY2VydCwgaG9zdG5hbWUpOgogICAgICAgICIiIlZlcmlmeSB0aGF0ICpjZXJ0KiAoaW4gZGVjb2RlZCBmb3JtYXQgYXMgcmV0dXJuZWQgYnkKICAgICAgICBTU0xTb2NrZXQuZ2V0cGVlcmNlcnQoKSkgbWF0Y2hlcyB0aGUgKmhvc3RuYW1lKi4gIFJGQyAyODE4IGFuZCBSRkMgNjEyNQogICAgICAgIHJ1bGVzIGFyZSBmb2xsb3dlZCwgYnV0IElQIGFkZHJlc3NlcyBhcmUgbm90IGFjY2VwdGVkIGZvciAqaG9zdG5hbWUqLgoKICAgICAgICBDZXJ0aWZpY2F0ZUVycm9yIGlzIHJhaXNlZCBvbiBmYWlsdXJlLiBPbiBzdWNjZXNzLCB0aGUgZnVuY3Rpb24KICAgICAgICByZXR1cm5zIG5vdGhpbmcuCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IGNlcnQ6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImVtcHR5IG9yIG5vIGNlcnRpZmljYXRlIikKICAgICAgICBkbnNuYW1lcyA9IFtdCiAgICAgICAgc2FuID0gY2VydC5nZXQoJ3N1YmplY3RBbHROYW1lJywgKCkpCiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gc2FuOgogICAgICAgICAgICBpZiBrZXkgPT0gJ0ROUyc6CiAgICAgICAgICAgICAgICBpZiBfZG5zbmFtZV9tYXRjaCh2YWx1ZSwgaG9zdG5hbWUpOgogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgZG5zbmFtZXMuYXBwZW5kKHZhbHVlKQogICAgICAgIGlmIG5vdCBkbnNuYW1lczoKICAgICAgICAgICAgIyBUaGUgc3ViamVjdCBpcyBvbmx5IGNoZWNrZWQgd2hlbiB0aGVyZSBpcyBubyBkTlNOYW1lIGVudHJ5CiAgICAgICAgICAgICMgaW4gc3ViamVjdEFsdE5hbWUKICAgICAgICAgICAgZm9yIHN1YiBpbiBjZXJ0LmdldCgnc3ViamVjdCcsICgpKToKICAgICAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIHN1YjoKICAgICAgICAgICAgICAgICAgICAjIFhYWCBhY2NvcmRpbmcgdG8gUkZDIDI4MTgsIHRoZSBtb3N0IHNwZWNpZmljIENvbW1vbiBOYW1lCiAgICAgICAgICAgICAgICAgICAgIyBtdXN0IGJlIHVzZWQuCiAgICAgICAgICAgICAgICAgICAgaWYga2V5ID09ICdjb21tb25OYW1lJzoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgX2Ruc25hbWVfbWF0Y2godmFsdWUsIGhvc3RuYW1lKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgICAgICAgICBkbnNuYW1lcy5hcHBlbmQodmFsdWUpCiAgICAgICAgaWYgbGVuKGRuc25hbWVzKSA+IDE6CiAgICAgICAgICAgIHJhaXNlIENlcnRpZmljYXRlRXJyb3IoImhvc3RuYW1lICVyICIKICAgICAgICAgICAgICAgICJkb2Vzbid0IG1hdGNoIGVpdGhlciBvZiAlcyIKICAgICAgICAgICAgICAgICUgKGhvc3RuYW1lLCAnLCAnLmpvaW4obWFwKHJlcHIsIGRuc25hbWVzKSkpKQogICAgICAgIGVsaWYgbGVuKGRuc25hbWVzKSA9PSAxOgogICAgICAgICAgICByYWlzZSBDZXJ0aWZpY2F0ZUVycm9yKCJob3N0bmFtZSAlciAiCiAgICAgICAgICAgICAgICAiZG9lc24ndCBtYXRjaCAlciIKICAgICAgICAgICAgICAgICUgKGhvc3RuYW1lLCBkbnNuYW1lc1swXSkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgQ2VydGlmaWNhdGVFcnJvcigibm8gYXBwcm9wcmlhdGUgY29tbW9uTmFtZSBvciAiCiAgICAgICAgICAgICAgICAic3ViamVjdEFsdE5hbWUgZmllbGRzIHdlcmUgZm91bmQiKQoKICAgICMjIwogICAgIyMjIEVuZCBvZiBQeXRob24gU29mdHdhcmUgRm91bmRhdGlvbiBMaWNlbnNlZCBjb2RlCiAgICAjIyMKCiAgICBIQVNfTUFUQ0hfSE9TVE5BTUUgPSBUcnVlCgoKIyBUaGlzIGlzIGEgZHVtbXkgY2FjZXJ0IHByb3ZpZGVkIGZvciBNYWMgT1Mgc2luY2UgeW91IG5lZWQgYXQgbGVhc3QgMQojIGNhIGNlcnQsIHJlZ2FyZGxlc3Mgb2YgdmFsaWRpdHksIGZvciBQeXRob24gb24gTWFjIE9TIHRvIHVzZSB0aGUKIyBrZXljaGFpbiBmdW5jdGlvbmFsaXR5IGluIE9wZW5TU0wgZm9yIHZhbGlkYXRpbmcgU1NMIGNlcnRpZmljYXRlcy4KIyBTZWU6IGh0dHA6Ly9tZXJjdXJpYWwuc2VsZW5pYy5jb20vd2lraS9DQUNlcnRpZmljYXRlcyNNYWNfT1NfWF8xMC42X2FuZF9oaWdoZXIKYl9EVU1NWV9DQV9DRVJUID0gYigiIiItLS0tLUJFR0lOIENFUlRJRklDQVRFLS0tLS0KTUlJQ3ZEQ0NBaVdnQXdJQkFnSUpBTzhFMTJTNy9xRXBNQTBHQ1NxR1NJYjNEUUVCQlFVQU1Fa3hDekFKQmdOVgpCQVlUQWxWVE1SY3dGUVlEVlFRSUV3NU9iM0owYUNCRFlYSnZiR2x1WVRFUE1BMEdBMVVFQnhNR1JIVnlhR0Z0Ck1SQXdEZ1lEVlFRS0V3ZEJibk5wWW14bE1CNFhEVEUwTURNeE9ESXlNREF5TWxvWERUSTBNRE14TlRJeU1EQXkKTWxvd1NURUxNQWtHQTFVRUJoTUNWVk14RnpBVkJnTlZCQWdURGs1dmNuUm9JRU5oY205c2FXNWhNUTh3RFFZRApWUVFIRXdaRWRYSm9ZVzB4RURBT0JnTlZCQW9UQjBGdWMybGliR1V3Z1o4d0RRWUpLb1pJaHZjTkFRRUJCUUFECmdZMEFNSUdKQW9HQkFOdHZwUHEzSWxObFJiQ0hoWkFjUDZXQ3poYzVSYnNEcXloMXpya21MaTBHd2NRM3ovcjkKZ2FXZlFCWWhIcG9iSzJUaXExMVRmcmFIZU5CMy9WZk5JbWpaY0dwTjhGbDNNV3d1N0xmVmtKeTNnTk5ueGtBMQo0R28wL0xtSXZSRkhoYnpnZnVvOU5GZ2pQbW1hYjllcVhKY2VxWklsejJDOHhBN0VlRzdrdTArdkFnTUJBQUdqCmdhc3dnYWd3SFFZRFZSME9CQllFRlBuTjFuUFJxTkRYR2xDcUN2ZFpjaFJOaS9GYU1Ia0dBMVVkSXdSeU1IQ0EKRlBuTjFuUFJxTkRYR2xDcUN2ZFpjaFJOaS9GYW9VMmtTekJKTVFzd0NRWURWUVFHRXdKVlV6RVhNQlVHQTFVRQpDQk1PVG05eWRHZ2dRMkZ5YjJ4cGJtRXhEekFOQmdOVkJBY1RCa1IxY21oaGJURVFNQTRHQTFVRUNoTUhRVzV6CmFXSnNaWUlKQU84RTEyUzcvcUVwTUF3R0ExVWRFd1FGTUFNQkFmOHdEUVlKS29aSWh2Y05BUUVGQlFBRGdZRUEKTVVCODBJUjZrbnE5Sy90WStodlBzWmVyNmVGTXpPM0pHa1JGQmgya242SmRNRG5oWUdYN0FYVkhHZmxyd05RSApxRnkrYWVuV1hzQzBadnJpa0Z4YlFuWDhHVnREQUR0VnpueE9pN1h6Rnc3Sk94ZHNWcnBYZ1NOMGVoMGFNenZWCnpLUFpzWjJtaVZHY2xpY0pIem01cTA4MGIxcC9zWnR1S0lFWms2dlpxRWc9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KIiIiKQoKIwojIEV4Y2VwdGlvbnMKIwoKCmNsYXNzIENvbm5lY3Rpb25FcnJvcihFeGNlcHRpb24pOgogICAgIiIiRmFpbGVkIHRvIGNvbm5lY3QgdG8gdGhlIHNlcnZlciIiIgogICAgcGFzcwoKCmNsYXNzIFByb3h5RXJyb3IoQ29ubmVjdGlvbkVycm9yKToKICAgICIiIkZhaWx1cmUgdG8gY29ubmVjdCBiZWNhdXNlIG9mIGEgcHJveHkiIiIKICAgIHBhc3MKCgpjbGFzcyBTU0xWYWxpZGF0aW9uRXJyb3IoQ29ubmVjdGlvbkVycm9yKToKICAgICIiIkZhaWx1cmUgdG8gY29ubmVjdCBkdWUgdG8gU1NMIHZhbGlkYXRpb24gZmFpbGluZyIiIgogICAgcGFzcwoKCmNsYXNzIE5vU1NMRXJyb3IoU1NMVmFsaWRhdGlvbkVycm9yKToKICAgICIiIk5lZWRlZCB0byBjb25uZWN0IHRvIGFuIEhUVFBTIHVybCBidXQgbm8gc3NsIGxpYnJhcnkgYXZhaWxhYmxlIHRvIHZlcmlmeSB0aGUgY2VydGlmaWNhdGUiIiIKICAgIHBhc3MKCiMgU29tZSBlbnZpcm9ubWVudHMgKEdvb2dsZSBDb21wdXRlIEVuZ2luZSdzIENvcmVPUyBkZXBsb3lzKSBkbyBub3QgY29tcGlsZQojIGFnYWluc3Qgb3BlbnNzbCBhbmQgdGh1cyBkbyBub3QgaGF2ZSBhbnkgSFRUUFMgc3VwcG9ydC4KQ3VzdG9tSFRUUFNDb25uZWN0aW9uID0gQ3VzdG9tSFRUUFNIYW5kbGVyID0gTm9uZQppZiBoYXNhdHRyKGh0dHBsaWIsICdIVFRQU0Nvbm5lY3Rpb24nKSBhbmQgaGFzYXR0cih1cmxsaWJfcmVxdWVzdCwgJ0hUVFBTSGFuZGxlcicpOgogICAgY2xhc3MgQ3VzdG9tSFRUUFNDb25uZWN0aW9uKGh0dHBsaWIuSFRUUFNDb25uZWN0aW9uKToKICAgICAgICBkZWYgX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAgICAgaHR0cGxpYi5IVFRQU0Nvbm5lY3Rpb24uX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKQogICAgICAgICAgICBzZWxmLmNvbnRleHQgPSBOb25lCiAgICAgICAgICAgIGlmIEhBU19TU0xDT05URVhUOgogICAgICAgICAgICAgICAgc2VsZi5jb250ZXh0ID0gY3JlYXRlX2RlZmF1bHRfY29udGV4dCgpCiAgICAgICAgICAgIGVsaWYgSEFTX1VSTExJQjNfUFlPUEVOU1NMQ09OVEVYVDoKICAgICAgICAgICAgICAgIHNlbGYuY29udGV4dCA9IFB5T3BlblNTTENvbnRleHQoUFJPVE9DT0wpCiAgICAgICAgICAgIGlmIHNlbGYuY29udGV4dCBhbmQgc2VsZi5jZXJ0X2ZpbGU6CiAgICAgICAgICAgICAgICBzZWxmLmNvbnRleHQubG9hZF9jZXJ0X2NoYWluKHNlbGYuY2VydF9maWxlLCBzZWxmLmtleV9maWxlKQoKICAgICAgICBkZWYgY29ubmVjdChzZWxmKToKICAgICAgICAgICAgIkNvbm5lY3QgdG8gYSBob3N0IG9uIGEgZ2l2ZW4gKFNTTCkgcG9ydC4iCgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdzb3VyY2VfYWRkcmVzcycpOgogICAgICAgICAgICAgICAgc29jayA9IHNvY2tldC5jcmVhdGVfY29ubmVjdGlvbigoc2VsZi5ob3N0LCBzZWxmLnBvcnQpLCBzZWxmLnRpbWVvdXQsIHNlbGYuc291cmNlX2FkZHJlc3MpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzb2NrID0gc29ja2V0LmNyZWF0ZV9jb25uZWN0aW9uKChzZWxmLmhvc3QsIHNlbGYucG9ydCksIHNlbGYudGltZW91dCkKCiAgICAgICAgICAgIHNlcnZlcl9ob3N0bmFtZSA9IHNlbGYuaG9zdAogICAgICAgICAgICAjIE5vdGU6IHNlbGYuX3R1bm5lbF9ob3N0IGlzIG5vdCBhdmFpbGFibGUgb24gcHkgPCAyLjYgYnV0IHRoaXMgY29kZQogICAgICAgICAgICAjIGlzbid0IHVzZWQgb24gcHkgPCAyLjYgKGxhY2sgb2YgY3JlYXRlX2Nvbm5lY3Rpb24pCiAgICAgICAgICAgIGlmIHNlbGYuX3R1bm5lbF9ob3N0OgogICAgICAgICAgICAgICAgc2VsZi5zb2NrID0gc29jawogICAgICAgICAgICAgICAgc2VsZi5fdHVubmVsKCkKICAgICAgICAgICAgICAgIHNlcnZlcl9ob3N0bmFtZSA9IHNlbGYuX3R1bm5lbF9ob3N0CgogICAgICAgICAgICBpZiBIQVNfU1NMQ09OVEVYVCBvciBIQVNfVVJMTElCM19QWU9QRU5TU0xDT05URVhUOgogICAgICAgICAgICAgICAgc2VsZi5zb2NrID0gc2VsZi5jb250ZXh0LndyYXBfc29ja2V0KHNvY2ssIHNlcnZlcl9ob3N0bmFtZT1zZXJ2ZXJfaG9zdG5hbWUpCiAgICAgICAgICAgIGVsaWYgSEFTX1VSTExJQjNfU1NMX1dSQVBfU09DS0VUOgogICAgICAgICAgICAgICAgc2VsZi5zb2NrID0gc3NsX3dyYXBfc29ja2V0KHNvY2ssIGtleWZpbGU9c2VsZi5rZXlfZmlsZSwgY2VydF9yZXFzPXNzbC5DRVJUX05PTkUsIGNlcnRmaWxlPXNlbGYuY2VydF9maWxlLCBzc2xfdmVyc2lvbj1QUk9UT0NPTCwKICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyX2hvc3RuYW1lPXNlcnZlcl9ob3N0bmFtZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuc29jayA9IHNzbC53cmFwX3NvY2tldChzb2NrLCBrZXlmaWxlPXNlbGYua2V5X2ZpbGUsIGNlcnRmaWxlPXNlbGYuY2VydF9maWxlLCBzc2xfdmVyc2lvbj1QUk9UT0NPTCkKCiAgICBjbGFzcyBDdXN0b21IVFRQU0hhbmRsZXIodXJsbGliX3JlcXVlc3QuSFRUUFNIYW5kbGVyKToKCiAgICAgICAgZGVmIGh0dHBzX29wZW4oc2VsZiwgcmVxKToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuZG9fb3BlbihDdXN0b21IVFRQU0Nvbm5lY3Rpb24sIHJlcSkKCiAgICAgICAgaHR0cHNfcmVxdWVzdCA9IEFic3RyYWN0SFRUUEhhbmRsZXIuZG9fcmVxdWVzdF8KCgpjbGFzcyBIVFRQU0NsaWVudEF1dGhIYW5kbGVyKHVybGxpYl9yZXF1ZXN0LkhUVFBTSGFuZGxlcik6CiAgICAnJydIYW5kbGVzIGNsaWVudCBhdXRoZW50aWNhdGlvbiB2aWEgY2VydC9rZXkKCiAgICBUaGlzIGlzIGEgZmFpcmx5IGxpZ2h0d2VpZ2h0IGV4dGVuc2lvbiBvbiBIVFRQU0hhbmRsZXIsIGFuZCBjYW4gYmUgdXNlZAogICAgaW4gcGxhY2Ugb2YgSFRUUFNIYW5kbGVyCiAgICAnJycKCiAgICBkZWYgX19pbml0X18oc2VsZiwgY2xpZW50X2NlcnQ9Tm9uZSwgY2xpZW50X2tleT1Ob25lLCAqKmt3YXJncyk6CiAgICAgICAgdXJsbGliX3JlcXVlc3QuSFRUUFNIYW5kbGVyLl9faW5pdF9fKHNlbGYsICoqa3dhcmdzKQogICAgICAgIHNlbGYuY2xpZW50X2NlcnQgPSBjbGllbnRfY2VydAogICAgICAgIHNlbGYuY2xpZW50X2tleSA9IGNsaWVudF9rZXkKCiAgICBkZWYgaHR0cHNfb3BlbihzZWxmLCByZXEpOgogICAgICAgIHJldHVybiBzZWxmLmRvX29wZW4oc2VsZi5fYnVpbGRfaHR0cHNfY29ubmVjdGlvbiwgcmVxKQoKICAgIGRlZiBfYnVpbGRfaHR0cHNfY29ubmVjdGlvbihzZWxmLCBob3N0LCAqKmt3YXJncyk6CiAgICAgICAga3dhcmdzLnVwZGF0ZSh7CiAgICAgICAgICAgICdjZXJ0X2ZpbGUnOiBzZWxmLmNsaWVudF9jZXJ0LAogICAgICAgICAgICAna2V5X2ZpbGUnOiBzZWxmLmNsaWVudF9rZXksCiAgICAgICAgfSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGt3YXJnc1snY29udGV4dCddID0gc2VsZi5fY29udGV4dAogICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBodHRwbGliLkhUVFBTQ29ubmVjdGlvbihob3N0LCAqKmt3YXJncykKCgpkZWYgZ2VuZXJpY191cmxwYXJzZShwYXJ0cyk6CiAgICAnJycKICAgIFJldHVybnMgYSBkaWN0aW9uYXJ5IG9mIHVybCBwYXJ0cyBhcyBwYXJzZWQgYnkgdXJscGFyc2UsCiAgICBidXQgYWNjb3VudHMgZm9yIHRoZSBmYWN0IHRoYXQgb2xkZXIgdmVyc2lvbnMgb2YgdGhhdAogICAgbGlicmFyeSBkbyBub3Qgc3VwcG9ydCBuYW1lZCBhdHRyaWJ1dGVzIChpZS4gLm5ldGxvYykKICAgICcnJwogICAgZ2VuZXJpY19wYXJ0cyA9IGRpY3QoKQogICAgaWYgaGFzYXR0cihwYXJ0cywgJ25ldGxvYycpOgogICAgICAgICMgdXJscGFyc2UgaXMgbmV3ZXIsIGp1c3QgcmVhZCB0aGUgZmllbGRzIHN0cmFpZ2h0CiAgICAgICAgIyBmcm9tIHRoZSBwYXJ0cyBvYmplY3QKICAgICAgICBnZW5lcmljX3BhcnRzWydzY2hlbWUnXSAgID0gcGFydHMuc2NoZW1lCiAgICAgICAgZ2VuZXJpY19wYXJ0c1snbmV0bG9jJ10gICA9IHBhcnRzLm5ldGxvYwogICAgICAgIGdlbmVyaWNfcGFydHNbJ3BhdGgnXSAgICAgPSBwYXJ0cy5wYXRoCiAgICAgICAgZ2VuZXJpY19wYXJ0c1sncGFyYW1zJ10gICA9IHBhcnRzLnBhcmFtcwogICAgICAgIGdlbmVyaWNfcGFydHNbJ3F1ZXJ5J10gICAgPSBwYXJ0cy5xdWVyeQogICAgICAgIGdlbmVyaWNfcGFydHNbJ2ZyYWdtZW50J10gPSBwYXJ0cy5mcmFnbWVudAogICAgICAgIGdlbmVyaWNfcGFydHNbJ3VzZXJuYW1lJ10gPSBwYXJ0cy51c2VybmFtZQogICAgICAgIGdlbmVyaWNfcGFydHNbJ3Bhc3N3b3JkJ10gPSBwYXJ0cy5wYXNzd29yZAogICAgICAgIGdlbmVyaWNfcGFydHNbJ2hvc3RuYW1lJ10gPSBwYXJ0cy5ob3N0bmFtZQogICAgICAgIGdlbmVyaWNfcGFydHNbJ3BvcnQnXSAgICAgPSBwYXJ0cy5wb3J0CiAgICBlbHNlOgogICAgICAgICMgd2UgaGF2ZSB0byB1c2UgaW5kZXhlcywgYW5kIHRoZW4gcGFyc2Ugb3V0CiAgICAgICAgIyB0aGUgb3RoZXIgcGFydHMgbm90IHN1cHBvcnRlZCBieSBpbmRleGluZwogICAgICAgIGdlbmVyaWNfcGFydHNbJ3NjaGVtZSddICAgPSBwYXJ0c1swXQogICAgICAgIGdlbmVyaWNfcGFydHNbJ25ldGxvYyddICAgPSBwYXJ0c1sxXQogICAgICAgIGdlbmVyaWNfcGFydHNbJ3BhdGgnXSAgICAgPSBwYXJ0c1syXQogICAgICAgIGdlbmVyaWNfcGFydHNbJ3BhcmFtcyddICAgPSBwYXJ0c1szXQogICAgICAgIGdlbmVyaWNfcGFydHNbJ3F1ZXJ5J10gICAgPSBwYXJ0c1s0XQogICAgICAgIGdlbmVyaWNfcGFydHNbJ2ZyYWdtZW50J10gPSBwYXJ0c1s1XQogICAgICAgICMgZ2V0IHRoZSB1c2VybmFtZSwgcGFzc3dvcmQsIGV0Yy4KICAgICAgICB0cnk6CiAgICAgICAgICAgIG5ldGxvY19yZSA9IHJlLmNvbXBpbGUocideKCg/Olx3KSsoPzo6KD86XHcpKyk/QCk/KFtBLVphLXowLTkuLV0rKSg6XGQrKT8kJykKICAgICAgICAgICAgbWF0Y2ggPSBuZXRsb2NfcmUubWF0Y2gocGFydHNbMV0pCiAgICAgICAgICAgIGF1dGggPSBtYXRjaC5ncm91cCgxKQogICAgICAgICAgICBob3N0bmFtZSA9IG1hdGNoLmdyb3VwKDIpCiAgICAgICAgICAgIHBvcnQgPSBtYXRjaC5ncm91cCgzKQogICAgICAgICAgICBpZiBwb3J0OgogICAgICAgICAgICAgICAgIyB0aGUgY2FwdHVyZSBncm91cCBmb3IgdGhlIHBvcnQgd2lsbCBpbmNsdWRlIHRoZSAnOicsCiAgICAgICAgICAgICAgICAjIHNvIHJlbW92ZSBpdCBhbmQgY29udmVydCB0aGUgcG9ydCB0byBhbiBpbnRlZ2VyCiAgICAgICAgICAgICAgICBwb3J0ID0gaW50KHBvcnRbMTpdKQogICAgICAgICAgICBpZiBhdXRoOgogICAgICAgICAgICAgICAgIyB0aGUgY2FwdHVyZSBncm91cCBhYm92ZSBpbmNsdWVzIHRoZSBALCBzbyByZW1vdmUgaXQKICAgICAgICAgICAgICAgICMgYW5kIHRoZW4gc3BsaXQgaXQgdXAgYmFzZWQgb24gdGhlIGZpcnN0ICc6JyBmb3VuZAogICAgICAgICAgICAgICAgYXV0aCA9IGF1dGhbOi0xXQogICAgICAgICAgICAgICAgdXNlcm5hbWUsIHBhc3N3b3JkID0gYXV0aC5zcGxpdCgnOicsIDEpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHBhc3N3b3JkID0gTm9uZQogICAgICAgICAgICBnZW5lcmljX3BhcnRzWyd1c2VybmFtZSddID0gdXNlcm5hbWUKICAgICAgICAgICAgZ2VuZXJpY19wYXJ0c1sncGFzc3dvcmQnXSA9IHBhc3N3b3JkCiAgICAgICAgICAgIGdlbmVyaWNfcGFydHNbJ2hvc3RuYW1lJ10gPSBob3N0bmFtZQogICAgICAgICAgICBnZW5lcmljX3BhcnRzWydwb3J0J10gICAgID0gcG9ydAogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgZ2VuZXJpY19wYXJ0c1sndXNlcm5hbWUnXSA9IE5vbmUKICAgICAgICAgICAgZ2VuZXJpY19wYXJ0c1sncGFzc3dvcmQnXSA9IE5vbmUKICAgICAgICAgICAgZ2VuZXJpY19wYXJ0c1snaG9zdG5hbWUnXSA9IHBhcnRzWzFdCiAgICAgICAgICAgIGdlbmVyaWNfcGFydHNbJ3BvcnQnXSAgICAgPSBOb25lCiAgICByZXR1cm4gZ2VuZXJpY19wYXJ0cwoKCmNsYXNzIFJlcXVlc3RXaXRoTWV0aG9kKHVybGxpYl9yZXF1ZXN0LlJlcXVlc3QpOgogICAgJycnCiAgICBXb3JrYXJvdW5kIGZvciB1c2luZyBERUxFVEUvUFVUL2V0YyB3aXRoIHVybGxpYjIKICAgIE9yaWdpbmFsbHkgY29udGFpbmVkIGluIGxpYnJhcnkvbmV0X2luZnJhc3RydWN0dXJlL2Ruc21hZGVlYXN5CiAgICAnJycKCiAgICBkZWYgX19pbml0X18oc2VsZiwgdXJsLCBtZXRob2QsIGRhdGE9Tm9uZSwgaGVhZGVycz1Ob25lKToKICAgICAgICBpZiBoZWFkZXJzIGlzIE5vbmU6CiAgICAgICAgICAgIGhlYWRlcnMgPSB7fQogICAgICAgIHNlbGYuX21ldGhvZCA9IG1ldGhvZC51cHBlcigpCiAgICAgICAgdXJsbGliX3JlcXVlc3QuUmVxdWVzdC5fX2luaXRfXyhzZWxmLCB1cmwsIGRhdGEsIGhlYWRlcnMpCgogICAgZGVmIGdldF9tZXRob2Qoc2VsZik6CiAgICAgICAgaWYgc2VsZi5fbWV0aG9kOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fbWV0aG9kCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHVybGxpYl9yZXF1ZXN0LlJlcXVlc3QuZ2V0X21ldGhvZChzZWxmKQoKCmRlZiBSZWRpcmVjdEhhbmRsZXJGYWN0b3J5KGZvbGxvd19yZWRpcmVjdHM9Tm9uZSwgdmFsaWRhdGVfY2VydHM9VHJ1ZSk6CiAgICAiIiJUaGlzIGlzIGEgY2xhc3MgZmFjdG9yeSB0aGF0IGNsb3NlcyBvdmVyIHRoZSB2YWx1ZSBvZgogICAgYGBmb2xsb3dfcmVkaXJlY3RzYGAgc28gdGhhdCB0aGUgUmVkaXJlY3RIYW5kbGVyIGNsYXNzIGhhcyBhY2Nlc3MgdG8KICAgIHRoYXQgdmFsdWUgd2l0aG91dCBoYXZpbmcgdG8gdXNlIGdsb2JhbHMsIGFuZCBwb3RlbnRpYWxseSBjYXVzZSBwcm9ibGVtcwogICAgd2hlcmUgYGBvcGVuX3VybGBgIG9yIGBgZmV0Y2hfdXJsYGAgYXJlIHVzZWQgbXVsdGlwbGUgdGltZXMgaW4gYSBtb2R1bGUuCiAgICAiIiIKCiAgICBjbGFzcyBSZWRpcmVjdEhhbmRsZXIodXJsbGliX3JlcXVlc3QuSFRUUFJlZGlyZWN0SGFuZGxlcik6CiAgICAgICAgIiIiVGhpcyBpcyBhbiBpbXBsZW1lbnRhdGlvbiBvZiBhIFJlZGlyZWN0SGFuZGxlciB0byBtYXRjaCB0aGUKICAgICAgICBmdW5jdGlvbmFsaXR5IHByb3ZpZGVkIGJ5IGh0dHBsaWIyLiBJdCB3aWxsIHV0aWxpemUgdGhlIHZhbHVlIG9mCiAgICAgICAgYGBmb2xsb3dfcmVkaXJlY3RzYGAgdGhhdCBpcyBwYXNzZWQgaW50byBgYFJlZGlyZWN0SGFuZGxlckZhY3RvcnlgYAogICAgICAgIHRvIGRldGVybWluZSBob3cgcmVkaXJlY3RzIHNob3VsZCBiZSBoYW5kbGVkIGluIHVybGxpYjIuCiAgICAgICAgIiIiCgogICAgICAgIGRlZiByZWRpcmVjdF9yZXF1ZXN0KHNlbGYsIHJlcSwgZnAsIGNvZGUsIG1zZywgaGRycywgbmV3dXJsKToKICAgICAgICAgICAgaGFuZGxlciA9IG1heWJlX2FkZF9zc2xfaGFuZGxlcihuZXd1cmwsIHZhbGlkYXRlX2NlcnRzKQogICAgICAgICAgICBpZiBoYW5kbGVyOgogICAgICAgICAgICAgICAgdXJsbGliX3JlcXVlc3QuX29wZW5lci5hZGRfaGFuZGxlcihoYW5kbGVyKQoKICAgICAgICAgICAgaWYgZm9sbG93X3JlZGlyZWN0cyA9PSAndXJsbGliMic6CiAgICAgICAgICAgICAgICByZXR1cm4gdXJsbGliX3JlcXVlc3QuSFRUUFJlZGlyZWN0SGFuZGxlci5yZWRpcmVjdF9yZXF1ZXN0KHNlbGYsIHJlcSwgZnAsIGNvZGUsIG1zZywgaGRycywgbmV3dXJsKQogICAgICAgICAgICBlbGlmIGZvbGxvd19yZWRpcmVjdHMgaW4gWydubycsICdub25lJywgRmFsc2VdOgogICAgICAgICAgICAgICAgcmFpc2UgdXJsbGliX2Vycm9yLkhUVFBFcnJvcihuZXd1cmwsIGNvZGUsIG1zZywgaGRycywgZnApCgogICAgICAgICAgICBkb19yZWRpcmVjdCA9IEZhbHNlCiAgICAgICAgICAgIGlmIGZvbGxvd19yZWRpcmVjdHMgaW4gWydhbGwnLCAneWVzJywgVHJ1ZV06CiAgICAgICAgICAgICAgICBkb19yZWRpcmVjdCA9IChjb2RlID49IDMwMCBhbmQgY29kZSA8IDQwMCkKCiAgICAgICAgICAgIGVsaWYgZm9sbG93X3JlZGlyZWN0cyA9PSAnc2FmZSc6CiAgICAgICAgICAgICAgICBtID0gcmVxLmdldF9tZXRob2QoKQogICAgICAgICAgICAgICAgZG9fcmVkaXJlY3QgPSAoY29kZSA+PSAzMDAgYW5kIGNvZGUgPCA0MDAgYW5kIG0gaW4gKCdHRVQnLCAnSEVBRCcpKQoKICAgICAgICAgICAgaWYgZG9fcmVkaXJlY3Q6CiAgICAgICAgICAgICAgICAjIGJlIGNvbmNpbGlhbnQgd2l0aCBVUklzIGNvbnRhaW5pbmcgYSBzcGFjZQogICAgICAgICAgICAgICAgbmV3dXJsID0gbmV3dXJsLnJlcGxhY2UoJyAnLCAnJTIwJykKICAgICAgICAgICAgICAgIG5ld2hlYWRlcnMgPSBkaWN0KChrLHYpIGZvciBrLHYgaW4gcmVxLmhlYWRlcnMuaXRlbXMoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgay5sb3dlcigpIG5vdCBpbiAoImNvbnRlbnQtbGVuZ3RoIiwgImNvbnRlbnQtdHlwZSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIFB5dGhvbiAyLTMuMwogICAgICAgICAgICAgICAgICAgIG9yaWdpbl9yZXFfaG9zdCA9IHJlcS5nZXRfb3JpZ2luX3JlcV9ob3N0KCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgICAgICAgICAjIFB5dGhvbiAzLjQrCiAgICAgICAgICAgICAgICAgICAgb3JpZ2luX3JlcV9ob3N0ID0gcmVxLm9yaWdpbl9yZXFfaG9zdAogICAgICAgICAgICAgICAgcmV0dXJuIHVybGxpYl9yZXF1ZXN0LlJlcXVlc3QobmV3dXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycz1uZXdoZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luX3JlcV9ob3N0PW9yaWdpbl9yZXFfaG9zdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVudmVyaWZpYWJsZT1UcnVlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgdXJsbGliX2Vycm9yLkhUVFBFcnJvcihyZXEuZ2V0X2Z1bGxfdXJsKCksIGNvZGUsIG1zZywgaGRycywgZnApCgogICAgcmV0dXJuIFJlZGlyZWN0SGFuZGxlcgoKCmRlZiBidWlsZF9zc2xfdmFsaWRhdGlvbl9lcnJvcihob3N0bmFtZSwgcG9ydCwgcGF0aHMsIGV4Yz1Ob25lKToKICAgICcnJ0ludGVsaWdlbnRseSBidWlsZCBvdXQgdGhlIFNTTFZhbGlkYXRpb25FcnJvciBiYXNlZCBvbiB3aGF0IHN1cHBvcnQKICAgIHlvdSBoYXZlIGluc3RhbGxlZAogICAgJycnCgogICAgbXNnID0gWwogICAgICAgICgnRmFpbGVkIHRvIHZhbGlkYXRlIHRoZSBTU0wgY2VydGlmaWNhdGUgZm9yICVzOiVzLicKICAgICAgICAgJyBNYWtlIHN1cmUgeW91ciBtYW5hZ2VkIHN5c3RlbXMgaGF2ZSBhIHZhbGlkIENBJwogICAgICAgICAnIGNlcnRpZmljYXRlIGluc3RhbGxlZC4nKQogICAgXQogICAgaWYgbm90IEhBU19TU0xDT05URVhUOgogICAgICAgIG1zZy5hcHBlbmQoJ0lmIHRoZSB3ZWJzaXRlIHNlcnZpbmcgdGhlIHVybCB1c2VzIFNOSSB5b3UgbmVlZCcKICAgICAgICAgICAgICAgICAgICcgcHl0aG9uID49IDIuNy45IG9uIHlvdXIgbWFuYWdlZCBtYWNoaW5lJykKICAgICAgICBpZiBub3QgSEFTX1VSTExJQjNfUFlPUEVOU1NMQ09OVEVYVCBvciBub3QgSEFTX1VSTExJQjNfU1NMX1dSQVBfU09DS0VUOgogICAgICAgICAgICBtc2cuYXBwZW5kKCdvciB5b3UgY2FuIGluc3RhbGwgdGhlIGB1cmxsaWIzYCwgYHB5T3BlblNTTGAsJwogICAgICAgICAgICAgICAgICAgICAgICcgYG5kZy1odHRwc2NsaWVudGAsIGFuZCBgcHlhc24xYCBweXRob24gbW9kdWxlcycpCgogICAgICAgIG1zZy5hcHBlbmQoJ3RvIHBlcmZvcm0gU05JIHZlcmlmaWNhdGlvbiBpbiBweXRob24gPj0gMi42LicpCgogICAgbXNnLmFwcGVuZCgnWW91IGNhbiB1c2UgdmFsaWRhdGVfY2VydHM9RmFsc2UgaWYgeW91IGRvJwogICAgICAgICAgICAgICAnIG5vdCBuZWVkIHRvIGNvbmZpcm0gdGhlIHNlcnZlcnMgaWRlbnRpdHkgYnV0IHRoaXMgaXMnCiAgICAgICAgICAgICAgICcgdW5zYWZlIGFuZCBub3QgcmVjb21tZW5kZWQuJwogICAgICAgICAgICAgICAnIFBhdGhzIGNoZWNrZWQgZm9yIHRoaXMgcGxhdGZvcm06ICVzLicpCgogICAgaWYgZXhjOgogICAgICAgIG1zZy5hcHBlbmQoJ1RoZSBleGNlcHRpb24gbXNnIHdhczogJXMuJyAlIHRvX25hdGl2ZShleGMpKQoKICAgIHJhaXNlIFNTTFZhbGlkYXRpb25FcnJvcignICcuam9pbihtc2cpICUgKGhvc3RuYW1lLCBwb3J0LCAiLCAiLmpvaW4ocGF0aHMpKSkKCgpjbGFzcyBTU0xWYWxpZGF0aW9uSGFuZGxlcih1cmxsaWJfcmVxdWVzdC5CYXNlSGFuZGxlcik6CiAgICAnJycKICAgIEEgY3VzdG9tIGhhbmRsZXIgY2xhc3MgZm9yIFNTTCB2YWxpZGF0aW9uLgoKICAgIEJhc2VkIG9uOgogICAgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xMDg3MjI3L3ZhbGlkYXRlLXNzbC1jZXJ0aWZpY2F0ZXMtd2l0aC1weXRob24KICAgIGh0dHA6Ly90ZWNoa25hY2submV0L3B5dGhvbi11cmxsaWIyLWhhbmRsZXJzLwogICAgJycnCiAgICBDT05ORUNUX0NPTU1BTkQgPSAiQ09OTkVDVCAlczolcyBIVFRQLzEuMFxyXG5Db25uZWN0aW9uOiBjbG9zZVxyXG4iCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGhvc3RuYW1lLCBwb3J0KToKICAgICAgICBzZWxmLmhvc3RuYW1lID0gaG9zdG5hbWUKICAgICAgICBzZWxmLnBvcnQgPSBwb3J0CgogICAgZGVmIGdldF9jYV9jZXJ0cyhzZWxmKToKICAgICAgICAjIHRyaWVzIHRvIGZpbmQgYSB2YWxpZCBDQSBjZXJ0IGluIG9uZSBvZiB0aGUKICAgICAgICAjIHN0YW5kYXJkIGxvY2F0aW9ucyBmb3IgdGhlIGN1cnJlbnQgZGlzdHJpYnV0aW9uCgogICAgICAgIGNhX2NlcnRzID0gW10KICAgICAgICBwYXRoc19jaGVja2VkID0gW10KCiAgICAgICAgc3lzdGVtID0gdG9fdGV4dChwbGF0Zm9ybS5zeXN0ZW0oKSwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICAjIGJ1aWxkIGEgbGlzdCBvZiBwYXRocyB0byBjaGVjayBmb3IgLmNydC8ucGVtIGZpbGVzCiAgICAgICAgIyBiYXNlZCBvbiB0aGUgcGxhdGZvcm0gdHlwZQogICAgICAgIHBhdGhzX2NoZWNrZWQuYXBwZW5kKCcvZXRjL3NzbC9jZXJ0cycpCiAgICAgICAgaWYgc3lzdGVtID09IHUnTGludXgnOgogICAgICAgICAgICBwYXRoc19jaGVja2VkLmFwcGVuZCgnL2V0Yy9wa2kvY2EtdHJ1c3QvZXh0cmFjdGVkL3BlbScpCiAgICAgICAgICAgIHBhdGhzX2NoZWNrZWQuYXBwZW5kKCcvZXRjL3BraS90bHMvY2VydHMnKQogICAgICAgICAgICBwYXRoc19jaGVja2VkLmFwcGVuZCgnL3Vzci9zaGFyZS9jYS1jZXJ0aWZpY2F0ZXMvY2FjZXJ0Lm9yZycpCiAgICAgICAgZWxpZiBzeXN0ZW0gPT0gdSdGcmVlQlNEJzoKICAgICAgICAgICAgcGF0aHNfY2hlY2tlZC5hcHBlbmQoJy91c3IvbG9jYWwvc2hhcmUvY2VydHMnKQogICAgICAgIGVsaWYgc3lzdGVtID09IHUnT3BlbkJTRCc6CiAgICAgICAgICAgIHBhdGhzX2NoZWNrZWQuYXBwZW5kKCcvZXRjL3NzbCcpCiAgICAgICAgZWxpZiBzeXN0ZW0gPT0gdSdOZXRCU0QnOgogICAgICAgICAgICBjYV9jZXJ0cy5hcHBlbmQoJy9ldGMvb3BlbnNzbC9jZXJ0cycpCiAgICAgICAgZWxpZiBzeXN0ZW0gPT0gdSdTdW5PUyc6CiAgICAgICAgICAgIHBhdGhzX2NoZWNrZWQuYXBwZW5kKCcvb3B0L2xvY2FsL2V0Yy9vcGVuc3NsL2NlcnRzJykKCiAgICAgICAgIyBmYWxsIGJhY2sgdG8gYSB1c2VyLWRlcGxveWVkIGNlcnQgaW4gYSBzdGFuZGFyZAogICAgICAgICMgbG9jYXRpb24gaWYgdGhlIE9TIHBsYXRmb3JtIG9uZSBpcyBub3QgYXZhaWxhYmxlCiAgICAgICAgcGF0aHNfY2hlY2tlZC5hcHBlbmQoJy9ldGMvYW5zaWJsZScpCgogICAgICAgIHRtcF9mZCwgdG1wX3BhdGggPSB0ZW1wZmlsZS5ta3N0ZW1wKCkKICAgICAgICB0b19hZGRfZmQsIHRvX2FkZF9wYXRoID0gdGVtcGZpbGUubWtzdGVtcCgpCiAgICAgICAgdG9fYWRkID0gRmFsc2UKCiAgICAgICAgIyBXcml0ZSB0aGUgZHVtbXkgY2EgY2VydCBpZiB3ZSBhcmUgcnVubmluZyBvbiBNYWMgT1MgWAogICAgICAgIGlmIHN5c3RlbSA9PSB1J0Rhcndpbic6CiAgICAgICAgICAgIG9zLndyaXRlKHRtcF9mZCwgYl9EVU1NWV9DQV9DRVJUKQogICAgICAgICAgICAjIERlZmF1bHQgSG9tZWJyZXcgcGF0aCBmb3IgT3BlblNTTCBjZXJ0cwogICAgICAgICAgICBwYXRoc19jaGVja2VkLmFwcGVuZCgnL3Vzci9sb2NhbC9ldGMvb3BlbnNzbCcpCgogICAgICAgICMgZm9yIGFsbCBvZiB0aGUgcGF0aHMsIGZpbmQgYW55ICAuY3J0IG9yIC5wZW0gZmlsZXMKICAgICAgICAjIGFuZCBjb21waWxlIHRoZW0gaW50byBzaW5nbGUgdGVtcCBmaWxlIGZvciB1c2UKICAgICAgICAjIGluIHRoZSBzc2wgY2hlY2sgdG8gc3BlZWQgdXAgdGhlIHRlc3QKICAgICAgICBmb3IgcGF0aCBpbiBwYXRoc19jaGVja2VkOgogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhwYXRoKSBhbmQgb3MucGF0aC5pc2RpcihwYXRoKToKICAgICAgICAgICAgICAgIGRpcl9jb250ZW50cyA9IG9zLmxpc3RkaXIocGF0aCkKICAgICAgICAgICAgICAgIGZvciBmIGluIGRpcl9jb250ZW50czoKICAgICAgICAgICAgICAgICAgICBmdWxsX3BhdGggPSBvcy5wYXRoLmpvaW4ocGF0aCwgZikKICAgICAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShmdWxsX3BhdGgpIGFuZCBvcy5wYXRoLnNwbGl0ZXh0KGYpWzFdIGluICgnLmNydCcsJy5wZW0nKToKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydF9maWxlID0gb3BlbihmdWxsX3BhdGgsICdyYicpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZXJ0ID0gY2VydF9maWxlLnJlYWQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydF9maWxlLmNsb3NlKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLndyaXRlKHRtcF9mZCwgY2VydCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLndyaXRlKHRtcF9mZCwgYignXG4nKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGZ1bGxfcGF0aCBub3QgaW4gTE9BREVEX1ZFUklGWV9MT0NBVElPTlM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9fYWRkID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLndyaXRlKHRvX2FkZF9mZCwgY2VydCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy53cml0ZSh0b19hZGRfZmQsIGIoJ1xuJykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTE9BREVEX1ZFUklGWV9MT0NBVElPTlMuYWRkKGZ1bGxfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgaWYgbm90IHRvX2FkZDoKICAgICAgICAgICAgdG9fYWRkX3BhdGggPSBOb25lCiAgICAgICAgcmV0dXJuICh0bXBfcGF0aCwgdG9fYWRkX3BhdGgsIHBhdGhzX2NoZWNrZWQpCgogICAgZGVmIHZhbGlkYXRlX3Byb3h5X3Jlc3BvbnNlKHNlbGYsIHJlc3BvbnNlLCB2YWxpZF9jb2Rlcz1bMjAwXSk6CiAgICAgICAgJycnCiAgICAgICAgbWFrZSBzdXJlIHdlIGdldCBiYWNrIGEgdmFsaWQgY29kZSBmcm9tIHRoZSBwcm94eQogICAgICAgICcnJwogICAgICAgIHRyeToKICAgICAgICAgICAgKGh0dHBfdmVyc2lvbiwgcmVzcF9jb2RlLCBtc2cpID0gcmUubWF0Y2gocicoSFRUUC9cZFwuXGQpIChcZFxkXGQpICguKiknLCByZXNwb25zZSkuZ3JvdXBzKCkKICAgICAgICAgICAgaWYgaW50KHJlc3BfY29kZSkgbm90IGluIHZhbGlkX2NvZGVzOgogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByYWlzZSBQcm94eUVycm9yKCdDb25uZWN0aW9uIHRvIHByb3h5IGZhaWxlZCcpCgogICAgZGVmIGRldGVjdF9ub19wcm94eShzZWxmLCB1cmwpOgogICAgICAgICcnJwogICAgICAgIERldGVjdCBpZiB0aGUgJ25vX3Byb3h5JyBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBzZXQgYW5kIGhvbm9yIHRob3NlIGxvY2F0aW9ucy4KICAgICAgICAnJycKICAgICAgICBlbnZfbm9fcHJveHkgPSBvcy5lbnZpcm9uLmdldCgnbm9fcHJveHknKQogICAgICAgIGlmIGVudl9ub19wcm94eToKICAgICAgICAgICAgZW52X25vX3Byb3h5ID0gZW52X25vX3Byb3h5LnNwbGl0KCcsJykKICAgICAgICAgICAgbmV0bG9jID0gdXJscGFyc2UodXJsKS5uZXRsb2MKCiAgICAgICAgICAgIGZvciBob3N0IGluIGVudl9ub19wcm94eToKICAgICAgICAgICAgICAgIGlmIG5ldGxvYy5lbmRzd2l0aChob3N0KSBvciBuZXRsb2Muc3BsaXQoJzonKVswXS5lbmRzd2l0aChob3N0KToKICAgICAgICAgICAgICAgICAgICAjIE91ciByZXF1ZXN0ZWQgVVJMIG1hdGNoZXMgc29tZXRoaW5nIGluIG5vX3Byb3h5LCBzbyBkb24ndAogICAgICAgICAgICAgICAgICAgICMgdXNlIHRoZSBwcm94eSBmb3IgdGhpcwogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIF9tYWtlX2NvbnRleHQoc2VsZiwgdG9fYWRkX2NhX2NlcnRfcGF0aCk6CiAgICAgICAgaWYgSEFTX1VSTExJQjNfUFlPUEVOU1NMQ09OVEVYVDoKICAgICAgICAgICAgY29udGV4dCA9IFB5T3BlblNTTENvbnRleHQoUFJPVE9DT0wpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY29udGV4dCA9IGNyZWF0ZV9kZWZhdWx0X2NvbnRleHQoKQogICAgICAgIGlmIHRvX2FkZF9jYV9jZXJ0X3BhdGg6CiAgICAgICAgICAgIGNvbnRleHQubG9hZF92ZXJpZnlfbG9jYXRpb25zKHRvX2FkZF9jYV9jZXJ0X3BhdGgpCiAgICAgICAgcmV0dXJuIGNvbnRleHQKCiAgICBkZWYgaHR0cF9yZXF1ZXN0KHNlbGYsIHJlcSk6CiAgICAgICAgdG1wX2NhX2NlcnRfcGF0aCwgdG9fYWRkX2NhX2NlcnRfcGF0aCwgcGF0aHNfY2hlY2tlZCA9IHNlbGYuZ2V0X2NhX2NlcnRzKCkKICAgICAgICBodHRwc19wcm94eSA9IG9zLmVudmlyb24uZ2V0KCdodHRwc19wcm94eScpCiAgICAgICAgY29udGV4dCA9IE5vbmUKICAgICAgICBpZiBIQVNfU1NMQ09OVEVYVCBvciBIQVNfVVJMTElCM19QWU9QRU5TU0xDT05URVhUOgogICAgICAgICAgICBjb250ZXh0ID0gc2VsZi5fbWFrZV9jb250ZXh0KHRvX2FkZF9jYV9jZXJ0X3BhdGgpCgogICAgICAgICMgRGV0ZWN0IGlmICdub19wcm94eScgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgc2V0IGFuZCBpZiBvdXIgVVJMIGlzIGluY2x1ZGVkCiAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kZXRlY3Rfbm9fcHJveHkocmVxLmdldF9mdWxsX3VybCgpKQoKICAgICAgICBpZiBub3QgdXNlX3Byb3h5OgogICAgICAgICAgICAjIGlnbm9yZSBwcm94eSBzZXR0aW5ncyBmb3IgdGhpcyBob3N0IHJlcXVlc3QKICAgICAgICAgICAgcmV0dXJuIHJlcQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHMgPSBzb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULCBzb2NrZXQuU09DS19TVFJFQU0pCiAgICAgICAgICAgIGlmIGh0dHBzX3Byb3h5OgogICAgICAgICAgICAgICAgcHJveHlfcGFydHMgPSBnZW5lcmljX3VybHBhcnNlKHVybHBhcnNlKGh0dHBzX3Byb3h5KSkKICAgICAgICAgICAgICAgIHBvcnQgPSBwcm94eV9wYXJ0cy5nZXQoJ3BvcnQnKSBvciA0NDMKICAgICAgICAgICAgICAgIHMuY29ubmVjdCgocHJveHlfcGFydHMuZ2V0KCdob3N0bmFtZScpLCBwb3J0KSkKICAgICAgICAgICAgICAgIGlmIHByb3h5X3BhcnRzLmdldCgnc2NoZW1lJykgPT0gJ2h0dHAnOgogICAgICAgICAgICAgICAgICAgIHMuc2VuZGFsbChzZWxmLkNPTk5FQ1RfQ09NTUFORCAlIChzZWxmLmhvc3RuYW1lLCBzZWxmLnBvcnQpKQogICAgICAgICAgICAgICAgICAgIGlmIHByb3h5X3BhcnRzLmdldCgndXNlcm5hbWUnKToKICAgICAgICAgICAgICAgICAgICAgICAgY3JlZGVudGlhbHMgPSAiJXM6JXMiICUgKHByb3h5X3BhcnRzLmdldCgndXNlcm5hbWUnLCcnKSwgcHJveHlfcGFydHMuZ2V0KCdwYXNzd29yZCcsJycpKQogICAgICAgICAgICAgICAgICAgICAgICBzLnNlbmRhbGwoYignUHJveHktQXV0aG9yaXphdGlvbjogQmFzaWMgJXNcclxuJykgJSBiYXNlNjQuYjY0ZW5jb2RlKHRvX2J5dGVzKGNyZWRlbnRpYWxzLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKSkuc3RyaXAoKSkKICAgICAgICAgICAgICAgICAgICBzLnNlbmRhbGwoYignXHJcbicpKQogICAgICAgICAgICAgICAgICAgIGNvbm5lY3RfcmVzdWx0ID0gYigiIikKICAgICAgICAgICAgICAgICAgICB3aGlsZSBjb25uZWN0X3Jlc3VsdC5maW5kKGIoIlxyXG5cclxuIikpIDw9IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3RfcmVzdWx0ICs9IHMucmVjdig0MDk2KQogICAgICAgICAgICAgICAgICAgICAgICAjIDEyOCBraWxvYnl0ZXMgb2YgaGVhZGVycyBzaG91bGQgYmUgZW5vdWdoIGZvciBldmVyeW9uZS4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKGNvbm5lY3RfcmVzdWx0KSA+IDEzMTA3MjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIFByb3h5RXJyb3IoJ1Byb3h5IHNlbnQgdG9vIHZlcmJvc2UgaGVhZGVycy4gT25seSAxMjhLaUIgYWxsb3dlZC4nKQogICAgICAgICAgICAgICAgICAgIHNlbGYudmFsaWRhdGVfcHJveHlfcmVzcG9uc2UoY29ubmVjdF9yZXN1bHQpCiAgICAgICAgICAgICAgICAgICAgaWYgY29udGV4dDoKICAgICAgICAgICAgICAgICAgICAgICAgc3NsX3MgPSBjb250ZXh0LndyYXBfc29ja2V0KHMsIHNlcnZlcl9ob3N0bmFtZT1zZWxmLmhvc3RuYW1lKQogICAgICAgICAgICAgICAgICAgIGVsaWYgSEFTX1VSTExJQjNfU1NMX1dSQVBfU09DS0VUOgogICAgICAgICAgICAgICAgICAgICAgICBzc2xfcyA9IHNzbF93cmFwX3NvY2tldChzLCBjYV9jZXJ0cz10bXBfY2FfY2VydF9wYXRoLCBjZXJ0X3JlcXM9c3NsLkNFUlRfUkVRVUlSRUQsIHNzbF92ZXJzaW9uPVBST1RPQ09MLCBzZXJ2ZXJfaG9zdG5hbWU9c2VsZi5ob3N0bmFtZSkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzc2xfcyA9IHNzbC53cmFwX3NvY2tldChzLCBjYV9jZXJ0cz10bXBfY2FfY2VydF9wYXRoLCBjZXJ0X3JlcXM9c3NsLkNFUlRfUkVRVUlSRUQsIHNzbF92ZXJzaW9uPVBST1RPQ09MKQogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaF9ob3N0bmFtZShzc2xfcy5nZXRwZWVyY2VydCgpLCBzZWxmLmhvc3RuYW1lKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByYWlzZSBQcm94eUVycm9yKCdVbnN1cHBvcnRlZCBwcm94eSBzY2hlbWU6ICVzLiBDdXJyZW50bHkgYW5zaWJsZSBvbmx5IHN1cHBvcnRzIEhUVFAgcHJveGllcy4nICUgcHJveHlfcGFydHMuZ2V0KCdzY2hlbWUnKSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHMuY29ubmVjdCgoc2VsZi5ob3N0bmFtZSwgc2VsZi5wb3J0KSkKICAgICAgICAgICAgICAgIGlmIGNvbnRleHQ6CiAgICAgICAgICAgICAgICAgICAgc3NsX3MgPSBjb250ZXh0LndyYXBfc29ja2V0KHMsIHNlcnZlcl9ob3N0bmFtZT1zZWxmLmhvc3RuYW1lKQogICAgICAgICAgICAgICAgZWxpZiBIQVNfVVJMTElCM19TU0xfV1JBUF9TT0NLRVQ6CiAgICAgICAgICAgICAgICAgICAgc3NsX3MgPSBzc2xfd3JhcF9zb2NrZXQocywgY2FfY2VydHM9dG1wX2NhX2NlcnRfcGF0aCwgY2VydF9yZXFzPXNzbC5DRVJUX1JFUVVJUkVELCBzc2xfdmVyc2lvbj1QUk9UT0NPTCwgc2VydmVyX2hvc3RuYW1lPXNlbGYuaG9zdG5hbWUpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNzbF9zID0gc3NsLndyYXBfc29ja2V0KHMsIGNhX2NlcnRzPXRtcF9jYV9jZXJ0X3BhdGgsIGNlcnRfcmVxcz1zc2wuQ0VSVF9SRVFVSVJFRCwgc3NsX3ZlcnNpb249UFJPVE9DT0wpCiAgICAgICAgICAgICAgICAgICAgbWF0Y2hfaG9zdG5hbWUoc3NsX3MuZ2V0cGVlcmNlcnQoKSwgc2VsZi5ob3N0bmFtZSkKICAgICAgICAgICAgIyBjbG9zZSB0aGUgc3NsIGNvbm5lY3Rpb24KICAgICAgICAgICAgI3NzbF9zLnVud3JhcCgpCiAgICAgICAgICAgIHMuY2xvc2UoKQogICAgICAgIGV4Y2VwdCAoc3NsLlNTTEVycm9yLCBDZXJ0aWZpY2F0ZUVycm9yKToKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBidWlsZF9zc2xfdmFsaWRhdGlvbl9lcnJvcihzZWxmLmhvc3RuYW1lLCBzZWxmLnBvcnQsIHBhdGhzX2NoZWNrZWQsIGUpCiAgICAgICAgZXhjZXB0IHNvY2tldC5lcnJvcjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICByYWlzZSBDb25uZWN0aW9uRXJyb3IoJ0ZhaWxlZCB0byBjb25uZWN0IHRvICVzIGF0IHBvcnQgJXM6ICVzJyAlIChzZWxmLmhvc3RuYW1lLCBzZWxmLnBvcnQsIHRvX25hdGl2ZShlKSkpCgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBjbGVhbnVwIHRoZSB0ZW1wIGZpbGUgY3JlYXRlZCwgZG9uJ3Qgd29ycnkKICAgICAgICAgICAgIyBpZiBpdCBmYWlscyBmb3Igc29tZSByZWFzb24KICAgICAgICAgICAgb3MucmVtb3ZlKHRtcF9jYV9jZXJ0X3BhdGgpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBjbGVhbnVwIHRoZSB0ZW1wIGZpbGUgY3JlYXRlZCwgZG9uJ3Qgd29ycnkKICAgICAgICAgICAgIyBpZiBpdCBmYWlscyBmb3Igc29tZSByZWFzb24KICAgICAgICAgICAgaWYgdG9fYWRkX2NhX2NlcnRfcGF0aDoKICAgICAgICAgICAgICAgIG9zLnJlbW92ZSh0b19hZGRfY2FfY2VydF9wYXRoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKICAgICAgICByZXR1cm4gcmVxCgogICAgaHR0cHNfcmVxdWVzdCA9IGh0dHBfcmVxdWVzdAoKCmRlZiBtYXliZV9hZGRfc3NsX2hhbmRsZXIodXJsLCB2YWxpZGF0ZV9jZXJ0cyk6CiAgICAjIEZJWE1FOiBjaGFuZ2UgdGhlIGZvbGxvd2luZyB0byB1c2UgdGhlIGdlbmVyaWNfdXJscGFyc2UgZnVuY3Rpb24KICAgICMgICAgICAgIHRvIHJlbW92ZSB0aGUgaW5kZXhlZCByZWZlcmVuY2VzIGZvciAncGFyc2VkJwogICAgcGFyc2VkID0gdXJscGFyc2UodXJsKQogICAgaWYgcGFyc2VkWzBdID09ICdodHRwcycgYW5kIHZhbGlkYXRlX2NlcnRzOgogICAgICAgIGlmIG5vdCBIQVNfU1NMOgogICAgICAgICAgICByYWlzZSBOb1NTTEVycm9yKCdTU0wgdmFsaWRhdGlvbiBpcyBub3QgYXZhaWxhYmxlIGluIHlvdXIgdmVyc2lvbiBvZiBweXRob24uIFlvdSBjYW4gdXNlIHZhbGlkYXRlX2NlcnRzPUZhbHNlLCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIGhvd2V2ZXIgdGhpcyBpcyB1bnNhZmUgYW5kIG5vdCByZWNvbW1lbmRlZCcpCgogICAgICAgICMgZG8gdGhlIGNlcnQgdmFsaWRhdGlvbgogICAgICAgIG5ldGxvYyA9IHBhcnNlZFsxXQogICAgICAgIGlmICdAJyBpbiBuZXRsb2M6CiAgICAgICAgICAgIG5ldGxvYyA9IG5ldGxvYy5zcGxpdCgnQCcsIDEpWzFdCiAgICAgICAgaWYgJzonIGluIG5ldGxvYzoKICAgICAgICAgICAgaG9zdG5hbWUsIHBvcnQgPSBuZXRsb2Muc3BsaXQoJzonLCAxKQogICAgICAgICAgICBwb3J0ID0gaW50KHBvcnQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaG9zdG5hbWUgPSBuZXRsb2MKICAgICAgICAgICAgcG9ydCA9IDQ0MwogICAgICAgICMgY3JlYXRlIHRoZSBTU0wgdmFsaWRhdGlvbiBoYW5kbGVyIGFuZAogICAgICAgICMgYWRkIGl0IHRvIHRoZSBsaXN0IG9mIGhhbmRsZXJzCiAgICAgICAgcmV0dXJuIFNTTFZhbGlkYXRpb25IYW5kbGVyKGhvc3RuYW1lLCBwb3J0KQoKCmRlZiBvcGVuX3VybCh1cmwsIGRhdGE9Tm9uZSwgaGVhZGVycz1Ob25lLCBtZXRob2Q9Tm9uZSwgdXNlX3Byb3h5PVRydWUsCiAgICAgICAgICAgICBmb3JjZT1GYWxzZSwgbGFzdF9tb2RfdGltZT1Ob25lLCB0aW1lb3V0PTEwLCB2YWxpZGF0ZV9jZXJ0cz1UcnVlLAogICAgICAgICAgICAgdXJsX3VzZXJuYW1lPU5vbmUsIHVybF9wYXNzd29yZD1Ob25lLCBodHRwX2FnZW50PU5vbmUsCiAgICAgICAgICAgICBmb3JjZV9iYXNpY19hdXRoPUZhbHNlLCBmb2xsb3dfcmVkaXJlY3RzPSd1cmxsaWIyJywKICAgICAgICAgICAgIGNsaWVudF9jZXJ0PU5vbmUsIGNsaWVudF9rZXk9Tm9uZSk6CiAgICAnJycKICAgIFNlbmRzIGEgcmVxdWVzdCB2aWEgSFRUUChTKSBvciBGVFAgdXNpbmcgdXJsbGliMiAoUHl0aG9uMikgb3IgdXJsbGliIChQeXRob24zKQoKICAgIERvZXMgbm90IHJlcXVpcmUgdGhlIG1vZHVsZSBlbnZpcm9ubWVudAogICAgJycnCiAgICBoYW5kbGVycyA9IFtdCiAgICBzc2xfaGFuZGxlciA9IG1heWJlX2FkZF9zc2xfaGFuZGxlcih1cmwsIHZhbGlkYXRlX2NlcnRzKQogICAgaWYgc3NsX2hhbmRsZXI6CiAgICAgICAgaGFuZGxlcnMuYXBwZW5kKHNzbF9oYW5kbGVyKQoKICAgICMgRklYTUU6IGNoYW5nZSB0aGUgZm9sbG93aW5nIHRvIHVzZSB0aGUgZ2VuZXJpY191cmxwYXJzZSBmdW5jdGlvbgogICAgIyAgICAgICAgdG8gcmVtb3ZlIHRoZSBpbmRleGVkIHJlZmVyZW5jZXMgZm9yICdwYXJzZWQnCiAgICBwYXJzZWQgPSB1cmxwYXJzZSh1cmwpCiAgICBpZiBwYXJzZWRbMF0gIT0gJ2Z0cCc6CiAgICAgICAgdXNlcm5hbWUgPSB1cmxfdXNlcm5hbWUKCiAgICAgICAgaWYgaGVhZGVycyBpcyBOb25lOgogICAgICAgICAgICBoZWFkZXJzID0ge30KCiAgICAgICAgaWYgdXNlcm5hbWU6CiAgICAgICAgICAgIHBhc3N3b3JkID0gdXJsX3Bhc3N3b3JkCiAgICAgICAgICAgIG5ldGxvYyA9IHBhcnNlZFsxXQogICAgICAgIGVsaWYgJ0AnIGluIHBhcnNlZFsxXToKICAgICAgICAgICAgY3JlZGVudGlhbHMsIG5ldGxvYyA9IHBhcnNlZFsxXS5zcGxpdCgnQCcsIDEpCiAgICAgICAgICAgIGlmICc6JyBpbiBjcmVkZW50aWFsczoKICAgICAgICAgICAgICAgIHVzZXJuYW1lLCBwYXNzd29yZCA9IGNyZWRlbnRpYWxzLnNwbGl0KCc6JywgMSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gY3JlZGVudGlhbHMKICAgICAgICAgICAgICAgIHBhc3N3b3JkID0gJycKCiAgICAgICAgICAgIHBhcnNlZCA9IGxpc3QocGFyc2VkKQogICAgICAgICAgICBwYXJzZWRbMV0gPSBuZXRsb2MKCiAgICAgICAgICAgICMgcmVjb25zdHJ1Y3QgdXJsIHdpdGhvdXQgY3JlZGVudGlhbHMKICAgICAgICAgICAgdXJsID0gdXJsdW5wYXJzZShwYXJzZWQpCgogICAgICAgIGlmIHVzZXJuYW1lIGFuZCBub3QgZm9yY2VfYmFzaWNfYXV0aDoKICAgICAgICAgICAgcGFzc21hbiA9IHVybGxpYl9yZXF1ZXN0LkhUVFBQYXNzd29yZE1ncldpdGhEZWZhdWx0UmVhbG0oKQoKICAgICAgICAgICAgIyB0aGlzIGNyZWF0ZXMgYSBwYXNzd29yZCBtYW5hZ2VyCiAgICAgICAgICAgIHBhc3NtYW4uYWRkX3Bhc3N3b3JkKE5vbmUsIG5ldGxvYywgdXNlcm5hbWUsIHBhc3N3b3JkKQoKICAgICAgICAgICAgIyBiZWNhdXNlIHdlIGhhdmUgcHV0IE5vbmUgYXQgdGhlIHN0YXJ0IGl0IHdpbGwgYWx3YXlzCiAgICAgICAgICAgICMgdXNlIHRoaXMgdXNlcm5hbWUvcGFzc3dvcmQgY29tYmluYXRpb24gZm9yICB1cmxzCiAgICAgICAgICAgICMgZm9yIHdoaWNoIGB0aGV1cmxgIGlzIGEgc3VwZXItdXJsCiAgICAgICAgICAgIGF1dGhoYW5kbGVyID0gdXJsbGliX3JlcXVlc3QuSFRUUEJhc2ljQXV0aEhhbmRsZXIocGFzc21hbikKICAgICAgICAgICAgZGlnZXN0X2F1dGhoYW5kbGVyID0gdXJsbGliX3JlcXVlc3QuSFRUUERpZ2VzdEF1dGhIYW5kbGVyKHBhc3NtYW4pCgogICAgICAgICAgICAjIGNyZWF0ZSB0aGUgQXV0aEhhbmRsZXIKICAgICAgICAgICAgaGFuZGxlcnMuYXBwZW5kKGF1dGhoYW5kbGVyKQogICAgICAgICAgICBoYW5kbGVycy5hcHBlbmQoZGlnZXN0X2F1dGhoYW5kbGVyKQoKICAgICAgICBlbGlmIHVzZXJuYW1lIGFuZCBmb3JjZV9iYXNpY19hdXRoOgogICAgICAgICAgICBoZWFkZXJzWyJBdXRob3JpemF0aW9uIl0gPSBiYXNpY19hdXRoX2hlYWRlcih1c2VybmFtZSwgcGFzc3dvcmQpCgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJjID0gbmV0cmMubmV0cmMob3MuZW52aXJvbi5nZXQoJ05FVFJDJykpCiAgICAgICAgICAgICAgICBsb2dpbiA9IHJjLmF1dGhlbnRpY2F0b3JzKHBhcnNlZFsxXSkKICAgICAgICAgICAgZXhjZXB0IElPRXJyb3I6CiAgICAgICAgICAgICAgICBsb2dpbiA9IE5vbmUKCiAgICAgICAgICAgIGlmIGxvZ2luOgogICAgICAgICAgICAgICAgdXNlcm5hbWUsIF8sIHBhc3N3b3JkID0gbG9naW4KICAgICAgICAgICAgICAgIGlmIHVzZXJuYW1lIGFuZCBwYXNzd29yZDoKICAgICAgICAgICAgICAgICAgICBoZWFkZXJzWyJBdXRob3JpemF0aW9uIl0gPSBiYXNpY19hdXRoX2hlYWRlcih1c2VybmFtZSwgcGFzc3dvcmQpCgogICAgaWYgbm90IHVzZV9wcm94eToKICAgICAgICBwcm94eWhhbmRsZXIgPSB1cmxsaWJfcmVxdWVzdC5Qcm94eUhhbmRsZXIoe30pCiAgICAgICAgaGFuZGxlcnMuYXBwZW5kKHByb3h5aGFuZGxlcikKCiAgICBpZiBIQVNfU1NMQ09OVEVYVCBhbmQgbm90IHZhbGlkYXRlX2NlcnRzOgogICAgICAgICMgSW4gMi43LjksIHRoZSBkZWZhdWx0IGNvbnRleHQgdmFsaWRhdGVzIGNlcnRpZmljYXRlcwogICAgICAgIGNvbnRleHQgPSBTU0xDb250ZXh0KHNzbC5QUk9UT0NPTF9TU0x2MjMpCiAgICAgICAgY29udGV4dC5vcHRpb25zIHw9IHNzbC5PUF9OT19TU0x2MgogICAgICAgIGNvbnRleHQub3B0aW9ucyB8PSBzc2wuT1BfTk9fU1NMdjMKICAgICAgICBjb250ZXh0LnZlcmlmeV9tb2RlID0gc3NsLkNFUlRfTk9ORQogICAgICAgIGNvbnRleHQuY2hlY2tfaG9zdG5hbWUgPSBGYWxzZQogICAgICAgIGhhbmRsZXJzLmFwcGVuZChIVFRQU0NsaWVudEF1dGhIYW5kbGVyKGNsaWVudF9jZXJ0PWNsaWVudF9jZXJ0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsaWVudF9rZXk9Y2xpZW50X2tleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0PWNvbnRleHQpKQogICAgZWxpZiBjbGllbnRfY2VydDoKICAgICAgICBoYW5kbGVycy5hcHBlbmQoSFRUUFNDbGllbnRBdXRoSGFuZGxlcihjbGllbnRfY2VydD1jbGllbnRfY2VydCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGllbnRfa2V5PWNsaWVudF9rZXkpKQoKICAgICMgcHJlLTIuNiB2ZXJzaW9ucyBvZiBweXRob24gY2Fubm90IHVzZSB0aGUgY3VzdG9tIGh0dHBzCiAgICAjIGhhbmRsZXIsIHNpbmNlIHRoZSBzb2NrZXQgY2xhc3MgaXMgbGFja2luZyBjcmVhdGVfY29ubmVjdGlvbi4KICAgICMgU29tZSBweXRob24gYnVpbGRzIGxhY2sgSFRUUFMgc3VwcG9ydC4KICAgIGlmIGhhc2F0dHIoc29ja2V0LCAnY3JlYXRlX2Nvbm5lY3Rpb24nKSBhbmQgQ3VzdG9tSFRUUFNIYW5kbGVyOgogICAgICAgIGhhbmRsZXJzLmFwcGVuZChDdXN0b21IVFRQU0hhbmRsZXIpCgogICAgaGFuZGxlcnMuYXBwZW5kKFJlZGlyZWN0SGFuZGxlckZhY3RvcnkoZm9sbG93X3JlZGlyZWN0cywgdmFsaWRhdGVfY2VydHMpKQoKICAgIG9wZW5lciA9IHVybGxpYl9yZXF1ZXN0LmJ1aWxkX29wZW5lcigqaGFuZGxlcnMpCiAgICB1cmxsaWJfcmVxdWVzdC5pbnN0YWxsX29wZW5lcihvcGVuZXIpCgogICAgZGF0YSA9IHRvX2J5dGVzKGRhdGEsIG5vbnN0cmluZz0ncGFzc3RocnUnKQogICAgaWYgbWV0aG9kOgogICAgICAgIGlmIG1ldGhvZC51cHBlcigpIG5vdCBpbiAoJ09QVElPTlMnLCdHRVQnLCdIRUFEJywnUE9TVCcsJ1BVVCcsJ0RFTEVURScsJ1RSQUNFJywnQ09OTkVDVCcsJ1BBVENIJyk6CiAgICAgICAgICAgIHJhaXNlIENvbm5lY3Rpb25FcnJvcignaW52YWxpZCBIVFRQIHJlcXVlc3QgbWV0aG9kOyAlcycgJSBtZXRob2QudXBwZXIoKSkKICAgICAgICByZXF1ZXN0ID0gUmVxdWVzdFdpdGhNZXRob2QodXJsLCBtZXRob2QudXBwZXIoKSwgZGF0YSkKICAgIGVsc2U6CiAgICAgICAgcmVxdWVzdCA9IHVybGxpYl9yZXF1ZXN0LlJlcXVlc3QodXJsLCBkYXRhKQoKICAgICMgYWRkIHRoZSBjdXN0b20gYWdlbnQgaGVhZGVyLCB0byBoZWxwIHByZXZlbnQgaXNzdWVzCiAgICAjIHdpdGggc2l0ZXMgdGhhdCBibG9jayB0aGUgZGVmYXVsdCB1cmxsaWIgYWdlbnQgc3RyaW5nCiAgICBpZiBodHRwX2FnZW50OgogICAgICAgIHJlcXVlc3QuYWRkX2hlYWRlcignVXNlci1hZ2VudCcsIGh0dHBfYWdlbnQpCgogICAgIyBDYWNoZSBjb250cm9sCiAgICAjIEVpdGhlciB3ZSBkaXJlY3RseSBmb3JjZSBhIGNhY2hlIHJlZnJlc2gKICAgIGlmIGZvcmNlOgogICAgICAgIHJlcXVlc3QuYWRkX2hlYWRlcignY2FjaGUtY29udHJvbCcsICduby1jYWNoZScpCiAgICAjIG9yIHdlIGRvIGl0IGlmIHRoZSBvcmlnaW5hbCBpcyBtb3JlIHJlY2VudCB0aGFuIG91ciBjb3B5CiAgICBlbGlmIGxhc3RfbW9kX3RpbWU6CiAgICAgICAgdHN0YW1wID0gbGFzdF9tb2RfdGltZS5zdHJmdGltZSgnJWEsICVkICViICVZICVIOiVNOiVTICswMDAwJykKICAgICAgICByZXF1ZXN0LmFkZF9oZWFkZXIoJ0lmLU1vZGlmaWVkLVNpbmNlJywgdHN0YW1wKQoKICAgICMgdXNlciBkZWZpbmVkIGhlYWRlcnMgbm93LCB3aGljaCBtYXkgb3ZlcnJpZGUgdGhpbmdzIHdlJ3ZlIHNldCBhYm92ZQogICAgaWYgaGVhZGVyczoKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShoZWFkZXJzLCBkaWN0KToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaGVhZGVycyBwcm92aWRlZCB0byBmZXRjaF91cmwoKSBtdXN0IGJlIGEgZGljdCIpCiAgICAgICAgZm9yIGhlYWRlciBpbiBoZWFkZXJzOgogICAgICAgICAgICByZXF1ZXN0LmFkZF9oZWFkZXIoaGVhZGVyLCBoZWFkZXJzW2hlYWRlcl0pCgogICAgdXJsb3Blbl9hcmdzID0gW3JlcXVlc3QsIE5vbmVdCiAgICBpZiBzeXMudmVyc2lvbl9pbmZvID49ICgyLDYsMCk6CiAgICAgICAgIyB1cmxvcGVuIGluIHB5dGhvbiBwcmlvciB0byAyLjYuMCBkaWQgbm90CiAgICAgICAgIyBoYXZlIGEgdGltZW91dCBwYXJhbWV0ZXIKICAgICAgICB1cmxvcGVuX2FyZ3MuYXBwZW5kKHRpbWVvdXQpCgogICAgciA9IHVybGxpYl9yZXF1ZXN0LnVybG9wZW4oKnVybG9wZW5fYXJncykKICAgIHJldHVybiByCgojCiMgTW9kdWxlLXJlbGF0ZWQgZnVuY3Rpb25zCiMKCgpkZWYgYmFzaWNfYXV0aF9oZWFkZXIodXNlcm5hbWUsIHBhc3N3b3JkKToKICAgICIiIlRha2VzIGEgdXNlcm5hbWUgYW5kIHBhc3N3b3JkIGFuZCByZXR1cm5zIGEgYnl0ZSBzdHJpbmcgc3VpdGFibGUgZm9yCiAgICB1c2luZyBhcyB2YWx1ZSBvZiBhbiBBdXRob3JpemF0aW9uIGhlYWRlciB0byBkbyBiYXNpYyBhdXRoLgogICAgIiIiCiAgICByZXR1cm4gYigiQmFzaWMgJXMiKSAlIGJhc2U2NC5iNjRlbmNvZGUodG9fYnl0ZXMoIiVzOiVzIiAlICh1c2VybmFtZSwgcGFzc3dvcmQpLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKSkKCgpkZWYgdXJsX2FyZ3VtZW50X3NwZWMoKToKICAgICcnJwogICAgQ3JlYXRlcyBhbiBhcmd1bWVudCBzcGVjIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCBhbnkgbW9kdWxlCiAgICB0aGF0IHdpbGwgYmUgcmVxdWVzdGluZyBjb250ZW50IHZpYSB1cmxsaWIvdXJsbGliMgogICAgJycnCiAgICByZXR1cm4gZGljdCgKICAgICAgICB1cmw9ZGljdCgpLAogICAgICAgIGZvcmNlPWRpY3QoZGVmYXVsdD0nbm8nLCBhbGlhc2VzPVsndGhpcnN0eSddLCB0eXBlPSdib29sJyksCiAgICAgICAgaHR0cF9hZ2VudD1kaWN0KGRlZmF1bHQ9J2Fuc2libGUtaHR0cGdldCcpLAogICAgICAgIHVzZV9wcm94eT1kaWN0KGRlZmF1bHQ9J3llcycsIHR5cGU9J2Jvb2wnKSwKICAgICAgICB2YWxpZGF0ZV9jZXJ0cz1kaWN0KGRlZmF1bHQ9J3llcycsIHR5cGU9J2Jvb2wnKSwKICAgICAgICB1cmxfdXNlcm5hbWU9ZGljdChyZXF1aXJlZD1GYWxzZSksCiAgICAgICAgdXJsX3Bhc3N3b3JkPWRpY3QocmVxdWlyZWQ9RmFsc2UsIG5vX2xvZz1UcnVlKSwKICAgICAgICBmb3JjZV9iYXNpY19hdXRoPWRpY3QocmVxdWlyZWQ9RmFsc2UsIHR5cGU9J2Jvb2wnLCBkZWZhdWx0PSdubycpLAogICAgICAgIGNsaWVudF9jZXJ0PWRpY3QocmVxdWlyZWQ9RmFsc2UsIHR5cGU9J3BhdGgnLCBkZWZhdWx0PU5vbmUpLAogICAgICAgIGNsaWVudF9rZXk9ZGljdChyZXF1aXJlZD1GYWxzZSwgdHlwZT0ncGF0aCcsIGRlZmF1bHQ9Tm9uZSksCiAgICApCgoKZGVmIGZldGNoX3VybChtb2R1bGUsIHVybCwgZGF0YT1Ob25lLCBoZWFkZXJzPU5vbmUsIG1ldGhvZD1Ob25lLAogICAgICAgICAgICAgIHVzZV9wcm94eT1UcnVlLCBmb3JjZT1GYWxzZSwgbGFzdF9tb2RfdGltZT1Ob25lLCB0aW1lb3V0PTEwKToKICAgICIiIlNlbmRzIGEgcmVxdWVzdCB2aWEgSFRUUChTKSBvciBGVFAgKG5lZWRzIHRoZSBtb2R1bGUgYXMgcGFyYW1ldGVyKQoKICAgIDphcmcgbW9kdWxlOiBUaGUgQW5zaWJsZU1vZHVsZSAodXNlZCB0byBnZXQgdXNlcm5hbWUsIHBhc3N3b3JkIGV0Yy4gKHMuYi4pLgogICAgOmFyZyB1cmw6ICAgICAgICAgICAgIFRoZSB1cmwgdG8gdXNlLgoKICAgIDprd2FyZyBkYXRhOiAgICAgICAgICBUaGUgZGF0YSB0byBiZSBzZW50IChpbiBjYXNlIG9mIFBPU1QvUFVUKS4KICAgIDprd2FyZyBoZWFkZXJzOiAgICAgICBBIGRpY3Qgd2l0aCB0aGUgcmVxdWVzdCBoZWFkZXJzLgogICAgOmt3YXJnIG1ldGhvZDogICAgICAgICJQT1NUIiwgIlBVVCIsIGV0Yy4KICAgIDprd2FyZyBib29sZWFuIHVzZV9wcm94eTogICAgIERlZmF1bHQ6IFRydWUKICAgIDprd2FyZyBib29sZWFuIGZvcmNlOiBJZiBUcnVlOiBEbyBub3QgZ2V0IGEgY2FjaGVkIGNvcHkgKERlZmF1bHQ6IEZhbHNlKQogICAgOmt3YXJnIGxhc3RfbW9kX3RpbWU6IERlZmF1bHQ6IE5vbmUKICAgIDprd2FyZyBpbnQgdGltZW91dDogICBEZWZhdWx0OiAxMAoKICAgIDpyZXR1cm5zOiBBIHR1cGxlIG9mICgqKnJlc3BvbnNlKiosICoqaW5mbyoqKS4gVXNlIGBgcmVzcG9uc2UuYm9keSgpYGAgdG8gcmVhZCB0aGUgZGF0YS4KICAgICAgICBUaGUgKippbmZvKiogY29udGFpbnMgdGhlICdzdGF0dXMnIGFuZCBvdGhlciBtZXRhIGRhdGEuIFdoZW4gYSBIdHRwRXJyb3IgKHN0YXR1cyA+IDQwMCkKICAgICAgICBvY2N1cnJlZCB0aGVuIGBgaW5mb1snYm9keSddYGAgY29udGFpbnMgdGhlIGVycm9yIHJlc3BvbnNlIGRhdGE6OgoKICAgIEV4YW1wbGU6OgoKICAgICAgICBkYXRhPXsuLi59CiAgICAgICAgcmVzcCwgaW5mbyA9IGZldGNoX3VybChtb2R1bGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaHR0cDovL2V4YW1wbGUuY29tIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE9bW9kdWxlLmpzb25pZnkoZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcj17Q29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZD0iUE9TVCIpCiAgICAgICAgc3RhdHVzX2NvZGUgPSBpbmZvWyJzdGF0dXMiXQogICAgICAgIGJvZHkgPSByZXNwLnJlYWQoKQogICAgICAgIGlmIHN0YXR1c19jb2RlID49IDQwMCA6CiAgICAgICAgICAgIGJvZHkgPSBpbmZvWydib2R5J10KICAgICIiIgoKICAgIGlmIG5vdCBIQVNfVVJMUEFSU0U6CiAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9J3VybHBhcnNlIGlzIG5vdCBpbnN0YWxsZWQnKQoKICAgICMgR2V0IHZhbGlkYXRlX2NlcnRzIGZyb20gdGhlIG1vZHVsZSBwYXJhbXMKICAgIHZhbGlkYXRlX2NlcnRzID0gbW9kdWxlLnBhcmFtcy5nZXQoJ3ZhbGlkYXRlX2NlcnRzJywgVHJ1ZSkKCiAgICB1c2VybmFtZSA9IG1vZHVsZS5wYXJhbXMuZ2V0KCd1cmxfdXNlcm5hbWUnLCAnJykKICAgIHBhc3N3b3JkID0gbW9kdWxlLnBhcmFtcy5nZXQoJ3VybF9wYXNzd29yZCcsICcnKQogICAgaHR0cF9hZ2VudCA9IG1vZHVsZS5wYXJhbXMuZ2V0KCdodHRwX2FnZW50JywgTm9uZSkKICAgIGZvcmNlX2Jhc2ljX2F1dGggPSBtb2R1bGUucGFyYW1zLmdldCgnZm9yY2VfYmFzaWNfYXV0aCcsICcnKQoKICAgIGZvbGxvd19yZWRpcmVjdHMgPSBtb2R1bGUucGFyYW1zLmdldCgnZm9sbG93X3JlZGlyZWN0cycsICd1cmxsaWIyJykKCiAgICBjbGllbnRfY2VydCA9IG1vZHVsZS5wYXJhbXMuZ2V0KCdjbGllbnRfY2VydCcpCiAgICBjbGllbnRfa2V5ID0gbW9kdWxlLnBhcmFtcy5nZXQoJ2NsaWVudF9rZXknKQoKICAgIHIgPSBOb25lCiAgICBpbmZvID0gZGljdCh1cmw9dXJsKQogICAgdHJ5OgogICAgICAgIHIgPSBvcGVuX3VybCh1cmwsIGRhdGE9ZGF0YSwgaGVhZGVycz1oZWFkZXJzLCBtZXRob2Q9bWV0aG9kLAogICAgICAgICAgICAgICAgICAgICB1c2VfcHJveHk9dXNlX3Byb3h5LCBmb3JjZT1mb3JjZSwgbGFzdF9tb2RfdGltZT1sYXN0X21vZF90aW1lLCB0aW1lb3V0PXRpbWVvdXQsCiAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlX2NlcnRzPXZhbGlkYXRlX2NlcnRzLCB1cmxfdXNlcm5hbWU9dXNlcm5hbWUsCiAgICAgICAgICAgICAgICAgICAgIHVybF9wYXNzd29yZD1wYXNzd29yZCwgaHR0cF9hZ2VudD1odHRwX2FnZW50LCBmb3JjZV9iYXNpY19hdXRoPWZvcmNlX2Jhc2ljX2F1dGgsCiAgICAgICAgICAgICAgICAgICAgIGZvbGxvd19yZWRpcmVjdHM9Zm9sbG93X3JlZGlyZWN0cywgY2xpZW50X2NlcnQ9Y2xpZW50X2NlcnQsCiAgICAgICAgICAgICAgICAgICAgIGNsaWVudF9rZXk9Y2xpZW50X2tleSkKICAgICAgICBpbmZvLnVwZGF0ZShyLmluZm8oKSkKICAgICAgICBpbmZvLnVwZGF0ZShkaWN0KG1zZz0iT0sgKCVzIGJ5dGVzKSIgJSByLmhlYWRlcnMuZ2V0KCdDb250ZW50LUxlbmd0aCcsICd1bmtub3duJyksIHVybD1yLmdldHVybCgpLCBzdGF0dXM9ci5jb2RlKSkKICAgIGV4Y2VwdCBOb1NTTEVycm9yOgogICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICBkaXN0cmlidXRpb24gPSBnZXRfZGlzdHJpYnV0aW9uKCkKICAgICAgICBpZiBkaXN0cmlidXRpb24gaXMgbm90IE5vbmUgYW5kIGRpc3RyaWJ1dGlvbi5sb3dlcigpID09ICdyZWRoYXQnOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG1zZz0nJXMuIFlvdSBjYW4gYWxzbyBpbnN0YWxsIHB5dGhvbi1zc2wgZnJvbSBFUEVMJyAlIHN0cihlKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG1zZz0nJXMnICUgc3RyKGUpKQogICAgZXhjZXB0IChDb25uZWN0aW9uRXJyb3IsIFZhbHVlRXJyb3IpOgogICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG1zZz1zdHIoZSkpCiAgICBleGNlcHQgdXJsbGliX2Vycm9yLkhUVFBFcnJvcjoKICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBib2R5ID0gZS5yZWFkKCkKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgIGJvZHkgPSAnJwoKICAgICAgICAjIFRyeSB0byBhZGQgZXhjZXB0aW9uIGluZm8gdG8gdGhlIG91dHB1dCBidXQgZG9uJ3QgZmFpbCBpZiB3ZSBjYW4ndAogICAgICAgIGV4Y19pbmZvID0gZS5pbmZvKCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGluZm8udXBkYXRlKGRpY3QoKiplLmluZm8oKSkpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgogICAgICAgIGluZm8udXBkYXRlKHsnbXNnJzogc3RyKGUpLCAnYm9keSc6IGJvZHksICdzdGF0dXMnOiBlLmNvZGV9KQoKICAgIGV4Y2VwdCB1cmxsaWJfZXJyb3IuVVJMRXJyb3I6CiAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgIGNvZGUgPSBpbnQoZ2V0YXR0cihlLCAnY29kZScsIC0xKSkKICAgICAgICBpbmZvLnVwZGF0ZShkaWN0KG1zZz0iUmVxdWVzdCBmYWlsZWQ6ICVzIiAlIHN0cihlKSwgc3RhdHVzPWNvZGUpKQogICAgZXhjZXB0IHNvY2tldC5lcnJvcjoKICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgaW5mby51cGRhdGUoZGljdChtc2c9IkNvbm5lY3Rpb24gZmFpbHVyZTogJXMiICUgc3RyKGUpLCBzdGF0dXM9LTEpKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgaW5mby51cGRhdGUoZGljdChtc2c9IkFuIHVua25vd24gZXJyb3Igb2NjdXJyZWQ6ICVzIiAlIHN0cihlKSwgc3RhdHVzPS0xKSkKCiAgICByZXR1cm4gciwgaW5mbwpQSwMEFAAAAAAAzLsrSxgXcvUBEQAAAREAACQAAABhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX19pbml0X18ucHkjIFRoaXMgY29kZSBpcyBwYXJ0IG9mIEFuc2libGUsIGJ1dCBpcyBhbiBpbmRlcGVuZGVudCBjb21wb25lbnQuCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgQ29weXJpZ2h0IChjKSAyMDE3LCBUb3NoaW8gS3VyYXRvbWkgPHRrdXJhdG9taUBhbnNpYmxlLmNvbT4KIwojIFRoaXMgY29kZSBpcyBiYXNlZCBvbiBjb2RlIGZyb20gQXN0cm9weSBhbmQgcmV0YWlucyB0aGVpciAzLWNsYXVzZSBCU0QgbGljZW5zZQojIHJlcHJvZHVjZWQgYmVsb3c6CiMKIyBDb3B5cmlnaHQgKGMpIDIwMTEtMjAxNiwgQXN0cm9weSBEZXZlbG9wZXJzCiMKIyBBbGwgcmlnaHRzIHJlc2VydmVkLgojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0CiMgbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwgdGhpcwojICAgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIyAqIE5laXRoZXIgdGhlIG5hbWUgb2YgdGhlIEFzdHJvcHkgVGVhbSBub3IgdGhlIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5CiMgICBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0cyBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0CiMgICBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIKIyBBTkQgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFCiMgSU1QTElFRCBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFCiMgRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRQojIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMCiMgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IKIyBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUgojIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksCiMgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UKIyBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCiMgQXN0cm9weSBMaWNlbnNlOiBodHRwczovL2dpdGh1Yi5jb20vYXN0cm9weS9hc3Ryb3B5L2Jsb2IvY2YzMjY1ZTQyYTBkYjhlMDBiYjkwNjQ0ZGIzN2M4MTUwZjVhYzAwYy9saWNlbnNlcy9MSUNFTlNFLnJzdAojIEFzdHJvcHkgQ29kZTogaHR0cHM6Ly9naXRodWIuY29tL2FzdHJvcHkvYXN0cm9weS9ibG9iL2NmMzI2NWU0MmEwZGI4ZTAwYmI5MDY0NGRiMzdjODE1MGY1YWMwMGMvYXN0cm9weS9leHRlcm4vc2l4LnB5CgoiIiIKSGFuZGxlIGxvYWRpbmcgc2l4IHBhY2thZ2UgZnJvbSBzeXN0ZW0gb3IgZnJvbSB0aGUgYnVuZGxlZCBjb3B5CiIiIgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IGFic29sdXRlX2ltcG9ydAoKaW1wb3J0IGltcCBhcyBfaW1wCmltcG9ydCBzeXMgYXMgX3N5cwoKdHJ5OgogICAgZnJvbSBkaXN0dXRpbHMudmVyc2lvbiBpbXBvcnQgTG9vc2VWZXJzaW9uIGFzIF9Mb29zZVZlcnNpb24KZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyBTb21lIHBsYXRmb3JtcyAqY291Z2gqU29sYXJpcypjb3VnaCogZG9uJ3Qgc2hpcCB0aGUgd2hvbGUgc3RkbGliCiAgICBfTG9vc2VWZXJzaW9uID0gTm9uZQoKdHJ5OgogICAgaW1wb3J0IHNpeCBhcyBfc3lzdGVtX3NpeApleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBfc3lzdGVtX3NpeCA9IE5vbmUKCmZyb20gLiBpbXBvcnQgX3NpeCBhcyBfYnVuZGxlZF9zaXgKCgpkZWYgX2ZpbmRfbW9kdWxlKG5hbWUsIHBhdGg9Tm9uZSk6CiAgICAiIiJBbHRlcm5hdGl2ZSB0byBgaW1wLmZpbmRfbW9kdWxlYCB0aGF0IGNhbiBhbHNvIHNlYXJjaCBpbiBzdWJwYWNrYWdlcyIiIgogICAgcGFydHMgPSBuYW1lLnNwbGl0KCcuJykKCiAgICBmb3IgcGFydCBpbiBwYXJ0czoKICAgICAgICBpZiBwYXRoIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwYXRoID0gW3BhdGhdCiAgICAgICAgZmgsIHBhdGgsIGRlc2NyID0gX2ltcC5maW5kX21vZHVsZShwYXJ0LCBwYXRoKQogICAgcmV0dXJuIGZoLCBwYXRoLCBkZXNjcgoKCmRlZiBfZ2V0X2J1bmRsZWRfc2l4X3NvdXJjZSgpOgogICAgIyBTcGVjaWFsIGltcG9ydCBsb2FkZXIgKHppcGltcG9ydCBmb3IgaW5zdGFuY2UpCiAgICBmb3VuZCA9IEZhbHNlCiAgICBmb3IgcGF0aCBpbiBfc3lzLnBhdGg6CiAgICAgICAgaW1wb3J0ZXIgPSBfc3lzLnBhdGhfaW1wb3J0ZXJfY2FjaGUuZ2V0KHBhdGgpCiAgICAgICAgaWYgaW1wb3J0ZXI6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZvdW5kID0gaW1wb3J0ZXIuZmluZF9tb2R1bGUoJ2Fuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fc2l4JykKICAgICAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgZm91bmQ6CiAgICAgICAgICAgICAgICBicmVhawogICAgZWxzZToKICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigiQ291bGQgbm90IGZpbmQgYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Ll9zaXgiKQoKICAgIG1vZHVsZV9zb3VyY2UgPSBpbXBvcnRlci5nZXRfc291cmNlKCdhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeCcpCiAgICByZXR1cm4gbW9kdWxlX3NvdXJjZQoKCmRlZiBfZ2V0X3NpeF9zb3VyY2UoKToKICAgICIiIkltcG9ydCB0aGUgbmV3ZXN0IHZlcnNpb24gb2YgdGhlIHNpeCBsaWJyYXJ5IHRoYXQncyBhdmFpbGFibGUiIiIKICAgIG1vZF9pbmZvID0gTm9uZQogICAgdHJ5OgogICAgICAgIGlmIF9zeXN0ZW1fc2l4IGFuZCBfTG9vc2VWZXJzaW9uIGFuZCBcCiAgICAgICAgICAgICAgICBfTG9vc2VWZXJzaW9uKF9zeXN0ZW1fc2l4Ll9fdmVyc2lvbl9fKSA+PSBfTG9vc2VWZXJzaW9uKF9idW5kbGVkX3NpeC5fX3ZlcnNpb25fXyk6CiAgICAgICAgICAgIG1vZF9pbmZvID0gX2ZpbmRfbW9kdWxlKCdzaXgnKQogICAgZXhjZXB0OgogICAgICAgICMgQW55IGVycm9ycyBmaW5kaW5nIHRoZSBzeXN0ZW0gbGlicmFyeSwgdXNlIG91ciBidW5kbGVkIGxpYiBpbnN0ZWFkCiAgICAgICAgcGFzcwoKICAgIGlmIG5vdCBtb2RfaW5mbzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIG1vZF9pbmZvID0gX2ZpbmRfbW9kdWxlKCdhbnNpYmxlLm1vZHVsZV91dGlscy5zaXguX3NpeCcpCiAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICAjIHppcGltcG9ydAogICAgICAgICAgICBtb2R1bGVfc291cmNlID0gX2dldF9idW5kbGVkX3NpeF9zb3VyY2UoKQogICAgICAgICAgICByZXR1cm4gbW9kdWxlX3NvdXJjZQoKICAgIHJldHVybiBtb2RfaW5mb1swXS5yZWFkKCkKCnNvdXJjZSA9IF9nZXRfc2l4X3NvdXJjZSgpCmV4ZWMoc291cmNlKQpQSwMEFAAAAAAAzLsrS7XYBAYlMAAAJTAAAB0AAABhbnNpYmxlL21vZHVsZV91dGlscy9fdGV4dC5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpLCBUb3NoaW8gS3VyYXRvbWkgPGEuYmFkZ2VyQGdtYWlsLmNvbT4sIDIwMTYKIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dCBtb2RpZmljYXRpb24sCiMgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAojICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5ECiMgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRUQKIyBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuCiMgSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsCiMgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLAojIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUwojIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QKIyBMSUFCSUxJVFksIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUKIyBVU0UgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwoKIiIiCi4uIHdhcm46OiBUaGlzIG1vZHVsZV91dGlsIGlzIGN1cnJlbnRseSBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbi4KICAgIFdlIHdhbnQgdG8gZXZhbHVhdGUgdGhpcyBjb2RlIGZvciBzdGFiaWxpdHkgYW5kIEFQSSBzdWl0YWJpbGl0eSBiZWZvcmUKICAgIG1ha2luZyBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBndWFyYW50ZWVzLiAgVGhlIEFQSSBtYXkgY2hhbmdlIGJldHdlZW4KICAgIHJlbGVhc2VzLiAgRG8gbm90IHVzZSB0aGlzIHVubGVzcyB5b3UgYXJlIHdpbGxpbmcgdG8gcG9ydCB5b3VyIG1vZHVsZSBjb2RlLgoiIiIKaW1wb3J0IGNvZGVjcwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IFBZMywgdGV4dF90eXBlLCBiaW5hcnlfdHlwZQoKCnRyeToKICAgIGNvZGVjcy5sb29rdXBfZXJyb3IoJ3N1cnJvZ2F0ZWVzY2FwZScpCiAgICBIQVNfU1VSUk9HQVRFRVNDQVBFID0gVHJ1ZQpleGNlcHQgTG9va3VwRXJyb3I6CiAgICBIQVNfU1VSUk9HQVRFRVNDQVBFID0gRmFsc2UKCgpfQ09NUE9TRURfRVJST1JfSEFORExFUlMgPSBmcm96ZW5zZXQoKE5vbmUsICdzdXJyb2dhdGVfb3JfZXNjYXBlJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdXJyb2dhdGVfb3Jfc3RyaWN0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykpCgoKZGVmIHRvX2J5dGVzKG9iaiwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPU5vbmUsIG5vbnN0cmluZz0nc2ltcGxlcmVwcicpOgogICAgIiIiTWFrZSBzdXJlIHRoYXQgYSBzdHJpbmcgaXMgYSBieXRlIHN0cmluZwoKICAgIDphcmcgb2JqOiBBbiBvYmplY3QgdG8gbWFrZSBzdXJlIGlzIGEgYnl0ZSBzdHJpbmcuICBJbiBtb3N0IGNhc2VzIHRoaXMKICAgICAgICB3aWxsIGJlIGVpdGhlciBhIHRleHQgc3RyaW5nIG9yIGEgYnl0ZSBzdHJpbmcuICBIb3dldmVyLCB3aXRoCiAgICAgICAgYGBub25zdHJpbmc9J3NpbXBsZXJlcHInYGAsIHRoaXMgY2FuIGJlIHVzZWQgYXMgYSB0cmFjZWJhY2stZnJlZQogICAgICAgIHZlcnNpb24gb2YgYGBzdHIob2JqKWBgLgogICAgOmt3YXJnIGVuY29kaW5nOiBUaGUgZW5jb2RpbmcgdG8gdXNlIHRvIHRyYW5zZm9ybSBmcm9tIGEgdGV4dCBzdHJpbmcgdG8KICAgICAgICBhIGJ5dGUgc3RyaW5nLiAgRGVmYXVsdHMgdG8gdXNpbmcgJ3V0Zi04Jy4KICAgIDprd2FyZyBlcnJvcnM6IFRoZSBlcnJvciBoYW5kbGVyIHRvIHVzZSBpZiB0aGUgdGV4dCBzdHJpbmcgaXMgbm90CiAgICAgICAgZW5jb2RhYmxlIHVzaW5nIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcuICBBbnkgdmFsaWQgYGNvZGVjcyBlcnJvcgogICAgICAgIGhhbmRsZXIgPGh0dHBzOi8vZG9jcy5weXRob24ub3JnLzIvbGlicmFyeS9jb2RlY3MuaHRtbCNjb2RlYy1iYXNlLWNsYXNzZXM+YF8KICAgICAgICBtYXkgYmUgc3BlY2lmaWVkLiBUaGVyZSBhcmUgdGhyZWUgYWRkaXRpb25hbCBlcnJvciBzdHJhdGVnaWVzCiAgICAgICAgc3BlY2lmaWNhbGx5IGFpbWVkIGF0IGhlbHBpbmcgcGVvcGxlIHRvIHBvcnQgY29kZS4gIFRoZSBmaXJzdCB0d28gYXJlOgoKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9zdHJpY3Q6IFdpbGwgdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlciwgb3RoZXJ3aXNlIGl0IHdpbGwgdXNlIGBgc3RyaWN0YGAKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9yZXBsYWNlOiBXaWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSBgYHJlcGxhY2VgYC4KCiAgICAgICAgQmVjYXVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIHdhcyBhZGRlZCBpbiBQeXRob24zIHRoaXMgdXN1YWxseSBtZWFucyB0aGF0CiAgICAgICAgUHl0aG9uMyB3aWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGFuZCBQeXRob24yIHdpbGwgdXNlIHRoZSBmYWxsYmFjawogICAgICAgIGVycm9yIGhhbmRsZXIuIE5vdGUgdGhhdCB0aGUgY29kZSBjaGVja3MgZm9yIGBgc3Vycm9nYXRlZXNjYXBlYGAgd2hlbiB0aGUKICAgICAgICBtb2R1bGUgaXMgaW1wb3J0ZWQuICBJZiB5b3UgaGF2ZSBhIGJhY2twb3J0IG9mIGBgc3Vycm9nYXRlZXNjYXBlYGAgZm9yCiAgICAgICAgUHl0aG9uMiwgYmUgc3VyZSB0byByZWdpc3RlciB0aGUgZXJyb3IgaGFuZGxlciBwcmlvciB0byBpbXBvcnRpbmcgdGhpcwogICAgICAgIG1vZHVsZS4KCiAgICAgICAgVGhlIGxhc3QgZXJyb3IgaGFuZGxlciBpczoKCiAgICAgICAgICAgIDpzdXJyb2dhdGVfdGhlbl9yZXBsYWNlOiBXaWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIuICBJZiBlbmNvZGluZyB3aXRoIGBgc3Vycm9nYXRlZXNjYXBlYGAgd291bGQgdHJhY2ViYWNrLAogICAgICAgICAgICAgICAgc3Vycm9nYXRlcyBhcmUgZmlyc3QgcmVwbGFjZWQgd2l0aCBhIHJlcGxhY2VtZW50IGNoYXJhY3RlcnMKICAgICAgICAgICAgICAgIGFuZCB0aGVuIHRoZSBzdHJpbmcgaXMgZW5jb2RlZCB1c2luZyBgYHJlcGxhY2VgYCAod2hpY2ggcmVwbGFjZXMKICAgICAgICAgICAgICAgIHRoZSByZXN0IG9mIHRoZSBub25lbmNvZGFibGUgYnl0ZXMpLiAgSWYgYGBzdXJyb2dhdGVlc2NhcGVgYCBpcwogICAgICAgICAgICAgICAgbm90IHByZXNlbnQgaXQgd2lsbCBzaW1wbHkgdXNlIGBgcmVwbGFjZWBgLiAgKEFkZGVkIGluIEFuc2libGUgMi4zKQogICAgICAgICAgICAgICAgVGhpcyBzdHJhdGVneSBpcyBkZXNpZ25lZCB0byBuZXZlciB0cmFjZWJhY2sgd2hlbiBpdCBhdHRlbXB0cwogICAgICAgICAgICAgICAgdG8gZW5jb2RlIGEgc3RyaW5nLgoKICAgICAgICBUaGUgZGVmYXVsdCB1bnRpbCBBbnNpYmxlLTIuMiB3YXMgYGBzdXJyb2dhdGVfb3JfcmVwbGFjZWBgCiAgICAgICAgRnJvbSBBbnNpYmxlLTIuMyBvbndhcmRzLCB0aGUgZGVmYXVsdCBpcyBgYHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2VgYC4KCiAgICA6a3dhcmcgbm9uc3RyaW5nOiBUaGUgc3RyYXRlZ3kgdG8gdXNlIGlmIGEgbm9uc3RyaW5nIGlzIHNwZWNpZmllZCBpbgogICAgICAgIGBgb2JqYGAuICBEZWZhdWx0IGlzICdzaW1wbGVyZXByJy4gIFZhbGlkIHZhbHVlcyBhcmU6CgogICAgICAgIDpzaW1wbGVyZXByOiBUaGUgZGVmYXVsdC4gIFRoaXMgdGFrZXMgdGhlIGBgc3RyYGAgb2YgdGhlIG9iamVjdCBhbmQKICAgICAgICAgICAgdGhlbiByZXR1cm5zIHRoZSBieXRlcyB2ZXJzaW9uIG9mIHRoYXQgc3RyaW5nLgogICAgICAgIDplbXB0eTogUmV0dXJuIGFuIGVtcHR5IGJ5dGUgc3RyaW5nCiAgICAgICAgOnBhc3N0aHJ1OiBSZXR1cm4gdGhlIG9iamVjdCBwYXNzZWQgaW4KICAgICAgICA6c3RyaWN0OiBSYWlzZSBhIDpleGM6YFR5cGVFcnJvcmAKCiAgICA6cmV0dXJuczogVHlwaWNhbGx5IHRoaXMgcmV0dXJucyBhIGJ5dGUgc3RyaW5nLiAgSWYgYSBub25zdHJpbmcgb2JqZWN0IGlzCiAgICAgICAgcGFzc2VkIGluIHRoaXMgbWF5IGJlIGEgZGlmZmVyZW50IHR5cGUgZGVwZW5kaW5nIG9uIHRoZSBzdHJhdGVneQogICAgICAgIHNwZWNpZmllZCBieSBub25zdHJpbmcuICBUaGlzIHdpbGwgbmV2ZXIgcmV0dXJuIGEgdGV4dCBzdHJpbmcuCgogICAgLi4gbm90ZTo6IElmIHBhc3NlZCBhIGJ5dGUgc3RyaW5nLCB0aGlzIGZ1bmN0aW9uIGRvZXMgbm90IGNoZWNrIHRoYXQgdGhlCiAgICAgICAgc3RyaW5nIGlzIHZhbGlkIGluIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcuICBJZiBpdCdzIGltcG9ydGFudCB0aGF0IHRoZQogICAgICAgIGJ5dGUgc3RyaW5nIGlzIGluIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcgZG86OgoKICAgICAgICAgICAgZW5jb2RlZF9zdHJpbmcgPSB0b19ieXRlcyh0b190ZXh0KGlucHV0X3N0cmluZywgJ2xhdGluLTEnKSwgJ3V0Zi04JykKCiAgICAuLiB2ZXJzaW9uX2NoYW5nZWQ6OiAyLjMKCiAgICAgICAgQWRkZWQgdGhlIGBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWBgIGVycm9yIGhhbmRsZXIgYW5kIG1hZGUgaXQgdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlci4KICAgICIiIgogICAgaWYgaXNpbnN0YW5jZShvYmosIGJpbmFyeV90eXBlKToKICAgICAgICByZXR1cm4gb2JqCgogICAgIyBXZSdyZSBnaXZlbiBhIHRleHQgc3RyaW5nCiAgICAjIElmIGl0IGhhcyBzdXJyb2dhdGVzLCB3ZSBrbm93IGJlY2F1c2UgaXQgd2lsbCBkZWNvZGUKICAgIG9yaWdpbmFsX2Vycm9ycyA9IGVycm9ycwogICAgaWYgZXJyb3JzIGluIF9DT01QT1NFRF9FUlJPUl9IQU5ETEVSUzoKICAgICAgICBpZiBIQVNfU1VSUk9HQVRFRVNDQVBFOgogICAgICAgICAgICBlcnJvcnMgPSAnc3Vycm9nYXRlZXNjYXBlJwogICAgICAgIGVsaWYgZXJyb3JzID09ICdzdXJyb2dhdGVfb3Jfc3RyaWN0JzoKICAgICAgICAgICAgZXJyb3JzID0gJ3N0cmljdCcKICAgICAgICBlbHNlOgogICAgICAgICAgICBlcnJvcnMgPSAncmVwbGFjZScKCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgdGV4dF90eXBlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVHJ5IHRoaXMgZmlyc3QgYXMgaXQncyB0aGUgZmFzdGVzdAogICAgICAgICAgICByZXR1cm4gb2JqLmVuY29kZShlbmNvZGluZywgZXJyb3JzKQogICAgICAgIGV4Y2VwdCBVbmljb2RlRW5jb2RlRXJyb3I6CiAgICAgICAgICAgIGlmIG9yaWdpbmFsX2Vycm9ycyBpbiAoTm9uZSwgJ3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKToKICAgICAgICAgICAgICAgICMgU2xvdyBidXQgd29ya3MKICAgICAgICAgICAgICAgIHJldHVybl9zdHJpbmcgPSBvYmouZW5jb2RlKCd1dGYtOCcsICdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICAgICAgICAgcmV0dXJuX3N0cmluZyA9IHJldHVybl9zdHJpbmcuZGVjb2RlKCd1dGYtOCcsICdyZXBsYWNlJykKICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5fc3RyaW5nLmVuY29kZShlbmNvZGluZywgJ3JlcGxhY2UnKQogICAgICAgICAgICByYWlzZQoKICAgICMgTm90ZTogV2UgZG8gdGhlc2UgbGFzdCBldmVuIHRob3VnaCB3ZSBoYXZlIHRvIGNhbGwgdG9fYnl0ZXMgYWdhaW4gb24gdGhlCiAgICAjIHZhbHVlIGJlY2F1c2Ugd2UncmUgb3B0aW1pemluZyB0aGUgY29tbW9uIGNhc2UKICAgIGlmIG5vbnN0cmluZyA9PSAnc2ltcGxlcmVwcic6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWx1ZSA9IHN0cihvYmopCiAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdmFsdWUgPSByZXByKG9iaikKICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgICMgR2l2aW5nIHVwCiAgICAgICAgICAgICAgICByZXR1cm4gdG9fYnl0ZXMoJycpCiAgICBlbGlmIG5vbnN0cmluZyA9PSAncGFzc3RocnUnOgogICAgICAgIHJldHVybiBvYmoKICAgIGVsaWYgbm9uc3RyaW5nID09ICdlbXB0eSc6CiAgICAgICAgIyBweXRob24yLjQgZG9lc24ndCBoYXZlIGInJwogICAgICAgIHJldHVybiB0b19ieXRlcygnJykKICAgIGVsaWYgbm9uc3RyaW5nID09ICdzdHJpY3QnOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignb2JqIG11c3QgYmUgYSBzdHJpbmcgdHlwZScpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignSW52YWxpZCB2YWx1ZSAlcyBmb3IgdG9fYnl0ZXNcJyBub25zdHJpbmcgcGFyYW1ldGVyJyAlIG5vbnN0cmluZykKCiAgICByZXR1cm4gdG9fYnl0ZXModmFsdWUsIGVuY29kaW5nLCBlcnJvcnMpCgoKZGVmIHRvX3RleHQob2JqLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9Tm9uZSwgbm9uc3RyaW5nPSdzaW1wbGVyZXByJyk6CiAgICAiIiJNYWtlIHN1cmUgdGhhdCBhIHN0cmluZyBpcyBhIHRleHQgc3RyaW5nCgogICAgOmFyZyBvYmo6IEFuIG9iamVjdCB0byBtYWtlIHN1cmUgaXMgYSB0ZXh0IHN0cmluZy4gIEluIG1vc3QgY2FzZXMgdGhpcwogICAgICAgIHdpbGwgYmUgZWl0aGVyIGEgdGV4dCBzdHJpbmcgb3IgYSBieXRlIHN0cmluZy4gIEhvd2V2ZXIsIHdpdGgKICAgICAgICBgYG5vbnN0cmluZz0nc2ltcGxlcmVwcidgYCwgdGhpcyBjYW4gYmUgdXNlZCBhcyBhIHRyYWNlYmFjay1mcmVlCiAgICAgICAgdmVyc2lvbiBvZiBgYHN0cihvYmopYGAuCiAgICA6a3dhcmcgZW5jb2Rpbmc6IFRoZSBlbmNvZGluZyB0byB1c2UgdG8gdHJhbnNmb3JtIGZyb20gYSBieXRlIHN0cmluZyB0bwogICAgICAgIGEgdGV4dCBzdHJpbmcuICBEZWZhdWx0cyB0byB1c2luZyAndXRmLTgnLgogICAgOmt3YXJnIGVycm9yczogVGhlIGVycm9yIGhhbmRsZXIgdG8gdXNlIGlmIHRoZSBieXRlIHN0cmluZyBpcyBub3QKICAgICAgICBkZWNvZGFibGUgdXNpbmcgdGhlIHNwZWNpZmllZCBlbmNvZGluZy4gIEFueSB2YWxpZCBgY29kZWNzIGVycm9yCiAgICAgICAgaGFuZGxlciA8aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMi9saWJyYXJ5L2NvZGVjcy5odG1sI2NvZGVjLWJhc2UtY2xhc3Nlcz5gXwogICAgICAgIG1heSBiZSBzcGVjaWZpZWQuICAgV2Ugc3VwcG9ydCB0aHJlZSBhZGRpdGlvbmFsIGVycm9yIHN0cmF0ZWdpZXMKICAgICAgICBzcGVjaWZpY2FsbHkgYWltZWQgYXQgaGVscGluZyBwZW9wbGUgdG8gcG9ydCBjb2RlOgoKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9zdHJpY3Q6IFdpbGwgdXNlIHN1cnJvZ2F0ZWVzY2FwZSBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLCBvdGhlcndpc2UgaXQgd2lsbCB1c2Ugc3RyaWN0CiAgICAgICAgICAgIDpzdXJyb2dhdGVfb3JfcmVwbGFjZTogV2lsbCB1c2Ugc3Vycm9nYXRlZXNjYXBlIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSByZXBsYWNlLgogICAgICAgICAgICA6c3Vycm9nYXRlX3RoZW5fcmVwbGFjZTogRG9lcyB0aGUgc2FtZSBhcyBzdXJyb2dhdGVfb3JfcmVwbGFjZSBidXQKICAgICAgICAgICAgICAgIGB3YXMgYWRkZWQgZm9yIHN5bW1ldHJ5IHdpdGggdGhlIGVycm9yIGhhbmRsZXJzIGluCiAgICAgICAgICAgICAgICA6ZnVuYzpgYW5zaWJsZS5tb2R1bGVfdXRpbHMuX3RleHQudG9fYnl0ZXNgIChBZGRlZCBpbiBBbnNpYmxlIDIuMykKCiAgICAgICAgQmVjYXVzZSBzdXJyb2dhdGVlc2NhcGUgd2FzIGFkZGVkIGluIFB5dGhvbjMgdGhpcyB1c3VhbGx5IG1lYW5zIHRoYXQKICAgICAgICBQeXRob24zIHdpbGwgdXNlIGBzdXJyb2dhdGVlc2NhcGVgIGFuZCBQeXRob24yIHdpbGwgdXNlIHRoZSBmYWxsYmFjawogICAgICAgIGVycm9yIGhhbmRsZXIuIE5vdGUgdGhhdCB0aGUgY29kZSBjaGVja3MgZm9yIHN1cnJvZ2F0ZWVzY2FwZSB3aGVuIHRoZQogICAgICAgIG1vZHVsZSBpcyBpbXBvcnRlZC4gIElmIHlvdSBoYXZlIGEgYmFja3BvcnQgb2YgYHN1cnJvZ2F0ZWVzY2FwZWAgZm9yCiAgICAgICAgcHl0aG9uMiwgYmUgc3VyZSB0byByZWdpc3RlciB0aGUgZXJyb3IgaGFuZGxlciBwcmlvciB0byBpbXBvcnRpbmcgdGhpcwogICAgICAgIG1vZHVsZS4KCiAgICAgICAgVGhlIGRlZmF1bHQgdW50aWwgQW5zaWJsZS0yLjIgd2FzIGBzdXJyb2dhdGVfb3JfcmVwbGFjZWAKICAgICAgICBJbiBBbnNpYmxlLTIuMyB0aGlzIGRlZmF1bHRzIHRvIGBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlYCBmb3Igc3ltbWV0cnkKICAgICAgICB3aXRoIDpmdW5jOmBhbnNpYmxlLm1vZHVsZV91dGlscy5fdGV4dC50b19ieXRlc2AgLgogICAgOmt3YXJnIG5vbnN0cmluZzogVGhlIHN0cmF0ZWd5IHRvIHVzZSBpZiBhIG5vbnN0cmluZyBpcyBzcGVjaWZpZWQgaW4KICAgICAgICBgYG9iamBgLiAgRGVmYXVsdCBpcyAnc2ltcGxlcmVwcicuICBWYWxpZCB2YWx1ZXMgYXJlOgoKICAgICAgICA6c2ltcGxlcmVwcjogVGhlIGRlZmF1bHQuICBUaGlzIHRha2VzIHRoZSBgYHN0cmBgIG9mIHRoZSBvYmplY3QgYW5kCiAgICAgICAgICAgIHRoZW4gcmV0dXJucyB0aGUgdGV4dCB2ZXJzaW9uIG9mIHRoYXQgc3RyaW5nLgogICAgICAgIDplbXB0eTogUmV0dXJuIGFuIGVtcHR5IHRleHQgc3RyaW5nCiAgICAgICAgOnBhc3N0aHJ1OiBSZXR1cm4gdGhlIG9iamVjdCBwYXNzZWQgaW4KICAgICAgICA6c3RyaWN0OiBSYWlzZSBhIDpleGM6YFR5cGVFcnJvcmAKCiAgICA6cmV0dXJuczogVHlwaWNhbGx5IHRoaXMgcmV0dXJucyBhIHRleHQgc3RyaW5nLiAgSWYgYSBub25zdHJpbmcgb2JqZWN0IGlzCiAgICAgICAgcGFzc2VkIGluIHRoaXMgbWF5IGJlIGEgZGlmZmVyZW50IHR5cGUgZGVwZW5kaW5nIG9uIHRoZSBzdHJhdGVneQogICAgICAgIHNwZWNpZmllZCBieSBub25zdHJpbmcuICBUaGlzIHdpbGwgbmV2ZXIgcmV0dXJuIGEgYnl0ZSBzdHJpbmcuCiAgICAgICAgRnJvbSBBbnNpYmxlLTIuMyBvbndhcmRzLCB0aGUgZGVmYXVsdCBpcyBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWAuCgogICAgLi4gdmVyc2lvbl9jaGFuZ2VkOjogMi4zCgogICAgICAgIEFkZGVkIHRoZSBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlIGVycm9yIGhhbmRsZXIgYW5kIG1hZGUgaXQgdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlci4KICAgICIiIgogICAgaWYgaXNpbnN0YW5jZShvYmosIHRleHRfdHlwZSk6CiAgICAgICAgcmV0dXJuIG9iagoKICAgIGlmIGVycm9ycyBpbiBfQ09NUE9TRURfRVJST1JfSEFORExFUlM6CiAgICAgICAgaWYgSEFTX1NVUlJPR0FURUVTQ0FQRToKICAgICAgICAgICAgZXJyb3JzID0gJ3N1cnJvZ2F0ZWVzY2FwZScKICAgICAgICBlbGlmIGVycm9ycyA9PSAnc3Vycm9nYXRlX29yX3N0cmljdCc6CiAgICAgICAgICAgIGVycm9ycyA9ICdzdHJpY3QnCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZXJyb3JzID0gJ3JlcGxhY2UnCgogICAgaWYgaXNpbnN0YW5jZShvYmosIGJpbmFyeV90eXBlKToKICAgICAgICAjIE5vdGU6IFdlIGRvbid0IG5lZWQgc3BlY2lhbCBoYW5kbGluZyBmb3Igc3Vycm9nYXRlX3RoZW5fcmVwbGFjZQogICAgICAgICMgYmVjYXVzZSBhbGwgYnl0ZXMgd2lsbCBlaXRoZXIgYmUgbWFkZSBpbnRvIHN1cnJvZ2F0ZXMgb3IgYXJlIHZhbGlkCiAgICAgICAgIyB0byBkZWNvZGUuCiAgICAgICAgcmV0dXJuIG9iai5kZWNvZGUoZW5jb2RpbmcsIGVycm9ycykKCiAgICAjIE5vdGU6IFdlIGRvIHRoZXNlIGxhc3QgZXZlbiB0aG91Z2ggd2UgaGF2ZSB0byBjYWxsIHRvX3RleHQgYWdhaW4gb24gdGhlCiAgICAjIHZhbHVlIGJlY2F1c2Ugd2UncmUgb3B0aW1pemluZyB0aGUgY29tbW9uIGNhc2UKICAgIGlmIG5vbnN0cmluZyA9PSAnc2ltcGxlcmVwcic6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWx1ZSA9IHN0cihvYmopCiAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdmFsdWUgPSByZXByKG9iaikKICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgICMgR2l2aW5nIHVwCiAgICAgICAgICAgICAgICByZXR1cm4gdScnCiAgICBlbGlmIG5vbnN0cmluZyA9PSAncGFzc3RocnUnOgogICAgICAgIHJldHVybiBvYmoKICAgIGVsaWYgbm9uc3RyaW5nID09ICdlbXB0eSc6CiAgICAgICAgcmV0dXJuIHUnJwogICAgZWxpZiBub25zdHJpbmcgPT0gJ3N0cmljdCc6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdvYmogbXVzdCBiZSBhIHN0cmluZyB0eXBlJykKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdJbnZhbGlkIHZhbHVlICVzIGZvciB0b190ZXh0XCdzIG5vbnN0cmluZyBwYXJhbWV0ZXInICUgbm9uc3RyaW5nKQoKICAgIHJldHVybiB0b190ZXh0KHZhbHVlLCBlbmNvZGluZywgZXJyb3JzKQoKCiM6IDpweTpmdW5jOmB0b19uYXRpdmVgCiM6ICAgICAgVHJhbnNmb3JtIGEgdmFyaWFibGUgaW50byB0aGUgbmF0aXZlIHN0ciB0eXBlIGZvciB0aGUgcHl0aG9uIHZlcnNpb24KIzoKIzogICAgICBPbiBQeXRob24yLCB0aGlzIGlzIGFuIGFsaWFzIGZvcgojOiAgICAgIDpmdW5jOmB+YW5zaWJsZS5tb2R1bGVfdXRpbHMudG9fYnl0ZXNgLiAgT24gUHl0aG9uMyBpdCBpcyBhbiBhbGlhcyBmb3IKIzogICAgICA6ZnVuYzpgfmFuc2libGUubW9kdWxlX3V0aWxzLnRvX3RleHRgLiAgSXQgbWFrZXMgaXQgZWFzaWVyIHRvCiM6ICAgICAgdHJhbnNmb3JtIGEgdmFyaWFibGUgaW50byB0aGUgbmF0aXZlIHN0ciB0eXBlIGZvciB0aGUgcHl0aG9uIHZlcnNpb24KIzogICAgICB0aGUgY29kZSBpcyBydW5uaW5nIG9uLiAgVXNlIHRoaXMgd2hlbiBjb25zdHJ1Y3RpbmcgdGhlIG1lc3NhZ2UgdG8KIzogICAgICBzZW5kIHRvIGV4Y2VwdGlvbnMgb3Igd2hlbiBkZWFsaW5nIHdpdGggYW4gQVBJIHRoYXQgbmVlZHMgdG8gdGFrZQojOiAgICAgIGEgbmF0aXZlIHN0cmluZy4gIEV4YW1wbGU6OgojOgojOiAgICAgICAgICB0cnk6CiM6ICAgICAgICAgICAgICAxLy8wCiM6ICAgICAgICAgIGV4Y2VwdCBaZXJvRGl2aXNpb25FcnJvciBhcyBlOgojOiAgICAgICAgICAgICAgcmFpc2UgTXlFeGNlcHRpb24oJ0VuY291bnRlcmVkIGFuZCBlcnJvcjogJXMnICUgdG9fbmF0aXZlKGUpKQppZiBQWTM6CiAgICB0b19uYXRpdmUgPSB0b190ZXh0CmVsc2U6CiAgICB0b19uYXRpdmUgPSB0b19ieXRlcwpQSwMEFAAAAAAAzLsrSzjix9GRdQAAkXUAACAAAABhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeC5weSIiIlV0aWxpdGllcyBmb3Igd3JpdGluZyBjb2RlIHRoYXQgcnVucyBvbiBQeXRob24gMiBhbmQgMyIiIgoKIyBDb3B5cmlnaHQgKGMpIDIwMTAtMjAxNSBCZW5qYW1pbiBQZXRlcnNvbgojCiMgUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQojIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiMgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwojIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKIyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKIyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgojCiMgVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCiMgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KIwojIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiMgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiMgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiMgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgojIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiMgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKIyBTT0ZUV0FSRS4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgYWJzb2x1dGVfaW1wb3J0CgppbXBvcnQgZnVuY3Rvb2xzCmltcG9ydCBpdGVydG9vbHMKaW1wb3J0IG9wZXJhdG9yCmltcG9ydCBzeXMKaW1wb3J0IHR5cGVzCgpfX2F1dGhvcl9fID0gIkJlbmphbWluIFBldGVyc29uIDxiZW5qYW1pbkBweXRob24ub3JnPiIKX192ZXJzaW9uX18gPSAiMS4xMC4wIgoKCiMgVXNlZnVsIGZvciB2ZXJ5IGNvYXJzZSB2ZXJzaW9uIGRpZmZlcmVudGlhdGlvbi4KUFkyID0gc3lzLnZlcnNpb25faW5mb1swXSA9PSAyClBZMyA9IHN5cy52ZXJzaW9uX2luZm9bMF0gPT0gMwpQWTM0ID0gc3lzLnZlcnNpb25faW5mb1swOjJdID49ICgzLCA0KQoKaWYgUFkzOgogICAgc3RyaW5nX3R5cGVzID0gc3RyLAogICAgaW50ZWdlcl90eXBlcyA9IGludCwKICAgIGNsYXNzX3R5cGVzID0gdHlwZSwKICAgIHRleHRfdHlwZSA9IHN0cgogICAgYmluYXJ5X3R5cGUgPSBieXRlcwogICAgTUFYU0laRSA9IHN5cy5tYXhzaXplCmVsc2U6CiAgICBzdHJpbmdfdHlwZXMgPSBiYXNlc3RyaW5nLAogICAgaW50ZWdlcl90eXBlcyA9IChpbnQsIGxvbmcpCiAgICBjbGFzc190eXBlcyA9ICh0eXBlLCB0eXBlcy5DbGFzc1R5cGUpCiAgICB0ZXh0X3R5cGUgPSB1bmljb2RlCiAgICBiaW5hcnlfdHlwZSA9IHN0cgoKICAgIGlmIHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCJqYXZhIik6CiAgICAgICAgIyBKeXRob24gYWx3YXlzIHVzZXMgMzIgYml0cy4KICAgICAgICBNQVhTSVpFID0gaW50KCgxIDw8IDMxKSAtIDEpCiAgICBlbHNlOgogICAgICAgICMgSXQncyBwb3NzaWJsZSB0byBoYXZlIHNpemVvZihsb25nKSAhPSBzaXplb2YoUHlfc3NpemVfdCkuCiAgICAgICAgY2xhc3MgWChvYmplY3QpOgoKICAgICAgICAgICAgZGVmIF9fbGVuX18oc2VsZik6CiAgICAgICAgICAgICAgICByZXR1cm4gMSA8PCAzMQogICAgICAgIHRyeToKICAgICAgICAgICAgbGVuKFgoKSkKICAgICAgICBleGNlcHQgT3ZlcmZsb3dFcnJvcjoKICAgICAgICAgICAgIyAzMi1iaXQKICAgICAgICAgICAgTUFYU0laRSA9IGludCgoMSA8PCAzMSkgLSAxKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgNjQtYml0CiAgICAgICAgICAgIE1BWFNJWkUgPSBpbnQoKDEgPDwgNjMpIC0gMSkKICAgICAgICBkZWwgWAoKCmRlZiBfYWRkX2RvYyhmdW5jLCBkb2MpOgogICAgIiIiQWRkIGRvY3VtZW50YXRpb24gdG8gYSBmdW5jdGlvbi4iIiIKICAgIGZ1bmMuX19kb2NfXyA9IGRvYwoKCmRlZiBfaW1wb3J0X21vZHVsZShuYW1lKToKICAgICIiIkltcG9ydCBtb2R1bGUsIHJldHVybmluZyB0aGUgbW9kdWxlIGFmdGVyIHRoZSBsYXN0IGRvdC4iIiIKICAgIF9faW1wb3J0X18obmFtZSkKICAgIHJldHVybiBzeXMubW9kdWxlc1tuYW1lXQoKCmNsYXNzIF9MYXp5RGVzY3Iob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSk6CiAgICAgICAgc2VsZi5uYW1lID0gbmFtZQoKICAgIGRlZiBfX2dldF9fKHNlbGYsIG9iaiwgdHApOgogICAgICAgIHJlc3VsdCA9IHNlbGYuX3Jlc29sdmUoKQogICAgICAgIHNldGF0dHIob2JqLCBzZWxmLm5hbWUsIHJlc3VsdCkgICMgSW52b2tlcyBfX3NldF9fLgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBUaGlzIGlzIGEgYml0IHVnbHksIGJ1dCBpdCBhdm9pZHMgcnVubmluZyB0aGlzIGFnYWluIGJ5CiAgICAgICAgICAgICMgcmVtb3ZpbmcgdGhpcyBkZXNjcmlwdG9yLgogICAgICAgICAgICBkZWxhdHRyKG9iai5fX2NsYXNzX18sIHNlbGYubmFtZSkKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gcmVzdWx0CgoKY2xhc3MgTW92ZWRNb2R1bGUoX0xhenlEZXNjcik6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUsIG9sZCwgbmV3PU5vbmUpOgogICAgICAgIHN1cGVyKE1vdmVkTW9kdWxlLCBzZWxmKS5fX2luaXRfXyhuYW1lKQogICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgaWYgbmV3IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBuZXcgPSBuYW1lCiAgICAgICAgICAgIHNlbGYubW9kID0gbmV3CiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5tb2QgPSBvbGQKCiAgICBkZWYgX3Jlc29sdmUoc2VsZik6CiAgICAgICAgcmV0dXJuIF9pbXBvcnRfbW9kdWxlKHNlbGYubW9kKQoKICAgIGRlZiBfX2dldGF0dHJfXyhzZWxmLCBhdHRyKToKICAgICAgICBfbW9kdWxlID0gc2VsZi5fcmVzb2x2ZSgpCiAgICAgICAgdmFsdWUgPSBnZXRhdHRyKF9tb2R1bGUsIGF0dHIpCiAgICAgICAgc2V0YXR0cihzZWxmLCBhdHRyLCB2YWx1ZSkKICAgICAgICByZXR1cm4gdmFsdWUKCgpjbGFzcyBfTGF6eU1vZHVsZSh0eXBlcy5Nb2R1bGVUeXBlKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSk6CiAgICAgICAgc3VwZXIoX0xhenlNb2R1bGUsIHNlbGYpLl9faW5pdF9fKG5hbWUpCiAgICAgICAgc2VsZi5fX2RvY19fID0gc2VsZi5fX2NsYXNzX18uX19kb2NfXwoKICAgIGRlZiBfX2Rpcl9fKHNlbGYpOgogICAgICAgIGF0dHJzID0gWyJfX2RvY19fIiwgIl9fbmFtZV9fIl0KICAgICAgICBhdHRycyArPSBbYXR0ci5uYW1lIGZvciBhdHRyIGluIHNlbGYuX21vdmVkX2F0dHJpYnV0ZXNdCiAgICAgICAgcmV0dXJuIGF0dHJzCgogICAgIyBTdWJjbGFzc2VzIHNob3VsZCBvdmVycmlkZSB0aGlzCiAgICBfbW92ZWRfYXR0cmlidXRlcyA9IFtdCgoKY2xhc3MgTW92ZWRBdHRyaWJ1dGUoX0xhenlEZXNjcik6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUsIG9sZF9tb2QsIG5ld19tb2QsIG9sZF9hdHRyPU5vbmUsIG5ld19hdHRyPU5vbmUpOgogICAgICAgIHN1cGVyKE1vdmVkQXR0cmlidXRlLCBzZWxmKS5fX2luaXRfXyhuYW1lKQogICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgaWYgbmV3X21vZCBpcyBOb25lOgogICAgICAgICAgICAgICAgbmV3X21vZCA9IG5hbWUKICAgICAgICAgICAgc2VsZi5tb2QgPSBuZXdfbW9kCiAgICAgICAgICAgIGlmIG5ld19hdHRyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBpZiBvbGRfYXR0ciBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIG5ld19hdHRyID0gbmFtZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBuZXdfYXR0ciA9IG9sZF9hdHRyCiAgICAgICAgICAgIHNlbGYuYXR0ciA9IG5ld19hdHRyCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5tb2QgPSBvbGRfbW9kCiAgICAgICAgICAgIGlmIG9sZF9hdHRyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBvbGRfYXR0ciA9IG5hbWUKICAgICAgICAgICAgc2VsZi5hdHRyID0gb2xkX2F0dHIKCiAgICBkZWYgX3Jlc29sdmUoc2VsZik6CiAgICAgICAgbW9kdWxlID0gX2ltcG9ydF9tb2R1bGUoc2VsZi5tb2QpCiAgICAgICAgcmV0dXJuIGdldGF0dHIobW9kdWxlLCBzZWxmLmF0dHIpCgoKY2xhc3MgX1NpeE1ldGFQYXRoSW1wb3J0ZXIob2JqZWN0KToKCiAgICAiIiIKICAgIEEgbWV0YSBwYXRoIGltcG9ydGVyIHRvIGltcG9ydCBzaXgubW92ZXMgYW5kIGl0cyBzdWJtb2R1bGVzLgoKICAgIFRoaXMgY2xhc3MgaW1wbGVtZW50cyBhIFBFUDMwMiBmaW5kZXIgYW5kIGxvYWRlci4gSXQgc2hvdWxkIGJlIGNvbXBhdGlibGUKICAgIHdpdGggUHl0aG9uIDIuNSBhbmQgYWxsIGV4aXN0aW5nIHZlcnNpb25zIG9mIFB5dGhvbjMKICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzaXhfbW9kdWxlX25hbWUpOgogICAgICAgIHNlbGYubmFtZSA9IHNpeF9tb2R1bGVfbmFtZQogICAgICAgIHNlbGYua25vd25fbW9kdWxlcyA9IHt9CgogICAgZGVmIF9hZGRfbW9kdWxlKHNlbGYsIG1vZCwgKmZ1bGxuYW1lcyk6CiAgICAgICAgZm9yIGZ1bGxuYW1lIGluIGZ1bGxuYW1lczoKICAgICAgICAgICAgc2VsZi5rbm93bl9tb2R1bGVzW3NlbGYubmFtZSArICIuIiArIGZ1bGxuYW1lXSA9IG1vZAoKICAgIGRlZiBfZ2V0X21vZHVsZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgcmV0dXJuIHNlbGYua25vd25fbW9kdWxlc1tzZWxmLm5hbWUgKyAiLiIgKyBmdWxsbmFtZV0KCiAgICBkZWYgZmluZF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUsIHBhdGg9Tm9uZSk6CiAgICAgICAgaWYgZnVsbG5hbWUgaW4gc2VsZi5rbm93bl9tb2R1bGVzOgogICAgICAgICAgICByZXR1cm4gc2VsZgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9fZ2V0X21vZHVsZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gc2VsZi5rbm93bl9tb2R1bGVzW2Z1bGxuYW1lXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoIlRoaXMgbG9hZGVyIGRvZXMgbm90IGtub3cgbW9kdWxlICIgKyBmdWxsbmFtZSkKCiAgICBkZWYgbG9hZF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBpbiBjYXNlIG9mIGEgcmVsb2FkCiAgICAgICAgICAgIHJldHVybiBzeXMubW9kdWxlc1tmdWxsbmFtZV0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBtb2QgPSBzZWxmLl9fZ2V0X21vZHVsZShmdWxsbmFtZSkKICAgICAgICBpZiBpc2luc3RhbmNlKG1vZCwgTW92ZWRNb2R1bGUpOgogICAgICAgICAgICBtb2QgPSBtb2QuX3Jlc29sdmUoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1vZC5fX2xvYWRlcl9fID0gc2VsZgogICAgICAgIHN5cy5tb2R1bGVzW2Z1bGxuYW1lXSA9IG1vZAogICAgICAgIHJldHVybiBtb2QKCiAgICBkZWYgaXNfcGFja2FnZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgIiIiCiAgICAgICAgUmV0dXJuIHRydWUsIGlmIHRoZSBuYW1lZCBtb2R1bGUgaXMgYSBwYWNrYWdlLgoKICAgICAgICBXZSBuZWVkIHRoaXMgbWV0aG9kIHRvIGdldCBjb3JyZWN0IHNwZWMgb2JqZWN0cyB3aXRoCiAgICAgICAgUHl0aG9uIDMuNCAoc2VlIFBFUDQ1MSkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gaGFzYXR0cihzZWxmLl9fZ2V0X21vZHVsZShmdWxsbmFtZSksICJfX3BhdGhfXyIpCgogICAgZGVmIGdldF9jb2RlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICAiIiJSZXR1cm4gTm9uZQoKICAgICAgICBSZXF1aXJlZCwgaWYgaXNfcGFja2FnZSBpcyBpbXBsZW1lbnRlZCIiIgogICAgICAgIHNlbGYuX19nZXRfbW9kdWxlKGZ1bGxuYW1lKSAgIyBldmVudHVhbGx5IHJhaXNlcyBJbXBvcnRFcnJvcgogICAgICAgIHJldHVybiBOb25lCiAgICBnZXRfc291cmNlID0gZ2V0X2NvZGUgICMgc2FtZSBhcyBnZXRfY29kZQoKX2ltcG9ydGVyID0gX1NpeE1ldGFQYXRoSW1wb3J0ZXIoX19uYW1lX18pCgoKY2xhc3MgX01vdmVkSXRlbXMoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIiIiCiAgICBfX3BhdGhfXyA9IFtdICAjIG1hcmsgYXMgcGFja2FnZQoKCl9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoImNTdHJpbmdJTyIsICJjU3RyaW5nSU8iLCAiaW8iLCAiU3RyaW5nSU8iKSwKICAgIE1vdmVkQXR0cmlidXRlKCJmaWx0ZXIiLCAiaXRlcnRvb2xzIiwgImJ1aWx0aW5zIiwgImlmaWx0ZXIiLCAiZmlsdGVyIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZmlsdGVyZmFsc2UiLCAiaXRlcnRvb2xzIiwgIml0ZXJ0b29scyIsICJpZmlsdGVyZmFsc2UiLCAiZmlsdGVyZmFsc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnB1dCIsICJfX2J1aWx0aW5fXyIsICJidWlsdGlucyIsICJyYXdfaW5wdXQiLCAiaW5wdXQiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnRlcm4iLCAiX19idWlsdGluX18iLCAic3lzIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgibWFwIiwgIml0ZXJ0b29scyIsICJidWlsdGlucyIsICJpbWFwIiwgIm1hcCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldGN3ZCIsICJvcyIsICJvcyIsICJnZXRjd2R1IiwgImdldGN3ZCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldGN3ZGIiLCAib3MiLCAib3MiLCAiZ2V0Y3dkIiwgImdldGN3ZGIiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJyYW5nZSIsICJfX2J1aWx0aW5fXyIsICJidWlsdGlucyIsICJ4cmFuZ2UiLCAicmFuZ2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJyZWxvYWRfbW9kdWxlIiwgIl9fYnVpbHRpbl9fIiwgImltcG9ydGxpYiIgaWYgUFkzNCBlbHNlICJpbXAiLCAicmVsb2FkIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicmVkdWNlIiwgIl9fYnVpbHRpbl9fIiwgImZ1bmN0b29scyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInNobGV4X3F1b3RlIiwgInBpcGVzIiwgInNobGV4IiwgInF1b3RlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiU3RyaW5nSU8iLCAiU3RyaW5nSU8iLCAiaW8iKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVc2VyRGljdCIsICJVc2VyRGljdCIsICJjb2xsZWN0aW9ucyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVzZXJMaXN0IiwgIlVzZXJMaXN0IiwgImNvbGxlY3Rpb25zIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVXNlclN0cmluZyIsICJVc2VyU3RyaW5nIiwgImNvbGxlY3Rpb25zIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgieHJhbmdlIiwgIl9fYnVpbHRpbl9fIiwgImJ1aWx0aW5zIiwgInhyYW5nZSIsICJyYW5nZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInppcCIsICJpdGVydG9vbHMiLCAiYnVpbHRpbnMiLCAiaXppcCIsICJ6aXAiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ6aXBfbG9uZ2VzdCIsICJpdGVydG9vbHMiLCAiaXRlcnRvb2xzIiwgIml6aXBfbG9uZ2VzdCIsICJ6aXBfbG9uZ2VzdCIpLAogICAgTW92ZWRNb2R1bGUoImJ1aWx0aW5zIiwgIl9fYnVpbHRpbl9fIiksCiAgICBNb3ZlZE1vZHVsZSgiY29uZmlncGFyc2VyIiwgIkNvbmZpZ1BhcnNlciIpLAogICAgTW92ZWRNb2R1bGUoImNvcHlyZWciLCAiY29weV9yZWciKSwKICAgIE1vdmVkTW9kdWxlKCJkYm1fZ251IiwgImdkYm0iLCAiZGJtLmdudSIpLAogICAgTW92ZWRNb2R1bGUoIl9kdW1teV90aHJlYWQiLCAiZHVtbXlfdGhyZWFkIiwgIl9kdW1teV90aHJlYWQiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2Nvb2tpZWphciIsICJjb29raWVsaWIiLCAiaHR0cC5jb29raWVqYXIiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2Nvb2tpZXMiLCAiQ29va2llIiwgImh0dHAuY29va2llcyIpLAogICAgTW92ZWRNb2R1bGUoImh0bWxfZW50aXRpZXMiLCAiaHRtbGVudGl0eWRlZnMiLCAiaHRtbC5lbnRpdGllcyIpLAogICAgTW92ZWRNb2R1bGUoImh0bWxfcGFyc2VyIiwgIkhUTUxQYXJzZXIiLCAiaHRtbC5wYXJzZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2NsaWVudCIsICJodHRwbGliIiwgImh0dHAuY2xpZW50IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV9tdWx0aXBhcnQiLCAiZW1haWwuTUlNRU11bHRpcGFydCIsICJlbWFpbC5taW1lLm11bHRpcGFydCIpLAogICAgTW92ZWRNb2R1bGUoImVtYWlsX21pbWVfbm9ubXVsdGlwYXJ0IiwgImVtYWlsLk1JTUVOb25NdWx0aXBhcnQiLCAiZW1haWwubWltZS5ub25tdWx0aXBhcnQiKSwKICAgIE1vdmVkTW9kdWxlKCJlbWFpbF9taW1lX3RleHQiLCAiZW1haWwuTUlNRVRleHQiLCAiZW1haWwubWltZS50ZXh0IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV9iYXNlIiwgImVtYWlsLk1JTUVCYXNlIiwgImVtYWlsLm1pbWUuYmFzZSIpLAogICAgTW92ZWRNb2R1bGUoIkJhc2VIVFRQU2VydmVyIiwgIkJhc2VIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiQ0dJSFRUUFNlcnZlciIsICJDR0lIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiU2ltcGxlSFRUUFNlcnZlciIsICJTaW1wbGVIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiY1BpY2tsZSIsICJjUGlja2xlIiwgInBpY2tsZSIpLAogICAgTW92ZWRNb2R1bGUoInF1ZXVlIiwgIlF1ZXVlIiksCiAgICBNb3ZlZE1vZHVsZSgicmVwcmxpYiIsICJyZXByIiksCiAgICBNb3ZlZE1vZHVsZSgic29ja2V0c2VydmVyIiwgIlNvY2tldFNlcnZlciIpLAogICAgTW92ZWRNb2R1bGUoIl90aHJlYWQiLCAidGhyZWFkIiwgIl90aHJlYWQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyIiwgIlRraW50ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2RpYWxvZyIsICJEaWFsb2ciLCAidGtpbnRlci5kaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2ZpbGVkaWFsb2ciLCAiRmlsZURpYWxvZyIsICJ0a2ludGVyLmZpbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3Njcm9sbGVkdGV4dCIsICJTY3JvbGxlZFRleHQiLCAidGtpbnRlci5zY3JvbGxlZHRleHQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3NpbXBsZWRpYWxvZyIsICJTaW1wbGVEaWFsb2ciLCAidGtpbnRlci5zaW1wbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3RpeCIsICJUaXgiLCAidGtpbnRlci50aXgiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3R0ayIsICJ0dGsiLCAidGtpbnRlci50dGsiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2NvbnN0YW50cyIsICJUa2NvbnN0YW50cyIsICJ0a2ludGVyLmNvbnN0YW50cyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZG5kIiwgIlRrZG5kIiwgInRraW50ZXIuZG5kIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9jb2xvcmNob29zZXIiLCAidGtDb2xvckNob29zZXIiLAogICAgICAgICAgICAgICAgInRraW50ZXIuY29sb3JjaG9vc2VyIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9jb21tb25kaWFsb2ciLCAidGtDb21tb25EaWFsb2ciLAogICAgICAgICAgICAgICAgInRraW50ZXIuY29tbW9uZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl90a2ZpbGVkaWFsb2ciLCAidGtGaWxlRGlhbG9nIiwgInRraW50ZXIuZmlsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZm9udCIsICJ0a0ZvbnQiLCAidGtpbnRlci5mb250IiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9tZXNzYWdlYm94IiwgInRrTWVzc2FnZUJveCIsICJ0a2ludGVyLm1lc3NhZ2Vib3giKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3Rrc2ltcGxlZGlhbG9nIiwgInRrU2ltcGxlRGlhbG9nIiwKICAgICAgICAgICAgICAgICJ0a2ludGVyLnNpbXBsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYl9wYXJzZSIsIF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWJfcGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZE1vZHVsZSgidXJsbGliX2Vycm9yIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYl9lcnJvciIsICJ1cmxsaWIuZXJyb3IiKSwKICAgIE1vdmVkTW9kdWxlKCJ1cmxsaWIiLCBfX25hbWVfXyArICIubW92ZXMudXJsbGliIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYiIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYl9yb2JvdHBhcnNlciIsICJyb2JvdHBhcnNlciIsICJ1cmxsaWIucm9ib3RwYXJzZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJ4bWxycGNfY2xpZW50IiwgInhtbHJwY2xpYiIsICJ4bWxycGMuY2xpZW50IiksCiAgICBNb3ZlZE1vZHVsZSgieG1scnBjX3NlcnZlciIsICJTaW1wbGVYTUxSUENTZXJ2ZXIiLCAieG1scnBjLnNlcnZlciIpLApdCiMgQWRkIHdpbmRvd3Mgc3BlY2lmaWMgbW9kdWxlcy4KaWYgc3lzLnBsYXRmb3JtID09ICJ3aW4zMiI6CiAgICBfbW92ZWRfYXR0cmlidXRlcyArPSBbCiAgICAgICAgTW92ZWRNb2R1bGUoIndpbnJlZyIsICJfd2lucmVnIiksCiAgICBdCgpmb3IgYXR0ciBpbiBfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoX01vdmVkSXRlbXMsIGF0dHIubmFtZSwgYXR0cikKICAgIGlmIGlzaW5zdGFuY2UoYXR0ciwgTW92ZWRNb2R1bGUpOgogICAgICAgIF9pbXBvcnRlci5fYWRkX21vZHVsZShhdHRyLCAibW92ZXMuIiArIGF0dHIubmFtZSkKZGVsIGF0dHIKCl9Nb3ZlZEl0ZW1zLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX21vdmVkX2F0dHJpYnV0ZXMKCm1vdmVzID0gX01vdmVkSXRlbXMoX19uYW1lX18gKyAiLm1vdmVzIikKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKG1vdmVzLCAibW92ZXMiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3BhcnNlIiIiCgoKX3VybGxpYl9wYXJzZV9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoIlBhcnNlUmVzdWx0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlNwbGl0UmVzdWx0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInBhcnNlX3FzIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInBhcnNlX3FzbCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxkZWZyYWciLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsam9pbiIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxwYXJzZSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxzcGxpdCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmx1bnBhcnNlIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHVuc3BsaXQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicXVvdGUiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInF1b3RlX3BsdXMiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVucXVvdGUiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVucXVvdGVfcGx1cyIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsZW5jb2RlIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzcGxpdHF1ZXJ5IiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzcGxpdHRhZyIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgic3BsaXR1c2VyIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX2ZyYWdtZW50IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfbmV0bG9jIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfcGFyYW1zIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfcXVlcnkiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19yZWxhdGl2ZSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX3BhcnNlX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9wYXJzZS5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfcGFyc2VfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWJfcGFyc2UiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfcGFyc2UiLCAibW92ZXMudXJsbGliLnBhcnNlIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvcihfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9lcnJvciIiIgoKCl91cmxsaWJfZXJyb3JfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJVUkxFcnJvciIsICJ1cmxsaWIyIiwgInVybGxpYi5lcnJvciIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBFcnJvciIsICJ1cmxsaWIyIiwgInVybGxpYi5lcnJvciIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkNvbnRlbnRUb29TaG9ydEVycm9yIiwgInVybGxpYiIsICJ1cmxsaWIuZXJyb3IiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX2Vycm9yX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvci5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfZXJyb3JfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIuZXJyb3IiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfZXJyb3IiLCAibW92ZXMudXJsbGliLmVycm9yIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXF1ZXN0KF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3JlcXVlc3QiIiIKCgpfdXJsbGliX3JlcXVlc3RfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxvcGVuIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnN0YWxsX29wZW5lciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYnVpbGRfb3BlbmVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwYXRobmFtZTJ1cmwiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsMnBhdGhuYW1lIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldHByb3hpZXMiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUmVxdWVzdCIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiT3BlbmVyRGlyZWN0b3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBEZWZhdWx0RXJyb3JIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQUmVkaXJlY3RIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQQ29va2llUHJvY2Vzc29yIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJQcm94eUhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkJhc2VIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQUGFzc3dvcmRNZ3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBQYXNzd29yZE1ncldpdGhEZWZhdWx0UmVhbG0iLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkFic3RyYWN0QmFzaWNBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEJhc2ljQXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlByb3h5QmFzaWNBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQWJzdHJhY3REaWdlc3RBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUERpZ2VzdEF1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJQcm94eURpZ2VzdEF1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUFNIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJGaWxlSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiRlRQSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQ2FjaGVGVFBIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVbmtub3duSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEVycm9yUHJvY2Vzc29yIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxyZXRyaWV2ZSIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxjbGVhbnVwIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVSTG9wZW5lciIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJGYW5jeVVSTG9wZW5lciIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwcm94eV9ieXBhc3MiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9yZXF1ZXN0X21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3JlcXVlc3RfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5yZXF1ZXN0IiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3JlcXVlc3QiLCAibW92ZXMudXJsbGliLnJlcXVlc3QiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3Jlc3BvbnNlKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3Jlc3BvbnNlIiIiCgoKX3VybGxpYl9yZXNwb25zZV9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGJhc2UiLCAidXJsbGliIiwgInVybGxpYi5yZXNwb25zZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGNsb3NlaG9vayIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkaW5mbyIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkaW5mb3VybCIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9yZXNwb25zZV9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZSwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVzcG9uc2UuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3Jlc3BvbnNlX21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZShfX25hbWVfXyArICIubW92ZXMudXJsbGliLnJlc3BvbnNlIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3Jlc3BvbnNlIiwgIm1vdmVzLnVybGxpYi5yZXNwb25zZSIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfcm9ib3RwYXJzZXIiIiIKCgpfdXJsbGliX3JvYm90cGFyc2VyX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUm9ib3RGaWxlUGFyc2VyIiwgInJvYm90cGFyc2VyIiwgInVybGxpYi5yb2JvdHBhcnNlciIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfcm9ib3RwYXJzZXJfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JvYm90cGFyc2VyLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9yb2JvdHBhcnNlcl9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5yb2JvdHBhcnNlciIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9yb2JvdHBhcnNlciIsICJtb3Zlcy51cmxsaWIucm9ib3RwYXJzZXIiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliKHR5cGVzLk1vZHVsZVR5cGUpOgoKICAgICIiIkNyZWF0ZSBhIHNpeC5tb3Zlcy51cmxsaWIgbmFtZXNwYWNlIHRoYXQgcmVzZW1ibGVzIHRoZSBQeXRob24gMyBuYW1lc3BhY2UiIiIKICAgIF9fcGF0aF9fID0gW10gICMgbWFyayBhcyBwYWNrYWdlCiAgICBwYXJzZSA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3BhcnNlIikKICAgIGVycm9yID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfZXJyb3IiKQogICAgcmVxdWVzdCA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3JlcXVlc3QiKQogICAgcmVzcG9uc2UgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9yZXNwb25zZSIpCiAgICByb2JvdHBhcnNlciA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3JvYm90cGFyc2VyIikKCiAgICBkZWYgX19kaXJfXyhzZWxmKToKICAgICAgICByZXR1cm4gWydwYXJzZScsICdlcnJvcicsICdyZXF1ZXN0JywgJ3Jlc3BvbnNlJywgJ3JvYm90cGFyc2VyJ10KCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYihfX25hbWVfXyArICIubW92ZXMudXJsbGliIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliIikKCgpkZWYgYWRkX21vdmUobW92ZSk6CiAgICAiIiJBZGQgYW4gaXRlbSB0byBzaXgubW92ZXMuIiIiCiAgICBzZXRhdHRyKF9Nb3ZlZEl0ZW1zLCBtb3ZlLm5hbWUsIG1vdmUpCgoKZGVmIHJlbW92ZV9tb3ZlKG5hbWUpOgogICAgIiIiUmVtb3ZlIGl0ZW0gZnJvbSBzaXgubW92ZXMuIiIiCiAgICB0cnk6CiAgICAgICAgZGVsYXR0cihfTW92ZWRJdGVtcywgbmFtZSkKICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRlbCBtb3Zlcy5fX2RpY3RfX1tuYW1lXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcmFpc2UgQXR0cmlidXRlRXJyb3IoIm5vIHN1Y2ggbW92ZSwgJXIiICUgKG5hbWUsKSkKCgppZiBQWTM6CiAgICBfbWV0aF9mdW5jID0gIl9fZnVuY19fIgogICAgX21ldGhfc2VsZiA9ICJfX3NlbGZfXyIKCiAgICBfZnVuY19jbG9zdXJlID0gIl9fY2xvc3VyZV9fIgogICAgX2Z1bmNfY29kZSA9ICJfX2NvZGVfXyIKICAgIF9mdW5jX2RlZmF1bHRzID0gIl9fZGVmYXVsdHNfXyIKICAgIF9mdW5jX2dsb2JhbHMgPSAiX19nbG9iYWxzX18iCmVsc2U6CiAgICBfbWV0aF9mdW5jID0gImltX2Z1bmMiCiAgICBfbWV0aF9zZWxmID0gImltX3NlbGYiCgogICAgX2Z1bmNfY2xvc3VyZSA9ICJmdW5jX2Nsb3N1cmUiCiAgICBfZnVuY19jb2RlID0gImZ1bmNfY29kZSIKICAgIF9mdW5jX2RlZmF1bHRzID0gImZ1bmNfZGVmYXVsdHMiCiAgICBfZnVuY19nbG9iYWxzID0gImZ1bmNfZ2xvYmFscyIKCgp0cnk6CiAgICBhZHZhbmNlX2l0ZXJhdG9yID0gbmV4dApleGNlcHQgTmFtZUVycm9yOgogICAgZGVmIGFkdmFuY2VfaXRlcmF0b3IoaXQpOgogICAgICAgIHJldHVybiBpdC5uZXh0KCkKbmV4dCA9IGFkdmFuY2VfaXRlcmF0b3IKCgp0cnk6CiAgICBjYWxsYWJsZSA9IGNhbGxhYmxlCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICBkZWYgY2FsbGFibGUob2JqKToKICAgICAgICByZXR1cm4gYW55KCJfX2NhbGxfXyIgaW4ga2xhc3MuX19kaWN0X18gZm9yIGtsYXNzIGluIHR5cGUob2JqKS5fX21yb19fKQoKCmlmIFBZMzoKICAgIGRlZiBnZXRfdW5ib3VuZF9mdW5jdGlvbih1bmJvdW5kKToKICAgICAgICByZXR1cm4gdW5ib3VuZAoKICAgIGNyZWF0ZV9ib3VuZF9tZXRob2QgPSB0eXBlcy5NZXRob2RUeXBlCgogICAgZGVmIGNyZWF0ZV91bmJvdW5kX21ldGhvZChmdW5jLCBjbHMpOgogICAgICAgIHJldHVybiBmdW5jCgogICAgSXRlcmF0b3IgPSBvYmplY3QKZWxzZToKICAgIGRlZiBnZXRfdW5ib3VuZF9mdW5jdGlvbih1bmJvdW5kKToKICAgICAgICByZXR1cm4gdW5ib3VuZC5pbV9mdW5jCgogICAgZGVmIGNyZWF0ZV9ib3VuZF9tZXRob2QoZnVuYywgb2JqKToKICAgICAgICByZXR1cm4gdHlwZXMuTWV0aG9kVHlwZShmdW5jLCBvYmosIG9iai5fX2NsYXNzX18pCgogICAgZGVmIGNyZWF0ZV91bmJvdW5kX21ldGhvZChmdW5jLCBjbHMpOgogICAgICAgIHJldHVybiB0eXBlcy5NZXRob2RUeXBlKGZ1bmMsIE5vbmUsIGNscykKCiAgICBjbGFzcyBJdGVyYXRvcihvYmplY3QpOgoKICAgICAgICBkZWYgbmV4dChzZWxmKToKICAgICAgICAgICAgcmV0dXJuIHR5cGUoc2VsZikuX19uZXh0X18oc2VsZikKCiAgICBjYWxsYWJsZSA9IGNhbGxhYmxlCl9hZGRfZG9jKGdldF91bmJvdW5kX2Z1bmN0aW9uLAogICAgICAgICAiIiJHZXQgdGhlIGZ1bmN0aW9uIG91dCBvZiBhIHBvc3NpYmx5IHVuYm91bmQgZnVuY3Rpb24iIiIpCgoKZ2V0X21ldGhvZF9mdW5jdGlvbiA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX21ldGhfZnVuYykKZ2V0X21ldGhvZF9zZWxmID0gb3BlcmF0b3IuYXR0cmdldHRlcihfbWV0aF9zZWxmKQpnZXRfZnVuY3Rpb25fY2xvc3VyZSA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfY2xvc3VyZSkKZ2V0X2Z1bmN0aW9uX2NvZGUgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9mdW5jX2NvZGUpCmdldF9mdW5jdGlvbl9kZWZhdWx0cyA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfZGVmYXVsdHMpCmdldF9mdW5jdGlvbl9nbG9iYWxzID0gb3BlcmF0b3IuYXR0cmdldHRlcihfZnVuY19nbG9iYWxzKQoKCmlmIFBZMzoKICAgIGRlZiBpdGVya2V5cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLmtleXMoKiprdykpCgogICAgZGVmIGl0ZXJ2YWx1ZXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC52YWx1ZXMoKiprdykpCgogICAgZGVmIGl0ZXJpdGVtcyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLml0ZW1zKCoqa3cpKQoKICAgIGRlZiBpdGVybGlzdHMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC5saXN0cygqKmt3KSkKCiAgICB2aWV3a2V5cyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigia2V5cyIpCgogICAgdmlld3ZhbHVlcyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigidmFsdWVzIikKCiAgICB2aWV3aXRlbXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoIml0ZW1zIikKZWxzZToKICAgIGRlZiBpdGVya2V5cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gZC5pdGVya2V5cygqKmt3KQoKICAgIGRlZiBpdGVydmFsdWVzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJ2YWx1ZXMoKiprdykKCiAgICBkZWYgaXRlcml0ZW1zKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJpdGVtcygqKmt3KQoKICAgIGRlZiBpdGVybGlzdHMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGQuaXRlcmxpc3RzKCoqa3cpCgogICAgdmlld2tleXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZpZXdrZXlzIikKCiAgICB2aWV3dmFsdWVzID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJ2aWV3dmFsdWVzIikKCiAgICB2aWV3aXRlbXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZpZXdpdGVtcyIpCgpfYWRkX2RvYyhpdGVya2V5cywgIlJldHVybiBhbiBpdGVyYXRvciBvdmVyIHRoZSBrZXlzIG9mIGEgZGljdGlvbmFyeS4iKQpfYWRkX2RvYyhpdGVydmFsdWVzLCAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIHZhbHVlcyBvZiBhIGRpY3Rpb25hcnkuIikKX2FkZF9kb2MoaXRlcml0ZW1zLAogICAgICAgICAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIChrZXksIHZhbHVlKSBwYWlycyBvZiBhIGRpY3Rpb25hcnkuIikKX2FkZF9kb2MoaXRlcmxpc3RzLAogICAgICAgICAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIChrZXksIFt2YWx1ZXNdKSBwYWlycyBvZiBhIGRpY3Rpb25hcnkuIikKCgppZiBQWTM6CiAgICBkZWYgYihzKToKICAgICAgICByZXR1cm4gcy5lbmNvZGUoImxhdGluLTEiKQoKICAgIGRlZiB1KHMpOgogICAgICAgIHJldHVybiBzCiAgICB1bmljaHIgPSBjaHIKICAgIGltcG9ydCBzdHJ1Y3QKICAgIGludDJieXRlID0gc3RydWN0LlN0cnVjdCgiPkIiKS5wYWNrCiAgICBkZWwgc3RydWN0CiAgICBieXRlMmludCA9IG9wZXJhdG9yLml0ZW1nZXR0ZXIoMCkKICAgIGluZGV4Ynl0ZXMgPSBvcGVyYXRvci5nZXRpdGVtCiAgICBpdGVyYnl0ZXMgPSBpdGVyCiAgICBpbXBvcnQgaW8KICAgIFN0cmluZ0lPID0gaW8uU3RyaW5nSU8KICAgIEJ5dGVzSU8gPSBpby5CeXRlc0lPCiAgICBfYXNzZXJ0Q291bnRFcXVhbCA9ICJhc3NlcnRDb3VudEVxdWFsIgogICAgaWYgc3lzLnZlcnNpb25faW5mb1sxXSA8PSAxOgogICAgICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleHAiCiAgICAgICAgX2Fzc2VydFJlZ2V4ID0gImFzc2VydFJlZ2V4cE1hdGNoZXMiCiAgICBlbHNlOgogICAgICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleCIKICAgICAgICBfYXNzZXJ0UmVnZXggPSAiYXNzZXJ0UmVnZXgiCmVsc2U6CiAgICBkZWYgYihzKToKICAgICAgICByZXR1cm4gcwogICAgIyBXb3JrYXJvdW5kIGZvciBzdGFuZGFsb25lIGJhY2tzbGFzaAoKICAgIGRlZiB1KHMpOgogICAgICAgIHJldHVybiB1bmljb2RlKHMucmVwbGFjZShyJ1xcJywgcidcXFxcJyksICJ1bmljb2RlX2VzY2FwZSIpCiAgICB1bmljaHIgPSB1bmljaHIKICAgIGludDJieXRlID0gY2hyCgogICAgZGVmIGJ5dGUyaW50KGJzKToKICAgICAgICByZXR1cm4gb3JkKGJzWzBdKQoKICAgIGRlZiBpbmRleGJ5dGVzKGJ1ZiwgaSk6CiAgICAgICAgcmV0dXJuIG9yZChidWZbaV0pCiAgICBpdGVyYnl0ZXMgPSBmdW5jdG9vbHMucGFydGlhbChpdGVydG9vbHMuaW1hcCwgb3JkKQogICAgaW1wb3J0IFN0cmluZ0lPCiAgICBTdHJpbmdJTyA9IEJ5dGVzSU8gPSBTdHJpbmdJTy5TdHJpbmdJTwogICAgX2Fzc2VydENvdW50RXF1YWwgPSAiYXNzZXJ0SXRlbXNFcXVhbCIKICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleHAiCiAgICBfYXNzZXJ0UmVnZXggPSAiYXNzZXJ0UmVnZXhwTWF0Y2hlcyIKX2FkZF9kb2MoYiwgIiIiQnl0ZSBsaXRlcmFsIiIiKQpfYWRkX2RvYyh1LCAiIiJUZXh0IGxpdGVyYWwiIiIpCgoKZGVmIGFzc2VydENvdW50RXF1YWwoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgIHJldHVybiBnZXRhdHRyKHNlbGYsIF9hc3NlcnRDb3VudEVxdWFsKSgqYXJncywgKiprd2FyZ3MpCgoKZGVmIGFzc2VydFJhaXNlc1JlZ2V4KHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICByZXR1cm4gZ2V0YXR0cihzZWxmLCBfYXNzZXJ0UmFpc2VzUmVnZXgpKCphcmdzLCAqKmt3YXJncykKCgpkZWYgYXNzZXJ0UmVnZXgoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgIHJldHVybiBnZXRhdHRyKHNlbGYsIF9hc3NlcnRSZWdleCkoKmFyZ3MsICoqa3dhcmdzKQoKCmlmIFBZMzoKICAgIGV4ZWNfID0gZ2V0YXR0cihtb3Zlcy5idWlsdGlucywgImV4ZWMiKQoKICAgIGRlZiByZXJhaXNlKHRwLCB2YWx1ZSwgdGI9Tm9uZSk6CiAgICAgICAgaWYgdmFsdWUgaXMgTm9uZToKICAgICAgICAgICAgdmFsdWUgPSB0cCgpCiAgICAgICAgaWYgdmFsdWUuX190cmFjZWJhY2tfXyBpcyBub3QgdGI6CiAgICAgICAgICAgIHJhaXNlIHZhbHVlLndpdGhfdHJhY2ViYWNrKHRiKQogICAgICAgIHJhaXNlIHZhbHVlCgplbHNlOgogICAgZGVmIGV4ZWNfKF9jb2RlXywgX2dsb2JzXz1Ob25lLCBfbG9jc189Tm9uZSk6CiAgICAgICAgIiIiRXhlY3V0ZSBjb2RlIGluIGEgbmFtZXNwYWNlLiIiIgogICAgICAgIGlmIF9nbG9ic18gaXMgTm9uZToKICAgICAgICAgICAgZnJhbWUgPSBzeXMuX2dldGZyYW1lKDEpCiAgICAgICAgICAgIF9nbG9ic18gPSBmcmFtZS5mX2dsb2JhbHMKICAgICAgICAgICAgaWYgX2xvY3NfIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBfbG9jc18gPSBmcmFtZS5mX2xvY2FscwogICAgICAgICAgICBkZWwgZnJhbWUKICAgICAgICBlbGlmIF9sb2NzXyBpcyBOb25lOgogICAgICAgICAgICBfbG9jc18gPSBfZ2xvYnNfCiAgICAgICAgZXhlYygiIiJleGVjIF9jb2RlXyBpbiBfZ2xvYnNfLCBfbG9jc18iIiIpCgogICAgZXhlY18oIiIiZGVmIHJlcmFpc2UodHAsIHZhbHVlLCB0Yj1Ob25lKToKICAgIHJhaXNlIHRwLCB2YWx1ZSwgdGIKIiIiKQoKCmlmIHN5cy52ZXJzaW9uX2luZm9bOjJdID09ICgzLCAyKToKICAgIGV4ZWNfKCIiImRlZiByYWlzZV9mcm9tKHZhbHVlLCBmcm9tX3ZhbHVlKToKICAgIGlmIGZyb21fdmFsdWUgaXMgTm9uZToKICAgICAgICByYWlzZSB2YWx1ZQogICAgcmFpc2UgdmFsdWUgZnJvbSBmcm9tX3ZhbHVlCiIiIikKZWxpZiBzeXMudmVyc2lvbl9pbmZvWzoyXSA+ICgzLCAyKToKICAgIGV4ZWNfKCIiImRlZiByYWlzZV9mcm9tKHZhbHVlLCBmcm9tX3ZhbHVlKToKICAgIHJhaXNlIHZhbHVlIGZyb20gZnJvbV92YWx1ZQoiIiIpCmVsc2U6CiAgICBkZWYgcmFpc2VfZnJvbSh2YWx1ZSwgZnJvbV92YWx1ZSk6CiAgICAgICAgcmFpc2UgdmFsdWUKCgpwcmludF8gPSBnZXRhdHRyKG1vdmVzLmJ1aWx0aW5zLCAicHJpbnQiLCBOb25lKQppZiBwcmludF8gaXMgTm9uZToKICAgIGRlZiBwcmludF8oKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAiIiJUaGUgbmV3LXN0eWxlIHByaW50IGZ1bmN0aW9uIGZvciBQeXRob24gMi40IGFuZCAyLjUuIiIiCiAgICAgICAgZnAgPSBrd2FyZ3MucG9wKCJmaWxlIiwgc3lzLnN0ZG91dCkKICAgICAgICBpZiBmcCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZGVmIHdyaXRlKGRhdGEpOgogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShkYXRhLCBiYXNlc3RyaW5nKToKICAgICAgICAgICAgICAgIGRhdGEgPSBzdHIoZGF0YSkKICAgICAgICAgICAgIyBJZiB0aGUgZmlsZSBoYXMgYW4gZW5jb2RpbmcsIGVuY29kZSB1bmljb2RlIHdpdGggaXQuCiAgICAgICAgICAgIGlmIChpc2luc3RhbmNlKGZwLCBmaWxlKSBhbmQKICAgICAgICAgICAgICAgICAgICBpc2luc3RhbmNlKGRhdGEsIHVuaWNvZGUpIGFuZAogICAgICAgICAgICAgICAgICAgIGZwLmVuY29kaW5nIGlzIG5vdCBOb25lKToKICAgICAgICAgICAgICAgIGVycm9ycyA9IGdldGF0dHIoZnAsICJlcnJvcnMiLCBOb25lKQogICAgICAgICAgICAgICAgaWYgZXJyb3JzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzID0gInN0cmljdCIKICAgICAgICAgICAgICAgIGRhdGEgPSBkYXRhLmVuY29kZShmcC5lbmNvZGluZywgZXJyb3JzKQogICAgICAgICAgICBmcC53cml0ZShkYXRhKQogICAgICAgIHdhbnRfdW5pY29kZSA9IEZhbHNlCiAgICAgICAgc2VwID0ga3dhcmdzLnBvcCgic2VwIiwgTm9uZSkKICAgICAgICBpZiBzZXAgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc2VwLCB1bmljb2RlKToKICAgICAgICAgICAgICAgIHdhbnRfdW5pY29kZSA9IFRydWUKICAgICAgICAgICAgZWxpZiBub3QgaXNpbnN0YW5jZShzZXAsIHN0cik6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoInNlcCBtdXN0IGJlIE5vbmUgb3IgYSBzdHJpbmciKQogICAgICAgIGVuZCA9IGt3YXJncy5wb3AoImVuZCIsIE5vbmUpCiAgICAgICAgaWYgZW5kIGlzIG5vdCBOb25lOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGVuZCwgdW5pY29kZSk6CiAgICAgICAgICAgICAgICB3YW50X3VuaWNvZGUgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2UoZW5kLCBzdHIpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJlbmQgbXVzdCBiZSBOb25lIG9yIGEgc3RyaW5nIikKICAgICAgICBpZiBrd2FyZ3M6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiaW52YWxpZCBrZXl3b3JkIGFyZ3VtZW50cyB0byBwcmludCgpIikKICAgICAgICBpZiBub3Qgd2FudF91bmljb2RlOgogICAgICAgICAgICBmb3IgYXJnIGluIGFyZ3M6CiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGFyZywgdW5pY29kZSk6CiAgICAgICAgICAgICAgICAgICAgd2FudF91bmljb2RlID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgaWYgd2FudF91bmljb2RlOgogICAgICAgICAgICBuZXdsaW5lID0gdW5pY29kZSgiXG4iKQogICAgICAgICAgICBzcGFjZSA9IHVuaWNvZGUoIiAiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG5ld2xpbmUgPSAiXG4iCiAgICAgICAgICAgIHNwYWNlID0gIiAiCiAgICAgICAgaWYgc2VwIGlzIE5vbmU6CiAgICAgICAgICAgIHNlcCA9IHNwYWNlCiAgICAgICAgaWYgZW5kIGlzIE5vbmU6CiAgICAgICAgICAgIGVuZCA9IG5ld2xpbmUKICAgICAgICBmb3IgaSwgYXJnIGluIGVudW1lcmF0ZShhcmdzKToKICAgICAgICAgICAgaWYgaToKICAgICAgICAgICAgICAgIHdyaXRlKHNlcCkKICAgICAgICAgICAgd3JpdGUoYXJnKQogICAgICAgIHdyaXRlKGVuZCkKaWYgc3lzLnZlcnNpb25faW5mb1s6Ml0gPCAoMywgMyk6CiAgICBfcHJpbnQgPSBwcmludF8KCiAgICBkZWYgcHJpbnRfKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgZnAgPSBrd2FyZ3MuZ2V0KCJmaWxlIiwgc3lzLnN0ZG91dCkKICAgICAgICBmbHVzaCA9IGt3YXJncy5wb3AoImZsdXNoIiwgRmFsc2UpCiAgICAgICAgX3ByaW50KCphcmdzLCAqKmt3YXJncykKICAgICAgICBpZiBmbHVzaCBhbmQgZnAgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGZwLmZsdXNoKCkKCl9hZGRfZG9jKHJlcmFpc2UsICIiIlJlcmFpc2UgYW4gZXhjZXB0aW9uLiIiIikKCmlmIHN5cy52ZXJzaW9uX2luZm9bMDoyXSA8ICgzLCA0KToKICAgIGRlZiB3cmFwcyh3cmFwcGVkLCBhc3NpZ25lZD1mdW5jdG9vbHMuV1JBUFBFUl9BU1NJR05NRU5UUywKICAgICAgICAgICAgICB1cGRhdGVkPWZ1bmN0b29scy5XUkFQUEVSX1VQREFURVMpOgogICAgICAgIGRlZiB3cmFwcGVyKGYpOgogICAgICAgICAgICBmID0gZnVuY3Rvb2xzLndyYXBzKHdyYXBwZWQsIGFzc2lnbmVkLCB1cGRhdGVkKShmKQogICAgICAgICAgICBmLl9fd3JhcHBlZF9fID0gd3JhcHBlZAogICAgICAgICAgICByZXR1cm4gZgogICAgICAgIHJldHVybiB3cmFwcGVyCmVsc2U6CiAgICB3cmFwcyA9IGZ1bmN0b29scy53cmFwcwoKCmRlZiB3aXRoX21ldGFjbGFzcyhtZXRhLCAqYmFzZXMpOgogICAgIiIiQ3JlYXRlIGEgYmFzZSBjbGFzcyB3aXRoIGEgbWV0YWNsYXNzLiIiIgogICAgIyBUaGlzIHJlcXVpcmVzIGEgYml0IG9mIGV4cGxhbmF0aW9uOiB0aGUgYmFzaWMgaWRlYSBpcyB0byBtYWtlIGEgZHVtbXkKICAgICMgbWV0YWNsYXNzIGZvciBvbmUgbGV2ZWwgb2YgY2xhc3MgaW5zdGFudGlhdGlvbiB0aGF0IHJlcGxhY2VzIGl0c2VsZiB3aXRoCiAgICAjIHRoZSBhY3R1YWwgbWV0YWNsYXNzLgogICAgY2xhc3MgbWV0YWNsYXNzKG1ldGEpOgoKICAgICAgICBkZWYgX19uZXdfXyhjbHMsIG5hbWUsIHRoaXNfYmFzZXMsIGQpOgogICAgICAgICAgICByZXR1cm4gbWV0YShuYW1lLCBiYXNlcywgZCkKICAgIHJldHVybiB0eXBlLl9fbmV3X18obWV0YWNsYXNzLCAndGVtcG9yYXJ5X2NsYXNzJywgKCksIHt9KQoKCmRlZiBhZGRfbWV0YWNsYXNzKG1ldGFjbGFzcyk6CiAgICAiIiJDbGFzcyBkZWNvcmF0b3IgZm9yIGNyZWF0aW5nIGEgY2xhc3Mgd2l0aCBhIG1ldGFjbGFzcy4iIiIKICAgIGRlZiB3cmFwcGVyKGNscyk6CiAgICAgICAgb3JpZ192YXJzID0gY2xzLl9fZGljdF9fLmNvcHkoKQogICAgICAgIHNsb3RzID0gb3JpZ192YXJzLmdldCgnX19zbG90c19fJykKICAgICAgICBpZiBzbG90cyBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzbG90cywgc3RyKToKICAgICAgICAgICAgICAgIHNsb3RzID0gW3Nsb3RzXQogICAgICAgICAgICBmb3Igc2xvdHNfdmFyIGluIHNsb3RzOgogICAgICAgICAgICAgICAgb3JpZ192YXJzLnBvcChzbG90c192YXIpCiAgICAgICAgb3JpZ192YXJzLnBvcCgnX19kaWN0X18nLCBOb25lKQogICAgICAgIG9yaWdfdmFycy5wb3AoJ19fd2Vha3JlZl9fJywgTm9uZSkKICAgICAgICByZXR1cm4gbWV0YWNsYXNzKGNscy5fX25hbWVfXywgY2xzLl9fYmFzZXNfXywgb3JpZ192YXJzKQogICAgcmV0dXJuIHdyYXBwZXIKCgpkZWYgcHl0aG9uXzJfdW5pY29kZV9jb21wYXRpYmxlKGtsYXNzKToKICAgICIiIgogICAgQSBkZWNvcmF0b3IgdGhhdCBkZWZpbmVzIF9fdW5pY29kZV9fIGFuZCBfX3N0cl9fIG1ldGhvZHMgdW5kZXIgUHl0aG9uIDIuCiAgICBVbmRlciBQeXRob24gMyBpdCBkb2VzIG5vdGhpbmcuCgogICAgVG8gc3VwcG9ydCBQeXRob24gMiBhbmQgMyB3aXRoIGEgc2luZ2xlIGNvZGUgYmFzZSwgZGVmaW5lIGEgX19zdHJfXyBtZXRob2QKICAgIHJldHVybmluZyB0ZXh0IGFuZCBhcHBseSB0aGlzIGRlY29yYXRvciB0byB0aGUgY2xhc3MuCiAgICAiIiIKICAgIGlmIFBZMjoKICAgICAgICBpZiAnX19zdHJfXycgbm90IGluIGtsYXNzLl9fZGljdF9fOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJAcHl0aG9uXzJfdW5pY29kZV9jb21wYXRpYmxlIGNhbm5vdCBiZSBhcHBsaWVkICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidG8gJXMgYmVjYXVzZSBpdCBkb2Vzbid0IGRlZmluZSBfX3N0cl9fKCkuIiAlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2xhc3MuX19uYW1lX18pCiAgICAgICAga2xhc3MuX191bmljb2RlX18gPSBrbGFzcy5fX3N0cl9fCiAgICAgICAga2xhc3MuX19zdHJfXyA9IGxhbWJkYSBzZWxmOiBzZWxmLl9fdW5pY29kZV9fKCkuZW5jb2RlKCd1dGYtOCcpCiAgICByZXR1cm4ga2xhc3MKCgojIENvbXBsZXRlIHRoZSBtb3ZlcyBpbXBsZW1lbnRhdGlvbi4KIyBUaGlzIGNvZGUgaXMgYXQgdGhlIGVuZCBvZiB0aGlzIG1vZHVsZSB0byBzcGVlZCB1cCBtb2R1bGUgbG9hZGluZy4KIyBUdXJuIHRoaXMgbW9kdWxlIGludG8gYSBwYWNrYWdlLgpfX3BhdGhfXyA9IFtdICAjIHJlcXVpcmVkIGZvciBQRVAgMzAyIGFuZCBQRVAgNDUxCl9fcGFja2FnZV9fID0gX19uYW1lX18gICMgc2VlIFBFUCAzNjYgQFJlc2VydmVkQXNzaWdubWVudAppZiBnbG9iYWxzKCkuZ2V0KCJfX3NwZWNfXyIpIGlzIG5vdCBOb25lOgogICAgX19zcGVjX18uc3VibW9kdWxlX3NlYXJjaF9sb2NhdGlvbnMgPSBbXSAgIyBQRVAgNDUxIEBVbmRlZmluZWRWYXJpYWJsZQojIFJlbW92ZSBvdGhlciBzaXggbWV0YSBwYXRoIGltcG9ydGVycywgc2luY2UgdGhleSBjYXVzZSBwcm9ibGVtcy4gVGhpcyBjYW4KIyBoYXBwZW4gaWYgc2l4IGlzIHJlbW92ZWQgZnJvbSBzeXMubW9kdWxlcyBhbmQgdGhlbiByZWxvYWRlZC4gKFNldHVwdG9vbHMgZG9lcwojIHRoaXMgZm9yIHNvbWUgcmVhc29uLikKaWYgc3lzLm1ldGFfcGF0aDoKICAgIGZvciBpLCBpbXBvcnRlciBpbiBlbnVtZXJhdGUoc3lzLm1ldGFfcGF0aCk6CiAgICAgICAgIyBIZXJlJ3Mgc29tZSByZWFsIG5hc3RpbmVzczogQW5vdGhlciAiaW5zdGFuY2UiIG9mIHRoZSBzaXggbW9kdWxlIG1pZ2h0CiAgICAgICAgIyBiZSBmbG9hdGluZyBhcm91bmQuIFRoZXJlZm9yZSwgd2UgY2FuJ3QgdXNlIGlzaW5zdGFuY2UoKSB0byBjaGVjayBmb3IKICAgICAgICAjIHRoZSBzaXggbWV0YSBwYXRoIGltcG9ydGVyLCBzaW5jZSB0aGUgb3RoZXIgc2l4IGluc3RhbmNlIHdpbGwgaGF2ZQogICAgICAgICMgaW5zZXJ0ZWQgYW4gaW1wb3J0ZXIgd2l0aCBkaWZmZXJlbnQgY2xhc3MuCiAgICAgICAgaWYgKHR5cGUoaW1wb3J0ZXIpLl9fbmFtZV9fID09ICJfU2l4TWV0YVBhdGhJbXBvcnRlciIgYW5kCiAgICAgICAgICAgICAgICBpbXBvcnRlci5uYW1lID09IF9fbmFtZV9fKToKICAgICAgICAgICAgZGVsIHN5cy5tZXRhX3BhdGhbaV0KICAgICAgICAgICAgYnJlYWsKICAgIGRlbCBpLCBpbXBvcnRlcgojIEZpbmFsbHksIGFkZCB0aGUgaW1wb3J0ZXIgdG8gdGhlIG1ldGEgcGF0aCBpbXBvcnQgaG9vay4Kc3lzLm1ldGFfcGF0aC5hcHBlbmQoX2ltcG9ydGVyKQpQSwECFAMUAAAAAADMuytLj6fxUncAAAB3AAAAEwAAAAAAAAAAAAAAgAEAAAAAYW5zaWJsZS9fX2luaXRfXy5weVBLAQIUAxQAAAAAAMy7K0udxfFrSAAAAEgAAAAgAAAAAAAAAAAAAACAAagAAABhbnNpYmxlL21vZHVsZV91dGlscy9fX2luaXRfXy5weVBLAQIUAxQAAAAAAMy7K0tvllkKWi0AAFotAAApAAAAAAAAAAAAAACAAS4BAABhbnNpYmxlX21vZHVsZV9uZXRhcHBfZV9zdG9yYWdlX3N5c3RlbS5weVBLAQIUAxQAAAAAAMy7K0s73zmVMIoBADCKAQAdAAAAAAAAAAAAAACAAc8uAABhbnNpYmxlL21vZHVsZV91dGlscy9iYXNpYy5weVBLAQIUAxQAAAAAAMy7K0sE9Y6L6A0AAOgNAAAbAAAAAAAAAAAAAACAATq5AQBhbnNpYmxlL21vZHVsZV91dGlscy9hcGkucHlQSwECFAMUAAAAAADMuytLJdy0fhMQAAATEAAAIgAAAAAAAAAAAAAAgAFbxwEAYW5zaWJsZS9tb2R1bGVfdXRpbHMvcHljb21wYXQyNC5weVBLAQIUAxQAAAAAAMy7K0tdhrVvO60AADutAAAcAAAAAAAAAAAAAACAAa7XAQBhbnNpYmxlL21vZHVsZV91dGlscy91cmxzLnB5UEsBAhQDFAAAAAAAzLsrSxgXcvUBEQAAAREAACQAAAAAAAAAAAAAAIABI4UCAGFuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fX2luaXRfXy5weVBLAQIUAxQAAAAAAMy7K0u12AQGJTAAACUwAAAdAAAAAAAAAAAAAACAAWaWAgBhbnNpYmxlL21vZHVsZV91dGlscy9fdGV4dC5weVBLAQIUAxQAAAAAAMy7K0s44sfRkXUAAJF1AAAgAAAAAAAAAAAAAACAAcbGAgBhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeC5weVBLBQYAAAAACgAKAP8CAACVPAMAAAA="""
def invoke_module(module, modlib_path, json_params):
    pythonpath = os.environ.get('PYTHONPATH')
    if pythonpath:
        os.environ['PYTHONPATH'] = ':'.join((modlib_path, pythonpath))
    else:
        os.environ['PYTHONPATH'] = modlib_path
    p = subprocess.Popen(['/usr/bin/python', module], env=os.environ, shell=False, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
    (stdout, stderr) = p.communicate(json_params)
    if not isinstance(stderr, (bytes, unicode)):
        stderr = stderr.read()
    if not isinstance(stdout, (bytes, unicode)):
        stdout = stdout.read()
    if PY3:
        sys.stderr.buffer.write(stderr)
        sys.stdout.buffer.write(stdout)
    else:
        sys.stderr.write(stderr)
        sys.stdout.write(stdout)
    return p.returncode
def debug(command, zipped_mod, json_params):
    basedir = os.path.join(os.path.abspath(os.path.dirname(__file__)), 'debug_dir')
    args_path = os.path.join(basedir, 'args')
    script_path = os.path.join(basedir, 'ansible_module_netapp_e_storage_system.py')
    if command == 'explode':
        z = zipfile.ZipFile(zipped_mod)
        for filename in z.namelist():
            if filename.startswith('/'):
                raise Exception('Something wrong with this module zip file: should not contain absolute paths')
            dest_filename = os.path.join(basedir, filename)
            if dest_filename.endswith(os.path.sep) and not os.path.exists(dest_filename):
                os.makedirs(dest_filename)
            else:
                directory = os.path.dirname(dest_filename)
                if not os.path.exists(directory):
                    os.makedirs(directory)
                f = open(dest_filename, 'wb')
                f.write(z.read(filename))
                f.close()
        f = open(args_path, 'wb')
        f.write(json_params)
        f.close()
        print('Module expanded into:')
        print('%s' % basedir)
        exitcode = 0
    elif command == 'execute':
        pythonpath = os.environ.get('PYTHONPATH')
        if pythonpath:
            os.environ['PYTHONPATH'] = ':'.join((basedir, pythonpath))
        else:
            os.environ['PYTHONPATH'] = basedir
        p = subprocess.Popen(['/usr/bin/python', script_path, args_path],
                env=os.environ, shell=False, stdout=subprocess.PIPE,
                stderr=subprocess.PIPE, stdin=subprocess.PIPE)
        (stdout, stderr) = p.communicate()
        if not isinstance(stderr, (bytes, unicode)):
            stderr = stderr.read()
        if not isinstance(stdout, (bytes, unicode)):
            stdout = stdout.read()
        if PY3:
            sys.stderr.buffer.write(stderr)
            sys.stdout.buffer.write(stdout)
        else:
            sys.stderr.write(stderr)
            sys.stdout.write(stdout)
        return p.returncode
    elif command == 'excommunicate':
        sys.argv = ['netapp_e_storage_system', args_path]
        sys.path.insert(0, basedir)
        from ansible_module_netapp_e_storage_system import main
        main()
        print('WARNING: Module returned to wrapper instead of exiting')
        sys.exit(1)
    else:
        print('WARNING: Unknown debug command.  Doing nothing.')
        exitcode = 0
    return exitcode
if __name__ == '__main__':
    ANSIBALLZ_PARAMS = json.dumps({"ANSIBLE_MODULE_ARGS": json.load(sys.stdin)})
    if PY3:
        ANSIBALLZ_PARAMS = ANSIBALLZ_PARAMS.encode('utf-8')
    try:
        temp_path = tempfile.mkdtemp(prefix='ansible_')
        zipped_mod = os.path.join(temp_path, 'ansible_modlib.zip')
        modlib = open(zipped_mod, 'wb')
        modlib.write(base64.b64decode(ZIPDATA))
        modlib.close()
        if len(sys.argv) == 2:
            exitcode = debug(sys.argv[1], zipped_mod, ANSIBALLZ_PARAMS)
        else:
            z = zipfile.ZipFile(zipped_mod, mode='r')
            module = os.path.join(temp_path, 'ansible_module_netapp_e_storage_system.py')
            f = open(module, 'wb')
            f.write(z.read('ansible_module_netapp_e_storage_system.py'))
            f.close()
            z = zipfile.ZipFile(zipped_mod, mode='a')
            sitecustomize = u'import sys\nsys.path.insert(0,"%s")\n' %  zipped_mod
            sitecustomize = sitecustomize.encode('utf-8')
            zinfo = zipfile.ZipInfo()
            zinfo.filename = 'sitecustomize.py'
            zinfo.date_time = ( 2017, 9, 11, 23, 30, 24)
            z.writestr(zinfo, sitecustomize)
            z.close()
            exitcode = invoke_module(module, zipped_mod, ANSIBALLZ_PARAMS)
    finally:
        try:
            shutil.rmtree(temp_path)
        except OSError:
            pass
    sys.exit(exitcode)