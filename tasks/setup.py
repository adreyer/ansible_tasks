#!/usr/bin/python
# -*- coding: utf-8 -*-
ANSIBALLZ_WRAPPER = True # For test-module script to tell this is a ANSIBALLZ_WRAPPER
import os
import os.path
import sys
import __main__
scriptdir = None
try:
    scriptdir = os.path.dirname(os.path.abspath(__main__.__file__))
except (AttributeError, OSError):
    pass
if scriptdir is not None:
    sys.path = [p for p in sys.path if p != scriptdir]
import base64
import json
import shutil
import zipfile
import tempfile
import subprocess
if sys.version_info < (3,):
    bytes = str
    PY3 = False
else:
    unicode = str
    PY3 = True
try:
    from io import BytesIO as IOStream
except ImportError:
    from StringIO import StringIO as IOStream
ZIPDATA = """UEsDBBQAAAAAAMu7K0uPp/FSdwAAAHcAAAATAAAAYW5zaWJsZS9fX2luaXRfXy5weWZyb20gcGtndXRpbCBpbXBvcnQgZXh0ZW5kX3BhdGgKX19wYXRoX189ZXh0ZW5kX3BhdGgoX19wYXRoX18sX19uYW1lX18pCl9fdmVyc2lvbl9fPSIyLjQuMCIKX19hdXRob3JfXz0iQW5zaWJsZSwgSW5jLiIKUEsDBBQAAAAAAMu7K0udxfFrSAAAAEgAAAAgAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX19pbml0X18ucHlmcm9tIHBrZ3V0aWwgaW1wb3J0IGV4dGVuZF9wYXRoCl9fcGF0aF9fPWV4dGVuZF9wYXRoKF9fcGF0aF9fLF9fbmFtZV9fKQpQSwMEFAAAAAAAy7srS+mMp9IPKwAADysAABcAAABhbnNpYmxlX21vZHVsZV9zZXR1cC5weSMhL3Vzci9iaW4vcHl0aG9uCiMgLSotIGNvZGluZzogdXRmLTggLSotCgojIChjKSAyMDEyLCBNaWNoYWVsIERlSGFhbiA8bWljaGFlbC5kZWhhYW5AZ21haWwuY29tPgojCiMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKQU5TSUJMRV9NRVRBREFUQSA9IHsnbWV0YWRhdGFfdmVyc2lvbic6ICcxLjAnLAogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiBbJ3N0YWJsZWludGVyZmFjZSddLAogICAgICAgICAgICAgICAgICAgICdzdXBwb3J0ZWRfYnknOiAnY29yZSd9CgoKRE9DVU1FTlRBVElPTiA9ICcnJwotLS0KbW9kdWxlOiBzZXR1cAp2ZXJzaW9uX2FkZGVkOiBoaXN0b3JpY2FsCnNob3J0X2Rlc2NyaXB0aW9uOiBHYXRoZXJzIGZhY3RzIGFib3V0IHJlbW90ZSBob3N0cwpvcHRpb25zOgogICAgZ2F0aGVyX3N1YnNldDoKICAgICAgICB2ZXJzaW9uX2FkZGVkOiAiMi4xIgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtICJpZiBzdXBwbGllZCwgcmVzdHJpY3QgdGhlIGFkZGl0aW9uYWwgZmFjdHMgY29sbGVjdGVkIHRvIHRoZSBnaXZlbiBzdWJzZXQuCiAgICAgICAgICAgICAgUG9zc2libGUgdmFsdWVzOiBhbGwsIGhhcmR3YXJlLCBuZXR3b3JrLCB2aXJ0dWFsLCBvaGFpLCBhbmQKICAgICAgICAgICAgICBmYWN0ZXIgQ2FuIHNwZWNpZnkgYSBsaXN0IG9mIHZhbHVlcyB0byBzcGVjaWZ5IGEgbGFyZ2VyIHN1YnNldC4KICAgICAgICAgICAgICBWYWx1ZXMgY2FuIGFsc28gYmUgdXNlZCB3aXRoIGFuIGluaXRpYWwgQyghKSB0byBzcGVjaWZ5IHRoYXQKICAgICAgICAgICAgICB0aGF0IHNwZWNpZmljIHN1YnNldCBzaG91bGQgbm90IGJlIGNvbGxlY3RlZC4gIEZvciBpbnN0YW5jZToKICAgICAgICAgICAgICAhaGFyZHdhcmUsICFuZXR3b3JrLCAhdmlydHVhbCwgIW9oYWksICFmYWN0ZXIuICBOb3RlIHRoYXQgYSBmZXcKICAgICAgICAgICAgICBmYWN0cyBhcmUgYWx3YXlzIGNvbGxlY3RlZC4gIFVzZSB0aGUgZmlsdGVyIHBhcmFtZXRlciBpZiB5b3UgZG8KICAgICAgICAgICAgICBub3Qgd2FudCB0byBkaXNwbGF5IHRob3NlLiIKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiAnYWxsJwogICAgZ2F0aGVyX3RpbWVvdXQ6CiAgICAgICAgdmVyc2lvbl9hZGRlZDogIjIuMiIKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSAiU2V0IHRoZSBkZWZhdWx0IHRpbWVvdXQgaW4gc2Vjb25kcyBmb3IgaW5kaXZpZHVhbCBmYWN0IGdhdGhlcmluZyIKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiAxMAogICAgZmlsdGVyOgogICAgICAgIHZlcnNpb25fYWRkZWQ6ICIxLjEiCiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gaWYgc3VwcGxpZWQsIG9ubHkgcmV0dXJuIGZhY3RzIHRoYXQgbWF0Y2ggdGhpcyBzaGVsbC1zdHlsZSAoZm5tYXRjaCkgd2lsZGNhcmQuCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgICAgZGVmYXVsdDogJyonCiAgICBmYWN0X3BhdGg6CiAgICAgICAgdmVyc2lvbl9hZGRlZDogIjEuMyIKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSBwYXRoIHVzZWQgZm9yIGxvY2FsIGFuc2libGUgZmFjdHMgKCouZmFjdCkgLSBmaWxlcyBpbiB0aGlzIGRpcgogICAgICAgICAgICAgIHdpbGwgYmUgcnVuIChpZiBleGVjdXRhYmxlKSBhbmQgdGhlaXIgcmVzdWx0cyBiZSBhZGRlZCB0byBhbnNpYmxlX2xvY2FsIGZhY3RzCiAgICAgICAgICAgICAgaWYgYSBmaWxlIGlzIG5vdCBleGVjdXRhYmxlIGl0IGlzIHJlYWQuIENoZWNrIG5vdGVzIGZvciBXaW5kb3dzIG9wdGlvbnMuIChmcm9tIDIuMSBvbikKICAgICAgICAgICAgICBGaWxlL3Jlc3VsdHMgZm9ybWF0IGNhbiBiZSBqc29uIG9yIGluaS1mb3JtYXQKICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICBkZWZhdWx0OiAnL2V0Yy9hbnNpYmxlL2ZhY3RzLmQnCmRlc2NyaXB0aW9uOgogICAgIC0gVGhpcyBtb2R1bGUgaXMgYXV0b21hdGljYWxseSBjYWxsZWQgYnkgcGxheWJvb2tzIHRvIGdhdGhlciB1c2VmdWwKICAgICAgIHZhcmlhYmxlcyBhYm91dCByZW1vdGUgaG9zdHMgdGhhdCBjYW4gYmUgdXNlZCBpbiBwbGF5Ym9va3MuIEl0IGNhbiBhbHNvIGJlCiAgICAgICBleGVjdXRlZCBkaXJlY3RseSBieSBDKC91c3IvYmluL2Fuc2libGUpIHRvIGNoZWNrIHdoYXQgdmFyaWFibGVzIGFyZQogICAgICAgYXZhaWxhYmxlIHRvIGEgaG9zdC4gQW5zaWJsZSBwcm92aWRlcyBtYW55IEkoZmFjdHMpIGFib3V0IHRoZSBzeXN0ZW0sCiAgICAgICBhdXRvbWF0aWNhbGx5Lgpub3RlczoKICAgIC0gTW9yZSBhbnNpYmxlIGZhY3RzIHdpbGwgYmUgYWRkZWQgd2l0aCBzdWNjZXNzaXZlIHJlbGVhc2VzLiBJZiBJKGZhY3Rlcikgb3IKICAgICAgSShvaGFpKSBhcmUgaW5zdGFsbGVkLCB2YXJpYWJsZXMgZnJvbSB0aGVzZSBwcm9ncmFtcyB3aWxsIGFsc28gYmUgc25hcHNob3R0ZWQKICAgICAgaW50byB0aGUgSlNPTiBmaWxlIGZvciB1c2FnZSBpbiB0ZW1wbGF0aW5nLiBUaGVzZSB2YXJpYWJsZXMgYXJlIHByZWZpeGVkCiAgICAgIHdpdGggQyhmYWN0ZXJfKSBhbmQgQyhvaGFpXykgc28gaXQncyBlYXN5IHRvIHRlbGwgdGhlaXIgc291cmNlLiBBbGwgdmFyaWFibGVzIGFyZQogICAgICBidWJibGVkIHVwIHRvIHRoZSBjYWxsZXIuIFVzaW5nIHRoZSBhbnNpYmxlIGZhY3RzIGFuZCBjaG9vc2luZyB0byBub3QKICAgICAgaW5zdGFsbCBJKGZhY3RlcikgYW5kIEkob2hhaSkgbWVhbnMgeW91IGNhbiBhdm9pZCBSdWJ5LWRlcGVuZGVuY2llcyBvbiB5b3VyCiAgICAgIHJlbW90ZSBzeXN0ZW1zLiAoU2VlIGFsc28gTShmYWN0ZXIpIGFuZCBNKG9oYWkpLikKICAgIC0gVGhlIGZpbHRlciBvcHRpb24gZmlsdGVycyBvbmx5IHRoZSBmaXJzdCBsZXZlbCBzdWJrZXkgYmVsb3cgYW5zaWJsZV9mYWN0cy4KICAgIC0gSWYgdGhlIHRhcmdldCBob3N0IGlzIFdpbmRvd3MsIHlvdSB3aWxsIG5vdCBjdXJyZW50bHkgaGF2ZSB0aGUgYWJpbGl0eSB0byB1c2UKICAgICAgQyhmaWx0ZXIpIGFzIHRoaXMgaXMgcHJvdmlkZWQgYnkgYSBzaW1wbGVyIGltcGxlbWVudGF0aW9uIG9mIHRoZSBtb2R1bGUuCiAgICAtIElmIHRoZSB0YXJnZXQgaG9zdCBpcyBXaW5kb3dzIHlvdSBjYW4gbm93IHVzZSBDKGZhY3RfcGF0aCkuIE1ha2Ugc3VyZSB0aGF0IHRoaXMgcGF0aAogICAgICBleGlzdHMgb24gdGhlIHRhcmdldCBob3N0LiBGaWxlcyBpbiB0aGlzIHBhdGggTVVTVCBiZSBQb3dlclNoZWxsIHNjcmlwdHMgKGBgKi5wczFgYCkgYW5kCiAgICAgIHRoZWlyIG91dHB1dCBtdXN0IGJlIGZvcm1hdHRhYmxlIGluIEpTT04gKEFuc2libGUgd2lsbCB0YWtlIGNhcmUgb2YgdGhpcykuIFRlc3QgdGhlCiAgICAgIG91dHB1dCBvZiB5b3VyIHNjcmlwdHMuCiAgICAgIFRoaXMgb3B0aW9uIHdhcyBhZGRlZCBpbiBBbnNpYmxlIDIuMS4KYXV0aG9yOgogICAgLSAiQW5zaWJsZSBDb3JlIFRlYW0iCiAgICAtICJNaWNoYWVsIERlSGFhbiIKICAgIC0gIkRhdmlkIE8nQnJpZW4gQGRhdmlkX29icmllbiBkYXZpZG9icmllbjE5ODUiCicnJwoKRVhBTVBMRVMgPSAiIiIKIyBEaXNwbGF5IGZhY3RzIGZyb20gYWxsIGhvc3RzIGFuZCBzdG9yZSB0aGVtIGluZGV4ZWQgYnkgSShob3N0bmFtZSkgYXQgQygvdG1wL2ZhY3RzKS4KIyBhbnNpYmxlIGFsbCAtbSBzZXR1cCAtLXRyZWUgL3RtcC9mYWN0cwoKIyBEaXNwbGF5IG9ubHkgZmFjdHMgcmVnYXJkaW5nIG1lbW9yeSBmb3VuZCBieSBhbnNpYmxlIG9uIGFsbCBob3N0cyBhbmQgb3V0cHV0IHRoZW0uCiMgYW5zaWJsZSBhbGwgLW0gc2V0dXAgLWEgJ2ZpbHRlcj1hbnNpYmxlXypfbWInCgojIERpc3BsYXkgb25seSBmYWN0cyByZXR1cm5lZCBieSBmYWN0ZXIuCiMgYW5zaWJsZSBhbGwgLW0gc2V0dXAgLWEgJ2ZpbHRlcj1mYWN0ZXJfKicKCiMgRGlzcGxheSBvbmx5IGZhY3RzIGFib3V0IGNlcnRhaW4gaW50ZXJmYWNlcy4KIyBhbnNpYmxlIGFsbCAtbSBzZXR1cCAtYSAnZmlsdGVyPWFuc2libGVfZXRoWzAtMl0nCgojIFJlc3RyaWN0IGFkZGl0aW9uYWwgZ2F0aGVyZWQgZmFjdHMgdG8gbmV0d29yayBhbmQgdmlydHVhbC4KIyBhbnNpYmxlIGFsbCAtbSBzZXR1cCAtYSAnZ2F0aGVyX3N1YnNldD1uZXR3b3JrLHZpcnR1YWwnCgojIERvIG5vdCBjYWxsIHB1cHBldCBmYWN0ZXIgb3Igb2hhaSBldmVuIGlmIHByZXNlbnQuCiMgYW5zaWJsZSBhbGwgLW0gc2V0dXAgLWEgJ2dhdGhlcl9zdWJzZXQ9IWZhY3Rlciwhb2hhaScKCiMgT25seSBjb2xsZWN0IHRoZSBtaW5pbXVtIGFtb3VudCBvZiBmYWN0czoKIyBhbnNpYmxlIGFsbCAtbSBzZXR1cCAtYSAnZ2F0aGVyX3N1YnNldD0hYWxsJwoKIyBEaXNwbGF5IGZhY3RzIGZyb20gV2luZG93cyBob3N0cyB3aXRoIGN1c3RvbSBmYWN0cyBzdG9yZWQgaW4gQyhDOlxcY3VzdG9tX2ZhY3RzKS4KIyBhbnNpYmxlIHdpbmRvd3MgLW0gc2V0dXAgLWEgImZhY3RfcGF0aD0nYzpcXGN1c3RvbV9mYWN0cyciCiIiIgppbXBvcnQgZm5tYXRjaAppbXBvcnQgc3lzCgojIGltcG9ydCBtb2R1bGUgc25pcHBldHMKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5iYXNpYyBpbXBvcnQgQW5zaWJsZU1vZHVsZQoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cyBpbXBvcnQgY29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmFtZXNwYWNlIGltcG9ydCBQcmVmaXhGYWN0TmFtZXNwYWNlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzIGltcG9ydCBkZWZhdWx0X2NvbGxlY3RvcnMKCgojIFRoaXMgaXMgdGhlIG1haW4gZW50cnkgcG9pbnQgZm9yIHNldHVwLnB5IGZhY3RzLnB5LgojIEZJWE1FOiBUaGlzIGlzIGNvdXBsZWQgdG8gQW5zaWJsZU1vZHVsZSAoaXQgYXNzdW1lcyBtb2R1bGUucGFyYW1zIGhhcyBrZXlzICdnYXRoZXJfc3Vic2V0JywKIyAgICAgICAgJ2dhdGhlcl90aW1lb3V0JywgJ2ZpbHRlcicgaW5zdGVhZCBvZiBwYXNzaW5nIHRob3NlIGFyZSBhcmdzIG9yIG9ibGlxdWUgZHMKIyAgICAgICAgbW9kdWxlIGlzIHBhc3NlZCBpbiBhbmQgc2VsZi5tb2R1bGUubWlzY19BbnNpYmxlTW9kdWxlX21ldGhvZHMKIyAgICAgICAgYXJlIHVzZWQsIHNvIGhhcmQgdG8gZGVjb3VwbGUuCgpjbGFzcyBBbnNpYmxlRmFjdENvbGxlY3Rvcihjb2xsZWN0b3IuQmFzZUZhY3RDb2xsZWN0b3IpOgogICAgJycnQSBGYWN0Q29sbGVjdG9yIHRoYXQgcmV0dXJucyByZXN1bHRzIHVuZGVyICdhbnNpYmxlX2ZhY3RzJyB0b3AgbGV2ZWwga2V5LgoKICAgICAgIEhhcyBhICdmcm9tX2dhdGhlcl9zdWJzZXQoKSBjb25zdHJ1Y3RvciB0aGF0IHBvcHVsYXRlcyBjb2xsZWN0b3JzIGJhc2VkIG9uIGEKICAgICAgIGdhdGhlcl9zdWJzZXQgc3BlY2lmaWVyLicnJwoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb2xsZWN0b3JzPU5vbmUsIG5hbWVzcGFjZT1Ob25lLCBmaWx0ZXJfc3BlYz1Ob25lKToKCiAgICAgICAgc3VwZXIoQW5zaWJsZUZhY3RDb2xsZWN0b3IsIHNlbGYpLl9faW5pdF9fKGNvbGxlY3RvcnM9Y29sbGVjdG9ycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlPW5hbWVzcGFjZSkKCiAgICAgICAgc2VsZi5maWx0ZXJfc3BlYyA9IGZpbHRlcl9zcGVjCgogICAgZGVmIF9maWx0ZXIoc2VsZiwgZmFjdHNfZGljdCwgZmlsdGVyX3NwZWMpOgogICAgICAgICMgYXNzdW1lIGEgZmlsdGVyX3NwZWM9JycgaXMgZXF1aWx2IHRvIGZpbHRlcl9zcGVjPScqJwogICAgICAgIGlmIG5vdCBmaWx0ZXJfc3BlYyBvciBmaWx0ZXJfc3BlYyA9PSAnKic6CiAgICAgICAgICAgIHJldHVybiBmYWN0c19kaWN0CgogICAgICAgIHJldHVybiBbKHgsIHkpIGZvciB4LCB5IGluIGZhY3RzX2RpY3QuaXRlbXMoKSBpZiBmbm1hdGNoLmZubWF0Y2goeCwgZmlsdGVyX3NwZWMpXQoKICAgIGRlZiBjb2xsZWN0KHNlbGYsIG1vZHVsZT1Ob25lLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgY29sbGVjdGVkX2ZhY3RzID0gY29sbGVjdGVkX2ZhY3RzIG9yIHt9CgogICAgICAgIGZhY3RzX2RpY3QgPSB7fQogICAgICAgIGZhY3RzX2RpY3RbJ2Fuc2libGVfZmFjdHMnXSA9IHt9CgogICAgICAgIGZvciBjb2xsZWN0b3Jfb2JqIGluIHNlbGYuY29sbGVjdG9yczoKICAgICAgICAgICAgaW5mb19kaWN0ID0ge30KCiAgICAgICAgICAgICMgc2hhbGxvdyBjb3B5IG9mIHRoZSBhY2N1bXVsYXRlZCBjb2xsZWN0ZWQgZmFjdHMgdG8gcGFzcyB0byBlYWNoIGNvbGxlY3RvcgogICAgICAgICAgICAjIGZvciByZWZlcmVuY2UuCiAgICAgICAgICAgIGNvbGxlY3RlZF9mYWN0cy51cGRhdGUoZmFjdHNfZGljdFsnYW5zaWJsZV9mYWN0cyddLmNvcHkoKSkKCiAgICAgICAgICAgIHRyeToKCiAgICAgICAgICAgICAgICAjIE5vdGU6IHRoaXMgY29sbGVjdHMgd2l0aCBuYW1lc3BhY2VzLCBzbyBjb2xsZWN0ZWRfZmFjdHMgYWxzbyBpbmNsdWRlcyBuYW1lc3BhY2VzCiAgICAgICAgICAgICAgICBpbmZvX2RpY3QgPSBjb2xsZWN0b3Jfb2JqLmNvbGxlY3Rfd2l0aF9uYW1lc3BhY2UobW9kdWxlPW1vZHVsZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0ZWRfZmFjdHM9Y29sbGVjdGVkX2ZhY3RzKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBzeXMuc3RkZXJyLndyaXRlKHJlcHIoZSkpCiAgICAgICAgICAgICAgICBzeXMuc3RkZXJyLndyaXRlKCdcbicpCgogICAgICAgICAgICAjIGZpbHRlcmVkX2luZm9fZGljdCA9IHNlbGYuX2ZpbHRlcihpbmZvX2RpY3QsIHNlbGYuZmlsdGVyX3NwZWMpCiAgICAgICAgICAgICMgTk9URTogSWYgd2Ugd2FudCBjb21wbGljYXRlZCBmYWN0IGRpY3QgbWVyZ2luZywgdGhpcyBpcyB3aGVyZSBpdCB3b3VsZCBob29rIGluCiAgICAgICAgICAgIGZhY3RzX2RpY3RbJ2Fuc2libGVfZmFjdHMnXS51cGRhdGUoc2VsZi5fZmlsdGVyKGluZm9fZGljdCwgc2VsZi5maWx0ZXJfc3BlYykpCgogICAgICAgICMgVE9ETzogdGhpcyBtYXkgYmUgYmVzdCBwbGFjZSB0byBhcHBseSBmYWN0ICdmaWx0ZXJzJyBhcyB3ZWxsLiBUaGV5CiAgICAgICAgIyAgICAgICBhcmUgY3VycmVudGx5IGlnbm9yZWQgLWFrbAogICAgICAgIHJldHVybiBmYWN0c19kaWN0CgoKY2xhc3MgQ29sbGVjdG9yTWV0YURhdGFDb2xsZWN0b3IoY29sbGVjdG9yLkJhc2VGYWN0Q29sbGVjdG9yKToKICAgICcnJ0NvbGxlY3RvciB0aGF0IHByb3ZpZGVzIGEgZmFjdHMgd2l0aCB0aGUgZ2F0aGVyX3N1YnNldCBtZXRhZGF0YS4nJycKCiAgICBuYW1lID0gJ2dhdGhlcl9zdWJzZXQnCiAgICBfZmFjdF9pZHMgPSBzZXQoW10pCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbGxlY3RvcnM9Tm9uZSwgbmFtZXNwYWNlPU5vbmUsIGdhdGhlcl9zdWJzZXQ9Tm9uZSwgbW9kdWxlX3NldHVwPU5vbmUpOgogICAgICAgIHN1cGVyKENvbGxlY3Rvck1ldGFEYXRhQ29sbGVjdG9yLCBzZWxmKS5fX2luaXRfXyhjb2xsZWN0b3JzLCBuYW1lc3BhY2UpCiAgICAgICAgc2VsZi5nYXRoZXJfc3Vic2V0ID0gZ2F0aGVyX3N1YnNldAogICAgICAgIHNlbGYubW9kdWxlX3NldHVwID0gbW9kdWxlX3NldHVwCgogICAgZGVmIGNvbGxlY3Qoc2VsZiwgbW9kdWxlPU5vbmUsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBtZXRhX2ZhY3RzID0geydnYXRoZXJfc3Vic2V0Jzogc2VsZi5nYXRoZXJfc3Vic2V0fQogICAgICAgIGlmIHNlbGYubW9kdWxlX3NldHVwOgogICAgICAgICAgICBtZXRhX2ZhY3RzWydtb2R1bGVfc2V0dXAnXSA9IHNlbGYubW9kdWxlX3NldHVwCiAgICAgICAgcmV0dXJuIG1ldGFfZmFjdHMKCgpkZWYgbWFpbigpOgogICAgbW9kdWxlID0gQW5zaWJsZU1vZHVsZSgKICAgICAgICBhcmd1bWVudF9zcGVjPWRpY3QoCiAgICAgICAgICAgIGdhdGhlcl9zdWJzZXQ9ZGljdChkZWZhdWx0PVsiYWxsIl0sIHJlcXVpcmVkPUZhbHNlLCB0eXBlPSdsaXN0JyksCiAgICAgICAgICAgIGdhdGhlcl90aW1lb3V0PWRpY3QoZGVmYXVsdD0xMCwgcmVxdWlyZWQ9RmFsc2UsIHR5cGU9J2ludCcpLAogICAgICAgICAgICBmaWx0ZXI9ZGljdChkZWZhdWx0PSIqIiwgcmVxdWlyZWQ9RmFsc2UpLAogICAgICAgICAgICBmYWN0X3BhdGg9ZGljdChkZWZhdWx0PScvZXRjL2Fuc2libGUvZmFjdHMuZCcsIHJlcXVpcmVkPUZhbHNlLCB0eXBlPSdwYXRoJyksCiAgICAgICAgKSwKICAgICAgICBzdXBwb3J0c19jaGVja19tb2RlPVRydWUsCiAgICApCgogICAgZ2F0aGVyX3N1YnNldCA9IG1vZHVsZS5wYXJhbXNbJ2dhdGhlcl9zdWJzZXQnXQogICAgZ2F0aGVyX3RpbWVvdXQgPSBtb2R1bGUucGFyYW1zWydnYXRoZXJfdGltZW91dCddCiAgICBmaWx0ZXJfc3BlYyA9IG1vZHVsZS5wYXJhbXNbJ2ZpbHRlciddCgogICAgIyBUT0RPOiB0aGlzIG1pbWljcyBleGlzdGluZyBiZWhhdmlvciB3aGVyZSBnYXRoZXJfc3Vic2V0PVsiIWFsbCJdIGFjdHVhbGx5IG1lYW5zCiAgICAjICAgICAgIHRvIGNvbGxlY3Qgbm90aGluZyBleGNlcHQgZm9yIHRoZSBiZWxvdyBsaXN0CiAgICAjIFRPRE86IGRlY2lkZSB3aGF0ICchYWxsJyBtZWFucywgSSBsZWFuIHRvd2FyZHMgbWFraW5nIGl0IG1lYW4gbm9uZSwgYnV0IGxpa2VseSBuZWVkcwogICAgIyAgICAgICBzb21lIHR3ZWFraW5nIG9uIGhvdyBnYXRoZXJfc3Vic2V0IG9wZXJhdGlvbnMgYXJlIHBlcmZvcm1lZAogICAgbWluaW1hbF9nYXRoZXJfc3Vic2V0ID0gZnJvemVuc2V0KFsnYXBwYXJtb3InLCAnY2FwcycsICdjbWRsaW5lJywgJ2RhdGVfdGltZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkaXN0cmlidXRpb24nLCAnZG5zJywgJ2VudicsICdmaXBzJywgJ2xvY2FsJywgJ2xzYicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwa2dfbWdyJywgJ3BsYXRmb3JtJywgJ3B5dGhvbicsICdzZWxpbnV4JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NlcnZpY2VfbWdyJywgJ3NzaF9wdWJfa2V5cycsICd1c2VyJ10pCgogICAgYWxsX2NvbGxlY3Rvcl9jbGFzc2VzID0gZGVmYXVsdF9jb2xsZWN0b3JzLmNvbGxlY3RvcnMKCiAgICBjb2xsZWN0b3JfY2xhc3NlcyA9IFwKICAgICAgICBjb2xsZWN0b3IuY29sbGVjdG9yX2NsYXNzZXNfZnJvbV9nYXRoZXJfc3Vic2V0KAogICAgICAgICAgICBhbGxfY29sbGVjdG9yX2NsYXNzZXM9YWxsX2NvbGxlY3Rvcl9jbGFzc2VzLAogICAgICAgICAgICBtaW5pbWFsX2dhdGhlcl9zdWJzZXQ9bWluaW1hbF9nYXRoZXJfc3Vic2V0LAogICAgICAgICAgICBnYXRoZXJfc3Vic2V0PWdhdGhlcl9zdWJzZXQsCiAgICAgICAgICAgIGdhdGhlcl90aW1lb3V0PWdhdGhlcl90aW1lb3V0KQoKICAgICMgcHJpbnQoJ2NvbGxlY3Rvcl9jbGFzc2VzOiAlcycgJSBwcHJpbnQucGZvcm1hdChjb2xsZWN0b3JfY2xhc3NlcykpCgogICAgbmFtZXNwYWNlID0gUHJlZml4RmFjdE5hbWVzcGFjZShuYW1lc3BhY2VfbmFtZT0nYW5zaWJsZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeD0nYW5zaWJsZV8nKQoKICAgIGNvbGxlY3RvcnMgPSBbXQogICAgZm9yIGNvbGxlY3Rvcl9jbGFzcyBpbiBjb2xsZWN0b3JfY2xhc3NlczoKICAgICAgICBjb2xsZWN0b3Jfb2JqID0gY29sbGVjdG9yX2NsYXNzKG5hbWVzcGFjZT1uYW1lc3BhY2UpCiAgICAgICAgY29sbGVjdG9ycy5hcHBlbmQoY29sbGVjdG9yX29iaikKCiAgICAjIEFkZCBhIGNvbGxlY3RvciB0aGF0IGtub3dzIHdoYXQgZ2F0aGVyX3N1YnNldCB3ZSB1c2VkIHNvIGl0IGl0IGNhbiBwcm92aWRlIGEgZmFjdAogICAgY29sbGVjdG9yX21ldGFfZGF0YV9jb2xsZWN0b3IgPSBcCiAgICAgICAgQ29sbGVjdG9yTWV0YURhdGFDb2xsZWN0b3IoZ2F0aGVyX3N1YnNldD1nYXRoZXJfc3Vic2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZV9zZXR1cD1UcnVlKQogICAgY29sbGVjdG9ycy5hcHBlbmQoY29sbGVjdG9yX21ldGFfZGF0YV9jb2xsZWN0b3IpCgogICAgIyBwcmludCgnY29sbGVjdG9yczogJXMnICUgcHByaW50LnBmb3JtYXQoY29sbGVjdG9ycykpCgogICAgZmFjdF9jb2xsZWN0b3IgPSBcCiAgICAgICAgQW5zaWJsZUZhY3RDb2xsZWN0b3IoY29sbGVjdG9ycz1jb2xsZWN0b3JzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcl9zcGVjPWZpbHRlcl9zcGVjKQoKICAgIGZhY3RzX2RpY3QgPSBmYWN0X2NvbGxlY3Rvci5jb2xsZWN0KG1vZHVsZT1tb2R1bGUpCgogICAgbW9kdWxlLmV4aXRfanNvbigqKmZhY3RzX2RpY3QpCgoKaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICAgIG1haW4oKQpQSwMEFAAAAAAAy7srSzvfOZUwigEAMIoBAB0AAABhbnNpYmxlL21vZHVsZV91dGlscy9iYXNpYy5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpLCBNaWNoYWVsIERlSGFhbiA8bWljaGFlbC5kZWhhYW5AZ21haWwuY29tPiwgMjAxMi0yMDEzCiMgQ29weXJpZ2h0IChjKSwgVG9zaGlvIEt1cmF0b21pIDx0a3VyYXRvbWlAYW5zaWJsZS5jb20+IDIwMTYKIyBBbGwgcmlnaHRzIHJlc2VydmVkLgojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwKIyBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiMgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICAgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICAgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKIyBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAojIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4KIyBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwKIyBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sCiMgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCiMgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVAojIExJQUJJTElUWSwgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRQojIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCgpCT09MRUFOU19UUlVFID0gWyd5JywgJ3llcycsICdvbicsICcxJywgJ3RydWUnLCAxLCBUcnVlXQpCT09MRUFOU19GQUxTRSA9IFsnbicsICdubycsICdvZmYnLCAnMCcsICdmYWxzZScsIDAsIEZhbHNlXQpCT09MRUFOUyA9IEJPT0xFQU5TX1RSVUUgKyBCT09MRUFOU19GQUxTRQoKU0laRV9SQU5HRVMgPSB7ICdZJzogMTw8ODAsICdaJzogMTw8NzAsICdFJzogMTw8NjAsICdQJzogMTw8NTAsICdUJzogMTw8NDAsICdHJzogMTw8MzAsICdNJzogMTw8MjAsICdLJzogMTw8MTAsICdCJzogMSB9CgpGSUxFX0FUVFJJQlVURVMgPSB7CiAgICAnQSc6ICdub2F0aW1lJywKICAgICdhJzogJ2FwcGVuZCcsCiAgICAnYyc6ICdjb21wcmVzc2VkJywKICAgICdDJzogJ25vY293JywKICAgICdkJzogJ25vZHVtcCcsCiAgICAnRCc6ICdkaXJzeW5jJywKICAgICdlJzogJ2V4dGVudHMnLAogICAgJ0UnOiAnZW5jcnlwdGVkJywKICAgICdoJzogJ2Jsb2Nrc2l6ZScsCiAgICAnaSc6ICdpbW11dGFibGUnLAogICAgJ0knOiAnaW5kZXhlZCcsCiAgICAnaic6ICdqb3VybmFsbGVkJywKICAgICdOJzogJ2lubGluZScsCiAgICAncyc6ICd6ZXJvJywKICAgICdTJzogJ3N5bmNocm9ub3VzJywKICAgICd0JzogJ25vdGFpbCcsCiAgICAnVCc6ICdibG9ja3Jvb3QnLAogICAgJ3UnOiAndW5kZWxldGUnLAogICAgJ1gnOiAnY29tcHJlc3NlZHJhdycsCiAgICAnWic6ICdjb21wcmVzc2VkZGlydHknLAp9CgojIGFuc2libGUgbW9kdWxlcyBjYW4gYmUgd3JpdHRlbiBpbiBhbnkgbGFuZ3VhZ2UuICBUbyBzaW1wbGlmeQojIGRldmVsb3BtZW50IG9mIFB5dGhvbiBtb2R1bGVzLCB0aGUgZnVuY3Rpb25zIGF2YWlsYWJsZSBoZXJlIGNhbgojIGJlIHVzZWQgdG8gZG8gbWFueSBjb21tb24gdGFza3MKCmltcG9ydCBsb2NhbGUKaW1wb3J0IG9zCmltcG9ydCByZQppbXBvcnQgc2hsZXgKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHN5cwppbXBvcnQgdHlwZXMKaW1wb3J0IHRpbWUKaW1wb3J0IHNlbGVjdAppbXBvcnQgc2h1dGlsCmltcG9ydCBzdGF0CmltcG9ydCB0ZW1wZmlsZQppbXBvcnQgdHJhY2ViYWNrCmltcG9ydCBncnAKaW1wb3J0IHB3ZAppbXBvcnQgcGxhdGZvcm0KaW1wb3J0IGVycm5vCmltcG9ydCBkYXRldGltZQpmcm9tIGl0ZXJ0b29scyBpbXBvcnQgcmVwZWF0LCBjaGFpbgoKdHJ5OgogICAgaW1wb3J0IHN5c2xvZwogICAgSEFTX1NZU0xPRz1UcnVlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIEhBU19TWVNMT0c9RmFsc2UKCnRyeToKICAgIGZyb20gc3lzdGVtZCBpbXBvcnQgam91cm5hbAogICAgaGFzX2pvdXJuYWwgPSBUcnVlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGhhc19qb3VybmFsID0gRmFsc2UKCkhBVkVfU0VMSU5VWD1GYWxzZQp0cnk6CiAgICBpbXBvcnQgc2VsaW51eAogICAgSEFWRV9TRUxJTlVYPVRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgcGFzcwoKIyBQeXRob24yICYgMyB3YXkgdG8gZ2V0IE5vbmVUeXBlCk5vbmVUeXBlID0gdHlwZShOb25lKQoKdHJ5OgogICAgZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgU2VxdWVuY2UsIE1hcHBpbmcKZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyBweXRob24yLjUKICAgIFNlcXVlbmNlID0gKGxpc3QsIHR1cGxlKQogICAgTWFwcGluZyA9IChkaWN0LCkKCiMgTm90ZTogV2hlbiBnZXR0aW5nIFNlcXVlbmNlIGZyb20gY29sbGVjdGlvbnMsIGl0IG1hdGNoZXMgd2l0aCBzdHJpbmdzLiAgSWYKIyB0aGlzIG1hdHRlcnMsIG1ha2Ugc3VyZSB0byBjaGVjayBmb3Igc3RyaW5ncyBiZWZvcmUgY2hlY2tpbmcgZm9yIHNlcXVlbmNldHlwZQp0cnk6CiAgICBmcm9tIGNvbGxlY3Rpb25zLmFiYyBpbXBvcnQgS2V5c1ZpZXcKICAgIFNFUVVFTkNFVFlQRSA9IChTZXF1ZW5jZSwgS2V5c1ZpZXcpCmV4Y2VwdDoKICAgIFNFUVVFTkNFVFlQRSA9IFNlcXVlbmNlCgp0cnk6CiAgICBpbXBvcnQganNvbgogICAgIyBEZXRlY3QgdGhlIHB5dGhvbi1qc29uIGxpYnJhcnkgd2hpY2ggaXMgaW5jb21wYXRpYmxlCiAgICAjIExvb2sgZm9yIHNpbXBsZWpzb24gaWYgdGhhdCdzIHRoZSBjYXNlCiAgICB0cnk6CiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoanNvbi5sb2FkcywgdHlwZXMuRnVuY3Rpb25UeXBlKSBvciBub3QgaXNpbnN0YW5jZShqc29uLmR1bXBzLCB0eXBlcy5GdW5jdGlvblR5cGUpOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcgogICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgIHJhaXNlIEltcG9ydEVycm9yCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIHRyeToKICAgICAgICBpbXBvcnQgc2ltcGxlanNvbiBhcyBqc29uCiAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgcHJpbnQoJ1xueyJtc2ciOiAiRXJyb3I6IGFuc2libGUgcmVxdWlyZXMgdGhlIHN0ZGxpYiBqc29uIG9yIHNpbXBsZWpzb24gbW9kdWxlLCBuZWl0aGVyIHdhcyBmb3VuZCEiLCAiZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCiAgICBleGNlcHQgU3ludGF4RXJyb3I6CiAgICAgICAgcHJpbnQoJ1xueyJtc2ciOiAiU3ludGF4RXJyb3I6IHByb2JhYmx5IGR1ZSB0byBpbnN0YWxsZWQgc2ltcGxlanNvbiBiZWluZyBmb3IgYSBkaWZmZXJlbnQgcHl0aG9uIHZlcnNpb24iLCAiZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCgpBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TID0gZGljdCgpCnRyeToKICAgIGltcG9ydCBoYXNobGliCgogICAgIyBweXRob24gMi43LjkrIGFuZCAyLjcuMCsKICAgIGZvciBhdHRyaWJ1dGUgaW4gKCdhdmFpbGFibGVfYWxnb3JpdGhtcycsICdhbGdvcml0aG1zJyk6CiAgICAgICAgYWxnb3JpdGhtcyA9IGdldGF0dHIoaGFzaGxpYiwgYXR0cmlidXRlLCBOb25lKQogICAgICAgIGlmIGFsZ29yaXRobXM6CiAgICAgICAgICAgIGJyZWFrCiAgICBpZiBhbGdvcml0aG1zIGlzIE5vbmU6CiAgICAgICAgIyBweXRob24gMi41KwogICAgICAgIGFsZ29yaXRobXMgPSAoJ21kNScsICdzaGExJywgJ3NoYTIyNCcsICdzaGEyNTYnLCAnc2hhMzg0JywgJ3NoYTUxMicpCiAgICBmb3IgYWxnb3JpdGhtIGluIGFsZ29yaXRobXM6CiAgICAgICAgQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNU1thbGdvcml0aG1dID0gZ2V0YXR0cihoYXNobGliLCBhbGdvcml0aG0pCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGltcG9ydCBzaGEKICAgIEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVMgPSB7J3NoYTEnOiBzaGEuc2hhfQogICAgdHJ5OgogICAgICAgIGltcG9ydCBtZDUKICAgICAgICBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TWydtZDUnXSA9IG1kNS5tZDUKICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICBwYXNzCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnB5Y29tcGF0MjQgaW1wb3J0IGdldF9leGNlcHRpb24sIGxpdGVyYWxfZXZhbApmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpbXBvcnQgKFBZMiwgUFkzLCBiLCBiaW5hcnlfdHlwZSwgaW50ZWdlcl90eXBlcywKICAgICAgICBpdGVyaXRlbXMsIHRleHRfdHlwZSwgc3RyaW5nX3R5cGVzKQpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5tb3ZlcyBpbXBvcnQgbWFwLCByZWR1Y2UsIHNobGV4X3F1b3RlCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuX3RleHQgaW1wb3J0IHRvX25hdGl2ZSwgdG9fYnl0ZXMsIHRvX3RleHQKClBBU1NXT1JEX01BVENIID0gcmUuY29tcGlsZShyJ14oPzouK1stX1xzXSk/cGFzcyg/OlstX1xzXT8oPzp3b3JkfHBocmFzZXx3cmR8d2QpPykoPzpbLV9cc10uKyk/JCcsIHJlLkkpCgpfTlVNQkVSVFlQRVMgPSB0dXBsZShsaXN0KGludGVnZXJfdHlwZXMpICsgW2Zsb2F0XSkKCiMgRGVwcmVjYXRlZCBjb21wYXQuICBPbmx5IGtlcHQgaW4gY2FzZSBhbm90aGVyIG1vZHVsZSB1c2VkIHRoZXNlIG5hbWVzICBVc2luZwojIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpcyBwcmVmZXJyZWQKCk5VTUJFUlRZUEVTID0gX05VTUJFUlRZUEVTCgppbWFwID0gbWFwCgp0cnk6CiAgICAjIFB5dGhvbiAyCiAgICB1bmljb2RlCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICAjIFB5dGhvbiAzCiAgICB1bmljb2RlID0gdGV4dF90eXBlCgp0cnk6CiAgICAjIFB5dGhvbiAyLjYrCiAgICBieXRlcwpleGNlcHQgTmFtZUVycm9yOgogICAgIyBQeXRob24gMi40CiAgICBieXRlcyA9IGJpbmFyeV90eXBlCgp0cnk6CiAgICAjIFB5dGhvbiAyCiAgICBiYXNlc3RyaW5nCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICAjIFB5dGhvbiAzCiAgICBiYXNlc3RyaW5nID0gc3RyaW5nX3R5cGVzCgpfbGl0ZXJhbF9ldmFsID0gbGl0ZXJhbF9ldmFsCgojIEVuZCBvZiBkZXByZWNhdGVkIG5hbWVzCgojIEludGVybmFsIGdsb2JhbCBob2xkaW5nIHBhc3NlZCBpbiBwYXJhbXMuICBUaGlzIGlzIGNvbnN1bHRlZCBpbiBjYXNlCiMgbXVsdGlwbGUgQW5zaWJsZU1vZHVsZXMgYXJlIGNyZWF0ZWQuICBPdGhlcndpc2UgZWFjaCBBbnNpYmxlTW9kdWxlIHdvdWxkCiMgYXR0ZW1wdCB0byByZWFkIGZyb20gc3RkaW4uICBPdGhlciBjb2RlIHNob3VsZCBub3QgdXNlIHRoaXMgZGlyZWN0bHkgYXMgaXQKIyBpcyBhbiBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBkZXRhaWwKX0FOU0lCTEVfQVJHUyA9IE5vbmUKCkZJTEVfQ09NTU9OX0FSR1VNRU5UUz1kaWN0KAogICAgc3JjID0gZGljdCgpLAogICAgbW9kZSA9IGRpY3QodHlwZT0ncmF3JyksCiAgICBvd25lciA9IGRpY3QoKSwKICAgIGdyb3VwID0gZGljdCgpLAogICAgc2V1c2VyID0gZGljdCgpLAogICAgc2Vyb2xlID0gZGljdCgpLAogICAgc2VsZXZlbCA9IGRpY3QoKSwKICAgIHNldHlwZSA9IGRpY3QoKSwKICAgIGZvbGxvdyA9IGRpY3QodHlwZT0nYm9vbCcsIGRlZmF1bHQ9RmFsc2UpLAogICAgIyBub3QgdGFrZW4gYnkgdGhlIGZpbGUgbW9kdWxlLCBidXQgb3RoZXIgbW9kdWxlcyBjYWxsIGZpbGUgc28gaXQgbXVzdCBpZ25vcmUgdGhlbS4KICAgIGNvbnRlbnQgPSBkaWN0KG5vX2xvZz1UcnVlKSwKICAgIGJhY2t1cCA9IGRpY3QoKSwKICAgIGZvcmNlID0gZGljdCgpLAogICAgcmVtb3RlX3NyYyA9IGRpY3QoKSwgIyB1c2VkIGJ5IGFzc2VtYmxlCiAgICByZWdleHAgPSBkaWN0KCksICMgdXNlZCBieSBhc3NlbWJsZQogICAgZGVsaW1pdGVyID0gZGljdCgpLCAjIHVzZWQgYnkgYXNzZW1ibGUKICAgIGRpcmVjdG9yeV9tb2RlID0gZGljdCgpLCAjIHVzZWQgYnkgY29weQogICAgdW5zYWZlX3dyaXRlcyAgPSBkaWN0KHR5cGU9J2Jvb2wnKSwgIyBzaG91bGQgYmUgYXZhaWxhYmxlIHRvIGFueSBtb2R1bGUgdXNpbmcgYXRvbWljX21vdmUKICAgIGF0dHJpYnV0ZXMgPSBkaWN0KGFsaWFzZXM9WydhdHRyJ10pLAopCgpQQVNTV0RfQVJHX1JFID0gcmUuY29tcGlsZShyJ15bLV17MCwyfXBhc3NbLV0/KHdvcmR8d2QpPycpCgojIENhbid0IHVzZSAwNzc3NyBvbiBQeXRob24gMywgY2FuJ3QgdXNlIDBvNzc3NyBvbiBQeXRob24gMi40ClBFUk1fQklUUyA9IGludCgnMDc3NzcnLCA4KSAgICAgICMgZmlsZSBtb2RlIHBlcm1pc3Npb24gYml0cwpFWEVDX1BFUk1fQklUUyA9IGludCgnMDAxMTEnLCA4KSAjIGV4ZWN1dGUgcGVybWlzc2lvbiBiaXRzCkRFRkFVTFRfUEVSTSA9IGludCgnMDY2NicsIDgpICAgICMgZGVmYXVsdCBmaWxlIHBlcm1pc3Npb24gYml0cwoKCmRlZiBnZXRfcGxhdGZvcm0oKToKICAgICcnJyB3aGF0J3MgdGhlIHBsYXRmb3JtPyAgZXhhbXBsZTogTGludXggaXMgYSBwbGF0Zm9ybS4gJycnCiAgICByZXR1cm4gcGxhdGZvcm0uc3lzdGVtKCkKCmRlZiBnZXRfZGlzdHJpYnV0aW9uKCk6CiAgICAnJycgcmV0dXJuIHRoZSBkaXN0cmlidXRpb24gbmFtZSAnJycKICAgIGlmIHBsYXRmb3JtLnN5c3RlbSgpID09ICdMaW51eCc6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdXBwb3J0ZWRfZGlzdHMgPSBwbGF0Zm9ybS5fc3VwcG9ydGVkX2Rpc3RzICsgKCdhcmNoJywnYWxwaW5lJykKICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gcGxhdGZvcm0ubGludXhfZGlzdHJpYnV0aW9uKHN1cHBvcnRlZF9kaXN0cz1zdXBwb3J0ZWRfZGlzdHMpWzBdLmNhcGl0YWxpemUoKQogICAgICAgICAgICBpZiBub3QgZGlzdHJpYnV0aW9uIGFuZCBvcy5wYXRoLmlzZmlsZSgnL2V0Yy9zeXN0ZW0tcmVsZWFzZScpOgogICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gcGxhdGZvcm0ubGludXhfZGlzdHJpYnV0aW9uKHN1cHBvcnRlZF9kaXN0cz1bJ3N5c3RlbSddKVswXS5jYXBpdGFsaXplKCkKICAgICAgICAgICAgICAgIGlmICdBbWF6b24nIGluIGRpc3RyaWJ1dGlvbjoKICAgICAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSAnQW1hem9uJwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSAnT3RoZXJMaW51eCcKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICMgRklYTUU6IE1ldGhvZE1pc3NpbmcsIEkgYXNzdW1lPwogICAgICAgICAgICBkaXN0cmlidXRpb24gPSBwbGF0Zm9ybS5kaXN0KClbMF0uY2FwaXRhbGl6ZSgpCiAgICBlbHNlOgogICAgICAgIGRpc3RyaWJ1dGlvbiA9IE5vbmUKICAgIHJldHVybiBkaXN0cmlidXRpb24KCmRlZiBnZXRfZGlzdHJpYnV0aW9uX3ZlcnNpb24oKToKICAgICcnJyByZXR1cm4gdGhlIGRpc3RyaWJ1dGlvbiB2ZXJzaW9uICcnJwogICAgaWYgcGxhdGZvcm0uc3lzdGVtKCkgPT0gJ0xpbnV4JzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbl92ZXJzaW9uID0gcGxhdGZvcm0ubGludXhfZGlzdHJpYnV0aW9uKClbMV0KICAgICAgICAgICAgaWYgbm90IGRpc3RyaWJ1dGlvbl92ZXJzaW9uIGFuZCBvcy5wYXRoLmlzZmlsZSgnL2V0Yy9zeXN0ZW0tcmVsZWFzZScpOgogICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oc3VwcG9ydGVkX2Rpc3RzPVsnc3lzdGVtJ10pWzFdCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAjIEZJWE1FOiBNZXRob2RNaXNzaW5nLCBJIGFzc3VtZT8KICAgICAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBwbGF0Zm9ybS5kaXN0KClbMV0KICAgIGVsc2U6CiAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBOb25lCiAgICByZXR1cm4gZGlzdHJpYnV0aW9uX3ZlcnNpb24KCmRlZiBnZXRfYWxsX3N1YmNsYXNzZXMoY2xzKToKICAgICcnJwogICAgdXNlZCBieSBtb2R1bGVzIGxpa2UgSGFyZHdhcmUgb3IgTmV0d29yayBmYWN0IGNsYXNzZXMgdG8gcmV0cmlldmUgYWxsIHN1YmNsYXNzZXMgb2YgYSBnaXZlbiBjbGFzcy4KICAgIF9fc3ViY2xhc3Nlc19fIHJldHVybiBvbmx5IGRpcmVjdCBzdWIgY2xhc3Nlcy4gVGhpcyBvbmUgZ28gZG93biBpbnRvIHRoZSBjbGFzcyB0cmVlLgogICAgJycnCiAgICAjIFJldHJpZXZlIGRpcmVjdCBzdWJjbGFzc2VzCiAgICBzdWJjbGFzc2VzID0gY2xzLl9fc3ViY2xhc3Nlc19fKCkKICAgIHRvX3Zpc2l0ID0gbGlzdChzdWJjbGFzc2VzKQogICAgIyBUaGVuIHZpc2l0IGFsbCBzdWJjbGFzc2VzCiAgICB3aGlsZSB0b192aXNpdDoKICAgICAgICBmb3Igc2MgaW4gdG9fdmlzaXQ6CiAgICAgICAgICAgICMgVGhlIGN1cnJlbnQgY2xhc3MgaXMgbm93IHZpc2l0ZWQsIHNvIHJlbW92ZSBpdCBmcm9tIGxpc3QKICAgICAgICAgICAgdG9fdmlzaXQucmVtb3ZlKHNjKQogICAgICAgICAgICAjIEFwcGVuZGluZyBhbGwgc3ViY2xhc3NlcyB0byB2aXNpdCBhbmQga2VlcCBhIHJlZmVyZW5jZSBvZiBhdmFpbGFibGUgY2xhc3MKICAgICAgICAgICAgZm9yIHNzYyBpbiBzYy5fX3N1YmNsYXNzZXNfXygpOgogICAgICAgICAgICAgICAgc3ViY2xhc3Nlcy5hcHBlbmQoc3NjKQogICAgICAgICAgICAgICAgdG9fdmlzaXQuYXBwZW5kKHNzYykKICAgIHJldHVybiBzdWJjbGFzc2VzCgoKZGVmIGxvYWRfcGxhdGZvcm1fc3ViY2xhc3MoY2xzLCAqYXJncywgKiprd2FyZ3MpOgogICAgJycnCiAgICB1c2VkIGJ5IG1vZHVsZXMgbGlrZSBVc2VyIHRvIGhhdmUgZGlmZmVyZW50IGltcGxlbWVudGF0aW9ucyBiYXNlZCBvbiBkZXRlY3RlZCBwbGF0Zm9ybS4gIFNlZSBVc2VyCiAgICBtb2R1bGUgZm9yIGFuIGV4YW1wbGUuCiAgICAnJycKCiAgICB0aGlzX3BsYXRmb3JtID0gZ2V0X3BsYXRmb3JtKCkKICAgIGRpc3RyaWJ1dGlvbiA9IGdldF9kaXN0cmlidXRpb24oKQogICAgc3ViY2xhc3MgPSBOb25lCgogICAgIyBnZXQgdGhlIG1vc3Qgc3BlY2lmaWMgc3VwZXJjbGFzcyBmb3IgdGhpcyBwbGF0Zm9ybQogICAgaWYgZGlzdHJpYnV0aW9uIGlzIG5vdCBOb25lOgogICAgICAgIGZvciBzYyBpbiBnZXRfYWxsX3N1YmNsYXNzZXMoY2xzKToKICAgICAgICAgICAgaWYgc2MuZGlzdHJpYnV0aW9uIGlzIG5vdCBOb25lIGFuZCBzYy5kaXN0cmlidXRpb24gPT0gZGlzdHJpYnV0aW9uIGFuZCBzYy5wbGF0Zm9ybSA9PSB0aGlzX3BsYXRmb3JtOgogICAgICAgICAgICAgICAgc3ViY2xhc3MgPSBzYwogICAgaWYgc3ViY2xhc3MgaXMgTm9uZToKICAgICAgICBmb3Igc2MgaW4gZ2V0X2FsbF9zdWJjbGFzc2VzKGNscyk6CiAgICAgICAgICAgIGlmIHNjLnBsYXRmb3JtID09IHRoaXNfcGxhdGZvcm0gYW5kIHNjLmRpc3RyaWJ1dGlvbiBpcyBOb25lOgogICAgICAgICAgICAgICAgc3ViY2xhc3MgPSBzYwogICAgaWYgc3ViY2xhc3MgaXMgTm9uZToKICAgICAgICBzdWJjbGFzcyA9IGNscwoKICAgIHJldHVybiBzdXBlcihjbHMsIHN1YmNsYXNzKS5fX25ld19fKHN1YmNsYXNzKQoKCmRlZiBqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcyhkLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKToKICAgICcnJyBSZWN1cnNpdmVseSBjb252ZXJ0IGRpY3Qga2V5cyBhbmQgdmFsdWVzIHRvIGJ5dGUgc3RyCgogICAgICAgIFNwZWNpYWxpemVkIGZvciBqc29uIHJldHVybiBiZWNhdXNlIHRoaXMgb25seSBoYW5kbGVzLCBsaXN0cywgdHVwbGVzLAogICAgICAgIGFuZCBkaWN0IGNvbnRhaW5lciB0eXBlcyAodGhlIGNvbnRhaW5lcnMgdGhhdCB0aGUganNvbiBtb2R1bGUgcmV0dXJucykKICAgICcnJwoKICAgIGlmIGlzaW5zdGFuY2UoZCwgdGV4dF90eXBlKToKICAgICAgICByZXR1cm4gdG9fYnl0ZXMoZCwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgZGljdCk6CiAgICAgICAgcmV0dXJuIGRpY3QobWFwKGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzLCBpdGVyaXRlbXMoZCksIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBsaXN0KToKICAgICAgICByZXR1cm4gbGlzdChtYXAoanNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMsIGQsIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCB0dXBsZSk6CiAgICAgICAgcmV0dXJuIHR1cGxlKG1hcChqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcywgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxzZToKICAgICAgICByZXR1cm4gZAoKZGVmIGpzb25fZGljdF9ieXRlc190b191bmljb2RlKGQsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpOgogICAgJycnIFJlY3Vyc2l2ZWx5IGNvbnZlcnQgZGljdCBrZXlzIGFuZCB2YWx1ZXMgdG8gYnl0ZSBzdHIKCiAgICAgICAgU3BlY2lhbGl6ZWQgZm9yIGpzb24gcmV0dXJuIGJlY2F1c2UgdGhpcyBvbmx5IGhhbmRsZXMsIGxpc3RzLCB0dXBsZXMsCiAgICAgICAgYW5kIGRpY3QgY29udGFpbmVyIHR5cGVzICh0aGUgY29udGFpbmVycyB0aGF0IHRoZSBqc29uIG1vZHVsZSByZXR1cm5zKQogICAgJycnCgogICAgaWYgaXNpbnN0YW5jZShkLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgIyBXYXJuaW5nLCBjYW4gdHJhY2ViYWNrCiAgICAgICAgcmV0dXJuIHRvX3RleHQoZCwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgZGljdCk6CiAgICAgICAgcmV0dXJuIGRpY3QobWFwKGpzb25fZGljdF9ieXRlc190b191bmljb2RlLCBpdGVyaXRlbXMoZCksIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBsaXN0KToKICAgICAgICByZXR1cm4gbGlzdChtYXAoanNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUsIGQsIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCB0dXBsZSk6CiAgICAgICAgcmV0dXJuIHR1cGxlKG1hcChqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZSwgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxzZToKICAgICAgICByZXR1cm4gZAoKZGVmIHJldHVybl92YWx1ZXMob2JqKToKICAgICIiIiBSZXR1cm4gbmF0aXZlIHN0cmluZ2lmaWVkIHZhbHVlcyBmcm9tIGRhdGFzdHJ1Y3R1cmVzLgoKICAgIEZvciB1c2Ugd2l0aCByZW1vdmluZyBzZW5zaXRpdmUgdmFsdWVzIHByZS1qc29uaWZpY2F0aW9uLiIiIgogICAgaWYgaXNpbnN0YW5jZShvYmosICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgaWYgb2JqOgogICAgICAgICAgICB5aWVsZCB0b19uYXRpdmUob2JqLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIHJldHVybgogICAgZWxpZiBpc2luc3RhbmNlKG9iaiwgU0VRVUVOQ0VUWVBFKToKICAgICAgICBmb3IgZWxlbWVudCBpbiBvYmo6CiAgICAgICAgICAgIGZvciBzdWJlbGVtZW50IGluIHJldHVybl92YWx1ZXMoZWxlbWVudCk6CiAgICAgICAgICAgICAgICB5aWVsZCBzdWJlbGVtZW50CiAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCBNYXBwaW5nKToKICAgICAgICBmb3IgZWxlbWVudCBpbiBvYmouaXRlbXMoKToKICAgICAgICAgICAgZm9yIHN1YmVsZW1lbnQgaW4gcmV0dXJuX3ZhbHVlcyhlbGVtZW50WzFdKToKICAgICAgICAgICAgICAgIHlpZWxkIHN1YmVsZW1lbnQKICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIChib29sLCBOb25lVHlwZSkpOgogICAgICAgICMgVGhpcyBtdXN0IGNvbWUgYmVmb3JlIGludCBiZWNhdXNlIGJvb2xzIGFyZSBhbHNvIGludHMKICAgICAgICByZXR1cm4KICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIE5VTUJFUlRZUEVTKToKICAgICAgICB5aWVsZCB0b19uYXRpdmUob2JqLCBub25zdHJpbmc9J3NpbXBsZXJlcHInKQogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ1Vua25vd24gcGFyYW1ldGVyIHR5cGU6ICVzLCAlcycgJSAodHlwZShvYmopLCBvYmopKQoKZGVmIHJlbW92ZV92YWx1ZXModmFsdWUsIG5vX2xvZ19zdHJpbmdzKToKICAgICIiIiBSZW1vdmUgc3RyaW5ncyBpbiBub19sb2dfc3RyaW5ncyBmcm9tIHZhbHVlLiAgSWYgdmFsdWUgaXMgYSBjb250YWluZXIKICAgIHR5cGUsIHRoZW4gcmVtb3ZlIGEgbG90IG1vcmUiIiIKICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgIyBOZWVkIG5hdGl2ZSBzdHIgdHlwZQogICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSB2YWx1ZQogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHRleHRfdHlwZSk6CiAgICAgICAgICAgIHZhbHVlX2lzX3RleHQgPSBUcnVlCiAgICAgICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSB0b19ieXRlcyh2YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgdmFsdWVfaXNfdGV4dCA9IEZhbHNlCiAgICAgICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSB0b190ZXh0KHZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQoKICAgICAgICBpZiBuYXRpdmVfc3RyX3ZhbHVlIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICByZXR1cm4gJ1ZBTFVFX1NQRUNJRklFRF9JTl9OT19MT0dfUEFSQU1FVEVSJwogICAgICAgIGZvciBvbWl0X21lIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICBuYXRpdmVfc3RyX3ZhbHVlID0gbmF0aXZlX3N0cl92YWx1ZS5yZXBsYWNlKG9taXRfbWUsICcqJyAqIDgpCgogICAgICAgIGlmIHZhbHVlX2lzX3RleHQgYW5kIGlzaW5zdGFuY2UobmF0aXZlX3N0cl92YWx1ZSwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICB2YWx1ZSA9IHRvX3RleHQobmF0aXZlX3N0cl92YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykKICAgICAgICBlbGlmIG5vdCB2YWx1ZV9pc190ZXh0IGFuZCBpc2luc3RhbmNlKG5hdGl2ZV9zdHJfdmFsdWUsIHRleHRfdHlwZSk6CiAgICAgICAgICAgIHZhbHVlID0gdG9fYnl0ZXMobmF0aXZlX3N0cl92YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykKICAgICAgICBlbHNlOgogICAgICAgICAgICB2YWx1ZSA9IG5hdGl2ZV9zdHJfdmFsdWUKICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgU0VRVUVOQ0VUWVBFKToKICAgICAgICByZXR1cm4gW3JlbW92ZV92YWx1ZXMoZWxlbSwgbm9fbG9nX3N0cmluZ3MpIGZvciBlbGVtIGluIHZhbHVlXQogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBNYXBwaW5nKToKICAgICAgICByZXR1cm4gZGljdCgoaywgcmVtb3ZlX3ZhbHVlcyh2LCBub19sb2dfc3RyaW5ncykpIGZvciBrLCB2IGluIHZhbHVlLml0ZW1zKCkpCiAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIHR1cGxlKGNoYWluKE5VTUJFUlRZUEVTLCAoYm9vbCwgTm9uZVR5cGUpKSkpOgogICAgICAgIHN0cmluZ3lfdmFsdWUgPSB0b19uYXRpdmUodmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgaWYgc3RyaW5neV92YWx1ZSBpbiBub19sb2dfc3RyaW5nczoKICAgICAgICAgICAgcmV0dXJuICdWQUxVRV9TUEVDSUZJRURfSU5fTk9fTE9HX1BBUkFNRVRFUicKICAgICAgICBmb3Igb21pdF9tZSBpbiBub19sb2dfc3RyaW5nczoKICAgICAgICAgICAgaWYgb21pdF9tZSBpbiBzdHJpbmd5X3ZhbHVlOgogICAgICAgICAgICAgICAgcmV0dXJuICdWQUxVRV9TUEVDSUZJRURfSU5fTk9fTE9HX1BBUkFNRVRFUicKICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgZGF0ZXRpbWUuZGF0ZXRpbWUpOgogICAgICAgIHZhbHVlID0gdmFsdWUuaXNvZm9ybWF0KCkKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdWYWx1ZSBvZiB1bmtub3duIHR5cGU6ICVzLCAlcycgJSAodHlwZSh2YWx1ZSksIHZhbHVlKSkKICAgIHJldHVybiB2YWx1ZQoKCmRlZiBoZXVyaXN0aWNfbG9nX3Nhbml0aXplKGRhdGEsIG5vX2xvZ192YWx1ZXM9Tm9uZSk6CiAgICAnJycgUmVtb3ZlIHN0cmluZ3MgdGhhdCBsb29rIGxpa2UgcGFzc3dvcmRzIGZyb20gbG9nIG1lc3NhZ2VzICcnJwogICAgIyBDdXJyZW50bHkgZmlsdGVyczoKICAgICMgdXNlcjpwYXNzQGZvby93aGF0ZXZlciBhbmQgaHR0cDovL3VzZXJuYW1lOnBhc3NAd2hlcmV2ZXIvZm9vCiAgICAjIFRoaXMgY29kZSBoYXMgZmFsc2UgcG9zaXRpdmVzIGFuZCBjb25zdW1lcyBwYXJ0cyBvZiBsb2dzIHRoYXQgYXJlCiAgICAjIG5vdCBwYXNzd2RzCgogICAgIyBiZWdpbjogc3RhcnQgb2YgYSBwYXNzd2QgY29udGFpbmluZyBzdHJpbmcKICAgICMgZW5kOiBlbmQgb2YgYSBwYXNzd2QgY29udGFpbmluZyBzdHJpbmcKICAgICMgc2VwOiBjaGFyIGJldHdlZW4gdXNlciBhbmQgcGFzc3dkCiAgICAjIHByZXZfYmVnaW46IHdoZXJlIGluIHRoZSBvdmVyYWxsIHN0cmluZyB0byBzdGFydCBhIHNlYXJjaCBmb3IKICAgICMgICBhIHBhc3N3ZAogICAgIyBzZXBfc2VhcmNoX2VuZDogd2hlcmUgaW4gdGhlIHN0cmluZyB0byBlbmQgYSBzZWFyY2ggZm9yIHRoZSBzZXAKICAgIGRhdGEgPSB0b19uYXRpdmUoZGF0YSkKCiAgICBvdXRwdXQgPSBbXQogICAgYmVnaW4gPSBsZW4oZGF0YSkKICAgIHByZXZfYmVnaW4gPSBiZWdpbgogICAgc2VwID0gMQogICAgd2hpbGUgc2VwOgogICAgICAgICMgRmluZCB0aGUgcG90ZW50aWFsIGVuZCBvZiBhIHBhc3N3ZAogICAgICAgIHRyeToKICAgICAgICAgICAgZW5kID0gZGF0YS5yaW5kZXgoJ0AnLCAwLCBiZWdpbikKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgIyBObyBwYXNzd2QgaW4gdGhlIHJlc3Qgb2YgdGhlIGRhdGEKICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCBkYXRhWzA6YmVnaW5dKQogICAgICAgICAgICBicmVhawoKICAgICAgICAjIFNlYXJjaCBmb3IgdGhlIGJlZ2lubmluZyBvZiBhIHBhc3N3ZAogICAgICAgIHNlcCA9IE5vbmUKICAgICAgICBzZXBfc2VhcmNoX2VuZCA9IGVuZAogICAgICAgIHdoaWxlIG5vdCBzZXA6CiAgICAgICAgICAgICMgVVJMLXN0eWxlIHVzZXJuYW1lK3Bhc3N3b3JkCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGJlZ2luID0gZGF0YS5yaW5kZXgoJzovLycsIDAsIHNlcF9zZWFyY2hfZW5kKQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICMgTm8gdXJsIHN0eWxlIGluIHRoZSBkYXRhLCBjaGVjayBmb3Igc3NoIHN0eWxlIGluIHRoZQogICAgICAgICAgICAgICAgIyByZXN0IG9mIHRoZSBzdHJpbmcKICAgICAgICAgICAgICAgIGJlZ2luID0gMAogICAgICAgICAgICAjIFNlYXJjaCBmb3Igc2VwYXJhdG9yCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlcCA9IGRhdGEuaW5kZXgoJzonLCBiZWdpbiArIDMsIGVuZCkKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAjIE5vIHNlcGFyYXRvcjsgY2hvaWNlczoKICAgICAgICAgICAgICAgIGlmIGJlZ2luID09IDA6CiAgICAgICAgICAgICAgICAgICAgIyBTZWFyY2hlZCB0aGUgd2hvbGUgc3RyaW5nIHNvIHRoZXJlJ3Mgbm8gcGFzc3dvcmQKICAgICAgICAgICAgICAgICAgICAjIGhlcmUuICBSZXR1cm4gdGhlIHJlbWFpbmluZyBkYXRhCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCBkYXRhWzA6YmVnaW5dKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAjIFNlYXJjaCBmb3IgYSBkaWZmZXJlbnQgYmVnaW5uaW5nIG9mIHRoZSBwYXNzd29yZCBmaWVsZC4KICAgICAgICAgICAgICAgIHNlcF9zZWFyY2hfZW5kID0gYmVnaW4KICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgaWYgc2VwOgogICAgICAgICAgICAjIFBhc3N3b3JkIHdhcyBmb3VuZDsgcmVtb3ZlIGl0LgogICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsIGRhdGFbZW5kOnByZXZfYmVnaW5dKQogICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsICcqKioqKioqKicpCiAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgZGF0YVtiZWdpbjpzZXAgKyAxXSkKICAgICAgICAgICAgcHJldl9iZWdpbiA9IGJlZ2luCgogICAgb3V0cHV0ID0gJycuam9pbihvdXRwdXQpCiAgICBpZiBub19sb2dfdmFsdWVzOgogICAgICAgIG91dHB1dCA9IHJlbW92ZV92YWx1ZXMob3V0cHV0LCBub19sb2dfdmFsdWVzKQogICAgcmV0dXJuIG91dHB1dAoKZGVmIGJ5dGVzX3RvX2h1bWFuKHNpemUsIGlzYml0cz1GYWxzZSwgdW5pdD1Ob25lKToKCiAgICBiYXNlID0gJ0J5dGVzJwogICAgaWYgaXNiaXRzOgogICAgICAgIGJhc2UgPSAnYml0cycKICAgIHN1ZmZpeCA9ICcnCgogICAgZm9yIHN1ZmZpeCwgbGltaXQgaW4gc29ydGVkKGl0ZXJpdGVtcyhTSVpFX1JBTkdFUyksIGtleT1sYW1iZGEgaXRlbTogLWl0ZW1bMV0pOgogICAgICAgIGlmICh1bml0IGlzIE5vbmUgYW5kIHNpemUgPj0gbGltaXQpIG9yIHVuaXQgaXMgbm90IE5vbmUgYW5kIHVuaXQudXBwZXIoKSA9PSBzdWZmaXhbMF06CiAgICAgICAgICAgIGJyZWFrCgogICAgaWYgbGltaXQgIT0gMToKICAgICAgICBzdWZmaXggKz0gYmFzZVswXQogICAgZWxzZToKICAgICAgICBzdWZmaXggPSBiYXNlCgogICAgcmV0dXJuICclLjJmICVzJyAlIChmbG9hdChzaXplKS8gbGltaXQsIHN1ZmZpeCkKCmRlZiBodW1hbl90b19ieXRlcyhudW1iZXIsIGRlZmF1bHRfdW5pdD1Ob25lLCBpc2JpdHM9RmFsc2UpOgoKICAgICcnJwogICAgQ29udmVydCBudW1iZXIgaW4gc3RyaW5nIGZvcm1hdCBpbnRvIGJ5dGVzIChleDogJzJLJyA9PiAyMDQ4KSBvciB1c2luZyB1bml0IGFyZ3VtZW50CiAgICBleDoKICAgICAgaHVtYW5fdG9fYnl0ZXMoJzEwTScpIDw9PiBodW1hbl90b19ieXRlcygxMCwgJ00nKQogICAgJycnCiAgICBtID0gcmUuc2VhcmNoKCdeXHMqKFxkKlwuP1xkKilccyooW0EtWmEtel0rKT8nLCBzdHIobnVtYmVyKSwgZmxhZ3M9cmUuSUdOT1JFQ0FTRSkKICAgIGlmIG0gaXMgTm9uZToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJodW1hbl90b19ieXRlcygpIGNhbid0IGludGVycHJldCBmb2xsb3dpbmcgc3RyaW5nOiAlcyIgJSBzdHIobnVtYmVyKSkKICAgIHRyeToKICAgICAgICBudW0gPSBmbG9hdChtLmdyb3VwKDEpKQogICAgZXhjZXB0OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgY2FuJ3QgaW50ZXJwcmV0IGZvbGxvd2luZyBudW1iZXI6ICVzIChvcmlnaW5hbCBpbnB1dCBzdHJpbmc6ICVzKSIgJSAobS5ncm91cCgxKSwgbnVtYmVyKSkKCiAgICB1bml0ID0gbS5ncm91cCgyKQogICAgaWYgdW5pdCBpcyBOb25lOgogICAgICAgIHVuaXQgPSBkZWZhdWx0X3VuaXQKCiAgICBpZiB1bml0IGlzIE5vbmU6CiAgICAgICAgJycnIE5vIHVuaXQgZ2l2ZW4sIHJldHVybmluZyByYXcgbnVtYmVyICcnJwogICAgICAgIHJldHVybiBpbnQocm91bmQobnVtKSkKICAgIHJhbmdlX2tleSA9IHVuaXRbMF0udXBwZXIoKQogICAgdHJ5OgogICAgICAgIGxpbWl0ID0gU0laRV9SQU5HRVNbcmFuZ2Vfa2V5XQogICAgZXhjZXB0OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgZmFpbGVkIHRvIGNvbnZlcnQgJXMgKHVuaXQgPSAlcykuIFRoZSBzdWZmaXggbXVzdCBiZSBvbmUgb2YgJXMiICUgKG51bWJlciwgdW5pdCwgIiwgIi5qb2luKFNJWkVfUkFOR0VTLmtleXMoKSkpKQoKICAgICMgZGVmYXVsdCB2YWx1ZQogICAgdW5pdF9jbGFzcyA9ICdCJwogICAgdW5pdF9jbGFzc19uYW1lID0gJ2J5dGUnCiAgICAjIGhhbmRsaW5nIGJpdHMgY2FzZQogICAgaWYgaXNiaXRzOgogICAgICAgIHVuaXRfY2xhc3MgPSAnYicKICAgICAgICB1bml0X2NsYXNzX25hbWUgPSAnYml0JwogICAgIyBjaGVjayB1bml0IHZhbHVlIGlmIG1vcmUgdGhhbiBvbmUgY2hhcmFjdGVyIChLQiwgTUIpCiAgICBpZiBsZW4odW5pdCkgPiAxOgogICAgICAgIGV4cGVjdF9tZXNzYWdlID0gJ2V4cGVjdCAlcyVzIG9yICVzJyAlIChyYW5nZV9rZXksIHVuaXRfY2xhc3MsIHJhbmdlX2tleSkKICAgICAgICBpZiByYW5nZV9rZXkgPT0gJ0InOgogICAgICAgICAgICBleHBlY3RfbWVzc2FnZSA9ICdleHBlY3QgJXMgb3IgJXMnICUgKHVuaXRfY2xhc3MsIHVuaXRfY2xhc3NfbmFtZSkKCiAgICAgICAgaWYgdW5pdF9jbGFzc19uYW1lIGluIHVuaXQubG93ZXIoKToKICAgICAgICAgICAgcGFzcwogICAgICAgIGVsaWYgdW5pdFsxXSAhPSB1bml0X2NsYXNzOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJodW1hbl90b19ieXRlcygpIGZhaWxlZCB0byBjb252ZXJ0ICVzLiBWYWx1ZSBpcyBub3QgYSB2YWxpZCBzdHJpbmcgKCVzKSIgJSAobnVtYmVyLCBleHBlY3RfbWVzc2FnZSkpCgogICAgcmV0dXJuIGludChyb3VuZChudW0gKiBsaW1pdCkpCgpkZWYgaXNfZXhlY3V0YWJsZShwYXRoKToKICAgICcnJ2lzIHRoZSBnaXZlbiBwYXRoIGV4ZWN1dGFibGU/CgogICAgTGltaXRhdGlvbnM6CiAgICAqIERvZXMgbm90IGFjY291bnQgZm9yIEZTQUNMcy4KICAgICogTW9zdCB0aW1lcyB3ZSByZWFsbHkgd2FudCB0byBrbm93ICJDYW4gdGhlIGN1cnJlbnQgdXNlciBleGVjdXRlIHRoaXMKICAgICAgZmlsZSIgIFRoaXMgZnVuY3Rpb24gZG9lcyBub3QgdGVsbCB1cyB0aGF0LCBvbmx5IGlmIGFuIGV4ZWN1dGUgYml0IGlzIHNldC4KICAgICcnJwogICAgIyBUaGVzZSBhcmUgYWxsIGJpdGZpZWxkcyBzbyBmaXJzdCBiaXR3aXNlLW9yIGFsbCB0aGUgcGVybWlzc2lvbnMgd2UncmUKICAgICMgbG9va2luZyBmb3IsIHRoZW4gYml0d2lzZS1hbmQgd2l0aCB0aGUgZmlsZSdzIG1vZGUgdG8gZGV0ZXJtaW5lIGlmIGFueQogICAgIyBleGVjdXRlIGJpdHMgYXJlIHNldC4KICAgIHJldHVybiAoKHN0YXQuU19JWFVTUiB8IHN0YXQuU19JWEdSUCB8IHN0YXQuU19JWE9USCkgJiBvcy5zdGF0KHBhdGgpW3N0YXQuU1RfTU9ERV0pCgpkZWYgX2xvYWRfcGFyYW1zKCk6CiAgICAnJycgcmVhZCB0aGUgbW9kdWxlcyBwYXJhbWV0ZXJzIGFuZCBzdG9yZSB0aGVtIGdsb2JhbGx5LgoKICAgIFRoaXMgZnVuY3Rpb24gbWF5IGJlIG5lZWRlZCBmb3IgY2VydGFpbiB2ZXJ5IGR5bmFtaWMgY3VzdG9tIG1vZHVsZXMgd2hpY2gKICAgIHdhbnQgdG8gcHJvY2VzcyB0aGUgcGFyYW1ldGVycyB0aGF0IGFyZSBiZWluZyBoYW5kZWQgdGhlIG1vZHVsZS4gIFNpbmNlCiAgICB0aGlzIGlzIHNvIGNsb3NlbHkgdGllZCB0byB0aGUgaW1wbGVtZW50YXRpb24gb2YgbW9kdWxlcyB3ZSBjYW5ub3QKICAgIGd1YXJhbnRlZSBBUEkgc3RhYmlsaXR5IGZvciBpdCAoaXQgbWF5IGNoYW5nZSBiZXR3ZWVuIHZlcnNpb25zKSBob3dldmVyIHdlCiAgICB3aWxsIHRyeSBub3QgdG8gYnJlYWsgaXQgZ3JhdHVpdG91c2x5LiAgSXQgaXMgY2VydGFpbmx5IG1vcmUgZnV0dXJlLXByb29mCiAgICB0byBjYWxsIHRoaXMgZnVuY3Rpb24gYW5kIGNvbnN1bWUgaXRzIG91dHB1dHMgdGhhbiB0byBpbXBsZW1lbnQgdGhlIGxvZ2ljCiAgICBpbnNpZGUgaXQgYXMgYSBjb3B5IGluIHlvdXIgb3duIGNvZGUuCiAgICAnJycKICAgIGdsb2JhbCBfQU5TSUJMRV9BUkdTCiAgICBpZiBfQU5TSUJMRV9BUkdTIGlzIG5vdCBOb25lOgogICAgICAgIGJ1ZmZlciA9IF9BTlNJQkxFX0FSR1MKICAgIGVsc2U6CiAgICAgICAgIyBkZWJ1ZyBvdmVycmlkZXMgdG8gcmVhZCBhcmdzIGZyb20gZmlsZSBvciBjbWRsaW5lCgogICAgICAgICMgQXZvaWQgdHJhY2ViYWNrcyB3aGVuIGxvY2FsZSBpcyBub24tdXRmOAogICAgICAgICMgV2UgY29udHJvbCB0aGUgYXJncyBhbmQgd2UgcGFzcyB0aGVtIGFzIHV0ZjgKICAgICAgICBpZiBsZW4oc3lzLmFyZ3YpID4gMToKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUoc3lzLmFyZ3ZbMV0pOgogICAgICAgICAgICAgICAgZmQgPSBvcGVuKHN5cy5hcmd2WzFdLCAncmInKQogICAgICAgICAgICAgICAgYnVmZmVyID0gZmQucmVhZCgpCiAgICAgICAgICAgICAgICBmZC5jbG9zZSgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzeXMuYXJndlsxXQogICAgICAgICAgICAgICAgaWYgUFkzOgogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IGJ1ZmZlci5lbmNvZGUoJ3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICMgZGVmYXVsdCBjYXNlLCByZWFkIGZyb20gc3RkaW4KICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBQWTI6CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzeXMuc3RkaW4ucmVhZCgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzeXMuc3RkaW4uYnVmZmVyLnJlYWQoKQogICAgICAgIF9BTlNJQkxFX0FSR1MgPSBidWZmZXIKCiAgICB0cnk6CiAgICAgICAgcGFyYW1zID0ganNvbi5sb2FkcyhidWZmZXIuZGVjb2RlKCd1dGYtOCcpKQogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgIyBUaGlzIGhlbHBlciB1c2VkIHRvbyBlYXJseSBmb3IgZmFpbF9qc29uIHRvIHdvcmsuCiAgICAgICAgcHJpbnQoJ1xueyJtc2ciOiAiRXJyb3I6IE1vZHVsZSB1bmFibGUgdG8gZGVjb2RlIHZhbGlkIEpTT04gb24gc3RkaW4uICBVbmFibGUgdG8gZmlndXJlIG91dCB3aGF0IHBhcmFtZXRlcnMgd2VyZSBwYXNzZWQiLCAiZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCgogICAgaWYgUFkyOgogICAgICAgIHBhcmFtcyA9IGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzKHBhcmFtcykKCiAgICB0cnk6CiAgICAgICAgcmV0dXJuIHBhcmFtc1snQU5TSUJMRV9NT0RVTEVfQVJHUyddCiAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgIyBUaGlzIGhlbHBlciBkb2VzIG5vdCBoYXZlIGFjY2VzcyB0byBmYWlsX2pzb24gc28gd2UgaGF2ZSB0byBwcmludAogICAgICAgICMganNvbiBvdXRwdXQgb24gb3VyIG93bi4KICAgICAgICBwcmludCgnXG57Im1zZyI6ICJFcnJvcjogTW9kdWxlIHVuYWJsZSB0byBsb2NhdGUgQU5TSUJMRV9NT0RVTEVfQVJHUyBpbiBqc29uIGRhdGEgZnJvbSBzdGRpbi4gIFVuYWJsZSB0byBmaWd1cmUgb3V0IHdoYXQgcGFyYW1ldGVycyB3ZXJlIHBhc3NlZCIsICcKICAgICAgICAgICAgICAnImZhaWxlZCI6IHRydWV9JykKICAgICAgICBzeXMuZXhpdCgxKQoKZGVmIGVudl9mYWxsYmFjaygqYXJncywgKiprd2FyZ3MpOgogICAgJycnIExvYWQgdmFsdWUgZnJvbSBlbnZpcm9ubWVudCAnJycKICAgIGZvciBhcmcgaW4gYXJnczoKICAgICAgICBpZiBhcmcgaW4gb3MuZW52aXJvbjoKICAgICAgICAgICAgcmV0dXJuIG9zLmVudmlyb25bYXJnXQogICAgZWxzZToKICAgICAgICByYWlzZSBBbnNpYmxlRmFsbGJhY2tOb3RGb3VuZAoKZGVmIF9sZW5pZW50X2xvd2VyY2FzZShsc3QpOgogICAgIiIiTG93ZXJjYXNlIGVsZW1lbnRzIG9mIGEgbGlzdC4KCiAgICBJZiBhbiBlbGVtZW50IGlzIG5vdCBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIHVudG91Y2hlZC4KICAgICIiIgogICAgbG93ZXJlZCA9IFtdCiAgICBmb3IgdmFsdWUgaW4gbHN0OgogICAgICAgIHRyeToKICAgICAgICAgICAgbG93ZXJlZC5hcHBlbmQodmFsdWUubG93ZXIoKSkKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgIGxvd2VyZWQuYXBwZW5kKHZhbHVlKQogICAgcmV0dXJuIGxvd2VyZWQKCmRlZiBmb3JtYXRfYXR0cmlidXRlcyhhdHRyaWJ1dGVzKToKICAgIGF0dHJpYnV0ZV9saXN0ID0gW10KICAgIGZvciBhdHRyIGluIGF0dHJpYnV0ZXM6CiAgICAgICAgaWYgYXR0ciBpbiBGSUxFX0FUVFJJQlVURVM6CiAgICAgICAgICAgIGF0dHJpYnV0ZV9saXN0LmFwcGVuZChGSUxFX0FUVFJJQlVURVNbYXR0cl0pCiAgICByZXR1cm4gYXR0cmlidXRlX2xpc3QKCmRlZiBnZXRfZmxhZ3NfZnJvbV9hdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpOgogICAgZmxhZ3MgPSBbXQogICAgZm9yIGtleSxhdHRyIGluIEZJTEVfQVRUUklCVVRFUy5pdGVtcygpOgogICAgICAgIGlmIGF0dHIgaW4gYXR0cmlidXRlczoKICAgICAgICAgICAgZmxhZ3MuYXBwZW5kKGtleSkKICAgIHJldHVybiAnJy5qb2luKGZsYWdzKQoKY2xhc3MgQW5zaWJsZUZhbGxiYWNrTm90Rm91bmQoRXhjZXB0aW9uKToKICAgIHBhc3MKCgpjbGFzcyBBbnNpYmxlTW9kdWxlKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgYXJndW1lbnRfc3BlYywgYnlwYXNzX2NoZWNrcz1GYWxzZSwgbm9fbG9nPUZhbHNlLAogICAgICAgICAgICAgICAgIGNoZWNrX2ludmFsaWRfYXJndW1lbnRzPVRydWUsIG11dHVhbGx5X2V4Y2x1c2l2ZT1Ob25lLCByZXF1aXJlZF90b2dldGhlcj1Ob25lLAogICAgICAgICAgICAgICAgIHJlcXVpcmVkX29uZV9vZj1Ob25lLCBhZGRfZmlsZV9jb21tb25fYXJncz1GYWxzZSwgc3VwcG9ydHNfY2hlY2tfbW9kZT1GYWxzZSwKICAgICAgICAgICAgICAgICByZXF1aXJlZF9pZj1Ob25lKToKCiAgICAgICAgJycnCiAgICAgICAgY29tbW9uIGNvZGUgZm9yIHF1aWNrbHkgYnVpbGRpbmcgYW4gYW5zaWJsZSBtb2R1bGUgaW4gUHl0aG9uCiAgICAgICAgKGFsdGhvdWdoIHlvdSBjYW4gd3JpdGUgbW9kdWxlcyBpbiBhbnl0aGluZyB0aGF0IGNhbiByZXR1cm4gSlNPTikKICAgICAgICBzZWUgbGlicmFyeS8qIGZvciBleGFtcGxlcwogICAgICAgICcnJwoKICAgICAgICBzZWxmLl9uYW1lID0gb3MucGF0aC5iYXNlbmFtZShfX2ZpbGVfXykgI2luaXRpYWxpemUgbmFtZSB1bnRpbCB3ZSBjYW4gcGFyc2UgZnJvbSBvcHRpb25zCiAgICAgICAgc2VsZi5hcmd1bWVudF9zcGVjID0gYXJndW1lbnRfc3BlYwogICAgICAgIHNlbGYuc3VwcG9ydHNfY2hlY2tfbW9kZSA9IHN1cHBvcnRzX2NoZWNrX21vZGUKICAgICAgICBzZWxmLmNoZWNrX21vZGUgPSBGYWxzZQogICAgICAgIHNlbGYubm9fbG9nID0gbm9fbG9nCiAgICAgICAgc2VsZi5jbGVhbnVwX2ZpbGVzID0gW10KICAgICAgICBzZWxmLl9kZWJ1ZyA9IEZhbHNlCiAgICAgICAgc2VsZi5fZGlmZiA9IEZhbHNlCiAgICAgICAgc2VsZi5fc29ja2V0X3BhdGggPSBOb25lCiAgICAgICAgc2VsZi5fdmVyYm9zaXR5ID0gMAogICAgICAgICMgTWF5IGJlIHVzZWQgdG8gc2V0IG1vZGlmaWNhdGlvbnMgdG8gdGhlIGVudmlyb25tZW50IGZvciBhbnkKICAgICAgICAjIHJ1bl9jb21tYW5kIGludm9jYXRpb24KICAgICAgICBzZWxmLnJ1bl9jb21tYW5kX2Vudmlyb25fdXBkYXRlID0ge30KICAgICAgICBzZWxmLl93YXJuaW5ncyA9IFtdCiAgICAgICAgc2VsZi5fZGVwcmVjYXRpb25zID0gW10KCiAgICAgICAgc2VsZi5hbGlhc2VzID0ge30KICAgICAgICBzZWxmLl9sZWdhbF9pbnB1dHMgPSBbJ19hbnNpYmxlX2NoZWNrX21vZGUnLCAnX2Fuc2libGVfbm9fbG9nJywgJ19hbnNpYmxlX2RlYnVnJywgJ19hbnNpYmxlX2RpZmYnLCAnX2Fuc2libGVfdmVyYm9zaXR5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ19hbnNpYmxlX3NlbGludXhfc3BlY2lhbF9mcycsICdfYW5zaWJsZV9tb2R1bGVfbmFtZScsICdfYW5zaWJsZV92ZXJzaW9uJywgJ19hbnNpYmxlX3N5c2xvZ19mYWNpbGl0eScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdfYW5zaWJsZV9zb2NrZXQnXQoKICAgICAgICBpZiBhZGRfZmlsZV9jb21tb25fYXJnczoKICAgICAgICAgICAgZm9yIGssIHYgaW4gRklMRV9DT01NT05fQVJHVU1FTlRTLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBrIG5vdCBpbiBzZWxmLmFyZ3VtZW50X3NwZWM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5hcmd1bWVudF9zcGVjW2tdID0gdgoKICAgICAgICBzZWxmLl9sb2FkX3BhcmFtcygpCiAgICAgICAgc2VsZi5fc2V0X2ZhbGxiYWNrcygpCgogICAgICAgICMgYXBwZW5kIHRvIGxlZ2FsX2lucHV0cyBhbmQgdGhlbiBwb3NzaWJseSBjaGVjayBhZ2FpbnN0IHRoZW0KICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuYWxpYXNlcyA9IHNlbGYuX2hhbmRsZV9hbGlhc2VzKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICMgVXNlIGV4Y2VwdGlvbnMgaGVyZSBiZWNhdXNlIGl0IGlzbid0IHNhZmUgdG8gY2FsbCBmYWlsX2pzb24gdW50aWwgbm9fbG9nIGlzIHByb2Nlc3NlZAogICAgICAgICAgICBwcmludCgnXG57ImZhaWxlZCI6IHRydWUsICJtc2ciOiAiTW9kdWxlIGFsaWFzIGVycm9yOiAlcyJ9JyAlIHN0cihlKSkKICAgICAgICAgICAgc3lzLmV4aXQoMSkKCiAgICAgICAgIyBTYXZlIHBhcmFtZXRlciB2YWx1ZXMgdGhhdCBzaG91bGQgbmV2ZXIgYmUgbG9nZ2VkCiAgICAgICAgc2VsZi5ub19sb2dfdmFsdWVzID0gc2V0KCkKICAgICAgICAjIFVzZSB0aGUgYXJnc3BlYyB0byBkZXRlcm1pbmUgd2hpY2ggYXJncyBhcmUgbm9fbG9nCiAgICAgICAgZm9yIGFyZ19uYW1lLCBhcmdfb3B0cyBpbiBzZWxmLmFyZ3VtZW50X3NwZWMuaXRlbXMoKToKICAgICAgICAgICAgaWYgYXJnX29wdHMuZ2V0KCdub19sb2cnLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAjIEZpbmQgdGhlIHZhbHVlIGZvciB0aGUgbm9fbG9nJ2QgcGFyYW0KICAgICAgICAgICAgICAgIG5vX2xvZ19vYmplY3QgPSBzZWxmLnBhcmFtcy5nZXQoYXJnX25hbWUsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBub19sb2dfb2JqZWN0OgogICAgICAgICAgICAgICAgICAgIHNlbGYubm9fbG9nX3ZhbHVlcy51cGRhdGUocmV0dXJuX3ZhbHVlcyhub19sb2dfb2JqZWN0KSkKCiAgICAgICAgICAgIGlmIGFyZ19vcHRzLmdldCgncmVtb3ZlZF9pbl92ZXJzaW9uJykgaXMgbm90IE5vbmUgYW5kIGFyZ19uYW1lIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgc2VsZi5fZGVwcmVjYXRpb25zLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAgICAgJ21zZyc6ICJQYXJhbSAnJXMnIGlzIGRlcHJlY2F0ZWQuIFNlZSB0aGUgbW9kdWxlIGRvY3MgZm9yIG1vcmUgaW5mb3JtYXRpb24iICUgYXJnX25hbWUsCiAgICAgICAgICAgICAgICAgICAgJ3ZlcnNpb24nOiBhcmdfb3B0cy5nZXQoJ3JlbW92ZWRfaW5fdmVyc2lvbicpCiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAjIGNoZWNrIHRoZSBsb2NhbGUgYXMgc2V0IGJ5IHRoZSBjdXJyZW50IGVudmlyb25tZW50LCBhbmQgcmVzZXQgdG8KICAgICAgICAjIGEga25vd24gdmFsaWQgKExBTkc9QykgaWYgaXQncyBhbiBpbnZhbGlkL3VuYXZhaWxhYmxlIGxvY2FsZQogICAgICAgIHNlbGYuX2NoZWNrX2xvY2FsZSgpCgogICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50cyhjaGVja19pbnZhbGlkX2FyZ3VtZW50cykKCiAgICAgICAgIyBjaGVjayBleGNsdXNpdmUgZWFybHkKICAgICAgICBpZiBub3QgYnlwYXNzX2NoZWNrczoKICAgICAgICAgICAgc2VsZi5fY2hlY2tfbXV0dWFsbHlfZXhjbHVzaXZlKG11dHVhbGx5X2V4Y2x1c2l2ZSkKCiAgICAgICAgc2VsZi5fc2V0X2RlZmF1bHRzKHByZT1UcnVlKQoKICAgICAgICBzZWxmLl9DSEVDS19BUkdVTUVOVF9UWVBFU19ESVNQQVRDSEVSID0gewogICAgICAgICAgICAnc3RyJzogc2VsZi5fY2hlY2tfdHlwZV9zdHIsCiAgICAgICAgICAgICdsaXN0Jzogc2VsZi5fY2hlY2tfdHlwZV9saXN0LAogICAgICAgICAgICAnZGljdCc6IHNlbGYuX2NoZWNrX3R5cGVfZGljdCwKICAgICAgICAgICAgJ2Jvb2wnOiBzZWxmLl9jaGVja190eXBlX2Jvb2wsCiAgICAgICAgICAgICdpbnQnOiBzZWxmLl9jaGVja190eXBlX2ludCwKICAgICAgICAgICAgJ2Zsb2F0Jzogc2VsZi5fY2hlY2tfdHlwZV9mbG9hdCwKICAgICAgICAgICAgJ3BhdGgnOiBzZWxmLl9jaGVja190eXBlX3BhdGgsCiAgICAgICAgICAgICdyYXcnOiBzZWxmLl9jaGVja190eXBlX3JhdywKICAgICAgICAgICAgJ2pzb25hcmcnOiBzZWxmLl9jaGVja190eXBlX2pzb25hcmcsCiAgICAgICAgICAgICdqc29uJzogc2VsZi5fY2hlY2tfdHlwZV9qc29uYXJnLAogICAgICAgICAgICAnYnl0ZXMnOiBzZWxmLl9jaGVja190eXBlX2J5dGVzLAogICAgICAgICAgICAnYml0cyc6IHNlbGYuX2NoZWNrX3R5cGVfYml0cywKICAgICAgICB9CiAgICAgICAgaWYgbm90IGJ5cGFzc19jaGVja3M6CiAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX2FyZ3VtZW50cygpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50X3R5cGVzKCkKICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdmFsdWVzKCkKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfdG9nZXRoZXIocmVxdWlyZWRfdG9nZXRoZXIpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX29uZV9vZihyZXF1aXJlZF9vbmVfb2YpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX2lmKHJlcXVpcmVkX2lmKQoKICAgICAgICBzZWxmLl9zZXRfZGVmYXVsdHMocHJlPUZhbHNlKQoKICAgICAgICBpZiBub3Qgc2VsZi5ub19sb2c6CiAgICAgICAgICAgIHNlbGYuX2xvZ19pbnZvY2F0aW9uKCkKCiAgICAgICAgIyBmaW5hbGx5LCBtYWtlIHN1cmUgd2UncmUgaW4gYSBzYW5lIHdvcmtpbmcgZGlyCiAgICAgICAgc2VsZi5fc2V0X2N3ZCgpCgogICAgZGVmIHdhcm4oc2VsZiwgd2FybmluZyk6CgogICAgICAgIGlmIGlzaW5zdGFuY2Uod2FybmluZywgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgc2VsZi5fd2FybmluZ3MuYXBwZW5kKHdhcm5pbmcpCiAgICAgICAgICAgIHNlbGYubG9nKCdbV0FSTklOR10gJXMnICUgd2FybmluZykKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoIndhcm4gcmVxdWlyZXMgYSBzdHJpbmcgbm90IGEgJXMiICUgdHlwZSh3YXJuaW5nKSkKCiAgICBkZWYgZGVwcmVjYXRlKHNlbGYsIG1zZywgdmVyc2lvbj1Ob25lKToKICAgICAgICBpZiBpc2luc3RhbmNlKG1zZywgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgc2VsZi5fZGVwcmVjYXRpb25zLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAnbXNnJzogbXNnLAogICAgICAgICAgICAgICAgJ3ZlcnNpb24nOiB2ZXJzaW9uCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIHNlbGYubG9nKCdbREVQUkVDQVRJT04gV0FSTklOR10gJXMgJXMnICUgKG1zZywgdmVyc2lvbikpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJkZXByZWNhdGUgcmVxdWlyZXMgYSBzdHJpbmcgbm90IGEgJXMiICUgdHlwZShtc2cpKQoKICAgIGRlZiBsb2FkX2ZpbGVfY29tbW9uX2FyZ3VtZW50cyhzZWxmLCBwYXJhbXMpOgogICAgICAgICcnJwogICAgICAgIG1hbnkgbW9kdWxlcyBkZWFsIHdpdGggZmlsZXMsIHRoaXMgZW5jYXBzdWxhdGVzIGNvbW1vbgogICAgICAgIG9wdGlvbnMgdGhhdCB0aGUgZmlsZSBtb2R1bGUgYWNjZXB0cyBzdWNoIHRoYXQgaXQgaXMgZGlyZWN0bHkKICAgICAgICBhdmFpbGFibGUgdG8gYWxsIG1vZHVsZXMgYW5kIHRoZXkgY2FuIHNoYXJlIGNvZGUuCiAgICAgICAgJycnCgogICAgICAgIHBhdGggPSBwYXJhbXMuZ2V0KCdwYXRoJywgcGFyYW1zLmdldCgnZGVzdCcsIE5vbmUpKQogICAgICAgIGlmIHBhdGggaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMocGF0aCkpCgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgIyBpZiB0aGUgcGF0aCBpcyBhIHN5bWxpbmssIGFuZCB3ZSdyZSBmb2xsb3dpbmcgbGlua3MsIGdldAogICAgICAgICMgdGhlIHRhcmdldCBvZiB0aGUgbGluayBpbnN0ZWFkIGZvciB0ZXN0aW5nCiAgICAgICAgaWYgcGFyYW1zLmdldCgnZm9sbG93JywgRmFsc2UpIGFuZCBvcy5wYXRoLmlzbGluayhiX3BhdGgpOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLnJlYWxwYXRoKGJfcGF0aCkKICAgICAgICAgICAgcGF0aCA9IHRvX25hdGl2ZShiX3BhdGgpCgogICAgICAgIG1vZGUgICA9IHBhcmFtcy5nZXQoJ21vZGUnLCBOb25lKQogICAgICAgIG93bmVyICA9IHBhcmFtcy5nZXQoJ293bmVyJywgTm9uZSkKICAgICAgICBncm91cCAgPSBwYXJhbXMuZ2V0KCdncm91cCcsIE5vbmUpCgogICAgICAgICMgc2VsaW51eCByZWxhdGVkIG9wdGlvbnMKICAgICAgICBzZXVzZXIgICAgPSBwYXJhbXMuZ2V0KCdzZXVzZXInLCBOb25lKQogICAgICAgIHNlcm9sZSAgICA9IHBhcmFtcy5nZXQoJ3Nlcm9sZScsIE5vbmUpCiAgICAgICAgc2V0eXBlICAgID0gcGFyYW1zLmdldCgnc2V0eXBlJywgTm9uZSkKICAgICAgICBzZWxldmVsICAgPSBwYXJhbXMuZ2V0KCdzZWxldmVsJywgTm9uZSkKICAgICAgICBzZWNvbnRleHQgPSBbc2V1c2VyLCBzZXJvbGUsIHNldHlwZV0KCiAgICAgICAgaWYgc2VsZi5zZWxpbnV4X21sc19lbmFibGVkKCk6CiAgICAgICAgICAgIHNlY29udGV4dC5hcHBlbmQoc2VsZXZlbCkKCiAgICAgICAgZGVmYXVsdF9zZWNvbnRleHQgPSBzZWxmLnNlbGludXhfZGVmYXVsdF9jb250ZXh0KHBhdGgpCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKGRlZmF1bHRfc2Vjb250ZXh0KSk6CiAgICAgICAgICAgIGlmIGkgaXMgbm90IE5vbmUgYW5kIHNlY29udGV4dFtpXSA9PSAnX2RlZmF1bHQnOgogICAgICAgICAgICAgICAgc2Vjb250ZXh0W2ldID0gZGVmYXVsdF9zZWNvbnRleHRbaV0KCiAgICAgICAgYXR0cmlidXRlcyA9IHBhcmFtcy5nZXQoJ2F0dHJpYnV0ZXMnLCBOb25lKQogICAgICAgIHJldHVybiBkaWN0KAogICAgICAgICAgICBwYXRoPXBhdGgsIG1vZGU9bW9kZSwgb3duZXI9b3duZXIsIGdyb3VwPWdyb3VwLAogICAgICAgICAgICBzZXVzZXI9c2V1c2VyLCBzZXJvbGU9c2Vyb2xlLCBzZXR5cGU9c2V0eXBlLAogICAgICAgICAgICBzZWxldmVsPXNlbGV2ZWwsIHNlY29udGV4dD1zZWNvbnRleHQsIGF0dHJpYnV0ZXM9YXR0cmlidXRlcywKICAgICAgICApCgoKICAgICMgRGV0ZWN0IHdoZXRoZXIgdXNpbmcgc2VsaW51eCB0aGF0IGlzIE1MUy1hd2FyZS4KICAgICMgV2hpbGUgdGhpcyBtZWFucyB5b3UgY2FuIHNldCB0aGUgbGV2ZWwvcmFuZ2Ugd2l0aAogICAgIyBzZWxpbnV4LmxzZXRmaWxlY29uKCksIGl0IG1heSBvciBtYXkgbm90IG1lYW4gdGhhdCB5b3UKICAgICMgd2lsbCBnZXQgdGhlIHNlbGV2ZWwgYXMgcGFydCBvZiB0aGUgY29udGV4dCByZXR1cm5lZAogICAgIyBieSBzZWxpbnV4LmxnZXRmaWxlY29uKCkuCgogICAgZGVmIHNlbGludXhfbWxzX2VuYWJsZWQoc2VsZik6CiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgaWYgc2VsaW51eC5pc19zZWxpbnV4X21sc19lbmFibGVkKCkgPT0gMToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgc2VsaW51eF9lbmFibGVkKHNlbGYpOgogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVg6CiAgICAgICAgICAgIHNlZW5hYmxlZCA9IHNlbGYuZ2V0X2Jpbl9wYXRoKCdzZWxpbnV4ZW5hYmxlZCcpCiAgICAgICAgICAgIGlmIHNlZW5hYmxlZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIChyYyxvdXQsZXJyKSA9IHNlbGYucnVuX2NvbW1hbmQoc2VlbmFibGVkKQogICAgICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IkFib3J0aW5nLCB0YXJnZXQgdXNlcyBzZWxpbnV4IGJ1dCBweXRob24gYmluZGluZ3MgKGxpYnNlbGludXgtcHl0aG9uKSBhcmVuJ3QgaW5zdGFsbGVkISIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGlmIHNlbGludXguaXNfc2VsaW51eF9lbmFibGVkKCkgPT0gMToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAjIERldGVybWluZSB3aGV0aGVyIHdlIG5lZWQgYSBwbGFjZWhvbGRlciBmb3Igc2VsZXZlbC9tbHMKICAgIGRlZiBzZWxpbnV4X2luaXRpYWxfY29udGV4dChzZWxmKToKICAgICAgICBjb250ZXh0ID0gW05vbmUsIE5vbmUsIE5vbmVdCiAgICAgICAgaWYgc2VsZi5zZWxpbnV4X21sc19lbmFibGVkKCk6CiAgICAgICAgICAgIGNvbnRleHQuYXBwZW5kKE5vbmUpCiAgICAgICAgcmV0dXJuIGNvbnRleHQKCiAgICAjIElmIHNlbGludXggZmFpbHMgdG8gZmluZCBhIGRlZmF1bHQsIHJldHVybiBhbiBhcnJheSBvZiBOb25lCiAgICBkZWYgc2VsaW51eF9kZWZhdWx0X2NvbnRleHQoc2VsZiwgcGF0aCwgbW9kZT0wKToKICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2luaXRpYWxfY29udGV4dCgpCiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldCA9IHNlbGludXgubWF0Y2hwYXRoY29uKHRvX25hdGl2ZShwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKSwgbW9kZSkKICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICBpZiByZXRbMF0gPT0gLTE6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgIyBMaW1pdCBzcGxpdCB0byA0IGJlY2F1c2UgdGhlIHNlbGV2ZWwsIHRoZSBsYXN0IGluIHRoZSBsaXN0LAogICAgICAgICMgbWF5IGNvbnRhaW4gJzonIGNoYXJhY3RlcnMKICAgICAgICBjb250ZXh0ID0gcmV0WzFdLnNwbGl0KCc6JywgMykKICAgICAgICByZXR1cm4gY29udGV4dAoKICAgIGRlZiBzZWxpbnV4X2NvbnRleHQoc2VsZiwgcGF0aCk6CiAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9pbml0aWFsX2NvbnRleHQoKQogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVggb3Igbm90IHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXQgPSBzZWxpbnV4LmxnZXRmaWxlY29uX3Jhdyh0b19uYXRpdmUocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykpCiAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgaWYgZS5lcnJubyA9PSBlcnJuby5FTk9FTlQ6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0ncGF0aCAlcyBkb2VzIG5vdCBleGlzdCcgJSBwYXRoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2ZhaWxlZCB0byByZXRyaWV2ZSBzZWxpbnV4IGNvbnRleHQnKQogICAgICAgIGlmIHJldFswXSA9PSAtMToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICAjIExpbWl0IHNwbGl0IHRvIDQgYmVjYXVzZSB0aGUgc2VsZXZlbCwgdGhlIGxhc3QgaW4gdGhlIGxpc3QsCiAgICAgICAgIyBtYXkgY29udGFpbiAnOicgY2hhcmFjdGVycwogICAgICAgIGNvbnRleHQgPSByZXRbMV0uc3BsaXQoJzonLCAzKQogICAgICAgIHJldHVybiBjb250ZXh0CgogICAgZGVmIHVzZXJfYW5kX2dyb3VwKHNlbGYsIHBhdGgsIGV4cGFuZD1UcnVlKToKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgc3QgPSBvcy5sc3RhdChiX3BhdGgpCiAgICAgICAgdWlkID0gc3Quc3RfdWlkCiAgICAgICAgZ2lkID0gc3Quc3RfZ2lkCiAgICAgICAgcmV0dXJuICh1aWQsIGdpZCkKCiAgICBkZWYgZmluZF9tb3VudF9wb2ludChzZWxmLCBwYXRoKToKICAgICAgICBwYXRoX2lzX2J5dGVzID0gRmFsc2UKICAgICAgICBpZiBpc2luc3RhbmNlKHBhdGgsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgcGF0aF9pc19ieXRlcyA9IFRydWUKCiAgICAgICAgYl9wYXRoID0gb3MucGF0aC5yZWFscGF0aCh0b19ieXRlcyhvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKHBhdGgpKSwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykpCiAgICAgICAgd2hpbGUgbm90IG9zLnBhdGguaXNtb3VudChiX3BhdGgpOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmRpcm5hbWUoYl9wYXRoKQoKICAgICAgICBpZiBwYXRoX2lzX2J5dGVzOgogICAgICAgICAgICByZXR1cm4gYl9wYXRoCgogICAgICAgIHJldHVybiB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKCiAgICBkZWYgaXNfc3BlY2lhbF9zZWxpbnV4X3BhdGgoc2VsZiwgcGF0aCk6CiAgICAgICAgIiIiCiAgICAgICAgUmV0dXJucyBhIHR1cGxlIGNvbnRhaW5pbmcgKFRydWUsIHNlbGludXhfY29udGV4dCkgaWYgdGhlIGdpdmVuIHBhdGggaXMgb24gYQogICAgICAgIE5GUyBvciBvdGhlciAnc3BlY2lhbCcgZnMgIG1vdW50IHBvaW50LCBvdGhlcndpc2UgdGhlIHJldHVybiB3aWxsIGJlIChGYWxzZSwgTm9uZSkuCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmID0gb3BlbignL3Byb2MvbW91bnRzJywgJ3InKQogICAgICAgICAgICBtb3VudF9kYXRhID0gZi5yZWFkbGluZXMoKQogICAgICAgICAgICBmLmNsb3NlKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiAoRmFsc2UsIE5vbmUpCiAgICAgICAgcGF0aF9tb3VudF9wb2ludCA9IHNlbGYuZmluZF9tb3VudF9wb2ludChwYXRoKQogICAgICAgIGZvciBsaW5lIGluIG1vdW50X2RhdGE6CiAgICAgICAgICAgIChkZXZpY2UsIG1vdW50X3BvaW50LCBmc3R5cGUsIG9wdGlvbnMsIHJlc3QpID0gbGluZS5zcGxpdCgnICcsIDQpCgogICAgICAgICAgICBpZiBwYXRoX21vdW50X3BvaW50ID09IG1vdW50X3BvaW50OgogICAgICAgICAgICAgICAgZm9yIGZzIGluIHNlbGYuX3NlbGludXhfc3BlY2lhbF9mczoKICAgICAgICAgICAgICAgICAgICBpZiBmcyBpbiBmc3R5cGU6CiAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpYWxfY29udGV4dCA9IHNlbGYuc2VsaW51eF9jb250ZXh0KHBhdGhfbW91bnRfcG9pbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoVHJ1ZSwgc3BlY2lhbF9jb250ZXh0KQoKICAgICAgICByZXR1cm4gKEZhbHNlLCBOb25lKQoKICAgIGRlZiBzZXRfZGVmYXVsdF9zZWxpbnV4X2NvbnRleHQoc2VsZiwgcGF0aCwgY2hhbmdlZCk6CiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2RlZmF1bHRfY29udGV4dChwYXRoKQogICAgICAgIHJldHVybiBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudChwYXRoLCBjb250ZXh0LCBGYWxzZSkKCiAgICBkZWYgc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIGNvbnRleHQsIGNoYW5nZWQsIGRpZmY9Tm9uZSk6CgogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVggb3Igbm90IHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCiAgICAgICAgY3VyX2NvbnRleHQgPSBzZWxmLnNlbGludXhfY29udGV4dChwYXRoKQogICAgICAgIG5ld19jb250ZXh0ID0gbGlzdChjdXJfY29udGV4dCkKICAgICAgICAjIEl0ZXJhdGUgb3ZlciB0aGUgY3VycmVudCBjb250ZXh0IGluc3RlYWQgb2YgdGhlCiAgICAgICAgIyBhcmd1bWVudCBjb250ZXh0LCB3aGljaCBtYXkgaGF2ZSBzZWxldmVsLgoKICAgICAgICAoaXNfc3BlY2lhbF9zZSwgc3BfY29udGV4dCkgPSBzZWxmLmlzX3NwZWNpYWxfc2VsaW51eF9wYXRoKHBhdGgpCiAgICAgICAgaWYgaXNfc3BlY2lhbF9zZToKICAgICAgICAgICAgbmV3X2NvbnRleHQgPSBzcF9jb250ZXh0CiAgICAgICAgZWxzZToKICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKGN1cl9jb250ZXh0KSk6CiAgICAgICAgICAgICAgICBpZiBsZW4oY29udGV4dCkgPiBpOgogICAgICAgICAgICAgICAgICAgIGlmIGNvbnRleHRbaV0gaXMgbm90IE5vbmUgYW5kIGNvbnRleHRbaV0gIT0gY3VyX2NvbnRleHRbaV06CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld19jb250ZXh0W2ldID0gY29udGV4dFtpXQogICAgICAgICAgICAgICAgICAgIGVsaWYgY29udGV4dFtpXSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICBuZXdfY29udGV4dFtpXSA9IGN1cl9jb250ZXh0W2ldCgogICAgICAgIGlmIGN1cl9jb250ZXh0ICE9IG5ld19jb250ZXh0OgogICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ3NlY29udGV4dCddID0gY3VyX2NvbnRleHQKICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydzZWNvbnRleHQnXSA9IG5ld19jb250ZXh0CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIHJjID0gc2VsaW51eC5sc2V0ZmlsZWNvbih0b19uYXRpdmUocGF0aCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyKCc6Jy5qb2luKG5ld19jb250ZXh0KSkpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2ludmFsaWQgc2VsaW51eCBjb250ZXh0OiAlcycgJSBzdHIoZSksIG5ld19jb250ZXh0PW5ld19jb250ZXh0LCBjdXJfY29udGV4dD1jdXJfY29udGV4dCwgaW5wdXRfd2FzPWNvbnRleHQpCiAgICAgICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nc2V0IHNlbGludXggY29udGV4dCBmYWlsZWQnKQogICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9vd25lcl9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgb3duZXIsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBwYXRoID0gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBvd25lciBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAogICAgICAgIG9yaWdfdWlkLCBvcmlnX2dpZCA9IHNlbGYudXNlcl9hbmRfZ3JvdXAocGF0aCwgZXhwYW5kKQogICAgICAgIHRyeToKICAgICAgICAgICAgdWlkID0gaW50KG93bmVyKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB1aWQgPSBwd2QuZ2V0cHduYW0ob3duZXIpLnB3X3VpZAogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hvd24gZmFpbGVkOiBmYWlsZWQgdG8gbG9vayB1cCB1c2VyICVzJyAlIG93bmVyKQogICAgICAgIGlmIG9yaWdfdWlkICE9IHVpZDoKCiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnb3duZXInXSA9IG9yaWdfdWlkCiAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnb3duZXInXSA9IHVpZAoKICAgICAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MubGNob3duKGJfcGF0aCwgdWlkLCAtMSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hvd24gZmFpbGVkJykKICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfZ3JvdXBfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIGdyb3VwLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgcGF0aCA9IHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZ3JvdXAgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKICAgICAgICBvcmlnX3VpZCwgb3JpZ19naWQgPSBzZWxmLnVzZXJfYW5kX2dyb3VwKGJfcGF0aCwgZXhwYW5kKQogICAgICAgIHRyeToKICAgICAgICAgICAgZ2lkID0gaW50KGdyb3VwKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBnaWQgPSBncnAuZ2V0Z3JuYW0oZ3JvdXApLmdyX2dpZAogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hncnAgZmFpbGVkOiBmYWlsZWQgdG8gbG9vayB1cCBncm91cCAlcycgJSBncm91cCkKICAgICAgICBpZiBvcmlnX2dpZCAhPSBnaWQ6CgogICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ2dyb3VwJ10gPSBvcmlnX2dpZAogICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ2dyb3VwJ10gPSBnaWQKCiAgICAgICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLmxjaG93bihiX3BhdGgsIC0xLCBnaWQpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2NoZ3JwIGZhaWxlZCcpCiAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X21vZGVfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIG1vZGUsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBwYXRoID0gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBwYXRoX3N0YXQgPSBvcy5sc3RhdChiX3BhdGgpCgogICAgICAgIGlmIG1vZGUgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UobW9kZSwgaW50KToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbW9kZSA9IGludChtb2RlLCA4KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG1vZGUgPSBzZWxmLl9zeW1ib2xpY19tb2RlX3RvX29jdGFsKHBhdGhfc3RhdCwgbW9kZSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2c9Im1vZGUgbXVzdCBiZSBpbiBvY3RhbCBvciBzeW1ib2xpYyBmb3JtIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWxzPXN0cihlKSkKCiAgICAgICAgICAgICAgICBpZiBtb2RlICE9IHN0YXQuU19JTU9ERShtb2RlKToKICAgICAgICAgICAgICAgICAgICAjIHByZXZlbnQgbW9kZSBmcm9tIGhhdmluZyBleHRyYSBpbmZvIG9yYmVpbmcgaW52YWxpZCBsb25nIG51bWJlcgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSJJbnZhbGlkIG1vZGUgc3VwcGxpZWQsIG9ubHkgcGVybWlzc2lvbiBpbmZvIGlzIGFsbG93ZWQiLCBkZXRhaWxzPW1vZGUpCgogICAgICAgIHByZXZfbW9kZSA9IHN0YXQuU19JTU9ERShwYXRoX3N0YXQuc3RfbW9kZSkKCiAgICAgICAgaWYgcHJldl9tb2RlICE9IG1vZGU6CgogICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ21vZGUnXSA9ICcwJTAzbycgJSBwcmV2X21vZGUKICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydtb2RlJ10gPSAnMCUwM28nICUgbW9kZQoKICAgICAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgIyBGSVhNRTogY29tcGFyaXNvbiBhZ2FpbnN0IHN0cmluZyBhYm92ZSB3aWxsIGNhdXNlIHRoaXMgdG8gYmUgZXhlY3V0ZWQKICAgICAgICAgICAgIyBldmVyeSB0aW1lCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIob3MsICdsY2htb2QnKToKICAgICAgICAgICAgICAgICAgICBvcy5sY2htb2QoYl9wYXRoLCBtb2RlKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2xpbmsoYl9wYXRoKToKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2htb2QoYl9wYXRoLCBtb2RlKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQXR0ZW1wdCB0byBzZXQgdGhlIHBlcm1zIG9mIHRoZSBzeW1saW5rIGJ1dCBiZQogICAgICAgICAgICAgICAgICAgICAgICAjIGNhcmVmdWwgbm90IHRvIGNoYW5nZSB0aGUgcGVybXMgb2YgdGhlIHVuZGVybHlpbmcKICAgICAgICAgICAgICAgICAgICAgICAgIyBmaWxlIHdoaWxlIHRyeWluZwogICAgICAgICAgICAgICAgICAgICAgICB1bmRlcmx5aW5nX3N0YXQgPSBvcy5zdGF0KGJfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2htb2QoYl9wYXRoLCBtb2RlKQogICAgICAgICAgICAgICAgICAgICAgICBuZXdfdW5kZXJseWluZ19zdGF0ID0gb3Muc3RhdChiX3BhdGgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVuZGVybHlpbmdfc3RhdC5zdF9tb2RlICE9IG5ld191bmRlcmx5aW5nX3N0YXQuc3RfbW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNobW9kKGJfcGF0aCwgc3RhdC5TX0lNT0RFKHVuZGVybHlpbmdfc3RhdC5zdF9tb2RlKSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmlzbGluayhiX3BhdGgpIGFuZCBlLmVycm5vID09IGVycm5vLkVQRVJNOiAgIyBDYW4ndCBzZXQgbW9kZSBvbiBzeW1ib2xpYyBsaW5rcwogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIGVsaWYgZS5lcnJubyBpbiAoZXJybm8uRU5PRU5ULCBlcnJuby5FTE9PUCk6ICMgQ2FuJ3Qgc2V0IG1vZGUgb24gYnJva2VuIHN5bWJvbGljIGxpbmtzCiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByYWlzZSBlCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2htb2QgZmFpbGVkJywgZGV0YWlscz1zdHIoZSkpCgogICAgICAgICAgICBwYXRoX3N0YXQgPSBvcy5sc3RhdChiX3BhdGgpCiAgICAgICAgICAgIG5ld19tb2RlID0gc3RhdC5TX0lNT0RFKHBhdGhfc3RhdC5zdF9tb2RlKQoKICAgICAgICAgICAgaWYgbmV3X21vZGUgIT0gcHJldl9tb2RlOgogICAgICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgYXR0cmlidXRlcywgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CgogICAgICAgIGlmIGF0dHJpYnV0ZXMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHBhdGggPSB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQoKICAgICAgICBleGlzdGluZyA9IHNlbGYuZ2V0X2ZpbGVfYXR0cmlidXRlcyhiX3BhdGgpCgogICAgICAgIGlmIGV4aXN0aW5nLmdldCgnYXR0cl9mbGFncycsJycpICE9IGF0dHJpYnV0ZXM6CiAgICAgICAgICAgIGF0dHJjbWQgPSBzZWxmLmdldF9iaW5fcGF0aCgnY2hhdHRyJykKICAgICAgICAgICAgaWYgYXR0cmNtZDoKICAgICAgICAgICAgICAgIGF0dHJjbWQgPSBbYXR0cmNtZCwgJz0lcycgJSBhdHRyaWJ1dGVzLCBiX3BhdGhdCiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQoKICAgICAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnYXR0cmlidXRlcyddID0gZXhpc3RpbmcuZ2V0KCdhdHRyX2ZsYWdzJykKICAgICAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydhdHRyaWJ1dGVzJ10gPSBhdHRyaWJ1dGVzCgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYucnVuX2NvbW1hbmQoYXR0cmNtZCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmMgIT0gMCBvciBlcnI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIkVycm9yIHdoaWxlIHNldHRpbmcgYXR0cmlidXRlczogJXMiICUgKG91dCArIGVycikpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaGF0dHIgZmFpbGVkJywgZGV0YWlscz1zdHIoZSkpCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgZ2V0X2ZpbGVfYXR0cmlidXRlcyhzZWxmLCBwYXRoKToKICAgICAgICBvdXRwdXQgPSB7fQogICAgICAgIGF0dHJjbWQgPSBzZWxmLmdldF9iaW5fcGF0aCgnbHNhdHRyJywgRmFsc2UpCiAgICAgICAgaWYgYXR0cmNtZDoKICAgICAgICAgICAgYXR0cmNtZCA9IFthdHRyY21kLCAnLXZkJywgcGF0aF0KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5ydW5fY29tbWFuZChhdHRyY21kKQogICAgICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgICAgICByZXMgPSBvdXQuc3BsaXQoJyAnKVswOjJdCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0WydhdHRyX2ZsYWdzJ10gPSAgcmVzWzFdLnJlcGxhY2UoJy0nLCcnKS5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0Wyd2ZXJzaW9uJ10gPSByZXNbMF0uc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIG91dHB1dFsnYXR0cmlidXRlcyddID0gZm9ybWF0X2F0dHJpYnV0ZXMob3V0cHV0WydhdHRyX2ZsYWdzJ10pCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gb3V0cHV0CgoKICAgIGRlZiBfc3ltYm9saWNfbW9kZV90b19vY3RhbChzZWxmLCBwYXRoX3N0YXQsIHN5bWJvbGljX21vZGUpOgogICAgICAgIG5ld19tb2RlID0gc3RhdC5TX0lNT0RFKHBhdGhfc3RhdC5zdF9tb2RlKQoKICAgICAgICBtb2RlX3JlID0gcmUuY29tcGlsZShyJ14oP1A8dXNlcnM+W3Vnb2FdKykoP1A8b3BlcmF0b3I+Wy0rPV0pKD9QPHBlcm1zPltyd3hYc3QtXSp8W3Vnb10pJCcpCiAgICAgICAgZm9yIG1vZGUgaW4gc3ltYm9saWNfbW9kZS5zcGxpdCgnLCcpOgogICAgICAgICAgICBtYXRjaCA9IG1vZGVfcmUubWF0Y2gobW9kZSkKICAgICAgICAgICAgaWYgbWF0Y2g6CiAgICAgICAgICAgICAgICB1c2VycyA9IG1hdGNoLmdyb3VwKCd1c2VycycpCiAgICAgICAgICAgICAgICBvcGVyYXRvciA9IG1hdGNoLmdyb3VwKCdvcGVyYXRvcicpCiAgICAgICAgICAgICAgICBwZXJtcyA9IG1hdGNoLmdyb3VwKCdwZXJtcycpCgogICAgICAgICAgICAgICAgaWYgdXNlcnMgPT0gJ2EnOgogICAgICAgICAgICAgICAgICAgIHVzZXJzID0gJ3VnbycKCiAgICAgICAgICAgICAgICBmb3IgdXNlciBpbiB1c2VyczoKICAgICAgICAgICAgICAgICAgICBtb2RlX3RvX2FwcGx5ID0gc2VsZi5fZ2V0X29jdGFsX21vZGVfZnJvbV9zeW1ib2xpY19wZXJtcyhwYXRoX3N0YXQsIHVzZXIsIHBlcm1zKQogICAgICAgICAgICAgICAgICAgIG5ld19tb2RlID0gc2VsZi5fYXBwbHlfb3BlcmF0aW9uX3RvX21vZGUodXNlciwgb3BlcmF0b3IsIG1vZGVfdG9fYXBwbHksIG5ld19tb2RlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiYmFkIHN5bWJvbGljIHBlcm1pc3Npb24gZm9yIG1vZGU6ICVzIiAlIG1vZGUpCiAgICAgICAgcmV0dXJuIG5ld19tb2RlCgogICAgZGVmIF9hcHBseV9vcGVyYXRpb25fdG9fbW9kZShzZWxmLCB1c2VyLCBvcGVyYXRvciwgbW9kZV90b19hcHBseSwgY3VycmVudF9tb2RlKToKICAgICAgICBpZiBvcGVyYXRvciAgPT0gICc9JzoKICAgICAgICAgICAgaWYgdXNlciA9PSAndSc6CiAgICAgICAgICAgICAgICBtYXNrID0gc3RhdC5TX0lSV1hVIHwgc3RhdC5TX0lTVUlECiAgICAgICAgICAgIGVsaWYgdXNlciA9PSAnZyc6CiAgICAgICAgICAgICAgICBtYXNrID0gc3RhdC5TX0lSV1hHIHwgc3RhdC5TX0lTR0lECiAgICAgICAgICAgIGVsaWYgdXNlciA9PSAnbyc6CiAgICAgICAgICAgICAgICBtYXNrID0gc3RhdC5TX0lSV1hPIHwgc3RhdC5TX0lTVlRYCgogICAgICAgICAgICAjIG1hc2sgb3V0IHUsIGcsIG9yIG8gcGVybWlzc2lvbnMgZnJvbSBjdXJyZW50X21vZGUgYW5kIGFwcGx5IG5ldyBwZXJtaXNzaW9ucwogICAgICAgICAgICBpbnZlcnNlX21hc2sgPSBtYXNrIF4gUEVSTV9CSVRTCiAgICAgICAgICAgIG5ld19tb2RlID0gKGN1cnJlbnRfbW9kZSAmIGludmVyc2VfbWFzaykgfCBtb2RlX3RvX2FwcGx5CiAgICAgICAgZWxpZiBvcGVyYXRvciA9PSAnKyc6CiAgICAgICAgICAgIG5ld19tb2RlID0gY3VycmVudF9tb2RlIHwgbW9kZV90b19hcHBseQogICAgICAgIGVsaWYgb3BlcmF0b3IgPT0gJy0nOgogICAgICAgICAgICBuZXdfbW9kZSA9IGN1cnJlbnRfbW9kZSAtIChjdXJyZW50X21vZGUgJiBtb2RlX3RvX2FwcGx5KQogICAgICAgIHJldHVybiBuZXdfbW9kZQoKICAgIGRlZiBfZ2V0X29jdGFsX21vZGVfZnJvbV9zeW1ib2xpY19wZXJtcyhzZWxmLCBwYXRoX3N0YXQsIHVzZXIsIHBlcm1zKToKICAgICAgICBwcmV2X21vZGUgPSBzdGF0LlNfSU1PREUocGF0aF9zdGF0LnN0X21vZGUpCgogICAgICAgIGlzX2RpcmVjdG9yeSA9IHN0YXQuU19JU0RJUihwYXRoX3N0YXQuc3RfbW9kZSkKICAgICAgICBoYXNfeF9wZXJtaXNzaW9ucyA9IChwcmV2X21vZGUgJiBFWEVDX1BFUk1fQklUUykgPiAwCiAgICAgICAgYXBwbHlfWF9wZXJtaXNzaW9uID0gaXNfZGlyZWN0b3J5IG9yIGhhc194X3Blcm1pc3Npb25zCgogICAgICAgICMgUGVybWlzc2lvbiBiaXRzIGNvbnN0YW50cyBkb2N1bWVudGVkIGF0OgogICAgICAgICMgaHR0cDovL2RvY3MucHl0aG9uLm9yZy8yL2xpYnJhcnkvc3RhdC5odG1sI3N0YXQuU19JU1VJRAogICAgICAgIGlmIGFwcGx5X1hfcGVybWlzc2lvbjoKICAgICAgICAgICAgWF9wZXJtcyA9IHsKICAgICAgICAgICAgICAgICd1JzogeydYJzogc3RhdC5TX0lYVVNSfSwKICAgICAgICAgICAgICAgICdnJzogeydYJzogc3RhdC5TX0lYR1JQfSwKICAgICAgICAgICAgICAgICdvJzogeydYJzogc3RhdC5TX0lYT1RIfQogICAgICAgICAgICB9CiAgICAgICAgZWxzZToKICAgICAgICAgICAgWF9wZXJtcyA9IHsKICAgICAgICAgICAgICAgICd1JzogeydYJzogMH0sCiAgICAgICAgICAgICAgICAnZyc6IHsnWCc6IDB9LAogICAgICAgICAgICAgICAgJ28nOiB7J1gnOiAwfQogICAgICAgICAgICB9CgogICAgICAgIHVzZXJfcGVybXNfdG9fbW9kZXMgPSB7CiAgICAgICAgICAgICd1JzogewogICAgICAgICAgICAgICAgJ3InOiBzdGF0LlNfSVJVU1IsCiAgICAgICAgICAgICAgICAndyc6IHN0YXQuU19JV1VTUiwKICAgICAgICAgICAgICAgICd4Jzogc3RhdC5TX0lYVVNSLAogICAgICAgICAgICAgICAgJ3MnOiBzdGF0LlNfSVNVSUQsCiAgICAgICAgICAgICAgICAndCc6IDAsCiAgICAgICAgICAgICAgICAndSc6IHByZXZfbW9kZSAmIHN0YXQuU19JUldYVSwKICAgICAgICAgICAgICAgICdnJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYRykgPDwgMywKICAgICAgICAgICAgICAgICdvJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYTykgPDwgNiB9LAogICAgICAgICAgICAnZyc6IHsKICAgICAgICAgICAgICAgICdyJzogc3RhdC5TX0lSR1JQLAogICAgICAgICAgICAgICAgJ3cnOiBzdGF0LlNfSVdHUlAsCiAgICAgICAgICAgICAgICAneCc6IHN0YXQuU19JWEdSUCwKICAgICAgICAgICAgICAgICdzJzogc3RhdC5TX0lTR0lELAogICAgICAgICAgICAgICAgJ3QnOiAwLAogICAgICAgICAgICAgICAgJ3UnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hVKSA+PiAzLAogICAgICAgICAgICAgICAgJ2cnOiBwcmV2X21vZGUgJiBzdGF0LlNfSVJXWEcsCiAgICAgICAgICAgICAgICAnbyc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWE8pIDw8IDMgfSwKICAgICAgICAgICAgJ28nOiB7CiAgICAgICAgICAgICAgICAncic6IHN0YXQuU19JUk9USCwKICAgICAgICAgICAgICAgICd3Jzogc3RhdC5TX0lXT1RILAogICAgICAgICAgICAgICAgJ3gnOiBzdGF0LlNfSVhPVEgsCiAgICAgICAgICAgICAgICAncyc6IDAsCiAgICAgICAgICAgICAgICAndCc6IHN0YXQuU19JU1ZUWCwKICAgICAgICAgICAgICAgICd1JzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYVSkgPj4gNiwKICAgICAgICAgICAgICAgICdnJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYRykgPj4gMywKICAgICAgICAgICAgICAgICdvJzogcHJldl9tb2RlICYgc3RhdC5TX0lSV1hPIH0KICAgICAgICB9CgogICAgICAgICMgSW5zZXJ0IFhfcGVybXMgaW50byB1c2VyX3Blcm1zX3RvX21vZGVzCiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gWF9wZXJtcy5pdGVtcygpOgogICAgICAgICAgICB1c2VyX3Blcm1zX3RvX21vZGVzW2tleV0udXBkYXRlKHZhbHVlKQoKICAgICAgICBvcl9yZWR1Y2UgPSBsYW1iZGEgbW9kZSwgcGVybTogbW9kZSB8IHVzZXJfcGVybXNfdG9fbW9kZXNbdXNlcl1bcGVybV0KICAgICAgICByZXR1cm4gcmVkdWNlKG9yX3JlZHVjZSwgcGVybXMsIDApCgogICAgZGVmIHNldF9mc19hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChzZWxmLCBmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgICMgc2V0IG1vZGVzIG93bmVycyBhbmQgY29udGV4dCBhcyBuZWVkZWQKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ3NlY29udGV4dCddLCBjaGFuZ2VkLCBkaWZmCiAgICAgICAgKQogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9vd25lcl9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ293bmVyJ10sIGNoYW5nZWQsIGRpZmYsIGV4cGFuZAogICAgICAgICkKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfZ3JvdXBfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydncm91cCddLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQKICAgICAgICApCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X21vZGVfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydtb2RlJ10sIGNoYW5nZWQsIGRpZmYsIGV4cGFuZAogICAgICAgICkKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ2F0dHJpYnV0ZXMnXSwgY2hhbmdlZCwgZGlmZiwgZXhwYW5kCiAgICAgICAgKQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9kaXJlY3RvcnlfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoc2VsZiwgZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICByZXR1cm4gc2VsZi5zZXRfZnNfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQpCgogICAgZGVmIHNldF9maWxlX2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KHNlbGYsIGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgcmV0dXJuIHNlbGYuc2V0X2ZzX2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZiwgZXhwYW5kKQoKICAgIGRlZiBhZGRfcGF0aF9pbmZvKHNlbGYsIGt3YXJncyk6CiAgICAgICAgJycnCiAgICAgICAgZm9yIHJlc3VsdHMgdGhhdCBhcmUgZmlsZXMsIHN1cHBsZW1lbnQgdGhlIGluZm8gYWJvdXQgdGhlIGZpbGUKICAgICAgICBpbiB0aGUgcmV0dXJuIHBhdGggd2l0aCBzdGF0cyBhYm91dCB0aGUgZmlsZSBwYXRoLgogICAgICAgICcnJwoKICAgICAgICBwYXRoID0ga3dhcmdzLmdldCgncGF0aCcsIGt3YXJncy5nZXQoJ2Rlc3QnLCBOb25lKSkKICAgICAgICBpZiBwYXRoIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBrd2FyZ3MKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGJfcGF0aCk6CiAgICAgICAgICAgICh1aWQsIGdpZCkgPSBzZWxmLnVzZXJfYW5kX2dyb3VwKHBhdGgpCiAgICAgICAgICAgIGt3YXJnc1sndWlkJ10gPSB1aWQKICAgICAgICAgICAga3dhcmdzWydnaWQnXSA9IGdpZAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB1c2VyID0gcHdkLmdldHB3dWlkKHVpZClbMF0KICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgdXNlciA9IHN0cih1aWQpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGdyb3VwID0gZ3JwLmdldGdyZ2lkKGdpZClbMF0KICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgZ3JvdXAgPSBzdHIoZ2lkKQogICAgICAgICAgICBrd2FyZ3NbJ293bmVyJ10gPSB1c2VyCiAgICAgICAgICAgIGt3YXJnc1snZ3JvdXAnXSA9IGdyb3VwCiAgICAgICAgICAgIHN0ID0gb3MubHN0YXQoYl9wYXRoKQogICAgICAgICAgICBrd2FyZ3NbJ21vZGUnXSA9ICcwJTAzbycgJSBzdGF0LlNfSU1PREUoc3Rbc3RhdC5TVF9NT0RFXSkKICAgICAgICAgICAgIyBzZWNvbnRleHQgbm90IHlldCBzdXBwb3J0ZWQKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2xpbmsoYl9wYXRoKToKICAgICAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdsaW5rJwogICAgICAgICAgICBlbGlmIG9zLnBhdGguaXNkaXIoYl9wYXRoKToKICAgICAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdkaXJlY3RvcnknCiAgICAgICAgICAgIGVsaWYgb3Muc3RhdChiX3BhdGgpLnN0X25saW5rID4gMToKICAgICAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdoYXJkJwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2ZpbGUnCiAgICAgICAgICAgIGlmIEhBVkVfU0VMSU5VWCBhbmQgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgICAgIGt3YXJnc1snc2Vjb250ZXh0J10gPSAnOicuam9pbihzZWxmLnNlbGludXhfY29udGV4dChwYXRoKSkKICAgICAgICAgICAga3dhcmdzWydzaXplJ10gPSBzdFtzdGF0LlNUX1NJWkVdCiAgICAgICAgZWxzZToKICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2Fic2VudCcKICAgICAgICByZXR1cm4ga3dhcmdzCgogICAgZGVmIF9jaGVja19sb2NhbGUoc2VsZik6CiAgICAgICAgJycnCiAgICAgICAgVXNlcyB0aGUgbG9jYWxlIG1vZHVsZSB0byB0ZXN0IHRoZSBjdXJyZW50bHkgc2V0IGxvY2FsZQogICAgICAgIChwZXIgdGhlIExBTkcgYW5kIExDX0NUWVBFIGVudmlyb25tZW50IHNldHRpbmdzKQogICAgICAgICcnJwogICAgICAgIHRyeToKICAgICAgICAgICAgIyBzZXR0aW5nIHRoZSBsb2NhbGUgdG8gJycgdXNlcyB0aGUgZGVmYXVsdCBsb2NhbGUKICAgICAgICAgICAgIyBhcyBpdCB3b3VsZCBiZSByZXR1cm5lZCBieSBsb2NhbGUuZ2V0ZGVmYXVsdGxvY2FsZSgpCiAgICAgICAgICAgIGxvY2FsZS5zZXRsb2NhbGUobG9jYWxlLkxDX0FMTCwgJycpCiAgICAgICAgZXhjZXB0IGxvY2FsZS5FcnJvcjoKICAgICAgICAgICAgIyBmYWxsYmFjayB0byB0aGUgJ0MnIGxvY2FsZSwgd2hpY2ggbWF5IGNhdXNlIHVuaWNvZGUKICAgICAgICAgICAgIyBpc3N1ZXMgYnV0IGlzIHByZWZlcmFibGUgdG8gc2ltcGx5IGZhaWxpbmcgYmVjYXVzZQogICAgICAgICAgICAjIG9mIGFuIHVua25vd24gbG9jYWxlCiAgICAgICAgICAgIGxvY2FsZS5zZXRsb2NhbGUobG9jYWxlLkxDX0FMTCwgJ0MnKQogICAgICAgICAgICBvcy5lbnZpcm9uWydMQU5HJ10gPSAnQycKICAgICAgICAgICAgb3MuZW52aXJvblsnTENfQUxMJ10gPSAnQycKICAgICAgICAgICAgb3MuZW52aXJvblsnTENfTUVTU0FHRVMnXSA9ICdDJwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJBbiB1bmtub3duIGVycm9yIHdhcyBlbmNvdW50ZXJlZCB3aGlsZSBhdHRlbXB0aW5nIHRvIHZhbGlkYXRlIHRoZSBsb2NhbGU6ICVzIiAlIGUpCgogICAgZGVmIF9oYW5kbGVfYWxpYXNlcyhzZWxmLCBzcGVjPU5vbmUpOgogICAgICAgICMgdGhpcyB1c2VzIGV4Y2VwdGlvbnMgYXMgaXQgaGFwcGVucyBiZWZvcmUgd2UgY2FuIHNhZmVseSBjYWxsIGZhaWxfanNvbgogICAgICAgIGFsaWFzZXNfcmVzdWx0cyA9IHt9ICNhbGlhczpjYW5vbgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgc3BlYyA9IHNlbGYuYXJndW1lbnRfc3BlYwogICAgICAgIGZvciAoayx2KSBpbiBzcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIHNlbGYuX2xlZ2FsX2lucHV0cy5hcHBlbmQoaykKICAgICAgICAgICAgYWxpYXNlcyA9IHYuZ2V0KCdhbGlhc2VzJywgTm9uZSkKICAgICAgICAgICAgZGVmYXVsdCA9IHYuZ2V0KCdkZWZhdWx0JywgTm9uZSkKICAgICAgICAgICAgcmVxdWlyZWQgPSB2LmdldCgncmVxdWlyZWQnLCBGYWxzZSkKICAgICAgICAgICAgaWYgZGVmYXVsdCBpcyBub3QgTm9uZSBhbmQgcmVxdWlyZWQ6CiAgICAgICAgICAgICAgICAjIG5vdCBhbGlhcyBzcGVjaWZpYyBidXQgdGhpcyBpcyBhIGdvb2QgcGxhY2UgdG8gY2hlY2sgdGhpcwogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJpbnRlcm5hbCBlcnJvcjogcmVxdWlyZWQgYW5kIGRlZmF1bHQgYXJlIG11dHVhbGx5IGV4Y2x1c2l2ZSBmb3IgJXMiICUgaykKICAgICAgICAgICAgaWYgYWxpYXNlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoYWxpYXNlcywgU0VRVUVOQ0VUWVBFKSBvciBpc2luc3RhbmNlKGFsaWFzZXMsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oJ2ludGVybmFsIGVycm9yOiBhbGlhc2VzIG11c3QgYmUgYSBsaXN0IG9yIHR1cGxlJykKICAgICAgICAgICAgZm9yIGFsaWFzIGluIGFsaWFzZXM6CiAgICAgICAgICAgICAgICBzZWxmLl9sZWdhbF9pbnB1dHMuYXBwZW5kKGFsaWFzKQogICAgICAgICAgICAgICAgYWxpYXNlc19yZXN1bHRzW2FsaWFzXSA9IGsKICAgICAgICAgICAgICAgIGlmIGFsaWFzIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyYW1zW2tdID0gc2VsZi5wYXJhbXNbYWxpYXNdCgogICAgICAgIHJldHVybiBhbGlhc2VzX3Jlc3VsdHMKCiAgICBkZWYgX2NoZWNrX2FyZ3VtZW50cyhzZWxmLCBjaGVja19pbnZhbGlkX2FyZ3VtZW50cyk6CiAgICAgICAgc2VsZi5fc3lzbG9nX2ZhY2lsaXR5ID0gJ0xPR19VU0VSJwogICAgICAgIHVuc3VwcG9ydGVkX3BhcmFtZXRlcnMgPSBzZXQoKQogICAgICAgIGZvciAoayx2KSBpbiBsaXN0KHNlbGYucGFyYW1zLml0ZW1zKCkpOgoKICAgICAgICAgICAgaWYgayA9PSAnX2Fuc2libGVfY2hlY2tfbW9kZScgYW5kIHY6CiAgICAgICAgICAgICAgICBzZWxmLmNoZWNrX21vZGUgPSBUcnVlCgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX25vX2xvZyc6CiAgICAgICAgICAgICAgICBzZWxmLm5vX2xvZyA9IHNlbGYuYm9vbGVhbih2KQoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9kZWJ1Zyc6CiAgICAgICAgICAgICAgICBzZWxmLl9kZWJ1ZyA9IHNlbGYuYm9vbGVhbih2KQoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9kaWZmJzoKICAgICAgICAgICAgICAgIHNlbGYuX2RpZmYgPSBzZWxmLmJvb2xlYW4odikKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfdmVyYm9zaXR5JzoKICAgICAgICAgICAgICAgIHNlbGYuX3ZlcmJvc2l0eSA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfc2VsaW51eF9zcGVjaWFsX2ZzJzoKICAgICAgICAgICAgICAgIHNlbGYuX3NlbGludXhfc3BlY2lhbF9mcyA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfc3lzbG9nX2ZhY2lsaXR5JzoKICAgICAgICAgICAgICAgIHNlbGYuX3N5c2xvZ19mYWNpbGl0eSA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfdmVyc2lvbic6CiAgICAgICAgICAgICAgICBzZWxmLmFuc2libGVfdmVyc2lvbiA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfbW9kdWxlX25hbWUnOgogICAgICAgICAgICAgICAgc2VsZi5fbmFtZSA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfc29ja2V0JzoKICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldF9wYXRoID0gdgoKICAgICAgICAgICAgZWxpZiBjaGVja19pbnZhbGlkX2FyZ3VtZW50cyBhbmQgayBub3QgaW4gc2VsZi5fbGVnYWxfaW5wdXRzOgogICAgICAgICAgICAgICAgdW5zdXBwb3J0ZWRfcGFyYW1ldGVycy5hZGQoaykKCiAgICAgICAgICAgICNjbGVhbiB1cCBpbnRlcm5hbCBwYXJhbXM6CiAgICAgICAgICAgIGlmIGsuc3RhcnRzd2l0aCgnX2Fuc2libGVfJyk6CiAgICAgICAgICAgICAgICBkZWwgc2VsZi5wYXJhbXNba10KCiAgICAgICAgaWYgdW5zdXBwb3J0ZWRfcGFyYW1ldGVyczoKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJVbnN1cHBvcnRlZCBwYXJhbWV0ZXJzIGZvciAoJXMpIG1vZHVsZTogJXMuIFN1cHBvcnRlZCBwYXJhbWV0ZXJzIGluY2x1ZGU6ICVzIiAlIChzZWxmLl9uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcsJy5qb2luKHNvcnRlZChsaXN0KHVuc3VwcG9ydGVkX3BhcmFtZXRlcnMpKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJywnLmpvaW4oc29ydGVkKHNlbGYuYXJndW1lbnRfc3BlYy5rZXlzKCkpKSkpCiAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlIGFuZCBub3Qgc2VsZi5zdXBwb3J0c19jaGVja19tb2RlOgogICAgICAgICAgICBzZWxmLmV4aXRfanNvbihza2lwcGVkPVRydWUsIG1zZz0icmVtb3RlIG1vZHVsZSAoJXMpIGRvZXMgbm90IHN1cHBvcnQgY2hlY2sgbW9kZSIgJSBzZWxmLl9uYW1lKQoKICAgIGRlZiBfY291bnRfdGVybXMoc2VsZiwgY2hlY2spOgogICAgICAgIGNvdW50ID0gMAogICAgICAgIGZvciB0ZXJtIGluIGNoZWNrOgogICAgICAgICAgICBpZiB0ZXJtIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgY291bnQgKz0gMQogICAgICAgIHJldHVybiBjb3VudAoKICAgIGRlZiBfY2hlY2tfbXV0dWFsbHlfZXhjbHVzaXZlKHNlbGYsIHNwZWMpOgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZm9yIGNoZWNrIGluIHNwZWM6CiAgICAgICAgICAgIGNvdW50ID0gc2VsZi5fY291bnRfdGVybXMoY2hlY2spCiAgICAgICAgICAgIGlmIGNvdW50ID4gMToKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0icGFyYW1ldGVycyBhcmUgbXV0dWFsbHkgZXhjbHVzaXZlOiAlcyIgJSAoY2hlY2ssKSkKCiAgICBkZWYgX2NoZWNrX3JlcXVpcmVkX29uZV9vZihzZWxmLCBzcGVjKToKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciBjaGVjayBpbiBzcGVjOgogICAgICAgICAgICBjb3VudCA9IHNlbGYuX2NvdW50X3Rlcm1zKGNoZWNrKQogICAgICAgICAgICBpZiBjb3VudCA9PSAwOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJvbmUgb2YgdGhlIGZvbGxvd2luZyBpcyByZXF1aXJlZDogJXMiICUgJywnLmpvaW4oY2hlY2spKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfdG9nZXRoZXIoc2VsZiwgc3BlYyk6CiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3IgY2hlY2sgaW4gc3BlYzoKICAgICAgICAgICAgY291bnRzID0gWyBzZWxmLl9jb3VudF90ZXJtcyhbZmllbGRdKSBmb3IgZmllbGQgaW4gY2hlY2sgXQogICAgICAgICAgICBub25femVybyA9IFsgYyBmb3IgYyBpbiBjb3VudHMgaWYgYyA+IDAgXQogICAgICAgICAgICBpZiBsZW4obm9uX3plcm8pID4gMDoKICAgICAgICAgICAgICAgIGlmIDAgaW4gY291bnRzOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0icGFyYW1ldGVycyBhcmUgcmVxdWlyZWQgdG9nZXRoZXI6ICVzIiAlIChjaGVjaywpKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfYXJndW1lbnRzKHNlbGYsIHNwZWM9Tm9uZSwgcGFyYW09Tm9uZSApOgogICAgICAgICcnJyBlbnN1cmUgYWxsIHJlcXVpcmVkIGFyZ3VtZW50cyBhcmUgcHJlc2VudCAnJycKICAgICAgICBtaXNzaW5nID0gW10KICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHNwZWMgPSBzZWxmLmFyZ3VtZW50X3NwZWMKICAgICAgICBpZiBwYXJhbSBpcyBOb25lOgogICAgICAgICAgICBwYXJhbSA9IHNlbGYucGFyYW1zCiAgICAgICAgZm9yIChrLHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgcmVxdWlyZWQgPSB2LmdldCgncmVxdWlyZWQnLCBGYWxzZSkKICAgICAgICAgICAgaWYgcmVxdWlyZWQgYW5kIGsgbm90IGluIHBhcmFtOgogICAgICAgICAgICAgICAgbWlzc2luZy5hcHBlbmQoaykKICAgICAgICBpZiBsZW4obWlzc2luZykgPiAwOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9Im1pc3NpbmcgcmVxdWlyZWQgYXJndW1lbnRzOiAlcyIgJSAiLCIuam9pbihtaXNzaW5nKSkKCiAgICBkZWYgX2NoZWNrX3JlcXVpcmVkX2lmKHNlbGYsIHNwZWMpOgogICAgICAgICcnJyBlbnN1cmUgdGhhdCBwYXJhbWV0ZXJzIHdoaWNoIGNvbmRpdGlvbmFsbHkgcmVxdWlyZWQgYXJlIHByZXNlbnQgJycnCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3Igc3AgaW4gc3BlYzoKICAgICAgICAgICAgbWlzc2luZyA9IFtdCiAgICAgICAgICAgIG1heF9taXNzaW5nX2NvdW50ID0gMAogICAgICAgICAgICBpc19vbmVfb2YgPSBGYWxzZQogICAgICAgICAgICBpZiBsZW4oc3ApID09IDQ6CiAgICAgICAgICAgICAgICBrZXksIHZhbCwgcmVxdWlyZW1lbnRzLCBpc19vbmVfb2YgPSBzcAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAga2V5LCB2YWwsIHJlcXVpcmVtZW50cyA9IHNwCgogICAgICAgICAgICAjIGlzX29uZV9vZiBpcyBUcnVlIGF0IGxlYXN0IG9uZSByZXF1aXJlbWVudCBzaG91bGQgYmUKICAgICAgICAgICAgIyBwcmVzZW50LCBlbHNlIGFsbCByZXF1aXJlbWVudHMgc2hvdWxkIGJlIHByZXNlbnQuCiAgICAgICAgICAgIGlmIGlzX29uZV9vZjoKICAgICAgICAgICAgICAgIG1heF9taXNzaW5nX2NvdW50ID0gbGVuKHJlcXVpcmVtZW50cykKCiAgICAgICAgICAgIGlmIGtleSBpbiBzZWxmLnBhcmFtcyBhbmQgc2VsZi5wYXJhbXNba2V5XSA9PSB2YWw6CiAgICAgICAgICAgICAgICBmb3IgY2hlY2sgaW4gcmVxdWlyZW1lbnRzOgogICAgICAgICAgICAgICAgICAgIGNvdW50ID0gc2VsZi5fY291bnRfdGVybXMoKGNoZWNrLCkpCiAgICAgICAgICAgICAgICAgICAgaWYgY291bnQgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgbWlzc2luZy5hcHBlbmQoY2hlY2spCiAgICAgICAgICAgIGlmIGxlbihtaXNzaW5nKSBhbmQgbGVuKG1pc3NpbmcpID49IG1heF9taXNzaW5nX2NvdW50OgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSIlcyBpcyAlcyBidXQgdGhlIGZvbGxvd2luZyBhcmUgbWlzc2luZzogJXMiICUgKGtleSwgdmFsLCAnLCcuam9pbihtaXNzaW5nKSkpCgogICAgZGVmIF9jaGVja19hcmd1bWVudF92YWx1ZXMoc2VsZiwgc3BlYz1Ob25lLCBwYXJhbT1Ob25lKToKICAgICAgICAnJycgZW5zdXJlIGFsbCBhcmd1bWVudHMgaGF2ZSB0aGUgcmVxdWVzdGVkIHZhbHVlcywgYW5kIHRoZXJlIGFyZSBubyBzdHJheSBhcmd1bWVudHMgJycnCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICBzcGVjID0gc2VsZi5hcmd1bWVudF9zcGVjCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToKICAgICAgICAgICAgcGFyYW0gPSBzZWxmLnBhcmFtcwogICAgICAgIGZvciAoayx2KSBpbiBzcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIGNob2ljZXMgPSB2LmdldCgnY2hvaWNlcycsTm9uZSkKICAgICAgICAgICAgaWYgY2hvaWNlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShjaG9pY2VzLCBTRVFVRU5DRVRZUEUpIGFuZCBub3QgaXNpbnN0YW5jZShjaG9pY2VzLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpOgogICAgICAgICAgICAgICAgaWYgayBpbiBwYXJhbToKICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSBub3QgaW4gY2hvaWNlczoKICAgICAgICAgICAgICAgICAgICAgICAgIyBQeVlhbWwgY29udmVydHMgY2VydGFpbiBzdHJpbmdzIHRvIGJvb2xzLiAgSWYgd2UgY2FuIHVuYW1iaWd1b3VzbHkgY29udmVydCBiYWNrLCBkbyBzbyBiZWZvcmUgY2hlY2tpbmcKICAgICAgICAgICAgICAgICAgICAgICAgIyB0aGUgdmFsdWUuICBJZiB3ZSBjYW4ndCBmaWd1cmUgdGhpcyBvdXQsIG1vZHVsZSBhdXRob3IgaXMgcmVzcG9uc2libGUuCiAgICAgICAgICAgICAgICAgICAgICAgIGxvd2VyZWRfY2hvaWNlcyA9IE5vbmUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gPT0gJ0ZhbHNlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvd2VyZWRfY2hvaWNlcyA9IF9sZW5pZW50X2xvd2VyY2FzZShjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgRkFMU0VZID0gZnJvemVuc2V0KEJPT0xFQU5TX0ZBTFNFKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmxhcCA9IEZBTFNFWS5pbnRlcnNlY3Rpb24oY2hvaWNlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihvdmVybGFwKSA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgRXh0cmFjdCBmcm9tIGEgc2V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHBhcmFtW2tdLCkgPSBvdmVybGFwCgogICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSA9PSAnVHJ1ZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsb3dlcmVkX2Nob2ljZXMgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb3dlcmVkX2Nob2ljZXMgPSBfbGVuaWVudF9sb3dlcmNhc2UoY2hvaWNlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRSVVRIWSA9IGZyb3plbnNldChCT09MRUFOU19UUlVFKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmxhcCA9IFRSVVRIWS5pbnRlcnNlY3Rpb24oY2hvaWNlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihvdmVybGFwKSA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChwYXJhbVtrXSwpID0gb3ZlcmxhcAoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gbm90IGluIGNob2ljZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2VzX3N0cj0iLCIuam9pbihbdG9fbmF0aXZlKGMpIGZvciBjIGluIGNob2ljZXNdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnPSJ2YWx1ZSBvZiAlcyBtdXN0IGJlIG9uZSBvZjogJXMsIGdvdDogJXMiICUgKGssIGNob2ljZXNfc3RyLCBwYXJhbVtrXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz1tc2cpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImludGVybmFsIGVycm9yOiBjaG9pY2VzIGZvciBhcmd1bWVudCAlcyBhcmUgbm90IGl0ZXJhYmxlOiAlcyIgJSAoaywgY2hvaWNlcykpCgogICAgZGVmIHNhZmVfZXZhbChzZWxmLCB2YWx1ZSwgbG9jYWxzPU5vbmUsIGluY2x1ZGVfZXhjZXB0aW9ucz1GYWxzZSk6CgogICAgICAgICMgZG8gbm90IGFsbG93IG1ldGhvZCBjYWxscyB0byBtb2R1bGVzCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgICMgYWxyZWFkeSB0ZW1wbGF0ZWQgdG8gYSBkYXRhdmFsdWVzdHJ1Y3R1cmUsIHBlcmhhcHM/CiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAodmFsdWUsIE5vbmUpCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIGlmIHJlLnNlYXJjaChyJ1x3XC5cdytcKCcsIHZhbHVlKToKICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgTm9uZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgIyBkbyBub3QgYWxsb3cgaW1wb3J0cwogICAgICAgIGlmIHJlLnNlYXJjaChyJ2ltcG9ydCBcdysnLCB2YWx1ZSk6CiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAodmFsdWUsIE5vbmUpCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzdWx0ID0gbGl0ZXJhbF9ldmFsKHZhbHVlKQogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHJlc3VsdCwgTm9uZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAodmFsdWUsIGUpCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgIGRlZiBfY2hlY2tfdHlwZV9zdHIoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgICMgTm90ZTogVGhpcyBjb3VsZCB0aHJvdyBhIHVuaWNvZGUgZXJyb3IgaWYgdmFsdWUncyBfX3N0cl9fKCkgbWV0aG9kCiAgICAgICAgIyByZXR1cm5zIG5vbi1hc2NpaS4gIEhhdmUgdG8gcG9ydCB1dGlscy50b19ieXRlcygpIGlmIHRoYXQgaGFwcGVucwogICAgICAgIHJldHVybiBzdHIodmFsdWUpCgogICAgZGVmIF9jaGVja190eXBlX2xpc3Qoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGxpc3QpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnNwbGl0KCIsIikKICAgICAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIGludCkgb3IgaXNpbnN0YW5jZSh2YWx1ZSwgZmxvYXQpOgogICAgICAgICAgICByZXR1cm4gWyBzdHIodmFsdWUpIF0KCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgbGlzdCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfZGljdChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgZGljdCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBpZiB2YWx1ZS5zdGFydHN3aXRoKCJ7Iik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHModmFsdWUpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgKHJlc3VsdCwgZXhjKSA9IHNlbGYuc2FmZV9ldmFsKHZhbHVlLCBkaWN0KCksIGluY2x1ZGVfZXhjZXB0aW9ucz1UcnVlKQogICAgICAgICAgICAgICAgICAgIGlmIGV4YyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCd1bmFibGUgdG8gZXZhbHVhdGUgc3RyaW5nIGFzIGRpY3Rpb25hcnknKQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICAgICAgZWxpZiAnPScgaW4gdmFsdWU6CiAgICAgICAgICAgICAgICBmaWVsZHMgPSBbXQogICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyID0gW10KICAgICAgICAgICAgICAgIGluX3F1b3RlID0gRmFsc2UKICAgICAgICAgICAgICAgIGluX2VzY2FwZSA9IEZhbHNlCiAgICAgICAgICAgICAgICBmb3IgYyBpbiB2YWx1ZS5zdHJpcCgpOgogICAgICAgICAgICAgICAgICAgIGlmIGluX2VzY2FwZToKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyLmFwcGVuZChjKQogICAgICAgICAgICAgICAgICAgICAgICBpbl9lc2NhcGUgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsaWYgYyA9PSAnXFwnOgogICAgICAgICAgICAgICAgICAgICAgICBpbl9lc2NhcGUgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgZWxpZiBub3QgaW5fcXVvdGUgYW5kIGMgaW4gKCdcJycsICciJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGluX3F1b3RlID0gYwogICAgICAgICAgICAgICAgICAgIGVsaWYgaW5fcXVvdGUgYW5kIGluX3F1b3RlID09IGM6CiAgICAgICAgICAgICAgICAgICAgICAgIGluX3F1b3RlID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBpbl9xdW90ZSBhbmQgYyBpbiAoJywnLCAnICcpOgogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZCA9ICcnLmpvaW4oZmllbGRfYnVmZmVyKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBmaWVsZDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkcy5hcHBlbmQoZmllbGQpCiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkX2J1ZmZlciA9IFtdCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyLmFwcGVuZChjKQoKICAgICAgICAgICAgICAgIGZpZWxkID0gJycuam9pbihmaWVsZF9idWZmZXIpCiAgICAgICAgICAgICAgICBpZiBmaWVsZDoKICAgICAgICAgICAgICAgICAgICBmaWVsZHMuYXBwZW5kKGZpZWxkKQogICAgICAgICAgICAgICAgcmV0dXJuIGRpY3QoeC5zcGxpdCgiPSIsIDEpIGZvciB4IGluIGZpZWxkcykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiZGljdGlvbmFyeSByZXF1ZXN0ZWQsIGNvdWxkIG5vdCBwYXJzZSBKU09OIG9yIGtleT12YWx1ZSIpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGRpY3QnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2Jvb2woc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGJvb2wpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKSBvciBpc2luc3RhbmNlKHZhbHVlLCBpbnQpOgogICAgICAgICAgICByZXR1cm4gc2VsZi5ib29sZWFuKHZhbHVlKQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBib29sJyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9pbnQoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGludCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICByZXR1cm4gaW50KHZhbHVlKQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYW4gaW50JyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9mbG9hdChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgZmxvYXQpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUsIGludCkpOgogICAgICAgICAgICByZXR1cm4gZmxvYXQodmFsdWUpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGZsb2F0JyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9wYXRoKHNlbGYsIHZhbHVlKToKICAgICAgICB2YWx1ZSA9IHNlbGYuX2NoZWNrX3R5cGVfc3RyKHZhbHVlKQogICAgICAgIHJldHVybiBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfanNvbmFyZyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgIyBSZXR1cm4gYSBqc29uaWZpZWQgc3RyaW5nLiAgU29tZXRpbWVzIHRoZSBjb250cm9sbGVyIHR1cm5zIGEganNvbgogICAgICAgICMgc3RyaW5nIGludG8gYSBkaWN0L2xpc3Qgc28gdHJhbnNmb3JtIGl0IGJhY2sgaW50byBqc29uIGhlcmUKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUuc3RyaXAoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIChsaXN0LCB0dXBsZSwgZGljdCkpOgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24uZHVtcHModmFsdWUpCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEganNvbiBzdHJpbmcnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX3JhdyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgcmV0dXJuIHZhbHVlCgoKICAgIGRlZiBfY2hlY2tfdHlwZV9ieXRlcyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmh1bWFuX3RvX2J5dGVzKHZhbHVlKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBCeXRlIHZhbHVlJyAlIHR5cGUodmFsdWUpKQoKCiAgICBkZWYgX2NoZWNrX3R5cGVfYml0cyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmh1bWFuX3RvX2J5dGVzKHZhbHVlLCBpc2JpdHM9VHJ1ZSkKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgQml0IHZhbHVlJyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfYXJndW1lbnRfdHlwZXMoc2VsZiwgc3BlYz1Ob25lLCBwYXJhbT1Ob25lKToKICAgICAgICAnJycgZW5zdXJlIGFsbCBhcmd1bWVudHMgaGF2ZSB0aGUgcmVxdWVzdGVkIHR5cGUgJycnCgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgc3BlYyA9IHNlbGYuYXJndW1lbnRfc3BlYwogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAgICAgIHBhcmFtID0gc2VsZi5wYXJhbXMKCiAgICAgICAgZm9yIChrLCB2KSBpbiBzcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIHdhbnRlZCA9IHYuZ2V0KCd0eXBlJywgTm9uZSkKICAgICAgICAgICAgaWYgayBub3QgaW4gcGFyYW06CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiB3YW50ZWQgaXMgTm9uZToKICAgICAgICAgICAgICAgICMgTW9zdGx5IHdlIHdhbnQgdG8gZGVmYXVsdCB0byBzdHIuCiAgICAgICAgICAgICAgICAjIEZvciB2YWx1ZXMgc2V0IHRvIE5vbmUgZXhwbGljaXRseSwgcmV0dXJuIE5vbmUgaW5zdGVhZCBhcwogICAgICAgICAgICAgICAgIyB0aGF0IGFsbG93cyBhIHVzZXIgdG8gdW5zZXQgYSBwYXJhbWV0ZXIKICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHdhbnRlZCA9ICdzdHInCgogICAgICAgICAgICB2YWx1ZSA9IHBhcmFtW2tdCiAgICAgICAgICAgIGlmIHZhbHVlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdHlwZV9jaGVja2VyID0gc2VsZi5fQ0hFQ0tfQVJHVU1FTlRfVFlQRVNfRElTUEFUQ0hFUlt3YW50ZWRdCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iaW1wbGVtZW50YXRpb24gZXJyb3I6IHVua25vd24gdHlwZSAlcyByZXF1ZXN0ZWQgZm9yICVzIiAlICh3YW50ZWQsIGspKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwYXJhbVtrXSA9IHR5cGVfY2hlY2tlcih2YWx1ZSkKICAgICAgICAgICAgZXhjZXB0IChUeXBlRXJyb3IsIFZhbHVlRXJyb3IpOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJhcmd1bWVudCAlcyBpcyBvZiB0eXBlICVzIGFuZCB3ZSB3ZXJlIHVuYWJsZSB0byBjb252ZXJ0IHRvICVzOiAlcyIgJSAoaywgdHlwZSh2YWx1ZSksIHdhbnRlZCwgZSkpCgogICAgICAgICAgICAjIGRlYWwgd2l0aCBzdWIgb3B0aW9ucyB0byBjcmVhdGUgc3ViIHNwZWMKICAgICAgICAgICAgc3BlYyA9IE5vbmUKICAgICAgICAgICAgaWYgd2FudGVkID09ICdkaWN0JyBvciAod2FudGVkID09ICdsaXN0JyBhbmQgdi5nZXQoJ2VsZW1lbnRzJywgJycpID09ICdkaWN0Jyk6CiAgICAgICAgICAgICAgICBzcGVjID0gdi5nZXQoJ29wdGlvbnMnLCBOb25lKQogICAgICAgICAgICAgICAgaWYgc3BlYzoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF9hcmd1bWVudHMoc3BlYywgcGFyYW1ba10pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdHlwZXMoc3BlYywgcGFyYW1ba10pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdmFsdWVzKHNwZWMsIHBhcmFtW2tdKQoKICAgIGRlZiBfc2V0X2RlZmF1bHRzKHNlbGYsIHByZT1UcnVlKToKICAgICAgICBmb3IgKGssdikgaW4gc2VsZi5hcmd1bWVudF9zcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIGRlZmF1bHQgPSB2LmdldCgnZGVmYXVsdCcsIE5vbmUpCiAgICAgICAgICAgIGlmIHByZSBpcyBUcnVlOgogICAgICAgICAgICAgICAgIyB0aGlzIHByZXZlbnRzIHNldHRpbmcgZGVmYXVsdHMgb24gcmVxdWlyZWQgaXRlbXMKICAgICAgICAgICAgICAgIGlmIGRlZmF1bHQgaXMgbm90IE5vbmUgYW5kIGsgbm90IGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyYW1zW2tdID0gZGVmYXVsdAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBtYWtlIHN1cmUgdGhpbmdzIHdpdGhvdXQgYSBkZWZhdWx0IHN0aWxsIGdldCBzZXQgTm9uZQogICAgICAgICAgICAgICAgaWYgayBub3QgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBkZWZhdWx0CgogICAgZGVmIF9zZXRfZmFsbGJhY2tzKHNlbGYpOgogICAgICAgIGZvciBrLHYgaW4gc2VsZi5hcmd1bWVudF9zcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIGZhbGxiYWNrID0gdi5nZXQoJ2ZhbGxiYWNrJywgKE5vbmUsKSkKICAgICAgICAgICAgZmFsbGJhY2tfc3RyYXRlZ3kgPSBmYWxsYmFja1swXQogICAgICAgICAgICBmYWxsYmFja19hcmdzID0gW10KICAgICAgICAgICAgZmFsbGJhY2tfa3dhcmdzID0ge30KICAgICAgICAgICAgaWYgayBub3QgaW4gc2VsZi5wYXJhbXMgYW5kIGZhbGxiYWNrX3N0cmF0ZWd5IGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgZm9yIGl0ZW0gaW4gZmFsbGJhY2tbMTpdOgogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoaXRlbSwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrX2t3YXJncyA9IGl0ZW0KICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBmYWxsYmFja19hcmdzID0gaXRlbQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyYW1zW2tdID0gZmFsbGJhY2tfc3RyYXRlZ3koKmZhbGxiYWNrX2FyZ3MsICoqZmFsbGJhY2tfa3dhcmdzKQogICAgICAgICAgICAgICAgZXhjZXB0IEFuc2libGVGYWxsYmFja05vdEZvdW5kOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgZGVmIF9sb2FkX3BhcmFtcyhzZWxmKToKICAgICAgICAnJycgcmVhZCB0aGUgaW5wdXQgYW5kIHNldCB0aGUgcGFyYW1zIGF0dHJpYnV0ZS4KCiAgICAgICAgVGhpcyBtZXRob2QgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LiAgVGhlIGd1dHMgb2YgdGhlIGZ1bmN0aW9uCiAgICAgICAgd2VyZSBtb3ZlZCBvdXQgaW4gMi4xIHNvIHRoYXQgY3VzdG9tIG1vZHVsZXMgY291bGQgcmVhZCB0aGUgcGFyYW1ldGVycy4KICAgICAgICAnJycKICAgICAgICAjIGRlYnVnIG92ZXJyaWRlcyB0byByZWFkIGFyZ3MgZnJvbSBmaWxlIG9yIGNtZGxpbmUKICAgICAgICBzZWxmLnBhcmFtcyA9IF9sb2FkX3BhcmFtcygpCgogICAgZGVmIF9sb2dfdG9fc3lzbG9nKHNlbGYsIG1zZyk6CiAgICAgICAgaWYgSEFTX1NZU0xPRzoKICAgICAgICAgICAgbW9kdWxlID0gJ2Fuc2libGUtJXMnICUgc2VsZi5fbmFtZQogICAgICAgICAgICBmYWNpbGl0eSA9IGdldGF0dHIoc3lzbG9nLCBzZWxmLl9zeXNsb2dfZmFjaWxpdHksIHN5c2xvZy5MT0dfVVNFUikKICAgICAgICAgICAgc3lzbG9nLm9wZW5sb2coc3RyKG1vZHVsZSksIDAsIGZhY2lsaXR5KQogICAgICAgICAgICBzeXNsb2cuc3lzbG9nKHN5c2xvZy5MT0dfSU5GTywgbXNnKQoKICAgIGRlZiBkZWJ1ZyhzZWxmLCBtc2cpOgogICAgICAgIGlmIHNlbGYuX2RlYnVnOgogICAgICAgICAgICBzZWxmLmxvZygnW2RlYnVnXSAlcycgJSBtc2cpCgogICAgZGVmIGxvZyhzZWxmLCBtc2csIGxvZ19hcmdzPU5vbmUpOgoKICAgICAgICBpZiBub3Qgc2VsZi5ub19sb2c6CgogICAgICAgICAgICBpZiBsb2dfYXJncyBpcyBOb25lOgogICAgICAgICAgICAgICAgbG9nX2FyZ3MgPSBkaWN0KCkKCiAgICAgICAgICAgIG1vZHVsZSA9ICdhbnNpYmxlLSVzJyAlIHNlbGYuX25hbWUKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShtb2R1bGUsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgICAgIG1vZHVsZSA9IG1vZHVsZS5kZWNvZGUoJ3V0Zi04JywgJ3JlcGxhY2UnKQoKICAgICAgICAgICAgIyA2NjU1IC0gYWxsb3cgZm9yIGFjY2VudGVkIGNoYXJhY3RlcnMKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UobXNnLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJtc2cgc2hvdWxkIGJlIGEgc3RyaW5nIChnb3QgJXMpIiAlIHR5cGUobXNnKSkKCiAgICAgICAgICAgICMgV2Ugd2FudCBqb3VybmFsIHRvIGFsd2F5cyB0YWtlIHRleHQgdHlwZQogICAgICAgICAgICAjIHN5c2xvZyB0YWtlcyBieXRlcyBvbiBweTIsIHRleHQgdHlwZSBvbiBweTMKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShtc2csIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgICAgIGpvdXJuYWxfbXNnID0gcmVtb3ZlX3ZhbHVlcyhtc2cuZGVjb2RlKCd1dGYtOCcsICdyZXBsYWNlJyksIHNlbGYubm9fbG9nX3ZhbHVlcykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVE9ETzogc3Vycm9nYXRlZXNjYXBlIGlzIGEgZGFuZ2VyIGhlcmUgb24gUHkzCiAgICAgICAgICAgICAgICBqb3VybmFsX21zZyA9IHJlbW92ZV92YWx1ZXMobXNnLCBzZWxmLm5vX2xvZ192YWx1ZXMpCgogICAgICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgICAgICBzeXNsb2dfbXNnID0gam91cm5hbF9tc2cKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHN5c2xvZ19tc2cgPSBqb3VybmFsX21zZy5lbmNvZGUoJ3V0Zi04JywgJ3JlcGxhY2UnKQoKICAgICAgICAgICAgaWYgaGFzX2pvdXJuYWw6CiAgICAgICAgICAgICAgICBqb3VybmFsX2FyZ3MgPSBbKCJNT0RVTEUiLCBvcy5wYXRoLmJhc2VuYW1lKF9fZmlsZV9fKSldCiAgICAgICAgICAgICAgICBmb3IgYXJnIGluIGxvZ19hcmdzOgogICAgICAgICAgICAgICAgICAgIGpvdXJuYWxfYXJncy5hcHBlbmQoKGFyZy51cHBlcigpLCBzdHIobG9nX2FyZ3NbYXJnXSkpKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGpvdXJuYWwuc2VuZCh1IiVzICVzIiAlIChtb2R1bGUsIGpvdXJuYWxfbXNnKSwgKipkaWN0KGpvdXJuYWxfYXJncykpCiAgICAgICAgICAgICAgICBleGNlcHQgSU9FcnJvcjoKICAgICAgICAgICAgICAgICAgICAjIGZhbGwgYmFjayB0byBzeXNsb2cgc2luY2UgbG9nZ2luZyB0byBqb3VybmFsIGZhaWxlZAogICAgICAgICAgICAgICAgICAgIHNlbGYuX2xvZ190b19zeXNsb2coc3lzbG9nX21zZykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuX2xvZ190b19zeXNsb2coc3lzbG9nX21zZykKCiAgICBkZWYgX2xvZ19pbnZvY2F0aW9uKHNlbGYpOgogICAgICAgICcnJyBsb2cgdGhhdCBhbnNpYmxlIHJhbiB0aGUgbW9kdWxlICcnJwogICAgICAgICMgVE9ETzogZ2VuZXJhbGl6ZSBhIHNlcGFyYXRlIGxvZyBmdW5jdGlvbiBhbmQgbWFrZSBsb2dfaW52b2NhdGlvbiB1c2UgaXQKICAgICAgICAjIFNhbml0aXplIHBvc3NpYmxlIHBhc3N3b3JkIGFyZ3VtZW50IHdoZW4gbG9nZ2luZy4KICAgICAgICBsb2dfYXJncyA9IGRpY3QoKQoKICAgICAgICBmb3IgcGFyYW0gaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgIGNhbm9uICA9IHNlbGYuYWxpYXNlcy5nZXQocGFyYW0sIHBhcmFtKQogICAgICAgICAgICBhcmdfb3B0cyA9IHNlbGYuYXJndW1lbnRfc3BlYy5nZXQoY2Fub24sIHt9KQogICAgICAgICAgICBub19sb2cgPSBhcmdfb3B0cy5nZXQoJ25vX2xvZycsIEZhbHNlKQoKICAgICAgICAgICAgaWYgc2VsZi5ib29sZWFuKG5vX2xvZyk6CiAgICAgICAgICAgICAgICBsb2dfYXJnc1twYXJhbV0gPSAnTk9UX0xPR0dJTkdfUEFSQU1FVEVSJwogICAgICAgICAgICAjIHRyeSB0byBjYXB0dXJlIGFsbCBwYXNzd29yZHMvcGFzc3BocmFzZSBuYW1lZCBmaWVsZHMgbWlzc2VkIGJ5IG5vX2xvZwogICAgICAgICAgICBlbGlmIFBBU1NXT1JEX01BVENILnNlYXJjaChwYXJhbSkgYW5kIFwKICAgICAgICAgICAgICBhcmdfb3B0cy5nZXQoJ3R5cGUnLCAnc3RyJykgIT0gJ2Jvb2wnIGFuZCBcCiAgICAgICAgICAgICAgbm90IGFyZ19vcHRzLmdldCgnY2hvaWNlcycsIEZhbHNlKToKICAgICAgICAgICAgICAgICMgc2tpcCBib29sZWFuIGFuZCBlbnVtcyBhcyB0aGV5IGFyZSBhYm91dCAncGFzc3dvcmQnIHN0YXRlCiAgICAgICAgICAgICAgICBsb2dfYXJnc1twYXJhbV0gPSAnTk9UX0xPR0dJTkdfUEFTU1dPUkQnCiAgICAgICAgICAgICAgICBzZWxmLndhcm4oJ01vZHVsZSBkaWQgbm90IHNldCBub19sb2cgZm9yICVzJyAlIHBhcmFtKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcGFyYW1fdmFsID0gc2VsZi5wYXJhbXNbcGFyYW1dCiAgICAgICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShwYXJhbV92YWwsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgICAgICAgICAgICAgcGFyYW1fdmFsID0gc3RyKHBhcmFtX3ZhbCkKICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShwYXJhbV92YWwsIHRleHRfdHlwZSk6CiAgICAgICAgICAgICAgICAgICAgcGFyYW1fdmFsID0gcGFyYW1fdmFsLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICAgICAgbG9nX2FyZ3NbcGFyYW1dID0gaGV1cmlzdGljX2xvZ19zYW5pdGl6ZShwYXJhbV92YWwsIHNlbGYubm9fbG9nX3ZhbHVlcykKCiAgICAgICAgbXNnID0gWyclcz0lcycgJSAodG9fbmF0aXZlKGFyZyksIHRvX25hdGl2ZSh2YWwpKSBmb3IgYXJnLCB2YWwgaW4gbG9nX2FyZ3MuaXRlbXMoKV0KICAgICAgICBpZiBtc2c6CiAgICAgICAgICAgIG1zZyA9ICdJbnZva2VkIHdpdGggJXMnICUgJyAnLmpvaW4obXNnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1zZyA9ICdJbnZva2VkJwoKICAgICAgICBzZWxmLmxvZyhtc2csIGxvZ19hcmdzPWxvZ19hcmdzKQoKCiAgICBkZWYgX3NldF9jd2Qoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBjd2QgPSBvcy5nZXRjd2QoKQogICAgICAgICAgICBpZiBub3Qgb3MuYWNjZXNzKGN3ZCwgb3MuRl9PS3xvcy5SX09LKToKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigpCiAgICAgICAgICAgIHJldHVybiBjd2QKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICMgd2UgZG9uJ3QgaGF2ZSBhY2Nlc3MgdG8gdGhlIGN3ZCwgcHJvYmFibHkgYmVjYXVzZSBvZiBzdWRvLgogICAgICAgICAgICAjIFRyeSBhbmQgbW92ZSB0byBhIG5ldXRyYWwgbG9jYXRpb24gdG8gcHJldmVudCBlcnJvcnMKICAgICAgICAgICAgZm9yIGN3ZCBpbiBbb3MucGF0aC5leHBhbmR2YXJzKCckSE9NRScpLCB0ZW1wZmlsZS5nZXR0ZW1wZGlyKCldOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGlmIG9zLmFjY2Vzcyhjd2QsIG9zLkZfT0t8b3MuUl9PSyk6CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNoZGlyKGN3ZCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN3ZAogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAjIHdlIHdvbid0IGVycm9yIGhlcmUsIGFzIGl0IG1heSAqbm90KiBiZSBhIHByb2JsZW0sCiAgICAgICAgIyBhbmQgd2UgZG9uJ3Qgd2FudCB0byBicmVhayBtb2R1bGVzIHVubmVjZXNzYXJpbHkKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBnZXRfYmluX3BhdGgoc2VsZiwgYXJnLCByZXF1aXJlZD1GYWxzZSwgb3B0X2RpcnM9W10pOgogICAgICAgICcnJwogICAgICAgIGZpbmQgc3lzdGVtIGV4ZWN1dGFibGUgaW4gUEFUSC4KICAgICAgICBPcHRpb25hbCBhcmd1bWVudHM6CiAgICAgICAgICAgLSByZXF1aXJlZDogIGlmIGV4ZWN1dGFibGUgaXMgbm90IGZvdW5kIGFuZCByZXF1aXJlZCBpcyB0cnVlLCBmYWlsX2pzb24KICAgICAgICAgICAtIG9wdF9kaXJzOiAgb3B0aW9uYWwgbGlzdCBvZiBkaXJlY3RvcmllcyB0byBzZWFyY2ggaW4gYWRkaXRpb24gdG8gUEFUSAogICAgICAgIGlmIGZvdW5kIHJldHVybiBmdWxsIHBhdGg7IG90aGVyd2lzZSByZXR1cm4gTm9uZQogICAgICAgICcnJwogICAgICAgIHNiaW5fcGF0aHMgPSBbJy9zYmluJywgJy91c3Ivc2JpbicsICcvdXNyL2xvY2FsL3NiaW4nXQogICAgICAgIHBhdGhzID0gW10KICAgICAgICBmb3IgZCBpbiBvcHRfZGlyczoKICAgICAgICAgICAgaWYgZCBpcyBub3QgTm9uZSBhbmQgb3MucGF0aC5leGlzdHMoZCk6CiAgICAgICAgICAgICAgICBwYXRocy5hcHBlbmQoZCkKICAgICAgICBwYXRocyArPSBvcy5lbnZpcm9uLmdldCgnUEFUSCcsICcnKS5zcGxpdChvcy5wYXRoc2VwKQogICAgICAgIGJpbl9wYXRoID0gTm9uZQogICAgICAgICMgbWFuZ2xlIFBBVEggdG8gaW5jbHVkZSAvc2JpbiBkaXJzCiAgICAgICAgZm9yIHAgaW4gc2Jpbl9wYXRoczoKICAgICAgICAgICAgaWYgcCBub3QgaW4gcGF0aHMgYW5kIG9zLnBhdGguZXhpc3RzKHApOgogICAgICAgICAgICAgICAgcGF0aHMuYXBwZW5kKHApCiAgICAgICAgZm9yIGQgaW4gcGF0aHM6CiAgICAgICAgICAgIGlmIG5vdCBkOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgcGF0aCA9IG9zLnBhdGguam9pbihkLCBhcmcpCiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHBhdGgpIGFuZCBub3Qgb3MucGF0aC5pc2RpcihwYXRoKSBhbmQgaXNfZXhlY3V0YWJsZShwYXRoKToKICAgICAgICAgICAgICAgIGJpbl9wYXRoID0gcGF0aAogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICBpZiByZXF1aXJlZCBhbmQgYmluX3BhdGggaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdGYWlsZWQgdG8gZmluZCByZXF1aXJlZCBleGVjdXRhYmxlICVzIGluIHBhdGhzOiAlcycgJSAoYXJnLCBvcy5wYXRoc2VwLmpvaW4ocGF0aHMpKSkKICAgICAgICByZXR1cm4gYmluX3BhdGgKCiAgICBkZWYgYm9vbGVhbihzZWxmLCBhcmcpOgogICAgICAgICcnJyByZXR1cm4gYSBib29sIGZvciB0aGUgYXJnICcnJwogICAgICAgIGlmIGFyZyBpcyBOb25lIG9yIGlzaW5zdGFuY2UoYXJnLCBib29sKToKICAgICAgICAgICAgcmV0dXJuIGFyZwogICAgICAgIGlmIGlzaW5zdGFuY2UoYXJnLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBhcmcgPSBhcmcubG93ZXIoKQogICAgICAgIGlmIGFyZyBpbiBCT09MRUFOU19UUlVFOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsaWYgYXJnIGluIEJPT0xFQU5TX0ZBTFNFOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9JyVzIGlzIG5vdCBhIHZhbGlkIGJvb2xlYW4uIFZhbGlkIGJvb2xlYW5zIGluY2x1ZGU6ICVzJyAlICh0b190ZXh0KGFyZyksICcsJy5qb2luKFsnJXMnICUgeCBmb3IgeCBpbiBCT09MRUFOU10pKSkKCiAgICBkZWYganNvbmlmeShzZWxmLCBkYXRhKToKICAgICAgICBmb3IgZW5jb2RpbmcgaW4gKCJ1dGYtOCIsICJsYXRpbi0xIik6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmR1bXBzKGRhdGEsIGVuY29kaW5nPWVuY29kaW5nKQogICAgICAgICAgICAjIE9sZCBzeXN0ZW1zIHVzaW5nIG9sZCBzaW1wbGVqc29uIG1vZHVsZSBkb2VzIG5vdCBzdXBwb3J0IGVuY29kaW5nIGtleXdvcmQuCiAgICAgICAgICAgIGV4Y2VwdCBUeXBlRXJyb3I6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbmV3X2RhdGEgPSBqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZShkYXRhLCBlbmNvZGluZz1lbmNvZGluZykKICAgICAgICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRGVjb2RlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmR1bXBzKG5ld19kYXRhKQogICAgICAgICAgICBleGNlcHQgVW5pY29kZURlY29kZUVycm9yOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0ludmFsaWQgdW5pY29kZSBlbmNvZGluZyBlbmNvdW50ZXJlZCcpCgogICAgZGVmIGZyb21fanNvbihzZWxmLCBkYXRhKToKICAgICAgICByZXR1cm4ganNvbi5sb2FkcyhkYXRhKQoKICAgIGRlZiBhZGRfY2xlYW51cF9maWxlKHNlbGYsIHBhdGgpOgogICAgICAgIGlmIHBhdGggbm90IGluIHNlbGYuY2xlYW51cF9maWxlczoKICAgICAgICAgICAgc2VsZi5jbGVhbnVwX2ZpbGVzLmFwcGVuZChwYXRoKQoKICAgIGRlZiBkb19jbGVhbnVwX2ZpbGVzKHNlbGYpOgogICAgICAgIGZvciBwYXRoIGluIHNlbGYuY2xlYW51cF9maWxlczoKICAgICAgICAgICAgc2VsZi5jbGVhbnVwKHBhdGgpCgogICAgZGVmIF9yZXR1cm5fZm9ybWF0dGVkKHNlbGYsIGt3YXJncyk6CgogICAgICAgIHNlbGYuYWRkX3BhdGhfaW5mbyhrd2FyZ3MpCgogICAgICAgIGlmICdpbnZvY2F0aW9uJyBub3QgaW4ga3dhcmdzOgogICAgICAgICAgICBrd2FyZ3NbJ2ludm9jYXRpb24nXSA9IHsnbW9kdWxlX2FyZ3MnOiBzZWxmLnBhcmFtc30KCiAgICAgICAgaWYgJ3dhcm5pbmdzJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoa3dhcmdzWyd3YXJuaW5ncyddLCBsaXN0KToKICAgICAgICAgICAgICAgIGZvciB3IGluIGt3YXJnc1snd2FybmluZ3MnXToKICAgICAgICAgICAgICAgICAgICBzZWxmLndhcm4odykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYud2Fybihrd2FyZ3NbJ3dhcm5pbmdzJ10pCgogICAgICAgIGlmIHNlbGYuX3dhcm5pbmdzOgogICAgICAgICAgICBrd2FyZ3NbJ3dhcm5pbmdzJ10gPSBzZWxmLl93YXJuaW5ncwoKICAgICAgICBpZiAnZGVwcmVjYXRpb25zJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoa3dhcmdzWydkZXByZWNhdGlvbnMnXSwgbGlzdCk6CiAgICAgICAgICAgICAgICBmb3IgZCBpbiBrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddOgogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZCwgU0VRVUVOQ0VUWVBFKSBhbmQgbGVuKGQpID09IDI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGVwcmVjYXRlKGRbMF0sIHZlcnNpb249ZFsxXSkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRlcHJlY2F0ZShkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5kZXByZWNhdGUoa3dhcmdzWydkZXByZWNhdGlvbnMnXSkKCiAgICAgICAgaWYgc2VsZi5fZGVwcmVjYXRpb25zOgogICAgICAgICAgICBrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddID0gc2VsZi5fZGVwcmVjYXRpb25zCgogICAgICAgIGt3YXJncyA9IHJlbW92ZV92YWx1ZXMoa3dhcmdzLCBzZWxmLm5vX2xvZ192YWx1ZXMpCiAgICAgICAgcHJpbnQoJ1xuJXMnICUgc2VsZi5qc29uaWZ5KGt3YXJncykpCgogICAgZGVmIGV4aXRfanNvbihzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgJycnIHJldHVybiBmcm9tIHRoZSBtb2R1bGUsIHdpdGhvdXQgZXJyb3IgJycnCgogICAgICAgIGlmIG5vdCAnY2hhbmdlZCcgaW4ga3dhcmdzOgogICAgICAgICAgICBrd2FyZ3NbJ2NoYW5nZWQnXSA9IEZhbHNlCgogICAgICAgIHNlbGYuZG9fY2xlYW51cF9maWxlcygpCiAgICAgICAgc2VsZi5fcmV0dXJuX2Zvcm1hdHRlZChrd2FyZ3MpCiAgICAgICAgc3lzLmV4aXQoMCkKCiAgICBkZWYgZmFpbF9qc29uKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAnJycgcmV0dXJuIGZyb20gdGhlIG1vZHVsZSwgd2l0aCBhbiBlcnJvciBtZXNzYWdlICcnJwoKICAgICAgICBhc3NlcnQgJ21zZycgaW4ga3dhcmdzLCAiaW1wbGVtZW50YXRpb24gZXJyb3IgLS0gbXNnIHRvIGV4cGxhaW4gdGhlIGVycm9yIGlzIHJlcXVpcmVkIgogICAgICAgIGt3YXJnc1snZmFpbGVkJ10gPSBUcnVlCgogICAgICAgIGlmIG5vdCAnY2hhbmdlZCcgaW4ga3dhcmdzOgogICAgICAgICAgICBrd2FyZ3NbJ2NoYW5nZWQnXSA9IEZhbHNlCgogICAgICAgIHNlbGYuZG9fY2xlYW51cF9maWxlcygpCiAgICAgICAgc2VsZi5fcmV0dXJuX2Zvcm1hdHRlZChrd2FyZ3MpCiAgICAgICAgc3lzLmV4aXQoMSkKCiAgICBkZWYgZmFpbF9vbl9taXNzaW5nX3BhcmFtcyhzZWxmLCByZXF1aXJlZF9wYXJhbXM9Tm9uZSk6CiAgICAgICAgJycnIFRoaXMgaXMgZm9yIGNoZWNraW5nIGZvciByZXF1aXJlZCBwYXJhbXMgd2hlbiB3ZSBjYW4gbm90IGNoZWNrIHZpYSBhcmdzcGVjIGJlY2F1c2Ugd2UKICAgICAgICBuZWVkIG1vcmUgaW5mb3JtYXRpb24gdGhhbiBpcyBzaW1wbHkgZ2l2ZW4gaW4gdGhlIGFyZ3NwZWMuCiAgICAgICAgJycnCiAgICAgICAgaWYgbm90IHJlcXVpcmVkX3BhcmFtczoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgbWlzc2luZ19wYXJhbXMgPSBbXQogICAgICAgIGZvciByZXF1aXJlZF9wYXJhbSBpbiByZXF1aXJlZF9wYXJhbXM6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLnBhcmFtcy5nZXQocmVxdWlyZWRfcGFyYW0pOgogICAgICAgICAgICAgICAgbWlzc2luZ19wYXJhbXMuYXBwZW5kKHJlcXVpcmVkX3BhcmFtKQogICAgICAgIGlmIG1pc3NpbmdfcGFyYW1zOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9Im1pc3NpbmcgcmVxdWlyZWQgYXJndW1lbnRzOiAlcyIgJSAnLCcuam9pbihtaXNzaW5nX3BhcmFtcykpCgogICAgZGVmIGRpZ2VzdF9mcm9tX2ZpbGUoc2VsZiwgZmlsZW5hbWUsIGFsZ29yaXRobSk6CiAgICAgICAgJycnIFJldHVybiBoZXggZGlnZXN0IG9mIGxvY2FsIGZpbGUgZm9yIGEgZGlnZXN0X21ldGhvZCBzcGVjaWZpZWQgYnkgbmFtZSwgb3IgTm9uZSBpZiBmaWxlIGlzIG5vdCBwcmVzZW50LiAnJycKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZW5hbWUpOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIG9zLnBhdGguaXNkaXIoZmlsZW5hbWUpOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImF0dGVtcHRlZCB0byB0YWtlIGNoZWNrc3VtIG9mIGRpcmVjdG9yeTogJXMiICUgZmlsZW5hbWUpCgogICAgICAgICMgcHJlc2VydmUgb2xkIGJlaGF2aW91ciB3aGVyZSB0aGUgdGhpcmQgcGFyYW1ldGVyIHdhcyBhIGhhc2ggYWxnb3JpdGhtIG9iamVjdAogICAgICAgIGlmIGhhc2F0dHIoYWxnb3JpdGhtLCAnaGV4ZGlnZXN0Jyk6CiAgICAgICAgICAgIGRpZ2VzdF9tZXRob2QgPSBhbGdvcml0aG0KICAgICAgICBlbHNlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkaWdlc3RfbWV0aG9kID0gQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNU1thbGdvcml0aG1dKCkKICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJDb3VsZCBub3QgaGFzaCBmaWxlICclcycgd2l0aCBhbGdvcml0aG0gJyVzJy4gQXZhaWxhYmxlIGFsZ29yaXRobXM6ICVzIiAlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZpbGVuYW1lLCBhbGdvcml0aG0sICcsICcuam9pbihBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TKSkpCgogICAgICAgIGJsb2Nrc2l6ZSA9IDY0ICogMTAyNAogICAgICAgIGluZmlsZSA9IG9wZW4ob3MucGF0aC5yZWFscGF0aChmaWxlbmFtZSksICdyYicpCiAgICAgICAgYmxvY2sgPSBpbmZpbGUucmVhZChibG9ja3NpemUpCiAgICAgICAgd2hpbGUgYmxvY2s6CiAgICAgICAgICAgIGRpZ2VzdF9tZXRob2QudXBkYXRlKGJsb2NrKQogICAgICAgICAgICBibG9jayA9IGluZmlsZS5yZWFkKGJsb2Nrc2l6ZSkKICAgICAgICBpbmZpbGUuY2xvc2UoKQogICAgICAgIHJldHVybiBkaWdlc3RfbWV0aG9kLmhleGRpZ2VzdCgpCgogICAgZGVmIG1kNShzZWxmLCBmaWxlbmFtZSk6CiAgICAgICAgJycnIFJldHVybiBNRDUgaGV4IGRpZ2VzdCBvZiBsb2NhbCBmaWxlIHVzaW5nIGRpZ2VzdF9mcm9tX2ZpbGUoKS4KCiAgICAgICAgRG8gbm90IHVzZSB0aGlzIGZ1bmN0aW9uIHVubGVzcyB5b3UgaGF2ZSBubyBvdGhlciBjaG9pY2UgZm9yOgogICAgICAgICAgICAxKSBPcHRpb25hbCBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQogICAgICAgICAgICAyKSBDb21wYXRpYmlsaXR5IHdpdGggYSB0aGlyZCBwYXJ0eSBwcm90b2NvbAoKICAgICAgICBUaGlzIGZ1bmN0aW9uIHdpbGwgbm90IHdvcmsgb24gc3lzdGVtcyBjb21wbHlpbmcgd2l0aCBGSVBTLTE0MC0yLgoKICAgICAgICBNb3N0IHVzZXMgb2YgdGhpcyBmdW5jdGlvbiBjYW4gdXNlIHRoZSBtb2R1bGUuc2hhMSBmdW5jdGlvbiBpbnN0ZWFkLgogICAgICAgICcnJwogICAgICAgIGlmICdtZDUnIG5vdCBpbiBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdNRDUgbm90IGF2YWlsYWJsZS4gIFBvc3NpYmx5IHJ1bm5pbmcgaW4gRklQUyBtb2RlJykKICAgICAgICByZXR1cm4gc2VsZi5kaWdlc3RfZnJvbV9maWxlKGZpbGVuYW1lLCAnbWQ1JykKCiAgICBkZWYgc2hhMShzZWxmLCBmaWxlbmFtZSk6CiAgICAgICAgJycnIFJldHVybiBTSEExIGhleCBkaWdlc3Qgb2YgbG9jYWwgZmlsZSB1c2luZyBkaWdlc3RfZnJvbV9maWxlKCkuICcnJwogICAgICAgIHJldHVybiBzZWxmLmRpZ2VzdF9mcm9tX2ZpbGUoZmlsZW5hbWUsICdzaGExJykKCiAgICBkZWYgc2hhMjU2KHNlbGYsIGZpbGVuYW1lKToKICAgICAgICAnJycgUmV0dXJuIFNIQS0yNTYgaGV4IGRpZ2VzdCBvZiBsb2NhbCBmaWxlIHVzaW5nIGRpZ2VzdF9mcm9tX2ZpbGUoKS4gJycnCiAgICAgICAgcmV0dXJuIHNlbGYuZGlnZXN0X2Zyb21fZmlsZShmaWxlbmFtZSwgJ3NoYTI1NicpCgogICAgZGVmIGJhY2t1cF9sb2NhbChzZWxmLCBmbik6CiAgICAgICAgJycnbWFrZSBhIGRhdGUtbWFya2VkIGJhY2t1cCBvZiB0aGUgc3BlY2lmaWVkIGZpbGUsIHJldHVybiBUcnVlIG9yIEZhbHNlIG9uIHN1Y2Nlc3Mgb3IgZmFpbHVyZScnJwoKICAgICAgICBiYWNrdXBkZXN0ID0gJycKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhmbik6CiAgICAgICAgICAgICMgYmFja3VwcyBuYW1lZCBiYXNlbmFtZS5QSUQuWVlZWS1NTS1EREBISDpNTTpTU34KICAgICAgICAgICAgZXh0ID0gdGltZS5zdHJmdGltZSgiJVktJW0tJWRAJUg6JU06JVN+IiwgdGltZS5sb2NhbHRpbWUodGltZS50aW1lKCkpKQogICAgICAgICAgICBiYWNrdXBkZXN0ID0gJyVzLiVzLiVzJyAlIChmbiwgb3MuZ2V0cGlkKCksIGV4dCkKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5MihmbiwgYmFja3VwZGVzdCkKICAgICAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdDb3VsZCBub3QgbWFrZSBiYWNrdXAgb2YgJXMgdG8gJXM6ICVzJyAlIChmbiwgYmFja3VwZGVzdCwgZSkpCgogICAgICAgIHJldHVybiBiYWNrdXBkZXN0CgogICAgZGVmIGNsZWFudXAoc2VsZiwgdG1wZmlsZSk6CiAgICAgICAgaWYgb3MucGF0aC5leGlzdHModG1wZmlsZSk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLnVubGluayh0bXBmaWxlKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHN5cy5zdGRlcnIud3JpdGUoImNvdWxkIG5vdCBjbGVhbnVwICVzOiAlcyIgJSAodG1wZmlsZSwgZSkpCgogICAgZGVmIGF0b21pY19tb3ZlKHNlbGYsIHNyYywgZGVzdCwgdW5zYWZlX3dyaXRlcz1GYWxzZSk6CiAgICAgICAgJycnYXRvbWljYWxseSBtb3ZlIHNyYyB0byBkZXN0LCBjb3B5aW5nIGF0dHJpYnV0ZXMgZnJvbSBkZXN0LCByZXR1cm5zIHRydWUgb24gc3VjY2VzcwogICAgICAgIGl0IHVzZXMgb3MucmVuYW1lIHRvIGVuc3VyZSB0aGlzIGFzIGl0IGlzIGFuIGF0b21pYyBvcGVyYXRpb24sIHJlc3Qgb2YgdGhlIGZ1bmN0aW9uIGlzCiAgICAgICAgdG8gd29yayBhcm91bmQgbGltaXRhdGlvbnMsIGNvcm5lciBjYXNlcyBhbmQgZW5zdXJlIHNlbGludXggY29udGV4dCBpcyBzYXZlZCBpZiBwb3NzaWJsZScnJwogICAgICAgIGNvbnRleHQgPSBOb25lCiAgICAgICAgZGVzdF9zdGF0ID0gTm9uZQogICAgICAgIGJfc3JjID0gdG9fYnl0ZXMoc3JjLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGJfZGVzdCA9IHRvX2J5dGVzKGRlc3QsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoYl9kZXN0KToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGVzdF9zdGF0ID0gb3Muc3RhdChiX2Rlc3QpCgogICAgICAgICAgICAgICAgIyBjb3B5IG1vZGUgYW5kIG93bmVyc2hpcAogICAgICAgICAgICAgICAgb3MuY2htb2QoYl9zcmMsIGRlc3Rfc3RhdC5zdF9tb2RlICYgUEVSTV9CSVRTKQogICAgICAgICAgICAgICAgb3MuY2hvd24oYl9zcmMsIGRlc3Rfc3RhdC5zdF91aWQsIGRlc3Rfc3RhdC5zdF9naWQpCgogICAgICAgICAgICAgICAgIyB0cnkgdG8gY29weSBmbGFncyBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihvcywgJ2NoZmxhZ3MnKSBhbmQgaGFzYXR0cihkZXN0X3N0YXQsICdzdF9mbGFncycpOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2hmbGFncyhiX3NyYywgZGVzdF9zdGF0LnN0X2ZsYWdzKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBlcnIgaW4gJ0VPUE5PVFNVUFAnLCAnRU5PVFNVUCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKGVycm5vLCBlcnIpIGFuZCBlLmVycm5vID09IGdldGF0dHIoZXJybm8sIGVycik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgaWYgZS5lcnJubyAhPSBlcnJuby5FUEVSTToKICAgICAgICAgICAgICAgICAgICByYWlzZQogICAgICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9jb250ZXh0KGRlc3QpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfZGVmYXVsdF9jb250ZXh0KGRlc3QpCgogICAgICAgIGNyZWF0aW5nID0gbm90IG9zLnBhdGguZXhpc3RzKGJfZGVzdCkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIE9wdGltaXN0aWNhbGx5IHRyeSBhIHJlbmFtZSwgc29sdmVzIHNvbWUgY29ybmVyIGNhc2VzIGFuZCBjYW4gYXZvaWQgdXNlbGVzcyB3b3JrLCB0aHJvd3MgZXhjZXB0aW9uIGlmIG5vdCBhdG9taWMuCiAgICAgICAgICAgIG9zLnJlbmFtZShiX3NyYywgYl9kZXN0KQogICAgICAgIGV4Y2VwdCAoSU9FcnJvciwgT1NFcnJvcik6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgaWYgZS5lcnJubyBub3QgaW4gW2Vycm5vLkVQRVJNLCBlcnJuby5FWERFViwgZXJybm8uRUFDQ0VTLCBlcnJuby5FVFhUQlNZLCBlcnJuby5FQlVTWV06CiAgICAgICAgICAgICAgICAjIG9ubHkgdHJ5IHdvcmthcm91bmRzIGZvciBlcnJubyAxOCAoY3Jvc3MgZGV2aWNlKSwgMSAobm90IHBlcm1pdHRlZCksICAxMyAocGVybWlzc2lvbiBkZW5pZWQpCiAgICAgICAgICAgICAgICAjIGFuZCAyNiAodGV4dCBmaWxlIGJ1c3kpIHdoaWNoIGhhcHBlbnMgb24gdmFncmFudCBzeW5jZWQgZm9sZGVycyBhbmQgb3RoZXIgJ2V4b3RpYycgbm9uIHBvc2l4IGZpbGUgc3lzdGVtcwogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdDb3VsZCBub3QgcmVwbGFjZSBmaWxlOiAlcyB0byAlczogJXMnICUgKHNyYywgZGVzdCwgZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYl9kZXN0X2RpciA9IG9zLnBhdGguZGlybmFtZShiX2Rlc3QpCiAgICAgICAgICAgICAgICAjIFVzZSBieXRlcyBoZXJlLiAgSW4gdGhlIHNoaXBwYWJsZSBDSSwgdGhpcyBmYWlscyB3aXRoCiAgICAgICAgICAgICAgICAjIGEgVW5pY29kZUVycm9yIHdpdGggc3Vycm9nYXRlZXNjYXBlJ2Qgc3RyaW5ncyBmb3IgYW4gdW5rbm93bgogICAgICAgICAgICAgICAgIyByZWFzb24gKGRvZXNuJ3QgaGFwcGVuIGluIGEgbG9jYWwgVWJ1bnR1MTYuMDQgVk0pCiAgICAgICAgICAgICAgICBuYXRpdmVfZGVzdF9kaXIgPSBiX2Rlc3RfZGlyCiAgICAgICAgICAgICAgICBuYXRpdmVfc3VmZml4ID0gb3MucGF0aC5iYXNlbmFtZShiX2Rlc3QpCiAgICAgICAgICAgICAgICBuYXRpdmVfcHJlZml4ID0gYignLmFuc2libGVfdG1wJykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB0bXBfZGVzdF9mZCwgdG1wX2Rlc3RfbmFtZSA9IHRlbXBmaWxlLm1rc3RlbXAoIHByZWZpeD1uYXRpdmVfcHJlZml4LCBkaXI9bmF0aXZlX2Rlc3RfZGlyLCBzdWZmaXg9bmF0aXZlX3N1ZmZpeCkKICAgICAgICAgICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nVGhlIGRlc3RpbmF0aW9uIGRpcmVjdG9yeSAoJXMpIGlzIG5vdCB3cml0YWJsZSBieSB0aGUgY3VycmVudCB1c2VyLiBFcnJvciB3YXM6ICVzJyAlIChvcy5wYXRoLmRpcm5hbWUoZGVzdCksIGUpKQogICAgICAgICAgICAgICAgZXhjZXB0IFR5cGVFcnJvcjoKICAgICAgICAgICAgICAgICAgICAjIFdlIGV4cGVjdCB0aGF0IHRoaXMgaXMgaGFwcGVuaW5nIGJlY2F1c2UgcHl0aG9uMy40LnggYW5kCiAgICAgICAgICAgICAgICAgICAgIyBiZWxvdyBjYW4ndCBoYW5kbGUgYnl0ZSBzdHJpbmdzIGluIG1rc3RlbXAoKS4gIFRyYWNlYmFjawogICAgICAgICAgICAgICAgICAgICMgd291bGQgZW5kIGluIHNvbWV0aGluZyBsaWtlOgogICAgICAgICAgICAgICAgICAgICMgICAgIGZpbGUgPSBfb3MucGF0aC5qb2luKGRpciwgcHJlICsgbmFtZSArIHN1ZikKICAgICAgICAgICAgICAgICAgICAjIFR5cGVFcnJvcjogY2FuJ3QgY29uY2F0IGJ5dGVzIHRvIHN0cgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nRmFpbGVkIGNyZWF0aW5nIHRlbXAgZmlsZSBmb3IgYXRvbWljIG1vdmUuICBUaGlzIHVzdWFsbHkgaGFwcGVucyB3aGVuIHVzaW5nIFB5dGhvbjMgbGVzcyB0aGFuIFB5dGhvbjMuNS4gJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnUGxlYXNlIHVzZSBQeXRob24yLnggb3IgUHl0aG9uMy41IG9yIGdyZWF0ZXIuJywgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCgogICAgICAgICAgICAgICAgYl90bXBfZGVzdF9uYW1lID0gdG9fYnl0ZXModG1wX2Rlc3RfbmFtZSwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAjIGNsb3NlIHRtcCBmaWxlIGhhbmRsZSBiZWZvcmUgZmlsZSBvcGVyYXRpb25zIHRvIHByZXZlbnQgdGV4dCBmaWxlIGJ1c3kgZXJyb3JzIG9uIHZib3hmcyBzeW5jZWQgZm9sZGVycyAod2luZG93cyBob3N0KQogICAgICAgICAgICAgICAgICAgICAgICBvcy5jbG9zZSh0bXBfZGVzdF9mZCkKICAgICAgICAgICAgICAgICAgICAgICAgIyBsZWF2ZXMgdG1wIGZpbGUgYmVoaW5kIHdoZW4gc3VkbyBhbmQgbm90IHJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2h1dGlsLm1vdmUoYl9zcmMsIGJfdG1wX2Rlc3RfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIGNsZWFudXAgd2lsbCBoYXBwZW4gYnkgJ3JtJyBvZiB0ZW1wZGlyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIGNvcHkyIHdpbGwgcHJlc2VydmUgc29tZSBtZXRhZGF0YQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2h1dGlsLmNvcHkyKGJfc3JjLCBiX3RtcF9kZXN0X25hbWUpCgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYl90bXBfZGVzdF9uYW1lLCBjb250ZXh0LCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wX3N0YXQgPSBvcy5zdGF0KGJfdG1wX2Rlc3RfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGRlc3Rfc3RhdCBhbmQgKHRtcF9zdGF0LnN0X3VpZCAhPSBkZXN0X3N0YXQuc3RfdWlkIG9yIHRtcF9zdGF0LnN0X2dpZCAhPSBkZXN0X3N0YXQuc3RfZ2lkKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy5jaG93bihiX3RtcF9kZXN0X25hbWUsIGRlc3Rfc3RhdC5zdF91aWQsIGRlc3Rfc3RhdC5zdF9naWQpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZS5lcnJubyAhPSBlcnJuby5FUEVSTToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy5yZW5hbWUoYl90bXBfZGVzdF9uYW1lLCBiX2Rlc3QpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCAoc2h1dGlsLkVycm9yLCBPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVuc2FmZV93cml0ZXMgYW5kIGUuZXJybm8gPT0gZXJybm8uRUJVU1k6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fdW5zYWZlX3dyaXRlcyhiX3RtcF9kZXN0X25hbWUsIGJfZGVzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdVbmFibGUgdG8gcmVuYW1lIGZpbGU6ICVzIHRvICVzOiAlcycgJSAoc3JjLCBkZXN0LCBlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nRmFpbGVkIHRvIHJlcGxhY2UgZmlsZTogJXMgdG8gJXM6ICVzJyAlIChzcmMsIGRlc3QsIGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jbGVhbnVwKGJfdG1wX2Rlc3RfbmFtZSkKCiAgICAgICAgaWYgY3JlYXRpbmc6CiAgICAgICAgICAgICMgbWFrZSBzdXJlIHRoZSBmaWxlIGhhcyB0aGUgY29ycmVjdCBwZXJtaXNzaW9ucwogICAgICAgICAgICAjIGJhc2VkIG9uIHRoZSBjdXJyZW50IHZhbHVlIG9mIHVtYXNrCiAgICAgICAgICAgIHVtYXNrID0gb3MudW1hc2soMCkKICAgICAgICAgICAgb3MudW1hc2sodW1hc2spCiAgICAgICAgICAgIG9zLmNobW9kKGJfZGVzdCwgREVGQVVMVF9QRVJNICYgfnVtYXNrKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5jaG93bihiX2Rlc3QsIG9zLmdldGV1aWQoKSwgb3MuZ2V0ZWdpZCgpKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICMgV2UncmUgb2theSB3aXRoIHRyeWluZyBvdXIgYmVzdCBoZXJlLiAgSWYgdGhlIHVzZXIgaXMgbm90CiAgICAgICAgICAgICAgICAjIHJvb3QgKG9yIG9sZCBVbmljZXMpIHRoZXkgd29uJ3QgYmUgYWJsZSB0byBjaG93bi4KICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgaWYgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgIyByZW5hbWUgbWlnaHQgbm90IHByZXNlcnZlIGNvbnRleHQKICAgICAgICAgICAgc2VsZi5zZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoZGVzdCwgY29udGV4dCwgRmFsc2UpCgogICAgZGVmIF91bnNhZmVfd3JpdGVzKHNlbGYsIHNyYywgZGVzdCk6CiAgICAgICAgIyBzYWRseSB0aGVyZSBhcmUgc29tZSBzaXR1YXRpb25zIHdoZXJlIHdlIGNhbm5vdCBlbnN1cmUgYXRvbWljaXR5LCBidXQgb25seSBpZgogICAgICAgICMgdGhlIHVzZXIgaW5zaXN0cyBhbmQgd2UgZ2V0IHRoZSBhcHByb3ByaWF0ZSBlcnJvciB3ZSB1cGRhdGUgdGhlIGZpbGUgdW5zYWZlbHkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG91dF9kZXN0ID0gb3BlbihkZXN0LCAnd2InKQogICAgICAgICAgICAgICAgaW5fc3JjID0gb3BlbihzcmMsICdyYicpCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weWZpbGVvYmooaW5fc3JjLCBvdXRfZGVzdCkKICAgICAgICAgICAgZmluYWxseTogICMgYXNzdXJpbmcgY2xvc2VkIGZpbGVzIGluIDIuNCBjb21wYXRpYmxlIHdheQogICAgICAgICAgICAgICAgaWYgb3V0X2Rlc3Q6CiAgICAgICAgICAgICAgICAgICAgb3V0X2Rlc3QuY2xvc2UoKQogICAgICAgICAgICAgICAgaWYgaW5fc3JjOgogICAgICAgICAgICAgICAgICAgIGluX3NyYy5jbG9zZSgpCiAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nQ291bGQgbm90IHdyaXRlIGRhdGEgdG8gZmlsZSAoJXMpIGZyb20gKCVzKTogJXMnICUgKGRlc3QsIHNyYywgZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQoKCiAgICBkZWYgX3JlYWRfZnJvbV9waXBlcyhzZWxmLCBycGlwZXMsIHJmZHMsIGZpbGVfZGVzY3JpcHRvcik6CiAgICAgICAgZGF0YSA9IGIoJycpCiAgICAgICAgaWYgZmlsZV9kZXNjcmlwdG9yIGluIHJmZHM6CiAgICAgICAgICAgIGRhdGEgPSBvcy5yZWFkKGZpbGVfZGVzY3JpcHRvci5maWxlbm8oKSwgOTAwMCkKICAgICAgICAgICAgaWYgZGF0YSA9PSBiKCcnKToKICAgICAgICAgICAgICAgIHJwaXBlcy5yZW1vdmUoZmlsZV9kZXNjcmlwdG9yKQoKICAgICAgICByZXR1cm4gZGF0YQoKICAgIGRlZiBydW5fY29tbWFuZChzZWxmLCBhcmdzLCBjaGVja19yYz1GYWxzZSwgY2xvc2VfZmRzPVRydWUsIGV4ZWN1dGFibGU9Tm9uZSwgZGF0YT1Ob25lLCBiaW5hcnlfZGF0YT1GYWxzZSwgcGF0aF9wcmVmaXg9Tm9uZSwgY3dkPU5vbmUsCiAgICAgICAgICAgICAgICAgICAgdXNlX3Vuc2FmZV9zaGVsbD1GYWxzZSwgcHJvbXB0X3JlZ2V4PU5vbmUsIGVudmlyb25fdXBkYXRlPU5vbmUsIHVtYXNrPU5vbmUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpOgogICAgICAgICcnJwogICAgICAgIEV4ZWN1dGUgYSBjb21tYW5kLCByZXR1cm5zIHJjLCBzdGRvdXQsIGFuZCBzdGRlcnIuCgogICAgICAgIDphcmcgYXJnczogaXMgdGhlIGNvbW1hbmQgdG8gcnVuCiAgICAgICAgICAgICogSWYgYXJncyBpcyBhIGxpc3QsIHRoZSBjb21tYW5kIHdpbGwgYmUgcnVuIHdpdGggc2hlbGw9RmFsc2UuCiAgICAgICAgICAgICogSWYgYXJncyBpcyBhIHN0cmluZyBhbmQgdXNlX3Vuc2FmZV9zaGVsbD1GYWxzZSBpdCB3aWxsIHNwbGl0IGFyZ3MgdG8gYSBsaXN0IGFuZCBydW4gd2l0aCBzaGVsbD1GYWxzZQogICAgICAgICAgICAqIElmIGFyZ3MgaXMgYSBzdHJpbmcgYW5kIHVzZV91bnNhZmVfc2hlbGw9VHJ1ZSBpdCBydW5zIHdpdGggc2hlbGw9VHJ1ZS4KICAgICAgICA6a3cgY2hlY2tfcmM6IFdoZXRoZXIgdG8gY2FsbCBmYWlsX2pzb24gaW4gY2FzZSBvZiBub24gemVybyBSQy4KICAgICAgICAgICAgRGVmYXVsdCBGYWxzZQogICAgICAgIDprdyBjbG9zZV9mZHM6IFNlZSBkb2N1bWVudGF0aW9uIGZvciBzdWJwcm9jZXNzLlBvcGVuKCkuIERlZmF1bHQgVHJ1ZQogICAgICAgIDprdyBleGVjdXRhYmxlOiBTZWUgZG9jdW1lbnRhdGlvbiBmb3Igc3VicHJvY2Vzcy5Qb3BlbigpLiBEZWZhdWx0IE5vbmUKICAgICAgICA6a3cgZGF0YTogSWYgZ2l2ZW4sIGluZm9ybWF0aW9uIHRvIHdyaXRlIHRvIHRoZSBzdGRpbiBvZiB0aGUgY29tbWFuZAogICAgICAgIDprdyBiaW5hcnlfZGF0YTogSWYgRmFsc2UsIGFwcGVuZCBhIG5ld2xpbmUgdG8gdGhlIGRhdGEuICBEZWZhdWx0IEZhbHNlCiAgICAgICAgOmt3IHBhdGhfcHJlZml4OiBJZiBnaXZlbiwgYWRkaXRpb25hbCBwYXRoIHRvIGZpbmQgdGhlIGNvbW1hbmQgaW4uCiAgICAgICAgICAgIFRoaXMgYWRkcyB0byB0aGUgUEFUSCBlbnZpcm9ubWVudCB2YWlyYWJsZSBzbyBoZWxwZXIgY29tbWFuZHMgaW4KICAgICAgICAgICAgdGhlIHNhbWUgZGlyZWN0b3J5IGNhbiBhbHNvIGJlIGZvdW5kCiAgICAgICAgOmt3IGN3ZDogSWYgZ2l2ZW4sIHdvcmtpbmcgZGlyZWN0b3J5IHRvIHJ1biB0aGUgY29tbWFuZCBpbnNpZGUKICAgICAgICA6a3cgdXNlX3Vuc2FmZV9zaGVsbDogU2VlIGBhcmdzYCBwYXJhbWV0ZXIuICBEZWZhdWx0IEZhbHNlCiAgICAgICAgOmt3IHByb21wdF9yZWdleDogUmVnZXggc3RyaW5nIChub3QgYSBjb21waWxlZCByZWdleCkgd2hpY2ggY2FuIGJlCiAgICAgICAgICAgIHVzZWQgdG8gZGV0ZWN0IHByb21wdHMgaW4gdGhlIHN0ZG91dCB3aGljaCB3b3VsZCBvdGhlcndpc2UgY2F1c2UKICAgICAgICAgICAgdGhlIGV4ZWN1dGlvbiB0byBoYW5nIChlc3BlY2lhbGx5IGlmIG5vIGlucHV0IGRhdGEgaXMgc3BlY2lmaWVkKQogICAgICAgIDprdyBlbnZpcm9uX3VwZGF0ZTogZGljdGlvbmFyeSB0byAqdXBkYXRlKiBvcy5lbnZpcm9uIHdpdGgKICAgICAgICA6a3cgdW1hc2s6IFVtYXNrIHRvIGJlIHVzZWQgd2hlbiBydW5uaW5nIHRoZSBjb21tYW5kLiBEZWZhdWx0IE5vbmUKICAgICAgICA6a3cgZW5jb2Rpbmc6IFNpbmNlIHdlIHJldHVybiBuYXRpdmUgc3RyaW5ncywgb24gcHl0aG9uMyB3ZSBuZWVkIHRvCiAgICAgICAgICAgIGtub3cgdGhlIGVuY29kaW5nIHRvIHVzZSB0byB0cmFuc2Zvcm0gZnJvbSBieXRlcyB0byB0ZXh0LiAgSWYgeW91CiAgICAgICAgICAgIHdhbnQgdG8gYWx3YXlzIGdldCBieXRlcyBiYWNrLCB1c2UgZW5jb2Rpbmc9Tm9uZS4gIFRoZSBkZWZhdWx0IGlzCiAgICAgICAgICAgICJ1dGYtOCIuICBUaGlzIGRvZXMgbm90IGFmZmVjdCB0cmFuc2Zvcm1hdGlvbiBvZiBzdHJpbmdzIGdpdmVuIGFzCiAgICAgICAgICAgIGFyZ3MuCiAgICAgICAgOmt3IGVycm9yczogU2luY2Ugd2UgcmV0dXJuIG5hdGl2ZSBzdHJpbmdzLCBvbiBweXRob24zIHdlIG5lZWQgdG8KICAgICAgICAgICAgdHJhbnNmb3JtIHN0ZG91dCBhbmQgc3RkZXJyIGZyb20gYnl0ZXMgdG8gdGV4dC4gIElmIHRoZSBieXRlcyBhcmUKICAgICAgICAgICAgdW5kZWNvZGFibGUgaW4gdGhlIGBgZW5jb2RpbmdgYCBzcGVjaWZpZWQsIHRoZW4gdXNlIHRoaXMgZXJyb3IKICAgICAgICAgICAgaGFuZGxlciB0byBkZWFsIHdpdGggdGhlbS4gIFRoZSBkZWZhdWx0IGlzIGBgc3Vycm9nYXRlX29yX3N0cmljdGBgCiAgICAgICAgICAgIHdoaWNoIG1lYW5zIHRoYXQgdGhlIGJ5dGVzIHdpbGwgYmUgZGVjb2RlZCB1c2luZyB0aGUKICAgICAgICAgICAgc3Vycm9nYXRlZXNjYXBlIGVycm9yIGhhbmRsZXIgaWYgYXZhaWxhYmxlIChhdmFpbGFibGUgb24gYWxsCiAgICAgICAgICAgIHB5dGhvbjMgdmVyc2lvbnMgd2Ugc3VwcG9ydCkgb3RoZXJ3aXNlIGEgVW5pY29kZUVycm9yIHRyYWNlYmFjawogICAgICAgICAgICB3aWxsIGJlIHJhaXNlZC4gIFRoaXMgZG9lcyBub3QgYWZmZWN0IHRyYW5zZm9ybWF0aW9ucyBvZiBzdHJpbmdzCiAgICAgICAgICAgIGdpdmVuIGFzIGFyZ3MuCiAgICAgICAgOnJldHVybnM6IEEgMy10dXBsZSBvZiByZXR1cm4gY29kZSAoaW50ZWdlciksIHN0ZG91dCAobmF0aXZlIHN0cmluZyksCiAgICAgICAgICAgIGFuZCBzdGRlcnIgKG5hdGl2ZSBzdHJpbmcpLiAgT24gcHl0aG9uMiwgc3Rkb3V0IGFuZCBzdGRlcnIgYXJlIGJvdGgKICAgICAgICAgICAgYnl0ZSBzdHJpbmdzLiAgT24gcHl0aG9uMywgc3Rkb3V0IGFuZCBzdGRlcnIgYXJlIHRleHQgc3RyaW5ncyBjb252ZXJ0ZWQKICAgICAgICAgICAgYWNjb3JkaW5nIHRvIHRoZSBlbmNvZGluZyBhbmQgZXJyb3JzIHBhcmFtZXRlcnMuICBJZiB5b3Ugd2FudCBieXRlCiAgICAgICAgICAgIHN0cmluZ3Mgb24gcHl0aG9uMywgdXNlIGVuY29kaW5nPU5vbmUgdG8gdHVybiBkZWNvZGluZyB0byB0ZXh0IG9mZi4KICAgICAgICAnJycKCiAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCBsaXN0KToKICAgICAgICAgICAgaWYgdXNlX3Vuc2FmZV9zaGVsbDoKICAgICAgICAgICAgICAgIGFyZ3MgPSAiICIuam9pbihbc2hsZXhfcXVvdGUoeCkgZm9yIHggaW4gYXJnc10pCiAgICAgICAgICAgICAgICBzaGVsbCA9IFRydWUKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoYXJncywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKSBhbmQgdXNlX3Vuc2FmZV9zaGVsbDoKICAgICAgICAgICAgc2hlbGwgPSBUcnVlCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGFyZ3MsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgIGlmIG5vdCB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICAgICAgIyBPbiBweXRob24yLjYgYW5kIGJlbG93LCBzaGxleCBoYXMgcHJvYmxlbXMgd2l0aCB0ZXh0IHR5cGUKICAgICAgICAgICAgICAgICMgT24gcHl0aG9uMywgc2hsZXggbmVlZHMgYSB0ZXh0IHR5cGUuCiAgICAgICAgICAgICAgICBpZiBQWTI6CiAgICAgICAgICAgICAgICAgICAgYXJncyA9IHRvX2J5dGVzKGFyZ3MsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgICAgICAgICBlbGlmIFBZMzoKICAgICAgICAgICAgICAgICAgICBhcmdzID0gdG9fdGV4dChhcmdzLCBlcnJvcnM9J3N1cnJvZ2F0ZWVzY2FwZScpCiAgICAgICAgICAgICAgICBhcmdzID0gc2hsZXguc3BsaXQoYXJncykKICAgICAgICBlbHNlOgogICAgICAgICAgICBtc2cgPSAiQXJndW1lbnQgJ2FyZ3MnIHRvIHJ1bl9jb21tYW5kIG11c3QgYmUgbGlzdCBvciBzdHJpbmciCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPTI1NywgY21kPWFyZ3MsIG1zZz1tc2cpCgogICAgICAgIHNoZWxsID0gRmFsc2UKICAgICAgICBpZiB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICBpZiBleGVjdXRhYmxlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBleGVjdXRhYmxlID0gb3MuZW52aXJvbi5nZXQoJ1NIRUxMJykKICAgICAgICAgICAgaWYgZXhlY3V0YWJsZToKICAgICAgICAgICAgICAgIGFyZ3MgPSBbZXhlY3V0YWJsZSwgJy1jJywgYXJnc10KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNoZWxsID0gVHJ1ZQoKICAgICAgICBwcm9tcHRfcmUgPSBOb25lCiAgICAgICAgaWYgcHJvbXB0X3JlZ2V4OgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHByb21wdF9yZWdleCwgdGV4dF90eXBlKToKICAgICAgICAgICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgICAgICAgICBwcm9tcHRfcmVnZXggPSB0b19ieXRlcyhwcm9tcHRfcmVnZXgsIGVycm9ycz0nc3Vycm9nYXRlZXNjYXBlJykKICAgICAgICAgICAgICAgIGVsaWYgUFkyOgogICAgICAgICAgICAgICAgICAgIHByb21wdF9yZWdleCA9IHRvX2J5dGVzKHByb21wdF9yZWdleCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcHJvbXB0X3JlID0gcmUuY29tcGlsZShwcm9tcHRfcmVnZXgsIHJlLk1VTFRJTElORSkKICAgICAgICAgICAgZXhjZXB0IHJlLmVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJpbnZhbGlkIHByb21wdCByZWd1bGFyIGV4cHJlc3Npb24gZ2l2ZW4gdG8gcnVuX2NvbW1hbmQiKQoKICAgICAgICAjIGV4cGFuZCB0aGluZ3MgbGlrZSAkSE9NRSBhbmQgfgogICAgICAgIGlmIG5vdCBzaGVsbDoKICAgICAgICAgICAgYXJncyA9IFsgb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyh4KSkgZm9yIHggaW4gYXJncyBpZiB4IGlzIG5vdCBOb25lIF0KCiAgICAgICAgcmMgPSAwCiAgICAgICAgbXNnID0gTm9uZQogICAgICAgIHN0X2luID0gTm9uZQoKICAgICAgICAjIE1hbmlwdWxhdGUgdGhlIGVudmlyb24gd2UnbGwgc2VuZCB0byB0aGUgbmV3IHByb2Nlc3MKICAgICAgICBvbGRfZW52X3ZhbHMgPSB7fQogICAgICAgICMgV2UgY2FuIHNldCB0aGlzIGZyb20gYm90aCBhbiBhdHRyaWJ1dGUgYW5kIHBlciBjYWxsCiAgICAgICAgZm9yIGtleSwgdmFsIGluIHNlbGYucnVuX2NvbW1hbmRfZW52aXJvbl91cGRhdGUuaXRlbXMoKToKICAgICAgICAgICAgb2xkX2Vudl92YWxzW2tleV0gPSBvcy5lbnZpcm9uLmdldChrZXksIE5vbmUpCiAgICAgICAgICAgIG9zLmVudmlyb25ba2V5XSA9IHZhbAogICAgICAgIGlmIGVudmlyb25fdXBkYXRlOgogICAgICAgICAgICBmb3Iga2V5LCB2YWwgaW4gZW52aXJvbl91cGRhdGUuaXRlbXMoKToKICAgICAgICAgICAgICAgIG9sZF9lbnZfdmFsc1trZXldID0gb3MuZW52aXJvbi5nZXQoa2V5LCBOb25lKQogICAgICAgICAgICAgICAgb3MuZW52aXJvbltrZXldID0gdmFsCiAgICAgICAgaWYgcGF0aF9wcmVmaXg6CiAgICAgICAgICAgIG9sZF9lbnZfdmFsc1snUEFUSCddID0gb3MuZW52aXJvblsnUEFUSCddCiAgICAgICAgICAgIG9zLmVudmlyb25bJ1BBVEgnXSA9ICIlczolcyIgJSAocGF0aF9wcmVmaXgsIG9zLmVudmlyb25bJ1BBVEgnXSkKCiAgICAgICAgIyBJZiB1c2luZyB0ZXN0LW1vZHVsZSBhbmQgZXhwbG9kZSwgdGhlIHJlbW90ZSBsaWIgcGF0aCB3aWxsIHJlc2VtYmxlIC4uLgogICAgICAgICMgICAvdG1wL3Rlc3RfbW9kdWxlX3NjcmF0Y2gvZGVidWdfZGlyL2Fuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5CiAgICAgICAgIyBJZiB1c2luZyBhbnNpYmxlIG9yIGFuc2libGUtcGxheWJvb2sgd2l0aCBhIHJlbW90ZSBzeXN0ZW0gLi4uCiAgICAgICAgIyAgIC90bXAvYW5zaWJsZV92bXdlTFEvYW5zaWJsZV9tb2RsaWIuemlwL2Fuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5CgogICAgICAgICMgQ2xlYW4gb3V0IHB5dGhvbiBwYXRocyBzZXQgYnkgYW5zaWJhbGx6CiAgICAgICAgaWYgJ1BZVEhPTlBBVEgnIGluIG9zLmVudmlyb246CiAgICAgICAgICAgIHB5cGF0aHMgPSBvcy5lbnZpcm9uWydQWVRIT05QQVRIJ10uc3BsaXQoJzonKQogICAgICAgICAgICBweXBhdGhzID0gW3ggZm9yIHggaW4gcHlwYXRocyBcCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCB4LmVuZHN3aXRoKCcvYW5zaWJsZV9tb2RsaWIuemlwJykgXAogICAgICAgICAgICAgICAgICAgICAgICBhbmQgbm90IHguZW5kc3dpdGgoJy9kZWJ1Z19kaXInKV0KICAgICAgICAgICAgb3MuZW52aXJvblsnUFlUSE9OUEFUSCddID0gJzonLmpvaW4ocHlwYXRocykKICAgICAgICAgICAgaWYgbm90IG9zLmVudmlyb25bJ1BZVEhPTlBBVEgnXToKICAgICAgICAgICAgICAgIGRlbCBvcy5lbnZpcm9uWydQWVRIT05QQVRIJ10KCiAgICAgICAgIyBjcmVhdGUgYSBwcmludGFibGUgdmVyc2lvbiBvZiB0aGUgY29tbWFuZCBmb3IgdXNlCiAgICAgICAgIyBpbiByZXBvcnRpbmcgbGF0ZXIsIHdoaWNoIHN0cmlwcyBvdXQgdGhpbmdzIGxpa2UKICAgICAgICAjIHBhc3N3b3JkcyBmcm9tIHRoZSBhcmdzIGxpc3QKICAgICAgICB0b19jbGVhbl9hcmdzID0gYXJncwogICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICAgICAgdG9fY2xlYW5fYXJncyA9IHRvX2J5dGVzKGFyZ3MpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgICAgICB0b19jbGVhbl9hcmdzID0gdG9fdGV4dChhcmdzKQogICAgICAgIGlmIGlzaW5zdGFuY2UoYXJncywgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICAgICAgdG9fY2xlYW5fYXJncyA9IHNobGV4LnNwbGl0KHRvX2NsZWFuX2FyZ3MpCgogICAgICAgIGNsZWFuX2FyZ3MgPSBbXQogICAgICAgIGlzX3Bhc3N3ZCA9IEZhbHNlCiAgICAgICAgZm9yIGFyZyBpbiB0b19jbGVhbl9hcmdzOgogICAgICAgICAgICBpZiBpc19wYXNzd2Q6CiAgICAgICAgICAgICAgICBpc19wYXNzd2QgPSBGYWxzZQogICAgICAgICAgICAgICAgY2xlYW5fYXJncy5hcHBlbmQoJyoqKioqKioqJykKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIFBBU1NXRF9BUkdfUkUubWF0Y2goYXJnKToKICAgICAgICAgICAgICAgIHNlcF9pZHggPSBhcmcuZmluZCgnPScpCiAgICAgICAgICAgICAgICBpZiBzZXBfaWR4ID4gLTE6CiAgICAgICAgICAgICAgICAgICAgY2xlYW5fYXJncy5hcHBlbmQoJyVzPSoqKioqKioqJyAlIGFyZ1s6c2VwX2lkeF0pCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaXNfcGFzc3dkID0gVHJ1ZQogICAgICAgICAgICBhcmcgPSBoZXVyaXN0aWNfbG9nX3Nhbml0aXplKGFyZywgc2VsZi5ub19sb2dfdmFsdWVzKQogICAgICAgICAgICBjbGVhbl9hcmdzLmFwcGVuZChhcmcpCiAgICAgICAgY2xlYW5fYXJncyA9ICcgJy5qb2luKHNobGV4X3F1b3RlKGFyZykgZm9yIGFyZyBpbiBjbGVhbl9hcmdzKQoKICAgICAgICBpZiBkYXRhOgogICAgICAgICAgICBzdF9pbiA9IHN1YnByb2Nlc3MuUElQRQoKICAgICAgICBrd2FyZ3MgPSBkaWN0KAogICAgICAgICAgICBleGVjdXRhYmxlPWV4ZWN1dGFibGUsCiAgICAgICAgICAgIHNoZWxsPXNoZWxsLAogICAgICAgICAgICBjbG9zZV9mZHM9Y2xvc2VfZmRzLAogICAgICAgICAgICBzdGRpbj1zdF9pbiwKICAgICAgICAgICAgc3Rkb3V0PXN1YnByb2Nlc3MuUElQRSwKICAgICAgICAgICAgc3RkZXJyPXN1YnByb2Nlc3MuUElQRSwKICAgICAgICApCgogICAgICAgICMgc3RvcmUgdGhlIHB3ZAogICAgICAgIHByZXZfZGlyID0gb3MuZ2V0Y3dkKCkKCiAgICAgICAgIyBtYWtlIHN1cmUgd2UncmUgaW4gdGhlIHJpZ2h0IHdvcmtpbmcgZGlyZWN0b3J5CiAgICAgICAgaWYgY3dkIGFuZCBvcy5wYXRoLmlzZGlyKGN3ZCk6CiAgICAgICAgICAgIGN3ZCA9IG9zLnBhdGguYWJzcGF0aChvcy5wYXRoLmV4cGFuZHVzZXIoY3dkKSkKICAgICAgICAgICAga3dhcmdzWydjd2QnXSA9IGN3ZAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5jaGRpcihjd2QpCiAgICAgICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihyYz1lLmVycm5vLCBtc2c9IkNvdWxkIG5vdCBvcGVuICVzLCAlcyIgJSAoY3dkLCBzdHIoZSkpKQoKICAgICAgICBvbGRfdW1hc2sgPSBOb25lCiAgICAgICAgaWYgdW1hc2s6CiAgICAgICAgICAgIG9sZF91bWFzayA9IG9zLnVtYXNrKHVtYXNrKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbGYuX2RlYnVnOgogICAgICAgICAgICAgICAgc2VsZi5sb2coJ0V4ZWN1dGluZzogJyArIGNsZWFuX2FyZ3MpCiAgICAgICAgICAgIGNtZCA9IHN1YnByb2Nlc3MuUG9wZW4oYXJncywgKiprd2FyZ3MpCgogICAgICAgICAgICAjIHRoZSBjb21tdW5pY2F0aW9uIGxvZ2ljIGhlcmUgaXMgZXNzZW50aWFsbHkgdGFrZW4gZnJvbSB0aGF0CiAgICAgICAgICAgICMgb2YgdGhlIF9jb21tdW5pY2F0ZSgpIGZ1bmN0aW9uIGluIHNzaC5weQoKICAgICAgICAgICAgc3Rkb3V0ID0gYignJykKICAgICAgICAgICAgc3RkZXJyID0gYignJykKICAgICAgICAgICAgcnBpcGVzID0gW2NtZC5zdGRvdXQsIGNtZC5zdGRlcnJdCgogICAgICAgICAgICBpZiBkYXRhOgogICAgICAgICAgICAgICAgaWYgbm90IGJpbmFyeV9kYXRhOgogICAgICAgICAgICAgICAgICAgIGRhdGEgKz0gJ1xuJwogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkYXRhLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICAgICAgICAgIGRhdGEgPSB0b19ieXRlcyhkYXRhKQogICAgICAgICAgICAgICAgY21kLnN0ZGluLndyaXRlKGRhdGEpCiAgICAgICAgICAgICAgICBjbWQuc3RkaW4uY2xvc2UoKQoKICAgICAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgICAgIHJmZHMsIHdmZHMsIGVmZHMgPSBzZWxlY3Quc2VsZWN0KHJwaXBlcywgW10sIHJwaXBlcywgMSkKICAgICAgICAgICAgICAgIHN0ZG91dCArPSBzZWxmLl9yZWFkX2Zyb21fcGlwZXMocnBpcGVzLCByZmRzLCBjbWQuc3Rkb3V0KQogICAgICAgICAgICAgICAgc3RkZXJyICs9IHNlbGYuX3JlYWRfZnJvbV9waXBlcyhycGlwZXMsIHJmZHMsIGNtZC5zdGRlcnIpCiAgICAgICAgICAgICAgICAjIGlmIHdlJ3JlIGNoZWNraW5nIGZvciBwcm9tcHRzLCBkbyBpdCBub3cKICAgICAgICAgICAgICAgIGlmIHByb21wdF9yZToKICAgICAgICAgICAgICAgICAgICBpZiBwcm9tcHRfcmUuc2VhcmNoKHN0ZG91dCkgYW5kIG5vdCBkYXRhOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBlbmNvZGluZzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dCA9IHRvX25hdGl2ZShzdGRvdXQsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Rkb3V0ID0gc3Rkb3V0CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoMjU3LCBzdGRvdXQsICJBIHByb21wdCB3YXMgZW5jb3VudGVyZWQgd2hpbGUgcnVubmluZyBhIGNvbW1hbmQsIGJ1dCBubyBpbnB1dCBkYXRhIHdhcyBzcGVjaWZpZWQiKQogICAgICAgICAgICAgICAgIyBvbmx5IGJyZWFrIG91dCBpZiBubyBwaXBlcyBhcmUgbGVmdCB0byByZWFkIG9yCiAgICAgICAgICAgICAgICAjIHRoZSBwaXBlcyBhcmUgY29tcGxldGVseSByZWFkIGFuZAogICAgICAgICAgICAgICAgIyB0aGUgcHJvY2VzcyBpcyB0ZXJtaW5hdGVkCiAgICAgICAgICAgICAgICBpZiAobm90IHJwaXBlcyBvciBub3QgcmZkcykgYW5kIGNtZC5wb2xsKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICMgTm8gcGlwZXMgYXJlIGxlZnQgdG8gcmVhZCBidXQgcHJvY2VzcyBpcyBub3QgeWV0IHRlcm1pbmF0ZWQKICAgICAgICAgICAgICAgICMgT25seSB0aGVuIGl0IGlzIHNhZmUgdG8gd2FpdCBmb3IgdGhlIHByb2Nlc3MgdG8gYmUgZmluaXNoZWQKICAgICAgICAgICAgICAgICMgTk9URTogQWN0dWFsbHkgY21kLnBvbGwoKSBpcyBhbHdheXMgTm9uZSBoZXJlIGlmIHJwaXBlcyBpcyBlbXB0eQogICAgICAgICAgICAgICAgZWxpZiBub3QgcnBpcGVzIGFuZCBjbWQucG9sbCgpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgY21kLndhaXQoKQogICAgICAgICAgICAgICAgICAgICMgVGhlIHByb2Nlc3MgaXMgdGVybWluYXRlZC4gU2luY2Ugbm8gcGlwZXMgdG8gcmVhZCBmcm9tIGFyZQogICAgICAgICAgICAgICAgICAgICMgbGVmdCwgdGhlcmUgaXMgbm8gbmVlZCB0byBjYWxsIHNlbGVjdCgpIGFnYWluLgogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBjbWQuc3Rkb3V0LmNsb3NlKCkKICAgICAgICAgICAgY21kLnN0ZGVyci5jbG9zZSgpCgogICAgICAgICAgICByYyA9IGNtZC5yZXR1cm5jb2RlCiAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLmxvZygiRXJyb3IgRXhlY3V0aW5nIENNRDolcyBFeGNlcHRpb246JXMiICUgKGNsZWFuX2FyZ3MsIHRvX25hdGl2ZShlKSkpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPWUuZXJybm8sIG1zZz10b19uYXRpdmUoZSksIGNtZD1jbGVhbl9hcmdzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5sb2coIkVycm9yIEV4ZWN1dGluZyBDTUQ6JXMgRXhjZXB0aW9uOiVzIiAlIChjbGVhbl9hcmdzLHRvX25hdGl2ZSh0cmFjZWJhY2suZm9ybWF0X2V4YygpKSkpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPTI1NywgbXNnPXRvX25hdGl2ZShlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCksIGNtZD1jbGVhbl9hcmdzKQoKICAgICAgICAjIFJlc3RvcmUgZW52IHNldHRpbmdzCiAgICAgICAgZm9yIGtleSwgdmFsIGluIG9sZF9lbnZfdmFscy5pdGVtcygpOgogICAgICAgICAgICBpZiB2YWwgaXMgTm9uZToKICAgICAgICAgICAgICAgIGRlbCBvcy5lbnZpcm9uW2tleV0KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9zLmVudmlyb25ba2V5XSA9IHZhbAoKICAgICAgICBpZiBvbGRfdW1hc2s6CiAgICAgICAgICAgIG9zLnVtYXNrKG9sZF91bWFzaykKCiAgICAgICAgaWYgcmMgIT0gMCBhbmQgY2hlY2tfcmM6CiAgICAgICAgICAgIG1zZyA9IGhldXJpc3RpY19sb2dfc2FuaXRpemUoc3RkZXJyLnJzdHJpcCgpLCBzZWxmLm5vX2xvZ192YWx1ZXMpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKGNtZD1jbGVhbl9hcmdzLCByYz1yYywgc3Rkb3V0PXN0ZG91dCwgc3RkZXJyPXN0ZGVyciwgbXNnPW1zZykKCiAgICAgICAgIyByZXNldCB0aGUgcHdkCiAgICAgICAgb3MuY2hkaXIocHJldl9kaXIpCgogICAgICAgIGlmIGVuY29kaW5nIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXR1cm4gKHJjLCB0b19uYXRpdmUoc3Rkb3V0LCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycyksCiAgICAgICAgICAgICAgICAgICAgdG9fbmF0aXZlKHN0ZGVyciwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpKQogICAgICAgIHJldHVybiAocmMsIHN0ZG91dCwgc3RkZXJyKQoKICAgIGRlZiBhcHBlbmRfdG9fZmlsZShzZWxmLCBmaWxlbmFtZSwgc3RyKToKICAgICAgICBmaWxlbmFtZSA9IG9zLnBhdGguZXhwYW5kdmFycyhvcy5wYXRoLmV4cGFuZHVzZXIoZmlsZW5hbWUpKQogICAgICAgIGZoID0gb3BlbihmaWxlbmFtZSwgJ2EnKQogICAgICAgIGZoLndyaXRlKHN0cikKICAgICAgICBmaC5jbG9zZSgpCgogICAgZGVmIGJ5dGVzX3RvX2h1bWFuKHNlbGYsIHNpemUpOgogICAgICAgIHJldHVybiBieXRlc190b19odW1hbihzaXplKQoKICAgICMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CiAgICBwcmV0dHlfYnl0ZXMgPSBieXRlc190b19odW1hbgoKICAgIGRlZiBodW1hbl90b19ieXRlcyhzZWxmLCBudW1iZXIsIGlzYml0cz1GYWxzZSk6CiAgICAgICAgcmV0dXJuIGh1bWFuX3RvX2J5dGVzKG51bWJlciwgaXNiaXRzKQoKICAgICMKICAgICMgQmFja3dhcmRzIGNvbXBhdAogICAgIwoKICAgICMgSW4gMi4wLCBtb3ZlZCBmcm9tIGluc2lkZSB0aGUgbW9kdWxlIHRvIHRoZSB0b3BsZXZlbAogICAgaXNfZXhlY3V0YWJsZSA9IGlzX2V4ZWN1dGFibGUKCgpkZWYgZ2V0X21vZHVsZV9wYXRoKCk6CiAgICByZXR1cm4gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGgucmVhbHBhdGgoX19maWxlX18pKQpQSwMEFAAAAAAAy7srSwAAAAAAAAAAAAAAACYAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9fX2luaXRfXy5weVBLAwQUAAAAAADLuytLRPQE7WkkAABpJAAAJwAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL2NvbGxlY3Rvci5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgpmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBkZWZhdWx0ZGljdAoKaW1wb3J0IHBsYXRmb3JtCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzIGltcG9ydCB0aW1lb3V0CgoKY2xhc3MgQmFzZUZhY3RDb2xsZWN0b3I6CiAgICBfZmFjdF9pZHMgPSBzZXQoKQoKICAgIF9wbGF0Zm9ybSA9ICdHZW5lcmljJwogICAgbmFtZSA9IE5vbmUKCiAgICBkZWYgX19pbml0X18oc2VsZiwgY29sbGVjdG9ycz1Ob25lLCBuYW1lc3BhY2U9Tm9uZSk6CiAgICAgICAgJycnQmFzZSBjbGFzcyBmb3IgdGhpbmdzIHRoYXQgY29sbGVjdCBmYWN0cy4KCiAgICAgICAgJ2NvbGxlY3RvcnMnIGlzIGFuIG9wdGlvbmFsIGxpc3Qgb2Ygb3RoZXIgRmFjdENvbGxlY3RvcnMgZm9yIGNvbXBvc2luZy4nJycKICAgICAgICBzZWxmLmNvbGxlY3RvcnMgPSBjb2xsZWN0b3JzIG9yIFtdCgogICAgICAgICMgc2VsZi5uYW1lc3BhY2UgaXMgYSBvYmplY3Qgd2l0aCBhICd0cmFuc2Zvcm0nIG1ldGhvZCB0aGF0IHRyYW5zZm9ybXMKICAgICAgICAjIHRoZSBuYW1lIHRvIGluZGljYXRlIHRoZSBuYW1lc3BhY2UgKGllLCBhZGRzIGEgcHJlZml4IG9yIHN1ZmZpeCkuCiAgICAgICAgc2VsZi5uYW1lc3BhY2UgPSBuYW1lc3BhY2UKCiAgICAgICAgc2VsZi5mYWN0X2lkcyA9IHNldChbc2VsZi5uYW1lXSkKICAgICAgICBzZWxmLmZhY3RfaWRzLnVwZGF0ZShzZWxmLl9mYWN0X2lkcykKCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBwbGF0Zm9ybV9tYXRjaChjbHMsIHBsYXRmb3JtX2luZm8pOgogICAgICAgIGlmIHBsYXRmb3JtX2luZm8uZ2V0KCdzeXN0ZW0nLCBOb25lKSA9PSBjbHMuX3BsYXRmb3JtOgogICAgICAgICAgICByZXR1cm4gY2xzCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgX3RyYW5zZm9ybV9uYW1lKHNlbGYsIGtleV9uYW1lKToKICAgICAgICBpZiBzZWxmLm5hbWVzcGFjZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYubmFtZXNwYWNlLnRyYW5zZm9ybShrZXlfbmFtZSkKICAgICAgICByZXR1cm4ga2V5X25hbWUKCiAgICBkZWYgX3RyYW5zZm9ybV9kaWN0X2tleXMoc2VsZiwgZmFjdF9kaWN0KToKICAgICAgICAnJyd1cGRhdGUgYSBkaWN0cyBrZXlzIHRvIHVzZSBuZXcgbmFtZXMgYXMgdHJhbnNmb3JtZWQgYnkgc2VsZi5fdHJhbnNmb3JtX25hbWUnJycKCiAgICAgICAgZm9yIG9sZF9rZXkgaW4gbGlzdChmYWN0X2RpY3Qua2V5cygpKToKICAgICAgICAgICAgbmV3X2tleSA9IHNlbGYuX3RyYW5zZm9ybV9uYW1lKG9sZF9rZXkpCiAgICAgICAgICAgICMgcG9wIHRoZSBpdGVtIGJ5IG9sZF9rZXkgYW5kIHJlcGxhY2UgaXQgdXNpbmcgbmV3X2tleQogICAgICAgICAgICBmYWN0X2RpY3RbbmV3X2tleV0gPSBmYWN0X2RpY3QucG9wKG9sZF9rZXkpCiAgICAgICAgcmV0dXJuIGZhY3RfZGljdAoKICAgICMgVE9ETy9NQVlCRTogcmVuYW1lIHRvICdjb2xsZWN0JyBhbmQgYWRkICdjb2xsZWN0X3dpdGhvdXRfbmFtZXNwYWNlJwogICAgZGVmIGNvbGxlY3Rfd2l0aF9uYW1lc3BhY2Uoc2VsZiwgbW9kdWxlPU5vbmUsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICAjIGNvbGxlY3QsIHRoZW4gdHJhbnNmb3JtIHRoZSBrZXkgbmFtZXMgaWYgbmVlZGVkCiAgICAgICAgZmFjdHNfZGljdCA9IHNlbGYuY29sbGVjdChtb2R1bGU9bW9kdWxlLCBjb2xsZWN0ZWRfZmFjdHM9Y29sbGVjdGVkX2ZhY3RzKQogICAgICAgIGlmIHNlbGYubmFtZXNwYWNlOgogICAgICAgICAgICBmYWN0c19kaWN0ID0gc2VsZi5fdHJhbnNmb3JtX2RpY3Rfa2V5cyhmYWN0c19kaWN0KQogICAgICAgIHJldHVybiBmYWN0c19kaWN0CgogICAgZGVmIGNvbGxlY3Qoc2VsZiwgbW9kdWxlPU5vbmUsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICAnJydkbyB0aGUgZmFjdCBjb2xsZWN0aW9uCgogICAgICAgICdjb2xsZWN0ZWRfZmFjdHMnIGlzIGEgb2JqZWN0IChhIGRpY3QsIGxpa2VseSkgdGhhdCBob2xkcyBhbGwgcHJldmlvdXNseQogICAgICAgICAgZmFjdHMuIFRoaXMgaXMgaW50ZW5kZWQgdG8gYmUgdXNlZCBpZiBhIEZhY3RDb2xsZWN0b3IgbmVlZHMgdG8gcmVmZXJlbmNlCiAgICAgICAgICBhbm90aGVyIGZhY3QgKGZvciBleCwgdGhlIHN5c3RlbSBhcmNoKSBhbmQgc2hvdWxkIG5vdCBiZSBtb2RpZmllZCAodXN1YWxseSkuCgogICAgICAgICAgUmV0dXJucyBhIGRpY3Qgb2YgZmFjdHMuCgogICAgICAgICAgJycnCiAgICAgICAgZmFjdHNfZGljdCA9IHt9CiAgICAgICAgcmV0dXJuIGZhY3RzX2RpY3QKCgpkZWYgZ2V0X2NvbGxlY3Rvcl9uYW1lcyh2YWxpZF9zdWJzZXRzPU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG1pbmltYWxfZ2F0aGVyX3N1YnNldD1Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICBnYXRoZXJfc3Vic2V0PU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGFsaWFzZXNfbWFwPU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXRmb3JtX2luZm89Tm9uZSk6CiAgICAnJydyZXR1cm4gYSBzZXQgb2YgRmFjdENvbGxlY3RvciBuYW1lcyBiYXNlZCBvbiBnYXRoZXJfc3Vic2V0IHNwZWMuCgogICAgZ2F0aGVyX3N1YnNldCBpcyBhIHNwZWMgZGVzY3JpYmluZyB3aGljaCBmYWN0cyB0byBnYXRoZXIuCiAgICB2YWxpZF9zdWJzZXRzIGlzIGEgZnJvemVuc2V0IG9mIHBvdGVudGlhbCBtYXRjaGVzIGZvciBnYXRoZXJfc3Vic2V0ICgnYWxsJywgJ25ldHdvcmsnKSBldGMKICAgIG1pbmltYWxfZ2F0aGVyX3N1YnNldHMgaXMgYSBmcm96ZW5zZXQgb2YgbWF0Y2hlcyB0byBhbHdheXMgdXNlLCBldmVuIGZvciBnYXRoZXJfc3Vic2V0PSchYWxsJwogICAgJycnCgogICAgIyBSZXRyaWV2ZSBtb2R1bGUgcGFyYW1ldGVycwogICAgZ2F0aGVyX3N1YnNldCA9IGdhdGhlcl9zdWJzZXQgb3IgWydhbGwnXQoKICAgICMgdGhlIGxpc3Qgb2YgZXZlcnl0aGluZyB0aGF0ICdhbGwnIGV4cGFuZHMgdG8KICAgIHZhbGlkX3N1YnNldHMgPSB2YWxpZF9zdWJzZXRzIG9yIGZyb3plbnNldCgpCgogICAgIyBpZiBwcm92aWRlZCwgbWluaW1hbF9nYXRoZXJfc3Vic2V0IGlzIGFsd2F5cyBhZGRlZCwgZXZlbiBhZnRlciBhbGwgbmVnYXRpb25zCiAgICBtaW5pbWFsX2dhdGhlcl9zdWJzZXQgPSBtaW5pbWFsX2dhdGhlcl9zdWJzZXQgb3IgZnJvemVuc2V0KCkKCiAgICBhbGlhc2VzX21hcCA9IGFsaWFzZXNfbWFwIG9yIGRlZmF1bHRkaWN0KHNldCkKCiAgICAjIFJldHJpZXZlIGFsbCBmYWN0cyBlbGVtZW50cwogICAgYWRkaXRpb25hbF9zdWJzZXRzID0gc2V0KCkKICAgIGV4Y2x1ZGVfc3Vic2V0cyA9IHNldCgpCgogICAgZm9yIHN1YnNldCBpbiBnYXRoZXJfc3Vic2V0OgogICAgICAgIHN1YnNldF9pZCA9IHN1YnNldAoKICAgICAgICBpZiBzdWJzZXRfaWQgPT0gJ2FsbCc6CiAgICAgICAgICAgIGFkZGl0aW9uYWxfc3Vic2V0cy51cGRhdGUodmFsaWRfc3Vic2V0cykKICAgICAgICAgICAgY29udGludWUKICAgICAgICBpZiBzdWJzZXRfaWQuc3RhcnRzd2l0aCgnIScpOgogICAgICAgICAgICBzdWJzZXQgPSBzdWJzZXRbMTpdCiAgICAgICAgICAgIGlmIHN1YnNldCA9PSAnYWxsJzoKICAgICAgICAgICAgICAgIGV4Y2x1ZGVfc3Vic2V0cy51cGRhdGUodmFsaWRfc3Vic2V0cykKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGV4Y2x1ZGUgPSBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZXhjbHVkZSA9IEZhbHNlCgogICAgICAgIGlmIGV4Y2x1ZGU6CiAgICAgICAgICAgICMgaW5jbHVkZSAnZGV2aWNlcycsICdkbWknIGV0YyBmb3IgJyFoYXJkd2FyZScKICAgICAgICAgICAgZXhjbHVkZV9zdWJzZXRzLnVwZGF0ZShhbGlhc2VzX21hcC5nZXQoc3Vic2V0LCBzZXQoKSkpCiAgICAgICAgICAgIGV4Y2x1ZGVfc3Vic2V0cy5hZGQoc3Vic2V0KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgTk9URTogdGhpcyBvbmx5IGNvbnNpZGVycyBhZGRpbmcgYW4gdW5rbm93biBnYXRoZXIgc3Vic2V0dXAgYW4gZXJyb3IuIEFza2luZyB0bwogICAgICAgICAgICAjICAgICAgIGV4Y2x1ZGUgYW4gdW5rbm93biBnYXRoZXIgc3Vic2V0IGlzIGlnbm9yZWQuCiAgICAgICAgICAgIGlmIHN1YnNldF9pZCBub3QgaW4gdmFsaWRfc3Vic2V0czoKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiQmFkIHN1YnNldCAnJXMnIGdpdmVuIHRvIEFuc2libGUuIGdhdGhlcl9zdWJzZXQgb3B0aW9ucyBhbGxvd2VkOiBhbGwsICVzIiAlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHN1YnNldCwgIiwgIi5qb2luKHNvcnRlZCh2YWxpZF9zdWJzZXRzKSkpKQoKICAgICAgICAgICAgYWRkaXRpb25hbF9zdWJzZXRzLmFkZChzdWJzZXQpCgogICAgaWYgbm90IGFkZGl0aW9uYWxfc3Vic2V0czoKICAgICAgICBhZGRpdGlvbmFsX3N1YnNldHMudXBkYXRlKHZhbGlkX3N1YnNldHMpCgogICAgYWRkaXRpb25hbF9zdWJzZXRzLmRpZmZlcmVuY2VfdXBkYXRlKGV4Y2x1ZGVfc3Vic2V0cykKCiAgICBhZGRpdGlvbmFsX3N1YnNldHMudXBkYXRlKG1pbmltYWxfZ2F0aGVyX3N1YnNldCkKCiAgICByZXR1cm4gYWRkaXRpb25hbF9zdWJzZXRzCgoKZGVmIGZpbmRfY29sbGVjdG9yc19mb3JfcGxhdGZvcm0oYWxsX2NvbGxlY3Rvcl9jbGFzc2VzLCBjb21wYXRfcGxhdGZvcm1zKToKICAgIGZvdW5kX2NvbGxlY3RvcnMgPSBzZXQoKQogICAgZm91bmRfY29sbGVjdG9yc19uYW1lcyA9IHNldCgpCgogICAgIyBzdGFydCBmcm9tIHNwZWNpZmljIHBsYXRmb3JtLCB0aGVuIHRyeSBnZW5lcmljCiAgICBmb3IgY29tcGF0X3BsYXRmb3JtIGluIGNvbXBhdF9wbGF0Zm9ybXM6CiAgICAgICAgcGxhdGZvcm1fbWF0Y2ggPSBOb25lCiAgICAgICAgZm9yIGFsbF9jb2xsZWN0b3JfY2xhc3MgaW4gYWxsX2NvbGxlY3Rvcl9jbGFzc2VzOgoKICAgICAgICAgICAgIyBhc2sgdGhlIGNsYXNzIGlmIGl0IGlzIGNvbXBhdGlibGUgd2l0aCB0aGUgcGxhdGZvcm0gaW5mbwogICAgICAgICAgICBwbGF0Zm9ybV9tYXRjaCA9IGFsbF9jb2xsZWN0b3JfY2xhc3MucGxhdGZvcm1fbWF0Y2goY29tcGF0X3BsYXRmb3JtKQoKICAgICAgICAgICAgaWYgbm90IHBsYXRmb3JtX21hdGNoOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIHByaW1hcnlfbmFtZSA9IGFsbF9jb2xsZWN0b3JfY2xhc3MubmFtZQoKICAgICAgICAgICAgaWYgcHJpbWFyeV9uYW1lIG5vdCBpbiBmb3VuZF9jb2xsZWN0b3JzX25hbWVzOgogICAgICAgICAgICAgICAgZm91bmRfY29sbGVjdG9ycy5hZGQoYWxsX2NvbGxlY3Rvcl9jbGFzcykKICAgICAgICAgICAgICAgIGZvdW5kX2NvbGxlY3RvcnNfbmFtZXMuYWRkKGFsbF9jb2xsZWN0b3JfY2xhc3MubmFtZSkKCiAgICByZXR1cm4gZm91bmRfY29sbGVjdG9ycwoKCmRlZiBidWlsZF9mYWN0X2lkX3RvX2NvbGxlY3Rvcl9tYXAoY29sbGVjdG9yc19mb3JfcGxhdGZvcm0pOgogICAgZmFjdF9pZF90b19jb2xsZWN0b3JfbWFwID0gZGVmYXVsdGRpY3QobGlzdCkKICAgIGFsaWFzZXNfbWFwID0gZGVmYXVsdGRpY3Qoc2V0KQoKICAgIGZvciBjb2xsZWN0b3JfY2xhc3MgaW4gY29sbGVjdG9yc19mb3JfcGxhdGZvcm06CiAgICAgICAgcHJpbWFyeV9uYW1lID0gY29sbGVjdG9yX2NsYXNzLm5hbWUKCiAgICAgICAgZmFjdF9pZF90b19jb2xsZWN0b3JfbWFwW3ByaW1hcnlfbmFtZV0uYXBwZW5kKGNvbGxlY3Rvcl9jbGFzcykKCiAgICAgICAgZm9yIGZhY3RfaWQgaW4gY29sbGVjdG9yX2NsYXNzLl9mYWN0X2lkczoKICAgICAgICAgICAgZmFjdF9pZF90b19jb2xsZWN0b3JfbWFwW2ZhY3RfaWRdLmFwcGVuZChjb2xsZWN0b3JfY2xhc3MpCiAgICAgICAgICAgIGFsaWFzZXNfbWFwW3ByaW1hcnlfbmFtZV0uYWRkKGZhY3RfaWQpCgogICAgcmV0dXJuIGZhY3RfaWRfdG9fY29sbGVjdG9yX21hcCwgYWxpYXNlc19tYXAKCgpkZWYgY29sbGVjdG9yX2NsYXNzZXNfZnJvbV9nYXRoZXJfc3Vic2V0KGFsbF9jb2xsZWN0b3JfY2xhc3Nlcz1Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkX3N1YnNldHM9Tm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5pbWFsX2dhdGhlcl9zdWJzZXQ9Tm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXRoZXJfc3Vic2V0PU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2F0aGVyX3RpbWVvdXQ9Tm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGF0Zm9ybV9pbmZvPU5vbmUpOgogICAgJycncmV0dXJuIGEgbGlzdCBvZiBjb2xsZWN0b3IgY2xhc3NlcyB0aGF0IG1hdGNoIHRoZSBhcmdzJycnCgogICAgIyB1c2UgZ2F0aGVyX25hbWUgZXRjIHRvIGdldCB0aGUgbGlzdCBvZiBjb2xsZWN0b3JzCgogICAgYWxsX2NvbGxlY3Rvcl9jbGFzc2VzID0gYWxsX2NvbGxlY3Rvcl9jbGFzc2VzIG9yIFtdCgogICAgbWluaW1hbF9nYXRoZXJfc3Vic2V0ID0gbWluaW1hbF9nYXRoZXJfc3Vic2V0IG9yIGZyb3plbnNldCgpCgogICAgcGxhdGZvcm1faW5mbyA9IHBsYXRmb3JtX2luZm8gb3IgeydzeXN0ZW0nOiBwbGF0Zm9ybS5zeXN0ZW0oKX0KCiAgICBnYXRoZXJfdGltZW91dCA9IGdhdGhlcl90aW1lb3V0IG9yIHRpbWVvdXQuREVGQVVMVF9HQVRIRVJfVElNRU9VVAoKICAgICMgdHdlYWsgdGhlIG1vZHVsZXMgR0FUSEVSX1RJTUVPVVQKICAgIHRpbWVvdXQuR0FUSEVSX1RJTUVPVVQgPSBnYXRoZXJfdGltZW91dAoKICAgIHZhbGlkX3N1YnNldHMgPSB2YWxpZF9zdWJzZXRzIG9yIGZyb3plbnNldCgpCgogICAgIyBtYXBzIGFsaWFzIG5hbWVzIGxpa2UgJ2hhcmR3YXJlJyB0byB0aGUgbGlzdCBvZiBuYW1lcyB0aGF0IGFyZSBwYXJ0IG9mIGhhcmR3YXJlCiAgICAjIGxpa2UgJ2RldmljZXMnIGFuZCAnZG1pJwogICAgYWxpYXNlc19tYXAgPSBkZWZhdWx0ZGljdChzZXQpCgogICAgY29tcGF0X3BsYXRmb3JtcyA9IFtwbGF0Zm9ybV9pbmZvLCB7J3N5c3RlbSc6ICdHZW5lcmljJ31dCgogICAgY29sbGVjdG9yc19mb3JfcGxhdGZvcm0gPSBmaW5kX2NvbGxlY3RvcnNfZm9yX3BsYXRmb3JtKGFsbF9jb2xsZWN0b3JfY2xhc3NlcywgY29tcGF0X3BsYXRmb3JtcykKCiAgICAjIGFsbF9mYWN0c19zdWJzZXRzIG1hcHMgdGhlIHN1YnNldCBuYW1lICgnaGFyZHdhcmUnKSB0byB0aGUgY2xhc3MgdGhhdCBwcm92aWRlcyBpdC4KCiAgICAjIFRPRE86IG5hbWUgY29sbGlzaW9ucyBoZXJlPyBhcmUgdGhlcmUgZmFjdHMgd2l0aCB0aGUgc2FtZSBuYW1lIGFzIGEgZ2F0aGVyX3N1YnNldCAoYWxsLCBuZXR3b3JrLCBoYXJkd2FyZSwgdmlydHVhbCwgb2hhaSwgZmFjdGVyKQogICAgYWxsX2ZhY3Rfc3Vic2V0cywgYWxpYXNlc19tYXAgPSBidWlsZF9mYWN0X2lkX3RvX2NvbGxlY3Rvcl9tYXAoY29sbGVjdG9yc19mb3JfcGxhdGZvcm0pCgogICAgYWxsX3ZhbGlkX3N1YnNldHMgPSBmcm96ZW5zZXQoYWxsX2ZhY3Rfc3Vic2V0cy5rZXlzKCkpCgogICAgIyBleHBhbmQgYW55IGZhY3RfaWQvY29sbGVjdG9ybmFtZS9nYXRoZXJfc3Vic2V0IHRlcm0gKCdhbGwnLCAnZW52JywgZXRjKSB0byB0aGUgbGlzdCBvZiBuYW1lcyB0aGF0IHJlcHJlc2VudHMKICAgIGNvbGxlY3Rvcl9uYW1lcyA9IGdldF9jb2xsZWN0b3JfbmFtZXModmFsaWRfc3Vic2V0cz1hbGxfdmFsaWRfc3Vic2V0cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluaW1hbF9nYXRoZXJfc3Vic2V0PW1pbmltYWxfZ2F0aGVyX3N1YnNldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2F0aGVyX3N1YnNldD1nYXRoZXJfc3Vic2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlhc2VzX21hcD1hbGlhc2VzX21hcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxhdGZvcm1faW5mbz1wbGF0Zm9ybV9pbmZvKQoKICAgICMgVE9ETzogY2FuIGJlIGEgc2V0KCkKICAgIHNlZW5fY29sbGVjdG9yX2NsYXNzZXMgPSBbXQoKICAgIHNlbGVjdGVkX2NvbGxlY3Rvcl9jbGFzc2VzID0gW10KCiAgICBmb3IgY29sbGVjdG9yX25hbWUgaW4gY29sbGVjdG9yX25hbWVzOgogICAgICAgIGNvbGxlY3Rvcl9jbGFzc2VzID0gYWxsX2ZhY3Rfc3Vic2V0cy5nZXQoY29sbGVjdG9yX25hbWUsIFtdKQoKICAgICAgICAjIFRPRE8/IGxvZy93YXJuIGlmIHdlIGRvbnQgZmluZCBhbiBpbXBsZW1lbnRhdGlvbiBvZiBhIGZhY3RfaWQ/CgogICAgICAgIGZvciBjb2xsZWN0b3JfY2xhc3MgaW4gY29sbGVjdG9yX2NsYXNzZXM6CiAgICAgICAgICAgIGlmIGNvbGxlY3Rvcl9jbGFzcyBub3QgaW4gc2Vlbl9jb2xsZWN0b3JfY2xhc3NlczoKICAgICAgICAgICAgICAgIHNlbGVjdGVkX2NvbGxlY3Rvcl9jbGFzc2VzLmFwcGVuZChjb2xsZWN0b3JfY2xhc3MpCiAgICAgICAgICAgICAgICBzZWVuX2NvbGxlY3Rvcl9jbGFzc2VzLmFwcGVuZChjb2xsZWN0b3JfY2xhc3MpCgogICAgcmV0dXJuIHNlbGVjdGVkX2NvbGxlY3Rvcl9jbGFzc2VzClBLAwQUAAAAAADLuytL0x1fnWEFAABhBQAAJwAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL25hbWVzcGFjZS5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgoKY2xhc3MgRmFjdE5hbWVzcGFjZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuYW1lc3BhY2VfbmFtZSk6CiAgICAgICAgc2VsZi5uYW1lc3BhY2VfbmFtZSA9IG5hbWVzcGFjZV9uYW1lCgogICAgZGVmIHRyYW5zZm9ybShzZWxmLCBuYW1lKToKICAgICAgICAnJydUYWtlIGEgdGV4dCBuYW1lLCBhbmQgdHJhbnNmb3JtcyBpdCBhcyBuZWVkZWQgKGFkZCBhIG5hbWVzcGFjZSBwcmVmaXgsIGV0YyknJycKICAgICAgICByZXR1cm4gbmFtZQoKICAgIGRlZiBfdW5kZXJzY29yZShzZWxmLCBuYW1lKToKICAgICAgICByZXR1cm4gbmFtZS5yZXBsYWNlKCctJywgJ18nKQoKCmNsYXNzIFByZWZpeEZhY3ROYW1lc3BhY2UoRmFjdE5hbWVzcGFjZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZXNwYWNlX25hbWUsIHByZWZpeD1Ob25lKToKICAgICAgICBzdXBlcihQcmVmaXhGYWN0TmFtZXNwYWNlLCBzZWxmKS5fX2luaXRfXyhuYW1lc3BhY2VfbmFtZSkKICAgICAgICBzZWxmLnByZWZpeCA9IHByZWZpeAoKICAgIGRlZiB0cmFuc2Zvcm0oc2VsZiwgbmFtZSk6CiAgICAgICAgbmV3X25hbWUgPSBzZWxmLl91bmRlcnNjb3JlKG5hbWUpCiAgICAgICAgcmV0dXJuICclcyVzJyAlIChzZWxmLnByZWZpeCwgbmV3X25hbWUpClBLAwQUAAAAAADLuytLe636zqkYAACpGAAAMAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL2RlZmF1bHRfY29sbGVjdG9ycy5weSMKIyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLm90aGVyLmZhY3RlciBpbXBvcnQgRmFjdGVyRmFjdENvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLm90aGVyLm9oYWkgaW1wb3J0IE9oYWlGYWN0Q29sbGVjdG9yCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnN5c3RlbS5hcHBhcm1vciBpbXBvcnQgQXBwYXJtb3JGYWN0Q29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuc3lzdGVtLmNhcHMgaW1wb3J0IFN5c3RlbUNhcGFiaWxpdGllc0ZhY3RDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5zeXN0ZW0uY21kbGluZSBpbXBvcnQgQ21kTGluZUZhY3RDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5zeXN0ZW0uZGlzdHJpYnV0aW9uIGltcG9ydCBEaXN0cmlidXRpb25GYWN0Q29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuc3lzdGVtLmRhdGVfdGltZSBpbXBvcnQgRGF0ZVRpbWVGYWN0Q29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuc3lzdGVtLmVudiBpbXBvcnQgRW52RmFjdENvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnN5c3RlbS5kbnMgaW1wb3J0IERuc0ZhY3RDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5zeXN0ZW0uZmlwcyBpbXBvcnQgRmlwc0ZhY3RDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5zeXN0ZW0ubG9jYWwgaW1wb3J0IExvY2FsRmFjdENvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnN5c3RlbS5sc2IgaW1wb3J0IExTQkZhY3RDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5zeXN0ZW0ucGtnX21nciBpbXBvcnQgUGtnTWdyRmFjdENvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnN5c3RlbS5wbGF0Zm9ybSBpbXBvcnQgUGxhdGZvcm1GYWN0Q29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuc3lzdGVtLnB5dGhvbiBpbXBvcnQgUHl0aG9uRmFjdENvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnN5c3RlbS5zZWxpbnV4IGltcG9ydCBTZWxpbnV4RmFjdENvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnN5c3RlbS5zZXJ2aWNlX21nciBpbXBvcnQgU2VydmljZU1nckZhY3RDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5zeXN0ZW0uc3NoX3B1Yl9rZXlzIGltcG9ydCBTc2hQdWJLZXlGYWN0Q29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuc3lzdGVtLnVzZXIgaW1wb3J0IFVzZXJGYWN0Q29sbGVjdG9yCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmhhcmR3YXJlLmJhc2UgaW1wb3J0IEhhcmR3YXJlQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUuYWl4IGltcG9ydCBBSVhIYXJkd2FyZUNvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmhhcmR3YXJlLmRhcndpbiBpbXBvcnQgRGFyd2luSGFyZHdhcmVDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5oYXJkd2FyZS5kcmFnb25mbHkgaW1wb3J0IERyYWdvbkZseUhhcmR3YXJlQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUuZnJlZWJzZCBpbXBvcnQgRnJlZUJTREhhcmR3YXJlQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUuaHB1eCBpbXBvcnQgSFBVWEhhcmR3YXJlQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUuaHVyZCBpbXBvcnQgSHVyZEhhcmR3YXJlQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUubGludXggaW1wb3J0IExpbnV4SGFyZHdhcmVDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5oYXJkd2FyZS5uZXRic2QgaW1wb3J0IE5ldEJTREhhcmR3YXJlQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUub3BlbmJzZCBpbXBvcnQgT3BlbkJTREhhcmR3YXJlQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUuc3Vub3MgaW1wb3J0IFN1bk9TSGFyZHdhcmVDb2xsZWN0b3IKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5iYXNlIGltcG9ydCBOZXR3b3JrQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5haXggaW1wb3J0IEFJWE5ldHdvcmtDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5uZXR3b3JrLmRhcndpbiBpbXBvcnQgRGFyd2luTmV0d29ya0NvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLm5ldHdvcmsuZHJhZ29uZmx5IGltcG9ydCBEcmFnb25GbHlOZXR3b3JrQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5mcmVlYnNkIGltcG9ydCBGcmVlQlNETmV0d29ya0NvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLm5ldHdvcmsuaHB1eCBpbXBvcnQgSFBVWE5ldHdvcmtDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5uZXR3b3JrLmh1cmQgaW1wb3J0IEh1cmROZXR3b3JrQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5saW51eCBpbXBvcnQgTGludXhOZXR3b3JrQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5uZXRic2QgaW1wb3J0IE5ldEJTRE5ldHdvcmtDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5uZXR3b3JrLm9wZW5ic2QgaW1wb3J0IE9wZW5CU0ROZXR3b3JrQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5zdW5vcyBpbXBvcnQgU3VuT1NOZXR3b3JrQ29sbGVjdG9yCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnZpcnR1YWwuYmFzZSBpbXBvcnQgVmlydHVhbENvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnZpcnR1YWwuZHJhZ29uZmx5IGltcG9ydCBEcmFnb25GbHlWaXJ0dWFsQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMudmlydHVhbC5mcmVlYnNkIGltcG9ydCBGcmVlQlNEVmlydHVhbENvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnZpcnR1YWwuaHB1eCBpbXBvcnQgSFBVWFZpcnR1YWxDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy52aXJ0dWFsLmxpbnV4IGltcG9ydCBMaW51eFZpcnR1YWxDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy52aXJ0dWFsLm5ldGJzZCBpbXBvcnQgTmV0QlNEVmlydHVhbENvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnZpcnR1YWwub3BlbmJzZCBpbXBvcnQgT3BlbkJTRFZpcnR1YWxDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy52aXJ0dWFsLnN1bm9zIGltcG9ydCBTdW5PU1ZpcnR1YWxDb2xsZWN0b3IKCiMgVE9ETzogbWFrZSBjb25maWcgZHJpdmVuCmNvbGxlY3RvcnMgPSBbQXBwYXJtb3JGYWN0Q29sbGVjdG9yLAogICAgICAgICAgICAgIENtZExpbmVGYWN0Q29sbGVjdG9yLAogICAgICAgICAgICAgIERhdGVUaW1lRmFjdENvbGxlY3RvciwKICAgICAgICAgICAgICBEaXN0cmlidXRpb25GYWN0Q29sbGVjdG9yLAogICAgICAgICAgICAgIERuc0ZhY3RDb2xsZWN0b3IsCiAgICAgICAgICAgICAgRW52RmFjdENvbGxlY3RvciwKICAgICAgICAgICAgICBGaXBzRmFjdENvbGxlY3RvciwKCiAgICAgICAgICAgICAgSGFyZHdhcmVDb2xsZWN0b3IsCiAgICAgICAgICAgICAgQUlYSGFyZHdhcmVDb2xsZWN0b3IsCiAgICAgICAgICAgICAgRGFyd2luSGFyZHdhcmVDb2xsZWN0b3IsCiAgICAgICAgICAgICAgRHJhZ29uRmx5SGFyZHdhcmVDb2xsZWN0b3IsCiAgICAgICAgICAgICAgRnJlZUJTREhhcmR3YXJlQ29sbGVjdG9yLAogICAgICAgICAgICAgIEhQVVhIYXJkd2FyZUNvbGxlY3RvciwKICAgICAgICAgICAgICBIdXJkSGFyZHdhcmVDb2xsZWN0b3IsCiAgICAgICAgICAgICAgTGludXhIYXJkd2FyZUNvbGxlY3RvciwKICAgICAgICAgICAgICBOZXRCU0RIYXJkd2FyZUNvbGxlY3RvciwKICAgICAgICAgICAgICBPcGVuQlNESGFyZHdhcmVDb2xsZWN0b3IsCiAgICAgICAgICAgICAgU3VuT1NIYXJkd2FyZUNvbGxlY3RvciwKICAgICAgICAgICAgICBMb2NhbEZhY3RDb2xsZWN0b3IsCiAgICAgICAgICAgICAgTFNCRmFjdENvbGxlY3RvciwKCiAgICAgICAgICAgICAgTmV0d29ya0NvbGxlY3RvciwKICAgICAgICAgICAgICBBSVhOZXR3b3JrQ29sbGVjdG9yLAogICAgICAgICAgICAgIERhcndpbk5ldHdvcmtDb2xsZWN0b3IsCiAgICAgICAgICAgICAgRHJhZ29uRmx5TmV0d29ya0NvbGxlY3RvciwKICAgICAgICAgICAgICBGcmVlQlNETmV0d29ya0NvbGxlY3RvciwKICAgICAgICAgICAgICBIUFVYTmV0d29ya0NvbGxlY3RvciwKICAgICAgICAgICAgICBIdXJkTmV0d29ya0NvbGxlY3RvciwKICAgICAgICAgICAgICBMaW51eE5ldHdvcmtDb2xsZWN0b3IsCiAgICAgICAgICAgICAgTmV0QlNETmV0d29ya0NvbGxlY3RvciwKICAgICAgICAgICAgICBPcGVuQlNETmV0d29ya0NvbGxlY3RvciwKICAgICAgICAgICAgICBTdW5PU05ldHdvcmtDb2xsZWN0b3IsCgogICAgICAgICAgICAgIFBrZ01nckZhY3RDb2xsZWN0b3IsCiAgICAgICAgICAgICAgUGxhdGZvcm1GYWN0Q29sbGVjdG9yLAogICAgICAgICAgICAgIFB5dGhvbkZhY3RDb2xsZWN0b3IsCiAgICAgICAgICAgICAgU2VsaW51eEZhY3RDb2xsZWN0b3IsCiAgICAgICAgICAgICAgU2VydmljZU1nckZhY3RDb2xsZWN0b3IsCiAgICAgICAgICAgICAgU3NoUHViS2V5RmFjdENvbGxlY3RvciwKICAgICAgICAgICAgICBTeXN0ZW1DYXBhYmlsaXRpZXNGYWN0Q29sbGVjdG9yLAogICAgICAgICAgICAgIFVzZXJGYWN0Q29sbGVjdG9yLAoKICAgICAgICAgICAgICBWaXJ0dWFsQ29sbGVjdG9yLAogICAgICAgICAgICAgIERyYWdvbkZseVZpcnR1YWxDb2xsZWN0b3IsCiAgICAgICAgICAgICAgRnJlZUJTRFZpcnR1YWxDb2xsZWN0b3IsCiAgICAgICAgICAgICAgTGludXhWaXJ0dWFsQ29sbGVjdG9yLAogICAgICAgICAgICAgIE9wZW5CU0RWaXJ0dWFsQ29sbGVjdG9yLAogICAgICAgICAgICAgIE5ldEJTRFZpcnR1YWxDb2xsZWN0b3IsCiAgICAgICAgICAgICAgU3VuT1NWaXJ0dWFsQ29sbGVjdG9yLAogICAgICAgICAgICAgIEhQVVhWaXJ0dWFsQ29sbGVjdG9yXQoKZXh0ZXJuYWxfY29sbGVjdG9ycyA9IFtGYWN0ZXJGYWN0Q29sbGVjdG9yLAogICAgICAgICAgICAgICAgICAgICAgIE9oYWlGYWN0Q29sbGVjdG9yXQpQSwMEFAAAAAAAy7srS7XYBAYlMAAAJTAAAB0AAABhbnNpYmxlL21vZHVsZV91dGlscy9fdGV4dC5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpLCBUb3NoaW8gS3VyYXRvbWkgPGEuYmFkZ2VyQGdtYWlsLmNvbT4sIDIwMTYKIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dCBtb2RpZmljYXRpb24sCiMgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAojICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5ECiMgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRUQKIyBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuCiMgSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsCiMgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLAojIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUwojIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QKIyBMSUFCSUxJVFksIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUKIyBVU0UgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwoKIiIiCi4uIHdhcm46OiBUaGlzIG1vZHVsZV91dGlsIGlzIGN1cnJlbnRseSBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbi4KICAgIFdlIHdhbnQgdG8gZXZhbHVhdGUgdGhpcyBjb2RlIGZvciBzdGFiaWxpdHkgYW5kIEFQSSBzdWl0YWJpbGl0eSBiZWZvcmUKICAgIG1ha2luZyBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBndWFyYW50ZWVzLiAgVGhlIEFQSSBtYXkgY2hhbmdlIGJldHdlZW4KICAgIHJlbGVhc2VzLiAgRG8gbm90IHVzZSB0aGlzIHVubGVzcyB5b3UgYXJlIHdpbGxpbmcgdG8gcG9ydCB5b3VyIG1vZHVsZSBjb2RlLgoiIiIKaW1wb3J0IGNvZGVjcwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IFBZMywgdGV4dF90eXBlLCBiaW5hcnlfdHlwZQoKCnRyeToKICAgIGNvZGVjcy5sb29rdXBfZXJyb3IoJ3N1cnJvZ2F0ZWVzY2FwZScpCiAgICBIQVNfU1VSUk9HQVRFRVNDQVBFID0gVHJ1ZQpleGNlcHQgTG9va3VwRXJyb3I6CiAgICBIQVNfU1VSUk9HQVRFRVNDQVBFID0gRmFsc2UKCgpfQ09NUE9TRURfRVJST1JfSEFORExFUlMgPSBmcm96ZW5zZXQoKE5vbmUsICdzdXJyb2dhdGVfb3JfZXNjYXBlJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdXJyb2dhdGVfb3Jfc3RyaWN0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykpCgoKZGVmIHRvX2J5dGVzKG9iaiwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPU5vbmUsIG5vbnN0cmluZz0nc2ltcGxlcmVwcicpOgogICAgIiIiTWFrZSBzdXJlIHRoYXQgYSBzdHJpbmcgaXMgYSBieXRlIHN0cmluZwoKICAgIDphcmcgb2JqOiBBbiBvYmplY3QgdG8gbWFrZSBzdXJlIGlzIGEgYnl0ZSBzdHJpbmcuICBJbiBtb3N0IGNhc2VzIHRoaXMKICAgICAgICB3aWxsIGJlIGVpdGhlciBhIHRleHQgc3RyaW5nIG9yIGEgYnl0ZSBzdHJpbmcuICBIb3dldmVyLCB3aXRoCiAgICAgICAgYGBub25zdHJpbmc9J3NpbXBsZXJlcHInYGAsIHRoaXMgY2FuIGJlIHVzZWQgYXMgYSB0cmFjZWJhY2stZnJlZQogICAgICAgIHZlcnNpb24gb2YgYGBzdHIob2JqKWBgLgogICAgOmt3YXJnIGVuY29kaW5nOiBUaGUgZW5jb2RpbmcgdG8gdXNlIHRvIHRyYW5zZm9ybSBmcm9tIGEgdGV4dCBzdHJpbmcgdG8KICAgICAgICBhIGJ5dGUgc3RyaW5nLiAgRGVmYXVsdHMgdG8gdXNpbmcgJ3V0Zi04Jy4KICAgIDprd2FyZyBlcnJvcnM6IFRoZSBlcnJvciBoYW5kbGVyIHRvIHVzZSBpZiB0aGUgdGV4dCBzdHJpbmcgaXMgbm90CiAgICAgICAgZW5jb2RhYmxlIHVzaW5nIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcuICBBbnkgdmFsaWQgYGNvZGVjcyBlcnJvcgogICAgICAgIGhhbmRsZXIgPGh0dHBzOi8vZG9jcy5weXRob24ub3JnLzIvbGlicmFyeS9jb2RlY3MuaHRtbCNjb2RlYy1iYXNlLWNsYXNzZXM+YF8KICAgICAgICBtYXkgYmUgc3BlY2lmaWVkLiBUaGVyZSBhcmUgdGhyZWUgYWRkaXRpb25hbCBlcnJvciBzdHJhdGVnaWVzCiAgICAgICAgc3BlY2lmaWNhbGx5IGFpbWVkIGF0IGhlbHBpbmcgcGVvcGxlIHRvIHBvcnQgY29kZS4gIFRoZSBmaXJzdCB0d28gYXJlOgoKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9zdHJpY3Q6IFdpbGwgdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlciwgb3RoZXJ3aXNlIGl0IHdpbGwgdXNlIGBgc3RyaWN0YGAKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9yZXBsYWNlOiBXaWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSBgYHJlcGxhY2VgYC4KCiAgICAgICAgQmVjYXVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIHdhcyBhZGRlZCBpbiBQeXRob24zIHRoaXMgdXN1YWxseSBtZWFucyB0aGF0CiAgICAgICAgUHl0aG9uMyB3aWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGFuZCBQeXRob24yIHdpbGwgdXNlIHRoZSBmYWxsYmFjawogICAgICAgIGVycm9yIGhhbmRsZXIuIE5vdGUgdGhhdCB0aGUgY29kZSBjaGVja3MgZm9yIGBgc3Vycm9nYXRlZXNjYXBlYGAgd2hlbiB0aGUKICAgICAgICBtb2R1bGUgaXMgaW1wb3J0ZWQuICBJZiB5b3UgaGF2ZSBhIGJhY2twb3J0IG9mIGBgc3Vycm9nYXRlZXNjYXBlYGAgZm9yCiAgICAgICAgUHl0aG9uMiwgYmUgc3VyZSB0byByZWdpc3RlciB0aGUgZXJyb3IgaGFuZGxlciBwcmlvciB0byBpbXBvcnRpbmcgdGhpcwogICAgICAgIG1vZHVsZS4KCiAgICAgICAgVGhlIGxhc3QgZXJyb3IgaGFuZGxlciBpczoKCiAgICAgICAgICAgIDpzdXJyb2dhdGVfdGhlbl9yZXBsYWNlOiBXaWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIuICBJZiBlbmNvZGluZyB3aXRoIGBgc3Vycm9nYXRlZXNjYXBlYGAgd291bGQgdHJhY2ViYWNrLAogICAgICAgICAgICAgICAgc3Vycm9nYXRlcyBhcmUgZmlyc3QgcmVwbGFjZWQgd2l0aCBhIHJlcGxhY2VtZW50IGNoYXJhY3RlcnMKICAgICAgICAgICAgICAgIGFuZCB0aGVuIHRoZSBzdHJpbmcgaXMgZW5jb2RlZCB1c2luZyBgYHJlcGxhY2VgYCAod2hpY2ggcmVwbGFjZXMKICAgICAgICAgICAgICAgIHRoZSByZXN0IG9mIHRoZSBub25lbmNvZGFibGUgYnl0ZXMpLiAgSWYgYGBzdXJyb2dhdGVlc2NhcGVgYCBpcwogICAgICAgICAgICAgICAgbm90IHByZXNlbnQgaXQgd2lsbCBzaW1wbHkgdXNlIGBgcmVwbGFjZWBgLiAgKEFkZGVkIGluIEFuc2libGUgMi4zKQogICAgICAgICAgICAgICAgVGhpcyBzdHJhdGVneSBpcyBkZXNpZ25lZCB0byBuZXZlciB0cmFjZWJhY2sgd2hlbiBpdCBhdHRlbXB0cwogICAgICAgICAgICAgICAgdG8gZW5jb2RlIGEgc3RyaW5nLgoKICAgICAgICBUaGUgZGVmYXVsdCB1bnRpbCBBbnNpYmxlLTIuMiB3YXMgYGBzdXJyb2dhdGVfb3JfcmVwbGFjZWBgCiAgICAgICAgRnJvbSBBbnNpYmxlLTIuMyBvbndhcmRzLCB0aGUgZGVmYXVsdCBpcyBgYHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2VgYC4KCiAgICA6a3dhcmcgbm9uc3RyaW5nOiBUaGUgc3RyYXRlZ3kgdG8gdXNlIGlmIGEgbm9uc3RyaW5nIGlzIHNwZWNpZmllZCBpbgogICAgICAgIGBgb2JqYGAuICBEZWZhdWx0IGlzICdzaW1wbGVyZXByJy4gIFZhbGlkIHZhbHVlcyBhcmU6CgogICAgICAgIDpzaW1wbGVyZXByOiBUaGUgZGVmYXVsdC4gIFRoaXMgdGFrZXMgdGhlIGBgc3RyYGAgb2YgdGhlIG9iamVjdCBhbmQKICAgICAgICAgICAgdGhlbiByZXR1cm5zIHRoZSBieXRlcyB2ZXJzaW9uIG9mIHRoYXQgc3RyaW5nLgogICAgICAgIDplbXB0eTogUmV0dXJuIGFuIGVtcHR5IGJ5dGUgc3RyaW5nCiAgICAgICAgOnBhc3N0aHJ1OiBSZXR1cm4gdGhlIG9iamVjdCBwYXNzZWQgaW4KICAgICAgICA6c3RyaWN0OiBSYWlzZSBhIDpleGM6YFR5cGVFcnJvcmAKCiAgICA6cmV0dXJuczogVHlwaWNhbGx5IHRoaXMgcmV0dXJucyBhIGJ5dGUgc3RyaW5nLiAgSWYgYSBub25zdHJpbmcgb2JqZWN0IGlzCiAgICAgICAgcGFzc2VkIGluIHRoaXMgbWF5IGJlIGEgZGlmZmVyZW50IHR5cGUgZGVwZW5kaW5nIG9uIHRoZSBzdHJhdGVneQogICAgICAgIHNwZWNpZmllZCBieSBub25zdHJpbmcuICBUaGlzIHdpbGwgbmV2ZXIgcmV0dXJuIGEgdGV4dCBzdHJpbmcuCgogICAgLi4gbm90ZTo6IElmIHBhc3NlZCBhIGJ5dGUgc3RyaW5nLCB0aGlzIGZ1bmN0aW9uIGRvZXMgbm90IGNoZWNrIHRoYXQgdGhlCiAgICAgICAgc3RyaW5nIGlzIHZhbGlkIGluIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcuICBJZiBpdCdzIGltcG9ydGFudCB0aGF0IHRoZQogICAgICAgIGJ5dGUgc3RyaW5nIGlzIGluIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcgZG86OgoKICAgICAgICAgICAgZW5jb2RlZF9zdHJpbmcgPSB0b19ieXRlcyh0b190ZXh0KGlucHV0X3N0cmluZywgJ2xhdGluLTEnKSwgJ3V0Zi04JykKCiAgICAuLiB2ZXJzaW9uX2NoYW5nZWQ6OiAyLjMKCiAgICAgICAgQWRkZWQgdGhlIGBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWBgIGVycm9yIGhhbmRsZXIgYW5kIG1hZGUgaXQgdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlci4KICAgICIiIgogICAgaWYgaXNpbnN0YW5jZShvYmosIGJpbmFyeV90eXBlKToKICAgICAgICByZXR1cm4gb2JqCgogICAgIyBXZSdyZSBnaXZlbiBhIHRleHQgc3RyaW5nCiAgICAjIElmIGl0IGhhcyBzdXJyb2dhdGVzLCB3ZSBrbm93IGJlY2F1c2UgaXQgd2lsbCBkZWNvZGUKICAgIG9yaWdpbmFsX2Vycm9ycyA9IGVycm9ycwogICAgaWYgZXJyb3JzIGluIF9DT01QT1NFRF9FUlJPUl9IQU5ETEVSUzoKICAgICAgICBpZiBIQVNfU1VSUk9HQVRFRVNDQVBFOgogICAgICAgICAgICBlcnJvcnMgPSAnc3Vycm9nYXRlZXNjYXBlJwogICAgICAgIGVsaWYgZXJyb3JzID09ICdzdXJyb2dhdGVfb3Jfc3RyaWN0JzoKICAgICAgICAgICAgZXJyb3JzID0gJ3N0cmljdCcKICAgICAgICBlbHNlOgogICAgICAgICAgICBlcnJvcnMgPSAncmVwbGFjZScKCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgdGV4dF90eXBlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVHJ5IHRoaXMgZmlyc3QgYXMgaXQncyB0aGUgZmFzdGVzdAogICAgICAgICAgICByZXR1cm4gb2JqLmVuY29kZShlbmNvZGluZywgZXJyb3JzKQogICAgICAgIGV4Y2VwdCBVbmljb2RlRW5jb2RlRXJyb3I6CiAgICAgICAgICAgIGlmIG9yaWdpbmFsX2Vycm9ycyBpbiAoTm9uZSwgJ3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKToKICAgICAgICAgICAgICAgICMgU2xvdyBidXQgd29ya3MKICAgICAgICAgICAgICAgIHJldHVybl9zdHJpbmcgPSBvYmouZW5jb2RlKCd1dGYtOCcsICdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICAgICAgICAgcmV0dXJuX3N0cmluZyA9IHJldHVybl9zdHJpbmcuZGVjb2RlKCd1dGYtOCcsICdyZXBsYWNlJykKICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5fc3RyaW5nLmVuY29kZShlbmNvZGluZywgJ3JlcGxhY2UnKQogICAgICAgICAgICByYWlzZQoKICAgICMgTm90ZTogV2UgZG8gdGhlc2UgbGFzdCBldmVuIHRob3VnaCB3ZSBoYXZlIHRvIGNhbGwgdG9fYnl0ZXMgYWdhaW4gb24gdGhlCiAgICAjIHZhbHVlIGJlY2F1c2Ugd2UncmUgb3B0aW1pemluZyB0aGUgY29tbW9uIGNhc2UKICAgIGlmIG5vbnN0cmluZyA9PSAnc2ltcGxlcmVwcic6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWx1ZSA9IHN0cihvYmopCiAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdmFsdWUgPSByZXByKG9iaikKICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgICMgR2l2aW5nIHVwCiAgICAgICAgICAgICAgICByZXR1cm4gdG9fYnl0ZXMoJycpCiAgICBlbGlmIG5vbnN0cmluZyA9PSAncGFzc3RocnUnOgogICAgICAgIHJldHVybiBvYmoKICAgIGVsaWYgbm9uc3RyaW5nID09ICdlbXB0eSc6CiAgICAgICAgIyBweXRob24yLjQgZG9lc24ndCBoYXZlIGInJwogICAgICAgIHJldHVybiB0b19ieXRlcygnJykKICAgIGVsaWYgbm9uc3RyaW5nID09ICdzdHJpY3QnOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignb2JqIG11c3QgYmUgYSBzdHJpbmcgdHlwZScpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignSW52YWxpZCB2YWx1ZSAlcyBmb3IgdG9fYnl0ZXNcJyBub25zdHJpbmcgcGFyYW1ldGVyJyAlIG5vbnN0cmluZykKCiAgICByZXR1cm4gdG9fYnl0ZXModmFsdWUsIGVuY29kaW5nLCBlcnJvcnMpCgoKZGVmIHRvX3RleHQob2JqLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9Tm9uZSwgbm9uc3RyaW5nPSdzaW1wbGVyZXByJyk6CiAgICAiIiJNYWtlIHN1cmUgdGhhdCBhIHN0cmluZyBpcyBhIHRleHQgc3RyaW5nCgogICAgOmFyZyBvYmo6IEFuIG9iamVjdCB0byBtYWtlIHN1cmUgaXMgYSB0ZXh0IHN0cmluZy4gIEluIG1vc3QgY2FzZXMgdGhpcwogICAgICAgIHdpbGwgYmUgZWl0aGVyIGEgdGV4dCBzdHJpbmcgb3IgYSBieXRlIHN0cmluZy4gIEhvd2V2ZXIsIHdpdGgKICAgICAgICBgYG5vbnN0cmluZz0nc2ltcGxlcmVwcidgYCwgdGhpcyBjYW4gYmUgdXNlZCBhcyBhIHRyYWNlYmFjay1mcmVlCiAgICAgICAgdmVyc2lvbiBvZiBgYHN0cihvYmopYGAuCiAgICA6a3dhcmcgZW5jb2Rpbmc6IFRoZSBlbmNvZGluZyB0byB1c2UgdG8gdHJhbnNmb3JtIGZyb20gYSBieXRlIHN0cmluZyB0bwogICAgICAgIGEgdGV4dCBzdHJpbmcuICBEZWZhdWx0cyB0byB1c2luZyAndXRmLTgnLgogICAgOmt3YXJnIGVycm9yczogVGhlIGVycm9yIGhhbmRsZXIgdG8gdXNlIGlmIHRoZSBieXRlIHN0cmluZyBpcyBub3QKICAgICAgICBkZWNvZGFibGUgdXNpbmcgdGhlIHNwZWNpZmllZCBlbmNvZGluZy4gIEFueSB2YWxpZCBgY29kZWNzIGVycm9yCiAgICAgICAgaGFuZGxlciA8aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMi9saWJyYXJ5L2NvZGVjcy5odG1sI2NvZGVjLWJhc2UtY2xhc3Nlcz5gXwogICAgICAgIG1heSBiZSBzcGVjaWZpZWQuICAgV2Ugc3VwcG9ydCB0aHJlZSBhZGRpdGlvbmFsIGVycm9yIHN0cmF0ZWdpZXMKICAgICAgICBzcGVjaWZpY2FsbHkgYWltZWQgYXQgaGVscGluZyBwZW9wbGUgdG8gcG9ydCBjb2RlOgoKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9zdHJpY3Q6IFdpbGwgdXNlIHN1cnJvZ2F0ZWVzY2FwZSBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLCBvdGhlcndpc2UgaXQgd2lsbCB1c2Ugc3RyaWN0CiAgICAgICAgICAgIDpzdXJyb2dhdGVfb3JfcmVwbGFjZTogV2lsbCB1c2Ugc3Vycm9nYXRlZXNjYXBlIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSByZXBsYWNlLgogICAgICAgICAgICA6c3Vycm9nYXRlX3RoZW5fcmVwbGFjZTogRG9lcyB0aGUgc2FtZSBhcyBzdXJyb2dhdGVfb3JfcmVwbGFjZSBidXQKICAgICAgICAgICAgICAgIGB3YXMgYWRkZWQgZm9yIHN5bW1ldHJ5IHdpdGggdGhlIGVycm9yIGhhbmRsZXJzIGluCiAgICAgICAgICAgICAgICA6ZnVuYzpgYW5zaWJsZS5tb2R1bGVfdXRpbHMuX3RleHQudG9fYnl0ZXNgIChBZGRlZCBpbiBBbnNpYmxlIDIuMykKCiAgICAgICAgQmVjYXVzZSBzdXJyb2dhdGVlc2NhcGUgd2FzIGFkZGVkIGluIFB5dGhvbjMgdGhpcyB1c3VhbGx5IG1lYW5zIHRoYXQKICAgICAgICBQeXRob24zIHdpbGwgdXNlIGBzdXJyb2dhdGVlc2NhcGVgIGFuZCBQeXRob24yIHdpbGwgdXNlIHRoZSBmYWxsYmFjawogICAgICAgIGVycm9yIGhhbmRsZXIuIE5vdGUgdGhhdCB0aGUgY29kZSBjaGVja3MgZm9yIHN1cnJvZ2F0ZWVzY2FwZSB3aGVuIHRoZQogICAgICAgIG1vZHVsZSBpcyBpbXBvcnRlZC4gIElmIHlvdSBoYXZlIGEgYmFja3BvcnQgb2YgYHN1cnJvZ2F0ZWVzY2FwZWAgZm9yCiAgICAgICAgcHl0aG9uMiwgYmUgc3VyZSB0byByZWdpc3RlciB0aGUgZXJyb3IgaGFuZGxlciBwcmlvciB0byBpbXBvcnRpbmcgdGhpcwogICAgICAgIG1vZHVsZS4KCiAgICAgICAgVGhlIGRlZmF1bHQgdW50aWwgQW5zaWJsZS0yLjIgd2FzIGBzdXJyb2dhdGVfb3JfcmVwbGFjZWAKICAgICAgICBJbiBBbnNpYmxlLTIuMyB0aGlzIGRlZmF1bHRzIHRvIGBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlYCBmb3Igc3ltbWV0cnkKICAgICAgICB3aXRoIDpmdW5jOmBhbnNpYmxlLm1vZHVsZV91dGlscy5fdGV4dC50b19ieXRlc2AgLgogICAgOmt3YXJnIG5vbnN0cmluZzogVGhlIHN0cmF0ZWd5IHRvIHVzZSBpZiBhIG5vbnN0cmluZyBpcyBzcGVjaWZpZWQgaW4KICAgICAgICBgYG9iamBgLiAgRGVmYXVsdCBpcyAnc2ltcGxlcmVwcicuICBWYWxpZCB2YWx1ZXMgYXJlOgoKICAgICAgICA6c2ltcGxlcmVwcjogVGhlIGRlZmF1bHQuICBUaGlzIHRha2VzIHRoZSBgYHN0cmBgIG9mIHRoZSBvYmplY3QgYW5kCiAgICAgICAgICAgIHRoZW4gcmV0dXJucyB0aGUgdGV4dCB2ZXJzaW9uIG9mIHRoYXQgc3RyaW5nLgogICAgICAgIDplbXB0eTogUmV0dXJuIGFuIGVtcHR5IHRleHQgc3RyaW5nCiAgICAgICAgOnBhc3N0aHJ1OiBSZXR1cm4gdGhlIG9iamVjdCBwYXNzZWQgaW4KICAgICAgICA6c3RyaWN0OiBSYWlzZSBhIDpleGM6YFR5cGVFcnJvcmAKCiAgICA6cmV0dXJuczogVHlwaWNhbGx5IHRoaXMgcmV0dXJucyBhIHRleHQgc3RyaW5nLiAgSWYgYSBub25zdHJpbmcgb2JqZWN0IGlzCiAgICAgICAgcGFzc2VkIGluIHRoaXMgbWF5IGJlIGEgZGlmZmVyZW50IHR5cGUgZGVwZW5kaW5nIG9uIHRoZSBzdHJhdGVneQogICAgICAgIHNwZWNpZmllZCBieSBub25zdHJpbmcuICBUaGlzIHdpbGwgbmV2ZXIgcmV0dXJuIGEgYnl0ZSBzdHJpbmcuCiAgICAgICAgRnJvbSBBbnNpYmxlLTIuMyBvbndhcmRzLCB0aGUgZGVmYXVsdCBpcyBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWAuCgogICAgLi4gdmVyc2lvbl9jaGFuZ2VkOjogMi4zCgogICAgICAgIEFkZGVkIHRoZSBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlIGVycm9yIGhhbmRsZXIgYW5kIG1hZGUgaXQgdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlci4KICAgICIiIgogICAgaWYgaXNpbnN0YW5jZShvYmosIHRleHRfdHlwZSk6CiAgICAgICAgcmV0dXJuIG9iagoKICAgIGlmIGVycm9ycyBpbiBfQ09NUE9TRURfRVJST1JfSEFORExFUlM6CiAgICAgICAgaWYgSEFTX1NVUlJPR0FURUVTQ0FQRToKICAgICAgICAgICAgZXJyb3JzID0gJ3N1cnJvZ2F0ZWVzY2FwZScKICAgICAgICBlbGlmIGVycm9ycyA9PSAnc3Vycm9nYXRlX29yX3N0cmljdCc6CiAgICAgICAgICAgIGVycm9ycyA9ICdzdHJpY3QnCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZXJyb3JzID0gJ3JlcGxhY2UnCgogICAgaWYgaXNpbnN0YW5jZShvYmosIGJpbmFyeV90eXBlKToKICAgICAgICAjIE5vdGU6IFdlIGRvbid0IG5lZWQgc3BlY2lhbCBoYW5kbGluZyBmb3Igc3Vycm9nYXRlX3RoZW5fcmVwbGFjZQogICAgICAgICMgYmVjYXVzZSBhbGwgYnl0ZXMgd2lsbCBlaXRoZXIgYmUgbWFkZSBpbnRvIHN1cnJvZ2F0ZXMgb3IgYXJlIHZhbGlkCiAgICAgICAgIyB0byBkZWNvZGUuCiAgICAgICAgcmV0dXJuIG9iai5kZWNvZGUoZW5jb2RpbmcsIGVycm9ycykKCiAgICAjIE5vdGU6IFdlIGRvIHRoZXNlIGxhc3QgZXZlbiB0aG91Z2ggd2UgaGF2ZSB0byBjYWxsIHRvX3RleHQgYWdhaW4gb24gdGhlCiAgICAjIHZhbHVlIGJlY2F1c2Ugd2UncmUgb3B0aW1pemluZyB0aGUgY29tbW9uIGNhc2UKICAgIGlmIG5vbnN0cmluZyA9PSAnc2ltcGxlcmVwcic6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWx1ZSA9IHN0cihvYmopCiAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdmFsdWUgPSByZXByKG9iaikKICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgICMgR2l2aW5nIHVwCiAgICAgICAgICAgICAgICByZXR1cm4gdScnCiAgICBlbGlmIG5vbnN0cmluZyA9PSAncGFzc3RocnUnOgogICAgICAgIHJldHVybiBvYmoKICAgIGVsaWYgbm9uc3RyaW5nID09ICdlbXB0eSc6CiAgICAgICAgcmV0dXJuIHUnJwogICAgZWxpZiBub25zdHJpbmcgPT0gJ3N0cmljdCc6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdvYmogbXVzdCBiZSBhIHN0cmluZyB0eXBlJykKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdJbnZhbGlkIHZhbHVlICVzIGZvciB0b190ZXh0XCdzIG5vbnN0cmluZyBwYXJhbWV0ZXInICUgbm9uc3RyaW5nKQoKICAgIHJldHVybiB0b190ZXh0KHZhbHVlLCBlbmNvZGluZywgZXJyb3JzKQoKCiM6IDpweTpmdW5jOmB0b19uYXRpdmVgCiM6ICAgICAgVHJhbnNmb3JtIGEgdmFyaWFibGUgaW50byB0aGUgbmF0aXZlIHN0ciB0eXBlIGZvciB0aGUgcHl0aG9uIHZlcnNpb24KIzoKIzogICAgICBPbiBQeXRob24yLCB0aGlzIGlzIGFuIGFsaWFzIGZvcgojOiAgICAgIDpmdW5jOmB+YW5zaWJsZS5tb2R1bGVfdXRpbHMudG9fYnl0ZXNgLiAgT24gUHl0aG9uMyBpdCBpcyBhbiBhbGlhcyBmb3IKIzogICAgICA6ZnVuYzpgfmFuc2libGUubW9kdWxlX3V0aWxzLnRvX3RleHRgLiAgSXQgbWFrZXMgaXQgZWFzaWVyIHRvCiM6ICAgICAgdHJhbnNmb3JtIGEgdmFyaWFibGUgaW50byB0aGUgbmF0aXZlIHN0ciB0eXBlIGZvciB0aGUgcHl0aG9uIHZlcnNpb24KIzogICAgICB0aGUgY29kZSBpcyBydW5uaW5nIG9uLiAgVXNlIHRoaXMgd2hlbiBjb25zdHJ1Y3RpbmcgdGhlIG1lc3NhZ2UgdG8KIzogICAgICBzZW5kIHRvIGV4Y2VwdGlvbnMgb3Igd2hlbiBkZWFsaW5nIHdpdGggYW4gQVBJIHRoYXQgbmVlZHMgdG8gdGFrZQojOiAgICAgIGEgbmF0aXZlIHN0cmluZy4gIEV4YW1wbGU6OgojOgojOiAgICAgICAgICB0cnk6CiM6ICAgICAgICAgICAgICAxLy8wCiM6ICAgICAgICAgIGV4Y2VwdCBaZXJvRGl2aXNpb25FcnJvciBhcyBlOgojOiAgICAgICAgICAgICAgcmFpc2UgTXlFeGNlcHRpb24oJ0VuY291bnRlcmVkIGFuZCBlcnJvcjogJXMnICUgdG9fbmF0aXZlKGUpKQppZiBQWTM6CiAgICB0b19uYXRpdmUgPSB0b190ZXh0CmVsc2U6CiAgICB0b19uYXRpdmUgPSB0b19ieXRlcwpQSwMEFAAAAAAAy7srSyXctH4TEAAAExAAACIAAABhbnNpYmxlL21vZHVsZV91dGlscy9weWNvbXBhdDI0LnB5IyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojIFRoaXMgcGFydGljdWxhciBmaWxlIHNuaXBwZXQsIGFuZCB0aGlzIGZpbGUgc25pcHBldCBvbmx5LCBpcyBCU0QgbGljZW5zZWQuCiMgTW9kdWxlcyB5b3Ugd3JpdGUgdXNpbmcgdGhpcyBzbmlwcGV0LCB3aGljaCBpcyBlbWJlZGRlZCBkeW5hbWljYWxseSBieSBBbnNpYmxlCiMgc3RpbGwgYmVsb25nIHRvIHRoZSBhdXRob3Igb2YgdGhlIG1vZHVsZSwgYW5kIG1heSBhc3NpZ24gdGhlaXIgb3duIGxpY2Vuc2UKIyB0byB0aGUgY29tcGxldGUgd29yay4KIwojIENvcHlyaWdodCAoYykgMjAxNiwgVG9zaGlvIEt1cmF0b21pIDx0a3VyYXRvbWlAYW5zaWJsZS5jb20+CiMgQ29weXJpZ2h0IChjKSAyMDE1LCBNYXJpdXMgR2VkbWluYXMKIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dCBtb2RpZmljYXRpb24sCiMgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAojICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5ECiMgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRUQKIyBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuCiMgSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsCiMgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLAojIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUwojIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QKIyBMSUFCSUxJVFksIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUKIyBVU0UgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwoKaW1wb3J0IHN5cwoKZGVmIGdldF9leGNlcHRpb24oKToKICAgICIiIkdldCB0aGUgY3VycmVudCBleGNlcHRpb24uCgogICAgVGhpcyBjb2RlIG5lZWRzIHRvIHdvcmsgb24gUHl0aG9uIDIuNCB0aHJvdWdoIDMueCwgc28gd2UgY2Fubm90IHVzZQogICAgImV4Y2VwdCBFeGNlcHRpb24sIGU6IiAoU3ludGF4RXJyb3Igb24gUHl0aG9uIDMueCkgbm9yCiAgICAiZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOiIgKFN5bnRheEVycm9yIG9uIFB5dGhvbiAyLjQtMi41KS4KICAgIEluc3RlYWQgd2UgbXVzdCB1c2UgOjoKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQoKICAgICIiIgogICAgcmV0dXJuIHN5cy5leGNfaW5mbygpWzFdCgp0cnk6CiAgICAjIFB5dGhvbiAyLjYrCiAgICBmcm9tIGFzdCBpbXBvcnQgbGl0ZXJhbF9ldmFsCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICMgYSByZXBsYWNlbWVudCBmb3IgbGl0ZXJhbF9ldmFsIHRoYXQgd29ya3Mgd2l0aCBweXRob24gMi40LiBmcm9tOgogICAgIyBodHRwczovL21haWwucHl0aG9uLm9yZy9waXBlcm1haWwvcHl0aG9uLWxpc3QvMjAwOS1TZXB0ZW1iZXIvNTUxODgwLmh0bWwKICAgICMgd2hpY2ggaXMgZXNzZW50aWFsbHkgYSBjdXQvcGFzdGUgZnJvbSBhbiBlYXJsaWVyICgyLjYpIHZlcnNpb24gb2YgcHl0aG9uJ3MKICAgICMgYXN0LnB5CiAgICBmcm9tIGNvbXBpbGVyIGltcG9ydCBhc3QsIHBhcnNlCiAgICBmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpbXBvcnQgYmluYXJ5X3R5cGUsIHN0cmluZ190eXBlcywgdGV4dF90eXBlCgogICAgZGVmIGxpdGVyYWxfZXZhbChub2RlX29yX3N0cmluZyk6CiAgICAgICAgIiIiCiAgICAgICAgU2FmZWx5IGV2YWx1YXRlIGFuIGV4cHJlc3Npb24gbm9kZSBvciBhIHN0cmluZyBjb250YWluaW5nIGEgUHl0aG9uCiAgICAgICAgZXhwcmVzc2lvbi4gIFRoZSBzdHJpbmcgb3Igbm9kZSBwcm92aWRlZCBtYXkgb25seSBjb25zaXN0IG9mIHRoZSAgZm9sbG93aW5nCiAgICAgICAgUHl0aG9uIGxpdGVyYWwgc3RydWN0dXJlczogc3RyaW5ncywgbnVtYmVycywgdHVwbGVzLCBsaXN0cywgZGljdHMsICBib29sZWFucywKICAgICAgICBhbmQgTm9uZS4KICAgICAgICAiIiIKICAgICAgICBfc2FmZV9uYW1lcyA9IHsnTm9uZSc6IE5vbmUsICdUcnVlJzogVHJ1ZSwgJ0ZhbHNlJzogRmFsc2V9CiAgICAgICAgaWYgaXNpbnN0YW5jZShub2RlX29yX3N0cmluZywgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgbm9kZV9vcl9zdHJpbmcgPSBwYXJzZShub2RlX29yX3N0cmluZywgbW9kZT0nZXZhbCcpCiAgICAgICAgaWYgaXNpbnN0YW5jZShub2RlX29yX3N0cmluZywgYXN0LkV4cHJlc3Npb24pOgogICAgICAgICAgICBub2RlX29yX3N0cmluZyA9IG5vZGVfb3Jfc3RyaW5nLm5vZGUKCiAgICAgICAgZGVmIF9jb252ZXJ0KG5vZGUpOgogICAgICAgICAgICAjIE9rYXkgdG8gdXNlIGxvbmcgaGVyZSBiZWNhdXNlIHRoaXMgaXMgb25seSBmb3IgcHl0aG9uIDIuNCBhbmQgMi41CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0LkNvbnN0KSBhbmQgaXNpbnN0YW5jZShub2RlLnZhbHVlLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSwgaW50LCBmbG9hdCwgbG9uZywgY29tcGxleCkpOgogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUudmFsdWUKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5UdXBsZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gdHVwbGUobWFwKF9jb252ZXJ0LCBub2RlLm5vZGVzKSkKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5MaXN0KToKICAgICAgICAgICAgICAgIHJldHVybiBsaXN0KG1hcChfY29udmVydCwgbm9kZS5ub2RlcykpCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuRGljdCk6CiAgICAgICAgICAgICAgICByZXR1cm4gZGljdCgoX2NvbnZlcnQoayksIF9jb252ZXJ0KHYpKSBmb3IgaywgdiBpbiBub2RlLml0ZW1zKCkpCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuTmFtZSk6CiAgICAgICAgICAgICAgICBpZiBub2RlLm5hbWUgaW4gX3NhZmVfbmFtZXM6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9zYWZlX25hbWVzW25vZGUubmFtZV0KICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5VbmFyeVN1Yik6CiAgICAgICAgICAgICAgICByZXR1cm4gLV9jb252ZXJ0KG5vZGUuZXhwcikKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignbWFsZm9ybWVkIHN0cmluZycpCiAgICAgICAgcmV0dXJuIF9jb252ZXJ0KG5vZGVfb3Jfc3RyaW5nKQoKX19hbGxfXyA9ICgnZ2V0X2V4Y2VwdGlvbicsICdsaXRlcmFsX2V2YWwnKQpQSwMEFAAAAAAAy7srSxgXcvUBEQAAAREAACQAAABhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX19pbml0X18ucHkjIFRoaXMgY29kZSBpcyBwYXJ0IG9mIEFuc2libGUsIGJ1dCBpcyBhbiBpbmRlcGVuZGVudCBjb21wb25lbnQuCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgQ29weXJpZ2h0IChjKSAyMDE3LCBUb3NoaW8gS3VyYXRvbWkgPHRrdXJhdG9taUBhbnNpYmxlLmNvbT4KIwojIFRoaXMgY29kZSBpcyBiYXNlZCBvbiBjb2RlIGZyb20gQXN0cm9weSBhbmQgcmV0YWlucyB0aGVpciAzLWNsYXVzZSBCU0QgbGljZW5zZQojIHJlcHJvZHVjZWQgYmVsb3c6CiMKIyBDb3B5cmlnaHQgKGMpIDIwMTEtMjAxNiwgQXN0cm9weSBEZXZlbG9wZXJzCiMKIyBBbGwgcmlnaHRzIHJlc2VydmVkLgojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0CiMgbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwgdGhpcwojICAgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIyAqIE5laXRoZXIgdGhlIG5hbWUgb2YgdGhlIEFzdHJvcHkgVGVhbSBub3IgdGhlIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5CiMgICBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0cyBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0CiMgICBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIKIyBBTkQgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFCiMgSU1QTElFRCBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFCiMgRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRQojIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMCiMgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IKIyBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUgojIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksCiMgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UKIyBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCiMgQXN0cm9weSBMaWNlbnNlOiBodHRwczovL2dpdGh1Yi5jb20vYXN0cm9weS9hc3Ryb3B5L2Jsb2IvY2YzMjY1ZTQyYTBkYjhlMDBiYjkwNjQ0ZGIzN2M4MTUwZjVhYzAwYy9saWNlbnNlcy9MSUNFTlNFLnJzdAojIEFzdHJvcHkgQ29kZTogaHR0cHM6Ly9naXRodWIuY29tL2FzdHJvcHkvYXN0cm9weS9ibG9iL2NmMzI2NWU0MmEwZGI4ZTAwYmI5MDY0NGRiMzdjODE1MGY1YWMwMGMvYXN0cm9weS9leHRlcm4vc2l4LnB5CgoiIiIKSGFuZGxlIGxvYWRpbmcgc2l4IHBhY2thZ2UgZnJvbSBzeXN0ZW0gb3IgZnJvbSB0aGUgYnVuZGxlZCBjb3B5CiIiIgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IGFic29sdXRlX2ltcG9ydAoKaW1wb3J0IGltcCBhcyBfaW1wCmltcG9ydCBzeXMgYXMgX3N5cwoKdHJ5OgogICAgZnJvbSBkaXN0dXRpbHMudmVyc2lvbiBpbXBvcnQgTG9vc2VWZXJzaW9uIGFzIF9Mb29zZVZlcnNpb24KZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyBTb21lIHBsYXRmb3JtcyAqY291Z2gqU29sYXJpcypjb3VnaCogZG9uJ3Qgc2hpcCB0aGUgd2hvbGUgc3RkbGliCiAgICBfTG9vc2VWZXJzaW9uID0gTm9uZQoKdHJ5OgogICAgaW1wb3J0IHNpeCBhcyBfc3lzdGVtX3NpeApleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBfc3lzdGVtX3NpeCA9IE5vbmUKCmZyb20gLiBpbXBvcnQgX3NpeCBhcyBfYnVuZGxlZF9zaXgKCgpkZWYgX2ZpbmRfbW9kdWxlKG5hbWUsIHBhdGg9Tm9uZSk6CiAgICAiIiJBbHRlcm5hdGl2ZSB0byBgaW1wLmZpbmRfbW9kdWxlYCB0aGF0IGNhbiBhbHNvIHNlYXJjaCBpbiBzdWJwYWNrYWdlcyIiIgogICAgcGFydHMgPSBuYW1lLnNwbGl0KCcuJykKCiAgICBmb3IgcGFydCBpbiBwYXJ0czoKICAgICAgICBpZiBwYXRoIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwYXRoID0gW3BhdGhdCiAgICAgICAgZmgsIHBhdGgsIGRlc2NyID0gX2ltcC5maW5kX21vZHVsZShwYXJ0LCBwYXRoKQogICAgcmV0dXJuIGZoLCBwYXRoLCBkZXNjcgoKCmRlZiBfZ2V0X2J1bmRsZWRfc2l4X3NvdXJjZSgpOgogICAgIyBTcGVjaWFsIGltcG9ydCBsb2FkZXIgKHppcGltcG9ydCBmb3IgaW5zdGFuY2UpCiAgICBmb3VuZCA9IEZhbHNlCiAgICBmb3IgcGF0aCBpbiBfc3lzLnBhdGg6CiAgICAgICAgaW1wb3J0ZXIgPSBfc3lzLnBhdGhfaW1wb3J0ZXJfY2FjaGUuZ2V0KHBhdGgpCiAgICAgICAgaWYgaW1wb3J0ZXI6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZvdW5kID0gaW1wb3J0ZXIuZmluZF9tb2R1bGUoJ2Fuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fc2l4JykKICAgICAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgZm91bmQ6CiAgICAgICAgICAgICAgICBicmVhawogICAgZWxzZToKICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigiQ291bGQgbm90IGZpbmQgYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Ll9zaXgiKQoKICAgIG1vZHVsZV9zb3VyY2UgPSBpbXBvcnRlci5nZXRfc291cmNlKCdhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeCcpCiAgICByZXR1cm4gbW9kdWxlX3NvdXJjZQoKCmRlZiBfZ2V0X3NpeF9zb3VyY2UoKToKICAgICIiIkltcG9ydCB0aGUgbmV3ZXN0IHZlcnNpb24gb2YgdGhlIHNpeCBsaWJyYXJ5IHRoYXQncyBhdmFpbGFibGUiIiIKICAgIG1vZF9pbmZvID0gTm9uZQogICAgdHJ5OgogICAgICAgIGlmIF9zeXN0ZW1fc2l4IGFuZCBfTG9vc2VWZXJzaW9uIGFuZCBcCiAgICAgICAgICAgICAgICBfTG9vc2VWZXJzaW9uKF9zeXN0ZW1fc2l4Ll9fdmVyc2lvbl9fKSA+PSBfTG9vc2VWZXJzaW9uKF9idW5kbGVkX3NpeC5fX3ZlcnNpb25fXyk6CiAgICAgICAgICAgIG1vZF9pbmZvID0gX2ZpbmRfbW9kdWxlKCdzaXgnKQogICAgZXhjZXB0OgogICAgICAgICMgQW55IGVycm9ycyBmaW5kaW5nIHRoZSBzeXN0ZW0gbGlicmFyeSwgdXNlIG91ciBidW5kbGVkIGxpYiBpbnN0ZWFkCiAgICAgICAgcGFzcwoKICAgIGlmIG5vdCBtb2RfaW5mbzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIG1vZF9pbmZvID0gX2ZpbmRfbW9kdWxlKCdhbnNpYmxlLm1vZHVsZV91dGlscy5zaXguX3NpeCcpCiAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICAjIHppcGltcG9ydAogICAgICAgICAgICBtb2R1bGVfc291cmNlID0gX2dldF9idW5kbGVkX3NpeF9zb3VyY2UoKQogICAgICAgICAgICByZXR1cm4gbW9kdWxlX3NvdXJjZQoKICAgIHJldHVybiBtb2RfaW5mb1swXS5yZWFkKCkKCnNvdXJjZSA9IF9nZXRfc2l4X3NvdXJjZSgpCmV4ZWMoc291cmNlKQpQSwMEFAAAAAAAy7srSzjix9GRdQAAkXUAACAAAABhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeC5weSIiIlV0aWxpdGllcyBmb3Igd3JpdGluZyBjb2RlIHRoYXQgcnVucyBvbiBQeXRob24gMiBhbmQgMyIiIgoKIyBDb3B5cmlnaHQgKGMpIDIwMTAtMjAxNSBCZW5qYW1pbiBQZXRlcnNvbgojCiMgUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQojIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiMgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwojIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKIyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKIyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgojCiMgVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCiMgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KIwojIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiMgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiMgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiMgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgojIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiMgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKIyBTT0ZUV0FSRS4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgYWJzb2x1dGVfaW1wb3J0CgppbXBvcnQgZnVuY3Rvb2xzCmltcG9ydCBpdGVydG9vbHMKaW1wb3J0IG9wZXJhdG9yCmltcG9ydCBzeXMKaW1wb3J0IHR5cGVzCgpfX2F1dGhvcl9fID0gIkJlbmphbWluIFBldGVyc29uIDxiZW5qYW1pbkBweXRob24ub3JnPiIKX192ZXJzaW9uX18gPSAiMS4xMC4wIgoKCiMgVXNlZnVsIGZvciB2ZXJ5IGNvYXJzZSB2ZXJzaW9uIGRpZmZlcmVudGlhdGlvbi4KUFkyID0gc3lzLnZlcnNpb25faW5mb1swXSA9PSAyClBZMyA9IHN5cy52ZXJzaW9uX2luZm9bMF0gPT0gMwpQWTM0ID0gc3lzLnZlcnNpb25faW5mb1swOjJdID49ICgzLCA0KQoKaWYgUFkzOgogICAgc3RyaW5nX3R5cGVzID0gc3RyLAogICAgaW50ZWdlcl90eXBlcyA9IGludCwKICAgIGNsYXNzX3R5cGVzID0gdHlwZSwKICAgIHRleHRfdHlwZSA9IHN0cgogICAgYmluYXJ5X3R5cGUgPSBieXRlcwogICAgTUFYU0laRSA9IHN5cy5tYXhzaXplCmVsc2U6CiAgICBzdHJpbmdfdHlwZXMgPSBiYXNlc3RyaW5nLAogICAgaW50ZWdlcl90eXBlcyA9IChpbnQsIGxvbmcpCiAgICBjbGFzc190eXBlcyA9ICh0eXBlLCB0eXBlcy5DbGFzc1R5cGUpCiAgICB0ZXh0X3R5cGUgPSB1bmljb2RlCiAgICBiaW5hcnlfdHlwZSA9IHN0cgoKICAgIGlmIHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCJqYXZhIik6CiAgICAgICAgIyBKeXRob24gYWx3YXlzIHVzZXMgMzIgYml0cy4KICAgICAgICBNQVhTSVpFID0gaW50KCgxIDw8IDMxKSAtIDEpCiAgICBlbHNlOgogICAgICAgICMgSXQncyBwb3NzaWJsZSB0byBoYXZlIHNpemVvZihsb25nKSAhPSBzaXplb2YoUHlfc3NpemVfdCkuCiAgICAgICAgY2xhc3MgWChvYmplY3QpOgoKICAgICAgICAgICAgZGVmIF9fbGVuX18oc2VsZik6CiAgICAgICAgICAgICAgICByZXR1cm4gMSA8PCAzMQogICAgICAgIHRyeToKICAgICAgICAgICAgbGVuKFgoKSkKICAgICAgICBleGNlcHQgT3ZlcmZsb3dFcnJvcjoKICAgICAgICAgICAgIyAzMi1iaXQKICAgICAgICAgICAgTUFYU0laRSA9IGludCgoMSA8PCAzMSkgLSAxKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgNjQtYml0CiAgICAgICAgICAgIE1BWFNJWkUgPSBpbnQoKDEgPDwgNjMpIC0gMSkKICAgICAgICBkZWwgWAoKCmRlZiBfYWRkX2RvYyhmdW5jLCBkb2MpOgogICAgIiIiQWRkIGRvY3VtZW50YXRpb24gdG8gYSBmdW5jdGlvbi4iIiIKICAgIGZ1bmMuX19kb2NfXyA9IGRvYwoKCmRlZiBfaW1wb3J0X21vZHVsZShuYW1lKToKICAgICIiIkltcG9ydCBtb2R1bGUsIHJldHVybmluZyB0aGUgbW9kdWxlIGFmdGVyIHRoZSBsYXN0IGRvdC4iIiIKICAgIF9faW1wb3J0X18obmFtZSkKICAgIHJldHVybiBzeXMubW9kdWxlc1tuYW1lXQoKCmNsYXNzIF9MYXp5RGVzY3Iob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSk6CiAgICAgICAgc2VsZi5uYW1lID0gbmFtZQoKICAgIGRlZiBfX2dldF9fKHNlbGYsIG9iaiwgdHApOgogICAgICAgIHJlc3VsdCA9IHNlbGYuX3Jlc29sdmUoKQogICAgICAgIHNldGF0dHIob2JqLCBzZWxmLm5hbWUsIHJlc3VsdCkgICMgSW52b2tlcyBfX3NldF9fLgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBUaGlzIGlzIGEgYml0IHVnbHksIGJ1dCBpdCBhdm9pZHMgcnVubmluZyB0aGlzIGFnYWluIGJ5CiAgICAgICAgICAgICMgcmVtb3ZpbmcgdGhpcyBkZXNjcmlwdG9yLgogICAgICAgICAgICBkZWxhdHRyKG9iai5fX2NsYXNzX18sIHNlbGYubmFtZSkKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gcmVzdWx0CgoKY2xhc3MgTW92ZWRNb2R1bGUoX0xhenlEZXNjcik6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUsIG9sZCwgbmV3PU5vbmUpOgogICAgICAgIHN1cGVyKE1vdmVkTW9kdWxlLCBzZWxmKS5fX2luaXRfXyhuYW1lKQogICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgaWYgbmV3IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBuZXcgPSBuYW1lCiAgICAgICAgICAgIHNlbGYubW9kID0gbmV3CiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5tb2QgPSBvbGQKCiAgICBkZWYgX3Jlc29sdmUoc2VsZik6CiAgICAgICAgcmV0dXJuIF9pbXBvcnRfbW9kdWxlKHNlbGYubW9kKQoKICAgIGRlZiBfX2dldGF0dHJfXyhzZWxmLCBhdHRyKToKICAgICAgICBfbW9kdWxlID0gc2VsZi5fcmVzb2x2ZSgpCiAgICAgICAgdmFsdWUgPSBnZXRhdHRyKF9tb2R1bGUsIGF0dHIpCiAgICAgICAgc2V0YXR0cihzZWxmLCBhdHRyLCB2YWx1ZSkKICAgICAgICByZXR1cm4gdmFsdWUKCgpjbGFzcyBfTGF6eU1vZHVsZSh0eXBlcy5Nb2R1bGVUeXBlKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSk6CiAgICAgICAgc3VwZXIoX0xhenlNb2R1bGUsIHNlbGYpLl9faW5pdF9fKG5hbWUpCiAgICAgICAgc2VsZi5fX2RvY19fID0gc2VsZi5fX2NsYXNzX18uX19kb2NfXwoKICAgIGRlZiBfX2Rpcl9fKHNlbGYpOgogICAgICAgIGF0dHJzID0gWyJfX2RvY19fIiwgIl9fbmFtZV9fIl0KICAgICAgICBhdHRycyArPSBbYXR0ci5uYW1lIGZvciBhdHRyIGluIHNlbGYuX21vdmVkX2F0dHJpYnV0ZXNdCiAgICAgICAgcmV0dXJuIGF0dHJzCgogICAgIyBTdWJjbGFzc2VzIHNob3VsZCBvdmVycmlkZSB0aGlzCiAgICBfbW92ZWRfYXR0cmlidXRlcyA9IFtdCgoKY2xhc3MgTW92ZWRBdHRyaWJ1dGUoX0xhenlEZXNjcik6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUsIG9sZF9tb2QsIG5ld19tb2QsIG9sZF9hdHRyPU5vbmUsIG5ld19hdHRyPU5vbmUpOgogICAgICAgIHN1cGVyKE1vdmVkQXR0cmlidXRlLCBzZWxmKS5fX2luaXRfXyhuYW1lKQogICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgaWYgbmV3X21vZCBpcyBOb25lOgogICAgICAgICAgICAgICAgbmV3X21vZCA9IG5hbWUKICAgICAgICAgICAgc2VsZi5tb2QgPSBuZXdfbW9kCiAgICAgICAgICAgIGlmIG5ld19hdHRyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBpZiBvbGRfYXR0ciBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIG5ld19hdHRyID0gbmFtZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBuZXdfYXR0ciA9IG9sZF9hdHRyCiAgICAgICAgICAgIHNlbGYuYXR0ciA9IG5ld19hdHRyCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5tb2QgPSBvbGRfbW9kCiAgICAgICAgICAgIGlmIG9sZF9hdHRyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBvbGRfYXR0ciA9IG5hbWUKICAgICAgICAgICAgc2VsZi5hdHRyID0gb2xkX2F0dHIKCiAgICBkZWYgX3Jlc29sdmUoc2VsZik6CiAgICAgICAgbW9kdWxlID0gX2ltcG9ydF9tb2R1bGUoc2VsZi5tb2QpCiAgICAgICAgcmV0dXJuIGdldGF0dHIobW9kdWxlLCBzZWxmLmF0dHIpCgoKY2xhc3MgX1NpeE1ldGFQYXRoSW1wb3J0ZXIob2JqZWN0KToKCiAgICAiIiIKICAgIEEgbWV0YSBwYXRoIGltcG9ydGVyIHRvIGltcG9ydCBzaXgubW92ZXMgYW5kIGl0cyBzdWJtb2R1bGVzLgoKICAgIFRoaXMgY2xhc3MgaW1wbGVtZW50cyBhIFBFUDMwMiBmaW5kZXIgYW5kIGxvYWRlci4gSXQgc2hvdWxkIGJlIGNvbXBhdGlibGUKICAgIHdpdGggUHl0aG9uIDIuNSBhbmQgYWxsIGV4aXN0aW5nIHZlcnNpb25zIG9mIFB5dGhvbjMKICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzaXhfbW9kdWxlX25hbWUpOgogICAgICAgIHNlbGYubmFtZSA9IHNpeF9tb2R1bGVfbmFtZQogICAgICAgIHNlbGYua25vd25fbW9kdWxlcyA9IHt9CgogICAgZGVmIF9hZGRfbW9kdWxlKHNlbGYsIG1vZCwgKmZ1bGxuYW1lcyk6CiAgICAgICAgZm9yIGZ1bGxuYW1lIGluIGZ1bGxuYW1lczoKICAgICAgICAgICAgc2VsZi5rbm93bl9tb2R1bGVzW3NlbGYubmFtZSArICIuIiArIGZ1bGxuYW1lXSA9IG1vZAoKICAgIGRlZiBfZ2V0X21vZHVsZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgcmV0dXJuIHNlbGYua25vd25fbW9kdWxlc1tzZWxmLm5hbWUgKyAiLiIgKyBmdWxsbmFtZV0KCiAgICBkZWYgZmluZF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUsIHBhdGg9Tm9uZSk6CiAgICAgICAgaWYgZnVsbG5hbWUgaW4gc2VsZi5rbm93bl9tb2R1bGVzOgogICAgICAgICAgICByZXR1cm4gc2VsZgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9fZ2V0X21vZHVsZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gc2VsZi5rbm93bl9tb2R1bGVzW2Z1bGxuYW1lXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoIlRoaXMgbG9hZGVyIGRvZXMgbm90IGtub3cgbW9kdWxlICIgKyBmdWxsbmFtZSkKCiAgICBkZWYgbG9hZF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBpbiBjYXNlIG9mIGEgcmVsb2FkCiAgICAgICAgICAgIHJldHVybiBzeXMubW9kdWxlc1tmdWxsbmFtZV0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBtb2QgPSBzZWxmLl9fZ2V0X21vZHVsZShmdWxsbmFtZSkKICAgICAgICBpZiBpc2luc3RhbmNlKG1vZCwgTW92ZWRNb2R1bGUpOgogICAgICAgICAgICBtb2QgPSBtb2QuX3Jlc29sdmUoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1vZC5fX2xvYWRlcl9fID0gc2VsZgogICAgICAgIHN5cy5tb2R1bGVzW2Z1bGxuYW1lXSA9IG1vZAogICAgICAgIHJldHVybiBtb2QKCiAgICBkZWYgaXNfcGFja2FnZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgIiIiCiAgICAgICAgUmV0dXJuIHRydWUsIGlmIHRoZSBuYW1lZCBtb2R1bGUgaXMgYSBwYWNrYWdlLgoKICAgICAgICBXZSBuZWVkIHRoaXMgbWV0aG9kIHRvIGdldCBjb3JyZWN0IHNwZWMgb2JqZWN0cyB3aXRoCiAgICAgICAgUHl0aG9uIDMuNCAoc2VlIFBFUDQ1MSkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gaGFzYXR0cihzZWxmLl9fZ2V0X21vZHVsZShmdWxsbmFtZSksICJfX3BhdGhfXyIpCgogICAgZGVmIGdldF9jb2RlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICAiIiJSZXR1cm4gTm9uZQoKICAgICAgICBSZXF1aXJlZCwgaWYgaXNfcGFja2FnZSBpcyBpbXBsZW1lbnRlZCIiIgogICAgICAgIHNlbGYuX19nZXRfbW9kdWxlKGZ1bGxuYW1lKSAgIyBldmVudHVhbGx5IHJhaXNlcyBJbXBvcnRFcnJvcgogICAgICAgIHJldHVybiBOb25lCiAgICBnZXRfc291cmNlID0gZ2V0X2NvZGUgICMgc2FtZSBhcyBnZXRfY29kZQoKX2ltcG9ydGVyID0gX1NpeE1ldGFQYXRoSW1wb3J0ZXIoX19uYW1lX18pCgoKY2xhc3MgX01vdmVkSXRlbXMoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIiIiCiAgICBfX3BhdGhfXyA9IFtdICAjIG1hcmsgYXMgcGFja2FnZQoKCl9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoImNTdHJpbmdJTyIsICJjU3RyaW5nSU8iLCAiaW8iLCAiU3RyaW5nSU8iKSwKICAgIE1vdmVkQXR0cmlidXRlKCJmaWx0ZXIiLCAiaXRlcnRvb2xzIiwgImJ1aWx0aW5zIiwgImlmaWx0ZXIiLCAiZmlsdGVyIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZmlsdGVyZmFsc2UiLCAiaXRlcnRvb2xzIiwgIml0ZXJ0b29scyIsICJpZmlsdGVyZmFsc2UiLCAiZmlsdGVyZmFsc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnB1dCIsICJfX2J1aWx0aW5fXyIsICJidWlsdGlucyIsICJyYXdfaW5wdXQiLCAiaW5wdXQiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnRlcm4iLCAiX19idWlsdGluX18iLCAic3lzIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgibWFwIiwgIml0ZXJ0b29scyIsICJidWlsdGlucyIsICJpbWFwIiwgIm1hcCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldGN3ZCIsICJvcyIsICJvcyIsICJnZXRjd2R1IiwgImdldGN3ZCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldGN3ZGIiLCAib3MiLCAib3MiLCAiZ2V0Y3dkIiwgImdldGN3ZGIiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJyYW5nZSIsICJfX2J1aWx0aW5fXyIsICJidWlsdGlucyIsICJ4cmFuZ2UiLCAicmFuZ2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJyZWxvYWRfbW9kdWxlIiwgIl9fYnVpbHRpbl9fIiwgImltcG9ydGxpYiIgaWYgUFkzNCBlbHNlICJpbXAiLCAicmVsb2FkIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicmVkdWNlIiwgIl9fYnVpbHRpbl9fIiwgImZ1bmN0b29scyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInNobGV4X3F1b3RlIiwgInBpcGVzIiwgInNobGV4IiwgInF1b3RlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiU3RyaW5nSU8iLCAiU3RyaW5nSU8iLCAiaW8iKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVc2VyRGljdCIsICJVc2VyRGljdCIsICJjb2xsZWN0aW9ucyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVzZXJMaXN0IiwgIlVzZXJMaXN0IiwgImNvbGxlY3Rpb25zIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVXNlclN0cmluZyIsICJVc2VyU3RyaW5nIiwgImNvbGxlY3Rpb25zIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgieHJhbmdlIiwgIl9fYnVpbHRpbl9fIiwgImJ1aWx0aW5zIiwgInhyYW5nZSIsICJyYW5nZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInppcCIsICJpdGVydG9vbHMiLCAiYnVpbHRpbnMiLCAiaXppcCIsICJ6aXAiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ6aXBfbG9uZ2VzdCIsICJpdGVydG9vbHMiLCAiaXRlcnRvb2xzIiwgIml6aXBfbG9uZ2VzdCIsICJ6aXBfbG9uZ2VzdCIpLAogICAgTW92ZWRNb2R1bGUoImJ1aWx0aW5zIiwgIl9fYnVpbHRpbl9fIiksCiAgICBNb3ZlZE1vZHVsZSgiY29uZmlncGFyc2VyIiwgIkNvbmZpZ1BhcnNlciIpLAogICAgTW92ZWRNb2R1bGUoImNvcHlyZWciLCAiY29weV9yZWciKSwKICAgIE1vdmVkTW9kdWxlKCJkYm1fZ251IiwgImdkYm0iLCAiZGJtLmdudSIpLAogICAgTW92ZWRNb2R1bGUoIl9kdW1teV90aHJlYWQiLCAiZHVtbXlfdGhyZWFkIiwgIl9kdW1teV90aHJlYWQiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2Nvb2tpZWphciIsICJjb29raWVsaWIiLCAiaHR0cC5jb29raWVqYXIiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2Nvb2tpZXMiLCAiQ29va2llIiwgImh0dHAuY29va2llcyIpLAogICAgTW92ZWRNb2R1bGUoImh0bWxfZW50aXRpZXMiLCAiaHRtbGVudGl0eWRlZnMiLCAiaHRtbC5lbnRpdGllcyIpLAogICAgTW92ZWRNb2R1bGUoImh0bWxfcGFyc2VyIiwgIkhUTUxQYXJzZXIiLCAiaHRtbC5wYXJzZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2NsaWVudCIsICJodHRwbGliIiwgImh0dHAuY2xpZW50IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV9tdWx0aXBhcnQiLCAiZW1haWwuTUlNRU11bHRpcGFydCIsICJlbWFpbC5taW1lLm11bHRpcGFydCIpLAogICAgTW92ZWRNb2R1bGUoImVtYWlsX21pbWVfbm9ubXVsdGlwYXJ0IiwgImVtYWlsLk1JTUVOb25NdWx0aXBhcnQiLCAiZW1haWwubWltZS5ub25tdWx0aXBhcnQiKSwKICAgIE1vdmVkTW9kdWxlKCJlbWFpbF9taW1lX3RleHQiLCAiZW1haWwuTUlNRVRleHQiLCAiZW1haWwubWltZS50ZXh0IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV9iYXNlIiwgImVtYWlsLk1JTUVCYXNlIiwgImVtYWlsLm1pbWUuYmFzZSIpLAogICAgTW92ZWRNb2R1bGUoIkJhc2VIVFRQU2VydmVyIiwgIkJhc2VIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiQ0dJSFRUUFNlcnZlciIsICJDR0lIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiU2ltcGxlSFRUUFNlcnZlciIsICJTaW1wbGVIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiY1BpY2tsZSIsICJjUGlja2xlIiwgInBpY2tsZSIpLAogICAgTW92ZWRNb2R1bGUoInF1ZXVlIiwgIlF1ZXVlIiksCiAgICBNb3ZlZE1vZHVsZSgicmVwcmxpYiIsICJyZXByIiksCiAgICBNb3ZlZE1vZHVsZSgic29ja2V0c2VydmVyIiwgIlNvY2tldFNlcnZlciIpLAogICAgTW92ZWRNb2R1bGUoIl90aHJlYWQiLCAidGhyZWFkIiwgIl90aHJlYWQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyIiwgIlRraW50ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2RpYWxvZyIsICJEaWFsb2ciLCAidGtpbnRlci5kaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2ZpbGVkaWFsb2ciLCAiRmlsZURpYWxvZyIsICJ0a2ludGVyLmZpbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3Njcm9sbGVkdGV4dCIsICJTY3JvbGxlZFRleHQiLCAidGtpbnRlci5zY3JvbGxlZHRleHQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3NpbXBsZWRpYWxvZyIsICJTaW1wbGVEaWFsb2ciLCAidGtpbnRlci5zaW1wbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3RpeCIsICJUaXgiLCAidGtpbnRlci50aXgiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3R0ayIsICJ0dGsiLCAidGtpbnRlci50dGsiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2NvbnN0YW50cyIsICJUa2NvbnN0YW50cyIsICJ0a2ludGVyLmNvbnN0YW50cyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZG5kIiwgIlRrZG5kIiwgInRraW50ZXIuZG5kIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9jb2xvcmNob29zZXIiLCAidGtDb2xvckNob29zZXIiLAogICAgICAgICAgICAgICAgInRraW50ZXIuY29sb3JjaG9vc2VyIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9jb21tb25kaWFsb2ciLCAidGtDb21tb25EaWFsb2ciLAogICAgICAgICAgICAgICAgInRraW50ZXIuY29tbW9uZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl90a2ZpbGVkaWFsb2ciLCAidGtGaWxlRGlhbG9nIiwgInRraW50ZXIuZmlsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZm9udCIsICJ0a0ZvbnQiLCAidGtpbnRlci5mb250IiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9tZXNzYWdlYm94IiwgInRrTWVzc2FnZUJveCIsICJ0a2ludGVyLm1lc3NhZ2Vib3giKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3Rrc2ltcGxlZGlhbG9nIiwgInRrU2ltcGxlRGlhbG9nIiwKICAgICAgICAgICAgICAgICJ0a2ludGVyLnNpbXBsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYl9wYXJzZSIsIF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWJfcGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZE1vZHVsZSgidXJsbGliX2Vycm9yIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYl9lcnJvciIsICJ1cmxsaWIuZXJyb3IiKSwKICAgIE1vdmVkTW9kdWxlKCJ1cmxsaWIiLCBfX25hbWVfXyArICIubW92ZXMudXJsbGliIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYiIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYl9yb2JvdHBhcnNlciIsICJyb2JvdHBhcnNlciIsICJ1cmxsaWIucm9ib3RwYXJzZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJ4bWxycGNfY2xpZW50IiwgInhtbHJwY2xpYiIsICJ4bWxycGMuY2xpZW50IiksCiAgICBNb3ZlZE1vZHVsZSgieG1scnBjX3NlcnZlciIsICJTaW1wbGVYTUxSUENTZXJ2ZXIiLCAieG1scnBjLnNlcnZlciIpLApdCiMgQWRkIHdpbmRvd3Mgc3BlY2lmaWMgbW9kdWxlcy4KaWYgc3lzLnBsYXRmb3JtID09ICJ3aW4zMiI6CiAgICBfbW92ZWRfYXR0cmlidXRlcyArPSBbCiAgICAgICAgTW92ZWRNb2R1bGUoIndpbnJlZyIsICJfd2lucmVnIiksCiAgICBdCgpmb3IgYXR0ciBpbiBfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoX01vdmVkSXRlbXMsIGF0dHIubmFtZSwgYXR0cikKICAgIGlmIGlzaW5zdGFuY2UoYXR0ciwgTW92ZWRNb2R1bGUpOgogICAgICAgIF9pbXBvcnRlci5fYWRkX21vZHVsZShhdHRyLCAibW92ZXMuIiArIGF0dHIubmFtZSkKZGVsIGF0dHIKCl9Nb3ZlZEl0ZW1zLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX21vdmVkX2F0dHJpYnV0ZXMKCm1vdmVzID0gX01vdmVkSXRlbXMoX19uYW1lX18gKyAiLm1vdmVzIikKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKG1vdmVzLCAibW92ZXMiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3BhcnNlIiIiCgoKX3VybGxpYl9wYXJzZV9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoIlBhcnNlUmVzdWx0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlNwbGl0UmVzdWx0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInBhcnNlX3FzIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInBhcnNlX3FzbCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxkZWZyYWciLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsam9pbiIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxwYXJzZSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxzcGxpdCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmx1bnBhcnNlIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHVuc3BsaXQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicXVvdGUiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInF1b3RlX3BsdXMiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVucXVvdGUiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVucXVvdGVfcGx1cyIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsZW5jb2RlIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzcGxpdHF1ZXJ5IiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzcGxpdHRhZyIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgic3BsaXR1c2VyIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX2ZyYWdtZW50IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfbmV0bG9jIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfcGFyYW1zIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfcXVlcnkiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19yZWxhdGl2ZSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX3BhcnNlX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9wYXJzZS5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfcGFyc2VfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWJfcGFyc2UiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfcGFyc2UiLCAibW92ZXMudXJsbGliLnBhcnNlIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvcihfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9lcnJvciIiIgoKCl91cmxsaWJfZXJyb3JfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJVUkxFcnJvciIsICJ1cmxsaWIyIiwgInVybGxpYi5lcnJvciIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBFcnJvciIsICJ1cmxsaWIyIiwgInVybGxpYi5lcnJvciIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkNvbnRlbnRUb29TaG9ydEVycm9yIiwgInVybGxpYiIsICJ1cmxsaWIuZXJyb3IiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX2Vycm9yX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvci5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfZXJyb3JfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIuZXJyb3IiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfZXJyb3IiLCAibW92ZXMudXJsbGliLmVycm9yIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXF1ZXN0KF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3JlcXVlc3QiIiIKCgpfdXJsbGliX3JlcXVlc3RfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxvcGVuIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnN0YWxsX29wZW5lciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYnVpbGRfb3BlbmVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwYXRobmFtZTJ1cmwiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsMnBhdGhuYW1lIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldHByb3hpZXMiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUmVxdWVzdCIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiT3BlbmVyRGlyZWN0b3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBEZWZhdWx0RXJyb3JIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQUmVkaXJlY3RIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQQ29va2llUHJvY2Vzc29yIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJQcm94eUhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkJhc2VIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQUGFzc3dvcmRNZ3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBQYXNzd29yZE1ncldpdGhEZWZhdWx0UmVhbG0iLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkFic3RyYWN0QmFzaWNBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEJhc2ljQXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlByb3h5QmFzaWNBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQWJzdHJhY3REaWdlc3RBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUERpZ2VzdEF1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJQcm94eURpZ2VzdEF1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUFNIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJGaWxlSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiRlRQSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQ2FjaGVGVFBIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVbmtub3duSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEVycm9yUHJvY2Vzc29yIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxyZXRyaWV2ZSIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxjbGVhbnVwIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVSTG9wZW5lciIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJGYW5jeVVSTG9wZW5lciIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwcm94eV9ieXBhc3MiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9yZXF1ZXN0X21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3JlcXVlc3RfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5yZXF1ZXN0IiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3JlcXVlc3QiLCAibW92ZXMudXJsbGliLnJlcXVlc3QiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3Jlc3BvbnNlKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3Jlc3BvbnNlIiIiCgoKX3VybGxpYl9yZXNwb25zZV9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGJhc2UiLCAidXJsbGliIiwgInVybGxpYi5yZXNwb25zZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGNsb3NlaG9vayIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkaW5mbyIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkaW5mb3VybCIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9yZXNwb25zZV9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZSwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVzcG9uc2UuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3Jlc3BvbnNlX21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZShfX25hbWVfXyArICIubW92ZXMudXJsbGliLnJlc3BvbnNlIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3Jlc3BvbnNlIiwgIm1vdmVzLnVybGxpYi5yZXNwb25zZSIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfcm9ib3RwYXJzZXIiIiIKCgpfdXJsbGliX3JvYm90cGFyc2VyX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUm9ib3RGaWxlUGFyc2VyIiwgInJvYm90cGFyc2VyIiwgInVybGxpYi5yb2JvdHBhcnNlciIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfcm9ib3RwYXJzZXJfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JvYm90cGFyc2VyLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9yb2JvdHBhcnNlcl9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5yb2JvdHBhcnNlciIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9yb2JvdHBhcnNlciIsICJtb3Zlcy51cmxsaWIucm9ib3RwYXJzZXIiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliKHR5cGVzLk1vZHVsZVR5cGUpOgoKICAgICIiIkNyZWF0ZSBhIHNpeC5tb3Zlcy51cmxsaWIgbmFtZXNwYWNlIHRoYXQgcmVzZW1ibGVzIHRoZSBQeXRob24gMyBuYW1lc3BhY2UiIiIKICAgIF9fcGF0aF9fID0gW10gICMgbWFyayBhcyBwYWNrYWdlCiAgICBwYXJzZSA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3BhcnNlIikKICAgIGVycm9yID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfZXJyb3IiKQogICAgcmVxdWVzdCA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3JlcXVlc3QiKQogICAgcmVzcG9uc2UgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9yZXNwb25zZSIpCiAgICByb2JvdHBhcnNlciA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3JvYm90cGFyc2VyIikKCiAgICBkZWYgX19kaXJfXyhzZWxmKToKICAgICAgICByZXR1cm4gWydwYXJzZScsICdlcnJvcicsICdyZXF1ZXN0JywgJ3Jlc3BvbnNlJywgJ3JvYm90cGFyc2VyJ10KCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYihfX25hbWVfXyArICIubW92ZXMudXJsbGliIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliIikKCgpkZWYgYWRkX21vdmUobW92ZSk6CiAgICAiIiJBZGQgYW4gaXRlbSB0byBzaXgubW92ZXMuIiIiCiAgICBzZXRhdHRyKF9Nb3ZlZEl0ZW1zLCBtb3ZlLm5hbWUsIG1vdmUpCgoKZGVmIHJlbW92ZV9tb3ZlKG5hbWUpOgogICAgIiIiUmVtb3ZlIGl0ZW0gZnJvbSBzaXgubW92ZXMuIiIiCiAgICB0cnk6CiAgICAgICAgZGVsYXR0cihfTW92ZWRJdGVtcywgbmFtZSkKICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRlbCBtb3Zlcy5fX2RpY3RfX1tuYW1lXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcmFpc2UgQXR0cmlidXRlRXJyb3IoIm5vIHN1Y2ggbW92ZSwgJXIiICUgKG5hbWUsKSkKCgppZiBQWTM6CiAgICBfbWV0aF9mdW5jID0gIl9fZnVuY19fIgogICAgX21ldGhfc2VsZiA9ICJfX3NlbGZfXyIKCiAgICBfZnVuY19jbG9zdXJlID0gIl9fY2xvc3VyZV9fIgogICAgX2Z1bmNfY29kZSA9ICJfX2NvZGVfXyIKICAgIF9mdW5jX2RlZmF1bHRzID0gIl9fZGVmYXVsdHNfXyIKICAgIF9mdW5jX2dsb2JhbHMgPSAiX19nbG9iYWxzX18iCmVsc2U6CiAgICBfbWV0aF9mdW5jID0gImltX2Z1bmMiCiAgICBfbWV0aF9zZWxmID0gImltX3NlbGYiCgogICAgX2Z1bmNfY2xvc3VyZSA9ICJmdW5jX2Nsb3N1cmUiCiAgICBfZnVuY19jb2RlID0gImZ1bmNfY29kZSIKICAgIF9mdW5jX2RlZmF1bHRzID0gImZ1bmNfZGVmYXVsdHMiCiAgICBfZnVuY19nbG9iYWxzID0gImZ1bmNfZ2xvYmFscyIKCgp0cnk6CiAgICBhZHZhbmNlX2l0ZXJhdG9yID0gbmV4dApleGNlcHQgTmFtZUVycm9yOgogICAgZGVmIGFkdmFuY2VfaXRlcmF0b3IoaXQpOgogICAgICAgIHJldHVybiBpdC5uZXh0KCkKbmV4dCA9IGFkdmFuY2VfaXRlcmF0b3IKCgp0cnk6CiAgICBjYWxsYWJsZSA9IGNhbGxhYmxlCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICBkZWYgY2FsbGFibGUob2JqKToKICAgICAgICByZXR1cm4gYW55KCJfX2NhbGxfXyIgaW4ga2xhc3MuX19kaWN0X18gZm9yIGtsYXNzIGluIHR5cGUob2JqKS5fX21yb19fKQoKCmlmIFBZMzoKICAgIGRlZiBnZXRfdW5ib3VuZF9mdW5jdGlvbih1bmJvdW5kKToKICAgICAgICByZXR1cm4gdW5ib3VuZAoKICAgIGNyZWF0ZV9ib3VuZF9tZXRob2QgPSB0eXBlcy5NZXRob2RUeXBlCgogICAgZGVmIGNyZWF0ZV91bmJvdW5kX21ldGhvZChmdW5jLCBjbHMpOgogICAgICAgIHJldHVybiBmdW5jCgogICAgSXRlcmF0b3IgPSBvYmplY3QKZWxzZToKICAgIGRlZiBnZXRfdW5ib3VuZF9mdW5jdGlvbih1bmJvdW5kKToKICAgICAgICByZXR1cm4gdW5ib3VuZC5pbV9mdW5jCgogICAgZGVmIGNyZWF0ZV9ib3VuZF9tZXRob2QoZnVuYywgb2JqKToKICAgICAgICByZXR1cm4gdHlwZXMuTWV0aG9kVHlwZShmdW5jLCBvYmosIG9iai5fX2NsYXNzX18pCgogICAgZGVmIGNyZWF0ZV91bmJvdW5kX21ldGhvZChmdW5jLCBjbHMpOgogICAgICAgIHJldHVybiB0eXBlcy5NZXRob2RUeXBlKGZ1bmMsIE5vbmUsIGNscykKCiAgICBjbGFzcyBJdGVyYXRvcihvYmplY3QpOgoKICAgICAgICBkZWYgbmV4dChzZWxmKToKICAgICAgICAgICAgcmV0dXJuIHR5cGUoc2VsZikuX19uZXh0X18oc2VsZikKCiAgICBjYWxsYWJsZSA9IGNhbGxhYmxlCl9hZGRfZG9jKGdldF91bmJvdW5kX2Z1bmN0aW9uLAogICAgICAgICAiIiJHZXQgdGhlIGZ1bmN0aW9uIG91dCBvZiBhIHBvc3NpYmx5IHVuYm91bmQgZnVuY3Rpb24iIiIpCgoKZ2V0X21ldGhvZF9mdW5jdGlvbiA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX21ldGhfZnVuYykKZ2V0X21ldGhvZF9zZWxmID0gb3BlcmF0b3IuYXR0cmdldHRlcihfbWV0aF9zZWxmKQpnZXRfZnVuY3Rpb25fY2xvc3VyZSA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfY2xvc3VyZSkKZ2V0X2Z1bmN0aW9uX2NvZGUgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9mdW5jX2NvZGUpCmdldF9mdW5jdGlvbl9kZWZhdWx0cyA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfZGVmYXVsdHMpCmdldF9mdW5jdGlvbl9nbG9iYWxzID0gb3BlcmF0b3IuYXR0cmdldHRlcihfZnVuY19nbG9iYWxzKQoKCmlmIFBZMzoKICAgIGRlZiBpdGVya2V5cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLmtleXMoKiprdykpCgogICAgZGVmIGl0ZXJ2YWx1ZXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC52YWx1ZXMoKiprdykpCgogICAgZGVmIGl0ZXJpdGVtcyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLml0ZW1zKCoqa3cpKQoKICAgIGRlZiBpdGVybGlzdHMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC5saXN0cygqKmt3KSkKCiAgICB2aWV3a2V5cyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigia2V5cyIpCgogICAgdmlld3ZhbHVlcyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigidmFsdWVzIikKCiAgICB2aWV3aXRlbXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoIml0ZW1zIikKZWxzZToKICAgIGRlZiBpdGVya2V5cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gZC5pdGVya2V5cygqKmt3KQoKICAgIGRlZiBpdGVydmFsdWVzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJ2YWx1ZXMoKiprdykKCiAgICBkZWYgaXRlcml0ZW1zKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJpdGVtcygqKmt3KQoKICAgIGRlZiBpdGVybGlzdHMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGQuaXRlcmxpc3RzKCoqa3cpCgogICAgdmlld2tleXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZpZXdrZXlzIikKCiAgICB2aWV3dmFsdWVzID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJ2aWV3dmFsdWVzIikKCiAgICB2aWV3aXRlbXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZpZXdpdGVtcyIpCgpfYWRkX2RvYyhpdGVya2V5cywgIlJldHVybiBhbiBpdGVyYXRvciBvdmVyIHRoZSBrZXlzIG9mIGEgZGljdGlvbmFyeS4iKQpfYWRkX2RvYyhpdGVydmFsdWVzLCAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIHZhbHVlcyBvZiBhIGRpY3Rpb25hcnkuIikKX2FkZF9kb2MoaXRlcml0ZW1zLAogICAgICAgICAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIChrZXksIHZhbHVlKSBwYWlycyBvZiBhIGRpY3Rpb25hcnkuIikKX2FkZF9kb2MoaXRlcmxpc3RzLAogICAgICAgICAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIChrZXksIFt2YWx1ZXNdKSBwYWlycyBvZiBhIGRpY3Rpb25hcnkuIikKCgppZiBQWTM6CiAgICBkZWYgYihzKToKICAgICAgICByZXR1cm4gcy5lbmNvZGUoImxhdGluLTEiKQoKICAgIGRlZiB1KHMpOgogICAgICAgIHJldHVybiBzCiAgICB1bmljaHIgPSBjaHIKICAgIGltcG9ydCBzdHJ1Y3QKICAgIGludDJieXRlID0gc3RydWN0LlN0cnVjdCgiPkIiKS5wYWNrCiAgICBkZWwgc3RydWN0CiAgICBieXRlMmludCA9IG9wZXJhdG9yLml0ZW1nZXR0ZXIoMCkKICAgIGluZGV4Ynl0ZXMgPSBvcGVyYXRvci5nZXRpdGVtCiAgICBpdGVyYnl0ZXMgPSBpdGVyCiAgICBpbXBvcnQgaW8KICAgIFN0cmluZ0lPID0gaW8uU3RyaW5nSU8KICAgIEJ5dGVzSU8gPSBpby5CeXRlc0lPCiAgICBfYXNzZXJ0Q291bnRFcXVhbCA9ICJhc3NlcnRDb3VudEVxdWFsIgogICAgaWYgc3lzLnZlcnNpb25faW5mb1sxXSA8PSAxOgogICAgICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleHAiCiAgICAgICAgX2Fzc2VydFJlZ2V4ID0gImFzc2VydFJlZ2V4cE1hdGNoZXMiCiAgICBlbHNlOgogICAgICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleCIKICAgICAgICBfYXNzZXJ0UmVnZXggPSAiYXNzZXJ0UmVnZXgiCmVsc2U6CiAgICBkZWYgYihzKToKICAgICAgICByZXR1cm4gcwogICAgIyBXb3JrYXJvdW5kIGZvciBzdGFuZGFsb25lIGJhY2tzbGFzaAoKICAgIGRlZiB1KHMpOgogICAgICAgIHJldHVybiB1bmljb2RlKHMucmVwbGFjZShyJ1xcJywgcidcXFxcJyksICJ1bmljb2RlX2VzY2FwZSIpCiAgICB1bmljaHIgPSB1bmljaHIKICAgIGludDJieXRlID0gY2hyCgogICAgZGVmIGJ5dGUyaW50KGJzKToKICAgICAgICByZXR1cm4gb3JkKGJzWzBdKQoKICAgIGRlZiBpbmRleGJ5dGVzKGJ1ZiwgaSk6CiAgICAgICAgcmV0dXJuIG9yZChidWZbaV0pCiAgICBpdGVyYnl0ZXMgPSBmdW5jdG9vbHMucGFydGlhbChpdGVydG9vbHMuaW1hcCwgb3JkKQogICAgaW1wb3J0IFN0cmluZ0lPCiAgICBTdHJpbmdJTyA9IEJ5dGVzSU8gPSBTdHJpbmdJTy5TdHJpbmdJTwogICAgX2Fzc2VydENvdW50RXF1YWwgPSAiYXNzZXJ0SXRlbXNFcXVhbCIKICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleHAiCiAgICBfYXNzZXJ0UmVnZXggPSAiYXNzZXJ0UmVnZXhwTWF0Y2hlcyIKX2FkZF9kb2MoYiwgIiIiQnl0ZSBsaXRlcmFsIiIiKQpfYWRkX2RvYyh1LCAiIiJUZXh0IGxpdGVyYWwiIiIpCgoKZGVmIGFzc2VydENvdW50RXF1YWwoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgIHJldHVybiBnZXRhdHRyKHNlbGYsIF9hc3NlcnRDb3VudEVxdWFsKSgqYXJncywgKiprd2FyZ3MpCgoKZGVmIGFzc2VydFJhaXNlc1JlZ2V4KHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICByZXR1cm4gZ2V0YXR0cihzZWxmLCBfYXNzZXJ0UmFpc2VzUmVnZXgpKCphcmdzLCAqKmt3YXJncykKCgpkZWYgYXNzZXJ0UmVnZXgoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgIHJldHVybiBnZXRhdHRyKHNlbGYsIF9hc3NlcnRSZWdleCkoKmFyZ3MsICoqa3dhcmdzKQoKCmlmIFBZMzoKICAgIGV4ZWNfID0gZ2V0YXR0cihtb3Zlcy5idWlsdGlucywgImV4ZWMiKQoKICAgIGRlZiByZXJhaXNlKHRwLCB2YWx1ZSwgdGI9Tm9uZSk6CiAgICAgICAgaWYgdmFsdWUgaXMgTm9uZToKICAgICAgICAgICAgdmFsdWUgPSB0cCgpCiAgICAgICAgaWYgdmFsdWUuX190cmFjZWJhY2tfXyBpcyBub3QgdGI6CiAgICAgICAgICAgIHJhaXNlIHZhbHVlLndpdGhfdHJhY2ViYWNrKHRiKQogICAgICAgIHJhaXNlIHZhbHVlCgplbHNlOgogICAgZGVmIGV4ZWNfKF9jb2RlXywgX2dsb2JzXz1Ob25lLCBfbG9jc189Tm9uZSk6CiAgICAgICAgIiIiRXhlY3V0ZSBjb2RlIGluIGEgbmFtZXNwYWNlLiIiIgogICAgICAgIGlmIF9nbG9ic18gaXMgTm9uZToKICAgICAgICAgICAgZnJhbWUgPSBzeXMuX2dldGZyYW1lKDEpCiAgICAgICAgICAgIF9nbG9ic18gPSBmcmFtZS5mX2dsb2JhbHMKICAgICAgICAgICAgaWYgX2xvY3NfIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBfbG9jc18gPSBmcmFtZS5mX2xvY2FscwogICAgICAgICAgICBkZWwgZnJhbWUKICAgICAgICBlbGlmIF9sb2NzXyBpcyBOb25lOgogICAgICAgICAgICBfbG9jc18gPSBfZ2xvYnNfCiAgICAgICAgZXhlYygiIiJleGVjIF9jb2RlXyBpbiBfZ2xvYnNfLCBfbG9jc18iIiIpCgogICAgZXhlY18oIiIiZGVmIHJlcmFpc2UodHAsIHZhbHVlLCB0Yj1Ob25lKToKICAgIHJhaXNlIHRwLCB2YWx1ZSwgdGIKIiIiKQoKCmlmIHN5cy52ZXJzaW9uX2luZm9bOjJdID09ICgzLCAyKToKICAgIGV4ZWNfKCIiImRlZiByYWlzZV9mcm9tKHZhbHVlLCBmcm9tX3ZhbHVlKToKICAgIGlmIGZyb21fdmFsdWUgaXMgTm9uZToKICAgICAgICByYWlzZSB2YWx1ZQogICAgcmFpc2UgdmFsdWUgZnJvbSBmcm9tX3ZhbHVlCiIiIikKZWxpZiBzeXMudmVyc2lvbl9pbmZvWzoyXSA+ICgzLCAyKToKICAgIGV4ZWNfKCIiImRlZiByYWlzZV9mcm9tKHZhbHVlLCBmcm9tX3ZhbHVlKToKICAgIHJhaXNlIHZhbHVlIGZyb20gZnJvbV92YWx1ZQoiIiIpCmVsc2U6CiAgICBkZWYgcmFpc2VfZnJvbSh2YWx1ZSwgZnJvbV92YWx1ZSk6CiAgICAgICAgcmFpc2UgdmFsdWUKCgpwcmludF8gPSBnZXRhdHRyKG1vdmVzLmJ1aWx0aW5zLCAicHJpbnQiLCBOb25lKQppZiBwcmludF8gaXMgTm9uZToKICAgIGRlZiBwcmludF8oKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAiIiJUaGUgbmV3LXN0eWxlIHByaW50IGZ1bmN0aW9uIGZvciBQeXRob24gMi40IGFuZCAyLjUuIiIiCiAgICAgICAgZnAgPSBrd2FyZ3MucG9wKCJmaWxlIiwgc3lzLnN0ZG91dCkKICAgICAgICBpZiBmcCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZGVmIHdyaXRlKGRhdGEpOgogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShkYXRhLCBiYXNlc3RyaW5nKToKICAgICAgICAgICAgICAgIGRhdGEgPSBzdHIoZGF0YSkKICAgICAgICAgICAgIyBJZiB0aGUgZmlsZSBoYXMgYW4gZW5jb2RpbmcsIGVuY29kZSB1bmljb2RlIHdpdGggaXQuCiAgICAgICAgICAgIGlmIChpc2luc3RhbmNlKGZwLCBmaWxlKSBhbmQKICAgICAgICAgICAgICAgICAgICBpc2luc3RhbmNlKGRhdGEsIHVuaWNvZGUpIGFuZAogICAgICAgICAgICAgICAgICAgIGZwLmVuY29kaW5nIGlzIG5vdCBOb25lKToKICAgICAgICAgICAgICAgIGVycm9ycyA9IGdldGF0dHIoZnAsICJlcnJvcnMiLCBOb25lKQogICAgICAgICAgICAgICAgaWYgZXJyb3JzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzID0gInN0cmljdCIKICAgICAgICAgICAgICAgIGRhdGEgPSBkYXRhLmVuY29kZShmcC5lbmNvZGluZywgZXJyb3JzKQogICAgICAgICAgICBmcC53cml0ZShkYXRhKQogICAgICAgIHdhbnRfdW5pY29kZSA9IEZhbHNlCiAgICAgICAgc2VwID0ga3dhcmdzLnBvcCgic2VwIiwgTm9uZSkKICAgICAgICBpZiBzZXAgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc2VwLCB1bmljb2RlKToKICAgICAgICAgICAgICAgIHdhbnRfdW5pY29kZSA9IFRydWUKICAgICAgICAgICAgZWxpZiBub3QgaXNpbnN0YW5jZShzZXAsIHN0cik6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoInNlcCBtdXN0IGJlIE5vbmUgb3IgYSBzdHJpbmciKQogICAgICAgIGVuZCA9IGt3YXJncy5wb3AoImVuZCIsIE5vbmUpCiAgICAgICAgaWYgZW5kIGlzIG5vdCBOb25lOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGVuZCwgdW5pY29kZSk6CiAgICAgICAgICAgICAgICB3YW50X3VuaWNvZGUgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2UoZW5kLCBzdHIpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJlbmQgbXVzdCBiZSBOb25lIG9yIGEgc3RyaW5nIikKICAgICAgICBpZiBrd2FyZ3M6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiaW52YWxpZCBrZXl3b3JkIGFyZ3VtZW50cyB0byBwcmludCgpIikKICAgICAgICBpZiBub3Qgd2FudF91bmljb2RlOgogICAgICAgICAgICBmb3IgYXJnIGluIGFyZ3M6CiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGFyZywgdW5pY29kZSk6CiAgICAgICAgICAgICAgICAgICAgd2FudF91bmljb2RlID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgaWYgd2FudF91bmljb2RlOgogICAgICAgICAgICBuZXdsaW5lID0gdW5pY29kZSgiXG4iKQogICAgICAgICAgICBzcGFjZSA9IHVuaWNvZGUoIiAiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG5ld2xpbmUgPSAiXG4iCiAgICAgICAgICAgIHNwYWNlID0gIiAiCiAgICAgICAgaWYgc2VwIGlzIE5vbmU6CiAgICAgICAgICAgIHNlcCA9IHNwYWNlCiAgICAgICAgaWYgZW5kIGlzIE5vbmU6CiAgICAgICAgICAgIGVuZCA9IG5ld2xpbmUKICAgICAgICBmb3IgaSwgYXJnIGluIGVudW1lcmF0ZShhcmdzKToKICAgICAgICAgICAgaWYgaToKICAgICAgICAgICAgICAgIHdyaXRlKHNlcCkKICAgICAgICAgICAgd3JpdGUoYXJnKQogICAgICAgIHdyaXRlKGVuZCkKaWYgc3lzLnZlcnNpb25faW5mb1s6Ml0gPCAoMywgMyk6CiAgICBfcHJpbnQgPSBwcmludF8KCiAgICBkZWYgcHJpbnRfKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgZnAgPSBrd2FyZ3MuZ2V0KCJmaWxlIiwgc3lzLnN0ZG91dCkKICAgICAgICBmbHVzaCA9IGt3YXJncy5wb3AoImZsdXNoIiwgRmFsc2UpCiAgICAgICAgX3ByaW50KCphcmdzLCAqKmt3YXJncykKICAgICAgICBpZiBmbHVzaCBhbmQgZnAgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGZwLmZsdXNoKCkKCl9hZGRfZG9jKHJlcmFpc2UsICIiIlJlcmFpc2UgYW4gZXhjZXB0aW9uLiIiIikKCmlmIHN5cy52ZXJzaW9uX2luZm9bMDoyXSA8ICgzLCA0KToKICAgIGRlZiB3cmFwcyh3cmFwcGVkLCBhc3NpZ25lZD1mdW5jdG9vbHMuV1JBUFBFUl9BU1NJR05NRU5UUywKICAgICAgICAgICAgICB1cGRhdGVkPWZ1bmN0b29scy5XUkFQUEVSX1VQREFURVMpOgogICAgICAgIGRlZiB3cmFwcGVyKGYpOgogICAgICAgICAgICBmID0gZnVuY3Rvb2xzLndyYXBzKHdyYXBwZWQsIGFzc2lnbmVkLCB1cGRhdGVkKShmKQogICAgICAgICAgICBmLl9fd3JhcHBlZF9fID0gd3JhcHBlZAogICAgICAgICAgICByZXR1cm4gZgogICAgICAgIHJldHVybiB3cmFwcGVyCmVsc2U6CiAgICB3cmFwcyA9IGZ1bmN0b29scy53cmFwcwoKCmRlZiB3aXRoX21ldGFjbGFzcyhtZXRhLCAqYmFzZXMpOgogICAgIiIiQ3JlYXRlIGEgYmFzZSBjbGFzcyB3aXRoIGEgbWV0YWNsYXNzLiIiIgogICAgIyBUaGlzIHJlcXVpcmVzIGEgYml0IG9mIGV4cGxhbmF0aW9uOiB0aGUgYmFzaWMgaWRlYSBpcyB0byBtYWtlIGEgZHVtbXkKICAgICMgbWV0YWNsYXNzIGZvciBvbmUgbGV2ZWwgb2YgY2xhc3MgaW5zdGFudGlhdGlvbiB0aGF0IHJlcGxhY2VzIGl0c2VsZiB3aXRoCiAgICAjIHRoZSBhY3R1YWwgbWV0YWNsYXNzLgogICAgY2xhc3MgbWV0YWNsYXNzKG1ldGEpOgoKICAgICAgICBkZWYgX19uZXdfXyhjbHMsIG5hbWUsIHRoaXNfYmFzZXMsIGQpOgogICAgICAgICAgICByZXR1cm4gbWV0YShuYW1lLCBiYXNlcywgZCkKICAgIHJldHVybiB0eXBlLl9fbmV3X18obWV0YWNsYXNzLCAndGVtcG9yYXJ5X2NsYXNzJywgKCksIHt9KQoKCmRlZiBhZGRfbWV0YWNsYXNzKG1ldGFjbGFzcyk6CiAgICAiIiJDbGFzcyBkZWNvcmF0b3IgZm9yIGNyZWF0aW5nIGEgY2xhc3Mgd2l0aCBhIG1ldGFjbGFzcy4iIiIKICAgIGRlZiB3cmFwcGVyKGNscyk6CiAgICAgICAgb3JpZ192YXJzID0gY2xzLl9fZGljdF9fLmNvcHkoKQogICAgICAgIHNsb3RzID0gb3JpZ192YXJzLmdldCgnX19zbG90c19fJykKICAgICAgICBpZiBzbG90cyBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzbG90cywgc3RyKToKICAgICAgICAgICAgICAgIHNsb3RzID0gW3Nsb3RzXQogICAgICAgICAgICBmb3Igc2xvdHNfdmFyIGluIHNsb3RzOgogICAgICAgICAgICAgICAgb3JpZ192YXJzLnBvcChzbG90c192YXIpCiAgICAgICAgb3JpZ192YXJzLnBvcCgnX19kaWN0X18nLCBOb25lKQogICAgICAgIG9yaWdfdmFycy5wb3AoJ19fd2Vha3JlZl9fJywgTm9uZSkKICAgICAgICByZXR1cm4gbWV0YWNsYXNzKGNscy5fX25hbWVfXywgY2xzLl9fYmFzZXNfXywgb3JpZ192YXJzKQogICAgcmV0dXJuIHdyYXBwZXIKCgpkZWYgcHl0aG9uXzJfdW5pY29kZV9jb21wYXRpYmxlKGtsYXNzKToKICAgICIiIgogICAgQSBkZWNvcmF0b3IgdGhhdCBkZWZpbmVzIF9fdW5pY29kZV9fIGFuZCBfX3N0cl9fIG1ldGhvZHMgdW5kZXIgUHl0aG9uIDIuCiAgICBVbmRlciBQeXRob24gMyBpdCBkb2VzIG5vdGhpbmcuCgogICAgVG8gc3VwcG9ydCBQeXRob24gMiBhbmQgMyB3aXRoIGEgc2luZ2xlIGNvZGUgYmFzZSwgZGVmaW5lIGEgX19zdHJfXyBtZXRob2QKICAgIHJldHVybmluZyB0ZXh0IGFuZCBhcHBseSB0aGlzIGRlY29yYXRvciB0byB0aGUgY2xhc3MuCiAgICAiIiIKICAgIGlmIFBZMjoKICAgICAgICBpZiAnX19zdHJfXycgbm90IGluIGtsYXNzLl9fZGljdF9fOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJAcHl0aG9uXzJfdW5pY29kZV9jb21wYXRpYmxlIGNhbm5vdCBiZSBhcHBsaWVkICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidG8gJXMgYmVjYXVzZSBpdCBkb2Vzbid0IGRlZmluZSBfX3N0cl9fKCkuIiAlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2xhc3MuX19uYW1lX18pCiAgICAgICAga2xhc3MuX191bmljb2RlX18gPSBrbGFzcy5fX3N0cl9fCiAgICAgICAga2xhc3MuX19zdHJfXyA9IGxhbWJkYSBzZWxmOiBzZWxmLl9fdW5pY29kZV9fKCkuZW5jb2RlKCd1dGYtOCcpCiAgICByZXR1cm4ga2xhc3MKCgojIENvbXBsZXRlIHRoZSBtb3ZlcyBpbXBsZW1lbnRhdGlvbi4KIyBUaGlzIGNvZGUgaXMgYXQgdGhlIGVuZCBvZiB0aGlzIG1vZHVsZSB0byBzcGVlZCB1cCBtb2R1bGUgbG9hZGluZy4KIyBUdXJuIHRoaXMgbW9kdWxlIGludG8gYSBwYWNrYWdlLgpfX3BhdGhfXyA9IFtdICAjIHJlcXVpcmVkIGZvciBQRVAgMzAyIGFuZCBQRVAgNDUxCl9fcGFja2FnZV9fID0gX19uYW1lX18gICMgc2VlIFBFUCAzNjYgQFJlc2VydmVkQXNzaWdubWVudAppZiBnbG9iYWxzKCkuZ2V0KCJfX3NwZWNfXyIpIGlzIG5vdCBOb25lOgogICAgX19zcGVjX18uc3VibW9kdWxlX3NlYXJjaF9sb2NhdGlvbnMgPSBbXSAgIyBQRVAgNDUxIEBVbmRlZmluZWRWYXJpYWJsZQojIFJlbW92ZSBvdGhlciBzaXggbWV0YSBwYXRoIGltcG9ydGVycywgc2luY2UgdGhleSBjYXVzZSBwcm9ibGVtcy4gVGhpcyBjYW4KIyBoYXBwZW4gaWYgc2l4IGlzIHJlbW92ZWQgZnJvbSBzeXMubW9kdWxlcyBhbmQgdGhlbiByZWxvYWRlZC4gKFNldHVwdG9vbHMgZG9lcwojIHRoaXMgZm9yIHNvbWUgcmVhc29uLikKaWYgc3lzLm1ldGFfcGF0aDoKICAgIGZvciBpLCBpbXBvcnRlciBpbiBlbnVtZXJhdGUoc3lzLm1ldGFfcGF0aCk6CiAgICAgICAgIyBIZXJlJ3Mgc29tZSByZWFsIG5hc3RpbmVzczogQW5vdGhlciAiaW5zdGFuY2UiIG9mIHRoZSBzaXggbW9kdWxlIG1pZ2h0CiAgICAgICAgIyBiZSBmbG9hdGluZyBhcm91bmQuIFRoZXJlZm9yZSwgd2UgY2FuJ3QgdXNlIGlzaW5zdGFuY2UoKSB0byBjaGVjayBmb3IKICAgICAgICAjIHRoZSBzaXggbWV0YSBwYXRoIGltcG9ydGVyLCBzaW5jZSB0aGUgb3RoZXIgc2l4IGluc3RhbmNlIHdpbGwgaGF2ZQogICAgICAgICMgaW5zZXJ0ZWQgYW4gaW1wb3J0ZXIgd2l0aCBkaWZmZXJlbnQgY2xhc3MuCiAgICAgICAgaWYgKHR5cGUoaW1wb3J0ZXIpLl9fbmFtZV9fID09ICJfU2l4TWV0YVBhdGhJbXBvcnRlciIgYW5kCiAgICAgICAgICAgICAgICBpbXBvcnRlci5uYW1lID09IF9fbmFtZV9fKToKICAgICAgICAgICAgZGVsIHN5cy5tZXRhX3BhdGhbaV0KICAgICAgICAgICAgYnJlYWsKICAgIGRlbCBpLCBpbXBvcnRlcgojIEZpbmFsbHksIGFkZCB0aGUgaW1wb3J0ZXIgdG8gdGhlIG1ldGEgcGF0aCBpbXBvcnQgaG9vay4Kc3lzLm1ldGFfcGF0aC5hcHBlbmQoX2ltcG9ydGVyKQpQSwMEFAAAAAAAy7srS+x77AGnCAAApwgAACUAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy90aW1lb3V0LnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCBzaWduYWwKCiMgdGltZW91dCBmdW5jdGlvbiB0byBtYWtlIHN1cmUgc29tZSBmYWN0IGdhdGhlcmluZwojIHN0ZXBzIGRvIG5vdCBleGNlZWQgYSB0aW1lIGxpbWl0CgpHQVRIRVJfVElNRU9VVCA9IE5vbmUKREVGQVVMVF9HQVRIRVJfVElNRU9VVCA9IDEwCgoKY2xhc3MgVGltZW91dEVycm9yKEV4Y2VwdGlvbik6CiAgICBwYXNzCgoKZGVmIHRpbWVvdXQoc2Vjb25kcz1Ob25lLCBlcnJvcl9tZXNzYWdlPSJUaW1lciBleHBpcmVkIik6CgogICAgZGVmIGRlY29yYXRvcihmdW5jKToKICAgICAgICBkZWYgX2hhbmRsZV90aW1lb3V0KHNpZ251bSwgZnJhbWUpOgogICAgICAgICAgICBtc2cgPSAnVGltZXIgZXhwaXJlZCBhZnRlciAlcyBzZWNvbmRzJyAlIGdsb2JhbHMoKS5nZXQoJ0dBVEhFUl9USU1FT1VUJykKICAgICAgICAgICAgcmFpc2UgVGltZW91dEVycm9yKG1zZykKCiAgICAgICAgZGVmIHdyYXBwZXIoKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAgICAgbG9jYWxfc2Vjb25kcyA9IHNlY29uZHMKICAgICAgICAgICAgaWYgbG9jYWxfc2Vjb25kcyBpcyBOb25lOgogICAgICAgICAgICAgICAgbG9jYWxfc2Vjb25kcyA9IGdsb2JhbHMoKS5nZXQoJ0dBVEhFUl9USU1FT1VUJykgb3IgREVGQVVMVF9HQVRIRVJfVElNRU9VVAogICAgICAgICAgICBzaWduYWwuc2lnbmFsKHNpZ25hbC5TSUdBTFJNLCBfaGFuZGxlX3RpbWVvdXQpCiAgICAgICAgICAgIHNpZ25hbC5hbGFybShsb2NhbF9zZWNvbmRzKQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYygqYXJncywgKiprd2FyZ3MpCiAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICBzaWduYWwuYWxhcm0oMCkKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdAoKICAgICAgICByZXR1cm4gd3JhcHBlcgoKICAgICMgSWYgd2Ugd2VyZSBjYWxsZWQgYXMgQHRpbWVvdXQsIHRoZW4gdGhlIGZpcnN0IHBhcmFtZXRlciB3aWxsIGJlIHRoZQogICAgIyBmdW5jdGlvbiB3ZSBhcmUgdG8gd3JhcCBpbnN0ZWFkIG9mIHRoZSBudW1iZXIgb2Ygc2Vjb25kcy4gIERldGVjdCB0aGlzCiAgICAjIGFuZCBjb3JyZWN0IGl0IGJ5IHNldHRpbmcgc2Vjb25kcyB0byBvdXIgZGVmYXVsdCB2YWx1ZSBhbmQgcmV0dXJuIHRoZQogICAgIyBpbm5lciBkZWNvcmF0b3IgZnVuY3Rpb24gbWFudWFsbHkgd3JhcHBlZCBhcm91bmQgdGhlIGZ1bmN0aW9uCiAgICBpZiBjYWxsYWJsZShzZWNvbmRzKToKICAgICAgICBmdW5jID0gc2Vjb25kcwogICAgICAgIHNlY29uZHMgPSBOb25lCiAgICAgICAgcmV0dXJuIGRlY29yYXRvcihmdW5jKQoKICAgICMgSWYgd2Ugd2VyZSBjYWxsZWQgYXMgQHRpbWVvdXQoWy4uLl0pIHRoZW4gcHl0aG9uIGl0c2VsZiB3aWxsIHRha2UKICAgICMgY2FyZSBvZiB3cmFwcGluZyB0aGUgaW5uZXIgZGVjb3JhdG9yIGFyb3VuZCB0aGUgZnVuY3Rpb24KCiAgICByZXR1cm4gZGVjb3JhdG9yClBLAwQUAAAAAADLuytLmyySgaYEAACmBAAALQAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL25ldHdvcmsvZnJlZWJzZC5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLm5ldHdvcmsuYmFzZSBpbXBvcnQgTmV0d29ya0NvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLm5ldHdvcmsuZ2VuZXJpY19ic2QgaW1wb3J0IEdlbmVyaWNCc2RJZmNvbmZpZ05ldHdvcmsKCgpjbGFzcyBGcmVlQlNETmV0d29yayhHZW5lcmljQnNkSWZjb25maWdOZXR3b3JrKToKICAgICIiIgogICAgVGhpcyBpcyB0aGUgRnJlZUJTRCBOZXR3b3JrIENsYXNzLgogICAgSXQgdXNlcyB0aGUgR2VuZXJpY0JzZElmY29uZmlnTmV0d29yayB1bmNoYW5nZWQuCiAgICAiIiIKICAgIHBsYXRmb3JtID0gJ0ZyZWVCU0QnCgoKY2xhc3MgRnJlZUJTRE5ldHdvcmtDb2xsZWN0b3IoTmV0d29ya0NvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IEZyZWVCU0ROZXR3b3JrCiAgICBfcGxhdGZvcm0gPSAnRnJlZUJTRCcKUEsDBBQAAAAAAMu7K0uks+lbDwkAAA8JAAAtAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvdmlydHVhbC9vcGVuYnNkLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCByZQoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy52aXJ0dWFsLmJhc2UgaW1wb3J0IFZpcnR1YWwsIFZpcnR1YWxDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy52aXJ0dWFsLnN5c2N0bCBpbXBvcnQgVmlydHVhbFN5c2N0bERldGVjdGlvbk1peGluCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnV0aWxzIGltcG9ydCBnZXRfZmlsZV9jb250ZW50CgoKY2xhc3MgT3BlbkJTRFZpcnR1YWwoVmlydHVhbCwgVmlydHVhbFN5c2N0bERldGVjdGlvbk1peGluKToKICAgICIiIgogICAgVGhpcyBpcyBhIE9wZW5CU0Qtc3BlY2lmaWMgc3ViY2xhc3Mgb2YgVmlydHVhbC4gIEl0IGRlZmluZXMKICAgIC0gdmlydHVhbGl6YXRpb25fdHlwZQogICAgLSB2aXJ0dWFsaXphdGlvbl9yb2xlCiAgICAiIiIKICAgIHBsYXRmb3JtID0gJ09wZW5CU0QnCiAgICBETUVTR19CT09UID0gJy92YXIvcnVuL2RtZXNnLmJvb3QnCgogICAgZGVmIGdldF92aXJ0dWFsX2ZhY3RzKHNlbGYpOgogICAgICAgIHZpcnR1YWxfZmFjdHMgPSB7fQoKICAgICAgICAjIFNldCBlbXB0eSB2YWx1ZXMgYXMgZGVmYXVsdAogICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICcnCiAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJycKCiAgICAgICAgdmlydHVhbF9wcm9kdWN0X2ZhY3RzID0gc2VsZi5kZXRlY3RfdmlydF9wcm9kdWN0KCdody5wcm9kdWN0JykKICAgICAgICB2aXJ0dWFsX2ZhY3RzLnVwZGF0ZSh2aXJ0dWFsX3Byb2R1Y3RfZmFjdHMpCgogICAgICAgIGlmIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9PSAnJzoKICAgICAgICAgICAgdmlydHVhbF92ZW5kb3JfZmFjdHMgPSBzZWxmLmRldGVjdF92aXJ0X3ZlbmRvcignaHcudmVuZG9yJykKICAgICAgICAgICAgdmlydHVhbF9mYWN0cy51cGRhdGUodmlydHVhbF92ZW5kb3JfZmFjdHMpCgogICAgICAgICMgQ2hlY2sgdGhlIGRtZXNnIGlmIHZtbSg0KSBhdHRhY2hlZCwgaW5kaWNhdGluZyB0aGUgaG9zdCBpcwogICAgICAgICMgY2FwYWJsZSBvZiB2aXJ0dWFsaXphdGlvbi4KICAgICAgICBkbWVzZ19ib290ID0gZ2V0X2ZpbGVfY29udGVudChPcGVuQlNEVmlydHVhbC5ETUVTR19CT09UKQogICAgICAgIGZvciBsaW5lIGluIGRtZXNnX2Jvb3Quc3BsaXRsaW5lcygpOgogICAgICAgICAgICBtYXRjaCA9IHJlLm1hdGNoKCdedm1tMCBhdCBtYWluYnVzMDogKFNWTS9SVkl8Vk1YL0VQVCkkJywgbGluZSkKICAgICAgICAgICAgaWYgbWF0Y2g6CiAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAndm1tJwogICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2hvc3QnCgogICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgoKY2xhc3MgT3BlbkJTRFZpcnR1YWxDb2xsZWN0b3IoVmlydHVhbENvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IE9wZW5CU0RWaXJ0dWFsCiAgICBfcGxhdGZvcm0gPSAnT3BlbkJTRCcKUEsDBBQAAAAAAMu7K0sENcvoYgkAAGIJAAAqAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvbmV0d29yay9iYXNlLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuY29sbGVjdG9yIGltcG9ydCBCYXNlRmFjdENvbGxlY3RvcgoKCmNsYXNzIE5ldHdvcms6CiAgICAiIiIKICAgIFRoaXMgaXMgYSBnZW5lcmljIE5ldHdvcmsgc3ViY2xhc3Mgb2YgRmFjdHMuICBUaGlzIHNob3VsZCBiZSBmdXJ0aGVyCiAgICBzdWJjbGFzc2VkIHRvIGltcGxlbWVudCBwZXIgcGxhdGZvcm0uICBJZiB5b3Ugc3ViY2xhc3MgdGhpcywKICAgIHlvdSBtdXN0IGRlZmluZToKICAgIC0gaW50ZXJmYWNlcyAoYSBsaXN0IG9mIGludGVyZmFjZSBuYW1lcykKICAgIC0gaW50ZXJmYWNlXzxuYW1lPiBkaWN0aW9uYXJ5IG9mIGlwdjQsIGlwdjYsIGFuZCBtYWMgYWRkcmVzcyBpbmZvcm1hdGlvbi4KCiAgICBBbGwgc3ViY2xhc3NlcyBNVVNUIGRlZmluZSBwbGF0Zm9ybS4KICAgICIiIgogICAgcGxhdGZvcm0gPSAnR2VuZXJpYycKCiAgICAjIEZJWE1FOiByZW1vdmUgbG9hZF9vbl9pbml0IHdoZW4gd2UgY2FuCiAgICBkZWYgX19pbml0X18oc2VsZiwgbW9kdWxlLCBsb2FkX29uX2luaXQ9RmFsc2UpOgogICAgICAgIHNlbGYubW9kdWxlID0gbW9kdWxlCgogICAgIyBUT0RPOiBtb3JlIG9yIGxlc3MgYWJzdHJhY3QvTm90SW1wbGVtZW50ZWQKICAgIGRlZiBwb3B1bGF0ZShzZWxmLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgcmV0dXJuIHt9CgoKY2xhc3MgTmV0d29ya0NvbGxlY3RvcihCYXNlRmFjdENvbGxlY3Rvcik6CiAgICAjIE1BWUJFOiB3ZSBjb3VsZCB0cnkgdG8gYnVpbGQgdGhpcyBiYXNlZCBvbiB0aGUgYXJjaCBzcGVjaWZpYyBpbXBsZW1lbWVudGF0aW9uIG9mIE5ldHdvcmsoKSBvciBpdHMga2luCiAgICBuYW1lID0gJ25ldHdvcmsnCiAgICBfZmFjdF9jbGFzcyA9IE5ldHdvcmsKICAgIF9mYWN0X2lkcyA9IHNldChbJ2ludGVyZmFjZXMnLAogICAgICAgICAgICAgICAgICAgICAnZGVmYXVsdF9pcHY0JywKICAgICAgICAgICAgICAgICAgICAgJ2RlZmF1bHRfaXB2NicsCiAgICAgICAgICAgICAgICAgICAgICdhbGxfaXB2NF9hZGRyZXNzZXMnLAogICAgICAgICAgICAgICAgICAgICAnYWxsX2lwdjZfYWRkcmVzc2VzJ10pCgogICAgSVBWNl9TQ09QRSA9IHsnMCc6ICdnbG9iYWwnLAogICAgICAgICAgICAgICAgICAnMTAnOiAnaG9zdCcsCiAgICAgICAgICAgICAgICAgICcyMCc6ICdsaW5rJywKICAgICAgICAgICAgICAgICAgJzQwJzogJ2FkbWluJywKICAgICAgICAgICAgICAgICAgJzUwJzogJ3NpdGUnLAogICAgICAgICAgICAgICAgICAnODAnOiAnb3JnYW5pemF0aW9uJ30KCiAgICBkZWYgY29sbGVjdChzZWxmLCBtb2R1bGU9Tm9uZSwgY29sbGVjdGVkX2ZhY3RzPU5vbmUpOgogICAgICAgIGNvbGxlY3RlZF9mYWN0cyA9IGNvbGxlY3RlZF9mYWN0cyBvciB7fQogICAgICAgIGlmIG5vdCBtb2R1bGU6CiAgICAgICAgICAgIHJldHVybiB7fQoKICAgICAgICAjIE5ldHdvcmsgbXVuZ2VzIGNhY2hlZF9mYWN0cyBieSBzaWRlIGVmZmVjdCwgc28gZ2l2ZSBpdCBhIGNvcHkKICAgICAgICBmYWN0c19vYmogPSBzZWxmLl9mYWN0X2NsYXNzKG1vZHVsZSkKCiAgICAgICAgZmFjdHNfZGljdCA9IGZhY3RzX29iai5wb3B1bGF0ZShjb2xsZWN0ZWRfZmFjdHM9Y29sbGVjdGVkX2ZhY3RzKQoKICAgICAgICByZXR1cm4gZmFjdHNfZGljdApQSwMEFAAAAAAAy7srS75PIo9CBAAAQgQAADAAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9oYXJkd2FyZS9kcmFnb25mbHkucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5oYXJkd2FyZS5iYXNlIGltcG9ydCBIYXJkd2FyZUNvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmhhcmR3YXJlLmZyZWVic2QgaW1wb3J0IEZyZWVCU0RIYXJkd2FyZQoKCmNsYXNzIERyYWdvbkZseUhhcmR3YXJlQ29sbGVjdG9yKEhhcmR3YXJlQ29sbGVjdG9yKToKICAgICMgTm90ZTogVGhpcyB1c2VzIHRoZSBmcmVlYnNkIGZhY3QgY2xhc3MsIHRoZXJlIGlzIG5vIGRyYWdvbmZseSBoYXJkd2FyZSBmYWN0IGNsYXNzCiAgICBfZmFjdF9jbGFzcyA9IEZyZWVCU0RIYXJkd2FyZQogICAgX3BsYXRmb3JtID0gJ0RyYWdvbkZseScKUEsDBBQAAAAAAMu7K0tLu2L2sgQAALIEAAAvAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvbmV0d29yay9kcmFnb25mbHkucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5uZXR3b3JrLmJhc2UgaW1wb3J0IE5ldHdvcmtDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5uZXR3b3JrLmdlbmVyaWNfYnNkIGltcG9ydCBHZW5lcmljQnNkSWZjb25maWdOZXR3b3JrCgoKY2xhc3MgRHJhZ29uRmx5TmV0d29yayhHZW5lcmljQnNkSWZjb25maWdOZXR3b3JrKToKICAgICIiIgogICAgVGhpcyBpcyB0aGUgRHJhZ29uRmx5IE5ldHdvcmsgQ2xhc3MuCiAgICBJdCB1c2VzIHRoZSBHZW5lcmljQnNkSWZjb25maWdOZXR3b3JrIHVuY2hhbmdlZC4KICAgICIiIgogICAgcGxhdGZvcm0gPSAnRHJhZ29uRmx5JwoKCmNsYXNzIERyYWdvbkZseU5ldHdvcmtDb2xsZWN0b3IoTmV0d29ya0NvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IERyYWdvbkZseU5ldHdvcmsKICAgIF9wbGF0Zm9ybSA9ICdEcmFnb25GbHknClBLAwQUAAAAAADLuytLn1krLAwiAAAMIgAAKgAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL2hhcmR3YXJlL2FpeC5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgppbXBvcnQgcmUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUuYmFzZSBpbXBvcnQgSGFyZHdhcmUsIEhhcmR3YXJlQ29sbGVjdG9yCgoKY2xhc3MgQUlYSGFyZHdhcmUoSGFyZHdhcmUpOgogICAgIiIiCiAgICBBSVgtc3BlY2lmaWMgc3ViY2xhc3Mgb2YgSGFyZHdhcmUuICBEZWZpbmVzIG1lbW9yeSBhbmQgQ1BVIGZhY3RzOgogICAgLSBtZW1mcmVlX21iCiAgICAtIG1lbXRvdGFsX21iCiAgICAtIHN3YXBmcmVlX21iCiAgICAtIHN3YXB0b3RhbF9tYgogICAgLSBwcm9jZXNzb3IgKGEgbGlzdCkKICAgIC0gcHJvY2Vzc29yX2NvcmVzCiAgICAtIHByb2Nlc3Nvcl9jb3VudAogICAgIiIiCiAgICBwbGF0Zm9ybSA9ICdBSVgnCgogICAgZGVmIHBvcHVsYXRlKHNlbGYsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBoYXJkd2FyZV9mYWN0cyA9IHt9CgogICAgICAgIGNwdV9mYWN0cyA9IHNlbGYuZ2V0X2NwdV9mYWN0cygpCiAgICAgICAgbWVtb3J5X2ZhY3RzID0gc2VsZi5nZXRfbWVtb3J5X2ZhY3RzKCkKICAgICAgICBkbWlfZmFjdHMgPSBzZWxmLmdldF9kbWlfZmFjdHMoKQogICAgICAgIHZnc19mYWN0cyA9IHNlbGYuZ2V0X3Znc19mYWN0cygpCiAgICAgICAgbW91bnRfZmFjdHMgPSBzZWxmLmdldF9tb3VudF9mYWN0cygpCgogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShjcHVfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKG1lbW9yeV9mYWN0cykKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUoZG1pX2ZhY3RzKQogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZSh2Z3NfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKG1vdW50X2ZhY3RzKQoKICAgICAgICByZXR1cm4gaGFyZHdhcmVfZmFjdHMKCiAgICBkZWYgZ2V0X2NwdV9mYWN0cyhzZWxmKToKICAgICAgICBjcHVfZmFjdHMgPSB7fQogICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yJ10gPSBbXQoKICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiL3Vzci9zYmluL2xzZGV2IC1DYyBwcm9jZXNzb3IiKQogICAgICAgIGlmIG91dDoKICAgICAgICAgICAgaSA9IDAKICAgICAgICAgICAgZm9yIGxpbmUgaW4gb3V0LnNwbGl0bGluZXMoKToKCiAgICAgICAgICAgICAgICBpZiAnQXZhaWxhYmxlJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgIGlmIGkgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3BsaXQoJyAnKQogICAgICAgICAgICAgICAgICAgICAgICBjcHVkZXYgPSBkYXRhWzBdCgogICAgICAgICAgICAgICAgICAgIGkgKz0gMQogICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3VudCddID0gaW50KGkpCgogICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiL3Vzci9zYmluL2xzYXR0ciAtRWwgIiArIGNwdWRldiArICIgLWEgdHlwZSIpCgogICAgICAgICAgICBkYXRhID0gb3V0LnNwbGl0KCcgJykKICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3InXSA9IGRhdGFbMV0KCiAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvdXNyL3NiaW4vbHNhdHRyIC1FbCAiICsgY3B1ZGV2ICsgIiAtYSBzbXRfdGhyZWFkcyIpCgogICAgICAgICAgICBkYXRhID0gb3V0LnNwbGl0KCcgJykKICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY29yZXMnXSA9IGludChkYXRhWzFdKQoKICAgICAgICByZXR1cm4gY3B1X2ZhY3RzCgogICAgZGVmIGdldF9tZW1vcnlfZmFjdHMoc2VsZik6CiAgICAgICAgbWVtb3J5X2ZhY3RzID0ge30KICAgICAgICBwYWdlc2l6ZSA9IDQwOTYKICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiL3Vzci9iaW4vdm1zdGF0IC12IikKICAgICAgICBmb3IgbGluZSBpbiBvdXQuc3BsaXRsaW5lcygpOgogICAgICAgICAgICBkYXRhID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgIGlmICdtZW1vcnkgcGFnZXMnIGluIGxpbmU6CiAgICAgICAgICAgICAgICBwYWdlY291bnQgPSBpbnQoZGF0YVswXSkKICAgICAgICAgICAgaWYgJ2ZyZWUgcGFnZXMnIGluIGxpbmU6CiAgICAgICAgICAgICAgICBmcmVlY291bnQgPSBpbnQoZGF0YVswXSkKICAgICAgICBtZW1vcnlfZmFjdHNbJ21lbXRvdGFsX21iJ10gPSBwYWdlc2l6ZSAqIHBhZ2Vjb3VudCAvLyAxMDI0IC8vIDEwMjQKICAgICAgICBtZW1vcnlfZmFjdHNbJ21lbWZyZWVfbWInXSA9IHBhZ2VzaXplICogZnJlZWNvdW50IC8vIDEwMjQgLy8gMTAyNAogICAgICAgICMgR2V0IHN3YXBpbmZvLiAgc3dhcGluZm8gb3V0cHV0IGxvb2tzIGxpa2U6CiAgICAgICAgIyBEZXZpY2UgICAgICAgICAgMU0tYmxvY2tzICAgICBVc2VkICAgIEF2YWlsIENhcGFjaXR5CiAgICAgICAgIyAvZGV2L2FkYTBwMyAgICAgICAgMzE0MzY4ICAgICAgICAwICAgMzE0MzY4ICAgICAwJQogICAgICAgICMKICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiL3Vzci9zYmluL2xzcHMgLXMiKQogICAgICAgIGlmIG91dDoKICAgICAgICAgICAgbGluZXMgPSBvdXQuc3BsaXRsaW5lcygpCiAgICAgICAgICAgIGRhdGEgPSBsaW5lc1sxXS5zcGxpdCgpCiAgICAgICAgICAgIHN3YXB0b3RhbF9tYiA9IGludChkYXRhWzBdLnJzdHJpcCgnTUInKSkKICAgICAgICAgICAgcGVyY3VzZWQgPSBpbnQoZGF0YVsxXS5yc3RyaXAoJyUnKSkKICAgICAgICAgICAgbWVtb3J5X2ZhY3RzWydzd2FwdG90YWxfbWInXSA9IHN3YXB0b3RhbF9tYgogICAgICAgICAgICBtZW1vcnlfZmFjdHNbJ3N3YXBmcmVlX21iJ10gPSBpbnQoc3dhcHRvdGFsX21iICogKDEwMCAtIHBlcmN1c2VkKSAvIDEwMCkKCiAgICAgICAgcmV0dXJuIG1lbW9yeV9mYWN0cwoKICAgIGRlZiBnZXRfZG1pX2ZhY3RzKHNlbGYpOgogICAgICAgIGRtaV9mYWN0cyA9IHt9CgogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvdXNyL3NiaW4vbHNhdHRyIC1FbCBzeXMwIC1hIGZ3dmVyc2lvbiIpCiAgICAgICAgZGF0YSA9IG91dC5zcGxpdCgpCiAgICAgICAgZG1pX2ZhY3RzWydmaXJtd2FyZV92ZXJzaW9uJ10gPSBkYXRhWzFdLnN0cmlwKCdJQk0sJykKICAgICAgICBsc2NvbmZfcGF0aCA9IHNlbGYubW9kdWxlLmdldF9iaW5fcGF0aCgibHNjb25mIikKICAgICAgICBpZiBsc2NvbmZfcGF0aDoKICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQobHNjb25mX3BhdGgpCiAgICAgICAgICAgIGlmIHJjID09IDAgYW5kIG91dDoKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIG91dC5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3BsaXQoJzonKQogICAgICAgICAgICAgICAgICAgIGlmICdNYWNoaW5lIFNlcmlhbCBOdW1iZXInIGluIGxpbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIGRtaV9mYWN0c1sncHJvZHVjdF9zZXJpYWwnXSA9IGRhdGFbMV0uc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIGlmICdMUEFSIEluZm8nIGluIGxpbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIGRtaV9mYWN0c1snbHBhcl9pbmZvJ10gPSBkYXRhWzFdLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiAnU3lzdGVtIE1vZGVsJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICBkbWlfZmFjdHNbJ3Byb2R1Y3RfbmFtZSddID0gZGF0YVsxXS5zdHJpcCgpCiAgICAgICAgcmV0dXJuIGRtaV9mYWN0cwoKICAgIGRlZiBnZXRfdmdzX2ZhY3RzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEdldCB2ZyBhbmQgcHYgRmFjdHMKICAgICAgICByb290dmc6CiAgICAgICAgUFZfTkFNRSAgICAgICAgICAgUFYgU1RBVEUgICAgICAgICAgVE9UQUwgUFBzICAgRlJFRSBQUHMgICAgRlJFRSBESVNUUklCVVRJT04KICAgICAgICBoZGlzazAgICAgICAgICAgICBhY3RpdmUgICAgICAgICAgICA1NDYgICAgICAgICAwICAgICAgICAgICAwMC4uMDAuLjAwLi4wMC4uMDAKICAgICAgICBoZGlzazEgICAgICAgICAgICBhY3RpdmUgICAgICAgICAgICA1NDYgICAgICAgICAxMTMgICAgICAgICAwMC4uMDAuLjAwLi4yMS4uOTIKICAgICAgICByZWFsc3luY3ZnOgogICAgICAgIFBWX05BTUUgICAgICAgICAgIFBWIFNUQVRFICAgICAgICAgIFRPVEFMIFBQcyAgIEZSRUUgUFBzICAgIEZSRUUgRElTVFJJQlVUSU9OCiAgICAgICAgaGRpc2s3NCAgICAgICAgICAgYWN0aXZlICAgICAgICAgICAgMTk5OSAgICAgICAgNiAgICAgICAgICAgMDAuLjAwLi4wMC4uMDAuLjA2CiAgICAgICAgdGVzdHZnOgogICAgICAgIFBWX05BTUUgICAgICAgICAgIFBWIFNUQVRFICAgICAgICAgIFRPVEFMIFBQcyAgIEZSRUUgUFBzICAgIEZSRUUgRElTVFJJQlVUSU9OCiAgICAgICAgaGRpc2sxMDUgICAgICAgICAgYWN0aXZlICAgICAgICAgICAgOTk5ICAgICAgICAgODM4ICAgICAgICAgMjAwLi4zOS4uMTk5Li4yMDAuLjIwMAogICAgICAgIGhkaXNrMTA2ICAgICAgICAgIGFjdGl2ZSAgICAgICAgICAgIDk5OSAgICAgICAgIDU5OSAgICAgICAgIDIwMC4uMDAuLjAwLi4xOTkuLjIwMAogICAgICAgICIiIgoKICAgICAgICB2Z3NfZmFjdHMgPSB7fQogICAgICAgIGxzdmdfcGF0aCA9IHNlbGYubW9kdWxlLmdldF9iaW5fcGF0aCgibHN2ZyIpCiAgICAgICAgeGFyZ3NfcGF0aCA9IHNlbGYubW9kdWxlLmdldF9iaW5fcGF0aCgieGFyZ3MiKQogICAgICAgIGNtZCA9ICIlcyB8ICVzICVzIC1wIiAlIChsc3ZnX3BhdGgsIHhhcmdzX3BhdGgsIGxzdmdfcGF0aCkKICAgICAgICBpZiBsc3ZnX3BhdGggYW5kIHhhcmdzX3BhdGg6CiAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKGNtZCwgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlKQogICAgICAgICAgICBpZiByYyA9PSAwIGFuZCBvdXQ6CiAgICAgICAgICAgICAgICB2Z3NfZmFjdHNbJ3ZncyddID0ge30KICAgICAgICAgICAgICAgIGZvciBtIGluIHJlLmZpbmRpdGVyKHInKFxTKyk6XG4uKkZSRUUgRElTVFJJQlVUSU9OKFxuKFxTKylccysoXHcrKVxzKyhcZCspXHMrKFxkKykuKikrJywgb3V0KToKICAgICAgICAgICAgICAgICAgICB2Z3NfZmFjdHNbJ3ZncyddW20uZ3JvdXAoMSldID0gW10KICAgICAgICAgICAgICAgICAgICBwcF9zaXplID0gMAogICAgICAgICAgICAgICAgICAgIGNtZCA9ICIlcyAlcyIgJSAobHN2Z19wYXRoLCBtLmdyb3VwKDEpKQogICAgICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKGNtZCkKICAgICAgICAgICAgICAgICAgICBpZiByYyA9PSAwIGFuZCBvdXQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHBwX3NpemUgPSByZS5zZWFyY2gocidQUCBTSVpFOlxzKyhcZCtccytcUyspJywgb3V0KS5ncm91cCgxKQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgbiBpbiByZS5maW5kaXRlcihyJyhcUyspXHMrKFx3KylccysoXGQrKVxzKyhcZCspLionLCBtLmdyb3VwKDApKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB2X2luZm8gPSB7J3B2X25hbWUnOiBuLmdyb3VwKDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncHZfc3RhdGUnOiBuLmdyb3VwKDIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAndG90YWxfcHBzJzogbi5ncm91cCgzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ZyZWVfcHBzJzogbi5ncm91cCg0KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3BwX3NpemUnOiBwcF9zaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZnc19mYWN0c1sndmdzJ11bbS5ncm91cCgxKV0uYXBwZW5kKHB2X2luZm8pCgogICAgICAgIHJldHVybiB2Z3NfZmFjdHMKCiAgICBkZWYgZ2V0X21vdW50X2ZhY3RzKHNlbGYpOgogICAgICAgIG1vdW50X2ZhY3RzID0ge30KCiAgICAgICAgbW91bnRfZmFjdHNbJ21vdW50cyddID0gW10KICAgICAgICAjIEFJWCBkb2VzIG5vdCBoYXZlIG10YWIgYnV0IG1vdW50IGNvbW1hbmQgaXMgb25seSBzb3VyY2Ugb2YgaW5mbyAob3IgdG8gdXNlCiAgICAgICAgIyBhcGkgY2FsbHMgdG8gZ2V0IHNhbWUgaW5mbykKICAgICAgICBtb3VudF9wYXRoID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCdtb3VudCcpCiAgICAgICAgcmMsIG1vdW50X291dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQobW91bnRfcGF0aCkKICAgICAgICBpZiBtb3VudF9vdXQ6CiAgICAgICAgICAgIGZvciBsaW5lIGluIG1vdW50X291dC5zcGxpdCgnXG4nKToKICAgICAgICAgICAgICAgIGZpZWxkcyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKGZpZWxkcykgIT0gMCBhbmQgZmllbGRzWzBdICE9ICdub2RlJyBhbmQgZmllbGRzWzBdWzBdICE9ICctJyBhbmQgcmUubWF0Y2goJ14vLip8XlthLXpBLVpdLip8XlswLTldLionLCBmaWVsZHNbMF0pOgogICAgICAgICAgICAgICAgICAgIGlmIHJlLm1hdGNoKCdeLycsIGZpZWxkc1swXSk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgbm9ybWFsIG1vdW50CiAgICAgICAgICAgICAgICAgICAgICAgIG1vdW50X2ZhY3RzWydtb3VudHMnXS5hcHBlbmQoeydtb3VudCc6IGZpZWxkc1sxXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RldmljZSc6IGZpZWxkc1swXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ZzdHlwZSc6IGZpZWxkc1syXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ29wdGlvbnMnOiBmaWVsZHNbNl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0aW1lJzogJyVzICVzICVzJyAlIChmaWVsZHNbM10sIGZpZWxkc1s0XSwgZmllbGRzWzVdKX0pCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBuZnMgb3IgY2lmcyBiYXNlZCBtb3VudAogICAgICAgICAgICAgICAgICAgICAgICAjIGluIGNhc2Ugb2YgbmZzIGlmIG5vIG1vdW50IG9wdGlvbnMgYXJlIHByb3ZpZGVkIG9uIGNvbW1hbmQgbGluZQogICAgICAgICAgICAgICAgICAgICAgICAjIGFkZCBpbnRvIGZpZWxkcyBlbXB0eSBzdHJpbmcuLi4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKGZpZWxkcykgPCA4OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzLmFwcGVuZCgiIikKCiAgICAgICAgICAgICAgICAgICAgICAgIG1vdW50X2ZhY3RzWydtb3VudHMnXS5hcHBlbmQoeydtb3VudCc6IGZpZWxkc1syXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RldmljZSc6ICclczolcycgJSAoZmllbGRzWzBdLCBmaWVsZHNbMV0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZnN0eXBlJzogZmllbGRzWzNdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3B0aW9ucyc6IGZpZWxkc1s3XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3RpbWUnOiAnJXMgJXMgJXMnICUgKGZpZWxkc1s0XSwgZmllbGRzWzVdLCBmaWVsZHNbNl0pfSkKICAgICAgICByZXR1cm4gbW91bnRfZmFjdHMKCgpjbGFzcyBBSVhIYXJkd2FyZUNvbGxlY3RvcihIYXJkd2FyZUNvbGxlY3Rvcik6CiAgICBfcGxhdGZvcm0gPSAnQUlYJwogICAgX2ZhY3RfY2xhc3MgPSBBSVhIYXJkd2FyZQpQSwMEFAAAAAAAy7srS3g4v21dFwAAXRcAACkAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9uZXR3b3JrL2FpeC5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgppbXBvcnQgcmUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5iYXNlIGltcG9ydCBOZXR3b3JrQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5nZW5lcmljX2JzZCBpbXBvcnQgR2VuZXJpY0JzZElmY29uZmlnTmV0d29yawoKCmNsYXNzIEFJWE5ldHdvcmsoR2VuZXJpY0JzZElmY29uZmlnTmV0d29yayk6CiAgICAiIiIKICAgIFRoaXMgaXMgdGhlIEFJWCBOZXR3b3JrIENsYXNzLgogICAgSXQgdXNlcyB0aGUgR2VuZXJpY0JzZElmY29uZmlnTmV0d29yayB1bmNoYW5nZWQuCiAgICAiIiIKICAgIHBsYXRmb3JtID0gJ0FJWCcKCiAgICBkZWYgZ2V0X2RlZmF1bHRfaW50ZXJmYWNlcyhzZWxmLCByb3V0ZV9wYXRoKToKICAgICAgICBuZXRzdGF0X3BhdGggPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoJ25ldHN0YXQnKQoKICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZChbbmV0c3RhdF9wYXRoLCAnLW5yJ10pCgogICAgICAgIGludGVyZmFjZSA9IGRpY3QodjQ9e30sIHY2PXt9KQoKICAgICAgICBsaW5lcyA9IG91dC5zcGxpdGxpbmVzKCkKICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgd29yZHMgPSBsaW5lLnNwbGl0KCkKICAgICAgICAgICAgaWYgbGVuKHdvcmRzKSA+IDEgYW5kIHdvcmRzWzBdID09ICdkZWZhdWx0JzoKICAgICAgICAgICAgICAgIGlmICcuJyBpbiB3b3Jkc1sxXToKICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2VbJ3Y0J11bJ2dhdGV3YXknXSA9IHdvcmRzWzFdCiAgICAgICAgICAgICAgICAgICAgaW50ZXJmYWNlWyd2NCddWydpbnRlcmZhY2UnXSA9IHdvcmRzWzVdCiAgICAgICAgICAgICAgICBlbGlmICc6JyBpbiB3b3Jkc1sxXToKICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2VbJ3Y2J11bJ2dhdGV3YXknXSA9IHdvcmRzWzFdCiAgICAgICAgICAgICAgICAgICAgaW50ZXJmYWNlWyd2NiddWydpbnRlcmZhY2UnXSA9IHdvcmRzWzVdCgogICAgICAgIHJldHVybiBpbnRlcmZhY2VbJ3Y0J10sIGludGVyZmFjZVsndjYnXQoKICAgICMgQUlYICdpZmNvbmZpZyAtYScgZG9lcyBub3QgaGF2ZSB0aHJlZSB3b3JkcyBpbiB0aGUgaW50ZXJmYWNlIGxpbmUKICAgIGRlZiBnZXRfaW50ZXJmYWNlc19pbmZvKHNlbGYsIGlmY29uZmlnX3BhdGgsIGlmY29uZmlnX29wdGlvbnM9Jy1hJyk6CiAgICAgICAgaW50ZXJmYWNlcyA9IHt9CiAgICAgICAgY3VycmVudF9pZiA9IHt9CiAgICAgICAgaXBzID0gZGljdCgKICAgICAgICAgICAgYWxsX2lwdjRfYWRkcmVzc2VzPVtdLAogICAgICAgICAgICBhbGxfaXB2Nl9hZGRyZXNzZXM9W10sCiAgICAgICAgKQoKICAgICAgICB1bmFtZV9yYyA9IE5vbmUKICAgICAgICB1bmFtZV9vdXQgPSBOb25lCiAgICAgICAgdW5hbWVfZXJyID0gTm9uZQogICAgICAgIHVuYW1lX3BhdGggPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoJ3VuYW1lJykKICAgICAgICBpZiB1bmFtZV9wYXRoOgogICAgICAgICAgICB1bmFtZV9yYywgdW5hbWVfb3V0LCB1bmFtZV9lcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZChbdW5hbWVfcGF0aCwgJy1XJ10pCgogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKFtpZmNvbmZpZ19wYXRoLCBpZmNvbmZpZ19vcHRpb25zXSkKCiAgICAgICAgZm9yIGxpbmUgaW4gb3V0LnNwbGl0bGluZXMoKToKCiAgICAgICAgICAgIGlmIGxpbmU6CiAgICAgICAgICAgICAgICB3b3JkcyA9IGxpbmUuc3BsaXQoKQoKICAgICAgICAgICAgICAgICMgb25seSB0aGlzIGNvbmRpdGlvbiBkaWZmZXJzIGZyb20gR2VuZXJpY0JzZElmY29uZmlnTmV0d29yawogICAgICAgICAgICAgICAgaWYgcmUubWF0Y2goJ15cdypcZCo6JywgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudF9pZiA9IHNlbGYucGFyc2VfaW50ZXJmYWNlX2xpbmUod29yZHMpCiAgICAgICAgICAgICAgICAgICAgaW50ZXJmYWNlc1tjdXJyZW50X2lmWydkZXZpY2UnXV0gPSBjdXJyZW50X2lmCiAgICAgICAgICAgICAgICBlbGlmIHdvcmRzWzBdLnN0YXJ0c3dpdGgoJ29wdGlvbnM9Jyk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV9vcHRpb25zX2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKICAgICAgICAgICAgICAgIGVsaWYgd29yZHNbMF0gPT0gJ25kNic6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV9uZDZfbGluZSh3b3JkcywgY3VycmVudF9pZiwgaXBzKQogICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1swXSA9PSAnZXRoZXInOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyc2VfZXRoZXJfbGluZSh3b3JkcywgY3VycmVudF9pZiwgaXBzKQogICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1swXSA9PSAnbWVkaWE6JzoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcnNlX21lZGlhX2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKICAgICAgICAgICAgICAgIGVsaWYgd29yZHNbMF0gPT0gJ3N0YXR1czonOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyc2Vfc3RhdHVzX2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKICAgICAgICAgICAgICAgIGVsaWYgd29yZHNbMF0gPT0gJ2xsYWRkcic6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV9sbGFkZHJfbGluZSh3b3JkcywgY3VycmVudF9pZiwgaXBzKQogICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1swXSA9PSAnaW5ldCc6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV9pbmV0X2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKICAgICAgICAgICAgICAgIGVsaWYgd29yZHNbMF0gPT0gJ2luZXQ2JzoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcnNlX2luZXQ2X2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV91bmtub3duX2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKCiAgICAgICAgICAgICMgZG9uJ3QgYm90aGVyIHdpdGggd3BhcnMgaXQgZG9lcyBub3Qgd29yawogICAgICAgICAgICAjIHplcm8gbWVhbnMgbm90IGluIHdwYXIKICAgICAgICAgICAgaWYgbm90IHVuYW1lX3JjIGFuZCB1bmFtZV9vdXQuc3BsaXQoKVswXSA9PSAnMCc6CgogICAgICAgICAgICAgICAgaWYgY3VycmVudF9pZlsnbWFjYWRkcmVzcyddID09ICd1bmtub3duJyBhbmQgcmUubWF0Y2goJ15lbicsIGN1cnJlbnRfaWZbJ2RldmljZSddKToKICAgICAgICAgICAgICAgICAgICBlbnRzdGF0X3BhdGggPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoJ2VudHN0YXQnKQogICAgICAgICAgICAgICAgICAgIGlmIGVudHN0YXRfcGF0aDoKICAgICAgICAgICAgICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoW2VudHN0YXRfcGF0aCwgY3VycmVudF9pZlsnZGV2aWNlJ11dKQogICAgICAgICAgICAgICAgICAgICAgICBpZiByYyAhPSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gb3V0LnNwbGl0bGluZXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmYgPSByZS5tYXRjaCgnXkhhcmR3YXJlIEFkZHJlc3M6ICguKiknLCBsaW5lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgYnVmZjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2lmWydtYWNhZGRyZXNzJ10gPSBidWZmLmdyb3VwKDEpCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZiA9IHJlLm1hdGNoKCdeRGV2aWNlIFR5cGU6JywgbGluZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGJ1ZmYgYW5kIHJlLm1hdGNoKCcuKkV0aGVybmV0JywgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9pZlsndHlwZSddID0gJ2V0aGVyJwoKICAgICAgICAgICAgICAgICMgZGV2aWNlIG11c3QgaGF2ZSBtdHUgYXR0cmlidXRlIGluIE9ETQogICAgICAgICAgICAgICAgaWYgJ210dScgbm90IGluIGN1cnJlbnRfaWY6CiAgICAgICAgICAgICAgICAgICAgbHNhdHRyX3BhdGggPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoJ2xzYXR0cicpCiAgICAgICAgICAgICAgICAgICAgaWYgbHNhdHRyX3BhdGg6CiAgICAgICAgICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKFtsc2F0dHJfcGF0aCwgJy1FbCcsIGN1cnJlbnRfaWZbJ2RldmljZSddXSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmMgIT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIG91dC5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgd29yZHNbMF0gPT0gJ210dSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfaWZbJ210dSddID0gd29yZHNbMV0KICAgICAgICByZXR1cm4gaW50ZXJmYWNlcywgaXBzCgogICAgIyBBSVggJ2lmY29uZmlnIC1hJyBkb2VzIG5vdCBpbmZvcm0gYWJvdXQgTVRVLCBzbyByZW1vdmUgY3VycmVudF9pZlsnbXR1J10gaGVyZQogICAgZGVmIHBhcnNlX2ludGVyZmFjZV9saW5lKHNlbGYsIHdvcmRzKToKICAgICAgICBkZXZpY2UgPSB3b3Jkc1swXVswOi0xXQogICAgICAgIGN1cnJlbnRfaWYgPSB7J2RldmljZSc6IGRldmljZSwgJ2lwdjQnOiBbXSwgJ2lwdjYnOiBbXSwgJ3R5cGUnOiAndW5rbm93bid9CiAgICAgICAgY3VycmVudF9pZlsnZmxhZ3MnXSA9IHNlbGYuZ2V0X29wdGlvbnMod29yZHNbMV0pCiAgICAgICAgY3VycmVudF9pZlsnbWFjYWRkcmVzcyddID0gJ3Vua25vd24nICAgICMgd2lsbCBiZSBvdmVyd3JpdHRlbiBsYXRlcgogICAgICAgIHJldHVybiBjdXJyZW50X2lmCgoKY2xhc3MgQUlYTmV0d29ya0NvbGxlY3RvcihOZXR3b3JrQ29sbGVjdG9yKToKICAgIF9mYWN0X2NsYXNzID0gQUlYTmV0d29yawogICAgX3BsYXRmb3JtID0gJ0FJWCcKUEsDBBQAAAAAAMu7K0tIrpdzdmMAAHZjAAAsAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvaGFyZHdhcmUvbGludXgucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKaW1wb3J0IGVycm5vCmltcG9ydCBqc29uCmltcG9ydCBvcwppbXBvcnQgcmUKaW1wb3J0IHN5cwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5iYXNpYyBpbXBvcnQgYnl0ZXNfdG9faHVtYW4KCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUuYmFzZSBpbXBvcnQgSGFyZHdhcmUsIEhhcmR3YXJlQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMudXRpbHMgaW1wb3J0IGdldF9maWxlX2NvbnRlbnQsIGdldF9maWxlX2xpbmVzLCBnZXRfbW91bnRfc2l6ZQoKIyBpbXBvcnQgdGhpcyBhcyBhIG1vZHVsZSB0byBlbnN1cmUgd2UgZ2V0IHRoZSBzYW1lIG1vZHVsZSBpc250YW5jZQpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzIGltcG9ydCB0aW1lb3V0CgoKZGVmIGdldF9wYXJ0aXRpb25fdXVpZChwYXJ0bmFtZSk6CiAgICB0cnk6CiAgICAgICAgdXVpZHMgPSBvcy5saXN0ZGlyKCIvZGV2L2Rpc2svYnktdXVpZCIpCiAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICByZXR1cm4KCiAgICBmb3IgdXVpZCBpbiB1dWlkczoKICAgICAgICBkZXYgPSBvcy5wYXRoLnJlYWxwYXRoKCIvZGV2L2Rpc2svYnktdXVpZC8iICsgdXVpZCkKICAgICAgICBpZiBkZXYgPT0gKCIvZGV2LyIgKyBwYXJ0bmFtZSk6CiAgICAgICAgICAgIHJldHVybiB1dWlkCgogICAgcmV0dXJuIE5vbmUKCgpjbGFzcyBMaW51eEhhcmR3YXJlKEhhcmR3YXJlKToKICAgICIiIgogICAgTGludXgtc3BlY2lmaWMgc3ViY2xhc3Mgb2YgSGFyZHdhcmUuICBEZWZpbmVzIG1lbW9yeSBhbmQgQ1BVIGZhY3RzOgogICAgLSBtZW1mcmVlX21iCiAgICAtIG1lbXRvdGFsX21iCiAgICAtIHN3YXBmcmVlX21iCiAgICAtIHN3YXB0b3RhbF9tYgogICAgLSBwcm9jZXNzb3IgKGEgbGlzdCkKICAgIC0gcHJvY2Vzc29yX2NvcmVzCiAgICAtIHByb2Nlc3Nvcl9jb3VudAoKICAgIEluIGFkZGl0aW9uLCBpdCBhbHNvIGRlZmluZXMgbnVtYmVyIG9mIERNSSBmYWN0cyBhbmQgZGV2aWNlIGZhY3RzLgogICAgIiIiCgogICAgcGxhdGZvcm0gPSAnTGludXgnCgogICAgIyBPcmlnaW5hbGx5IG9ubHkgaGFkIHRoZXNlIGZvdXIgYXMgdG9wbGV2ZWxmYWN0cwogICAgT1JJR0lOQUxfTUVNT1JZX0ZBQ1RTID0gZnJvemVuc2V0KCgnTWVtVG90YWwnLCAnU3dhcFRvdGFsJywgJ01lbUZyZWUnLCAnU3dhcEZyZWUnKSkKICAgICMgTm93IHdlIGhhdmUgYWxsIG9mIHRoZXNlIGluIGEgZGljdCBzdHJ1Y3R1cmUKICAgIE1FTU9SWV9GQUNUUyA9IE9SSUdJTkFMX01FTU9SWV9GQUNUUy51bmlvbigoJ0J1ZmZlcnMnLCAnQ2FjaGVkJywgJ1N3YXBDYWNoZWQnKSkKCiAgICAjIHJlZ2V4IHVzZWQgYWdhaW5zdCBmaW5kbW50IG91dHB1dCB0byBkZXRlY3QgYmluZCBtb3VudHMKICAgIEJJTkRfTU9VTlRfUkUgPSByZS5jb21waWxlKHInLipcXScpCgogICAgIyByZWdleCB1c2VkIGFnYWluc3QgbXRhYiBjb250ZW50IHRvIGZpbmQgZW50cmllcyB0aGF0IGFyZSBiaW5kIG1vdW50cwogICAgTVRBQl9CSU5EX01PVU5UX1JFID0gcmUuY29tcGlsZShyJy4qYmluZC4qIicpCgogICAgZGVmIHBvcHVsYXRlKHNlbGYsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBoYXJkd2FyZV9mYWN0cyA9IHt9CgogICAgICAgIGNwdV9mYWN0cyA9IHNlbGYuZ2V0X2NwdV9mYWN0cyhjb2xsZWN0ZWRfZmFjdHM9Y29sbGVjdGVkX2ZhY3RzKQogICAgICAgIG1lbW9yeV9mYWN0cyA9IHNlbGYuZ2V0X21lbW9yeV9mYWN0cygpCiAgICAgICAgZG1pX2ZhY3RzID0gc2VsZi5nZXRfZG1pX2ZhY3RzKCkKICAgICAgICBkZXZpY2VfZmFjdHMgPSBzZWxmLmdldF9kZXZpY2VfZmFjdHMoKQogICAgICAgIHVwdGltZV9mYWN0cyA9IHNlbGYuZ2V0X3VwdGltZV9mYWN0cygpCiAgICAgICAgbHZtX2ZhY3RzID0gc2VsZi5nZXRfbHZtX2ZhY3RzKCkKCiAgICAgICAgbW91bnRfZmFjdHMgPSB7fQogICAgICAgIHRyeToKICAgICAgICAgICAgbW91bnRfZmFjdHMgPSBzZWxmLmdldF9tb3VudF9mYWN0cygpCiAgICAgICAgZXhjZXB0IHRpbWVvdXQuVGltZW91dEVycm9yOgogICAgICAgICAgICBwYXNzCgogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShjcHVfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKG1lbW9yeV9mYWN0cykKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUoZG1pX2ZhY3RzKQogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShkZXZpY2VfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKHVwdGltZV9mYWN0cykKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUobHZtX2ZhY3RzKQogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShtb3VudF9mYWN0cykKCiAgICAgICAgcmV0dXJuIGhhcmR3YXJlX2ZhY3RzCgogICAgZGVmIGdldF9tZW1vcnlfZmFjdHMoc2VsZik6CiAgICAgICAgbWVtb3J5X2ZhY3RzID0ge30KICAgICAgICBpZiBub3Qgb3MuYWNjZXNzKCIvcHJvYy9tZW1pbmZvIiwgb3MuUl9PSyk6CiAgICAgICAgICAgIHJldHVybiBtZW1vcnlfZmFjdHMKCiAgICAgICAgbWVtc3RhdHMgPSB7fQogICAgICAgIGZvciBsaW5lIGluIGdldF9maWxlX2xpbmVzKCIvcHJvYy9tZW1pbmZvIik6CiAgICAgICAgICAgIGRhdGEgPSBsaW5lLnNwbGl0KCI6IiwgMSkKICAgICAgICAgICAga2V5ID0gZGF0YVswXQogICAgICAgICAgICBpZiBrZXkgaW4gc2VsZi5PUklHSU5BTF9NRU1PUllfRkFDVFM6CiAgICAgICAgICAgICAgICB2YWwgPSBkYXRhWzFdLnN0cmlwKCkuc3BsaXQoJyAnKVswXQogICAgICAgICAgICAgICAgbWVtb3J5X2ZhY3RzWyIlc19tYiIgJSBrZXkubG93ZXIoKV0gPSBpbnQodmFsKSAvLyAxMDI0CgogICAgICAgICAgICBpZiBrZXkgaW4gc2VsZi5NRU1PUllfRkFDVFM6CiAgICAgICAgICAgICAgICB2YWwgPSBkYXRhWzFdLnN0cmlwKCkuc3BsaXQoJyAnKVswXQogICAgICAgICAgICAgICAgbWVtc3RhdHNba2V5Lmxvd2VyKCldID0gaW50KHZhbCkgLy8gMTAyNAoKICAgICAgICBpZiBOb25lIG5vdCBpbiAobWVtc3RhdHMuZ2V0KCdtZW10b3RhbCcpLCBtZW1zdGF0cy5nZXQoJ21lbWZyZWUnKSk6CiAgICAgICAgICAgIG1lbXN0YXRzWydyZWFsOnVzZWQnXSA9IG1lbXN0YXRzWydtZW10b3RhbCddIC0gbWVtc3RhdHNbJ21lbWZyZWUnXQogICAgICAgIGlmIE5vbmUgbm90IGluIChtZW1zdGF0cy5nZXQoJ2NhY2hlZCcpLCBtZW1zdGF0cy5nZXQoJ21lbWZyZWUnKSwgbWVtc3RhdHMuZ2V0KCdidWZmZXJzJykpOgogICAgICAgICAgICBtZW1zdGF0c1snbm9jYWNoZTpmcmVlJ10gPSBtZW1zdGF0c1snY2FjaGVkJ10gKyBtZW1zdGF0c1snbWVtZnJlZSddICsgbWVtc3RhdHNbJ2J1ZmZlcnMnXQogICAgICAgIGlmIE5vbmUgbm90IGluIChtZW1zdGF0cy5nZXQoJ21lbXRvdGFsJyksIG1lbXN0YXRzLmdldCgnbm9jYWNoZTpmcmVlJykpOgogICAgICAgICAgICBtZW1zdGF0c1snbm9jYWNoZTp1c2VkJ10gPSBtZW1zdGF0c1snbWVtdG90YWwnXSAtIG1lbXN0YXRzWydub2NhY2hlOmZyZWUnXQogICAgICAgIGlmIE5vbmUgbm90IGluIChtZW1zdGF0cy5nZXQoJ3N3YXB0b3RhbCcpLCBtZW1zdGF0cy5nZXQoJ3N3YXBmcmVlJykpOgogICAgICAgICAgICBtZW1zdGF0c1snc3dhcDp1c2VkJ10gPSBtZW1zdGF0c1snc3dhcHRvdGFsJ10gLSBtZW1zdGF0c1snc3dhcGZyZWUnXQoKICAgICAgICBtZW1vcnlfZmFjdHNbJ21lbW9yeV9tYiddID0gewogICAgICAgICAgICAncmVhbCc6IHsKICAgICAgICAgICAgICAgICd0b3RhbCc6IG1lbXN0YXRzLmdldCgnbWVtdG90YWwnKSwKICAgICAgICAgICAgICAgICd1c2VkJzogbWVtc3RhdHMuZ2V0KCdyZWFsOnVzZWQnKSwKICAgICAgICAgICAgICAgICdmcmVlJzogbWVtc3RhdHMuZ2V0KCdtZW1mcmVlJyksCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICdub2NhY2hlJzogewogICAgICAgICAgICAgICAgJ2ZyZWUnOiBtZW1zdGF0cy5nZXQoJ25vY2FjaGU6ZnJlZScpLAogICAgICAgICAgICAgICAgJ3VzZWQnOiBtZW1zdGF0cy5nZXQoJ25vY2FjaGU6dXNlZCcpLAogICAgICAgICAgICB9LAogICAgICAgICAgICAnc3dhcCc6IHsKICAgICAgICAgICAgICAgICd0b3RhbCc6IG1lbXN0YXRzLmdldCgnc3dhcHRvdGFsJyksCiAgICAgICAgICAgICAgICAnZnJlZSc6IG1lbXN0YXRzLmdldCgnc3dhcGZyZWUnKSwKICAgICAgICAgICAgICAgICd1c2VkJzogbWVtc3RhdHMuZ2V0KCdzd2FwOnVzZWQnKSwKICAgICAgICAgICAgICAgICdjYWNoZWQnOiBtZW1zdGF0cy5nZXQoJ3N3YXBjYWNoZWQnKSwKICAgICAgICAgICAgfSwKICAgICAgICB9CgogICAgICAgIHJldHVybiBtZW1vcnlfZmFjdHMKCiAgICBkZWYgZ2V0X2NwdV9mYWN0cyhzZWxmLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgY3B1X2ZhY3RzID0ge30KICAgICAgICBjb2xsZWN0ZWRfZmFjdHMgPSBjb2xsZWN0ZWRfZmFjdHMgb3Ige30KCiAgICAgICAgaSA9IDAKICAgICAgICB2ZW5kb3JfaWRfb2NjdXJyZW5jZSA9IDAKICAgICAgICBtb2RlbF9uYW1lX29jY3VycmVuY2UgPSAwCiAgICAgICAgcGh5c2lkID0gMAogICAgICAgIGNvcmVpZCA9IDAKICAgICAgICBzb2NrZXRzID0ge30KICAgICAgICBjb3JlcyA9IHt9CgogICAgICAgIHhlbiA9IEZhbHNlCiAgICAgICAgeGVuX3BhcmF2aXJ0ID0gRmFsc2UKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKCcvcHJvYy94ZW4nKToKICAgICAgICAgICAgICAgIHhlbiA9IFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGdldF9maWxlX2xpbmVzKCcvc3lzL2h5cGVydmlzb3IvdHlwZScpOgogICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuc3RyaXAoKSA9PSAneGVuJzoKICAgICAgICAgICAgICAgICAgICAgICAgeGVuID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICMgT25seSBpbnRlcmVzdGVkIGluIHRoZSBmaXJzdCBsaW5lCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICBleGNlcHQgSU9FcnJvcjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICBpZiBub3Qgb3MuYWNjZXNzKCIvcHJvYy9jcHVpbmZvIiwgb3MuUl9PSyk6CiAgICAgICAgICAgIHJldHVybiBjcHVfZmFjdHMKCiAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3InXSA9IFtdCiAgICAgICAgZm9yIGxpbmUgaW4gZ2V0X2ZpbGVfbGluZXMoJy9wcm9jL2NwdWluZm8nKToKICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3BsaXQoIjoiLCAxKQogICAgICAgICAgICBrZXkgPSBkYXRhWzBdLnN0cmlwKCkKCiAgICAgICAgICAgIGlmIHhlbjoKICAgICAgICAgICAgICAgIGlmIGtleSA9PSAnZmxhZ3MnOgogICAgICAgICAgICAgICAgICAgICMgQ2hlY2sgZm9yIHZtZSBjcHUgZmxhZywgWGVuIHBhcmF2aXJ0IGRvZXMgbm90IGV4cG9zZSB0aGlzLgogICAgICAgICAgICAgICAgICAgICMgICBOZWVkIHRvIGRldGVjdCBYZW4gcGFyYXZpcnQgYmVjYXVzZSBpdCBleHBvc2VzIGNwdWluZm8KICAgICAgICAgICAgICAgICAgICAjICAgZGlmZmVyZW50bHkgdGhhbiBYZW4gSFZNIG9yIEtWTSBhbmQgY2F1c2VzIHJlcG9ydGluZyBvZgogICAgICAgICAgICAgICAgICAgICMgICBvbmx5IGEgc2luZ2xlIGNwdSBjb3JlLgogICAgICAgICAgICAgICAgICAgIGlmICd2bWUnIG5vdCBpbiBkYXRhOgogICAgICAgICAgICAgICAgICAgICAgICB4ZW5fcGFyYXZpcnQgPSBUcnVlCgogICAgICAgICAgICAjIG1vZGVsIG5hbWUgaXMgZm9yIEludGVsIGFyY2gsIFByb2Nlc3NvciAobWluZCB0aGUgdXBwZXJjYXNlIFApCiAgICAgICAgICAgICMgd29ya3MgZm9yIHNvbWUgQVJNIGRldmljZXMsIGxpa2UgdGhlIFNoZWV2YXBsdWcuCiAgICAgICAgICAgIGlmIGtleSBpbiBbJ21vZGVsIG5hbWUnLCAnUHJvY2Vzc29yJywgJ3ZlbmRvcl9pZCcsICdjcHUnLCAnVmVuZG9yJ106CiAgICAgICAgICAgICAgICBpZiAncHJvY2Vzc29yJyBub3QgaW4gY3B1X2ZhY3RzOgogICAgICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yJ10gPSBbXQogICAgICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3InXS5hcHBlbmQoZGF0YVsxXS5zdHJpcCgpKQogICAgICAgICAgICAgICAgaWYga2V5ID09ICd2ZW5kb3JfaWQnOgogICAgICAgICAgICAgICAgICAgIHZlbmRvcl9pZF9vY2N1cnJlbmNlICs9IDEKICAgICAgICAgICAgICAgIGlmIGtleSA9PSAnbW9kZWwgbmFtZSc6CiAgICAgICAgICAgICAgICAgICAgbW9kZWxfbmFtZV9vY2N1cnJlbmNlICs9IDEKICAgICAgICAgICAgICAgIGkgKz0gMQogICAgICAgICAgICBlbGlmIGtleSA9PSAncGh5c2ljYWwgaWQnOgogICAgICAgICAgICAgICAgcGh5c2lkID0gZGF0YVsxXS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBwaHlzaWQgbm90IGluIHNvY2tldHM6CiAgICAgICAgICAgICAgICAgICAgc29ja2V0c1twaHlzaWRdID0gMQogICAgICAgICAgICBlbGlmIGtleSA9PSAnY29yZSBpZCc6CiAgICAgICAgICAgICAgICBjb3JlaWQgPSBkYXRhWzFdLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIGNvcmVpZCBub3QgaW4gc29ja2V0czoKICAgICAgICAgICAgICAgICAgICBjb3Jlc1tjb3JlaWRdID0gMQogICAgICAgICAgICBlbGlmIGtleSA9PSAnY3B1IGNvcmVzJzoKICAgICAgICAgICAgICAgIHNvY2tldHNbcGh5c2lkXSA9IGludChkYXRhWzFdLnN0cmlwKCkpCiAgICAgICAgICAgIGVsaWYga2V5ID09ICdzaWJsaW5ncyc6CiAgICAgICAgICAgICAgICBjb3Jlc1tjb3JlaWRdID0gaW50KGRhdGFbMV0uc3RyaXAoKSkKICAgICAgICAgICAgZWxpZiBrZXkgPT0gJyMgcHJvY2Vzc29ycyc6CiAgICAgICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3JlcyddID0gaW50KGRhdGFbMV0uc3RyaXAoKSkKCiAgICAgICAgIyBTa2lwIGZvciBwbGF0Zm9ybXMgd2l0aG91dCB2ZW5kb3JfaWQvbW9kZWxfbmFtZSBpbiBjcHVpbmZvIChlLmcgcHBjNjRsZSkKICAgICAgICBpZiB2ZW5kb3JfaWRfb2NjdXJyZW5jZSA+IDA6CiAgICAgICAgICAgIGlmIHZlbmRvcl9pZF9vY2N1cnJlbmNlID09IG1vZGVsX25hbWVfb2NjdXJyZW5jZToKICAgICAgICAgICAgICAgIGkgPSB2ZW5kb3JfaWRfb2NjdXJyZW5jZQoKICAgICAgICAjIEZJWE1FCiAgICAgICAgaWYgY29sbGVjdGVkX2ZhY3RzLmdldCgnYW5zaWJsZV9hcmNoaXRlY3R1cmUnKSAhPSAnczM5MHgnOgogICAgICAgICAgICBpZiB4ZW5fcGFyYXZpcnQ6CiAgICAgICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3VudCddID0gaQogICAgICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY29yZXMnXSA9IGkKICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yX3RocmVhZHNfcGVyX2NvcmUnXSA9IDEKICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yX3ZjcHVzJ10gPSBpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiBzb2NrZXRzOgogICAgICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yX2NvdW50J10gPSBsZW4oc29ja2V0cykKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY291bnQnXSA9IGkKCiAgICAgICAgICAgICAgICBzb2NrZXRfdmFsdWVzID0gbGlzdChzb2NrZXRzLnZhbHVlcygpKQogICAgICAgICAgICAgICAgaWYgc29ja2V0X3ZhbHVlcyBhbmQgc29ja2V0X3ZhbHVlc1swXToKICAgICAgICAgICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3JlcyddID0gc29ja2V0X3ZhbHVlc1swXQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3JlcyddID0gMQoKICAgICAgICAgICAgICAgIGNvcmVfdmFsdWVzID0gbGlzdChjb3Jlcy52YWx1ZXMoKSkKICAgICAgICAgICAgICAgIGlmIGNvcmVfdmFsdWVzOgogICAgICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yX3RocmVhZHNfcGVyX2NvcmUnXSA9IGNvcmVfdmFsdWVzWzBdIC8vIGNwdV9mYWN0c1sncHJvY2Vzc29yX2NvcmVzJ10KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfdGhyZWFkc19wZXJfY29yZSddID0gMSAvLyBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3JlcyddCgogICAgICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfdmNwdXMnXSA9IChjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl90aHJlYWRzX3Blcl9jb3JlJ10gKgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3VudCddICogY3B1X2ZhY3RzWydwcm9jZXNzb3JfY29yZXMnXSkKCiAgICAgICAgcmV0dXJuIGNwdV9mYWN0cwoKICAgIGRlZiBnZXRfZG1pX2ZhY3RzKHNlbGYpOgogICAgICAgICcnJyBsZWFybiBkbWkgZmFjdHMgZnJvbSBzeXN0ZW0KCiAgICAgICAgVHJ5IC9zeXMgZmlyc3QgZm9yIGRtaSByZWxhdGVkIGZhY3RzLgogICAgICAgIElmIHRoYXQgaXMgbm90IGF2YWlsYWJsZSwgZmFsbCBiYWNrIHRvIGRtaWRlY29kZSBleGVjdXRhYmxlICcnJwoKICAgICAgICBkbWlfZmFjdHMgPSB7fQoKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cygnL3N5cy9kZXZpY2VzL3ZpcnR1YWwvZG1pL2lkL3Byb2R1Y3RfbmFtZScpOgogICAgICAgICAgICAjIFVzZSBrZXJuZWwgRE1JIGluZm8sIGlmIGF2YWlsYWJsZQoKICAgICAgICAgICAgIyBETUkgU1BFQyAtLSBodHRwOi8vd3d3LmRtdGYub3JnL3NpdGVzL2RlZmF1bHQvZmlsZXMvc3RhbmRhcmRzL2RvY3VtZW50cy9EU1AwMTM0XzIuNy4wLnBkZgogICAgICAgICAgICBGT1JNX0ZBQ1RPUiA9IFsiVW5rbm93biIsICJPdGhlciIsICJVbmtub3duIiwgIkRlc2t0b3AiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAiTG93IFByb2ZpbGUgRGVza3RvcCIsICJQaXp6YSBCb3giLCAiTWluaSBUb3dlciIsICJUb3dlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICJQb3J0YWJsZSIsICJMYXB0b3AiLCAiTm90ZWJvb2siLCAiSGFuZCBIZWxkIiwgIkRvY2tpbmcgU3RhdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICJBbGwgSW4gT25lIiwgIlN1YiBOb3RlYm9vayIsICJTcGFjZS1zYXZpbmciLCAiTHVuY2ggQm94IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIk1haW4gU2VydmVyIENoYXNzaXMiLCAiRXhwYW5zaW9uIENoYXNzaXMiLCAiU3ViIENoYXNzaXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAiQnVzIEV4cGFuc2lvbiBDaGFzc2lzIiwgIlBlcmlwaGVyYWwgQ2hhc3NpcyIsICJSQUlEIENoYXNzaXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAiUmFjayBNb3VudCBDaGFzc2lzIiwgIlNlYWxlZC1jYXNlIFBDIiwgIk11bHRpLXN5c3RlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICJDb21wYWN0UENJIiwgIkFkdmFuY2VkVENBIiwgIkJsYWRlIl0KCiAgICAgICAgICAgIERNSV9ESUNUID0gewogICAgICAgICAgICAgICAgJ2Jpb3NfZGF0ZSc6ICcvc3lzL2RldmljZXMvdmlydHVhbC9kbWkvaWQvYmlvc19kYXRlJywKICAgICAgICAgICAgICAgICdiaW9zX3ZlcnNpb24nOiAnL3N5cy9kZXZpY2VzL3ZpcnR1YWwvZG1pL2lkL2Jpb3NfdmVyc2lvbicsCiAgICAgICAgICAgICAgICAnZm9ybV9mYWN0b3InOiAnL3N5cy9kZXZpY2VzL3ZpcnR1YWwvZG1pL2lkL2NoYXNzaXNfdHlwZScsCiAgICAgICAgICAgICAgICAncHJvZHVjdF9uYW1lJzogJy9zeXMvZGV2aWNlcy92aXJ0dWFsL2RtaS9pZC9wcm9kdWN0X25hbWUnLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3Rfc2VyaWFsJzogJy9zeXMvZGV2aWNlcy92aXJ0dWFsL2RtaS9pZC9wcm9kdWN0X3NlcmlhbCcsCiAgICAgICAgICAgICAgICAncHJvZHVjdF91dWlkJzogJy9zeXMvZGV2aWNlcy92aXJ0dWFsL2RtaS9pZC9wcm9kdWN0X3V1aWQnLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3RfdmVyc2lvbic6ICcvc3lzL2RldmljZXMvdmlydHVhbC9kbWkvaWQvcHJvZHVjdF92ZXJzaW9uJywKICAgICAgICAgICAgICAgICdzeXN0ZW1fdmVuZG9yJzogJy9zeXMvZGV2aWNlcy92aXJ0dWFsL2RtaS9pZC9zeXNfdmVuZG9yJwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKGtleSwgcGF0aCkgaW4gRE1JX0RJQ1QuaXRlbXMoKToKICAgICAgICAgICAgICAgIGRhdGEgPSBnZXRfZmlsZV9jb250ZW50KHBhdGgpCiAgICAgICAgICAgICAgICBpZiBkYXRhIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIGlmIGtleSA9PSAnZm9ybV9mYWN0b3InOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbWlfZmFjdHNbJ2Zvcm1fZmFjdG9yJ10gPSBGT1JNX0ZBQ1RPUltpbnQoZGF0YSldCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBJbmRleEVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG1pX2ZhY3RzWydmb3JtX2ZhY3RvciddID0gJ3Vua25vd24gKCVzKScgJSBkYXRhCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZG1pX2ZhY3RzW2tleV0gPSBkYXRhCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGRtaV9mYWN0c1trZXldID0gJ05BJwoKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIEZhbGwgYmFjayB0byB1c2luZyBkbWlkZWNvZGUsIGlmIGF2YWlsYWJsZQogICAgICAgICAgICBkbWlfYmluID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCdkbWlkZWNvZGUnKQogICAgICAgICAgICBETUlfRElDVCA9IHsKICAgICAgICAgICAgICAgICdiaW9zX2RhdGUnOiAnYmlvcy1yZWxlYXNlLWRhdGUnLAogICAgICAgICAgICAgICAgJ2Jpb3NfdmVyc2lvbic6ICdiaW9zLXZlcnNpb24nLAogICAgICAgICAgICAgICAgJ2Zvcm1fZmFjdG9yJzogJ2NoYXNzaXMtdHlwZScsCiAgICAgICAgICAgICAgICAncHJvZHVjdF9uYW1lJzogJ3N5c3RlbS1wcm9kdWN0LW5hbWUnLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3Rfc2VyaWFsJzogJ3N5c3RlbS1zZXJpYWwtbnVtYmVyJywKICAgICAgICAgICAgICAgICdwcm9kdWN0X3V1aWQnOiAnc3lzdGVtLXV1aWQnLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3RfdmVyc2lvbic6ICdzeXN0ZW0tdmVyc2lvbicsCiAgICAgICAgICAgICAgICAnc3lzdGVtX3ZlbmRvcic6ICdzeXN0ZW0tbWFudWZhY3R1cmVyJwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoaywgdikgaW4gRE1JX0RJQ1QuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGRtaV9iaW4gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgKHJjLCBvdXQsIGVycikgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgnJXMgLXMgJXMnICUgKGRtaV9iaW4sIHYpKQogICAgICAgICAgICAgICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgICMgU3RyaXAgb3V0IGNvbW1lbnRlZCBsaW5lcyAoc3BlY2lmaWMgZG1pZGVjb2RlIG91dHB1dCkKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc3ZhbHVlID0gJycuam9pbihbbGluZSBmb3IgbGluZSBpbiBvdXQuc3BsaXRsaW5lcygpIGlmIG5vdCBsaW5lLnN0YXJ0c3dpdGgoJyMnKV0pCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpzb24uZHVtcHModGhpc3ZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgVW5pY29kZURlY29kZUVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc3ZhbHVlID0gIk5BIgoKICAgICAgICAgICAgICAgICAgICAgICAgZG1pX2ZhY3RzW2tdID0gdGhpc3ZhbHVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZG1pX2ZhY3RzW2tdID0gJ05BJwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBkbWlfZmFjdHNba10gPSAnTkEnCgogICAgICAgIHJldHVybiBkbWlfZmFjdHMKCiAgICBkZWYgX3J1bl9sc2JsayhzZWxmLCBsc2Jsa19wYXRoKToKICAgICAgICAjIGNhbGwgbHNibGsgYW5kIGNvbGxlY3QgYWxsIHV1aWRzCiAgICAgICAgIyAtLWV4Y2x1ZGUgMiBtYWtlcyBsc2JsayBpZ25vcmUgZmxvcHB5IGRpc2tzLCB3aGljaCBhcmUgc2xvd2VyIHRvIGFuc3dlciB0aGFuIHR5cGljYWwgdGltZW91dHMKICAgICAgICAjIHRoaXMgdXNlcyB0aGUgbGludXggbWFqb3IgZGV2aWNlIG51bWJlcgogICAgICAgICMgZm9yIGRldGFpbHMgc2VlIGh0dHBzOi8vd3d3Lmtlcm5lbC5vcmcvZG9jL0RvY3VtZW50YXRpb24vZGV2aWNlcy50eHQKICAgICAgICBhcmdzID0gWyctLWxpc3QnLCAnLS1ub2hlYWRpbmdzJywgJy0tcGF0aHMnLCAnLS1vdXRwdXQnLCAnTkFNRSxVVUlEJywgJy0tZXhjbHVkZScsICcyJ10KICAgICAgICBjbWQgPSBbbHNibGtfcGF0aF0gKyBhcmdzCiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoY21kKQogICAgICAgIHJldHVybiByYywgb3V0LCBlcnIKCiAgICBkZWYgX2xzYmxrX3V1aWQoc2VsZik6CiAgICAgICAgdXVpZHMgPSB7fQogICAgICAgIGxzYmxrX3BhdGggPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoImxzYmxrIikKICAgICAgICBpZiBub3QgbHNibGtfcGF0aDoKICAgICAgICAgICAgcmV0dXJuIHV1aWRzCgogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYuX3J1bl9sc2Jsayhsc2Jsa19wYXRoKQogICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgIHJldHVybiB1dWlkcwoKICAgICAgICAjIGVhY2ggbGluZSB3aWxsIGJlIGluIGZvcm1hdDoKICAgICAgICAjIDxkZXZpY2VuYW1lPjxzb21lIHdoaXRlc3BhY2U+PHV1aWQ+CiAgICAgICAgIyAvZGV2L3NkYTEgIDMyY2FhZWMzLWVmNDAtNDY5MS1hM2I2LTQzOGMzZjliYzFjMAogICAgICAgIGZvciBsc2Jsa19saW5lIGluIG91dC5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgIGlmIG5vdCBsc2Jsa19saW5lOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGxpbmUgPSBsc2Jsa19saW5lLnN0cmlwKCkKICAgICAgICAgICAgZmllbGRzID0gbGluZS5yc3BsaXQoTm9uZSwgMSkKCiAgICAgICAgICAgIGlmIGxlbihmaWVsZHMpIDwgMjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICBkZXZpY2VfbmFtZSwgdXVpZCA9IGZpZWxkc1swXS5zdHJpcCgpLCBmaWVsZHNbMV0uc3RyaXAoKQogICAgICAgICAgICBpZiBkZXZpY2VfbmFtZSBpbiB1dWlkczoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIHV1aWRzW2RldmljZV9uYW1lXSA9IHV1aWQKCiAgICAgICAgcmV0dXJuIHV1aWRzCgogICAgZGVmIF9ydW5fZmluZG1udChzZWxmLCBmaW5kbW50X3BhdGgpOgogICAgICAgIGFyZ3MgPSBbJy0tbGlzdCcsICctLW5vaGVhZGluZ3MnLCAnLS1ub3RydW5jYXRlJ10KICAgICAgICBjbWQgPSBbZmluZG1udF9wYXRoXSArIGFyZ3MKICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZChjbWQsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fcmVwbGFjZScpCiAgICAgICAgcmV0dXJuIHJjLCBvdXQsIGVycgoKICAgIGRlZiBfZmluZF9iaW5kX21vdW50cyhzZWxmKToKICAgICAgICBiaW5kX21vdW50cyA9IHNldCgpCiAgICAgICAgZmluZG1udF9wYXRoID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCJmaW5kbW50IikKICAgICAgICBpZiBub3QgZmluZG1udF9wYXRoOgogICAgICAgICAgICByZXR1cm4gYmluZF9tb3VudHMKCiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5fcnVuX2ZpbmRtbnQoZmluZG1udF9wYXRoKQogICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgIHJldHVybiBiaW5kX21vdW50cwoKICAgICAgICAjIGZpbmQgYmluZCBtb3VudHMsIGluIGNhc2UgL2V0Yy9tdGFiIGlzIGEgc3ltbGluayB0byAvcHJvYy9tb3VudHMKICAgICAgICBmb3IgbGluZSBpbiBvdXQuc3BsaXRsaW5lcygpOgogICAgICAgICAgICBmaWVsZHMgPSBsaW5lLnNwbGl0KCkKICAgICAgICAgICAgIyBmaWVsZHNbMF0gaXMgdGhlIFRBUkdFVCwgZmllbGRzWzFdIGlzIHRoZSBTT1VSQ0UKICAgICAgICAgICAgaWYgbGVuKGZpZWxkcykgPCAyOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgYmluZCBtb3VudHMgd2lsbCBoYXZlIGEgWy9kaXJlY3RvcnlfbmFtZV0gaW4gdGhlIFNPVVJDRSBjb2x1bW4KICAgICAgICAgICAgaWYgc2VsZi5CSU5EX01PVU5UX1JFLm1hdGNoKGZpZWxkc1sxXSk6CiAgICAgICAgICAgICAgICBiaW5kX21vdW50cy5hZGQoZmllbGRzWzBdKQoKICAgICAgICByZXR1cm4gYmluZF9tb3VudHMKCiAgICBkZWYgX210YWJfZW50cmllcyhzZWxmKToKICAgICAgICBtdGFiX2ZpbGUgPSAnL2V0Yy9tdGFiJwogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhtdGFiX2ZpbGUpOgogICAgICAgICAgICBtdGFiX2ZpbGUgPSAnL3Byb2MvbW91bnRzJwoKICAgICAgICBtdGFiID0gZ2V0X2ZpbGVfY29udGVudChtdGFiX2ZpbGUsICcnKQogICAgICAgIG10YWJfZW50cmllcyA9IFtdCiAgICAgICAgZm9yIGxpbmUgaW4gbXRhYi5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgIGZpZWxkcyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4oZmllbGRzKSA8IDQ6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBtdGFiX2VudHJpZXMuYXBwZW5kKGZpZWxkcykKICAgICAgICByZXR1cm4gbXRhYl9lbnRyaWVzCgogICAgQHRpbWVvdXQudGltZW91dCgpCiAgICBkZWYgZ2V0X21vdW50X2ZhY3RzKHNlbGYpOgogICAgICAgIG1vdW50X2ZhY3RzID0ge30KCiAgICAgICAgbW91bnRfZmFjdHNbJ21vdW50cyddID0gW10KCiAgICAgICAgYmluZF9tb3VudHMgPSBzZWxmLl9maW5kX2JpbmRfbW91bnRzKCkKICAgICAgICB1dWlkcyA9IHNlbGYuX2xzYmxrX3V1aWQoKQogICAgICAgIG10YWJfZW50cmllcyA9IHNlbGYuX210YWJfZW50cmllcygpCgogICAgICAgIG1vdW50cyA9IFtdCiAgICAgICAgZm9yIGZpZWxkcyBpbiBtdGFiX2VudHJpZXM6CiAgICAgICAgICAgIGRldmljZSwgbW91bnQsIGZzdHlwZSwgb3B0aW9ucyA9IGZpZWxkc1swXSwgZmllbGRzWzFdLCBmaWVsZHNbMl0sIGZpZWxkc1szXQoKICAgICAgICAgICAgaWYgbm90IGRldmljZS5zdGFydHN3aXRoKCcvJykgYW5kICc6Lycgbm90IGluIGRldmljZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICBpZiBmc3R5cGUgPT0gJ25vbmUnOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIHNpemVfdG90YWwsIHNpemVfYXZhaWxhYmxlID0gZ2V0X21vdW50X3NpemUobW91bnQpCgogICAgICAgICAgICBpZiBtb3VudCBpbiBiaW5kX21vdW50czoKICAgICAgICAgICAgICAgICMgb25seSBhZGQgaWYgbm90IGFscmVhZHkgdGhlcmUsIHdlIG1pZ2h0IGhhdmUgYSBwbGFpbiAvZXRjL210YWIKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLk1UQUJfQklORF9NT1VOVF9SRS5tYXRjaChvcHRpb25zKToKICAgICAgICAgICAgICAgICAgICBvcHRpb25zICs9ICIsYmluZCIKCiAgICAgICAgICAgIG1vdW50X2luZm8gPSB7J21vdW50JzogbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RldmljZSc6IGRldmljZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAnZnN0eXBlJzogZnN0eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICdvcHRpb25zJzogb3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAjIHN0YXR2ZnMgZGF0YQogICAgICAgICAgICAgICAgICAgICAgICAgICdzaXplX3RvdGFsJzogc2l6ZV90b3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAnc2l6ZV9hdmFpbGFibGUnOiBzaXplX2F2YWlsYWJsZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAndXVpZCc6IHV1aWRzLmdldChkZXZpY2UsICdOL0EnKX0KCiAgICAgICAgICAgIG1vdW50cy5hcHBlbmQobW91bnRfaW5mbykKCiAgICAgICAgbW91bnRfZmFjdHNbJ21vdW50cyddID0gbW91bnRzCgogICAgICAgIHJldHVybiBtb3VudF9mYWN0cwoKICAgIGRlZiBnZXRfaG9sZGVycyhzZWxmLCBibG9ja19kZXZfZGljdCwgc3lzZGlyKToKICAgICAgICBibG9ja19kZXZfZGljdFsnaG9sZGVycyddID0gW10KICAgICAgICBpZiBvcy5wYXRoLmlzZGlyKHN5c2RpciArICIvaG9sZGVycyIpOgogICAgICAgICAgICBmb3IgZm9sZGVyIGluIG9zLmxpc3RkaXIoc3lzZGlyICsgIi9ob2xkZXJzIik6CiAgICAgICAgICAgICAgICBpZiBub3QgZm9sZGVyLnN0YXJ0c3dpdGgoImRtLSIpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBuYW1lID0gZ2V0X2ZpbGVfY29udGVudChzeXNkaXIgKyAiL2hvbGRlcnMvIiArIGZvbGRlciArICIvZG0vbmFtZSIpCiAgICAgICAgICAgICAgICBpZiBuYW1lOgogICAgICAgICAgICAgICAgICAgIGJsb2NrX2Rldl9kaWN0Wydob2xkZXJzJ10uYXBwZW5kKG5hbWUpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGJsb2NrX2Rldl9kaWN0Wydob2xkZXJzJ10uYXBwZW5kKGZvbGRlcikKCiAgICBkZWYgZ2V0X2RldmljZV9mYWN0cyhzZWxmKToKICAgICAgICBkZXZpY2VfZmFjdHMgPSB7fQoKICAgICAgICBkZXZpY2VfZmFjdHNbJ2RldmljZXMnXSA9IHt9CiAgICAgICAgbHNwY2kgPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoJ2xzcGNpJykKICAgICAgICBpZiBsc3BjaToKICAgICAgICAgICAgcmMsIHBjaWRhdGEsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKFtsc3BjaSwgJy1EJ10sIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fcmVwbGFjZScpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcGNpZGF0YSA9IE5vbmUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBibG9ja19kZXZzID0gb3MubGlzdGRpcigiL3N5cy9ibG9jayIpCiAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgIHJldHVybiBkZXZpY2VfZmFjdHMKCiAgICAgICAgZGV2c193d24gPSB7fQogICAgICAgIHRyeToKICAgICAgICAgICAgZGV2c19ieV9pZCA9IG9zLmxpc3RkaXIoIi9kZXYvZGlzay9ieS1pZCIpCiAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBlbHNlOgogICAgICAgICAgICBmb3IgbGlua19uYW1lIGluIGRldnNfYnlfaWQ6CiAgICAgICAgICAgICAgICBpZiBsaW5rX25hbWUuc3RhcnRzd2l0aCgid3duLSIpOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgd3duX2xpbmsgPSBvcy5yZWFkbGluayhvcy5wYXRoLmpvaW4oIi9kZXYvZGlzay9ieS1pZCIsIGxpbmtfbmFtZSkpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZGV2c193d25bb3MucGF0aC5iYXNlbmFtZSh3d25fbGluayldID0gbGlua19uYW1lWzQ6XQoKICAgICAgICBmb3IgYmxvY2sgaW4gYmxvY2tfZGV2czoKICAgICAgICAgICAgdmlydHVhbCA9IDEKICAgICAgICAgICAgc3lzZnNfbm9fbGlua3MgPSAwCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHBhdGggPSBvcy5yZWFkbGluayhvcy5wYXRoLmpvaW4oIi9zeXMvYmxvY2svIiwgYmxvY2spKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIGUgPSBzeXMuZXhjX2luZm8oKVsxXQogICAgICAgICAgICAgICAgaWYgZS5lcnJubyA9PSBlcnJuby5FSU5WQUw6CiAgICAgICAgICAgICAgICAgICAgcGF0aCA9IGJsb2NrCiAgICAgICAgICAgICAgICAgICAgc3lzZnNfbm9fbGlua3MgPSAxCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmICJ2aXJ0dWFsIiBpbiBwYXRoOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgc3lzZGlyID0gb3MucGF0aC5qb2luKCIvc3lzL2Jsb2NrIiwgcGF0aCkKICAgICAgICAgICAgaWYgc3lzZnNfbm9fbGlua3MgPT0gMToKICAgICAgICAgICAgICAgIGZvciBmb2xkZXIgaW4gb3MubGlzdGRpcihzeXNkaXIpOgogICAgICAgICAgICAgICAgICAgIGlmICJkZXZpY2UiIGluIGZvbGRlcjoKICAgICAgICAgICAgICAgICAgICAgICAgdmlydHVhbCA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGlmIHZpcnR1YWw6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgZCA9IHt9CiAgICAgICAgICAgIGRpc2tuYW1lID0gb3MucGF0aC5iYXNlbmFtZShzeXNkaXIpCiAgICAgICAgICAgIGZvciBrZXkgaW4gWyd2ZW5kb3InLCAnbW9kZWwnLCAnc2FzX2FkZHJlc3MnLCAnc2FzX2RldmljZV9oYW5kbGUnXToKICAgICAgICAgICAgICAgIGRba2V5XSA9IGdldF9maWxlX2NvbnRlbnQoc3lzZGlyICsgIi9kZXZpY2UvIiArIGtleSkKCiAgICAgICAgICAgIHNnX2lucSA9IHNlbGYubW9kdWxlLmdldF9iaW5fcGF0aCgnc2dfaW5xJykKCiAgICAgICAgICAgIGlmIHNnX2lucToKICAgICAgICAgICAgICAgIGRldmljZSA9ICIvZGV2LyVzIiAlIChibG9jaykKICAgICAgICAgICAgICAgIHJjLCBkcml2ZWRhdGEsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKFtzZ19pbnEsIGRldmljZV0pCiAgICAgICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgICAgIHNlcmlhbCA9IHJlLnNlYXJjaCgiVW5pdCBzZXJpYWwgbnVtYmVyOlxzKyhcdyspIiwgZHJpdmVkYXRhKQogICAgICAgICAgICAgICAgICAgIGlmIHNlcmlhbDoKICAgICAgICAgICAgICAgICAgICAgICAgZFsnc2VyaWFsJ10gPSBzZXJpYWwuZ3JvdXAoMSkKCiAgICAgICAgICAgIGZvciBrZXkgaW4gWyd2ZW5kb3InLCAnbW9kZWwnXToKICAgICAgICAgICAgICAgIGRba2V5XSA9IGdldF9maWxlX2NvbnRlbnQoc3lzZGlyICsgIi9kZXZpY2UvIiArIGtleSkKCiAgICAgICAgICAgIGZvciBrZXksIHRlc3QgaW4gWygncmVtb3ZhYmxlJywgJy9yZW1vdmFibGUnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCdzdXBwb3J0X2Rpc2NhcmQnLCAnL3F1ZXVlL2Rpc2NhcmRfZ3JhbnVsYXJpdHknKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXToKICAgICAgICAgICAgICAgIGRba2V5XSA9IGdldF9maWxlX2NvbnRlbnQoc3lzZGlyICsgdGVzdCkKCiAgICAgICAgICAgIGlmIGRpc2tuYW1lIGluIGRldnNfd3duOgogICAgICAgICAgICAgICAgZFsnd3duJ10gPSBkZXZzX3d3bltkaXNrbmFtZV0KCiAgICAgICAgICAgIGRbJ3BhcnRpdGlvbnMnXSA9IHt9CiAgICAgICAgICAgIGZvciBmb2xkZXIgaW4gb3MubGlzdGRpcihzeXNkaXIpOgogICAgICAgICAgICAgICAgbSA9IHJlLnNlYXJjaCgiKCIgKyBkaXNrbmFtZSArICJcZCspIiwgZm9sZGVyKQogICAgICAgICAgICAgICAgaWYgbToKICAgICAgICAgICAgICAgICAgICBwYXJ0ID0ge30KICAgICAgICAgICAgICAgICAgICBwYXJ0bmFtZSA9IG0uZ3JvdXAoMSkKICAgICAgICAgICAgICAgICAgICBwYXJ0X3N5c2RpciA9IHN5c2RpciArICIvIiArIHBhcnRuYW1lCgogICAgICAgICAgICAgICAgICAgIHBhcnRbJ3N0YXJ0J10gPSBnZXRfZmlsZV9jb250ZW50KHBhcnRfc3lzZGlyICsgIi9zdGFydCIsIDApCiAgICAgICAgICAgICAgICAgICAgcGFydFsnc2VjdG9ycyddID0gZ2V0X2ZpbGVfY29udGVudChwYXJ0X3N5c2RpciArICIvc2l6ZSIsIDApCiAgICAgICAgICAgICAgICAgICAgcGFydFsnc2VjdG9yc2l6ZSddID0gZ2V0X2ZpbGVfY29udGVudChwYXJ0X3N5c2RpciArICIvcXVldWUvbG9naWNhbF9ibG9ja19zaXplIikKICAgICAgICAgICAgICAgICAgICBpZiBub3QgcGFydFsnc2VjdG9yc2l6ZSddOgogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0WydzZWN0b3JzaXplJ10gPSBnZXRfZmlsZV9jb250ZW50KHBhcnRfc3lzZGlyICsgIi9xdWV1ZS9od19zZWN0b3Jfc2l6ZSIsIDUxMikKICAgICAgICAgICAgICAgICAgICBwYXJ0WydzaXplJ10gPSBieXRlc190b19odW1hbigoZmxvYXQocGFydFsnc2VjdG9ycyddKSAqIGZsb2F0KHBhcnRbJ3NlY3RvcnNpemUnXSkpKQogICAgICAgICAgICAgICAgICAgIHBhcnRbJ3V1aWQnXSA9IGdldF9wYXJ0aXRpb25fdXVpZChwYXJ0bmFtZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmdldF9ob2xkZXJzKHBhcnQsIHBhcnRfc3lzZGlyKQoKICAgICAgICAgICAgICAgICAgICBkWydwYXJ0aXRpb25zJ11bcGFydG5hbWVdID0gcGFydAoKICAgICAgICAgICAgZFsncm90YXRpb25hbCddID0gZ2V0X2ZpbGVfY29udGVudChzeXNkaXIgKyAiL3F1ZXVlL3JvdGF0aW9uYWwiKQogICAgICAgICAgICBkWydzY2hlZHVsZXJfbW9kZSddID0gIiIKICAgICAgICAgICAgc2NoZWR1bGVyID0gZ2V0X2ZpbGVfY29udGVudChzeXNkaXIgKyAiL3F1ZXVlL3NjaGVkdWxlciIpCiAgICAgICAgICAgIGlmIHNjaGVkdWxlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIG0gPSByZS5tYXRjaCgiLio/KFxbKC4qKVxdKSIsIHNjaGVkdWxlcikKICAgICAgICAgICAgICAgIGlmIG06CiAgICAgICAgICAgICAgICAgICAgZFsnc2NoZWR1bGVyX21vZGUnXSA9IG0uZ3JvdXAoMikKCiAgICAgICAgICAgIGRbJ3NlY3RvcnMnXSA9IGdldF9maWxlX2NvbnRlbnQoc3lzZGlyICsgIi9zaXplIikKICAgICAgICAgICAgaWYgbm90IGRbJ3NlY3RvcnMnXToKICAgICAgICAgICAgICAgIGRbJ3NlY3RvcnMnXSA9IDAKICAgICAgICAgICAgZFsnc2VjdG9yc2l6ZSddID0gZ2V0X2ZpbGVfY29udGVudChzeXNkaXIgKyAiL3F1ZXVlL2xvZ2ljYWxfYmxvY2tfc2l6ZSIpCiAgICAgICAgICAgIGlmIG5vdCBkWydzZWN0b3JzaXplJ106CiAgICAgICAgICAgICAgICBkWydzZWN0b3JzaXplJ10gPSBnZXRfZmlsZV9jb250ZW50KHN5c2RpciArICIvcXVldWUvaHdfc2VjdG9yX3NpemUiLCA1MTIpCiAgICAgICAgICAgIGRbJ3NpemUnXSA9IGJ5dGVzX3RvX2h1bWFuKGZsb2F0KGRbJ3NlY3RvcnMnXSkgKiBmbG9hdChkWydzZWN0b3JzaXplJ10pKQoKICAgICAgICAgICAgZFsnaG9zdCddID0gIiIKCiAgICAgICAgICAgICMgZG9tYWlucyBhcmUgbnVtYmVyZWQgKDAgdG8gZmZmZiksIGJ1cyAoMCB0byBmZiksIHNsb3QgKDAgdG8gMWYpLCBhbmQgZnVuY3Rpb24gKDAgdG8gNykuCiAgICAgICAgICAgIG0gPSByZS5tYXRjaCgiLisvKFthLWYwLTldezR9OlthLWYwLTldezJ9OlswfDFdW2EtZjAtOV1cLlswLTddKS8iLCBzeXNkaXIpCiAgICAgICAgICAgIGlmIG0gYW5kIHBjaWRhdGE6CiAgICAgICAgICAgICAgICBwY2lpZCA9IG0uZ3JvdXAoMSkKICAgICAgICAgICAgICAgIGRpZCA9IHJlLmVzY2FwZShwY2lpZCkKICAgICAgICAgICAgICAgIG0gPSByZS5zZWFyY2goIl4iICsgZGlkICsgIlxzKC4qKSQiLCBwY2lkYXRhLCByZS5NVUxUSUxJTkUpCiAgICAgICAgICAgICAgICBpZiBtOgogICAgICAgICAgICAgICAgICAgIGRbJ2hvc3QnXSA9IG0uZ3JvdXAoMSkKCiAgICAgICAgICAgIHNlbGYuZ2V0X2hvbGRlcnMoZCwgc3lzZGlyKQoKICAgICAgICAgICAgZGV2aWNlX2ZhY3RzWydkZXZpY2VzJ11bZGlza25hbWVdID0gZAoKICAgICAgICByZXR1cm4gZGV2aWNlX2ZhY3RzCgogICAgZGVmIGdldF91cHRpbWVfZmFjdHMoc2VsZik6CiAgICAgICAgdXB0aW1lX2ZhY3RzID0ge30KICAgICAgICB1cHRpbWVfZmlsZV9jb250ZW50ID0gZ2V0X2ZpbGVfY29udGVudCgnL3Byb2MvdXB0aW1lJykKICAgICAgICBpZiB1cHRpbWVfZmlsZV9jb250ZW50OgogICAgICAgICAgICB1cHRpbWVfc2Vjb25kc19zdHJpbmcgPSB1cHRpbWVfZmlsZV9jb250ZW50LnNwbGl0KCcgJylbMF0KICAgICAgICAgICAgdXB0aW1lX2ZhY3RzWyd1cHRpbWVfc2Vjb25kcyddID0gaW50KGZsb2F0KHVwdGltZV9zZWNvbmRzX3N0cmluZykpCgogICAgICAgIHJldHVybiB1cHRpbWVfZmFjdHMKCiAgICBkZWYgX2ZpbmRfbWFwcGVyX2RldmljZV9uYW1lKHNlbGYsIGRtX2RldmljZSk6CiAgICAgICAgZG1fcHJlZml4ID0gJy9kZXYvZG0tJwogICAgICAgIG1hcHBlcl9kZXZpY2UgPSBkbV9kZXZpY2UKICAgICAgICBpZiBkbV9kZXZpY2Uuc3RhcnRzd2l0aChkbV9wcmVmaXgpOgogICAgICAgICAgICBkbXNldHVwX2NtZCA9IHNlbGYubW9kdWxlLmdldF9iaW5fcGF0aCgnZG1zZXR1cCcsIFRydWUpCiAgICAgICAgICAgIG1hcHBlcl9wcmVmaXggPSAnL2Rldi9tYXBwZXIvJwogICAgICAgICAgICByYywgZG1fbmFtZSwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIiVzIGluZm8gLUMgLS1ub2hlYWRpbmdzIC1vIG5hbWUgJXMiICUgKGRtc2V0dXBfY21kLCBkbV9kZXZpY2UpKQogICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgbWFwcGVyX2RldmljZSA9IG1hcHBlcl9wcmVmaXggKyBkbV9uYW1lLnJzdHJpcCgpCiAgICAgICAgcmV0dXJuIG1hcHBlcl9kZXZpY2UKCiAgICBkZWYgZ2V0X2x2bV9mYWN0cyhzZWxmKToKICAgICAgICAiIiIgR2V0IExWTSBGYWN0cyBpZiBydW5uaW5nIGFzIHJvb3QgYW5kIGx2bSB1dGlscyBhcmUgYXZhaWxhYmxlICIiIgoKICAgICAgICBsdm1fZmFjdHMgPSB7fQoKICAgICAgICBpZiBvcy5nZXR1aWQoKSA9PSAwIGFuZCBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoJ3ZncycpOgogICAgICAgICAgICBsdm1fdXRpbF9vcHRpb25zID0gJy0tbm9oZWFkaW5ncyAtLW5vc3VmZml4IC0tdW5pdHMgZycKCiAgICAgICAgICAgIHZnc19wYXRoID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCd2Z3MnKQogICAgICAgICAgICAjIHZncyBmaWVsZHM6IFZHICNQViAjTFYgI1NOIEF0dHIgVlNpemUgVkZyZWUKICAgICAgICAgICAgdmdzID0ge30KICAgICAgICAgICAgaWYgdmdzX3BhdGg6CiAgICAgICAgICAgICAgICByYywgdmdfbGluZXMsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCclcyAlcycgJSAodmdzX3BhdGgsIGx2bV91dGlsX29wdGlvbnMpKQogICAgICAgICAgICAgICAgZm9yIHZnX2xpbmUgaW4gdmdfbGluZXMuc3BsaXRsaW5lcygpOgogICAgICAgICAgICAgICAgICAgIGl0ZW1zID0gdmdfbGluZS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgdmdzW2l0ZW1zWzBdXSA9IHsnc2l6ZV9nJzogaXRlbXNbLTJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ZyZWVfZyc6IGl0ZW1zWy0xXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdudW1fbHZzJzogaXRlbXNbMl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbnVtX3B2cyc6IGl0ZW1zWzFdfQoKICAgICAgICAgICAgbHZzX3BhdGggPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoJ2x2cycpCiAgICAgICAgICAgICMgbHZzIGZpZWxkczoKICAgICAgICAgICAgIyBMViBWRyBBdHRyIExTaXplIFBvb2wgT3JpZ2luIERhdGElIE1vdmUgTG9nIENvcHklIENvbnZlcnQKICAgICAgICAgICAgbHZzID0ge30KICAgICAgICAgICAgaWYgbHZzX3BhdGg6CiAgICAgICAgICAgICAgICByYywgbHZfbGluZXMsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCclcyAlcycgJSAobHZzX3BhdGgsIGx2bV91dGlsX29wdGlvbnMpKQogICAgICAgICAgICAgICAgZm9yIGx2X2xpbmUgaW4gbHZfbGluZXMuc3BsaXRsaW5lcygpOgogICAgICAgICAgICAgICAgICAgIGl0ZW1zID0gbHZfbGluZS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgbHZzW2l0ZW1zWzBdXSA9IHsnc2l6ZV9nJzogaXRlbXNbM10sICd2Zyc6IGl0ZW1zWzFdfQoKICAgICAgICAgICAgcHZzX3BhdGggPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoJ3B2cycpCiAgICAgICAgICAgICMgcHZzIGZpZWxkczogUFYgVkcgI0ZtdCAjQXR0ciBQU2l6ZSBQRnJlZQogICAgICAgICAgICBwdnMgPSB7fQogICAgICAgICAgICBpZiBwdnNfcGF0aDoKICAgICAgICAgICAgICAgIHJjLCBwdl9saW5lcywgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoJyVzICVzJyAlIChwdnNfcGF0aCwgbHZtX3V0aWxfb3B0aW9ucykpCiAgICAgICAgICAgICAgICBmb3IgcHZfbGluZSBpbiBwdl9saW5lcy5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgICAgICAgICAgaXRlbXMgPSBwdl9saW5lLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBwdnNbc2VsZi5fZmluZF9tYXBwZXJfZGV2aWNlX25hbWUoaXRlbXNbMF0pXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgJ3NpemVfZyc6IGl0ZW1zWzRdLAogICAgICAgICAgICAgICAgICAgICAgICAnZnJlZV9nJzogaXRlbXNbNV0sCiAgICAgICAgICAgICAgICAgICAgICAgICd2Zyc6IGl0ZW1zWzFdfQoKICAgICAgICAgICAgbHZtX2ZhY3RzWydsdm0nXSA9IHsnbHZzJzogbHZzLCAndmdzJzogdmdzLCAncHZzJzogcHZzfQoKICAgICAgICByZXR1cm4gbHZtX2ZhY3RzCgoKY2xhc3MgTGludXhIYXJkd2FyZUNvbGxlY3RvcihIYXJkd2FyZUNvbGxlY3Rvcik6CiAgICBfcGxhdGZvcm0gPSAnTGludXgnCiAgICBfZmFjdF9jbGFzcyA9IExpbnV4SGFyZHdhcmUKUEsDBBQAAAAAAMu7K0uwVEF1YQ8AAGEPAAAtAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvc3lzdGVtL3BsYXRmb3JtLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCByZQppbXBvcnQgc29ja2V0CmltcG9ydCBwbGF0Zm9ybQoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy51dGlscyBpbXBvcnQgZ2V0X2ZpbGVfY29udGVudAoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5jb2xsZWN0b3IgaW1wb3J0IEJhc2VGYWN0Q29sbGVjdG9yCgojIGk4NnBjIGlzIGEgU29sYXJpcyBhbmQgZGVyaXZhdGl2ZXMtaXNtClNPTEFSSVNfSTg2X1JFX1BBVFRFUk4gPSByJ2koWzM0NTZdODZ8ODZwYyknCnNvbGFyaXNfaTg2X3JlID0gcmUuY29tcGlsZShTT0xBUklTX0k4Nl9SRV9QQVRURVJOKQoKCmNsYXNzIFBsYXRmb3JtRmFjdENvbGxlY3RvcihCYXNlRmFjdENvbGxlY3Rvcik6CiAgICBuYW1lID0gJ3BsYXRmb3JtJwogICAgX2ZhY3RfaWRzID0gc2V0KFsnc3lzdGVtJywKICAgICAgICAgICAgICAgICAgICAgJ2tlcm5lbCcsCiAgICAgICAgICAgICAgICAgICAgICdtYWNoaW5lJywKICAgICAgICAgICAgICAgICAgICAgJ3B5dGhvbl92ZXJzaW9uJywKICAgICAgICAgICAgICAgICAgICAgJ21hY2hpbmVfaWQnXSkKCiAgICBkZWYgY29sbGVjdChzZWxmLCBtb2R1bGU9Tm9uZSwgY29sbGVjdGVkX2ZhY3RzPU5vbmUpOgogICAgICAgIHBsYXRmb3JtX2ZhY3RzID0ge30KICAgICAgICAjIHBsYXRmb3JtLnN5c3RlbSgpIGNhbiBiZSBMaW51eCwgRGFyd2luLCBKYXZhLCBvciBXaW5kb3dzCiAgICAgICAgcGxhdGZvcm1fZmFjdHNbJ3N5c3RlbSddID0gcGxhdGZvcm0uc3lzdGVtKCkKICAgICAgICBwbGF0Zm9ybV9mYWN0c1sna2VybmVsJ10gPSBwbGF0Zm9ybS5yZWxlYXNlKCkKICAgICAgICBwbGF0Zm9ybV9mYWN0c1snbWFjaGluZSddID0gcGxhdGZvcm0ubWFjaGluZSgpCgogICAgICAgIHBsYXRmb3JtX2ZhY3RzWydweXRob25fdmVyc2lvbiddID0gcGxhdGZvcm0ucHl0aG9uX3ZlcnNpb24oKQoKICAgICAgICBwbGF0Zm9ybV9mYWN0c1snZnFkbiddID0gc29ja2V0LmdldGZxZG4oKQogICAgICAgIHBsYXRmb3JtX2ZhY3RzWydob3N0bmFtZSddID0gcGxhdGZvcm0ubm9kZSgpLnNwbGl0KCcuJylbMF0KICAgICAgICBwbGF0Zm9ybV9mYWN0c1snbm9kZW5hbWUnXSA9IHBsYXRmb3JtLm5vZGUoKQoKICAgICAgICBwbGF0Zm9ybV9mYWN0c1snZG9tYWluJ10gPSAnLicuam9pbihwbGF0Zm9ybV9mYWN0c1snZnFkbiddLnNwbGl0KCcuJylbMTpdKQoKICAgICAgICBhcmNoX2JpdHMgPSBwbGF0Zm9ybS5hcmNoaXRlY3R1cmUoKVswXQoKICAgICAgICBwbGF0Zm9ybV9mYWN0c1sndXNlcnNwYWNlX2JpdHMnXSA9IGFyY2hfYml0cy5yZXBsYWNlKCdiaXQnLCAnJykKICAgICAgICBpZiBwbGF0Zm9ybV9mYWN0c1snbWFjaGluZSddID09ICd4ODZfNjQnOgogICAgICAgICAgICBwbGF0Zm9ybV9mYWN0c1snYXJjaGl0ZWN0dXJlJ10gPSBwbGF0Zm9ybV9mYWN0c1snbWFjaGluZSddCiAgICAgICAgICAgIGlmIHBsYXRmb3JtX2ZhY3RzWyd1c2Vyc3BhY2VfYml0cyddID09ICc2NCc6CiAgICAgICAgICAgICAgICBwbGF0Zm9ybV9mYWN0c1sndXNlcnNwYWNlX2FyY2hpdGVjdHVyZSddID0gJ3g4Nl82NCcKICAgICAgICAgICAgZWxpZiBwbGF0Zm9ybV9mYWN0c1sndXNlcnNwYWNlX2JpdHMnXSA9PSAnMzInOgogICAgICAgICAgICAgICAgcGxhdGZvcm1fZmFjdHNbJ3VzZXJzcGFjZV9hcmNoaXRlY3R1cmUnXSA9ICdpMzg2JwogICAgICAgIGVsaWYgc29sYXJpc19pODZfcmUuc2VhcmNoKHBsYXRmb3JtX2ZhY3RzWydtYWNoaW5lJ10pOgogICAgICAgICAgICBwbGF0Zm9ybV9mYWN0c1snYXJjaGl0ZWN0dXJlJ10gPSAnaTM4NicKICAgICAgICAgICAgaWYgcGxhdGZvcm1fZmFjdHNbJ3VzZXJzcGFjZV9iaXRzJ10gPT0gJzY0JzoKICAgICAgICAgICAgICAgIHBsYXRmb3JtX2ZhY3RzWyd1c2Vyc3BhY2VfYXJjaGl0ZWN0dXJlJ10gPSAneDg2XzY0JwogICAgICAgICAgICBlbGlmIHBsYXRmb3JtX2ZhY3RzWyd1c2Vyc3BhY2VfYml0cyddID09ICczMic6CiAgICAgICAgICAgICAgICBwbGF0Zm9ybV9mYWN0c1sndXNlcnNwYWNlX2FyY2hpdGVjdHVyZSddID0gJ2kzODYnCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcGxhdGZvcm1fZmFjdHNbJ2FyY2hpdGVjdHVyZSddID0gcGxhdGZvcm1fZmFjdHNbJ21hY2hpbmUnXQoKICAgICAgICBpZiBwbGF0Zm9ybV9mYWN0c1snc3lzdGVtJ10gPT0gJ0FJWCc6CiAgICAgICAgICAgICMgQXR0ZW1wdCB0byB1c2UgZ2V0Y29uZiB0byBmaWd1cmUgb3V0IGFyY2hpdGVjdHVyZQogICAgICAgICAgICAjIGZhbGwgYmFjayB0byBib290aW5mbyBpZiBuZWVkZWQKICAgICAgICAgICAgZ2V0Y29uZl9iaW4gPSBtb2R1bGUuZ2V0X2Jpbl9wYXRoKCdnZXRjb25mJykKICAgICAgICAgICAgaWYgZ2V0Y29uZl9iaW46CiAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBtb2R1bGUucnVuX2NvbW1hbmQoW2dldGNvbmZfYmluLCAnTUFDSElORV9BUkNISVRFQ1RVUkUnXSkKICAgICAgICAgICAgICAgIGRhdGEgPSBvdXQuc3BsaXRsaW5lcygpCiAgICAgICAgICAgICAgICBwbGF0Zm9ybV9mYWN0c1snYXJjaGl0ZWN0dXJlJ10gPSBkYXRhWzBdCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBib290aW5mb19iaW4gPSBtb2R1bGUuZ2V0X2Jpbl9wYXRoKCdib290aW5mbycpCiAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBtb2R1bGUucnVuX2NvbW1hbmQoW2Jvb3RpbmZvX2JpbiwgJy1wJ10pCiAgICAgICAgICAgICAgICBkYXRhID0gb3V0LnNwbGl0bGluZXMoKQogICAgICAgICAgICAgICAgcGxhdGZvcm1fZmFjdHNbJ2FyY2hpdGVjdHVyZSddID0gZGF0YVswXQogICAgICAgIGVsaWYgcGxhdGZvcm1fZmFjdHNbJ3N5c3RlbSddID09ICdPcGVuQlNEJzoKICAgICAgICAgICAgcGxhdGZvcm1fZmFjdHNbJ2FyY2hpdGVjdHVyZSddID0gcGxhdGZvcm0udW5hbWUoKVs1XQoKICAgICAgICBtYWNoaW5lX2lkID0gZ2V0X2ZpbGVfY29udGVudCgiL3Zhci9saWIvZGJ1cy9tYWNoaW5lLWlkIikgb3IgZ2V0X2ZpbGVfY29udGVudCgiL2V0Yy9tYWNoaW5lLWlkIikKICAgICAgICBpZiBtYWNoaW5lX2lkOgogICAgICAgICAgICBtYWNoaW5lX2lkID0gbWFjaGluZV9pZC5zcGxpdGxpbmVzKClbMF0KICAgICAgICAgICAgcGxhdGZvcm1fZmFjdHNbIm1hY2hpbmVfaWQiXSA9IG1hY2hpbmVfaWQKCiAgICAgICAgcmV0dXJuIHBsYXRmb3JtX2ZhY3RzClBLAwQUAAAAAADLuytLHV16ohIgAAASIAAAKwAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL2hhcmR3YXJlL2hwdXgucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKaW1wb3J0IG9zCmltcG9ydCByZQoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5oYXJkd2FyZS5iYXNlIGltcG9ydCBIYXJkd2FyZSwgSGFyZHdhcmVDb2xsZWN0b3IKCgpjbGFzcyBIUFVYSGFyZHdhcmUoSGFyZHdhcmUpOgogICAgIiIiCiAgICBIUC1VWC1zcGVjaWZpYyBzdWJjbGFzcyBvZiBIYXJkd2FyZS4gRGVmaW5lcyBtZW1vcnkgYW5kIENQVSBmYWN0czoKICAgIC0gbWVtZnJlZV9tYgogICAgLSBtZW10b3RhbF9tYgogICAgLSBzd2FwZnJlZV9tYgogICAgLSBzd2FwdG90YWxfbWIKICAgIC0gcHJvY2Vzc29yCiAgICAtIHByb2Nlc3Nvcl9jb3JlcwogICAgLSBwcm9jZXNzb3JfY291bnQKICAgIC0gbW9kZWwKICAgIC0gZmlybXdhcmUKICAgICIiIgoKICAgIHBsYXRmb3JtID0gJ0hQLVVYJwoKICAgIGRlZiBwb3B1bGF0ZShzZWxmLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgaGFyZHdhcmVfZmFjdHMgPSB7fQoKICAgICAgICBjcHVfZmFjdHMgPSBzZWxmLmdldF9jcHVfZmFjdHMoY29sbGVjdGVkX2ZhY3RzPWNvbGxlY3RlZF9mYWN0cykKICAgICAgICBtZW1vcnlfZmFjdHMgPSBzZWxmLmdldF9tZW1vcnlfZmFjdHMoKQogICAgICAgIGh3X2ZhY3RzID0gc2VsZi5nZXRfaHdfZmFjdHMoKQoKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUoY3B1X2ZhY3RzKQogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShtZW1vcnlfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKGh3X2ZhY3RzKQoKICAgICAgICByZXR1cm4gaGFyZHdhcmVfZmFjdHMKCiAgICBkZWYgZ2V0X2NwdV9mYWN0cyhzZWxmLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgY3B1X2ZhY3RzID0ge30KICAgICAgICBjb2xsZWN0ZWRfZmFjdHMgPSBjb2xsZWN0ZWRfZmFjdHMgb3Ige30KCiAgICAgICAgaWYgY29sbGVjdGVkX2ZhY3RzLmdldCgnYW5zaWJsZV9hcmNoaXRlY3R1cmUnKSA9PSAnOTAwMC84MDAnOgogICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiaW9zY2FuIC1Ga0Nwcm9jZXNzb3IgfCB3YyAtbCIsIHVzZV91bnNhZmVfc2hlbGw9VHJ1ZSkKICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY291bnQnXSA9IGludChvdXQuc3RyaXAoKSkKICAgICAgICAjIFdvcmtpbmcgd2l0aCBtYWNoaW5mbyBtZXNzCiAgICAgICAgZWxpZiBjb2xsZWN0ZWRfZmFjdHMuZ2V0KCdhbnNpYmxlX2FyY2hpdGVjdHVyZScpID09ICdpYTY0JzoKICAgICAgICAgICAgaWYgY29sbGVjdGVkX2ZhY3RzLmdldCgnYW5zaWJsZV9kaXN0cmlidXRpb25fdmVyc2lvbicpID09ICJCLjExLjIzIjoKICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvdXNyL2NvbnRyaWIvYmluL21hY2hpbmZvIHwgZ3JlcCAnTnVtYmVyIG9mIENQVXMnIiwgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlKQogICAgICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY291bnQnXSA9IGludChvdXQuc3RyaXAoKS5zcGxpdCgnPScpWzFdKQogICAgICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3IvY29udHJpYi9iaW4vbWFjaGluZm8gfCBncmVwICdwcm9jZXNzb3IgZmFtaWx5JyIsIHVzZV91bnNhZmVfc2hlbGw9VHJ1ZSkKICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yJ10gPSByZS5zZWFyY2goJy4qKEludGVsLiopJywgb3V0KS5ncm91cHMoKVswXS5zdHJpcCgpCiAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiaW9zY2FuIC1Ga0Nwcm9jZXNzb3IgfCB3YyAtbCIsIHVzZV91bnNhZmVfc2hlbGw9VHJ1ZSkKICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yX2NvcmVzJ10gPSBpbnQob3V0LnN0cmlwKCkpCiAgICAgICAgICAgIGlmIGNvbGxlY3RlZF9mYWN0cy5nZXQoJ2Fuc2libGVfZGlzdHJpYnV0aW9uX3ZlcnNpb24nKSA9PSAiQi4xMS4zMSI6CiAgICAgICAgICAgICAgICAjIGlmIG1hY2hpbmZvIHJldHVybiBjb3JlcyBzdHJpbmdzIHJlbGVhc2UgQi4xMS4zMSA+IDEyMDQKICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvdXNyL2NvbnRyaWIvYmluL21hY2hpbmZvIHwgZ3JlcCBjb3JlIHwgd2MgLWwiLCB1c2VfdW5zYWZlX3NoZWxsPVRydWUpCiAgICAgICAgICAgICAgICBpZiBvdXQuc3RyaXAoKSA9PSAnMCc6CiAgICAgICAgICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3IvY29udHJpYi9iaW4vbWFjaGluZm8gfCBncmVwIEludGVsIiwgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlKQogICAgICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yX2NvdW50J10gPSBpbnQob3V0LnN0cmlwKCkuc3BsaXQoIiAiKVswXSkKICAgICAgICAgICAgICAgICAgICAjIElmIGh5cGVydGhyZWFkaW5nIGlzIGFjdGl2ZSBkaXZpZGUgY29yZXMgYnkgMgogICAgICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvdXNyL3NiaW4vcHNyc2V0IHwgZ3JlcCBMQ1BVIiwgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlKQogICAgICAgICAgICAgICAgICAgIGRhdGEgPSByZS5zdWIoJyArJywgJyAnLCBvdXQpLnN0cmlwKCkuc3BsaXQoJyAnKQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihkYXRhKSA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICBoeXBlcnRocmVhZGluZyA9ICdPRkYnCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgaHlwZXJ0aHJlYWRpbmcgPSBkYXRhWzFdCiAgICAgICAgICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3IvY29udHJpYi9iaW4vbWFjaGluZm8gfCBncmVwIGxvZ2ljYWwiLCB1c2VfdW5zYWZlX3NoZWxsPVRydWUpCiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IG91dC5zdHJpcCgpLnNwbGl0KCIgIikKICAgICAgICAgICAgICAgICAgICBpZiBoeXBlcnRocmVhZGluZyA9PSAnT04nOgogICAgICAgICAgICAgICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3JlcyddID0gaW50KGRhdGFbMF0pIC8gMgogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihkYXRhKSA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY29yZXMnXSA9IGNwdV9mYWN0c1sncHJvY2Vzc29yX2NvdW50J10KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yX2NvcmVzJ10gPSBpbnQoZGF0YVswXSkKICAgICAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiL3Vzci9jb250cmliL2Jpbi9tYWNoaW5mbyB8IGdyZXAgSW50ZWwgfGN1dCAtZCcgJyAtZjQtIiwgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlKQogICAgICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yJ10gPSBvdXQuc3RyaXAoKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiL3Vzci9jb250cmliL2Jpbi9tYWNoaW5mbyB8IGVncmVwICdzb2NrZXRbc10/JCcgfCB0YWlsIC0xIiwgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlKQogICAgICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yX2NvdW50J10gPSBpbnQob3V0LnN0cmlwKCkuc3BsaXQoIiAiKVswXSkKICAgICAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiL3Vzci9jb250cmliL2Jpbi9tYWNoaW5mbyB8IGdyZXAgLWUgJ1swLTldIGNvcmUnIHwgdGFpbCAtMSIsIHVzZV91bnNhZmVfc2hlbGw9VHJ1ZSkKICAgICAgICAgICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3JlcyddID0gaW50KG91dC5zdHJpcCgpLnNwbGl0KCIgIilbMF0pCiAgICAgICAgICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3IvY29udHJpYi9iaW4vbWFjaGluZm8gfCBncmVwIEludGVsIiwgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlKQogICAgICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yJ10gPSBvdXQuc3RyaXAoKQoKICAgICAgICByZXR1cm4gY3B1X2ZhY3RzCgogICAgZGVmIGdldF9tZW1vcnlfZmFjdHMoc2VsZiwgY29sbGVjdGVkX2ZhY3RzPU5vbmUpOgogICAgICAgIG1lbW9yeV9mYWN0cyA9IHt9CiAgICAgICAgY29sbGVjdGVkX2ZhY3RzID0gY29sbGVjdGVkX2ZhY3RzIG9yIHt9CgogICAgICAgIHBhZ2VzaXplID0gNDA5NgogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvdXNyL2Jpbi92bXN0YXQgfCB0YWlsIC0xIiwgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlKQogICAgICAgIGRhdGEgPSBpbnQocmUuc3ViKCcgKycsICcgJywgb3V0KS5zcGxpdCgnICcpWzVdLnN0cmlwKCkpCiAgICAgICAgbWVtb3J5X2ZhY3RzWydtZW1mcmVlX21iJ10gPSBwYWdlc2l6ZSAqIGRhdGEgLy8gMTAyNCAvLyAxMDI0CiAgICAgICAgaWYgY29sbGVjdGVkX2ZhY3RzLmdldCgnYW5zaWJsZV9hcmNoaXRlY3R1cmUnKSA9PSAnOTAwMC84MDAnOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiZ3JlcCBQaHlzaWNhbCAvdmFyL2FkbS9zeXNsb2cvc3lzbG9nLmxvZyIpCiAgICAgICAgICAgICAgICBkYXRhID0gcmUuc2VhcmNoKCcuKlBoeXNpY2FsOiAoWzAtOV0qKSBLYnl0ZXMuKicsIG91dCkuZ3JvdXBzKClbMF0uc3RyaXAoKQogICAgICAgICAgICAgICAgbWVtb3J5X2ZhY3RzWydtZW10b3RhbF9tYiddID0gaW50KGRhdGEpIC8vIDEwMjQKICAgICAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICAgICAgIyBGb3Igc3lzdGVtcyB3aGVyZSBtZW1vcnkgZGV0YWlscyBhcmVuJ3Qgc2VudCB0byBzeXNsb2cgb3IgdGhlIGxvZyBoYXMgcm90YXRlZCwgdXNlIHBhcnNlZAogICAgICAgICAgICAgICAgIyBhZGIgb3V0cHV0LiBVbmZvcnR1bmF0ZWx5IC9kZXYva21lbSBkb2Vzbid0IGhhdmUgd29ybGQtcmVhZCwgc28gdGhpcyBvbmx5IHdvcmtzIGFzIHJvb3QuCiAgICAgICAgICAgICAgICBpZiBvcy5hY2Nlc3MoIi9kZXYva21lbSIsIG9zLlJfT0spOgogICAgICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCJlY2hvICdwaHlzX21lbV9wYWdlcy9EJyB8IGFkYiAtayAvc3RhbmQvdm11bml4IC9kZXYva21lbSB8IHRhaWwgLTEgfCBhd2sgJ3twcmludCAkMn0nIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VfdW5zYWZlX3NoZWxsPVRydWUpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGVycjoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IG91dAogICAgICAgICAgICAgICAgICAgICAgICBtZW1vcnlfZmFjdHNbJ21lbXRvdGFsX21iJ10gPSBpbnQoZGF0YSkgLyAyNTYKICAgICAgICBlbHNlOgogICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiL3Vzci9jb250cmliL2Jpbi9tYWNoaW5mbyB8IGdyZXAgTWVtb3J5IiwgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlKQogICAgICAgICAgICBkYXRhID0gcmUuc2VhcmNoKCdNZW1vcnlbXCA6PV0qKFswLTldKikuKk1CLionLCBvdXQpLmdyb3VwcygpWzBdLnN0cmlwKCkKICAgICAgICAgICAgbWVtb3J5X2ZhY3RzWydtZW10b3RhbF9tYiddID0gaW50KGRhdGEpCiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3Ivc2Jpbi9zd2FwaW5mbyAtbSAtZCAtZiAtcSIpCiAgICAgICAgbWVtb3J5X2ZhY3RzWydzd2FwdG90YWxfbWInXSA9IGludChvdXQuc3RyaXAoKSkKICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiL3Vzci9zYmluL3N3YXBpbmZvIC1tIC1kIC1mIHwgZWdyZXAgJ15kZXZ8XmZzJyIsIHVzZV91bnNhZmVfc2hlbGw9VHJ1ZSkKICAgICAgICBzd2FwID0gMAogICAgICAgIGZvciBsaW5lIGluIG91dC5zdHJpcCgpLnNwbGl0bGluZXMoKToKICAgICAgICAgICAgc3dhcCArPSBpbnQocmUuc3ViKCcgKycsICcgJywgbGluZSkuc3BsaXQoJyAnKVszXS5zdHJpcCgpKQogICAgICAgIG1lbW9yeV9mYWN0c1snc3dhcGZyZWVfbWInXSA9IHN3YXAKCiAgICAgICAgcmV0dXJuIG1lbW9yeV9mYWN0cwoKICAgIGRlZiBnZXRfaHdfZmFjdHMoc2VsZiwgY29sbGVjdGVkX2ZhY3RzPU5vbmUpOgogICAgICAgIGh3X2ZhY3RzID0ge30KICAgICAgICBjb2xsZWN0ZWRfZmFjdHMgPSBjb2xsZWN0ZWRfZmFjdHMgb3Ige30KCiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIm1vZGVsIikKICAgICAgICBod19mYWN0c1snbW9kZWwnXSA9IG91dC5zdHJpcCgpCiAgICAgICAgaWYgY29sbGVjdGVkX2ZhY3RzLmdldCgnYW5zaWJsZV9hcmNoaXRlY3R1cmUnKSA9PSAnaWE2NCc6CiAgICAgICAgICAgIHNlcGFyYXRvciA9ICc6JwogICAgICAgICAgICBpZiBjb2xsZWN0ZWRfZmFjdHMuZ2V0KCdhbnNpYmxlX2Rpc3RyaWJ1dGlvbl92ZXJzaW9uJykgPT0gIkIuMTEuMjMiOgogICAgICAgICAgICAgICAgc2VwYXJhdG9yID0gJz0nCiAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvdXNyL2NvbnRyaWIvYmluL21hY2hpbmZvIHxncmVwIC1pICdGaXJtd2FyZSByZXZpc2lvbicgfCBncmVwIC12IEJNQyIsIHVzZV91bnNhZmVfc2hlbGw9VHJ1ZSkKICAgICAgICAgICAgaHdfZmFjdHNbJ2Zpcm13YXJlX3ZlcnNpb24nXSA9IG91dC5zcGxpdChzZXBhcmF0b3IpWzFdLnN0cmlwKCkKICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3IvY29udHJpYi9iaW4vbWFjaGluZm8gfGdyZXAgLWkgJ01hY2hpbmUgc2VyaWFsIG51bWJlcicgIiwgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlKQogICAgICAgICAgICBpZiByYyA9PSAwIGFuZCBvdXQ6CiAgICAgICAgICAgICAgICBod19mYWN0c1sncHJvZHVjdF9zZXJpYWwnXSA9IG91dC5zcGxpdChzZXBhcmF0b3IpWzFdLnN0cmlwKCkKCiAgICAgICAgcmV0dXJuIGh3X2ZhY3RzCgoKY2xhc3MgSFBVWEhhcmR3YXJlQ29sbGVjdG9yKEhhcmR3YXJlQ29sbGVjdG9yKToKICAgIF9mYWN0X2NsYXNzID0gSFBVWEhhcmR3YXJlCiAgICBfcGxhdGZvcm0gPSAnSFAtVVgnClBLAwQUAAAAAADLuytLfxQ/zfwGAAD8BgAAKQAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS91c2VyLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCBnZXRwYXNzCmltcG9ydCBvcwppbXBvcnQgcHdkCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmNvbGxlY3RvciBpbXBvcnQgQmFzZUZhY3RDb2xsZWN0b3IKCgpjbGFzcyBVc2VyRmFjdENvbGxlY3RvcihCYXNlRmFjdENvbGxlY3Rvcik6CiAgICBuYW1lID0gJ3VzZXInCiAgICBfZmFjdF9pZHMgPSBzZXQoWyd1c2VyX2lkJywgJ3VzZXJfdWlkJywgJ3VzZXJfZ2lkJywKICAgICAgICAgICAgICAgICAgICAgJ3VzZXJfZ2Vjb3MnLCAndXNlcl9kaXInLCAndXNlcl9zaGVsbCcsCiAgICAgICAgICAgICAgICAgICAgICdyZWFsX3VzZXJfaWQnLCAnZWZmZWN0aXZlX3VzZXJfaWQnLAogICAgICAgICAgICAgICAgICAgICAnZWZmZWN0aXZlX2dyb3VwX2lkcyddKQoKICAgIGRlZiBjb2xsZWN0KHNlbGYsIG1vZHVsZT1Ob25lLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgdXNlcl9mYWN0cyA9IHt9CgogICAgICAgIHVzZXJfZmFjdHNbJ3VzZXJfaWQnXSA9IGdldHBhc3MuZ2V0dXNlcigpCgogICAgICAgIHB3ZW50ID0gcHdkLmdldHB3bmFtKGdldHBhc3MuZ2V0dXNlcigpKQoKICAgICAgICB1c2VyX2ZhY3RzWyd1c2VyX3VpZCddID0gcHdlbnQucHdfdWlkCiAgICAgICAgdXNlcl9mYWN0c1sndXNlcl9naWQnXSA9IHB3ZW50LnB3X2dpZAogICAgICAgIHVzZXJfZmFjdHNbJ3VzZXJfZ2Vjb3MnXSA9IHB3ZW50LnB3X2dlY29zCiAgICAgICAgdXNlcl9mYWN0c1sndXNlcl9kaXInXSA9IHB3ZW50LnB3X2RpcgogICAgICAgIHVzZXJfZmFjdHNbJ3VzZXJfc2hlbGwnXSA9IHB3ZW50LnB3X3NoZWxsCiAgICAgICAgdXNlcl9mYWN0c1sncmVhbF91c2VyX2lkJ10gPSBvcy5nZXR1aWQoKQogICAgICAgIHVzZXJfZmFjdHNbJ2VmZmVjdGl2ZV91c2VyX2lkJ10gPSBvcy5nZXRldWlkKCkKICAgICAgICB1c2VyX2ZhY3RzWydyZWFsX2dyb3VwX2lkJ10gPSBvcy5nZXRnaWQoKQogICAgICAgIHVzZXJfZmFjdHNbJ2VmZmVjdGl2ZV9ncm91cF9pZCddID0gb3MuZ2V0Z2lkKCkKCiAgICAgICAgcmV0dXJuIHVzZXJfZmFjdHMKUEsDBBQAAAAAAMu7K0th+8iz2QYAANkGAAArAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvaGFyZHdhcmUvaHVyZC5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnRpbWVvdXQgaW1wb3J0IFRpbWVvdXRFcnJvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmhhcmR3YXJlLmJhc2UgaW1wb3J0IEhhcmR3YXJlQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUubGludXggaW1wb3J0IExpbnV4SGFyZHdhcmUKCgpjbGFzcyBIdXJkSGFyZHdhcmUoTGludXhIYXJkd2FyZSk6CiAgICAiIiIKICAgIEdOVSBIdXJkIHNwZWNpZmljIHN1YmNsYXNzIG9mIEhhcmR3YXJlLiBEZWZpbmUgbWVtb3J5IGFuZCBtb3VudCBmYWN0cwogICAgYmFzZWQgb24gcHJvY2ZzIGNvbXBhdGliaWxpdHkgdHJhbnNsYXRvciBtaW1pY2tpbmcgdGhlIGludGVyZmFjZSBvZgogICAgdGhlIExpbnV4IGtlcm5lbC4KICAgICIiIgoKICAgIHBsYXRmb3JtID0gJ0dOVScKCiAgICBkZWYgcG9wdWxhdGUoc2VsZiwgY29sbGVjdGVkX2ZhY3RzPU5vbmUpOgogICAgICAgIGhhcmR3YXJlX2ZhY3RzID0ge30KICAgICAgICB1cHRpbWVfZmFjdHMgPSBzZWxmLmdldF91cHRpbWVfZmFjdHMoKQogICAgICAgIG1lbW9yeV9mYWN0cyA9IHNlbGYuZ2V0X21lbW9yeV9mYWN0cygpCgogICAgICAgIG1vdW50X2ZhY3RzID0ge30KICAgICAgICB0cnk6CiAgICAgICAgICAgIG1vdW50X2ZhY3RzID0gc2VsZi5nZXRfbW91bnRfZmFjdHMoKQogICAgICAgIGV4Y2VwdCBUaW1lb3V0RXJyb3I6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKHVwdGltZV9mYWN0cykKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUobWVtb3J5X2ZhY3RzKQogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShtb3VudF9mYWN0cykKCiAgICAgICAgcmV0dXJuIGhhcmR3YXJlX2ZhY3RzCgoKY2xhc3MgSHVyZEhhcmR3YXJlQ29sbGVjdG9yKEhhcmR3YXJlQ29sbGVjdG9yKToKICAgIF9mYWN0X2NsYXNzID0gSHVyZEhhcmR3YXJlCiAgICBfcGxhdGZvcm0gPSAnR05VJwpQSwMEFAAAAAAAy7srS01C+rapCwAAqQsAACoAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9vdGhlci9mYWN0ZXIucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKaW1wb3J0IGpzb24KCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmFtZXNwYWNlIGltcG9ydCBQcmVmaXhGYWN0TmFtZXNwYWNlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmNvbGxlY3RvciBpbXBvcnQgQmFzZUZhY3RDb2xsZWN0b3IKCgpjbGFzcyBGYWN0ZXJGYWN0Q29sbGVjdG9yKEJhc2VGYWN0Q29sbGVjdG9yKToKICAgIG5hbWUgPSAnZmFjdGVyJwogICAgX2ZhY3RfaWRzID0gc2V0KFsnZmFjdGVyJ10pCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbGxlY3RvcnM9Tm9uZSwgbmFtZXNwYWNlPU5vbmUpOgogICAgICAgIG5hbWVzcGFjZSA9IFByZWZpeEZhY3ROYW1lc3BhY2UobmFtZXNwYWNlX25hbWU9J2ZhY3RlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVmaXg9J2ZhY3Rlcl8nKQogICAgICAgIHN1cGVyKEZhY3RlckZhY3RDb2xsZWN0b3IsIHNlbGYpLl9faW5pdF9fKGNvbGxlY3RvcnM9Y29sbGVjdG9ycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lc3BhY2U9bmFtZXNwYWNlKQoKICAgIGRlZiBmaW5kX2ZhY3RlcihzZWxmLCBtb2R1bGUpOgogICAgICAgIGZhY3Rlcl9wYXRoID0gbW9kdWxlLmdldF9iaW5fcGF0aCgnZmFjdGVyJywgb3B0X2RpcnM9Wycvb3B0L3B1cHBldGxhYnMvYmluJ10pCiAgICAgICAgY2ZhY3Rlcl9wYXRoID0gbW9kdWxlLmdldF9iaW5fcGF0aCgnY2ZhY3RlcicsIG9wdF9kaXJzPVsnL29wdC9wdXBwZXRsYWJzL2JpbiddKQoKICAgICAgICAjIFByZWZlciB0byB1c2UgY2ZhY3RlciBpZiBhdmFpbGFibGUKICAgICAgICBpZiBjZmFjdGVyX3BhdGggaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGZhY3Rlcl9wYXRoID0gY2ZhY3Rlcl9wYXRoCgogICAgICAgIHJldHVybiBmYWN0ZXJfcGF0aAoKICAgIGRlZiBydW5fZmFjdGVyKHNlbGYsIG1vZHVsZSwgZmFjdGVyX3BhdGgpOgogICAgICAgICMgaWYgZmFjdGVyIGlzIGluc3RhbGxlZCwgYW5kIHdlIGNhbiB1c2UgLS1qc29uIGJlY2F1c2UKICAgICAgICAjIHJ1YnktanNvbiBpcyBBTFNPIGluc3RhbGxlZCwgaW5jbHVkZSBmYWN0ZXIgZGF0YSBpbiB0aGUgSlNPTgogICAgICAgIHJjLCBvdXQsIGVyciA9IG1vZHVsZS5ydW5fY29tbWFuZChmYWN0ZXJfcGF0aCArICIgLS1wdXBwZXQgLS1qc29uIikKICAgICAgICByZXR1cm4gcmMsIG91dCwgZXJyCgogICAgZGVmIGdldF9mYWN0ZXJfb3V0cHV0KHNlbGYsIG1vZHVsZSk6CiAgICAgICAgZmFjdGVyX3BhdGggPSBzZWxmLmZpbmRfZmFjdGVyKG1vZHVsZSkKICAgICAgICBpZiBub3QgZmFjdGVyX3BhdGg6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYucnVuX2ZhY3Rlcihtb2R1bGUsIGZhY3Rlcl9wYXRoKQoKICAgICAgICBpZiByYyAhPSAwOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICByZXR1cm4gb3V0CgogICAgZGVmIGNvbGxlY3Qoc2VsZiwgbW9kdWxlPU5vbmUsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICAjIE5vdGUgdGhhdCB0aGlzIG1pcnJvcnMgcHJldmlvdXMgZmFjdGVyIGJlaGF2aW9yLCB3aGVyZSB0aGVyZSBpc250CiAgICAgICAgIyBhICdhbnNpYmxlX2ZhY3Rlcicga2V5IGluIHRoZSBtYWluIGZhY3QgZGljdCwgYnV0IGluc3RlYWQsICdmYWN0ZXJfd2hhdGV2ZXInCiAgICAgICAgIyBpdGVtcyBhcmUgYWRkZWQgdG8gdGhlIG1haW4gZGljdC4KICAgICAgICBmYWN0ZXJfZGljdCA9IHt9CgogICAgICAgIGlmIG5vdCBtb2R1bGU6CiAgICAgICAgICAgIHJldHVybiBmYWN0ZXJfZGljdAoKICAgICAgICBmYWN0ZXJfb3V0cHV0ID0gc2VsZi5nZXRfZmFjdGVyX291dHB1dChtb2R1bGUpCgogICAgICAgICMgVE9ETzogaWYgd2UgZmFpbCwgc2hvdWxkIHdlIGFkZCBhIGVtcHR5IGZhY3RlciBrZXkgb3Igbm90aGluZz8KICAgICAgICBpZiBmYWN0ZXJfb3V0cHV0IGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBmYWN0ZXJfZGljdAoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZhY3Rlcl9kaWN0ID0ganNvbi5sb2FkcyhmYWN0ZXJfb3V0cHV0KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICMgRklYTUU6IG1heWJlIHJhaXNlIGEgRmFjdENvbGxlY3RvckVycm9yIHdpdGggc29tZSBpbmZvIGF0dHJzPwogICAgICAgICAgICBwYXNzCgogICAgICAgIHJldHVybiBmYWN0ZXJfZGljdApQSwMEFAAAAAAAy7srS4qVblFpFQAAaRUAACsAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy92aXJ0dWFsL3N1bm9zLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCBvcwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy52aXJ0dWFsLmJhc2UgaW1wb3J0IFZpcnR1YWwsIFZpcnR1YWxDb2xsZWN0b3IKCgpjbGFzcyBTdW5PU1ZpcnR1YWwoVmlydHVhbCk6CiAgICAiIiIKICAgIFRoaXMgaXMgYSBTdW5PUy1zcGVjaWZpYyBzdWJjbGFzcyBvZiBWaXJ0dWFsLiAgSXQgZGVmaW5lcwogICAgLSB2aXJ0dWFsaXphdGlvbl90eXBlCiAgICAtIHZpcnR1YWxpemF0aW9uX3JvbGUKICAgIC0gY29udGFpbmVyCiAgICAiIiIKICAgIHBsYXRmb3JtID0gJ1N1bk9TJwoKICAgIGRlZiBnZXRfdmlydHVhbF9mYWN0cyhzZWxmKToKICAgICAgICB2aXJ0dWFsX2ZhY3RzID0ge30KICAgICAgICAjIENoZWNrIGlmIGl0J3MgYSB6b25lCgogICAgICAgIHpvbmVuYW1lID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCd6b25lbmFtZScpCiAgICAgICAgaWYgem9uZW5hbWU6CiAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKHpvbmVuYW1lKQogICAgICAgICAgICBpZiByYyA9PSAwIGFuZCBvdXQucnN0cmlwKCkgIT0gImdsb2JhbCI6CiAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWydjb250YWluZXInXSA9ICd6b25lJwogICAgICAgICMgQ2hlY2sgaWYgaXQncyBhIGJyYW5kZWQgem9uZSAoaS5lLiBTb2xhcmlzIDgvOSB6b25lKQogICAgICAgIGlmIG9zLnBhdGguaXNkaXIoJy8uU1VOV25hdGl2ZScpOgogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWydjb250YWluZXInXSA9ICd6b25lJwogICAgICAgICMgSWYgaXQncyBhIHpvbmUgY2hlY2sgaWYgd2UgY2FuIGRldGVjdCBpZiBvdXIgZ2xvYmFsIHpvbmUgaXMgaXRzZWxmIHZpcnR1YWxpemVkLgogICAgICAgICMgUmVsaWVzIG9uIHRoZSAiZ3Vlc3QgdG9vbHMiIChlLmcuIHZtd2FyZSB0b29scykgdG8gYmUgaW5zdGFsbGVkCgogICAgICAgIGlmICdjb250YWluZXInIGluIHZpcnR1YWxfZmFjdHMgYW5kIHZpcnR1YWxfZmFjdHNbJ2NvbnRhaW5lciddID09ICd6b25lJzoKICAgICAgICAgICAgbW9kaW5mbyA9IHNlbGYubW9kdWxlLmdldF9iaW5fcGF0aCgnbW9kaW5mbycpCiAgICAgICAgICAgIGlmIG1vZGluZm86CiAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZChtb2RpbmZvKQogICAgICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBvdXQuc3BsaXRsaW5lcygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiAnVk13YXJlJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ3Ztd2FyZScKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdndWVzdCcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgJ1ZpcnR1YWxCb3gnIGluIGxpbmU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAndmlydHVhbGJveCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdndWVzdCcKCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoJy9wcm9jL3Z6Jyk6CiAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICd2aXJ0dW96em8nCiAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdndWVzdCcKCiAgICAgICAgIyBEZXRlY3QgZG9tYWluaW5nIG9uIFNwYXJjIGhhcmR3YXJlCiAgICAgICAgdmlydGluZm8gPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoJ3ZpcnRpbmZvJykKICAgICAgICBpZiB2aXJ0aW5mbzoKICAgICAgICAgICAgIyBUaGUgb3V0cHV0IG9mIHZpcnRpbmZvIGlzIGRpZmZlcmVudCB3aGV0aGVyIHdlIGFyZSBvbiBhIG1hY2hpbmUgd2l0aCBsb2dpY2FsCiAgICAgICAgICAgICMgZG9tYWlucyAoJ0xEb21zJykgb24gYSBULXNlcmllcyBvciBkb21haW5zICgnRG9tYWlucycpIG9uIGEgTS1zZXJpZXMuIFRyeSBMRG9tcyBmaXJzdC4KICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3Ivc2Jpbi92aXJ0aW5mbyAtcCIpCiAgICAgICAgICAgICMgVGhlIG91dHB1dCBjb250YWlucyBtdWx0aXBsZSBsaW5lcyB3aXRoIGRpZmZlcmVudCBrZXlzIGxpa2UgdGhpczoKICAgICAgICAgICAgIyAgIERPTUFJTlJPTEV8aW1wbD1MRG9tc3xjb250cm9sPWZhbHNlfGlvPWZhbHNlfHNlcnZpY2U9ZmFsc2V8cm9vdD1mYWxzZQogICAgICAgICAgICAjIFRoZSBvdXRwdXQgbWF5IGFsc28gYmUgbm90IGZvcm1hdHRlZCBhbmQgdGhlIHJldHVybmNvZGUgaXMgc2V0IHRvIDAgcmVnYXJkbGVzcyBvZiB0aGUgZXJyb3IgY29uZGl0aW9uOgogICAgICAgICAgICAjICAgdmlydGluZm8gY2FuIG9ubHkgYmUgcnVuIGZyb20gdGhlIGdsb2JhbCB6b25lCiAgICAgICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gb3V0LnNwbGl0bGluZXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzID0gbGluZS5zcGxpdCgnfCcpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGZpZWxkc1swXSA9PSAnRE9NQUlOUk9MRScgYW5kIGZpZWxkc1sxXSA9PSAnaW1wbD1MRG9tcyc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAnbGRvbScKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdndWVzdCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RmZWF0dXJlcyA9IFtdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgZmllbGQgaW4gZmllbGRzWzI6XToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmcgPSBmaWVsZC5zcGxpdCgnPScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgYXJnWzFdID09ICd0cnVlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9zdGZlYXR1cmVzLmFwcGVuZChhcmdbMF0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4oaG9zdGZlYXR1cmVzKSA+IDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2hvc3QgKCcgKyAnLCcuam9pbihob3N0ZmVhdHVyZXMpICsgJyknCiAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNtYmlvcyA9IHNlbGYubW9kdWxlLmdldF9iaW5fcGF0aCgnc21iaW9zJykKICAgICAgICAgICAgaWYgbm90IHNtYmlvczoKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZChzbWJpb3MpCiAgICAgICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBvdXQuc3BsaXRsaW5lcygpOgogICAgICAgICAgICAgICAgICAgIGlmICdWTXdhcmUnIGluIGxpbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICd2bXdhcmUnCiAgICAgICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdndWVzdCcKICAgICAgICAgICAgICAgICAgICBlbGlmICdQYXJhbGxlbHMnIGluIGxpbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICdwYXJhbGxlbHMnCiAgICAgICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdndWVzdCcKICAgICAgICAgICAgICAgICAgICBlbGlmICdWaXJ0dWFsQm94JyBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAndmlydHVhbGJveCcKICAgICAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2d1ZXN0JwogICAgICAgICAgICAgICAgICAgIGVsaWYgJ0hWTSBkb21VJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAneGVuJwogICAgICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgICAgICAgICAgZWxpZiAnS1ZNJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAna3ZtJwogICAgICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCgogICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgoKY2xhc3MgU3VuT1NWaXJ0dWFsQ29sbGVjdG9yKFZpcnR1YWxDb2xsZWN0b3IpOgogICAgX2ZhY3RfY2xhc3MgPSBTdW5PU1ZpcnR1YWwKICAgIF9wbGF0Zm9ybSA9ICdTdW5PUycKUEsDBBQAAAAAAMu7K0vlE0OzxwsAAMcLAAAqAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvbmV0d29yay9ocHV4LnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5iYXNlIGltcG9ydCBOZXR3b3JrLCBOZXR3b3JrQ29sbGVjdG9yCgoKY2xhc3MgSFBVWE5ldHdvcmsoTmV0d29yayk6CiAgICAiIiIKICAgIEhQLVVYLXNwZWNpZmlnIHN1YmNsYXNzIG9mIE5ldHdvcmsuIERlZmluZXMgbmV0d29ya2luZyBmYWN0czoKICAgIC0gZGVmYXVsdF9pbnRlcmZhY2UKICAgIC0gaW50ZXJmYWNlcyAoYSBsaXN0IG9mIGludGVyZmFjZSBuYW1lcykKICAgIC0gaW50ZXJmYWNlXzxuYW1lPiBkaWN0aW9uYXJ5IG9mIGlwdjQgYWRkcmVzcyBpbmZvcm1hdGlvbi4KICAgICIiIgogICAgcGxhdGZvcm0gPSAnSFAtVVgnCgogICAgZGVmIHBvcHVsYXRlKHNlbGYsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBuZXR3b3JrX2ZhY3RzID0ge30KICAgICAgICBuZXRzdGF0X3BhdGggPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoJ25ldHN0YXQnKQoKICAgICAgICBpZiBuZXRzdGF0X3BhdGggaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIG5ldHdvcmtfZmFjdHMKCiAgICAgICAgZGVmYXVsdF9pbnRlcmZhY2VzX2ZhY3RzID0gc2VsZi5nZXRfZGVmYXVsdF9pbnRlcmZhY2VzKCkKICAgICAgICBuZXR3b3JrX2ZhY3RzLnVwZGF0ZShkZWZhdWx0X2ludGVyZmFjZXNfZmFjdHMpCgogICAgICAgIGludGVyZmFjZXMgPSBzZWxmLmdldF9pbnRlcmZhY2VzX2luZm8oKQogICAgICAgIG5ldHdvcmtfZmFjdHNbJ2ludGVyZmFjZXMnXSA9IGludGVyZmFjZXMua2V5cygpCiAgICAgICAgZm9yIGlmYWNlIGluIGludGVyZmFjZXM6CiAgICAgICAgICAgIG5ldHdvcmtfZmFjdHNbaWZhY2VdID0gaW50ZXJmYWNlc1tpZmFjZV0KCiAgICAgICAgcmV0dXJuIG5ldHdvcmtfZmFjdHMKCiAgICBkZWYgZ2V0X2RlZmF1bHRfaW50ZXJmYWNlcyhzZWxmKToKICAgICAgICBkZWZhdWx0X2ludGVyZmFjZXMgPSB7fQogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvdXNyL2Jpbi9uZXRzdGF0IC1uciIpCiAgICAgICAgbGluZXMgPSBvdXQuc3BsaXRsaW5lcygpCiAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgIHdvcmRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbih3b3JkcykgPiAxOgogICAgICAgICAgICAgICAgaWYgd29yZHNbMF0gPT0gJ2RlZmF1bHQnOgogICAgICAgICAgICAgICAgICAgIGRlZmF1bHRfaW50ZXJmYWNlc1snZGVmYXVsdF9pbnRlcmZhY2UnXSA9IHdvcmRzWzRdCiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdF9pbnRlcmZhY2VzWydkZWZhdWx0X2dhdGV3YXknXSA9IHdvcmRzWzFdCgogICAgICAgIHJldHVybiBkZWZhdWx0X2ludGVyZmFjZXMKCiAgICBkZWYgZ2V0X2ludGVyZmFjZXNfaW5mbyhzZWxmKToKICAgICAgICBpbnRlcmZhY2VzID0ge30KICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiL3Vzci9iaW4vbmV0c3RhdCAtbmkiKQogICAgICAgIGxpbmVzID0gb3V0LnNwbGl0bGluZXMoKQogICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICB3b3JkcyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICBmb3IgaSBpbiByYW5nZShsZW4od29yZHMpIC0gMSk6CiAgICAgICAgICAgICAgICBpZiB3b3Jkc1tpXVs6M10gPT0gJ2xhbic6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlID0gd29yZHNbaV0KICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV0gPSB7J2RldmljZSc6IGRldmljZX0KICAgICAgICAgICAgICAgICAgICBhZGRyZXNzID0gd29yZHNbaSArIDNdCiAgICAgICAgICAgICAgICAgICAgaW50ZXJmYWNlc1tkZXZpY2VdWydpcHY0J10gPSB7J2FkZHJlc3MnOiBhZGRyZXNzfQogICAgICAgICAgICAgICAgICAgIG5ldHdvcmsgPSB3b3Jkc1tpICsgMl0KICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV1bJ2lwdjQnXSA9IHsnbmV0d29yayc6IG5ldHdvcmssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ludGVyZmFjZSc6IGRldmljZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYWRkcmVzcyc6IGFkZHJlc3N9CiAgICAgICAgcmV0dXJuIGludGVyZmFjZXMKCgpjbGFzcyBIUFVYTmV0d29ya0NvbGxlY3RvcihOZXR3b3JrQ29sbGVjdG9yKToKICAgIF9mYWN0X2NsYXNzID0gSFBVWE5ldHdvcmsKICAgIF9wbGF0Zm9ybSA9ICdIUC1VWCcKUEsDBBQAAAAAAMu7K0svDx1LlGEAAJRhAAAxAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvc3lzdGVtL2Rpc3RyaWJ1dGlvbi5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgppbXBvcnQgb3MKaW1wb3J0IHBsYXRmb3JtCmltcG9ydCByZQoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy51dGlscyBpbXBvcnQgZ2V0X2ZpbGVfY29udGVudAoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5jb2xsZWN0b3IgaW1wb3J0IEJhc2VGYWN0Q29sbGVjdG9yCgoKZGVmIGdldF91bmFtZV92ZXJzaW9uKG1vZHVsZSk6CiAgICByYywgb3V0LCBlcnIgPSBtb2R1bGUucnVuX2NvbW1hbmQoWyd1bmFtZScsICctdiddKQogICAgaWYgcmMgPT0gMDoKICAgICAgICByZXR1cm4gb3V0CiAgICByZXR1cm4gTm9uZQoKCmRlZiBfZmlsZV9leGlzdHMocGF0aCwgYWxsb3dfZW1wdHk9RmFsc2UpOgogICAgIyBub3QgZmluZGluZyB0aGUgZmlsZSwgZXhpdCBlYXJseQogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKHBhdGgpOgogICAgICAgIHJldHVybiBGYWxzZQoKICAgICMgaWYganVzdCB0aGUgcGF0aCBuZWVkcyB0byBleGlzdHMgKGllLCBpdCBjYW4gYmUgZW1wdHkpIHdlIGFyZSBkb25lCiAgICBpZiBhbGxvd19lbXB0eToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICMgZmlsZSBleGlzdHMgYnV0IGlzIGVtcHR5IGFuZCB3ZSBkb250IGFsbG93X2VtcHR5CiAgICBpZiBvcy5wYXRoLmdldHNpemUocGF0aCkgPT0gMDoKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAjIGZpbGUgZXhpc3RzIHdpdGggc29tZSBjb250ZW50CiAgICByZXR1cm4gVHJ1ZQoKCmNsYXNzIERpc3RyaWJ1dGlvbkZpbGVzOgogICAgJycnaGFzLWEgdmFyaW91cyBkaXN0cm8gZmlsZSBwYXJzZXJzIChvcy1yZWxlYXNlLCBldGMpIGFuZCBsb2dpYyBmb3IgZmluZGluZyB0aGUgcmlnaHQgb25lLicnJwogICAgIyBldmVyeSBkaXN0cmlidXRpb24gbmFtZSBtZW50aW9uZWQgaGVyZSwgbXVzdCBoYXZlIG9uZSBvZgogICAgIyAgLSBhbGxvd2VtcHR5ID09IFRydWUKICAgICMgIC0gYmUgbGlzdGVkIGluIFNFQVJDSF9TVFJJTkcKICAgICMgIC0gaGF2ZSBhIGZ1bmN0aW9uIGdldF9kaXN0cmlidXRpb25fRElTVE5BTUUgaW1wbGVtZW50ZWQKICAgIE9TRElTVF9MSVNUID0gKAogICAgICAgIHsncGF0aCc6ICcvZXRjL29yYWNsZS1yZWxlYXNlJywgJ25hbWUnOiAnT3JhY2xlTGludXgnfSwKICAgICAgICB7J3BhdGgnOiAnL2V0Yy9zbGFja3dhcmUtdmVyc2lvbicsICduYW1lJzogJ1NsYWNrd2FyZSd9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL3JlZGhhdC1yZWxlYXNlJywgJ25hbWUnOiAnUmVkSGF0J30sCiAgICAgICAgeydwYXRoJzogJy9ldGMvdm13YXJlLXJlbGVhc2UnLCAnbmFtZSc6ICdWTXdhcmVFU1gnLCAnYWxsb3dlbXB0eSc6IFRydWV9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL29wZW53cnRfcmVsZWFzZScsICduYW1lJzogJ09wZW5XcnQnfSwKICAgICAgICB7J3BhdGgnOiAnL2V0Yy9zeXN0ZW0tcmVsZWFzZScsICduYW1lJzogJ0FtYXpvbid9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL2FscGluZS1yZWxlYXNlJywgJ25hbWUnOiAnQWxwaW5lJ30sCiAgICAgICAgeydwYXRoJzogJy9ldGMvYXJjaC1yZWxlYXNlJywgJ25hbWUnOiAnQXJjaGxpbnV4JywgJ2FsbG93ZW1wdHknOiBUcnVlfSwKICAgICAgICB7J3BhdGgnOiAnL2V0Yy9vcy1yZWxlYXNlJywgJ25hbWUnOiAnU3VTRSd9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL1N1U0UtcmVsZWFzZScsICduYW1lJzogJ1N1U0UnfSwKICAgICAgICB7J3BhdGgnOiAnL2V0Yy9nZW50b28tcmVsZWFzZScsICduYW1lJzogJ0dlbnRvbyd9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL29zLXJlbGVhc2UnLCAnbmFtZSc6ICdEZWJpYW4nfSwKICAgICAgICB7J3BhdGgnOiAnL2V0Yy9sc2ItcmVsZWFzZScsICduYW1lJzogJ01hbmRyaXZhJ30sCiAgICAgICAgeydwYXRoJzogJy9ldGMvYWx0bGludXgtcmVsZWFzZScsICduYW1lJzogJ0FsdGxpbnV4J30sCiAgICAgICAgeydwYXRoJzogJy9ldGMvc291cmNlbWFnZS1yZWxlYXNlJywgJ25hbWUnOiAnU01HTCd9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL29zLXJlbGVhc2UnLCAnbmFtZSc6ICdOQSd9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL2NvcmVvcy91cGRhdGUuY29uZicsICduYW1lJzogJ0NvcmVvcyd9LAogICAgICAgIHsncGF0aCc6ICcvdXNyL2xpYi9vcy1yZWxlYXNlJywgJ25hbWUnOiAnQ2xlYXJMaW51eCd9LAogICAgKQoKICAgIFNFQVJDSF9TVFJJTkcgPSB7CiAgICAgICAgJ09yYWNsZUxpbnV4JzogJ09yYWNsZSBMaW51eCcsCiAgICAgICAgJ1JlZEhhdCc6ICdSZWQgSGF0JywKICAgICAgICAnQWx0bGludXgnOiAnQUxUIExpbnV4JywKICAgICAgICAnQ2xlYXJMaW51eCc6ICdDbGVhciBMaW51eCBTb2Z0d2FyZSBmb3IgSW50ZWwgQXJjaGl0ZWN0dXJlJywKICAgICAgICAnU01HTCc6ICdTb3VyY2UgTWFnZSBHTlUvTGludXgnLAogICAgfQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBtb2R1bGUpOgogICAgICAgIHNlbGYubW9kdWxlID0gbW9kdWxlCgogICAgZGVmIF9nZXRfZmlsZV9jb250ZW50KHNlbGYsIHBhdGgpOgogICAgICAgIHJldHVybiBnZXRfZmlsZV9jb250ZW50KHBhdGgpCgogICAgZGVmIF9nZXRfZGlzdF9maWxlX2NvbnRlbnQoc2VsZiwgcGF0aCwgYWxsb3dfZW1wdHk9RmFsc2UpOgogICAgICAgICMgY2FudCBmaW5kIHRoYXQgZGlzdCBmaWxlIG9yIGl0IGlzIGluY29ycmVjdGx5IGVtcHR5CiAgICAgICAgaWYgbm90IF9maWxlX2V4aXN0cyhwYXRoLCBhbGxvd19lbXB0eT1hbGxvd19lbXB0eSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZSwgTm9uZQoKICAgICAgICBkYXRhID0gc2VsZi5fZ2V0X2ZpbGVfY29udGVudChwYXRoKQogICAgICAgIHJldHVybiBUcnVlLCBkYXRhCgogICAgZGVmIF9wYXJzZV9kaXN0X2ZpbGUoc2VsZiwgbmFtZSwgZGlzdF9maWxlX2NvbnRlbnQsIHBhdGgsIGNvbGxlY3RlZF9mYWN0cyk6CiAgICAgICAgZGlzdF9maWxlX2RpY3QgPSB7fQogICAgICAgIGlmIG5hbWUgaW4gc2VsZi5TRUFSQ0hfU1RSSU5HOgogICAgICAgICAgICAjIGxvb2sgZm9yIHRoZSBkaXN0cmlidXRpb24gc3RyaW5nIGluIHRoZSBkYXRhIGFuZCByZXBsYWNlIGFjY29yZGluZyB0byBSRUxFQVNFX05BTUVfTUFQCiAgICAgICAgICAgICMgb25seSB0aGUgZGlzdHJpYnV0aW9uIG5hbWUgaXMgc2V0LCB0aGUgdmVyc2lvbiBpcyBhc3N1bWVkIHRvIGJlIGNvcnJlY3QgZnJvbSBwbGF0Zm9ybS5kaXN0KCkKICAgICAgICAgICAgaWYgc2VsZi5TRUFSQ0hfU1RSSU5HW25hbWVdIGluIGRpc3RfZmlsZV9jb250ZW50OgogICAgICAgICAgICAgICAgIyB0aGlzIHNldHMgZGlzdHJpYnV0aW9uPVJlZEhhdCBpZiAnUmVkIEhhdCcgc2hvd3MgdXAgaW4gZGF0YQogICAgICAgICAgICAgICAgIyBzZWxmLmZhY3RzWydkaXN0cmlidXRpb24nXSA9IG5hbWUKICAgICAgICAgICAgICAgIGRpc3RfZmlsZV9kaWN0WydkaXN0cmlidXRpb24nXSA9IG5hbWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgdGhpcyBzZXRzIGRpc3RyaWJ1dGlvbiB0byB3aGF0J3MgaW4gdGhlIGRhdGEsIGUuZy4gQ2VudE9TLCBTY2llbnRpZmljLCAuLi4KICAgICAgICAgICAgICAgICMgc2VsZi5mYWN0c1snZGlzdHJpYnV0aW9uJ10gPSBkaXN0X2ZpbGVfY29udGVudC5zcGxpdCgpWzBdCiAgICAgICAgICAgICAgICBkaXN0X2ZpbGVfZGljdFsnZGlzdHJpYnV0aW9uJ10gPSBkaXN0X2ZpbGVfY29udGVudC5zcGxpdCgpWzBdCgogICAgICAgICAgICByZXR1cm4gVHJ1ZSwgZGlzdF9maWxlX2RpY3QKCiAgICAgICAgIyBjYWxsIGEgZGVkaWNhdGVkIGZ1bmN0aW9uIGZvciBwYXJzaW5nIHRoZSBmaWxlIGNvbnRlbnQKICAgICAgICAjIFRPRE86IHJlcGxhY2Ugd2l0aCBhIG1hcCBvciBhIGNsYXNzCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEZJWE1FOiBtb3N0IG9mIHRoZXNlIGRvbnQgYWN0dWFsbHkgbG9vayBhdCB0aGUgZGlzdCBmaWxlIGNvbnRlbnRzLCBidXQgcmFuZG9tIG90aGVyIHN0dWZmCiAgICAgICAgICAgIGRpc3RmdW5jX25hbWUgPSAncGFyc2VfZGlzdHJpYnV0aW9uX2ZpbGVfJyArIG5hbWUKICAgICAgICAgICAgIyBwcmludCgnZGlzdGZ1bmNfbmFtZTogJXMnICUgZGlzdGZ1bmNfbmFtZSkKCiAgICAgICAgICAgIGRpc3RmdW5jID0gZ2V0YXR0cihzZWxmLCBkaXN0ZnVuY19uYW1lKQogICAgICAgICAgICAjIHByaW50KCdkaXN0ZnVuYzogJXMnICUgZGlzdGZ1bmMpCgogICAgICAgICAgICBwYXJzZWQsIGRpc3RfZmlsZV9kaWN0ID0gZGlzdGZ1bmMobmFtZSwgZGlzdF9maWxlX2NvbnRlbnQsIHBhdGgsIGNvbGxlY3RlZF9mYWN0cykKICAgICAgICAgICAgcmV0dXJuIHBhcnNlZCwgZGlzdF9maWxlX2RpY3QKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3IgYXMgZXhjOgogICAgICAgICAgICBwcmludCgnZXhjOiAlcycgJSBleGMpCiAgICAgICAgICAgICMgdGhpcyBzaG91bGQgbmV2ZXIgaGFwcGVuLCBidXQgaWYgaXQgZG9lcyBmYWlsIHF1aXRlbHkgYW5kIG5vdCB3aXRoIGEgdHJhY2ViYWNrCiAgICAgICAgICAgIHJldHVybiBGYWxzZSwgZGlzdF9maWxlX2RpY3QKCiAgICAgICAgcmV0dXJuIFRydWUsIGRpc3RfZmlsZV9kaWN0CiAgICAgICAgIyB0byBkZWJ1ZyBtdWx0aXBsZSBtYXRjaGluZyByZWxlYXNlIGZpbGVzLCBvbmUgY2FuIHVzZToKICAgICAgICAjIHNlbGYuZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9kZWJ1ZyddLmFwcGVuZCh7cGF0aCArICcgJyArIG5hbWU6CiAgICAgICAgIyAgICAgICAgIChwYXJzZWQsCiAgICAgICAgIyAgICAgICAgICBzZWxmLmZhY3RzWydkaXN0cmlidXRpb24nXSwKICAgICAgICAjICAgICAgICAgIHNlbGYuZmFjdHNbJ2Rpc3RyaWJ1dGlvbl92ZXJzaW9uJ10sCiAgICAgICAgIyAgICAgICAgICBzZWxmLmZhY3RzWydkaXN0cmlidXRpb25fcmVsZWFzZSddLAogICAgICAgICMgICAgICAgICAgKX0pCgogICAgZGVmIF9ndWVzc19kaXN0cmlidXRpb24oc2VsZik6CiAgICAgICAgIyB0cnkgdG8gZmluZCBvdXQgd2hpY2ggbGludXggZGlzdHJpYnV0aW9uIHRoaXMgaXMKICAgICAgICBkaXN0ID0gcGxhdGZvcm0uZGlzdCgpCiAgICAgICAgZGlzdHJpYnV0aW9uX2d1ZXNzID0ge30KICAgICAgICBkaXN0cmlidXRpb25fZ3Vlc3NbJ2Rpc3RyaWJ1dGlvbiddID0gZGlzdFswXS5jYXBpdGFsaXplKCkgb3IgJ05BJwogICAgICAgIGRpc3RyaWJ1dGlvbl9ndWVzc1snZGlzdHJpYnV0aW9uX3ZlcnNpb24nXSA9IGRpc3RbMV0gb3IgJ05BJwogICAgICAgIGRpc3RyaWJ1dGlvbl9ndWVzc1snZGlzdHJpYnV0aW9uX21ham9yX3ZlcnNpb24nXSA9IGRpc3RbMV0uc3BsaXQoJy4nKVswXSBvciAnTkEnCiAgICAgICAgZGlzdHJpYnV0aW9uX2d1ZXNzWydkaXN0cmlidXRpb25fcmVsZWFzZSddID0gZGlzdFsyXSBvciAnTkEnCiAgICAgICAgcmV0dXJuIGRpc3RyaWJ1dGlvbl9ndWVzcwoKICAgIGRlZiBwcm9jZXNzX2Rpc3RfZmlsZXMoc2VsZik6CiAgICAgICAgIyBUcnkgdG8gaGFuZGxlIHRoZSBleGNlcHRpb25zIG5vdyAuLi4KICAgICAgICAjIHNlbGYuZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9kZWJ1ZyddID0gW10KICAgICAgICBkaXN0X2ZpbGVfZmFjdHMgPSB7fQoKICAgICAgICBkaXN0X2d1ZXNzID0gc2VsZi5fZ3Vlc3NfZGlzdHJpYnV0aW9uKCkKICAgICAgICBkaXN0X2ZpbGVfZmFjdHMudXBkYXRlKGRpc3RfZ3Vlc3MpCgogICAgICAgIGZvciBkZGljdCBpbiBzZWxmLk9TRElTVF9MSVNUOgogICAgICAgICAgICBuYW1lID0gZGRpY3RbJ25hbWUnXQogICAgICAgICAgICBwYXRoID0gZGRpY3RbJ3BhdGgnXQogICAgICAgICAgICBhbGxvd19lbXB0eSA9IGRkaWN0LmdldCgnYWxsb3dlbXB0eScsIEZhbHNlKQoKICAgICAgICAgICAgaGFzX2Rpc3RfZmlsZSwgZGlzdF9maWxlX2NvbnRlbnQgPSBzZWxmLl9nZXRfZGlzdF9maWxlX2NvbnRlbnQocGF0aCwgYWxsb3dfZW1wdHk9YWxsb3dfZW1wdHkpCgogICAgICAgICAgICBpZiBub3QgaGFzX2Rpc3RfZmlsZToKICAgICAgICAgICAgICAgICMga2VlcCBsb29raW5nCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBmaXJzdCB2YWxpZCBvcyBkaXN0IGZpbGUgd2UgZmluZCB3ZSBjb3VudAogICAgICAgICAgICAjIEZJWE1FOiBjb3Jlb3MgYW5kIGEgZmV3IG90aGVyIGJpdHMgZXhwZWN0IHRoaXMKICAgICAgICAgICAgIyBzZWxmLmZhY3RzWydkaXN0cmlidXRpb24nXSA9IG5hbWUKICAgICAgICAgICAgZGlzdF9maWxlX2ZhY3RzWydkaXN0cmlidXRpb24nXSA9IG5hbWUKICAgICAgICAgICAgZGlzdF9maWxlX2ZhY3RzWydkaXN0cmlidXRpb25fZmlsZV92YXJpZXR5J10gPSBuYW1lCiAgICAgICAgICAgIGRpc3RfZmlsZV9mYWN0c1snZGlzdHJpYnV0aW9uX2ZpbGVfcGF0aCddID0gcGF0aAoKICAgICAgICAgICAgcGFyc2VkX2Rpc3RfZmlsZSwgcGFyc2VkX2Rpc3RfZmlsZV9mYWN0cyA9IHNlbGYuX3BhcnNlX2Rpc3RfZmlsZShuYW1lLCBkaXN0X2ZpbGVfY29udGVudCwgcGF0aCwgZGlzdF9maWxlX2ZhY3RzKQoKICAgICAgICAgICAgZGlzdF9maWxlX2ZhY3RzWydkaXN0cmlidXRpb25fZmlsZV9wYXJzZWQnXSA9IHBhcnNlZF9kaXN0X2ZpbGUKCiAgICAgICAgICAgICMgZmluYWxseSBmb3VuZCB0aGUgcmlnaHQgb3MgZGlzdCBmaWxlIGFuZCB3ZXJlIGFibGUgdG8gcGFyc2UgaXQKICAgICAgICAgICAgaWYgcGFyc2VkX2Rpc3RfZmlsZToKICAgICAgICAgICAgICAgIGRpc3RfZmlsZV9mYWN0cy51cGRhdGUocGFyc2VkX2Rpc3RfZmlsZV9mYWN0cykKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIHJldHVybiBkaXN0X2ZpbGVfZmFjdHMKIyAgICAgICAgZGlzdHJpYnV0aW9uX2ZhY3RzLnVwZGF0ZShkaXN0X2ZpbGVfZmFjdHMpCiMgICAgICAgIHJldHVybiBkaXN0cmlidXRpb25fZmFjdHMKCiAgICAjIFRPRE86IEZJWE1FOiBzcGxpdCBkaXN0cm8gZmlsZSBwYXJzaW5nIGludG8gaXRzIG93biBtb2R1bGUgb3IgY2xhc3MKICAgIGRlZiBwYXJzZV9kaXN0cmlidXRpb25fZmlsZV9TbGFja3dhcmUoc2VsZiwgbmFtZSwgZGF0YSwgcGF0aCwgY29sbGVjdGVkX2ZhY3RzKToKICAgICAgICBzbGFja3dhcmVfZmFjdHMgPSB7fQogICAgICAgIGlmICdTbGFja3dhcmUnIG5vdCBpbiBkYXRhOgogICAgICAgICAgICByZXR1cm4gRmFsc2UsIHNsYWNrd2FyZV9mYWN0cyAgIyBUT0RPOiByZW1vdmUKICAgICAgICBzbGFja3dhcmVfZmFjdHNbJ2Rpc3RyaWJ1dGlvbiddID0gbmFtZQogICAgICAgIHZlcnNpb24gPSByZS5maW5kYWxsKCdcdytbLl1cdysnLCBkYXRhKQogICAgICAgIGlmIHZlcnNpb246CiAgICAgICAgICAgIHNsYWNrd2FyZV9mYWN0c1snZGlzdHJpYnV0aW9uX3ZlcnNpb24nXSA9IHZlcnNpb25bMF0KICAgICAgICByZXR1cm4gVHJ1ZSwgc2xhY2t3YXJlX2ZhY3RzCgogICAgZGVmIHBhcnNlX2Rpc3RyaWJ1dGlvbl9maWxlX0FtYXpvbihzZWxmLCBuYW1lLCBkYXRhLCBwYXRoLCBjb2xsZWN0ZWRfZmFjdHMpOgogICAgICAgIGFtYXpvbl9mYWN0cyA9IHt9CiAgICAgICAgaWYgJ0FtYXpvbicgbm90IGluIGRhdGE6CiAgICAgICAgICAgICMgcmV0dXJuIEZhbHNlICAjIFRPRE86IHJlbW92ZSAgICMgaHVoPwogICAgICAgICAgICByZXR1cm4gRmFsc2UsIGFtYXpvbl9mYWN0cyAgIyBUT0RPOiByZW1vdmUKICAgICAgICBhbWF6b25fZmFjdHNbJ2Rpc3RyaWJ1dGlvbiddID0gJ0FtYXpvbicKICAgICAgICBhbWF6b25fZmFjdHNbJ2Rpc3RyaWJ1dGlvbl92ZXJzaW9uJ10gPSBkYXRhLnNwbGl0KClbLTFdCiAgICAgICAgcmV0dXJuIFRydWUsIGFtYXpvbl9mYWN0cwoKICAgIGRlZiBwYXJzZV9kaXN0cmlidXRpb25fZmlsZV9PcGVuV3J0KHNlbGYsIG5hbWUsIGRhdGEsIHBhdGgsIGNvbGxlY3RlZF9mYWN0cyk6CiAgICAgICAgb3BlbndydF9mYWN0cyA9IHt9CiAgICAgICAgaWYgJ09wZW5XcnQnIG5vdCBpbiBkYXRhOgogICAgICAgICAgICByZXR1cm4gRmFsc2UsIG9wZW53cnRfZmFjdHMgICMgVE9ETzogcmVtb3ZlCiAgICAgICAgb3BlbndydF9mYWN0c1snZGlzdHJpYnV0aW9uJ10gPSBuYW1lCiAgICAgICAgdmVyc2lvbiA9IHJlLnNlYXJjaCgnRElTVFJJQl9SRUxFQVNFPSIoLiopIicsIGRhdGEpCiAgICAgICAgaWYgdmVyc2lvbjoKICAgICAgICAgICAgb3BlbndydF9mYWN0c1snZGlzdHJpYnV0aW9uX3ZlcnNpb24nXSA9IHZlcnNpb24uZ3JvdXBzKClbMF0KICAgICAgICByZWxlYXNlID0gcmUuc2VhcmNoKCdESVNUUklCX0NPREVOQU1FPSIoLiopIicsIGRhdGEpCiAgICAgICAgaWYgcmVsZWFzZToKICAgICAgICAgICAgb3BlbndydF9mYWN0c1snZGlzdHJpYnV0aW9uX3JlbGVhc2UnXSA9IHJlbGVhc2UuZ3JvdXBzKClbMF0KICAgICAgICByZXR1cm4gVHJ1ZSwgb3BlbndydF9mYWN0cwoKICAgIGRlZiBwYXJzZV9kaXN0cmlidXRpb25fZmlsZV9BbHBpbmUoc2VsZiwgbmFtZSwgZGF0YSwgcGF0aCwgY29sbGVjdGVkX2ZhY3RzKToKICAgICAgICBhbHBpbmVfZmFjdHMgPSB7fQogICAgICAgIGFscGluZV9mYWN0c1snZGlzdHJpYnV0aW9uJ10gPSAnQWxwaW5lJwogICAgICAgIGFscGluZV9mYWN0c1snZGlzdHJpYnV0aW9uX3ZlcnNpb24nXSA9IGRhdGEKICAgICAgICByZXR1cm4gVHJ1ZSwgYWxwaW5lX2ZhY3RzCgogICAgZGVmIHBhcnNlX2Rpc3RyaWJ1dGlvbl9maWxlX1N1U0Uoc2VsZiwgbmFtZSwgZGF0YSwgcGF0aCwgY29sbGVjdGVkX2ZhY3RzKToKICAgICAgICBzdXNlX2ZhY3RzID0ge30KICAgICAgICBpZiAnc3VzZScgbm90IGluIGRhdGEubG93ZXIoKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlLCBzdXNlX2ZhY3RzICAjIFRPRE86IHJlbW92ZSBpZiB0ZXN0ZWQgd2l0aG91dCB0aGlzCiAgICAgICAgaWYgcGF0aCA9PSAnL2V0Yy9vcy1yZWxlYXNlJzoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZGF0YS5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSByZS5zZWFyY2goIl5OQU1FPSguKikiLCBsaW5lKQogICAgICAgICAgICAgICAgaWYgZGlzdHJpYnV0aW9uOgogICAgICAgICAgICAgICAgICAgIHN1c2VfZmFjdHNbJ2Rpc3RyaWJ1dGlvbiddID0gZGlzdHJpYnV0aW9uLmdyb3VwKDEpLnN0cmlwKCciJykKICAgICAgICAgICAgICAgICMgZXhhbXBsZSBwYXR0ZXJuIGFyZSAxMy4wNCAxMy4wIDEzCiAgICAgICAgICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IHJlLnNlYXJjaCgnXlZFUlNJT05fSUQ9Ij8oWzAtOV0rXC4/WzAtOV0qKSI/JywgbGluZSkKICAgICAgICAgICAgICAgIGlmIGRpc3RyaWJ1dGlvbl92ZXJzaW9uOgogICAgICAgICAgICAgICAgICAgIHN1c2VfZmFjdHNbJ2Rpc3RyaWJ1dGlvbl92ZXJzaW9uJ10gPSBkaXN0cmlidXRpb25fdmVyc2lvbi5ncm91cCgxKQogICAgICAgICAgICAgICAgaWYgJ29wZW4nIGluIGRhdGEubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICByZWxlYXNlID0gcmUuc2VhcmNoKCdeVkVSU0lPTl9JRD0iP1swLTldK1wuPyhbMC05XSopIj8nLCBsaW5lKQogICAgICAgICAgICAgICAgICAgIGlmIHJlbGVhc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHN1c2VfZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9yZWxlYXNlJ10gPSByZWxlYXNlLmdyb3VwcygpWzBdCiAgICAgICAgICAgICAgICBlbGlmICdlbnRlcnByaXNlJyBpbiBkYXRhLmxvd2VyKCkgYW5kICdWRVJTSU9OX0lEJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgICMgU0xFUyBkb2Vzbid0IGdvdCBmdW5ueSByZWxlYXNlIG5hbWVzCiAgICAgICAgICAgICAgICAgICAgcmVsZWFzZSA9IHJlLnNlYXJjaCgnXlZFUlNJT05fSUQ9Ij9bMC05XStcLj8oWzAtOV0qKSI/JywgbGluZSkKICAgICAgICAgICAgICAgICAgICBpZiByZWxlYXNlLmdyb3VwKDEpOgogICAgICAgICAgICAgICAgICAgICAgICByZWxlYXNlID0gcmVsZWFzZS5ncm91cCgxKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbGVhc2UgPSAiMCIgICMgbm8gbWlub3IgbnVtYmVyLCBzbyBpdCBpcyB0aGUgZmlyc3QgcmVsZWFzZQogICAgICAgICAgICAgICAgICAgIHN1c2VfZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9yZWxlYXNlJ10gPSByZWxlYXNlCiAgICAgICAgZWxpZiBwYXRoID09ICcvZXRjL1N1U0UtcmVsZWFzZSc6CiAgICAgICAgICAgIGlmICdvcGVuJyBpbiBkYXRhLmxvd2VyKCk6CiAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5zcGxpdGxpbmVzKCkKICAgICAgICAgICAgICAgIGRpc3RkYXRhID0gZ2V0X2ZpbGVfY29udGVudChwYXRoKS5zcGxpdGxpbmVzKClbMF0KICAgICAgICAgICAgICAgIHN1c2VfZmFjdHNbJ2Rpc3RyaWJ1dGlvbiddID0gZGlzdGRhdGEuc3BsaXQoKVswXQogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZGF0YToKICAgICAgICAgICAgICAgICAgICByZWxlYXNlID0gcmUuc2VhcmNoKCdDT0RFTkFNRSAqPSAqKFteXG5dKyknLCBsaW5lKQogICAgICAgICAgICAgICAgICAgIGlmIHJlbGVhc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHN1c2VfZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9yZWxlYXNlJ10gPSByZWxlYXNlLmdyb3VwcygpWzBdLnN0cmlwKCkKICAgICAgICAgICAgZWxpZiAnZW50ZXJwcmlzZScgaW4gZGF0YS5sb3dlcigpOgogICAgICAgICAgICAgICAgbGluZXMgPSBkYXRhLnNwbGl0bGluZXMoKQogICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gbGluZXNbMF0uc3BsaXQoKVswXQogICAgICAgICAgICAgICAgaWYgIlNlcnZlciIgaW4gZGF0YToKICAgICAgICAgICAgICAgICAgICBzdXNlX2ZhY3RzWydkaXN0cmlidXRpb24nXSA9ICJTTEVTIgogICAgICAgICAgICAgICAgZWxpZiAiRGVza3RvcCIgaW4gZGF0YToKICAgICAgICAgICAgICAgICAgICBzdXNlX2ZhY3RzWydkaXN0cmlidXRpb24nXSA9ICJTTEVEIgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgICAgICAgICAgcmVsZWFzZSA9IHJlLnNlYXJjaCgnUEFUQ0hMRVZFTCA9IChbMC05XSspJywgbGluZSkgICMgU0xFUyBkb2Vzbid0IGdvdCBmdW5ueSByZWxlYXNlIG5hbWVzCiAgICAgICAgICAgICAgICAgICAgaWYgcmVsZWFzZToKICAgICAgICAgICAgICAgICAgICAgICAgc3VzZV9mYWN0c1snZGlzdHJpYnV0aW9uX3JlbGVhc2UnXSA9IHJlbGVhc2UuZ3JvdXAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgc3VzZV9mYWN0c1snZGlzdHJpYnV0aW9uX3ZlcnNpb24nXSA9IGNvbGxlY3RlZF9mYWN0c1snZGlzdHJpYnV0aW9uX3ZlcnNpb24nXSArICcuJyArIHJlbGVhc2UuZ3JvdXAoMSkKCiAgICAgICAgcmV0dXJuIFRydWUsIHN1c2VfZmFjdHMKCiAgICBkZWYgcGFyc2VfZGlzdHJpYnV0aW9uX2ZpbGVfRGViaWFuKHNlbGYsIG5hbWUsIGRhdGEsIHBhdGgsIGNvbGxlY3RlZF9mYWN0cyk6CiAgICAgICAgZGViaWFuX2ZhY3RzID0ge30KICAgICAgICBpZiAnRGViaWFuJyBpbiBkYXRhIG9yICdSYXNwYmlhbicgaW4gZGF0YToKICAgICAgICAgICAgZGViaWFuX2ZhY3RzWydkaXN0cmlidXRpb24nXSA9ICdEZWJpYW4nCiAgICAgICAgICAgIHJlbGVhc2UgPSByZS5zZWFyY2goIlBSRVRUWV9OQU1FPVteKF0rIFwoPyhbXildKz8pXCkiLCBkYXRhKQogICAgICAgICAgICBpZiByZWxlYXNlOgogICAgICAgICAgICAgICAgZGViaWFuX2ZhY3RzWydkaXN0cmlidXRpb25fcmVsZWFzZSddID0gcmVsZWFzZS5ncm91cHMoKVswXQoKICAgICAgICAgICAgIyBMYXN0IHJlc29ydDogdHJ5IHRvIGZpbmQgcmVsZWFzZSBmcm9tIHR6ZGF0YSBhcyBlaXRoZXIgbHNiIGlzIG1pc3Npbmcgb3IgdGhpcyBpcyB2ZXJ5IG9sZCBkZWJpYW4KICAgICAgICAgICAgaWYgY29sbGVjdGVkX2ZhY3RzWydkaXN0cmlidXRpb25fcmVsZWFzZSddID09ICdOQScgYW5kICdEZWJpYW4nIGluIGRhdGE6CiAgICAgICAgICAgICAgICBkcGtnX2NtZCA9IHNlbGYubW9kdWxlLmdldF9iaW5fcGF0aCgnZHBrZycpCiAgICAgICAgICAgICAgICBpZiBkcGtnX2NtZDoKICAgICAgICAgICAgICAgICAgICBjbWQgPSAiJXMgLS1zdGF0dXMgdHpkYXRhfGdyZXAgUHJvdmlkZXN8Y3V0IC1mMiAtZCctJyIgJSBkcGtnX2NtZAogICAgICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKGNtZCkKICAgICAgICAgICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgICAgICAgICBkZWJpYW5fZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9yZWxlYXNlJ10gPSBvdXQuc3RyaXAoKQogICAgICAgIGVsaWYgJ1VidW50dScgaW4gZGF0YToKICAgICAgICAgICAgZGViaWFuX2ZhY3RzWydkaXN0cmlidXRpb24nXSA9ICdVYnVudHUnCiAgICAgICAgICAgICMgbm90aGluZyBlbHNlIHRvIGRvLCBVYnVudHUgZ2V0cyBjb3JyZWN0IGluZm8gZnJvbSBweXRob24gZnVuY3Rpb25zCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlLCBkZWJpYW5fZmFjdHMKCiAgICAgICAgcmV0dXJuIFRydWUsIGRlYmlhbl9mYWN0cwoKICAgIGRlZiBwYXJzZV9kaXN0cmlidXRpb25fZmlsZV9NYW5kcml2YShzZWxmLCBuYW1lLCBkYXRhLCBwYXRoLCBjb2xsZWN0ZWRfZmFjdHMpOgogICAgICAgIG1hbmRyaXZhX2ZhY3RzID0ge30KICAgICAgICBpZiAnTWFuZHJpdmEnIGluIGRhdGE6CiAgICAgICAgICAgIG1hbmRyaXZhX2ZhY3RzWydkaXN0cmlidXRpb24nXSA9ICdNYW5kcml2YScKICAgICAgICAgICAgdmVyc2lvbiA9IHJlLnNlYXJjaCgnRElTVFJJQl9SRUxFQVNFPSIoLiopIicsIGRhdGEpCiAgICAgICAgICAgIGlmIHZlcnNpb246CiAgICAgICAgICAgICAgICBtYW5kcml2YV9mYWN0c1snZGlzdHJpYnV0aW9uX3ZlcnNpb24nXSA9IHZlcnNpb24uZ3JvdXBzKClbMF0KICAgICAgICAgICAgcmVsZWFzZSA9IHJlLnNlYXJjaCgnRElTVFJJQl9DT0RFTkFNRT0iKC4qKSInLCBkYXRhKQogICAgICAgICAgICBpZiByZWxlYXNlOgogICAgICAgICAgICAgICAgbWFuZHJpdmFfZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9yZWxlYXNlJ10gPSByZWxlYXNlLmdyb3VwcygpWzBdCiAgICAgICAgICAgIG1hbmRyaXZhX2ZhY3RzWydkaXN0cmlidXRpb24nXSA9IG5hbWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UsIG1hbmRyaXZhX2ZhY3RzCgogICAgICAgIHJldHVybiBUcnVlLCBtYW5kcml2YV9mYWN0cwoKICAgIGRlZiBwYXJzZV9kaXN0cmlidXRpb25fZmlsZV9OQShzZWxmLCBuYW1lLCBkYXRhLCBwYXRoLCBjb2xsZWN0ZWRfZmFjdHMpOgogICAgICAgIG5hX2ZhY3RzID0ge30KICAgICAgICBmb3IgbGluZSBpbiBkYXRhLnNwbGl0bGluZXMoKToKICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gcmUuc2VhcmNoKCJeTkFNRT0oLiopIiwgbGluZSkKICAgICAgICAgICAgaWYgZGlzdHJpYnV0aW9uIGFuZCBjb2xsZWN0ZWRfZmFjdHNbJ2Rpc3RyaWJ1dGlvbiddID09ICdOQSc6CiAgICAgICAgICAgICAgICBuYV9mYWN0c1snZGlzdHJpYnV0aW9uJ10gPSBkaXN0cmlidXRpb24uZ3JvdXAoMSkuc3RyaXAoJyInKQogICAgICAgICAgICB2ZXJzaW9uID0gcmUuc2VhcmNoKCJeVkVSU0lPTj0oLiopIiwgbGluZSkKICAgICAgICAgICAgaWYgdmVyc2lvbiBhbmQgY29sbGVjdGVkX2ZhY3RzWydkaXN0cmlidXRpb25fdmVyc2lvbiddID09ICdOQSc6CiAgICAgICAgICAgICAgICBuYV9mYWN0c1snZGlzdHJpYnV0aW9uX3ZlcnNpb24nXSA9IHZlcnNpb24uZ3JvdXAoMSkuc3RyaXAoJyInKQogICAgICAgIHJldHVybiBUcnVlLCBuYV9mYWN0cwoKICAgIGRlZiBwYXJzZV9kaXN0cmlidXRpb25fZmlsZV9Db3Jlb3Moc2VsZiwgbmFtZSwgZGF0YSwgcGF0aCwgY29sbGVjdGVkX2ZhY3RzKToKICAgICAgICBjb3Jlb3NfZmFjdHMgPSB7fQogICAgICAgICMgRklYTUU6IHBhc3MgaW4gcm8gY29weSBvZiBmYWN0cyBmb3IgdGhpcyBraW5kIG9mIHRoaW5nCiAgICAgICAgZGlzdCA9IHBsYXRmb3JtLmRpc3QoKQogICAgICAgIGRpc3RybyA9IGRpc3RbMF0KCiAgICAgICAgaWYgZGlzdHJvLmxvd2VyKCkgPT0gJ2NvcmVvcyc6CiAgICAgICAgICAgIGlmIG5vdCBkYXRhOgogICAgICAgICAgICAgICAgIyBpbmNsdWRlIGZpeCBmcm9tICMxNTIzMCwgIzE1MjI4CiAgICAgICAgICAgICAgICAjIFRPRE86IHZlcmlmeSB0aGlzIGlzIG9rIGZvciBhYm92ZSBidWdzCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UsIGNvcmVvc19mYWN0cwogICAgICAgICAgICByZWxlYXNlID0gcmUuc2VhcmNoKCJeR1JPVVA9KC4qKSIsIGRhdGEpCiAgICAgICAgICAgIGlmIHJlbGVhc2U6CiAgICAgICAgICAgICAgICBjb3Jlb3NfZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9yZWxlYXNlJ10gPSByZWxlYXNlLmdyb3VwKDEpLnN0cmlwKCciJykKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UsIGNvcmVvc19mYWN0cyAgIyBUT0RPOiByZW1vdmUgaWYgdGVzdGVkIHdpdGhvdXQgdGhpcwoKICAgICAgICByZXR1cm4gVHJ1ZSwgY29yZW9zX2ZhY3RzCgoKY2xhc3MgRGlzdHJpYnV0aW9uKG9iamVjdCk6CiAgICAiIiIKICAgIFRoaXMgc3ViY2xhc3Mgb2YgRmFjdHMgZmlsbHMgdGhlIGRpc3RyaWJ1dGlvbiwgZGlzdHJpYnV0aW9uX3ZlcnNpb24gYW5kIGRpc3RyaWJ1dGlvbl9yZWxlYXNlIHZhcmlhYmxlcwoKICAgIFRvIGRvIHNvIGl0IGNoZWNrcyB0aGUgZXhpc3RlbmNlIGFuZCBjb250ZW50IG9mIHR5cGljYWwgZmlsZXMgaW4gL2V0YyBjb250YWluaW5nIGRpc3RyaWJ1dGlvbiBpbmZvcm1hdGlvbgoKICAgIFRoaXMgaXMgdW5pdCB0ZXN0ZWQuIFBsZWFzZSBleHRlbmQgdGhlIHRlc3RzIHRvIGNvdmVyIGFsbCBkaXN0cmlidXRpb25zIGlmIHlvdSBoYXZlIHRoZW0gYXZhaWxhYmxlLgogICAgIiIiCgogICAgIyBldmVyeSBkaXN0cmlidXRpb24gbmFtZSBtZW50aW9uZWQgaGVyZSwgbXVzdCBoYXZlIG9uZSBvZgogICAgIyAgLSBhbGxvd2VtcHR5ID09IFRydWUKICAgICMgIC0gYmUgbGlzdGVkIGluIFNFQVJDSF9TVFJJTkcKICAgICMgIC0gaGF2ZSBhIGZ1bmN0aW9uIGdldF9kaXN0cmlidXRpb25fRElTVE5BTUUgaW1wbGVtZW50ZWQKICAgIE9TRElTVF9MSVNUID0gKAogICAgICAgIHsncGF0aCc6ICcvZXRjL29yYWNsZS1yZWxlYXNlJywgJ25hbWUnOiAnT3JhY2xlTGludXgnfSwKICAgICAgICB7J3BhdGgnOiAnL2V0Yy9zbGFja3dhcmUtdmVyc2lvbicsICduYW1lJzogJ1NsYWNrd2FyZSd9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL3JlZGhhdC1yZWxlYXNlJywgJ25hbWUnOiAnUmVkSGF0J30sCiAgICAgICAgeydwYXRoJzogJy9ldGMvdm13YXJlLXJlbGVhc2UnLCAnbmFtZSc6ICdWTXdhcmVFU1gnLCAnYWxsb3dlbXB0eSc6IFRydWV9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL29wZW53cnRfcmVsZWFzZScsICduYW1lJzogJ09wZW5XcnQnfSwKICAgICAgICB7J3BhdGgnOiAnL2V0Yy9zeXN0ZW0tcmVsZWFzZScsICduYW1lJzogJ0FtYXpvbid9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL2FscGluZS1yZWxlYXNlJywgJ25hbWUnOiAnQWxwaW5lJ30sCiAgICAgICAgeydwYXRoJzogJy9ldGMvYXJjaC1yZWxlYXNlJywgJ25hbWUnOiAnQXJjaGxpbnV4JywgJ2FsbG93ZW1wdHknOiBUcnVlfSwKICAgICAgICB7J3BhdGgnOiAnL2V0Yy9vcy1yZWxlYXNlJywgJ25hbWUnOiAnU3VTRSd9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL1N1U0UtcmVsZWFzZScsICduYW1lJzogJ1N1U0UnfSwKICAgICAgICB7J3BhdGgnOiAnL2V0Yy9nZW50b28tcmVsZWFzZScsICduYW1lJzogJ0dlbnRvbyd9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL29zLXJlbGVhc2UnLCAnbmFtZSc6ICdEZWJpYW4nfSwKICAgICAgICB7J3BhdGgnOiAnL2V0Yy9sc2ItcmVsZWFzZScsICduYW1lJzogJ01hbmRyaXZhJ30sCiAgICAgICAgeydwYXRoJzogJy9ldGMvYWx0bGludXgtcmVsZWFzZScsICduYW1lJzogJ0FsdGxpbnV4J30sCiAgICAgICAgeydwYXRoJzogJy9ldGMvc291cmNlbWFnZS1yZWxlYXNlJywgJ25hbWUnOiAnU01HTCd9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL29zLXJlbGVhc2UnLCAnbmFtZSc6ICdOQSd9LAogICAgICAgIHsncGF0aCc6ICcvZXRjL2NvcmVvcy91cGRhdGUuY29uZicsICduYW1lJzogJ0NvcmVvcyd9LAogICAgICAgIHsncGF0aCc6ICcvdXNyL2xpYi9vcy1yZWxlYXNlJywgJ25hbWUnOiAnQ2xlYXJMaW51eCd9LAogICAgKQoKICAgIFNFQVJDSF9TVFJJTkcgPSB7CiAgICAgICAgJ09yYWNsZUxpbnV4JzogJ09yYWNsZSBMaW51eCcsCiAgICAgICAgJ1JlZEhhdCc6ICdSZWQgSGF0JywKICAgICAgICAnQWx0bGludXgnOiAnQUxUIExpbnV4JywKICAgICAgICAnQ2xlYXJMaW51eCc6ICdDbGVhciBMaW51eCBTb2Z0d2FyZSBmb3IgSW50ZWwgQXJjaGl0ZWN0dXJlJywKICAgICAgICAnU01HTCc6ICdTb3VyY2UgTWFnZSBHTlUvTGludXgnLAogICAgfQoKICAgIE9TX0ZBTUlMWV9NQVAgPSB7J1JlZEhhdCc6IFsnUmVkSGF0JywgJ0ZlZG9yYScsICdDZW50T1MnLCAnU2NpZW50aWZpYycsICdTTEMnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdBc2NlbmRvcycsICdDbG91ZExpbnV4JywgJ1BTQk0nLCAnT3JhY2xlTGludXgnLCAnT1ZTJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnT0VMJywgJ0FtYXpvbicsICdWaXJ0dW96em8nLCAnWGVuU2VydmVyJ10sCiAgICAgICAgICAgICAgICAgICAgICdEZWJpYW4nOiBbJ0RlYmlhbicsICdVYnVudHUnLCAnUmFzcGJpYW4nLCAnTmVvbicsICdLREUgbmVvbiddLAogICAgICAgICAgICAgICAgICAgICAnU3VzZSc6IFsnU3VTRScsICdTTEVTJywgJ1NMRUQnLCAnb3BlblNVU0UnLCAnb3BlblNVU0UgVHVtYmxld2VlZCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdTTEVTX1NBUCcsICdTVVNFX0xJTlVYJywgJ29wZW5TVVNFIExlYXAnXSwKICAgICAgICAgICAgICAgICAgICAgJ0FyY2hsaW51eCc6IFsnQXJjaGxpbnV4JywgJ01hbmphcm8nXSwKICAgICAgICAgICAgICAgICAgICAgJ01hbmRyYWtlJzogWydNYW5kcmFrZScsICdNYW5kcml2YSddLAogICAgICAgICAgICAgICAgICAgICAnU29sYXJpcyc6IFsnU29sYXJpcycsICdOZXhlbnRhJywgJ09tbmlPUycsICdPcGVuSW5kaWFuYScsICdTbWFydE9TJ10sCiAgICAgICAgICAgICAgICAgICAgICdTbGFja3dhcmUnOiBbJ1NsYWNrd2FyZSddLAogICAgICAgICAgICAgICAgICAgICAnQWx0bGludXgnOiBbJ0FsdGxpbnV4J10sCiAgICAgICAgICAgICAgICAgICAgICdTR01MJzogWydTR01MJ10sCiAgICAgICAgICAgICAgICAgICAgICdHZW50b28nOiBbJ0dlbnRvbycsICdGdW50b28nXSwKICAgICAgICAgICAgICAgICAgICAgJ0FscGluZSc6IFsnQWxwaW5lJ10sCiAgICAgICAgICAgICAgICAgICAgICdBSVgnOiBbJ0FJWCddLAogICAgICAgICAgICAgICAgICAgICAnSFAtVVgnOiBbJ0hQVVgnXSwKICAgICAgICAgICAgICAgICAgICAgJ0Rhcndpbic6IFsnTWFjT1NYJ10sCiAgICAgICAgICAgICAgICAgICAgICdGcmVlQlNEJzogWydGcmVlQlNEJ119CgogICAgT1NfRkFNSUxZID0ge30KICAgIGZvciBmYW1pbHksIG5hbWVzIGluIE9TX0ZBTUlMWV9NQVAuaXRlbXMoKToKICAgICAgICBmb3IgbmFtZSBpbiBuYW1lczoKICAgICAgICAgICAgT1NfRkFNSUxZW25hbWVdID0gZmFtaWx5CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG1vZHVsZSk6CiAgICAgICAgc2VsZi5tb2R1bGUgPSBtb2R1bGUKCiAgICBkZWYgZ2V0X2Rpc3RyaWJ1dGlvbl9mYWN0cyhzZWxmKToKICAgICAgICBkaXN0cmlidXRpb25fZmFjdHMgPSB7fQoKICAgICAgICAjIFRoZSBwbGF0Zm9ybSBtb2R1bGUgcHJvdmlkZXMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJ1bm5pbmcKICAgICAgICAjIHN5c3RlbS9kaXN0cmlidXRpb24uIFVzZSB0aGlzIGFzIGEgYmFzZWxpbmUgYW5kIGZpeCBidWdneSBzeXN0ZW1zCiAgICAgICAgIyBhZnRlcndhcmRzCiAgICAgICAgc3lzdGVtID0gcGxhdGZvcm0uc3lzdGVtKCkKICAgICAgICBkaXN0cmlidXRpb25fZmFjdHNbJ2Rpc3RyaWJ1dGlvbiddID0gc3lzdGVtCiAgICAgICAgZGlzdHJpYnV0aW9uX2ZhY3RzWydkaXN0cmlidXRpb25fcmVsZWFzZSddID0gcGxhdGZvcm0ucmVsZWFzZSgpCiAgICAgICAgZGlzdHJpYnV0aW9uX2ZhY3RzWydkaXN0cmlidXRpb25fdmVyc2lvbiddID0gcGxhdGZvcm0udmVyc2lvbigpCgogICAgICAgIHN5c3RlbXNfaW1wbGVtZW50ZWQgPSAoJ0FJWCcsICdIUC1VWCcsICdEYXJ3aW4nLCAnRnJlZUJTRCcsICdPcGVuQlNEJywgJ1N1bk9TJywgJ0RyYWdvbkZseScsICdOZXRCU0QnKQoKICAgICAgICBpZiBzeXN0ZW0gaW4gc3lzdGVtc19pbXBsZW1lbnRlZDoKICAgICAgICAgICAgY2xlYW5lZG5hbWUgPSBzeXN0ZW0ucmVwbGFjZSgnLScsICcnKQogICAgICAgICAgICBkaXN0ZnVuYyA9IGdldGF0dHIoc2VsZiwgJ2dldF9kaXN0cmlidXRpb25fJyArIGNsZWFuZWRuYW1lKQogICAgICAgICAgICBkaXN0X2Z1bmNfZmFjdHMgPSBkaXN0ZnVuYygpCiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbl9mYWN0cy51cGRhdGUoZGlzdF9mdW5jX2ZhY3RzKQogICAgICAgIGVsaWYgc3lzdGVtID09ICdMaW51eCc6CgogICAgICAgICAgICBkaXN0cmlidXRpb25fZmlsZXMgPSBEaXN0cmlidXRpb25GaWxlcyhtb2R1bGU9c2VsZi5tb2R1bGUpCgogICAgICAgICAgICAjIGxpbnV4X2Rpc3RyaWJ1dGlvbl9mYWN0cyA9IExpbnV4RGlzdHJpYnV0aW9uKG1vZHVsZSkuZ2V0X2Rpc3RyaWJ1dGlvbl9mYWN0cygpCiAgICAgICAgICAgIGRpc3RfZmlsZV9mYWN0cyA9IGRpc3RyaWJ1dGlvbl9maWxlcy5wcm9jZXNzX2Rpc3RfZmlsZXMoKQoKICAgICAgICAgICAgZGlzdHJpYnV0aW9uX2ZhY3RzLnVwZGF0ZShkaXN0X2ZpbGVfZmFjdHMpCgogICAgICAgIGRpc3RybyA9IGRpc3RyaWJ1dGlvbl9mYWN0c1snZGlzdHJpYnV0aW9uJ10KCiAgICAgICAgIyBsb29rIGZvciBhIG9zIGZhbWlseSBhbGlhcyBmb3IgdGhlICdkaXN0cmlidXRpb24nLCBpZiB0aGVyZSBpc250IG9uZSwgdXNlICdkaXN0cmlidXRpb24nCiAgICAgICAgZGlzdHJpYnV0aW9uX2ZhY3RzWydvc19mYW1pbHknXSA9IHNlbGYuT1NfRkFNSUxZLmdldChkaXN0cm8sIE5vbmUpIG9yIGRpc3RybwoKICAgICAgICByZXR1cm4gZGlzdHJpYnV0aW9uX2ZhY3RzCgogICAgZGVmIGdldF9kaXN0cmlidXRpb25fQUlYKHNlbGYpOgogICAgICAgIGFpeF9mYWN0cyA9IHt9CiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3IvYmluL29zbGV2ZWwiKQogICAgICAgIGRhdGEgPSBvdXQuc3BsaXQoJy4nKQogICAgICAgIGFpeF9mYWN0c1snZGlzdHJpYnV0aW9uX3ZlcnNpb24nXSA9IGRhdGFbMF0KICAgICAgICBhaXhfZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9yZWxlYXNlJ10gPSBkYXRhWzFdCiAgICAgICAgcmV0dXJuIGFpeF9mYWN0cwoKICAgIGRlZiBnZXRfZGlzdHJpYnV0aW9uX0hQVVgoc2VsZik6CiAgICAgICAgaHB1eF9mYWN0cyA9IHt9CiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3Ivc2Jpbi9zd2xpc3QgfGVncmVwICdIUFVYLipPRS4qW0FCXS5bMC05XStcLlswLTldKyciLCB1c2VfdW5zYWZlX3NoZWxsPVRydWUpCiAgICAgICAgZGF0YSA9IHJlLnNlYXJjaCgnSFBVWC4qT0UuKihbQUJdLlswLTldK1wuWzAtOV0rKVwuKFswLTldKykuKicsIG91dCkKICAgICAgICBpZiBkYXRhOgogICAgICAgICAgICBocHV4X2ZhY3RzWydkaXN0cmlidXRpb25fdmVyc2lvbiddID0gZGF0YS5ncm91cHMoKVswXQogICAgICAgICAgICBocHV4X2ZhY3RzWydkaXN0cmlidXRpb25fcmVsZWFzZSddID0gZGF0YS5ncm91cHMoKVsxXQogICAgICAgIHJldHVybiBocHV4X2ZhY3RzCgogICAgZGVmIGdldF9kaXN0cmlidXRpb25fRGFyd2luKHNlbGYpOgogICAgICAgIGRhcndpbl9mYWN0cyA9IHt9CiAgICAgICAgZGFyd2luX2ZhY3RzWydkaXN0cmlidXRpb24nXSA9ICdNYWNPU1gnCiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3IvYmluL3N3X3ZlcnMgLXByb2R1Y3RWZXJzaW9uIikKICAgICAgICBkYXRhID0gb3V0LnNwbGl0KClbLTFdCiAgICAgICAgZGFyd2luX2ZhY3RzWydkaXN0cmlidXRpb25fdmVyc2lvbiddID0gZGF0YQogICAgICAgIHJldHVybiBkYXJ3aW5fZmFjdHMKCiAgICBkZWYgZ2V0X2Rpc3RyaWJ1dGlvbl9GcmVlQlNEKHNlbGYpOgogICAgICAgIGZyZWVic2RfZmFjdHMgPSB7fQogICAgICAgIGZyZWVic2RfZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9yZWxlYXNlJ10gPSBwbGF0Zm9ybS5yZWxlYXNlKCkKICAgICAgICBkYXRhID0gcmUuc2VhcmNoKCcoXGQrKVwuKFxkKyktUkVMRUFTRS4qJywgZnJlZWJzZF9mYWN0c1snZGlzdHJpYnV0aW9uX3JlbGVhc2UnXSkKICAgICAgICBpZiBkYXRhOgogICAgICAgICAgICBmcmVlYnNkX2ZhY3RzWydkaXN0cmlidXRpb25fbWFqb3JfdmVyc2lvbiddID0gZGF0YS5ncm91cCgxKQogICAgICAgICAgICBmcmVlYnNkX2ZhY3RzWydkaXN0cmlidXRpb25fdmVyc2lvbiddID0gJyVzLiVzJyAlIChkYXRhLmdyb3VwKDEpLCBkYXRhLmdyb3VwKDIpKQogICAgICAgIHJldHVybiBmcmVlYnNkX2ZhY3RzCgogICAgZGVmIGdldF9kaXN0cmlidXRpb25fT3BlbkJTRChzZWxmKToKICAgICAgICBvcGVuYnNkX2ZhY3RzID0ge30KICAgICAgICBvcGVuYnNkX2ZhY3RzWydkaXN0cmlidXRpb25fdmVyc2lvbiddID0gcGxhdGZvcm0ucmVsZWFzZSgpCiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi9zYmluL3N5c2N0bCAtbiBrZXJuLnZlcnNpb24iKQogICAgICAgIG1hdGNoID0gcmUubWF0Y2goJ09wZW5CU0Rcc1swLTldKy5bMC05XSstKFxTKylccy4qJywgb3V0KQogICAgICAgIGlmIG1hdGNoOgogICAgICAgICAgICBvcGVuYnNkX2ZhY3RzWydkaXN0cmlidXRpb25fcmVsZWFzZSddID0gbWF0Y2guZ3JvdXBzKClbMF0KICAgICAgICBlbHNlOgogICAgICAgICAgICBvcGVuYnNkX2ZhY3RzWydkaXN0cmlidXRpb25fcmVsZWFzZSddID0gJ3JlbGVhc2UnCiAgICAgICAgcmV0dXJuIG9wZW5ic2RfZmFjdHMKCiAgICBkZWYgZ2V0X2Rpc3RyaWJ1dGlvbl9EcmFnb25GbHkoc2VsZik6CiAgICAgICAgcmV0dXJuIHt9CgogICAgZGVmIGdldF9kaXN0cmlidXRpb25fTmV0QlNEKHNlbGYpOgogICAgICAgIG5ldGJzZF9mYWN0cyA9IHt9CiAgICAgICAgIyBGSVhNRTogcG9raW5nIGF0IHNlbGYuZmFjdHMsIHNob3VsZCBldmVudHVhbGx5IG1ha2UgdGhlc2UgZWFjaCBhIGNvbGxlY3RvcgogICAgICAgIHBsYXRmb3JtX3JlbGVhc2UgPSBwbGF0Zm9ybS5yZWxlYXNlKCkKICAgICAgICBuZXRic2RfZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9tYWpvcl92ZXJzaW9uJ10gPSBwbGF0Zm9ybV9yZWxlYXNlLnNwbGl0KCcuJylbMF0KICAgICAgICByZXR1cm4gbmV0YnNkX2ZhY3RzCgogICAgZGVmIGdldF9kaXN0cmlidXRpb25fU01HTChzZWxmKToKICAgICAgICBzbWdsX2ZhY3RzID0ge30KICAgICAgICBzbWdsX2ZhY3RzWydkaXN0cmlidXRpb24nXSA9ICdTb3VyY2UgTWFnZSBHTlUvTGludXgnCiAgICAgICAgcmV0dXJuIHNtZ2xfZmFjdHMKCiAgICBkZWYgZ2V0X2Rpc3RyaWJ1dGlvbl9TdW5PUyhzZWxmKToKICAgICAgICBzdW5vc19mYWN0cyA9IHt9CgogICAgICAgICMgcHJpbnQoJ3BsYXRmb3JtLnJlbGVhc2U6ICVzJyAlIGRpc3RyaWJ1dGlvbl9yZWxlYXNlKQogICAgICAgIGRhdGEgPSBnZXRfZmlsZV9jb250ZW50KCcvZXRjL3JlbGVhc2UnKS5zcGxpdGxpbmVzKClbMF0KCiAgICAgICAgIyBwcmludCgnZ2V0X2ZpbGVfY29udGVudDogZGF0YT0lcycgJSBkYXRhKQoKICAgICAgICBpZiAnU29sYXJpcycgaW4gZGF0YToKICAgICAgICAgICAgb3JhX3ByZWZpeCA9ICcnCiAgICAgICAgICAgIGlmICdPcmFjbGUgU29sYXJpcycgaW4gZGF0YToKICAgICAgICAgICAgICAgIGRhdGEgPSBkYXRhLnJlcGxhY2UoJ09yYWNsZSAnLCAnJykKICAgICAgICAgICAgICAgIG9yYV9wcmVmaXggPSAnT3JhY2xlICcKICAgICAgICAgICAgc3Vub3NfZmFjdHNbJ2Rpc3RyaWJ1dGlvbiddID0gZGF0YS5zcGxpdCgpWzBdCiAgICAgICAgICAgIHN1bm9zX2ZhY3RzWydkaXN0cmlidXRpb25fdmVyc2lvbiddID0gZGF0YS5zcGxpdCgpWzFdCiAgICAgICAgICAgIHN1bm9zX2ZhY3RzWydkaXN0cmlidXRpb25fcmVsZWFzZSddID0gb3JhX3ByZWZpeCArIGRhdGEKICAgICAgICAgICAgcmV0dXJuIHN1bm9zX2ZhY3RzCgogICAgICAgIHVuYW1lX3YgPSBnZXRfdW5hbWVfdmVyc2lvbihzZWxmLm1vZHVsZSkKICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IE5vbmUKCiAgICAgICAgIyBwcmludCgndW5hbWVfdjogJXMnICUgdW5hbWVfdikKCiAgICAgICAgaWYgJ1NtYXJ0T1MnIGluIGRhdGE6CiAgICAgICAgICAgIHN1bm9zX2ZhY3RzWydkaXN0cmlidXRpb24nXSA9ICdTbWFydE9TJwogICAgICAgICAgICBpZiBfZmlsZV9leGlzdHMoJy9ldGMvcHJvZHVjdCcpOgogICAgICAgICAgICAgICAgcHJvZHVjdF9kYXRhID0gZGljdChbbC5zcGxpdCgnOiAnLCAxKSBmb3IgbCBpbiBnZXRfZmlsZV9jb250ZW50KCcvZXRjL3Byb2R1Y3QnKS5zcGxpdGxpbmVzKCkgaWYgJzogJyBpbiBsXSkKICAgICAgICAgICAgICAgIGlmICdJbWFnZScgaW4gcHJvZHVjdF9kYXRhOgogICAgICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbl92ZXJzaW9uID0gcHJvZHVjdF9kYXRhLmdldCgnSW1hZ2UnKS5zcGxpdCgpWy0xXQogICAgICAgIGVsaWYgJ09wZW5JbmRpYW5hJyBpbiBkYXRhOgogICAgICAgICAgICBzdW5vc19mYWN0c1snZGlzdHJpYnV0aW9uJ10gPSAnT3BlbkluZGlhbmEnCiAgICAgICAgZWxpZiAnT21uaU9TJyBpbiBkYXRhOgogICAgICAgICAgICBzdW5vc19mYWN0c1snZGlzdHJpYnV0aW9uJ10gPSAnT21uaU9TJwogICAgICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IGRhdGEuc3BsaXQoKVstMV0KICAgICAgICBlbGlmIHVuYW1lX3YgaXMgbm90IE5vbmUgYW5kICdOZXhlbnRhT1NfJyBpbiB1bmFtZV92OgogICAgICAgICAgICBzdW5vc19mYWN0c1snZGlzdHJpYnV0aW9uJ10gPSAnTmV4ZW50YScKICAgICAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBkYXRhLnNwbGl0KClbLTFdLmxzdHJpcCgndicpCgogICAgICAgICMgcHJpbnQoJ3N1bm9zX2ZhY3RzOiAlcycgJSBzdW5vc19mYWN0cykKICAgICAgICBpZiBzdW5vc19mYWN0cy5nZXQoJ2Rpc3RyaWJ1dGlvbicsICcnKSBpbiAoJ1NtYXJ0T1MnLCAnT3BlbkluZGlhbmEnLCAnT21uaU9TJywgJ05leGVudGEnKToKICAgICAgICAgICAgc3Vub3NfZmFjdHNbJ2Rpc3RyaWJ1dGlvbl9yZWxlYXNlJ10gPSBkYXRhLnN0cmlwKCkKICAgICAgICAgICAgaWYgZGlzdHJpYnV0aW9uX3ZlcnNpb24gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBzdW5vc19mYWN0c1snZGlzdHJpYnV0aW9uX3ZlcnNpb24nXSA9IGRpc3RyaWJ1dGlvbl92ZXJzaW9uCiAgICAgICAgICAgIGVsaWYgdW5hbWVfdiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHN1bm9zX2ZhY3RzWydkaXN0cmlidXRpb25fdmVyc2lvbiddID0gdW5hbWVfdi5zcGxpdGxpbmVzKClbMF0uc3RyaXAoKQogICAgICAgICAgICByZXR1cm4gc3Vub3NfZmFjdHMKCiAgICAgICAgcmV0dXJuIHN1bm9zX2ZhY3RzCgoKY2xhc3MgRGlzdHJpYnV0aW9uRmFjdENvbGxlY3RvcihCYXNlRmFjdENvbGxlY3Rvcik6CiAgICBuYW1lID0gJ2Rpc3RyaWJ1dGlvbicKICAgIF9mYWN0X2lkcyA9IHNldChbJ2Rpc3RyaWJ1dGlvbl92ZXJzaW9uJywKICAgICAgICAgICAgICAgICAgICAgJ2Rpc3RyaWJ1dGlvbl9yZWxlYXNlJywKICAgICAgICAgICAgICAgICAgICAgJ2Rpc3RyaWJ1dGlvbl9tYWpvcl92ZXJzaW9uJ10pCgogICAgZGVmIGNvbGxlY3Qoc2VsZiwgbW9kdWxlPU5vbmUsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBjb2xsZWN0ZWRfZmFjdHMgPSBjb2xsZWN0ZWRfZmFjdHMgb3Ige30KICAgICAgICBmYWN0c19kaWN0ID0ge30KICAgICAgICBpZiBub3QgbW9kdWxlOgogICAgICAgICAgICByZXR1cm4gZmFjdHNfZGljdAoKICAgICAgICBkaXN0cmlidXRpb24gPSBEaXN0cmlidXRpb24obW9kdWxlPW1vZHVsZSkKICAgICAgICBkaXN0cm9fZmFjdHMgPSBkaXN0cmlidXRpb24uZ2V0X2Rpc3RyaWJ1dGlvbl9mYWN0cygpCgogICAgICAgIHJldHVybiBkaXN0cm9fZmFjdHMKUEsDBBQAAAAAAMu7K0sMID9x9QUAAPUFAAAtAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvdmlydHVhbC9mcmVlYnNkLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCBvcwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy52aXJ0dWFsLmJhc2UgaW1wb3J0IFZpcnR1YWwsIFZpcnR1YWxDb2xsZWN0b3IKCgpjbGFzcyBGcmVlQlNEVmlydHVhbChWaXJ0dWFsKToKICAgICIiIgogICAgVGhpcyBpcyBhIEZyZWVCU0Qtc3BlY2lmaWMgc3ViY2xhc3Mgb2YgVmlydHVhbC4gIEl0IGRlZmluZXMKICAgIC0gdmlydHVhbGl6YXRpb25fdHlwZQogICAgLSB2aXJ0dWFsaXphdGlvbl9yb2xlCiAgICAiIiIKICAgIHBsYXRmb3JtID0gJ0ZyZWVCU0QnCgogICAgZGVmIGdldF92aXJ0dWFsX2ZhY3RzKHNlbGYpOgogICAgICAgIHZpcnR1YWxfZmFjdHMgPSB7fQogICAgICAgICMgU2V0IGVtcHR5IHZhbHVlcyBhcyBkZWZhdWx0CiAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJycKICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnJwoKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cygnL2Rldi94ZW4veGVuc3RvcmUnKToKICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ3hlbicKICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2d1ZXN0JwoKICAgICAgICByZXR1cm4gdmlydHVhbF9mYWN0cwoKCmNsYXNzIEZyZWVCU0RWaXJ0dWFsQ29sbGVjdG9yKFZpcnR1YWxDb2xsZWN0b3IpOgogICAgX2ZhY3RfY2xhc3MgPSBGcmVlQlNEVmlydHVhbAogICAgX3BsYXRmb3JtID0gJ0ZyZWVCU0QnClBLAwQUAAAAAADLuytLAAAAAAAAAAAAAAAALQAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9fX2luaXRfXy5weVBLAwQUAAAAAADLuytL3aA+90AGAABABgAALQAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL25ldHdvcmsvb3BlbmJzZC5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLm5ldHdvcmsuYmFzZSBpbXBvcnQgTmV0d29ya0NvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLm5ldHdvcmsuZ2VuZXJpY19ic2QgaW1wb3J0IEdlbmVyaWNCc2RJZmNvbmZpZ05ldHdvcmsKCgpjbGFzcyBPcGVuQlNETmV0d29yayhHZW5lcmljQnNkSWZjb25maWdOZXR3b3JrKToKICAgICIiIgogICAgVGhpcyBpcyB0aGUgT3BlbkJTRCBOZXR3b3JrIENsYXNzLgogICAgSXQgdXNlcyB0aGUgR2VuZXJpY0JzZElmY29uZmlnTmV0d29yay4KICAgICIiIgogICAgcGxhdGZvcm0gPSAnT3BlbkJTRCcKCiAgICAjIE9wZW5CU0QgJ2lmY29uZmlnIC1hJyBkb2VzIG5vdCBoYXZlIGluZm9ybWF0aW9uIGFib3V0IGFsaWFzZXMKICAgIGRlZiBnZXRfaW50ZXJmYWNlc19pbmZvKHNlbGYsIGlmY29uZmlnX3BhdGgsIGlmY29uZmlnX29wdGlvbnM9Jy1hQScpOgogICAgICAgIHJldHVybiBzdXBlcihPcGVuQlNETmV0d29yaywgc2VsZikuZ2V0X2ludGVyZmFjZXNfaW5mbyhpZmNvbmZpZ19wYXRoLCBpZmNvbmZpZ19vcHRpb25zKQoKICAgICMgUmV0dXJuIG1hY2FkZHJlc3MgaW5zdGVhZCBvZiBsbGFkZHIKICAgIGRlZiBwYXJzZV9sbGFkZHJfbGluZShzZWxmLCB3b3JkcywgY3VycmVudF9pZiwgaXBzKToKICAgICAgICBjdXJyZW50X2lmWydtYWNhZGRyZXNzJ10gPSB3b3Jkc1sxXQogICAgICAgIGN1cnJlbnRfaWZbJ3R5cGUnXSA9ICdldGhlcicKCgpjbGFzcyBPcGVuQlNETmV0d29ya0NvbGxlY3RvcihOZXR3b3JrQ29sbGVjdG9yKToKICAgIF9mYWN0X2NsYXNzID0gT3BlbkJTRE5ldHdvcmsKICAgIF9wbGF0Zm9ybSA9ICdPcGVuQlNEJwpQSwMEFAAAAAAAy7srS2sPr5PaBwAA2gcAACwAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9uZXR3b3JrL2Rhcndpbi5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLm5ldHdvcmsuYmFzZSBpbXBvcnQgTmV0d29ya0NvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLm5ldHdvcmsuZ2VuZXJpY19ic2QgaW1wb3J0IEdlbmVyaWNCc2RJZmNvbmZpZ05ldHdvcmsKCgpjbGFzcyBEYXJ3aW5OZXR3b3JrKEdlbmVyaWNCc2RJZmNvbmZpZ05ldHdvcmspOgogICAgIiIiCiAgICBUaGlzIGlzIHRoZSBNYWMgT1MgWC9EYXJ3aW4gTmV0d29yayBDbGFzcy4KICAgIEl0IHVzZXMgdGhlIEdlbmVyaWNCc2RJZmNvbmZpZ05ldHdvcmsgdW5jaGFuZ2VkCiAgICAiIiIKICAgIHBsYXRmb3JtID0gJ0RhcndpbicKCiAgICAjIG1lZGlhIGxpbmUgaXMgZGlmZmVyZW50IHRvIHRoZSBkZWZhdWx0IEZyZWVCU0Qgb25lCiAgICBkZWYgcGFyc2VfbWVkaWFfbGluZShzZWxmLCB3b3JkcywgY3VycmVudF9pZiwgaXBzKToKICAgICAgICAjIG5vdCBzdXJlIGlmIHRoaXMgaXMgdXNlZnVsIC0gd2UgYWxzbyBkcm9wIGluZm9ybWF0aW9uCiAgICAgICAgY3VycmVudF9pZlsnbWVkaWEnXSA9ICdVbmtub3duJyAgIyBNYWMgZG9lcyBub3QgZ2l2ZSB1cyB0aGlzCiAgICAgICAgY3VycmVudF9pZlsnbWVkaWFfc2VsZWN0J10gPSB3b3Jkc1sxXQogICAgICAgIGlmIGxlbih3b3JkcykgPiAyOgogICAgICAgICAgICAjIE1hY09TWCBzZXRzIHRoZSBtZWRpYSB0byAnPHVua25vd24gdHlwZT4nIGZvciBicmlkZ2UgaW50ZXJmYWNlCiAgICAgICAgICAgICMgYW5kIHBhcnNpbmcgc3BsaXRzIHRoaXMgaW50byB0d28gd29yZHM7IHRoaXMgaWYvZWxzZSBoZWxwcwogICAgICAgICAgICBpZiB3b3Jkc1sxXSA9PSAnPHVua25vd24nIGFuZCB3b3Jkc1syXSA9PSAndHlwZT4nOgogICAgICAgICAgICAgICAgY3VycmVudF9pZlsnbWVkaWFfc2VsZWN0J10gPSAnVW5rbm93bicKICAgICAgICAgICAgICAgIGN1cnJlbnRfaWZbJ21lZGlhX3R5cGUnXSA9ICd1bmtub3duIHR5cGUnCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjdXJyZW50X2lmWydtZWRpYV90eXBlJ10gPSB3b3Jkc1syXVsxOi0xXQogICAgICAgIGlmIGxlbih3b3JkcykgPiAzOgogICAgICAgICAgICBjdXJyZW50X2lmWydtZWRpYV9vcHRpb25zJ10gPSBzZWxmLmdldF9vcHRpb25zKHdvcmRzWzNdKQoKCmNsYXNzIERhcndpbk5ldHdvcmtDb2xsZWN0b3IoTmV0d29ya0NvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IERhcndpbk5ldHdvcmsKICAgIF9wbGF0Zm9ybSA9ICdEYXJ3aW4nClBLAwQUAAAAAADLuytLRYeBVwE/AAABPwAAKwAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL25ldHdvcmsvbGludXgucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKaW1wb3J0IGdsb2IKaW1wb3J0IG9zCmltcG9ydCByZQppbXBvcnQgc29ja2V0CmltcG9ydCBzdHJ1Y3QKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5iYXNlIGltcG9ydCBOZXR3b3JrLCBOZXR3b3JrQ29sbGVjdG9yCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnV0aWxzIGltcG9ydCBnZXRfZmlsZV9jb250ZW50CgoKY2xhc3MgTGludXhOZXR3b3JrKE5ldHdvcmspOgogICAgIiIiCiAgICBUaGlzIGlzIGEgTGludXgtc3BlY2lmaWMgc3ViY2xhc3Mgb2YgTmV0d29yay4gIEl0IGRlZmluZXMKICAgIC0gaW50ZXJmYWNlcyAoYSBsaXN0IG9mIGludGVyZmFjZSBuYW1lcykKICAgIC0gaW50ZXJmYWNlXzxuYW1lPiBkaWN0aW9uYXJ5IG9mIGlwdjQsIGlwdjYsIGFuZCBtYWMgYWRkcmVzcyBpbmZvcm1hdGlvbi4KICAgIC0gYWxsX2lwdjRfYWRkcmVzc2VzIGFuZCBhbGxfaXB2Nl9hZGRyZXNzZXM6IGxpc3RzIG9mIGFsbCBjb25maWd1cmVkIGFkZHJlc3Nlcy4KICAgIC0gaXB2NF9hZGRyZXNzIGFuZCBpcHY2X2FkZHJlc3M6IHRoZSBmaXJzdCBub24tbG9jYWwgYWRkcmVzcyBmb3IgZWFjaCBmYW1pbHkuCiAgICAiIiIKICAgIHBsYXRmb3JtID0gJ0xpbnV4JwogICAgSU5URVJGQUNFX1RZUEUgPSB7CiAgICAgICAgJzEnOiAnZXRoZXInLAogICAgICAgICczMic6ICdpbmZpbmliYW5kJywKICAgICAgICAnNTEyJzogJ3BwcCcsCiAgICAgICAgJzc3Mic6ICdsb29wYmFjaycsCiAgICAgICAgJzY1NTM0JzogJ3R1bm5lbCcsCiAgICB9CgogICAgZGVmIHBvcHVsYXRlKHNlbGYsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBuZXR3b3JrX2ZhY3RzID0ge30KICAgICAgICBpcF9wYXRoID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCdpcCcpCiAgICAgICAgaWYgaXBfcGF0aCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gbmV0d29ya19mYWN0cwogICAgICAgIGRlZmF1bHRfaXB2NCwgZGVmYXVsdF9pcHY2ID0gc2VsZi5nZXRfZGVmYXVsdF9pbnRlcmZhY2VzKGlwX3BhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGVkX2ZhY3RzPWNvbGxlY3RlZF9mYWN0cykKICAgICAgICBpbnRlcmZhY2VzLCBpcHMgPSBzZWxmLmdldF9pbnRlcmZhY2VzX2luZm8oaXBfcGF0aCwgZGVmYXVsdF9pcHY0LCBkZWZhdWx0X2lwdjYpCiAgICAgICAgbmV0d29ya19mYWN0c1snaW50ZXJmYWNlcyddID0gaW50ZXJmYWNlcy5rZXlzKCkKICAgICAgICBmb3IgaWZhY2UgaW4gaW50ZXJmYWNlczoKICAgICAgICAgICAgbmV0d29ya19mYWN0c1tpZmFjZV0gPSBpbnRlcmZhY2VzW2lmYWNlXQogICAgICAgIG5ldHdvcmtfZmFjdHNbJ2RlZmF1bHRfaXB2NCddID0gZGVmYXVsdF9pcHY0CiAgICAgICAgbmV0d29ya19mYWN0c1snZGVmYXVsdF9pcHY2J10gPSBkZWZhdWx0X2lwdjYKICAgICAgICBuZXR3b3JrX2ZhY3RzWydhbGxfaXB2NF9hZGRyZXNzZXMnXSA9IGlwc1snYWxsX2lwdjRfYWRkcmVzc2VzJ10KICAgICAgICBuZXR3b3JrX2ZhY3RzWydhbGxfaXB2Nl9hZGRyZXNzZXMnXSA9IGlwc1snYWxsX2lwdjZfYWRkcmVzc2VzJ10KICAgICAgICByZXR1cm4gbmV0d29ya19mYWN0cwoKICAgIGRlZiBnZXRfZGVmYXVsdF9pbnRlcmZhY2VzKHNlbGYsIGlwX3BhdGgsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBjb2xsZWN0ZWRfZmFjdHMgPSBjb2xsZWN0ZWRfZmFjdHMgb3Ige30KICAgICAgICAjIFVzZSB0aGUgY29tbWFuZHM6CiAgICAgICAgIyAgICAgaXAgLTQgcm91dGUgZ2V0IDguOC44LjggICAgICAgICAgICAgICAgICAgICAtPiBHb29nbGUgcHVibGljIEROUwogICAgICAgICMgICAgIGlwIC02IHJvdXRlIGdldCAyNDA0OjY4MDA6NDAwYTo4MDA6OjEwMTIgICAgLT4gaXB2Ni5nb29nbGUuY29tCiAgICAgICAgIyB0byBmaW5kIG91dCB0aGUgZGVmYXVsdCBvdXRnb2luZyBpbnRlcmZhY2UsIGFkZHJlc3MsIGFuZCBnYXRld2F5CiAgICAgICAgY29tbWFuZCA9IGRpY3QoCiAgICAgICAgICAgIHY0PVtpcF9wYXRoLCAnLTQnLCAncm91dGUnLCAnZ2V0JywgJzguOC44LjgnXSwKICAgICAgICAgICAgdjY9W2lwX3BhdGgsICctNicsICdyb3V0ZScsICdnZXQnLCAnMjQwNDo2ODAwOjQwMGE6ODAwOjoxMDEyJ10KICAgICAgICApCiAgICAgICAgaW50ZXJmYWNlID0gZGljdCh2ND17fSwgdjY9e30pCgogICAgICAgIGZvciB2IGluICd2NCcsICd2Nic6CiAgICAgICAgICAgIGlmICh2ID09ICd2NicgYW5kIGNvbGxlY3RlZF9mYWN0cy5nZXQoJ2Fuc2libGVfb3NfZmFtaWx5JykgPT0gJ1JlZEhhdCcgYW5kCiAgICAgICAgICAgICAgICAgICAgY29sbGVjdGVkX2ZhY3RzLmdldCgnYW5zaWJsZV9kaXN0cmlidXRpb25fdmVyc2lvbicsICcnKS5zdGFydHN3aXRoKCc0LicpKToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIHYgPT0gJ3Y2JyBhbmQgbm90IHNvY2tldC5oYXNfaXB2NjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKGNvbW1hbmRbdl0sIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fcmVwbGFjZScpCiAgICAgICAgICAgIGlmIG5vdCBvdXQ6CiAgICAgICAgICAgICAgICAjIHY2IHJvdXRpbmcgbWF5IHJlc3VsdCBpbgogICAgICAgICAgICAgICAgIyAgIFJUTkVUTElOSyBhbnN3ZXJzOiBJbnZhbGlkIGFyZ3VtZW50CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB3b3JkcyA9IG91dC5zcGxpdGxpbmVzKClbMF0uc3BsaXQoKQogICAgICAgICAgICAjIEEgdmFsaWQgb3V0cHV0IHN0YXJ0cyB3aXRoIHRoZSBxdWVyaWVkIGFkZHJlc3Mgb24gdGhlIGZpcnN0IGxpbmUKICAgICAgICAgICAgaWYgbGVuKHdvcmRzKSA+IDAgYW5kIHdvcmRzWzBdID09IGNvbW1hbmRbdl1bLTFdOgogICAgICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKHdvcmRzKSAtIDEpOgogICAgICAgICAgICAgICAgICAgIGlmIHdvcmRzW2ldID09ICdkZXYnOgogICAgICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2Vbdl1bJ2ludGVyZmFjZSddID0gd29yZHNbaSArIDFdCiAgICAgICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1tpXSA9PSAnc3JjJzoKICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJmYWNlW3ZdWydhZGRyZXNzJ10gPSB3b3Jkc1tpICsgMV0KICAgICAgICAgICAgICAgICAgICBlbGlmIHdvcmRzW2ldID09ICd2aWEnIGFuZCB3b3Jkc1tpICsgMV0gIT0gY29tbWFuZFt2XVstMV06CiAgICAgICAgICAgICAgICAgICAgICAgIGludGVyZmFjZVt2XVsnZ2F0ZXdheSddID0gd29yZHNbaSArIDFdCiAgICAgICAgcmV0dXJuIGludGVyZmFjZVsndjQnXSwgaW50ZXJmYWNlWyd2NiddCgogICAgZGVmIGdldF9pbnRlcmZhY2VzX2luZm8oc2VsZiwgaXBfcGF0aCwgZGVmYXVsdF9pcHY0LCBkZWZhdWx0X2lwdjYpOgogICAgICAgIGludGVyZmFjZXMgPSB7fQogICAgICAgIGlwcyA9IGRpY3QoCiAgICAgICAgICAgIGFsbF9pcHY0X2FkZHJlc3Nlcz1bXSwKICAgICAgICAgICAgYWxsX2lwdjZfYWRkcmVzc2VzPVtdLAogICAgICAgICkKCiAgICAgICAgIyBGSVhNRTogbWF5YmUgc3BsaXQgaW50byBzbWFsbGVyIG1ldGhvZHM/CiAgICAgICAgIyBGSVhNRTogdGhpcyBpcyBwcmV0dHkgbXVjaCBhIGNvbnN0cnVjdG9yCgogICAgICAgIGZvciBwYXRoIGluIGdsb2IuZ2xvYignL3N5cy9jbGFzcy9uZXQvKicpOgogICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2RpcihwYXRoKToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGRldmljZSA9IG9zLnBhdGguYmFzZW5hbWUocGF0aCkKICAgICAgICAgICAgaW50ZXJmYWNlc1tkZXZpY2VdID0geydkZXZpY2UnOiBkZXZpY2V9CiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihwYXRoLCAnYWRkcmVzcycpKToKICAgICAgICAgICAgICAgIG1hY2FkZHJlc3MgPSBnZXRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihwYXRoLCAnYWRkcmVzcycpLCBkZWZhdWx0PScnKQogICAgICAgICAgICAgICAgaWYgbWFjYWRkcmVzcyBhbmQgbWFjYWRkcmVzcyAhPSAnMDA6MDA6MDA6MDA6MDA6MDAnOgogICAgICAgICAgICAgICAgICAgIGludGVyZmFjZXNbZGV2aWNlXVsnbWFjYWRkcmVzcyddID0gbWFjYWRkcmVzcwogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocGF0aCwgJ210dScpKToKICAgICAgICAgICAgICAgIGludGVyZmFjZXNbZGV2aWNlXVsnbXR1J10gPSBpbnQoZ2V0X2ZpbGVfY29udGVudChvcy5wYXRoLmpvaW4ocGF0aCwgJ210dScpKSkKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHBhdGgsICdvcGVyc3RhdGUnKSk6CiAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV1bJ2FjdGl2ZSddID0gZ2V0X2ZpbGVfY29udGVudChvcy5wYXRoLmpvaW4ocGF0aCwgJ29wZXJzdGF0ZScpKSAhPSAnZG93bicKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHBhdGgsICdkZXZpY2UnLCAnZHJpdmVyJywgJ21vZHVsZScpKToKICAgICAgICAgICAgICAgIGludGVyZmFjZXNbZGV2aWNlXVsnbW9kdWxlJ10gPSBvcy5wYXRoLmJhc2VuYW1lKG9zLnBhdGgucmVhbHBhdGgob3MucGF0aC5qb2luKHBhdGgsICdkZXZpY2UnLCAnZHJpdmVyJywgJ21vZHVsZScpKSkKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHBhdGgsICd0eXBlJykpOgogICAgICAgICAgICAgICAgX3R5cGUgPSBnZXRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihwYXRoLCAndHlwZScpKQogICAgICAgICAgICAgICAgaW50ZXJmYWNlc1tkZXZpY2VdWyd0eXBlJ10gPSBzZWxmLklOVEVSRkFDRV9UWVBFLmdldChfdHlwZSwgJ3Vua25vd24nKQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocGF0aCwgJ2JyaWRnZScpKToKICAgICAgICAgICAgICAgIGludGVyZmFjZXNbZGV2aWNlXVsndHlwZSddID0gJ2JyaWRnZScKICAgICAgICAgICAgICAgIGludGVyZmFjZXNbZGV2aWNlXVsnaW50ZXJmYWNlcyddID0gW29zLnBhdGguYmFzZW5hbWUoYikgZm9yIGIgaW4gZ2xvYi5nbG9iKG9zLnBhdGguam9pbihwYXRoLCAnYnJpZicsICcqJykpXQogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHBhdGgsICdicmlkZ2UnLCAnYnJpZGdlX2lkJykpOgogICAgICAgICAgICAgICAgICAgIGludGVyZmFjZXNbZGV2aWNlXVsnaWQnXSA9IGdldF9maWxlX2NvbnRlbnQob3MucGF0aC5qb2luKHBhdGgsICdicmlkZ2UnLCAnYnJpZGdlX2lkJyksIGRlZmF1bHQ9JycpCiAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocGF0aCwgJ2JyaWRnZScsICdzdHBfc3RhdGUnKSk6CiAgICAgICAgICAgICAgICAgICAgaW50ZXJmYWNlc1tkZXZpY2VdWydzdHAnXSA9IGdldF9maWxlX2NvbnRlbnQob3MucGF0aC5qb2luKHBhdGgsICdicmlkZ2UnLCAnc3RwX3N0YXRlJykpID09ICcxJwogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocGF0aCwgJ2JvbmRpbmcnKSk6CiAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV1bJ3R5cGUnXSA9ICdib25kaW5nJwogICAgICAgICAgICAgICAgaW50ZXJmYWNlc1tkZXZpY2VdWydzbGF2ZXMnXSA9IGdldF9maWxlX2NvbnRlbnQob3MucGF0aC5qb2luKHBhdGgsICdib25kaW5nJywgJ3NsYXZlcycpLCBkZWZhdWx0PScnKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV1bJ21vZGUnXSA9IGdldF9maWxlX2NvbnRlbnQob3MucGF0aC5qb2luKHBhdGgsICdib25kaW5nJywgJ21vZGUnKSwgZGVmYXVsdD0nJykuc3BsaXQoKVswXQogICAgICAgICAgICAgICAgaW50ZXJmYWNlc1tkZXZpY2VdWydtaWltb24nXSA9IGdldF9maWxlX2NvbnRlbnQob3MucGF0aC5qb2luKHBhdGgsICdib25kaW5nJywgJ21paW1vbicpLCBkZWZhdWx0PScnKS5zcGxpdCgpWzBdCiAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV1bJ2xhY3BfcmF0ZSddID0gZ2V0X2ZpbGVfY29udGVudChvcy5wYXRoLmpvaW4ocGF0aCwgJ2JvbmRpbmcnLCAnbGFjcF9yYXRlJyksIGRlZmF1bHQ9JycpLnNwbGl0KClbMF0KICAgICAgICAgICAgICAgIHByaW1hcnkgPSBnZXRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihwYXRoLCAnYm9uZGluZycsICdwcmltYXJ5JykpCiAgICAgICAgICAgICAgICBpZiBwcmltYXJ5OgogICAgICAgICAgICAgICAgICAgIGludGVyZmFjZXNbZGV2aWNlXVsncHJpbWFyeSddID0gcHJpbWFyeQogICAgICAgICAgICAgICAgICAgIHBhdGggPSBvcy5wYXRoLmpvaW4ocGF0aCwgJ2JvbmRpbmcnLCAnYWxsX3NsYXZlc19hY3RpdmUnKQogICAgICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHBhdGgpOgogICAgICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV1bJ2FsbF9zbGF2ZXNfYWN0aXZlJ10gPSBnZXRfZmlsZV9jb250ZW50KHBhdGgpID09ICcxJwogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocGF0aCwgJ2JvbmRpbmdfc2xhdmUnKSk6CiAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV1bJ3Blcm1fbWFjYWRkcmVzcyddID0gZ2V0X2ZpbGVfY29udGVudChvcy5wYXRoLmpvaW4ocGF0aCwgJ2JvbmRpbmdfc2xhdmUnLCAncGVybV9od2FkZHInKSwgZGVmYXVsdD0nJykKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHBhdGgsICdkZXZpY2UnKSk6CiAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV1bJ3BjaWlkJ10gPSBvcy5wYXRoLmJhc2VuYW1lKG9zLnJlYWRsaW5rKG9zLnBhdGguam9pbihwYXRoLCAnZGV2aWNlJykpKQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocGF0aCwgJ3NwZWVkJykpOgogICAgICAgICAgICAgICAgc3BlZWQgPSBnZXRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihwYXRoLCAnc3BlZWQnKSkKICAgICAgICAgICAgICAgIGlmIHNwZWVkIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIGludGVyZmFjZXNbZGV2aWNlXVsnc3BlZWQnXSA9IGludChzcGVlZCkKCiAgICAgICAgICAgICMgQ2hlY2sgd2hldGhlciBhbiBpbnRlcmZhY2UgaXMgaW4gcHJvbWlzY3VvdXMgbW9kZQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocGF0aCwgJ2ZsYWdzJykpOgogICAgICAgICAgICAgICAgcHJvbWlzY19tb2RlID0gRmFsc2UKICAgICAgICAgICAgICAgICMgVGhlIHNlY29uZCBieXRlIGluZGljYXRlcyB3aGV0aGVyIHRoZSBpbnRlcmZhY2UgaXMgaW4gcHJvbWlzY3VvdXMgbW9kZS4KICAgICAgICAgICAgICAgICMgMSA9IHByb21pc2MKICAgICAgICAgICAgICAgICMgMCA9IG5vIHByb21pc2MKICAgICAgICAgICAgICAgIGRhdGEgPSBpbnQoZ2V0X2ZpbGVfY29udGVudChvcy5wYXRoLmpvaW4ocGF0aCwgJ2ZsYWdzJykpLCAxNikKICAgICAgICAgICAgICAgIHByb21pc2NfbW9kZSA9IChkYXRhICYgMHgwMTAwID4gMCkKICAgICAgICAgICAgICAgIGludGVyZmFjZXNbZGV2aWNlXVsncHJvbWlzYyddID0gcHJvbWlzY19tb2RlCgogICAgICAgICAgICAjIFRPRE86IGRldGVybWluZSBpZiB0aGlzIG5lZWRzIHRvIGJlIGluIGEgbmVzdGVkIHNjb3BlL2Nsb3N1cmUKICAgICAgICAgICAgZGVmIHBhcnNlX2lwX291dHB1dChvdXRwdXQsIHNlY29uZGFyeT1GYWxzZSk6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBvdXRwdXQuc3BsaXRsaW5lcygpOgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIHdvcmRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgYnJvYWRjYXN0ID0gJycKICAgICAgICAgICAgICAgICAgICBpZiB3b3Jkc1swXSA9PSAnaW5ldCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICcvJyBpbiB3b3Jkc1sxXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MsIG5ldG1hc2tfbGVuZ3RoID0gd29yZHNbMV0uc3BsaXQoJy8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHdvcmRzKSA+IDM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJvYWRjYXN0ID0gd29yZHNbM10KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgcG9pbnRvcG9pbnQgaW50ZXJmYWNlcyBkbyBub3QgaGF2ZSBhIHByZWZpeAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyA9IHdvcmRzWzFdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXRtYXNrX2xlbmd0aCA9ICIzMiIKICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzc19iaW4gPSBzdHJ1Y3QudW5wYWNrKCchTCcsIHNvY2tldC5pbmV0X2F0b24oYWRkcmVzcykpWzBdCiAgICAgICAgICAgICAgICAgICAgICAgIG5ldG1hc2tfYmluID0gKDEgPDwgMzIpIC0gKDEgPDwgMzIgPj4gaW50KG5ldG1hc2tfbGVuZ3RoKSkKICAgICAgICAgICAgICAgICAgICAgICAgbmV0bWFzayA9IHNvY2tldC5pbmV0X250b2Eoc3RydWN0LnBhY2soJyFMJywgbmV0bWFza19iaW4pKQogICAgICAgICAgICAgICAgICAgICAgICBuZXR3b3JrID0gc29ja2V0LmluZXRfbnRvYShzdHJ1Y3QucGFjaygnIUwnLCBhZGRyZXNzX2JpbiAmIG5ldG1hc2tfYmluKSkKICAgICAgICAgICAgICAgICAgICAgICAgaWZhY2UgPSB3b3Jkc1stMV0KICAgICAgICAgICAgICAgICAgICAgICAgIyBOT1RFOiBkZXZpY2UgaXMgcmVmIHRvIG91dHNpZGUgc2NvcGUKICAgICAgICAgICAgICAgICAgICAgICAgIyBOT1RFOiBpbnRlcmZhY2VzIGlzIGFsc28gcmVmIHRvIG91dHNpZGUgc2NvcGUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaWZhY2UgIT0gZGV2aWNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJmYWNlc1tpZmFjZV0gPSB7fQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2Vjb25kYXJ5IGFuZCAiaXB2NCIgbm90IGluIGludGVyZmFjZXNbaWZhY2VdOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJmYWNlc1tpZmFjZV1bJ2lwdjQnXSA9IHsnYWRkcmVzcyc6IGFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdicm9hZGNhc3QnOiBicm9hZGNhc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICduZXRtYXNrJzogbmV0bWFzaywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ25ldHdvcmsnOiBuZXR3b3JrfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgImlwdjRfc2Vjb25kYXJpZXMiIG5vdCBpbiBpbnRlcmZhY2VzW2lmYWNlXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2lmYWNlXVsiaXB2NF9zZWNvbmRhcmllcyJdID0gW10KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVyZmFjZXNbaWZhY2VdWyJpcHY0X3NlY29uZGFyaWVzIl0uYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYWRkcmVzcyc6IGFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Jyb2FkY2FzdCc6IGJyb2FkY2FzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbmV0bWFzayc6IG5ldG1hc2ssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ25ldHdvcmsnOiBuZXR3b3JrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgICAgICMgYWRkIHRoaXMgc2Vjb25kYXJ5IElQIHRvIHRoZSBtYWluIGRldmljZQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWNvbmRhcnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAiaXB2NF9zZWNvbmRhcmllcyIgbm90IGluIGludGVyZmFjZXNbZGV2aWNlXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV1bImlwdjRfc2Vjb25kYXJpZXMiXSA9IFtdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV1bImlwdjRfc2Vjb25kYXJpZXMiXS5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhZGRyZXNzJzogYWRkcmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYnJvYWRjYXN0JzogYnJvYWRjYXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICduZXRtYXNrJzogbmV0bWFzaywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbmV0d29yayc6IG5ldHdvcmssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgICAgICAgICAgIyBOT1RFOiBkZWZhdWx0X2lwdjQgaXMgcmVmIHRvIG91dHNpZGUgc2NvcGUKICAgICAgICAgICAgICAgICAgICAgICAgIyBJZiB0aGlzIGlzIHRoZSBkZWZhdWx0IGFkZHJlc3MsIHVwZGF0ZSBkZWZhdWx0X2lwdjQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgJ2FkZHJlc3MnIGluIGRlZmF1bHRfaXB2NCBhbmQgZGVmYXVsdF9pcHY0WydhZGRyZXNzJ10gPT0gYWRkcmVzczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRfaXB2NFsnYnJvYWRjYXN0J10gPSBicm9hZGNhc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRfaXB2NFsnbmV0bWFzayddID0gbmV0bWFzawogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdF9pcHY0WyduZXR3b3JrJ10gPSBuZXR3b3JrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE5PVEU6IG1hY2FkcmVzcyBpcyByZWYgZnJvbSBvdXRzaWRlIHNjb3BlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0X2lwdjRbJ21hY2FkZHJlc3MnXSA9IG1hY2FkZHJlc3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRfaXB2NFsnbXR1J10gPSBpbnRlcmZhY2VzW2RldmljZV1bJ210dSddCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0X2lwdjRbJ3R5cGUnXSA9IGludGVyZmFjZXNbZGV2aWNlXS5nZXQoInR5cGUiLCAidW5rbm93biIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0X2lwdjRbJ2FsaWFzJ10gPSB3b3Jkc1stMV0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IGFkZHJlc3Muc3RhcnRzd2l0aCgnMTI3LicpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXBzWydhbGxfaXB2NF9hZGRyZXNzZXMnXS5hcHBlbmQoYWRkcmVzcykKICAgICAgICAgICAgICAgICAgICBlbGlmIHdvcmRzWzBdID09ICdpbmV0Nic6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICdwZWVyJyA9PSB3b3Jkc1syXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgPSB3b3Jkc1sxXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXywgcHJlZml4ID0gd29yZHNbM10uc3BsaXQoJy8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSB3b3Jkc1s1XQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcywgcHJlZml4ID0gd29yZHNbMV0uc3BsaXQoJy8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSB3b3Jkc1szXQogICAgICAgICAgICAgICAgICAgICAgICBpZiAnaXB2Nicgbm90IGluIGludGVyZmFjZXNbZGV2aWNlXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVyZmFjZXNbZGV2aWNlXVsnaXB2NiddID0gW10KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVyZmFjZXNbZGV2aWNlXVsnaXB2NiddLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2FkZHJlc3MnOiBhZGRyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwcmVmaXgnOiBwcmVmaXgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Njb3BlJzogc2NvcGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICMgSWYgdGhpcyBpcyB0aGUgZGVmYXVsdCBhZGRyZXNzLCB1cGRhdGUgZGVmYXVsdF9pcHY2CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICdhZGRyZXNzJyBpbiBkZWZhdWx0X2lwdjYgYW5kIGRlZmF1bHRfaXB2NlsnYWRkcmVzcyddID09IGFkZHJlc3M6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0X2lwdjZbJ3ByZWZpeCddID0gcHJlZml4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0X2lwdjZbJ3Njb3BlJ10gPSBzY29wZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdF9pcHY2WydtYWNhZGRyZXNzJ10gPSBtYWNhZGRyZXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0X2lwdjZbJ210dSddID0gaW50ZXJmYWNlc1tkZXZpY2VdWydtdHUnXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdF9pcHY2Wyd0eXBlJ10gPSBpbnRlcmZhY2VzW2RldmljZV0uZ2V0KCJ0eXBlIiwgInVua25vd24iKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgYWRkcmVzcyA9PSAnOjoxJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlwc1snYWxsX2lwdjZfYWRkcmVzc2VzJ10uYXBwZW5kKGFkZHJlc3MpCgogICAgICAgICAgICBpcF9wYXRoID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCJpcCIpCgogICAgICAgICAgICBhcmdzID0gW2lwX3BhdGgsICdhZGRyJywgJ3Nob3cnLCAncHJpbWFyeScsIGRldmljZV0KICAgICAgICAgICAgcmMsIHByaW1hcnlfZGF0YSwgc3RkZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoYXJncywgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykKCiAgICAgICAgICAgIGFyZ3MgPSBbaXBfcGF0aCwgJ2FkZHInLCAnc2hvdycsICdzZWNvbmRhcnknLCBkZXZpY2VdCiAgICAgICAgICAgIHJjLCBzZWNvbmRhcnlfZGF0YSwgc3RkZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoYXJncywgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykKCiAgICAgICAgICAgIHBhcnNlX2lwX291dHB1dChwcmltYXJ5X2RhdGEpCiAgICAgICAgICAgIHBhcnNlX2lwX291dHB1dChzZWNvbmRhcnlfZGF0YSwgc2Vjb25kYXJ5PVRydWUpCgogICAgICAgICAgICBpbnRlcmZhY2VzW2RldmljZV0udXBkYXRlKHNlbGYuZ2V0X2V0aHRvb2xfZGF0YShkZXZpY2UpKQoKICAgICAgICAjIHJlcGxhY2UgOiBieSBfIGluIGludGVyZmFjZSBuYW1lIHNpbmNlIHRoZXkgYXJlIGhhcmQgdG8gdXNlIGluIHRlbXBsYXRlCiAgICAgICAgbmV3X2ludGVyZmFjZXMgPSB7fQogICAgICAgICMgaSBpcyBhIGRpY3Qga2V5IChzdHJpbmcpIG5vdCBhbiBpbmRleCBpbnQKICAgICAgICBmb3IgaSBpbiBpbnRlcmZhY2VzOgogICAgICAgICAgICBpZiAnOicgaW4gaToKICAgICAgICAgICAgICAgIG5ld19pbnRlcmZhY2VzW2kucmVwbGFjZSgnOicsICdfJyldID0gaW50ZXJmYWNlc1tpXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbmV3X2ludGVyZmFjZXNbaV0gPSBpbnRlcmZhY2VzW2ldCiAgICAgICAgcmV0dXJuIG5ld19pbnRlcmZhY2VzLCBpcHMKCiAgICBkZWYgZ2V0X2V0aHRvb2xfZGF0YShzZWxmLCBkZXZpY2UpOgoKICAgICAgICBkYXRhID0ge30KICAgICAgICBldGh0b29sX3BhdGggPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoImV0aHRvb2wiKQogICAgICAgICMgRklYTUU6IGV4aXQgZWFybHkgb24gZmFsc2V5IGV0aHRvb2xfcGF0aCBhbmQgdW4taW5kZW50CiAgICAgICAgaWYgZXRodG9vbF9wYXRoOgogICAgICAgICAgICBhcmdzID0gW2V0aHRvb2xfcGF0aCwgJy1rJywgZGV2aWNlXQogICAgICAgICAgICByYywgc3Rkb3V0LCBzdGRlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZChhcmdzLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKQogICAgICAgICAgICAjIEZJWE1FOiBleGl0IGVhcmx5IG9uIGZhbHNleSBpZiB3ZSBjYW4KICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgIGZlYXR1cmVzID0ge30KICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIHN0ZG91dC5zdHJpcCgpLnNwbGl0bGluZXMoKToKICAgICAgICAgICAgICAgICAgICBpZiBub3QgbGluZSBvciBsaW5lLmVuZHN3aXRoKCI6Iik6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAga2V5LCB2YWx1ZSA9IGxpbmUuc3BsaXQoIjogIikKICAgICAgICAgICAgICAgICAgICBpZiBub3QgdmFsdWU6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZXNba2V5LnN0cmlwKCkucmVwbGFjZSgnLScsICdfJyldID0gdmFsdWUuc3RyaXAoKQogICAgICAgICAgICAgICAgZGF0YVsnZmVhdHVyZXMnXSA9IGZlYXR1cmVzCgogICAgICAgICAgICBhcmdzID0gW2V0aHRvb2xfcGF0aCwgJy1UJywgZGV2aWNlXQogICAgICAgICAgICByYywgc3Rkb3V0LCBzdGRlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZChhcmdzLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKQogICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgZGF0YVsndGltZXN0YW1waW5nJ10gPSBbbS5sb3dlcigpIGZvciBtIGluIHJlLmZpbmRhbGwoJ1NPRl9USU1FU1RBTVBJTkdfKFx3KyknLCBzdGRvdXQpXQogICAgICAgICAgICAgICAgZGF0YVsnaHdfdGltZXN0YW1wX2ZpbHRlcnMnXSA9IFttLmxvd2VyKCkgZm9yIG0gaW4gcmUuZmluZGFsbCgnSFdUU1RBTVBfRklMVEVSXyhcdyspJywgc3Rkb3V0KV0KICAgICAgICAgICAgICAgIG0gPSByZS5zZWFyY2goJ1BUUCBIYXJkd2FyZSBDbG9jazogKFxkKyknLCBzdGRvdXQpCiAgICAgICAgICAgICAgICBpZiBtOgogICAgICAgICAgICAgICAgICAgIGRhdGFbJ3BoY19pbmRleCddID0gaW50KG0uZ3JvdXBzKClbMF0pCgogICAgICAgIHJldHVybiBkYXRhCgoKY2xhc3MgTGludXhOZXR3b3JrQ29sbGVjdG9yKE5ldHdvcmtDb2xsZWN0b3IpOgogICAgX3BsYXRmb3JtID0gJ0xpbnV4JwogICAgX2ZhY3RfY2xhc3MgPSBMaW51eE5ldHdvcmsKUEsDBBQAAAAAAMu7K0tEW1+ZfiUAAH4lAAAsAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvaGFyZHdhcmUvc3Vub3MucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKaW1wb3J0IHJlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5tb3ZlcyBpbXBvcnQgcmVkdWNlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmJhc2ljIGltcG9ydCBieXRlc190b19odW1hbgoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy51dGlscyBpbXBvcnQgZ2V0X2ZpbGVfY29udGVudCwgZ2V0X21vdW50X3NpemUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUuYmFzZSBpbXBvcnQgSGFyZHdhcmUsIEhhcmR3YXJlQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMgaW1wb3J0IHRpbWVvdXQKCgpjbGFzcyBTdW5PU0hhcmR3YXJlKEhhcmR3YXJlKToKICAgICIiIgogICAgSW4gYWRkaXRpb24gdG8gdGhlIGdlbmVyaWMgbWVtb3J5IGFuZCBjcHUgZmFjdHMsIHRoaXMgYWxzbyBzZXRzCiAgICBzd2FwX3Jlc2VydmVkX21iIGFuZCBzd2FwX2FsbG9jYXRlZF9tYiB0aGF0IGlzIGF2YWlsYWJsZSBmcm9tICpzd2FwIC1zKi4KICAgICIiIgogICAgcGxhdGZvcm0gPSAnU3VuT1MnCgogICAgZGVmIHBvcHVsYXRlKHNlbGYsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBoYXJkd2FyZV9mYWN0cyA9IHt9CgogICAgICAgICMgRklYTUU6IGNvdWxkIHBhc3MgdG8gcnVuX2NvbW1hbmQoZW52aXJvbl91cGRhdGUpLCBidXQgaXQgYWxzbyB0d2Vha3MgdGhlIGVudgogICAgICAgICMgICAgICAgIG9mIHRoZSBwYXJlbnQgcHJvY2VzcyBpbnN0ZWFkIG9mIGFsdGVyaW5nIGFuIGVudiBwcm92aWRlZCB0byBQb3BlbigpCiAgICAgICAgIyBVc2UgQyBsb2NhbGUgZm9yIGhhcmR3YXJlIGNvbGxlY3Rpb24gaGVscGVycyB0byBhdm9pZCBsb2NhbGUgc3BlY2lmaWMgbnVtYmVyIGZvcm1hdHRpbmcgKCMyNDU0MikKICAgICAgICBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZF9lbnZpcm9uX3VwZGF0ZSA9IHsnTEFORyc6ICdDJywgJ0xDX0FMTCc6ICdDJywgJ0xDX05VTUVSSUMnOiAnQyd9CgogICAgICAgIGNwdV9mYWN0cyA9IHNlbGYuZ2V0X2NwdV9mYWN0cygpCiAgICAgICAgbWVtb3J5X2ZhY3RzID0gc2VsZi5nZXRfbWVtb3J5X2ZhY3RzKCkKICAgICAgICBkbWlfZmFjdHMgPSBzZWxmLmdldF9kbWlfZmFjdHMoKQogICAgICAgIGRldmljZV9mYWN0cyA9IHNlbGYuZ2V0X2RldmljZV9mYWN0cygpCiAgICAgICAgdXB0aW1lX2ZhY3RzID0gc2VsZi5nZXRfdXB0aW1lX2ZhY3RzKCkKCiAgICAgICAgbW91bnRfZmFjdHMgPSB7fQogICAgICAgIHRyeToKICAgICAgICAgICAgbW91bnRfZmFjdHMgPSBzZWxmLmdldF9tb3VudF9mYWN0cygpCiAgICAgICAgZXhjZXB0IHRpbWVvdXQuVGltZW91dEVycm9yOgogICAgICAgICAgICBwYXNzCgogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShjcHVfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKG1lbW9yeV9mYWN0cykKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUoZG1pX2ZhY3RzKQogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShkZXZpY2VfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKHVwdGltZV9mYWN0cykKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUobW91bnRfZmFjdHMpCgogICAgICAgIHJldHVybiBoYXJkd2FyZV9mYWN0cwoKICAgIGRlZiBnZXRfY3B1X2ZhY3RzKHNlbGYsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBwaHlzaWQgPSAwCiAgICAgICAgc29ja2V0cyA9IHt9CgogICAgICAgIGNwdV9mYWN0cyA9IHt9CiAgICAgICAgY29sbGVjdGVkX2ZhY3RzID0gY29sbGVjdGVkX2ZhY3RzIG9yIHt9CgogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvdXNyL2Jpbi9rc3RhdCBjcHVfaW5mbyIpCgogICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yJ10gPSBbXQoKICAgICAgICBmb3IgbGluZSBpbiBvdXQuc3BsaXRsaW5lcygpOgogICAgICAgICAgICBpZiBsZW4obGluZSkgPCAxOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGRhdGEgPSBsaW5lLnNwbGl0KE5vbmUsIDEpCiAgICAgICAgICAgIGtleSA9IGRhdGFbMF0uc3RyaXAoKQoKICAgICAgICAgICAgIyAiYnJhbmQiIHdvcmtzIG9uIFNvbGFyaXMgMTAgJiAxMS4gImltcGxlbWVudGF0aW9uIiBmb3IgU29sYXJpcyA5LgogICAgICAgICAgICBpZiBrZXkgPT0gJ21vZHVsZTonOgogICAgICAgICAgICAgICAgYnJhbmQgPSAnJwogICAgICAgICAgICBlbGlmIGtleSA9PSAnYnJhbmQnOgogICAgICAgICAgICAgICAgYnJhbmQgPSBkYXRhWzFdLnN0cmlwKCkKICAgICAgICAgICAgZWxpZiBrZXkgPT0gJ2Nsb2NrX01Ieic6CiAgICAgICAgICAgICAgICBjbG9ja19taHogPSBkYXRhWzFdLnN0cmlwKCkKICAgICAgICAgICAgZWxpZiBrZXkgPT0gJ2ltcGxlbWVudGF0aW9uJzoKICAgICAgICAgICAgICAgIHByb2Nlc3NvciA9IGJyYW5kIG9yIGRhdGFbMV0uc3RyaXAoKQogICAgICAgICAgICAgICAgIyBBZGQgY2xvY2sgc3BlZWQgdG8gZGVzY3JpcHRpb24gZm9yIFNQQVJDIENQVQogICAgICAgICAgICAgICAgIyBGSVhNRQogICAgICAgICAgICAgICAgaWYgY29sbGVjdGVkX2ZhY3RzLmdldCgnYW5zaWJsZV9tYWNoaW5lJykgIT0gJ2k4NnBjJzoKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzb3IgKz0gIiBAICIgKyBjbG9ja19taHogKyAiTUh6IgogICAgICAgICAgICAgICAgaWYgJ2Fuc2libGVfcHJvY2Vzc29yJyBub3QgaW4gY29sbGVjdGVkX2ZhY3RzOgogICAgICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yJ10gPSBbXQogICAgICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3InXS5hcHBlbmQocHJvY2Vzc29yKQogICAgICAgICAgICBlbGlmIGtleSA9PSAnY2hpcF9pZCc6CiAgICAgICAgICAgICAgICBwaHlzaWQgPSBkYXRhWzFdLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIHBoeXNpZCBub3QgaW4gc29ja2V0czoKICAgICAgICAgICAgICAgICAgICBzb2NrZXRzW3BoeXNpZF0gPSAxCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNvY2tldHNbcGh5c2lkXSArPSAxCgogICAgICAgICMgQ291bnRpbmcgY29yZXMgb24gU29sYXJpcyBjYW4gYmUgY29tcGxpY2F0ZWQuCiAgICAgICAgIyBodHRwczovL2Jsb2dzLm9yYWNsZS5jb20vbWFuZGFsaWthL2VudHJ5L3NvbGFyaXNfc2hvd19tZV90aGVfY3B1CiAgICAgICAgIyBUcmVhdCAncHJvY2Vzc29yX2NvdW50JyBhcyBwaHlzaWNhbCBzb2NrZXRzIGFuZCAncHJvY2Vzc29yX2NvcmVzJyBhcwogICAgICAgICMgdmlydHVhbCBDUFVzIHZpc2lzYmxlIHRvIFNvbGFyaXMuIE5vdCBhIHRydWUgY291bnQgb2YgY29yZXMgZm9yIG1vZGVybiBTUEFSQyBhcwogICAgICAgICMgdGhlc2UgcHJvY2Vzc29ycyBoYXZlOiBzb2NrZXRzIC0+IGNvcmVzIC0+IHRocmVhZHMvdmlydHVhbCBDUFUuCiAgICAgICAgaWYgbGVuKHNvY2tldHMpID4gMDoKICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY291bnQnXSA9IGxlbihzb2NrZXRzKQogICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3JlcyddID0gcmVkdWNlKGxhbWJkYSB4LCB5OiB4ICsgeSwgc29ja2V0cy52YWx1ZXMoKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3JlcyddID0gJ05BJwogICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3VudCddID0gbGVuKGNwdV9mYWN0c1sncHJvY2Vzc29yJ10pCgogICAgICAgIHJldHVybiBjcHVfZmFjdHMKCiAgICBkZWYgZ2V0X21lbW9yeV9mYWN0cyhzZWxmKToKICAgICAgICBtZW1vcnlfZmFjdHMgPSB7fQoKICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZChbIi91c3Ivc2Jpbi9wcnRjb25mIl0pCgogICAgICAgIGZvciBsaW5lIGluIG91dC5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgIGlmICdNZW1vcnkgc2l6ZScgaW4gbGluZToKICAgICAgICAgICAgICAgIG1lbW9yeV9mYWN0c1snbWVtdG90YWxfbWInXSA9IGludChsaW5lLnNwbGl0KClbMl0pCgogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvdXNyL3NiaW4vc3dhcCAtcyIpCgogICAgICAgIGFsbG9jYXRlZCA9IGludChvdXQuc3BsaXQoKVsxXVs6LTFdKQogICAgICAgIHJlc2VydmVkID0gaW50KG91dC5zcGxpdCgpWzVdWzotMV0pCiAgICAgICAgdXNlZCA9IGludChvdXQuc3BsaXQoKVs4XVs6LTFdKQogICAgICAgIGZyZWUgPSBpbnQob3V0LnNwbGl0KClbMTBdWzotMV0pCgogICAgICAgIG1lbW9yeV9mYWN0c1snc3dhcGZyZWVfbWInXSA9IGZyZWUgLy8gMTAyNAogICAgICAgIG1lbW9yeV9mYWN0c1snc3dhcHRvdGFsX21iJ10gPSAoZnJlZSArIHVzZWQpIC8vIDEwMjQKICAgICAgICBtZW1vcnlfZmFjdHNbJ3N3YXBfYWxsb2NhdGVkX21iJ10gPSBhbGxvY2F0ZWQgLy8gMTAyNAogICAgICAgIG1lbW9yeV9mYWN0c1snc3dhcF9yZXNlcnZlZF9tYiddID0gcmVzZXJ2ZWQgLy8gMTAyNAoKICAgICAgICByZXR1cm4gbWVtb3J5X2ZhY3RzCgogICAgQHRpbWVvdXQudGltZW91dCgpCiAgICBkZWYgZ2V0X21vdW50X2ZhY3RzKHNlbGYpOgogICAgICAgIG1vdW50X2ZhY3RzID0ge30KICAgICAgICBtb3VudF9mYWN0c1snbW91bnRzJ10gPSBbXQoKICAgICAgICAjIEZvciBhIGRldGFpbGVkIGZvcm1hdCBkZXNjcmlwdGlvbiBzZWUgbW50dGFiKDQpCiAgICAgICAgIyAgIHNwZWNpYWwgbW91bnRfcG9pbnQgZnN0eXBlIG9wdGlvbnMgdGltZQogICAgICAgIGZzdGFiID0gZ2V0X2ZpbGVfY29udGVudCgnL2V0Yy9tbnR0YWInKQoKICAgICAgICBpZiBmc3RhYjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZnN0YWIuc3BsaXRsaW5lcygpOgogICAgICAgICAgICAgICAgZmllbGRzID0gbGluZS5zcGxpdCgnXHQnKQogICAgICAgICAgICAgICAgc2l6ZV90b3RhbCwgc2l6ZV9hdmFpbGFibGUgPSBnZXRfbW91bnRfc2l6ZShmaWVsZHNbMV0pCiAgICAgICAgICAgICAgICBtb3VudF9mYWN0c1snbW91bnRzJ10uYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAnbW91bnQnOiBmaWVsZHNbMV0sCiAgICAgICAgICAgICAgICAgICAgJ2RldmljZSc6IGZpZWxkc1swXSwKICAgICAgICAgICAgICAgICAgICAnZnN0eXBlJzogZmllbGRzWzJdLAogICAgICAgICAgICAgICAgICAgICdvcHRpb25zJzogZmllbGRzWzNdLAogICAgICAgICAgICAgICAgICAgICd0aW1lJzogZmllbGRzWzRdLAogICAgICAgICAgICAgICAgICAgICdzaXplX3RvdGFsJzogc2l6ZV90b3RhbCwKICAgICAgICAgICAgICAgICAgICAnc2l6ZV9hdmFpbGFibGUnOiBzaXplX2F2YWlsYWJsZQogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgcmV0dXJuIG1vdW50X2ZhY3RzCgogICAgZGVmIGdldF9kbWlfZmFjdHMoc2VsZik6CiAgICAgICAgZG1pX2ZhY3RzID0ge30KCiAgICAgICAgdW5hbWVfcGF0aCA9IHNlbGYubW9kdWxlLmdldF9iaW5fcGF0aCgicHJ0ZGlhZyIpCiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQodW5hbWVfcGF0aCkKICAgICAgICAiIiIKICAgICAgICByYyByZXR1cm5zIDEKICAgICAgICAiIiIKICAgICAgICBpZiBvdXQ6CiAgICAgICAgICAgIHN5c3RlbV9jb25mID0gb3V0LnNwbGl0KCdcbicpWzBdCiAgICAgICAgICAgIGZvdW5kID0gcmUuc2VhcmNoKHInKFx3K1xzRW50ZXJwcmlzZVxzXHcrKScsIHN5c3RlbV9jb25mKQoKICAgICAgICAgICAgaWYgZm91bmQ6CiAgICAgICAgICAgICAgICBkbWlfZmFjdHNbJ3Byb2R1Y3RfbmFtZSddID0gZm91bmQuZ3JvdXAoMSkKCiAgICAgICAgcmV0dXJuIGRtaV9mYWN0cwoKICAgIGRlZiBnZXRfZGV2aWNlX2ZhY3RzKHNlbGYpOgogICAgICAgICMgRGV2aWNlIGZhY3RzIGFyZSBkZXJpdmVkIGZvciBzZGRlcnIga3N0YXRzLiBUaGlzIGNvZGUgZG9lcyBub3QgdXNlIHRoZQogICAgICAgICMgZnVsbCBvdXRwdXQsIGJ1dCByYXRoZXIgcXVlcmllcyBmb3Igc3BlY2lmaWMgc3RhdHMuCiAgICAgICAgIyBFeGFtcGxlIG91dHB1dDoKICAgICAgICAjIHNkZXJyOjA6c2QwLGVycjpIYXJkIEVycm9ycyAgICAgMAogICAgICAgICMgc2RlcnI6MDpzZDAsZXJyOklsbGVnYWwgUmVxdWVzdCA2CiAgICAgICAgIyBzZGVycjowOnNkMCxlcnI6TWVkaWEgRXJyb3IgICAgIDAKICAgICAgICAjIHNkZXJyOjA6c2QwLGVycjpQcmVkaWN0aXZlIEZhaWx1cmUgQW5hbHlzaXMgICAgIDAKICAgICAgICAjIHNkZXJyOjA6c2QwLGVycjpQcm9kdWN0IFZCT1ggSEFSRERJU0sgICA5CiAgICAgICAgIyBzZGVycjowOnNkMCxlcnI6UmV2aXNpb24gICAgICAgIDEuMAogICAgICAgICMgc2RlcnI6MDpzZDAsZXJyOlNlcmlhbCBObyAgICAgICBWQjBhZDJlYzRkLTA3NGEKICAgICAgICAjIHNkZXJyOjA6c2QwLGVycjpTaXplICAgIDUzNjg3MDkxMjAwCiAgICAgICAgIyBzZGVycjowOnNkMCxlcnI6U29mdCBFcnJvcnMgICAgIDAKICAgICAgICAjIHNkZXJyOjA6c2QwLGVycjpUcmFuc3BvcnQgRXJyb3JzICAgICAgICAwCiAgICAgICAgIyBzZGVycjowOnNkMCxlcnI6VmVuZG9yICBBVEEKCiAgICAgICAgZGV2aWNlX2ZhY3RzID0ge30KCiAgICAgICAgZGlza19zdGF0cyA9IHsKICAgICAgICAgICAgJ1Byb2R1Y3QnOiAncHJvZHVjdCcsCiAgICAgICAgICAgICdSZXZpc2lvbic6ICdyZXZpc2lvbicsCiAgICAgICAgICAgICdTZXJpYWwgTm8nOiAnc2VyaWFsJywKICAgICAgICAgICAgJ1NpemUnOiAnc2l6ZScsCiAgICAgICAgICAgICdWZW5kb3InOiAndmVuZG9yJywKICAgICAgICAgICAgJ0hhcmQgRXJyb3JzJzogJ2hhcmRfZXJyb3JzJywKICAgICAgICAgICAgJ1NvZnQgRXJyb3JzJzogJ3NvZnRfZXJyb3JzJywKICAgICAgICAgICAgJ1RyYW5zcG9ydCBFcnJvcnMnOiAndHJhbnNwb3J0X2Vycm9ycycsCiAgICAgICAgICAgICdNZWRpYSBFcnJvcic6ICdtZWRpYV9lcnJvcnMnLAogICAgICAgICAgICAnUHJlZGljdGl2ZSBGYWlsdXJlIEFuYWx5c2lzJzogJ3ByZWRpY3RpdmVfZmFpbHVyZV9hbmFseXNpcycsCiAgICAgICAgICAgICdJbGxlZ2FsIFJlcXVlc3QnOiAnaWxsZWdhbF9yZXF1ZXN0JywKICAgICAgICB9CgogICAgICAgIGNtZCA9IFsnL3Vzci9iaW4va3N0YXQnLCAnLXAnXQoKICAgICAgICBmb3IgZHMgaW4gZGlza19zdGF0czoKICAgICAgICAgICAgY21kLmFwcGVuZCgnc2RlcnI6OjolcycgJSBkcykKCiAgICAgICAgZCA9IHt9CiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoY21kKQogICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgIHJldHVybiBkZXZpY2VfZmFjdHMKCiAgICAgICAgc2RfaW5zdGFuY2VzID0gZnJvemVuc2V0KGxpbmUuc3BsaXQoJzonKVsxXSBmb3IgbGluZSBpbiBvdXQuc3BsaXQoJ1xuJykgaWYgbGluZS5zdGFydHN3aXRoKCdzZGVycicpKQogICAgICAgIGZvciBpbnN0YW5jZSBpbiBzZF9pbnN0YW5jZXM6CiAgICAgICAgICAgIGxpbmVzID0gKGxpbmUgZm9yIGxpbmUgaW4gb3V0LnNwbGl0KCdcbicpIGlmICc6JyBpbiBsaW5lIGFuZCBsaW5lLnNwbGl0KCc6JylbMV0gPT0gaW5zdGFuY2UpCiAgICAgICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICAgICAgdGV4dCwgdmFsdWUgPSBsaW5lLnNwbGl0KCdcdCcpCiAgICAgICAgICAgICAgICBzdGF0ID0gdGV4dC5zcGxpdCgnOicpWzNdCgogICAgICAgICAgICAgICAgaWYgc3RhdCA9PSAnU2l6ZSc6CiAgICAgICAgICAgICAgICAgICAgZFtkaXNrX3N0YXRzLmdldChzdGF0KV0gPSBieXRlc190b19odW1hbihmbG9hdCh2YWx1ZSkpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGRbZGlza19zdGF0cy5nZXQoc3RhdCldID0gdmFsdWUucnN0cmlwKCkKCiAgICAgICAgICAgIGRpc2tuYW1lID0gJ3NkJyArIGluc3RhbmNlCiAgICAgICAgICAgIGRldmljZV9mYWN0c1snZGV2aWNlcyddW2Rpc2tuYW1lXSA9IGQKICAgICAgICAgICAgZCA9IHt9CgogICAgICAgIHJldHVybiBkZXZpY2VfZmFjdHMKCiAgICBkZWYgZ2V0X3VwdGltZV9mYWN0cyhzZWxmKToKICAgICAgICB1cHRpbWVfZmFjdHMgPSB7fQogICAgICAgICMgT24gU29sYXJpcywgdW5peDowOnN5c3RlbV9taXNjOnNuYXB0aW1lIGlzIGNyZWF0ZWQgc2hvcnRseSBhZnRlciBtYWNoaW5lIGJvb3RzIHVwCiAgICAgICAgIyBhbmQgZGlzcGxheXMgdGllbSBpbiBzZWNvbmRzLiBUaGlzIGlzIG11Y2ggZWFzaWVyIHRoYW4gdXNpbmcgdXB0aW1lIGFzIHdlIHdvdWxkCiAgICAgICAgIyBuZWVkIHRvIGhhdmUgYSBwYXJzaW5nIHByb2NlZHVyZSBmb3IgdHJhbnNsYXRpbmcgZnJvbSBodW1hbi1yZWFkYWJsZSB0byBtYWNoaW5lLXJlYWRhYmxlCiAgICAgICAgIyBmb3JtYXQuCiAgICAgICAgIyBFeGFtcGxlIG91dHB1dDoKICAgICAgICAjIHVuaXg6MDpzeXN0ZW1fbWlzYzpzbmFwdGltZSAgICAgMTE3NS40MTA0NjM1OTAKICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgnL3Vzci9iaW4va3N0YXQgLXAgdW5peDowOnN5c3RlbV9taXNjOnNuYXB0aW1lJykKCiAgICAgICAgaWYgcmMgIT0gMDoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHVwdGltZV9mYWN0c1sndXB0aW1lX3NlY29uZHMnXSA9IGludChmbG9hdChvdXQuc3BsaXQoJ1x0JylbMV0pKQoKICAgICAgICByZXR1cm4gdXB0aW1lX2ZhY3RzCgoKY2xhc3MgU3VuT1NIYXJkd2FyZUNvbGxlY3RvcihIYXJkd2FyZUNvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IFN1bk9TSGFyZHdhcmUKICAgIF9wbGF0Zm9ybSA9ICdTdW5PUycKUEsDBBQAAAAAAMu7K0vBQysuxBIAAMQSAAArAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvbmV0d29yay9zdW5vcy5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgppbXBvcnQgcmUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5iYXNlIGltcG9ydCBOZXR3b3JrQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5nZW5lcmljX2JzZCBpbXBvcnQgR2VuZXJpY0JzZElmY29uZmlnTmV0d29yawoKCmNsYXNzIFN1bk9TTmV0d29yayhHZW5lcmljQnNkSWZjb25maWdOZXR3b3JrKToKICAgICIiIgogICAgVGhpcyBpcyB0aGUgU3VuT1MgTmV0d29yayBDbGFzcy4KICAgIEl0IHVzZXMgdGhlIEdlbmVyaWNCc2RJZmNvbmZpZ05ldHdvcmsuCgogICAgU29sYXJpcyBjYW4gaGF2ZSBkaWZmZXJlbnQgRkxBR1MgYW5kIE1UVSBmb3IgSVB2NCBhbmQgSVB2NiBvbiB0aGUgc2FtZSBpbnRlcmZhY2UKICAgIHNvIHRoZXNlIGZhY3RzIGhhdmUgYmVlbiBtb3ZlZCBpbnNpZGUgdGhlICdpcHY0JyBhbmQgJ2lwdjYnIGxpc3RzLgogICAgIiIiCiAgICBwbGF0Zm9ybSA9ICdTdW5PUycKCiAgICAjIFNvbGFyaXMgJ2lmY29uZmlnIC1hJyB3aWxsIHByaW50IGludGVyZmFjZXMgdHdpY2UsIG9uY2UgZm9yIElQdjQgYW5kIGFnYWluIGZvciBJUHY2LgogICAgIyBNVFUgYW5kIEZMQUdTIGFsc28gbWF5IGRpZmZlciBiZXR3ZWVuIElQdjQgYW5kIElQdjYgb24gdGhlIHNhbWUgaW50ZXJmYWNlLgogICAgIyAncGFyc2VfaW50ZXJmYWNlX2xpbmUoKScgY2hlY2tzIGZvciBwcmV2aW91c2x5IHNlZW4gaW50ZXJmYWNlcyBiZWZvcmUgZGVmaW5pbmcKICAgICMgJ2N1cnJlbnRfaWYnIHNvIHRoYXQgSVB2NiBmYWN0cyBkb24ndCBjbG9iYmVyIElQdjQgZmFjdHMgKG9yIHZpY2UgdmVyc2EpLgogICAgZGVmIGdldF9pbnRlcmZhY2VzX2luZm8oc2VsZiwgaWZjb25maWdfcGF0aCk6CiAgICAgICAgaW50ZXJmYWNlcyA9IHt9CiAgICAgICAgY3VycmVudF9pZiA9IHt9CiAgICAgICAgaXBzID0gZGljdCgKICAgICAgICAgICAgYWxsX2lwdjRfYWRkcmVzc2VzPVtdLAogICAgICAgICAgICBhbGxfaXB2Nl9hZGRyZXNzZXM9W10sCiAgICAgICAgKQogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKFtpZmNvbmZpZ19wYXRoLCAnLWEnXSkKCiAgICAgICAgZm9yIGxpbmUgaW4gb3V0LnNwbGl0bGluZXMoKToKCiAgICAgICAgICAgIGlmIGxpbmU6CiAgICAgICAgICAgICAgICB3b3JkcyA9IGxpbmUuc3BsaXQoKQoKICAgICAgICAgICAgICAgIGlmIHJlLm1hdGNoKCdeXFMnLCBsaW5lKSBhbmQgbGVuKHdvcmRzKSA+IDM6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudF9pZiA9IHNlbGYucGFyc2VfaW50ZXJmYWNlX2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGludGVyZmFjZXMpCiAgICAgICAgICAgICAgICAgICAgaW50ZXJmYWNlc1tjdXJyZW50X2lmWydkZXZpY2UnXV0gPSBjdXJyZW50X2lmCiAgICAgICAgICAgICAgICBlbGlmIHdvcmRzWzBdLnN0YXJ0c3dpdGgoJ29wdGlvbnM9Jyk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV9vcHRpb25zX2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKICAgICAgICAgICAgICAgIGVsaWYgd29yZHNbMF0gPT0gJ25kNic6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV9uZDZfbGluZSh3b3JkcywgY3VycmVudF9pZiwgaXBzKQogICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1swXSA9PSAnZXRoZXInOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyc2VfZXRoZXJfbGluZSh3b3JkcywgY3VycmVudF9pZiwgaXBzKQogICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1swXSA9PSAnbWVkaWE6JzoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcnNlX21lZGlhX2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKICAgICAgICAgICAgICAgIGVsaWYgd29yZHNbMF0gPT0gJ3N0YXR1czonOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyc2Vfc3RhdHVzX2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKICAgICAgICAgICAgICAgIGVsaWYgd29yZHNbMF0gPT0gJ2xsYWRkcic6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV9sbGFkZHJfbGluZSh3b3JkcywgY3VycmVudF9pZiwgaXBzKQogICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1swXSA9PSAnaW5ldCc6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV9pbmV0X2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKICAgICAgICAgICAgICAgIGVsaWYgd29yZHNbMF0gPT0gJ2luZXQ2JzoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcnNlX2luZXQ2X2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV91bmtub3duX2xpbmUod29yZHMsIGN1cnJlbnRfaWYsIGlwcykKCiAgICAgICAgIyAncGFyc2VfaW50ZXJmYWNlX2xpbmUnIGFuZCAncGFyc2VfaW5ldCpfbGluZScgbGVhdmUgdHdvIGRpY3RzIGluIHRoZQogICAgICAgICMgaXB2NC9pcHY2IGxpc3RzIHdoaWNoIGlzIHVnbHkgYW5kIGhhcmQgdG8gcmVhZC4KICAgICAgICAjIFRoaXMgcXVpY2sgaGFjayBtZXJnZXMgdGhlIGRpY3Rpb25hcmllcy4gUHVyZWx5IGNvc21ldGljLgogICAgICAgIGZvciBpZmFjZSBpbiBpbnRlcmZhY2VzOgogICAgICAgICAgICBmb3IgdiBpbiAnaXB2NCcsICdpcHY2JzoKICAgICAgICAgICAgICAgIGNvbWJpbmVkX2ZhY3RzID0ge30KICAgICAgICAgICAgICAgIGZvciBmYWN0cyBpbiBpbnRlcmZhY2VzW2lmYWNlXVt2XToKICAgICAgICAgICAgICAgICAgICBjb21iaW5lZF9mYWN0cy51cGRhdGUoZmFjdHMpCiAgICAgICAgICAgICAgICBpZiBsZW4oY29tYmluZWRfZmFjdHMua2V5cygpKSA+IDA6CiAgICAgICAgICAgICAgICAgICAgaW50ZXJmYWNlc1tpZmFjZV1bdl0gPSBbY29tYmluZWRfZmFjdHNdCgogICAgICAgIHJldHVybiBpbnRlcmZhY2VzLCBpcHMKCiAgICBkZWYgcGFyc2VfaW50ZXJmYWNlX2xpbmUoc2VsZiwgd29yZHMsIGN1cnJlbnRfaWYsIGludGVyZmFjZXMpOgogICAgICAgIGRldmljZSA9IHdvcmRzWzBdWzA6LTFdCiAgICAgICAgaWYgZGV2aWNlIG5vdCBpbiBpbnRlcmZhY2VzOgogICAgICAgICAgICBjdXJyZW50X2lmID0geydkZXZpY2UnOiBkZXZpY2UsICdpcHY0JzogW10sICdpcHY2JzogW10sICd0eXBlJzogJ3Vua25vd24nfQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGN1cnJlbnRfaWYgPSBpbnRlcmZhY2VzW2RldmljZV0KICAgICAgICBmbGFncyA9IHNlbGYuZ2V0X29wdGlvbnMod29yZHNbMV0pCiAgICAgICAgdiA9ICdpcHY0JwogICAgICAgIGlmICdJUHY2JyBpbiBmbGFnczoKICAgICAgICAgICAgdiA9ICdpcHY2JwogICAgICAgIGlmICdMT09QQkFDSycgaW4gZmxhZ3M6CiAgICAgICAgICAgIGN1cnJlbnRfaWZbJ3R5cGUnXSA9ICdsb29wYmFjaycKICAgICAgICBjdXJyZW50X2lmW3ZdLmFwcGVuZCh7J2ZsYWdzJzogZmxhZ3MsICdtdHUnOiB3b3Jkc1szXX0pCiAgICAgICAgY3VycmVudF9pZlsnbWFjYWRkcmVzcyddID0gJ3Vua25vd24nICAgICMgd2lsbCBiZSBvdmVyd3JpdHRlbiBsYXRlcgogICAgICAgIHJldHVybiBjdXJyZW50X2lmCgogICAgIyBTb2xhcmlzIGRpc3BsYXlzIHNpbmdsZSBkaWdpdCBvY3RldHMgaW4gTUFDIGFkZHJlc3NlcyBlLmcuIDA6MToyOmQ6ZTpmCiAgICAjIEFkZCBsZWFkaW5nIHplcm8gdG8gZWFjaCBvY3RldCB3aGVyZSBuZWVkZWQuCiAgICBkZWYgcGFyc2VfZXRoZXJfbGluZShzZWxmLCB3b3JkcywgY3VycmVudF9pZiwgaXBzKToKICAgICAgICBtYWNhZGRyZXNzID0gJycKICAgICAgICBmb3Igb2N0ZXQgaW4gd29yZHNbMV0uc3BsaXQoJzonKToKICAgICAgICAgICAgb2N0ZXQgPSAoJzAnICsgb2N0ZXQpWy0yOk5vbmVdCiAgICAgICAgICAgIG1hY2FkZHJlc3MgKz0gKG9jdGV0ICsgJzonKQogICAgICAgIGN1cnJlbnRfaWZbJ21hY2FkZHJlc3MnXSA9IG1hY2FkZHJlc3NbMDotMV0KCgpjbGFzcyBTdW5PU05ldHdvcmtDb2xsZWN0b3IoTmV0d29ya0NvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IFN1bk9TTmV0d29yawogICAgX3BsYXRmb3JtID0gJ1N1bk9TJwpQSwMEFAAAAAAAy7srS4uqs2cfBQAAHwUAAC0AAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9zeXN0ZW0vYXBwYXJtb3IucHkjIENvbGxlY3QgZmFjdHMgcmVsYXRlZCB0byBhcHBhcm1vcgojCiMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgppbXBvcnQgb3MKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuY29sbGVjdG9yIGltcG9ydCBCYXNlRmFjdENvbGxlY3RvcgoKCmNsYXNzIEFwcGFybW9yRmFjdENvbGxlY3RvcihCYXNlRmFjdENvbGxlY3Rvcik6CiAgICBuYW1lID0gJ2FwcGFybW9yJwogICAgX2ZhY3RfaWRzID0gc2V0KCkKCiAgICBkZWYgY29sbGVjdChzZWxmLCBtb2R1bGU9Tm9uZSwgY29sbGVjdGVkX2ZhY3RzPU5vbmUpOgogICAgICAgIGZhY3RzX2RpY3QgPSB7fQogICAgICAgIGFwcGFybW9yX2ZhY3RzID0ge30KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cygnL3N5cy9rZXJuZWwvc2VjdXJpdHkvYXBwYXJtb3InKToKICAgICAgICAgICAgYXBwYXJtb3JfZmFjdHNbJ3N0YXR1cyddID0gJ2VuYWJsZWQnCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYXBwYXJtb3JfZmFjdHNbJ3N0YXR1cyddID0gJ2Rpc2FibGVkJwoKICAgICAgICBmYWN0c19kaWN0WydhcHBhcm1vciddID0gYXBwYXJtb3JfZmFjdHMKICAgICAgICByZXR1cm4gZmFjdHNfZGljdApQSwMEFAAAAAAAy7srS3t1eks5GQAAORkAAC4AAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9oYXJkd2FyZS9vcGVuYnNkLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCByZQoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5fdGV4dCBpbXBvcnQgdG9fdGV4dAoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5oYXJkd2FyZS5iYXNlIGltcG9ydCBIYXJkd2FyZSwgSGFyZHdhcmVDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cyBpbXBvcnQgdGltZW91dAoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy51dGlscyBpbXBvcnQgZ2V0X2ZpbGVfY29udGVudCwgZ2V0X21vdW50X3NpemUKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5zeXNjdGwgaW1wb3J0IGdldF9zeXNjdGwKCgpjbGFzcyBPcGVuQlNESGFyZHdhcmUoSGFyZHdhcmUpOgogICAgIiIiCiAgICBPcGVuQlNELXNwZWNpZmljIHN1YmNsYXNzIG9mIEhhcmR3YXJlLiBEZWZpbmVzIG1lbW9yeSwgQ1BVIGFuZCBkZXZpY2UgZmFjdHM6CiAgICAtIG1lbWZyZWVfbWIKICAgIC0gbWVtdG90YWxfbWIKICAgIC0gc3dhcGZyZWVfbWIKICAgIC0gc3dhcHRvdGFsX21iCiAgICAtIHByb2Nlc3NvciAoYSBsaXN0KQogICAgLSBwcm9jZXNzb3JfY29yZXMKICAgIC0gcHJvY2Vzc29yX2NvdW50CiAgICAtIHByb2Nlc3Nvcl9zcGVlZAoKICAgIEluIGFkZGl0aW9uLCBpdCBhbHNvIGRlZmluZXMgbnVtYmVyIG9mIERNSSBmYWN0cyBhbmQgZGV2aWNlIGZhY3RzLgogICAgIiIiCiAgICBwbGF0Zm9ybSA9ICdPcGVuQlNEJwoKICAgIGRlZiBwb3B1bGF0ZShzZWxmLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgaGFyZHdhcmVfZmFjdHMgPSB7fQogICAgICAgIHNlbGYuc3lzY3RsID0gZ2V0X3N5c2N0bChzZWxmLm1vZHVsZSwgWydodyddKQoKICAgICAgICAjIFRPRE86IGNoYW5nZSBuYW1lCiAgICAgICAgY3B1X2ZhY3RzID0gc2VsZi5nZXRfcHJvY2Vzc29yX2ZhY3RzKCkKICAgICAgICBtZW1vcnlfZmFjdHMgPSBzZWxmLmdldF9tZW1vcnlfZmFjdHMoKQogICAgICAgIGRldmljZV9mYWN0cyA9IHNlbGYuZ2V0X2RldmljZV9mYWN0cygpCiAgICAgICAgZG1pX2ZhY3RzID0gc2VsZi5nZXRfZG1pX2ZhY3RzKCkKCiAgICAgICAgbW91bnRfZmFjdHMgPSB7fQogICAgICAgIHRyeToKICAgICAgICAgICAgbW91bnRfZmFjdHMgPSBzZWxmLmdldF9tb3VudF9mYWN0cygpCiAgICAgICAgZXhjZXB0IHRpbWVvdXQuVGltZW91dEVycm9yOgogICAgICAgICAgICBwYXNzCgogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShjcHVfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKG1lbW9yeV9mYWN0cykKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUoZG1pX2ZhY3RzKQogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShkZXZpY2VfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKG1vdW50X2ZhY3RzKQoKICAgICAgICByZXR1cm4gaGFyZHdhcmVfZmFjdHMKCiAgICBAdGltZW91dC50aW1lb3V0KCkKICAgIGRlZiBnZXRfbW91bnRfZmFjdHMoc2VsZik6CiAgICAgICAgbW91bnRfZmFjdHMgPSB7fQoKICAgICAgICBtb3VudF9mYWN0c1snbW91bnRzJ10gPSBbXQogICAgICAgIGZzdGFiID0gZ2V0X2ZpbGVfY29udGVudCgnL2V0Yy9mc3RhYicpCiAgICAgICAgaWYgZnN0YWI6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGZzdGFiLnNwbGl0bGluZXMoKToKICAgICAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCgnIycpIG9yIGxpbmUuc3RyaXAoKSA9PSAnJzoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZmllbGRzID0gcmUuc3ViKHInXHMrJywgJyAnLCBsaW5lKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBmaWVsZHNbMV0gPT0gJ25vbmUnIG9yIGZpZWxkc1szXSA9PSAneHgnOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBzaXplX3RvdGFsLCBzaXplX2F2YWlsYWJsZSA9IGdldF9tb3VudF9zaXplKGZpZWxkc1sxXSkKICAgICAgICAgICAgICAgIG1vdW50X2ZhY3RzWydtb3VudHMnXS5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICdtb3VudCc6IGZpZWxkc1sxXSwKICAgICAgICAgICAgICAgICAgICAnZGV2aWNlJzogZmllbGRzWzBdLAogICAgICAgICAgICAgICAgICAgICdmc3R5cGUnOiBmaWVsZHNbMl0sCiAgICAgICAgICAgICAgICAgICAgJ29wdGlvbnMnOiBmaWVsZHNbM10sCiAgICAgICAgICAgICAgICAgICAgJ3NpemVfdG90YWwnOiBzaXplX3RvdGFsLAogICAgICAgICAgICAgICAgICAgICdzaXplX2F2YWlsYWJsZSc6IHNpemVfYXZhaWxhYmxlCiAgICAgICAgICAgICAgICB9KQogICAgICAgIHJldHVybiBtb3VudF9mYWN0cwoKICAgIGRlZiBnZXRfbWVtb3J5X2ZhY3RzKHNlbGYpOgogICAgICAgIG1lbW9yeV9mYWN0cyA9IHt9CiAgICAgICAgIyBHZXQgZnJlZSBtZW1vcnkuIHZtc3RhdCBvdXRwdXQgbG9va3MgbGlrZToKICAgICAgICAjICBwcm9jcyAgICBtZW1vcnkgICAgICAgcGFnZSAgICAgICAgICAgICAgICAgICAgZGlza3MgICAgdHJhcHMgICAgICAgICAgY3B1CiAgICAgICAgIyAgciBiIHcgICAgYXZtICAgICBmcmUgIGZsdCAgcmUgIHBpICBwbyAgZnIgIHNyIHdkMCBmZDAgIGludCAgIHN5cyAgIGNzIHVzIHN5IGlkCiAgICAgICAgIyAgMCAwIDAgIDQ3NTEyICAgMjgxNjAgICA1MSAgIDAgICAwICAgMCAgIDAgICAwICAgMSAgIDAgIDExNiAgICA4OSAgIDE3ICAwICAxIDk5CiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3IvYmluL3Ztc3RhdCIpCiAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgbWVtb3J5X2ZhY3RzWydtZW1mcmVlX21iJ10gPSBpbnQob3V0LnNwbGl0bGluZXMoKVstMV0uc3BsaXQoKVs0XSkgLy8gMTAyNAogICAgICAgICAgICBtZW1vcnlfZmFjdHNbJ21lbXRvdGFsX21iJ10gPSBpbnQoc2VsZi5zeXNjdGxbJ2h3LnVzZXJtZW0nXSkgLy8gMTAyNCAvLyAxMDI0CgogICAgICAgICMgR2V0IHN3YXBjdGwgaW5mby4gc3dhcGN0bCBvdXRwdXQgbG9va3MgbGlrZToKICAgICAgICAjIHRvdGFsOiA2OTI2OCAxSy1ibG9ja3MgYWxsb2NhdGVkLCAwIHVzZWQsIDY5MjY4IGF2YWlsYWJsZQogICAgICAgICMgQW5kIGZvciBvbGRlciBPcGVuQlNEOgogICAgICAgICMgdG90YWw6IDY5MjY4ayBieXRlcyBhbGxvY2F0ZWQgPSAwayB1c2VkLCA2OTI2OGsgYXZhaWxhYmxlCiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi9zYmluL3N3YXBjdGwgLXNrIikKICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICBzd2FwdHJhbnMgPSB7b3JkKHUnaycpOiBOb25lLAogICAgICAgICAgICAgICAgICAgICAgICAgb3JkKHUnbScpOiBOb25lLAogICAgICAgICAgICAgICAgICAgICAgICAgb3JkKHUnZycpOiBOb25lfQogICAgICAgICAgICBkYXRhID0gdG9fdGV4dChvdXQsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpLnNwbGl0KCkKICAgICAgICAgICAgbWVtb3J5X2ZhY3RzWydzd2FwZnJlZV9tYiddID0gaW50KGRhdGFbLTJdLnRyYW5zbGF0ZShzd2FwdHJhbnMpKSAvLyAxMDI0CiAgICAgICAgICAgIG1lbW9yeV9mYWN0c1snc3dhcHRvdGFsX21iJ10gPSBpbnQoZGF0YVsxXS50cmFuc2xhdGUoc3dhcHRyYW5zKSkgLy8gMTAyNAoKICAgICAgICByZXR1cm4gbWVtb3J5X2ZhY3RzCgogICAgZGVmIGdldF9wcm9jZXNzb3JfZmFjdHMoc2VsZik6CiAgICAgICAgY3B1X2ZhY3RzID0ge30KICAgICAgICBwcm9jZXNzb3IgPSBbXQogICAgICAgIGZvciBpIGluIHJhbmdlKGludChzZWxmLnN5c2N0bFsnaHcubmNwdSddKSk6CiAgICAgICAgICAgIHByb2Nlc3Nvci5hcHBlbmQoc2VsZi5zeXNjdGxbJ2h3Lm1vZGVsJ10pCgogICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yJ10gPSBwcm9jZXNzb3IKICAgICAgICAjIFRoZSBmb2xsb3dpbmcgaXMgcGFydGx5IGEgbGllIGJlY2F1c2UgdGhlcmUgaXMgbm8gcmVsaWFibGUgd2F5IHRvCiAgICAgICAgIyBkZXRlcm1pbmUgdGhlIG51bWJlciBvZiBwaHlzaWNhbCBDUFVzIGluIHRoZSBzeXN0ZW0uIFdlIGNhbiBvbmx5CiAgICAgICAgIyBxdWVyeSB0aGUgbnVtYmVyIG9mIGxvZ2ljYWwgQ1BVcywgd2hpY2ggaGlkZXMgdGhlIG51bWJlciBvZiBjb3Jlcy4KICAgICAgICAjIE9uIGFtZDY0L2kzODYgd2UgY291bGQgdHJ5IHRvIGluc3BlY3QgdGhlIHNtdC9jb3JlL3BhY2thZ2UgbGluZXMgaW4KICAgICAgICAjIGRtZXNnLCBob3dldmVyIGV2ZW4gdGhvc2UgaGF2ZSBwcm92ZW4gdG8gYmUgdW5yZWxpYWJsZS4KICAgICAgICAjIFNvIHRha2UgYSBzaG9ydGN1dCBhbmQgcmVwb3J0IHRoZSBsb2dpY2FsIG51bWJlciBvZiBwcm9jZXNzb3JzIGluCiAgICAgICAgIyAncHJvY2Vzc29yX2NvdW50JyBhbmQgJ3Byb2Nlc3Nvcl9jb3JlcycgYW5kIGxlYXZlIGl0IGF0IHRoYXQuCiAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY291bnQnXSA9IHNlbGYuc3lzY3RsWydody5uY3B1J10KICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3JlcyddID0gc2VsZi5zeXNjdGxbJ2h3Lm5jcHUnXQoKICAgICAgICByZXR1cm4gY3B1X2ZhY3RzCgogICAgZGVmIGdldF9kZXZpY2VfZmFjdHMoc2VsZik6CiAgICAgICAgZGV2aWNlX2ZhY3RzID0ge30KICAgICAgICBkZXZpY2VzID0gW10KICAgICAgICBkZXZpY2VzLmV4dGVuZChzZWxmLnN5c2N0bFsnaHcuZGlza25hbWVzJ10uc3BsaXQoJywnKSkKICAgICAgICBkZXZpY2VfZmFjdHNbJ2RldmljZXMnXSA9IGRldmljZXMKCiAgICAgICAgcmV0dXJuIGRldmljZV9mYWN0cwoKICAgIGRlZiBnZXRfZG1pX2ZhY3RzKHNlbGYpOgogICAgICAgIGRtaV9mYWN0cyA9IHt9CiAgICAgICAgIyBXZSBkb24ndCB1c2UgZG1pZGVjb2RlKDEpIGhlcmUgYmVjYXVzZToKICAgICAgICAjIC0gaXQgd291bGQgYWRkIGRlcGVuZGVuY3kgb24gYW4gZXh0ZXJuYWwgcGFja2FnZQogICAgICAgICMgLSBkbWlkZWNvZGUoMSkgY2FuIG9ubHkgYmUgcmFuIGFzIHJvb3QKICAgICAgICAjIFNvIGluc3RlYWQgd2UgcmVseSBvbiBzeXNjdGwoOCkgdG8gcHJvdmlkZSB1cyB0aGUgaW5mb3JtYXRpb24gb24gYQogICAgICAgICMgYmVzdC1lZmZvcnQgYmFzaXMuIEFzIGEgYm9udXMgd2UgYWxzbyBnZXQgZmFjdHMgb24gbm9uLWFtZDY0L2kzODYKICAgICAgICAjIHBsYXRmb3JtcyB0aGlzIHdheS4KICAgICAgICBzeXNjdGxfdG9fZG1pID0gewogICAgICAgICAgICAnaHcucHJvZHVjdCc6ICdwcm9kdWN0X25hbWUnLAogICAgICAgICAgICAnaHcudmVyc2lvbic6ICdwcm9kdWN0X3ZlcnNpb24nLAogICAgICAgICAgICAnaHcudXVpZCc6ICdwcm9kdWN0X3V1aWQnLAogICAgICAgICAgICAnaHcuc2VyaWFsbm8nOiAncHJvZHVjdF9zZXJpYWwnLAogICAgICAgICAgICAnaHcudmVuZG9yJzogJ3N5c3RlbV92ZW5kb3InLAogICAgICAgIH0KCiAgICAgICAgZm9yIG1pYiBpbiBzeXNjdGxfdG9fZG1pOgogICAgICAgICAgICBpZiBtaWIgaW4gc2VsZi5zeXNjdGw6CiAgICAgICAgICAgICAgICBkbWlfZmFjdHNbc3lzY3RsX3RvX2RtaVttaWJdXSA9IHNlbGYuc3lzY3RsW21pYl0KCiAgICAgICAgcmV0dXJuIGRtaV9mYWN0cwoKCmNsYXNzIE9wZW5CU0RIYXJkd2FyZUNvbGxlY3RvcihIYXJkd2FyZUNvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IE9wZW5CU0RIYXJkd2FyZQogICAgX3BsYXRmb3JtID0gJ09wZW5CU0QnClBLAwQUAAAAAADLuytLYlwB7kIMAABCDAAAKgAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9sb2NhbC5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgppbXBvcnQgZ2xvYgppbXBvcnQganNvbgppbXBvcnQgb3MKaW1wb3J0IHN0YXQKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Lm1vdmVzIGltcG9ydCBjb25maWdwYXJzZXIKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXgubW92ZXMgaW1wb3J0IFN0cmluZ0lPCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnV0aWxzIGltcG9ydCBnZXRfZmlsZV9jb250ZW50Cgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmNvbGxlY3RvciBpbXBvcnQgQmFzZUZhY3RDb2xsZWN0b3IKCgpjbGFzcyBMb2NhbEZhY3RDb2xsZWN0b3IoQmFzZUZhY3RDb2xsZWN0b3IpOgogICAgbmFtZSA9ICdsb2NhbCcKICAgIF9mYWN0X2lkcyA9IHNldCgpCgogICAgZGVmIGNvbGxlY3Qoc2VsZiwgbW9kdWxlPU5vbmUsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBsb2NhbF9mYWN0cyA9IHt9CiAgICAgICAgbG9jYWxfZmFjdHNbJ2xvY2FsJ10gPSB7fQoKICAgICAgICBpZiBub3QgbW9kdWxlOgogICAgICAgICAgICByZXR1cm4gbG9jYWxfZmFjdHMKCiAgICAgICAgZmFjdF9wYXRoID0gbW9kdWxlLnBhcmFtcy5nZXQoJ2ZhY3RfcGF0aCcsIE5vbmUpCgogICAgICAgIGlmIG5vdCBmYWN0X3BhdGggb3Igbm90IG9zLnBhdGguZXhpc3RzKGZhY3RfcGF0aCk6CiAgICAgICAgICAgIHJldHVybiBsb2NhbF9mYWN0cwoKICAgICAgICBsb2NhbCA9IHt9CiAgICAgICAgZm9yIGZuIGluIHNvcnRlZChnbG9iLmdsb2IoZmFjdF9wYXRoICsgJy8qLmZhY3QnKSk6CiAgICAgICAgICAgICMgd2hlcmUgaXQgd2lsbCBzaXQgdW5kZXIgbG9jYWwgZmFjdHMKICAgICAgICAgICAgZmFjdF9iYXNlID0gb3MucGF0aC5iYXNlbmFtZShmbikucmVwbGFjZSgnLmZhY3QnLCAnJykKICAgICAgICAgICAgaWYgc3RhdC5TX0lYVVNSICYgb3Muc3RhdChmbilbc3RhdC5TVF9NT0RFXToKICAgICAgICAgICAgICAgICMgcnVuIGl0CiAgICAgICAgICAgICAgICAjIHRyeSB0byByZWFkIGl0IGFzIGpzb24gZmlyc3QKICAgICAgICAgICAgICAgICMgaWYgdGhhdCBmYWlscyByZWFkIGl0IHdpdGggQ29uZmlnUGFyc2VyCiAgICAgICAgICAgICAgICAjIGlmIHRoYXQgZmFpbHMsIHNraXAgaXQKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBtb2R1bGUucnVuX2NvbW1hbmQoZm4pCiAgICAgICAgICAgICAgICBleGNlcHQgVW5pY29kZUVycm9yOgogICAgICAgICAgICAgICAgICAgIGZhY3QgPSAnZXJyb3IgbG9hZGluZyBmYWN0IC0gb3V0cHV0IG9mIHJ1bm5pbmcgJXMgd2FzIG5vdCB1dGYtOCcgJSBmbgogICAgICAgICAgICAgICAgICAgIGxvY2FsW2ZhY3RfYmFzZV0gPSBmYWN0CiAgICAgICAgICAgICAgICAgICAgbG9jYWxfZmFjdHNbJ2xvY2FsJ10gPSBsb2NhbAogICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbF9mYWN0cwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb3V0ID0gZ2V0X2ZpbGVfY29udGVudChmbiwgZGVmYXVsdD0nJykKCiAgICAgICAgICAgICMgbG9hZCByYXcganNvbgogICAgICAgICAgICBmYWN0ID0gJ2xvYWRpbmcgJXMnICUgZmFjdF9iYXNlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZhY3QgPSBqc29uLmxvYWRzKG91dCkKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAjIGxvYWQgcmF3IGluaQogICAgICAgICAgICAgICAgY3AgPSBjb25maWdwYXJzZXIuQ29uZmlnUGFyc2VyKCkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBjcC5yZWFkZnAoU3RyaW5nSU8ob3V0KSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBjb25maWdwYXJzZXIuRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgZmFjdCA9ICJlcnJvciBsb2FkaW5nIGZhY3QgLSBwbGVhc2UgY2hlY2sgY29udGVudCIKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZmFjdCA9IHt9CiAgICAgICAgICAgICAgICAgICAgZm9yIHNlY3QgaW4gY3Auc2VjdGlvbnMoKToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VjdCBub3QgaW4gZmFjdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY3Rbc2VjdF0gPSB7fQogICAgICAgICAgICAgICAgICAgICAgICBmb3Igb3B0IGluIGNwLm9wdGlvbnMoc2VjdCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBjcC5nZXQoc2VjdCwgb3B0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFjdFtzZWN0XVtvcHRdID0gdmFsCgogICAgICAgICAgICBsb2NhbFtmYWN0X2Jhc2VdID0gZmFjdAoKICAgICAgICBsb2NhbF9mYWN0c1snbG9jYWwnXSA9IGxvY2FsCiAgICAgICAgcmV0dXJuIGxvY2FsX2ZhY3RzClBLAwQUAAAAAADLuytLNAfcKgMJAAADCQAAKAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL290aGVyL29oYWkucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKaW1wb3J0IGpzb24KCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmFtZXNwYWNlIGltcG9ydCBQcmVmaXhGYWN0TmFtZXNwYWNlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmNvbGxlY3RvciBpbXBvcnQgQmFzZUZhY3RDb2xsZWN0b3IKCgpjbGFzcyBPaGFpRmFjdENvbGxlY3RvcihCYXNlRmFjdENvbGxlY3Rvcik6CiAgICAnJydUaGlzIGlzIGEgc3ViY2xhc3Mgb2YgRmFjdHMgZm9yIGluY2x1ZGluZyBpbmZvcm1hdGlvbiBnYXRoZXJlZCBmcm9tIE9oYWkuJycnCiAgICBuYW1lID0gJ29oYWknCiAgICBfZmFjdF9pZHMgPSBzZXQoKQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb2xsZWN0b3JzPU5vbmUsIG5hbWVzcGFjZT1Ob25lKToKICAgICAgICBuYW1lc3BhY2UgPSBQcmVmaXhGYWN0TmFtZXNwYWNlKG5hbWVzcGFjZV9uYW1lPSdvaGFpJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeD0nb2hhaV8nKQogICAgICAgIHN1cGVyKE9oYWlGYWN0Q29sbGVjdG9yLCBzZWxmKS5fX2luaXRfXyhjb2xsZWN0b3JzPWNvbGxlY3RvcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZT1uYW1lc3BhY2UpCgogICAgZGVmIGZpbmRfb2hhaShzZWxmLCBtb2R1bGUpOgogICAgICAgIG9oYWlfcGF0aCA9IG1vZHVsZS5nZXRfYmluX3BhdGgoJ29oYWknKQogICAgICAgIHJldHVybiBvaGFpX3BhdGgKCiAgICBkZWYgcnVuX29oYWkoc2VsZiwgbW9kdWxlLCBvaGFpX3BhdGgsKToKICAgICAgICByYywgb3V0LCBlcnIgPSBtb2R1bGUucnVuX2NvbW1hbmQob2hhaV9wYXRoKQogICAgICAgIHJldHVybiByYywgb3V0LCBlcnIKCiAgICBkZWYgZ2V0X29oYWlfb3V0cHV0KHNlbGYsIG1vZHVsZSk6CiAgICAgICAgb2hhaV9wYXRoID0gc2VsZi5maW5kX29oYWkobW9kdWxlKQogICAgICAgIGlmIG5vdCBvaGFpX3BhdGg6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYucnVuX29oYWkobW9kdWxlLCBvaGFpX3BhdGgpCiAgICAgICAgaWYgcmMgIT0gMDoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgcmV0dXJuIG91dAoKICAgIGRlZiBjb2xsZWN0KHNlbGYsIG1vZHVsZT1Ob25lLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgb2hhaV9mYWN0cyA9IHt9CiAgICAgICAgaWYgbm90IG1vZHVsZToKICAgICAgICAgICAgcmV0dXJuIG9oYWlfZmFjdHMKCiAgICAgICAgb2hhaV9vdXRwdXQgPSBzZWxmLmdldF9vaGFpX291dHB1dChtb2R1bGUpCgogICAgICAgIGlmIG9oYWlfb3V0cHV0IGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBvaGFpX2ZhY3RzCgogICAgICAgIHRyeToKICAgICAgICAgICAgb2hhaV9mYWN0cyA9IGpzb24ubG9hZHMob2hhaV9vdXRwdXQpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgIyBGSVhNRTogdXNlZnVsIGVycm9yLCBsb2dnaW5nLCBzb21ldGhpbmcuLi4KICAgICAgICAgICAgcGFzcwoKICAgICAgICByZXR1cm4gb2hhaV9mYWN0cwpQSwMEFAAAAAAAy7srSwAAAAAAAAAAAAAAACwAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9vdGhlci9fX2luaXRfXy5weVBLAwQUAAAAAADLuytLPA6rCC4XAAAuFwAAMAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9zZXJ2aWNlX21nci5weSMgQ29sbGVjdCBmYWN0cyByZWxhdGVkIHRvIHN5c3RlbSBzZXJ2aWNlIG1hbmFnZXIgYW5kIGluaXQuCiMKIyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCBvcwppbXBvcnQgcGxhdGZvcm0KaW1wb3J0IHJlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLl90ZXh0IGltcG9ydCB0b19uYXRpdmUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMudXRpbHMgaW1wb3J0IGdldF9maWxlX2NvbnRlbnQKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5jb2xsZWN0b3IgaW1wb3J0IEJhc2VGYWN0Q29sbGVjdG9yCgojIFRoZSBkaXN0dXRpbHMgbW9kdWxlIGlzIG5vdCBzaGlwcGVkIHdpdGggU1VOV1B5dGhvbiBvbiBTb2xhcmlzLgojIEl0J3MgaW4gdGhlIFNVTldQeXRob24tZGV2ZWwgcGFja2FnZSB3aGljaCBhbHNvIGNvbnRhaW5zIGRldmVsb3BtZW50IGZpbGVzCiMgdGhhdCBkb24ndCBiZWxvbmcgb24gcHJvZHVjdGlvbiBib3hlcy4gIFNpbmNlIG91ciBTb2xhcmlzIGNvZGUgZG9lc24ndAojIGRlcGVuZCBvbiBMb29zZVZlcnNpb24sIGRvIG5vdCBpbXBvcnQgaXQgb24gU29sYXJpcy4KaWYgcGxhdGZvcm0uc3lzdGVtKCkgIT0gJ1N1bk9TJzoKICAgIGZyb20gZGlzdHV0aWxzLnZlcnNpb24gaW1wb3J0IExvb3NlVmVyc2lvbgoKCmNsYXNzIFNlcnZpY2VNZ3JGYWN0Q29sbGVjdG9yKEJhc2VGYWN0Q29sbGVjdG9yKToKICAgIG5hbWUgPSAnc2VydmljZV9tZ3InCiAgICBfZmFjdF9pZHMgPSBzZXQoKQoKICAgIGRlZiBpc19zeXN0ZW1kX21hbmFnZWQoc2VsZiwgbW9kdWxlKToKICAgICAgICAjIHRvb2xzIG11c3QgYmUgaW5zdGFsbGVkCiAgICAgICAgaWYgbW9kdWxlLmdldF9iaW5fcGF0aCgnc3lzdGVtY3RsJyk6CgogICAgICAgICAgICAjIHRoaXMgc2hvdWxkIHNob3cgaWYgc3lzdGVtZCBpcyB0aGUgYm9vdCBpbml0IHN5c3RlbSwgaWYgY2hlY2tpbmcgaW5pdCBmYWlsZCB0byBtYXJrIGFzIHN5c3RlbWQKICAgICAgICAgICAgIyB0aGVzZSBtaXJyb3Igc3lzdGVtZCdzIG93biBzZF9ib290IHRlc3QgaHR0cDovL3d3dy5mcmVlZGVza3RvcC5vcmcvc29mdHdhcmUvc3lzdGVtZC9tYW4vc2RfYm9vdGVkLmh0bWwKICAgICAgICAgICAgZm9yIGNhbmFyeSBpbiBbIi9ydW4vc3lzdGVtZC9zeXN0ZW0vIiwgIi9kZXYvLnJ1bi9zeXN0ZW1kLyIsICIvZGV2Ly5zeXN0ZW1kLyJdOgogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoY2FuYXJ5KToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBjb2xsZWN0KHNlbGYsIG1vZHVsZT1Ob25lLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgZmFjdHNfZGljdCA9IHt9CgogICAgICAgIGlmIG5vdCBtb2R1bGU6CiAgICAgICAgICAgIHJldHVybiBmYWN0c19kaWN0CgogICAgICAgIGNvbGxlY3RlZF9mYWN0cyA9IGNvbGxlY3RlZF9mYWN0cyBvciB7fQogICAgICAgIHNlcnZpY2VfbWdyX25hbWUgPSBOb25lCgogICAgICAgICMgVE9ETzogZGV0ZWN0IG1vcmUgY3VzdG9tIGluaXQgc2V0dXBzIGxpa2UgYm9vdHNjcmlwdHMsIGRtZCwgczYsIEVwb2NoLCBldGMKICAgICAgICAjIGFsc28gb3RoZXIgT1NzIG90aGVyIHRoYW4gbGludXggbWlnaHQgbmVlZCB0byBjaGVjayBhY3Jvc3Mgc2V2ZXJhbCBwb3NzaWJsZSBjYW5kaWRhdGVzCgogICAgICAgICMgTWFwcGluZyBvZiBwcm9jXzEgdmFsdWVzIHRvIG1vcmUgdXNlZnVsIG5hbWVzCiAgICAgICAgcHJvY18xX21hcCA9IHsKICAgICAgICAgICAgJ3Byb2NkJzogJ29wZW53cnRfaW5pdCcsCiAgICAgICAgICAgICdydW5pdC1pbml0JzogJ3J1bml0JywKICAgICAgICAgICAgJ3N2c2Nhbic6ICdzdmMnLAogICAgICAgICAgICAnb3BlbnJjLWluaXQnOiAnb3BlbnJjJywKICAgICAgICB9CgogICAgICAgICMgdHJ5IHZhcmlvdXMgZm9ybXMgb2YgcXVlcnlpbmcgcGlkIDEKICAgICAgICBwcm9jXzEgPSBnZXRfZmlsZV9jb250ZW50KCcvcHJvYy8xL2NvbW0nKQogICAgICAgIGlmIHByb2NfMSBpcyBOb25lOgogICAgICAgICAgICAjIEZJWE1FOiByZXR1cm4gY29kZSBpc250IGNoZWNrZWQKICAgICAgICAgICAgIyBGSVhNRTogaWYgc3Rkb3V0IGlzIGVtcHR5IHN0cmluZywgb2RkIHRoaW5ncwogICAgICAgICAgICAjIEZJWE1FOiBvdGhlciBjb2RlIHNlZW1zIHRvIHRoaW5rIHdlIGNvdWxkIGdldCBwcm9jXzEgPT0gTm9uZSBwYXN0IHRoaXMgcG9pbnQKICAgICAgICAgICAgcmMsIHByb2NfMSwgZXJyID0gbW9kdWxlLnJ1bl9jb21tYW5kKCJwcyAtcCAxIC1vIGNvbW18dGFpbCAtbiAxIiwgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlKQogICAgICAgICAgICAjIElmIHRoZSBvdXRwdXQgb2YgdGhlIGNvbW1hbmQgc3RhcnRzIHdpdGggd2hhdCBsb29rcyBsaWtlIGEgUElELCB0aGVuIHRoZSAncHMnIGNvbW1hbmQKICAgICAgICAgICAgIyBwcm9iYWJseSBkaWRuJ3Qgd29yayB0aGUgd2F5IHdlIHdhbnRlZCwgcHJvYmFibHkgYmVjYXVzZSBpdCdzIGJ1c3lib3gKICAgICAgICAgICAgaWYgcmUubWF0Y2gocicgKlswLTldKyAnLCBwcm9jXzEpOgogICAgICAgICAgICAgICAgcHJvY18xID0gTm9uZQoKICAgICAgICAjIFRoZSBwcyBjb21tYW5kIGFib3ZlIG1heSByZXR1cm4gIkNPTU1BTkQiIGlmIHRoZSB1c2VyIGNhbm5vdCByZWFkIC9wcm9jLCBlLmcuIHdpdGggZ3JzZWN1cml0eQogICAgICAgIGlmIHByb2NfMSA9PSAiQ09NTUFORFxuIjoKICAgICAgICAgICAgcHJvY18xID0gTm9uZQoKICAgICAgICAjIEZJWE1FOiBlbXB0eSBzdHJpbmcgcHJvY18xIHN0YXVzIGVtcHR5IHN0cmluZwogICAgICAgIGlmIHByb2NfMSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJvY18xID0gb3MucGF0aC5iYXNlbmFtZShwcm9jXzEpCiAgICAgICAgICAgIHByb2NfMSA9IHRvX25hdGl2ZShwcm9jXzEpCiAgICAgICAgICAgIHByb2NfMSA9IHByb2NfMS5zdHJpcCgpCgogICAgICAgIGlmIHByb2NfMSBpcyBub3QgTm9uZSBhbmQgKHByb2NfMSA9PSAnaW5pdCcgb3IgcHJvY18xLmVuZHN3aXRoKCdzaCcpKToKICAgICAgICAgICAgIyBtYW55IHN5c3RlbXMgcmV0dXJuIGluaXQsIHNvIHRoaXMgY2Fubm90IGJlIHRydXN0ZWQsIGlmIGl0IGVuZHMgaW4gJ3NoJyBpdCBwcm9iYWxieSBpcyBhIHNoZWxsIGluIGEgY29udGFpbmVyCiAgICAgICAgICAgIHByb2NfMSA9IE5vbmUKCiAgICAgICAgIyBpZiBub3QgaW5pdC9Ob25lIGl0IHNob3VsZCBiZSBhbiBpZGVudGlmaWFibGUgb3IgY3VzdG9tIGluaXQsIHNvIHdlIGFyZSBkb25lIQogICAgICAgIGlmIHByb2NfMSBpcyBub3QgTm9uZToKICAgICAgICAgICAgIyBMb29rdXAgcHJvY18xIHZhbHVlIGluIG1hcCBhbmQgdXNlIHByb2NfMSB2YWx1ZSBpdHNlbGYgaWYgbm8gbWF0Y2gKICAgICAgICAgICAgIyBGSVhNRTogZW1wdHkgc3RyaW5nIHN0aWxsIGZhbGxzIHRocm91Z2gKICAgICAgICAgICAgc2VydmljZV9tZ3JfbmFtZSA9IHByb2NfMV9tYXAuZ2V0KHByb2NfMSwgcHJvY18xKQoKICAgICAgICAjIEZJWE1FOiByZXBsYWNlIHdpdGggYSBzeXN0ZW0tPnNlcnZpY2VfbWdyX25hbWUgbWFwPwogICAgICAgICMgc3RhcnQgd2l0aCB0aGUgZWFzeSBvbmVzCiAgICAgICAgZWxpZiBjb2xsZWN0ZWRfZmFjdHMuZ2V0KCdkaXN0cmlidXRpb24nLCBOb25lKSA9PSAnTWFjT1NYJzoKICAgICAgICAgICAgIyBGSVhNRTogZmluZCB3YXkgdG8gcXVlcnkgZXhlY3V0YWJsZSwgdmVyc2lvbiBtYXRjaGluZyBpcyBub3QgaWRlYWwKICAgICAgICAgICAgaWYgTG9vc2VWZXJzaW9uKHBsYXRmb3JtLm1hY192ZXIoKVswXSkgPj0gTG9vc2VWZXJzaW9uKCcxMC40Jyk6CiAgICAgICAgICAgICAgICBzZXJ2aWNlX21ncl9uYW1lID0gJ2xhdW5jaGQnCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZXJ2aWNlX21ncl9uYW1lID0gJ3N5c3RlbXN0YXJ0ZXInCiAgICAgICAgZWxpZiAnQlNEJyBpbiBjb2xsZWN0ZWRfZmFjdHMuZ2V0KCdzeXN0ZW0nLCAnJykgb3IgY29sbGVjdGVkX2ZhY3RzLmdldCgnc3lzdGVtJykgaW4gWydCaXRyaWcnLCAnRHJhZ29uRmx5J106CiAgICAgICAgICAgICMgRklYTUU6IHdlIG1pZ2h0IHdhbnQgdG8gYnJlYWsgb3V0IHRvIGluZGl2aWR1YWwgQlNEcyBvciAncmMnCiAgICAgICAgICAgIHNlcnZpY2VfbWdyX25hbWUgPSAnYnNkaW5pdCcKICAgICAgICBlbGlmIGNvbGxlY3RlZF9mYWN0cy5nZXQoJ3N5c3RlbScpID09ICdBSVgnOgogICAgICAgICAgICBzZXJ2aWNlX21ncl9uYW1lID0gJ3NyYycKICAgICAgICBlbGlmIGNvbGxlY3RlZF9mYWN0cy5nZXQoJ3N5c3RlbScpID09ICdTdW5PUyc6CiAgICAgICAgICAgIHNlcnZpY2VfbWdyX25hbWUgPSAnc21mJwogICAgICAgIGVsaWYgY29sbGVjdGVkX2ZhY3RzLmdldCgnZGlzdHJpYnV0aW9uJykgPT0gJ09wZW5XcnQnOgogICAgICAgICAgICBzZXJ2aWNlX21ncl9uYW1lID0gJ29wZW53cnRfaW5pdCcKICAgICAgICBlbGlmIGNvbGxlY3RlZF9mYWN0cy5nZXQoJ3N5c3RlbScpID09ICdMaW51eCc6CiAgICAgICAgICAgICMgRklYTUU6IG12IGlzX3N5c3RlbWRfbWFuYWdlZAogICAgICAgICAgICBpZiBzZWxmLmlzX3N5c3RlbWRfbWFuYWdlZChtb2R1bGU9bW9kdWxlKToKICAgICAgICAgICAgICAgIHNlcnZpY2VfbWdyX25hbWUgPSAnc3lzdGVtZCcKICAgICAgICAgICAgZWxpZiBtb2R1bGUuZ2V0X2Jpbl9wYXRoKCdpbml0Y3RsJykgYW5kIG9zLnBhdGguZXhpc3RzKCIvZXRjL2luaXQvIik6CiAgICAgICAgICAgICAgICBzZXJ2aWNlX21ncl9uYW1lID0gJ3Vwc3RhcnQnCiAgICAgICAgICAgIGVsaWYgb3MucGF0aC5leGlzdHMoJy9zYmluL29wZW5yYycpOgogICAgICAgICAgICAgICAgc2VydmljZV9tZ3JfbmFtZSA9ICdvcGVucmMnCiAgICAgICAgICAgIGVsaWYgb3MucGF0aC5leGlzdHMoJy9ldGMvaW5pdC5kLycpOgogICAgICAgICAgICAgICAgc2VydmljZV9tZ3JfbmFtZSA9ICdzeXN2aW5pdCcKCiAgICAgICAgaWYgbm90IHNlcnZpY2VfbWdyX25hbWU6CiAgICAgICAgICAgICMgaWYgd2UgY2Fubm90IGRldGVjdCwgZmFsbGJhY2sgdG8gZ2VuZXJpYyAnc2VydmljZScKICAgICAgICAgICAgc2VydmljZV9tZ3JfbmFtZSA9ICdzZXJ2aWNlJwoKICAgICAgICBmYWN0c19kaWN0WydzZXJ2aWNlX21nciddID0gc2VydmljZV9tZ3JfbmFtZQogICAgICAgIHJldHVybiBmYWN0c19kaWN0ClBLAwQUAAAAAADLuytLXhXvYkYMAABGDAAAKgAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL25ldHdvcmsvaHVyZC5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgppbXBvcnQgb3MKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5iYXNlIGltcG9ydCBOZXR3b3JrLCBOZXR3b3JrQ29sbGVjdG9yCgoKY2xhc3MgSHVyZFBmaW5ldE5ldHdvcmsoTmV0d29yayk6CiAgICAiIiIKICAgIFRoaXMgaXMgYSBHTlUgSHVyZCBzcGVjaWZpYyBzdWJjbGFzcyBvZiBOZXR3b3JrLiBJdCB1c2UgZnN5c29wdHMgdG8KICAgIGdldCB0aGUgaXAgYWRkcmVzcyBhbmQgc3VwcG9ydCBvbmx5IHBmaW5ldC4KICAgICIiIgogICAgcGxhdGZvcm0gPSAnR05VJwogICAgX3NvY2tldF9kaXIgPSAnL3NlcnZlcnMvc29ja2V0LycKCiAgICBkZWYgcG9wdWxhdGUoc2VsZiwgY29sbGVjdGVkX2ZhY3RzPU5vbmUpOgogICAgICAgIG5ldHdvcmtfZmFjdHMgPSB7fQoKICAgICAgICBmc3lzb3B0c19wYXRoID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCdmc3lzb3B0cycpCiAgICAgICAgaWYgZnN5c29wdHNfcGF0aCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gbmV0d29ya19mYWN0cwoKICAgICAgICBzb2NrZXRfcGF0aCA9IE5vbmUKCiAgICAgICAgZm9yIGwgaW4gKCdpbmV0JywgJ2luZXQ2Jyk6CiAgICAgICAgICAgIGxpbmsgPSBvcy5wYXRoLmpvaW4oc2VsZi5fc29ja2V0X2RpciwgbCkKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMobGluayk6CiAgICAgICAgICAgICAgICBzb2NrZXRfcGF0aCA9IGxpbmsKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICMgRklYTUU6IGV4dHJhY3QgdG8gbWV0aG9kCiAgICAgICAgIyBGSVhNRTogZXhpdCBlYXJseSBvbiBmYWxzZXkgc29ja2V0X3BhdGggYW5kIHVuLWluZGVudCB3aG9sZSBibG9jawoKICAgICAgICBpZiBzb2NrZXRfcGF0aDoKICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoW2ZzeXNvcHRzX3BhdGgsICctTCcsIHNvY2tldF9wYXRoXSkKICAgICAgICAgICAgIyBGSVhNRTogYnVpbGQgdXAgYSBpbnRlcmZhY2VzIGRhdGFzdHJ1Y3R1cmUsIHRoZW4gYXNzaWduIGludG8gbmV0d29ya19mYWN0cwogICAgICAgICAgICBuZXR3b3JrX2ZhY3RzWydpbnRlcmZhY2VzJ10gPSBbXQogICAgICAgICAgICBmb3IgaSBpbiBvdXQuc3BsaXQoKToKICAgICAgICAgICAgICAgIGlmICc9JyBpbiBpIGFuZCBpLnN0YXJ0c3dpdGgoJy0tJyk6CiAgICAgICAgICAgICAgICAgICAgaywgdiA9IGkuc3BsaXQoJz0nLCAxKQogICAgICAgICAgICAgICAgICAgICMgcmVtb3ZlICctLScKICAgICAgICAgICAgICAgICAgICBrID0ga1syOl0KICAgICAgICAgICAgICAgICAgICBpZiBrID09ICdpbnRlcmZhY2UnOgogICAgICAgICAgICAgICAgICAgICAgICAjIHJlbW92ZSAvZGV2LyBmcm9tIC9kZXYvZXRoMAogICAgICAgICAgICAgICAgICAgICAgICB2ID0gdls1Ol0KICAgICAgICAgICAgICAgICAgICAgICAgbmV0d29ya19mYWN0c1snaW50ZXJmYWNlcyddLmFwcGVuZCh2KQogICAgICAgICAgICAgICAgICAgICAgICBuZXR3b3JrX2ZhY3RzW3ZdID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2FjdGl2ZSc6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGV2aWNlJzogdiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpcHY0Jzoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaXB2Nic6IFtdLAogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfaWYgPSB2CiAgICAgICAgICAgICAgICAgICAgZWxpZiBrID09ICdhZGRyZXNzJzoKICAgICAgICAgICAgICAgICAgICAgICAgbmV0d29ya19mYWN0c1tjdXJyZW50X2lmXVsnaXB2NCddWydhZGRyZXNzJ10gPSB2CiAgICAgICAgICAgICAgICAgICAgZWxpZiBrID09ICduZXRtYXNrJzoKICAgICAgICAgICAgICAgICAgICAgICAgbmV0d29ya19mYWN0c1tjdXJyZW50X2lmXVsnaXB2NCddWyduZXRtYXNrJ10gPSB2CiAgICAgICAgICAgICAgICAgICAgZWxpZiBrID09ICdhZGRyZXNzNic6CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MsIHByZWZpeCA9IHYuc3BsaXQoJy8nKQogICAgICAgICAgICAgICAgICAgICAgICBuZXR3b3JrX2ZhY3RzW2N1cnJlbnRfaWZdWydpcHY2J10uYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhZGRyZXNzJzogYWRkcmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwcmVmaXgnOiBwcmVmaXgsCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgIHJldHVybiBuZXR3b3JrX2ZhY3RzCgoKY2xhc3MgSHVyZE5ldHdvcmtDb2xsZWN0b3IoTmV0d29ya0NvbGxlY3Rvcik6CiAgICBfcGxhdGZvcm0gPSAnR05VJwogICAgX2ZhY3RfY2xhc3MgPSBIdXJkUGZpbmV0TmV0d29yawpQSwMEFAAAAAAAy7srSyyRZGq2CQAAtgkAACoAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy92aXJ0dWFsL2hwdXgucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKaW1wb3J0IG9zCmltcG9ydCByZQoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy52aXJ0dWFsLmJhc2UgaW1wb3J0IFZpcnR1YWwsIFZpcnR1YWxDb2xsZWN0b3IKCgpjbGFzcyBIUFVYVmlydHVhbChWaXJ0dWFsKToKICAgICIiIgogICAgVGhpcyBpcyBhIEhQLVVYIHNwZWNpZmljIHN1YmNsYXNzIG9mIFZpcnR1YWwuIEl0IGRlZmluZXMKICAgIC0gdmlydHVhbGl6YXRpb25fdHlwZQogICAgLSB2aXJ0dWFsaXphdGlvbl9yb2xlCiAgICAiIiIKICAgIHBsYXRmb3JtID0gJ0hQLVVYJwoKICAgIGRlZiBnZXRfdmlydHVhbF9mYWN0cyhzZWxmKToKICAgICAgICB2aXJ0dWFsX2ZhY3RzID0ge30KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cygnL3Vzci9zYmluL3ZlY2hlY2snKToKICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3Ivc2Jpbi92ZWNoZWNrIikKICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICdndWVzdCcKICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdIUCB2UGFyJwogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKCcvb3B0L2hwdm0vYmluL2hwdm1pbmZvJyk6CiAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvb3B0L2hwdm0vYmluL2hwdm1pbmZvIikKICAgICAgICAgICAgaWYgcmMgPT0gMCBhbmQgcmUubWF0Y2goJy4qUnVubmluZy4qSFBWTSB2UGFyLionLCBvdXQpOgogICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ2d1ZXN0JwogICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ0hQVk0gdlBhcicKICAgICAgICAgICAgZWxpZiByYyA9PSAwIGFuZCByZS5tYXRjaCgnLipSdW5uaW5nLipIUFZNIGd1ZXN0LionLCBvdXQpOgogICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ2d1ZXN0JwogICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ0hQVk0gSVZNJwogICAgICAgICAgICBlbGlmIHJjID09IDAgYW5kIHJlLm1hdGNoKCcuKlJ1bm5pbmcuKkhQVk0gaG9zdC4qJywgb3V0KToKICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICdob3N0JwogICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ0hQVk0nCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoJy91c3Ivc2Jpbi9wYXJzdGF0dXMnKToKICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3Ivc2Jpbi9wYXJzdGF0dXMiKQogICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ2d1ZXN0JwogICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ0hQIG5QYXInCgogICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgoKY2xhc3MgSFBVWFZpcnR1YWxDb2xsZWN0b3IoVmlydHVhbENvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IEhQVVhWaXJ0dWFsCiAgICBfcGxhdGZvcm0gPSAnSFAtVVgnClBLAwQUAAAAAADLuytLT52S9ToFAAA6BQAAKQAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9maXBzLnB5IyBEZXRlcm1pbmUgaWYgYSBzeXN0ZW0gaXMgaW4gJ2ZpcHMnIG1vZGUKIwojIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy51dGlscyBpbXBvcnQgZ2V0X2ZpbGVfY29udGVudAoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5jb2xsZWN0b3IgaW1wb3J0IEJhc2VGYWN0Q29sbGVjdG9yCgoKY2xhc3MgRmlwc0ZhY3RDb2xsZWN0b3IoQmFzZUZhY3RDb2xsZWN0b3IpOgogICAgbmFtZSA9ICdmaXBzJwogICAgX2ZhY3RfaWRzID0gc2V0KCkKCiAgICBkZWYgY29sbGVjdChzZWxmLCBtb2R1bGU9Tm9uZSwgY29sbGVjdGVkX2ZhY3RzPU5vbmUpOgogICAgICAgICMgTk9URTogdGhpcyBpcyBwb3B1bGF0ZWQgZXZlbiBpZiBpdCBpcyBub3Qgc2V0CiAgICAgICAgZmlwc19mYWN0cyA9IHt9CiAgICAgICAgZmlwc19mYWN0c1snZmlwcyddID0gRmFsc2UKICAgICAgICBkYXRhID0gZ2V0X2ZpbGVfY29udGVudCgnL3Byb2Mvc3lzL2NyeXB0by9maXBzX2VuYWJsZWQnKQogICAgICAgIGlmIGRhdGEgYW5kIGRhdGEgPT0gJzEnOgogICAgICAgICAgICBmaXBzX2ZhY3RzWydmaXBzJ10gPSBUcnVlCiAgICAgICAgcmV0dXJuIGZpcHNfZmFjdHMKUEsDBBQAAAAAAMu7K0sd3Dmg9QsAAPULAAAsAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvc3lzdGVtL3NlbGludXgucHkjIENvbGxlY3QgZmFjdHMgcmVsYXRlZCB0byBzZWxpbnV4CiMKIyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuY29sbGVjdG9yIGltcG9ydCBCYXNlRmFjdENvbGxlY3RvcgoKdHJ5OgogICAgaW1wb3J0IHNlbGludXgKICAgIEhBVkVfU0VMSU5VWCA9IFRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgSEFWRV9TRUxJTlVYID0gRmFsc2UKClNFTElOVVhfTU9ERV9ESUNUID0gezE6ICdlbmZvcmNpbmcnLAogICAgICAgICAgICAgICAgICAgICAwOiAncGVybWlzc2l2ZScsCiAgICAgICAgICAgICAgICAgICAgIC0xOiAnZGlzYWJsZWQnfQoKCmNsYXNzIFNlbGludXhGYWN0Q29sbGVjdG9yKEJhc2VGYWN0Q29sbGVjdG9yKToKICAgIG5hbWUgPSAnc2VsaW51eCcKICAgIF9mYWN0X2lkcyA9IHNldCgpCgogICAgZGVmIGNvbGxlY3Qoc2VsZiwgbW9kdWxlPU5vbmUsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBmYWN0c19kaWN0ID0ge30KICAgICAgICBzZWxpbnV4X2ZhY3RzID0ge30KCiAgICAgICAgIyBUaGlzIGlzIHdlaXJkLiBUaGUgdmFsdWUgb2YgdGhlIGZhY3RzICdzZWxpbnV4JyBrZXkgY2FuIGJlIEZhbHNlIG9yIGEgZGljdAogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVg6CiAgICAgICAgICAgIGZhY3RzX2RpY3RbJ3NlbGludXgnXSA9IEZhbHNlCiAgICAgICAgICAgIGZhY3RzX2RpY3RbJ3NlbGludXhfcHl0aG9uX3ByZXNlbnQnXSA9IEZhbHNlCiAgICAgICAgICAgIHJldHVybiBmYWN0c19kaWN0CgogICAgICAgIGZhY3RzX2RpY3RbJ3NlbGludXhfcHl0aG9uX3ByZXNlbnQnXSA9IFRydWUKCiAgICAgICAgaWYgbm90IHNlbGludXguaXNfc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgIHNlbGludXhfZmFjdHNbJ3N0YXR1cyddID0gJ2Rpc2FibGVkJwogICAgICAgICMgTk9URTogdGhpcyBjb3VsZCBqdXN0IHJldHVybiBpbiB0aGUgYWJvdmUgY2xhdXNlIGFuZCB0aGUgcmVzdCBvZiB0aGlzIGlzIHVwIGFuIGluZGVudCAtYWtsCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsaW51eF9mYWN0c1snc3RhdHVzJ10gPSAnZW5hYmxlZCcKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGludXhfZmFjdHNbJ3BvbGljeXZlcnMnXSA9IHNlbGludXguc2VjdXJpdHlfcG9saWN5dmVycygpCiAgICAgICAgICAgIGV4Y2VwdCAoQXR0cmlidXRlRXJyb3IsIE9TRXJyb3IpOgogICAgICAgICAgICAgICAgc2VsaW51eF9mYWN0c1sncG9saWN5dmVycyddID0gJ3Vua25vd24nCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAocmMsIGNvbmZpZ21vZGUpID0gc2VsaW51eC5zZWxpbnV4X2dldGVuZm9yY2Vtb2RlKCkKICAgICAgICAgICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgICAgICAgICAgc2VsaW51eF9mYWN0c1snY29uZmlnX21vZGUnXSA9IFNFTElOVVhfTU9ERV9ESUNULmdldChjb25maWdtb2RlLCAndW5rbm93bicpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGludXhfZmFjdHNbJ2NvbmZpZ19tb2RlJ10gPSAndW5rbm93bicKICAgICAgICAgICAgZXhjZXB0IChBdHRyaWJ1dGVFcnJvciwgT1NFcnJvcik6CiAgICAgICAgICAgICAgICBzZWxpbnV4X2ZhY3RzWydjb25maWdfbW9kZSddID0gJ3Vua25vd24nCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBtb2RlID0gc2VsaW51eC5zZWN1cml0eV9nZXRlbmZvcmNlKCkKICAgICAgICAgICAgICAgIHNlbGludXhfZmFjdHNbJ21vZGUnXSA9IFNFTElOVVhfTU9ERV9ESUNULmdldChtb2RlLCAndW5rbm93bicpCiAgICAgICAgICAgIGV4Y2VwdCAoQXR0cmlidXRlRXJyb3IsIE9TRXJyb3IpOgogICAgICAgICAgICAgICAgc2VsaW51eF9mYWN0c1snbW9kZSddID0gJ3Vua25vd24nCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAocmMsIHBvbGljeXR5cGUpID0gc2VsaW51eC5zZWxpbnV4X2dldHBvbGljeXR5cGUoKQogICAgICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgICAgICBzZWxpbnV4X2ZhY3RzWyd0eXBlJ10gPSBwb2xpY3l0eXBlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGludXhfZmFjdHNbJ3R5cGUnXSA9ICd1bmtub3duJwogICAgICAgICAgICBleGNlcHQgKEF0dHJpYnV0ZUVycm9yLCBPU0Vycm9yKToKICAgICAgICAgICAgICAgIHNlbGludXhfZmFjdHNbJ3R5cGUnXSA9ICd1bmtub3duJwoKICAgICAgICBmYWN0c19kaWN0WydzZWxpbnV4J10gPSBzZWxpbnV4X2ZhY3RzCiAgICAgICAgcmV0dXJuIGZhY3RzX2RpY3QKUEsDBBQAAAAAAMu7K0sAAAAAAAAAAAAAAAAuAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvdmlydHVhbC9fX2luaXRfXy5weVBLAwQUAAAAAADLuytL4LzNTuULAADlCwAALAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9wa2dfbWdyLnB5IyBDb2xsZWN0IGZhY3RzIHJlbGF0ZWQgdG8gdGhlIHN5c3RlbSBwYWNrYWdlIG1hbmFnZXIKIwojIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKaW1wb3J0IG9zCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmNvbGxlY3RvciBpbXBvcnQgQmFzZUZhY3RDb2xsZWN0b3IKCiMgQSBsaXN0IG9mIGRpY3RzLiAgSWYgdGhlcmUgaXMgYSBwbGF0Zm9ybSB3aXRoIG1vcmUgdGhhbiBvbmUKIyBwYWNrYWdlIG1hbmFnZXIsIHB1dCB0aGUgcHJlZmVycmVkIG9uZSBsYXN0LiAgSWYgdGhlcmUgaXMgYW4KIyBhbnNpYmxlIG1vZHVsZSwgdXNlIHRoYXQgYXMgdGhlIHZhbHVlIGZvciB0aGUgJ25hbWUnIGtleS4KUEtHX01HUlMgPSBbeydwYXRoJzogJy91c3IvYmluL3l1bScsICduYW1lJzogJ3l1bSd9LAogICAgICAgICAgICB7J3BhdGgnOiAnL3Vzci9iaW4vZG5mJywgJ25hbWUnOiAnZG5mJ30sCiAgICAgICAgICAgIHsncGF0aCc6ICcvdXNyL2Jpbi9hcHQtZ2V0JywgJ25hbWUnOiAnYXB0J30sCiAgICAgICAgICAgIHsncGF0aCc6ICcvdXNyL2Jpbi96eXBwZXInLCAnbmFtZSc6ICd6eXBwZXInfSwKICAgICAgICAgICAgeydwYXRoJzogJy91c3Ivc2Jpbi91cnBtaScsICduYW1lJzogJ3VycG1pJ30sCiAgICAgICAgICAgIHsncGF0aCc6ICcvdXNyL2Jpbi9wYWNtYW4nLCAnbmFtZSc6ICdwYWNtYW4nfSwKICAgICAgICAgICAgeydwYXRoJzogJy9iaW4vb3BrZycsICduYW1lJzogJ29wa2cnfSwKICAgICAgICAgICAgeydwYXRoJzogJy91c3IvcGtnL2Jpbi9wa2dpbicsICduYW1lJzogJ3BrZ2luJ30sCiAgICAgICAgICAgIHsncGF0aCc6ICcvb3B0L2xvY2FsL2Jpbi9wa2dpbicsICduYW1lJzogJ3BrZ2luJ30sCiAgICAgICAgICAgIHsncGF0aCc6ICcvb3B0L3Rvb2xzL2Jpbi9wa2dpbicsICduYW1lJzogJ3BrZ2luJ30sCiAgICAgICAgICAgIHsncGF0aCc6ICcvb3B0L2xvY2FsL2Jpbi9wb3J0JywgJ25hbWUnOiAnbWFjcG9ydHMnfSwKICAgICAgICAgICAgeydwYXRoJzogJy91c3IvbG9jYWwvYmluL2JyZXcnLCAnbmFtZSc6ICdob21lYnJldyd9LAogICAgICAgICAgICB7J3BhdGgnOiAnL3NiaW4vYXBrJywgJ25hbWUnOiAnYXBrJ30sCiAgICAgICAgICAgIHsncGF0aCc6ICcvdXNyL3NiaW4vcGtnJywgJ25hbWUnOiAncGtnbmcnfSwKICAgICAgICAgICAgeydwYXRoJzogJy91c3Ivc2Jpbi9zd2xpc3QnLCAnbmFtZSc6ICdIUC1VWCd9LAogICAgICAgICAgICB7J3BhdGgnOiAnL3Vzci9iaW4vZW1lcmdlJywgJ25hbWUnOiAncG9ydGFnZSd9LAogICAgICAgICAgICB7J3BhdGgnOiAnL3Vzci9zYmluL3BrZ2FkZCcsICduYW1lJzogJ3N2cjRwa2cnfSwKICAgICAgICAgICAgeydwYXRoJzogJy91c3IvYmluL3BrZycsICduYW1lJzogJ3BrZzUnfSwKICAgICAgICAgICAgeydwYXRoJzogJy91c3IvYmluL3hicHMtaW5zdGFsbCcsICduYW1lJzogJ3hicHMnfSwKICAgICAgICAgICAgeydwYXRoJzogJy91c3IvbG9jYWwvc2Jpbi9wa2cnLCAnbmFtZSc6ICdwa2duZyd9LAogICAgICAgICAgICB7J3BhdGgnOiAnL3Vzci9iaW4vc3d1cGQnLCAnbmFtZSc6ICdzd3VwZCd9LAogICAgICAgICAgICB7J3BhdGgnOiAnL3Vzci9zYmluL3NvcmNlcnknLCAnbmFtZSc6ICdzb3JjZXJ5J30sCiAgICAgICAgICAgIF0KCgojIHRoZSBmYWN0IGVuZHMgdXAgYmVpbmcgJ3BrZ19tZ3InIHNvIHN0aWNrIHdpdGggdGhhdCBuYW1pbmcvc3BlbGxpbmcKY2xhc3MgUGtnTWdyRmFjdENvbGxlY3RvcihCYXNlRmFjdENvbGxlY3Rvcik6CiAgICBuYW1lID0gJ3BrZ19tZ3InCiAgICBfZmFjdF9pZHMgPSBzZXQoKQoKICAgIGRlZiBjb2xsZWN0KHNlbGYsIG1vZHVsZT1Ob25lLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgZmFjdHNfZGljdCA9IHt9CiAgICAgICAgY29sbGVjdGVkX2ZhY3RzID0gY29sbGVjdGVkX2ZhY3RzIG9yIHt9CgogICAgICAgIHBrZ19tZ3JfbmFtZSA9IE5vbmUKICAgICAgICBpZiBjb2xsZWN0ZWRfZmFjdHMuZ2V0KCdzeXN0ZW0nKSA9PSAnT3BlbkJTRCc6CiAgICAgICAgICAgIGZhY3RzX2RpY3RbJ3BrZ19tZ3InXSA9ICdvcGVuYnNkX3BrZycKICAgICAgICAgICAgcmV0dXJuIGZhY3RzX2RpY3QKCiAgICAgICAgcGtnX21ncl9uYW1lID0gJ3Vua25vd24nCiAgICAgICAgZm9yIHBrZyBpbiBQS0dfTUdSUzoKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocGtnWydwYXRoJ10pOgogICAgICAgICAgICAgICAgcGtnX21ncl9uYW1lID0gcGtnWyduYW1lJ10KCiAgICAgICAgZmFjdHNfZGljdFsncGtnX21nciddID0gcGtnX21ncl9uYW1lCiAgICAgICAgcmV0dXJuIGZhY3RzX2RpY3QKUEsDBBQAAAAAAMu7K0uOZeASdgoAAHYKAAAoAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvc3lzdGVtL2Rucy5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy51dGlscyBpbXBvcnQgZ2V0X2ZpbGVfY29udGVudAoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5jb2xsZWN0b3IgaW1wb3J0IEJhc2VGYWN0Q29sbGVjdG9yCgoKY2xhc3MgRG5zRmFjdENvbGxlY3RvcihCYXNlRmFjdENvbGxlY3Rvcik6CiAgICBuYW1lID0gJ2RucycKICAgIF9mYWN0X2lkcyA9IHNldCgpCgogICAgZGVmIGNvbGxlY3Qoc2VsZiwgbW9kdWxlPU5vbmUsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBkbnNfZmFjdHMgPSB7fQoKICAgICAgICAjIFRPRE86IGZsYXR0ZW4KICAgICAgICBkbnNfZmFjdHNbJ2RucyddID0ge30KCiAgICAgICAgZm9yIGxpbmUgaW4gZ2V0X2ZpbGVfY29udGVudCgnL2V0Yy9yZXNvbHYuY29uZicsICcnKS5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCgnIycpIG9yIGxpbmUuc3RhcnRzd2l0aCgnOycpIG9yIGxpbmUuc3RyaXAoKSA9PSAnJzoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIHRva2VucyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4odG9rZW5zKSA9PSAwOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgdG9rZW5zWzBdID09ICduYW1lc2VydmVyJzoKICAgICAgICAgICAgICAgIGlmICduYW1lc2VydmVycycgbm90IGluIGRuc19mYWN0c1snZG5zJ106CiAgICAgICAgICAgICAgICAgICAgZG5zX2ZhY3RzWydkbnMnXVsnbmFtZXNlcnZlcnMnXSA9IFtdCiAgICAgICAgICAgICAgICBmb3IgbmFtZXNlcnZlciBpbiB0b2tlbnNbMTpdOgogICAgICAgICAgICAgICAgICAgIGRuc19mYWN0c1snZG5zJ11bJ25hbWVzZXJ2ZXJzJ10uYXBwZW5kKG5hbWVzZXJ2ZXIpCiAgICAgICAgICAgIGVsaWYgdG9rZW5zWzBdID09ICdkb21haW4nOgogICAgICAgICAgICAgICAgaWYgbGVuKHRva2VucykgPiAxOgogICAgICAgICAgICAgICAgICAgIGRuc19mYWN0c1snZG5zJ11bJ2RvbWFpbiddID0gdG9rZW5zWzFdCiAgICAgICAgICAgIGVsaWYgdG9rZW5zWzBdID09ICdzZWFyY2gnOgogICAgICAgICAgICAgICAgZG5zX2ZhY3RzWydkbnMnXVsnc2VhcmNoJ10gPSBbXQogICAgICAgICAgICAgICAgZm9yIHN1ZmZpeCBpbiB0b2tlbnNbMTpdOgogICAgICAgICAgICAgICAgICAgIGRuc19mYWN0c1snZG5zJ11bJ3NlYXJjaCddLmFwcGVuZChzdWZmaXgpCiAgICAgICAgICAgIGVsaWYgdG9rZW5zWzBdID09ICdzb3J0bGlzdCc6CiAgICAgICAgICAgICAgICBkbnNfZmFjdHNbJ2RucyddWydzb3J0bGlzdCddID0gW10KICAgICAgICAgICAgICAgIGZvciBhZGRyZXNzIGluIHRva2Vuc1sxOl06CiAgICAgICAgICAgICAgICAgICAgZG5zX2ZhY3RzWydkbnMnXVsnc29ydGxpc3QnXS5hcHBlbmQoYWRkcmVzcykKICAgICAgICAgICAgZWxpZiB0b2tlbnNbMF0gPT0gJ29wdGlvbnMnOgogICAgICAgICAgICAgICAgZG5zX2ZhY3RzWydkbnMnXVsnb3B0aW9ucyddID0ge30KICAgICAgICAgICAgICAgIGlmIGxlbih0b2tlbnMpID4gMToKICAgICAgICAgICAgICAgICAgICBmb3Igb3B0aW9uIGluIHRva2Vuc1sxOl06CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbl90b2tlbnMgPSBvcHRpb24uc3BsaXQoJzonLCAxKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4ob3B0aW9uX3Rva2VucykgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IGxlbihvcHRpb25fdG9rZW5zKSA9PSAyIGFuZCBvcHRpb25fdG9rZW5zWzFdIG9yIFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgZG5zX2ZhY3RzWydkbnMnXVsnb3B0aW9ucyddW29wdGlvbl90b2tlbnNbMF1dID0gdmFsCgogICAgICAgIHJldHVybiBkbnNfZmFjdHMKUEsDBBQAAAAAAMu7K0sJr22V+ggAAPoIAAAqAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvdmlydHVhbC9iYXNlLnB5IyBiYXNlIGNsYXNzZXMgZm9yIHZpcnR1YWxpemF0aW9uIGZhY3RzCiMgLSotIGNvZGluZzogdXRmLTggLSotCiMKIyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuY29sbGVjdG9yIGltcG9ydCBCYXNlRmFjdENvbGxlY3RvcgoKCmNsYXNzIFZpcnR1YWw6CiAgICAiIiIKICAgIFRoaXMgaXMgYSBnZW5lcmljIFZpcnR1YWwgc3ViY2xhc3Mgb2YgRmFjdHMuICBUaGlzIHNob3VsZCBiZSBmdXJ0aGVyCiAgICBzdWJjbGFzc2VkIHRvIGltcGxlbWVudCBwZXIgcGxhdGZvcm0uICBJZiB5b3Ugc3ViY2xhc3MgdGhpcywKICAgIHlvdSBzaG91bGQgZGVmaW5lOgogICAgLSB2aXJ0dWFsaXphdGlvbl90eXBlCiAgICAtIHZpcnR1YWxpemF0aW9uX3JvbGUKICAgIC0gY29udGFpbmVyIChlLmcuIHNvbGFyaXMgem9uZXMsIGZyZWVic2QgamFpbHMsIGxpbnV4IGNvbnRhaW5lcnMpCgogICAgQWxsIHN1YmNsYXNzZXMgTVVTVCBkZWZpbmUgcGxhdGZvcm0uCiAgICAiIiIKICAgIHBsYXRmb3JtID0gJ0dlbmVyaWMnCgogICAgIyBGSVhNRTogcmVtb3ZlIGxvYWRfb25faW5pdCBpZiB3ZSBjYW4KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBtb2R1bGUsIGxvYWRfb25faW5pdD1GYWxzZSk6CiAgICAgICAgc2VsZi5tb2R1bGUgPSBtb2R1bGUKCiAgICAjIEZJWE1FOiBqdXN0IGhlcmUgZm9yIGV4aXN0aW5nIHRlc3RzIGNhc2VzIHRpbGwgdGhleSBhcmUgdXBkYXRlZAogICAgZGVmIHBvcHVsYXRlKHNlbGYsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICB2aXJ0dWFsX2ZhY3RzID0gc2VsZi5nZXRfdmlydHVhbF9mYWN0cygpCgogICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgogICAgZGVmIGdldF92aXJ0dWFsX2ZhY3RzKHNlbGYpOgogICAgICAgIHZpcnR1YWxfZmFjdHMgPSB7J3ZpcnR1YWxpemF0aW9uX3R5cGUnOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICd2aXJ0dWFsaXphdGlvbl9yb2xlJzogJyd9CiAgICAgICAgcmV0dXJuIHZpcnR1YWxfZmFjdHMKCgpjbGFzcyBWaXJ0dWFsQ29sbGVjdG9yKEJhc2VGYWN0Q29sbGVjdG9yKToKICAgIG5hbWUgPSAndmlydHVhbCcKICAgIF9mYWN0X2NsYXNzID0gVmlydHVhbAogICAgX2ZhY3RfaWRzID0gc2V0KFsndmlydHVhbGl6YXRpb25fdHlwZScsCiAgICAgICAgICAgICAgICAgICAgICd2aXJ0dWFsaXphdGlvbl9yb2xlJ10pCgogICAgZGVmIGNvbGxlY3Qoc2VsZiwgbW9kdWxlPU5vbmUsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBjb2xsZWN0ZWRfZmFjdHMgPSBjb2xsZWN0ZWRfZmFjdHMgb3Ige30KICAgICAgICBpZiBub3QgbW9kdWxlOgogICAgICAgICAgICByZXR1cm4ge30KCiAgICAgICAgIyBOZXR3b3JrIG11bmdlcyBjYWNoZWRfZmFjdHMgYnkgc2lkZSBlZmZlY3QsIHNvIGdpdmUgaXQgYSBjb3B5CiAgICAgICAgZmFjdHNfb2JqID0gc2VsZi5fZmFjdF9jbGFzcyhtb2R1bGUpCgogICAgICAgIGZhY3RzX2RpY3QgPSBmYWN0c19vYmoucG9wdWxhdGUoY29sbGVjdGVkX2ZhY3RzPWNvbGxlY3RlZF9mYWN0cykKCiAgICAgICAgcmV0dXJuIGZhY3RzX2RpY3QKUEsDBBQAAAAAAMu7K0udppN8Ww0AAFsNAAAtAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvaGFyZHdhcmUvZGFyd2luLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmhhcmR3YXJlLmJhc2UgaW1wb3J0IEhhcmR3YXJlLCBIYXJkd2FyZUNvbGxlY3RvcgoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5zeXNjdGwgaW1wb3J0IGdldF9zeXNjdGwKCgpjbGFzcyBEYXJ3aW5IYXJkd2FyZShIYXJkd2FyZSk6CiAgICAiIiIKICAgIERhcndpbi1zcGVjaWZpYyBzdWJjbGFzcyBvZiBIYXJkd2FyZS4gIERlZmluZXMgbWVtb3J5IGFuZCBDUFUgZmFjdHM6CiAgICAtIHByb2Nlc3NvcgogICAgLSBwcm9jZXNzb3JfY29yZXMKICAgIC0gbWVtdG90YWxfbWIKICAgIC0gbWVtZnJlZV9tYgogICAgLSBtb2RlbAogICAgLSBvc3ZlcnNpb24KICAgIC0gb3NyZXZpc2lvbgogICAgIiIiCiAgICBwbGF0Zm9ybSA9ICdEYXJ3aW4nCgogICAgZGVmIHBvcHVsYXRlKHNlbGYsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBoYXJkd2FyZV9mYWN0cyA9IHt9CgogICAgICAgIHNlbGYuc3lzY3RsID0gZ2V0X3N5c2N0bChzZWxmLm1vZHVsZSwgWydodycsICdtYWNoZGVwJywgJ2tlcm4nXSkKICAgICAgICBtYWNfZmFjdHMgPSBzZWxmLmdldF9tYWNfZmFjdHMoKQogICAgICAgIGNwdV9mYWN0cyA9IHNlbGYuZ2V0X2NwdV9mYWN0cygpCiAgICAgICAgbWVtb3J5X2ZhY3RzID0gc2VsZi5nZXRfbWVtb3J5X2ZhY3RzKCkKCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKG1hY19mYWN0cykKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUoY3B1X2ZhY3RzKQogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShtZW1vcnlfZmFjdHMpCgogICAgICAgIHJldHVybiBoYXJkd2FyZV9mYWN0cwoKICAgIGRlZiBnZXRfc3lzdGVtX3Byb2ZpbGUoc2VsZik6CiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoWyIvdXNyL3NiaW4vc3lzdGVtX3Byb2ZpbGVyIiwgIlNQSGFyZHdhcmVEYXRhVHlwZSJdKQogICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgIHJldHVybiBkaWN0KCkKICAgICAgICBzeXN0ZW1fcHJvZmlsZSA9IGRpY3QoKQogICAgICAgIGZvciBsaW5lIGluIG91dC5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgIGlmICc6ICcgaW4gbGluZToKICAgICAgICAgICAgICAgIChrZXksIHZhbHVlKSA9IGxpbmUuc3BsaXQoJzogJywgMSkKICAgICAgICAgICAgICAgIHN5c3RlbV9wcm9maWxlW2tleS5zdHJpcCgpXSA9ICcgJy5qb2luKHZhbHVlLnN0cmlwKCkuc3BsaXQoKSkKICAgICAgICByZXR1cm4gc3lzdGVtX3Byb2ZpbGUKCiAgICBkZWYgZ2V0X21hY19mYWN0cyhzZWxmKToKICAgICAgICBtYWNfZmFjdHMgPSB7fQogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCJzeXNjdGwgaHcubW9kZWwiKQogICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgIG1hY19mYWN0c1snbW9kZWwnXSA9IG91dC5zcGxpdGxpbmVzKClbLTFdLnNwbGl0KClbMV0KICAgICAgICBtYWNfZmFjdHNbJ29zdmVyc2lvbiddID0gc2VsZi5zeXNjdGxbJ2tlcm4ub3N2ZXJzaW9uJ10KICAgICAgICBtYWNfZmFjdHNbJ29zcmV2aXNpb24nXSA9IHNlbGYuc3lzY3RsWydrZXJuLm9zcmV2aXNpb24nXQoKICAgICAgICByZXR1cm4gbWFjX2ZhY3RzCgogICAgZGVmIGdldF9jcHVfZmFjdHMoc2VsZik6CiAgICAgICAgY3B1X2ZhY3RzID0ge30KICAgICAgICBpZiAnbWFjaGRlcC5jcHUuYnJhbmRfc3RyaW5nJyBpbiBzZWxmLnN5c2N0bDogICMgSW50ZWwKICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3InXSA9IHNlbGYuc3lzY3RsWydtYWNoZGVwLmNwdS5icmFuZF9zdHJpbmcnXQogICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3JlcyddID0gc2VsZi5zeXNjdGxbJ21hY2hkZXAuY3B1LmNvcmVfY291bnQnXQogICAgICAgIGVsc2U6ICAjIFBvd2VyUEMKICAgICAgICAgICAgc3lzdGVtX3Byb2ZpbGUgPSBzZWxmLmdldF9zeXN0ZW1fcHJvZmlsZSgpCiAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yJ10gPSAnJXMgQCAlcycgJSAoc3lzdGVtX3Byb2ZpbGVbJ1Byb2Nlc3NvciBOYW1lJ10sIHN5c3RlbV9wcm9maWxlWydQcm9jZXNzb3IgU3BlZWQnXSkKICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY29yZXMnXSA9IHNlbGYuc3lzY3RsWydody5waHlzaWNhbGNwdSddCgogICAgICAgIHJldHVybiBjcHVfZmFjdHMKCiAgICBkZWYgZ2V0X21lbW9yeV9mYWN0cyhzZWxmKToKICAgICAgICBtZW1vcnlfZmFjdHMgPSB7fQoKICAgICAgICBtZW1vcnlfZmFjdHNbJ21lbXRvdGFsX21iJ10gPSBpbnQoc2VsZi5zeXNjdGxbJ2h3Lm1lbXNpemUnXSkgLy8gMTAyNCAvLyAxMDI0CgogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCJzeXNjdGwgaHcudXNlcm1lbSIpCiAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgbWVtb3J5X2ZhY3RzWydtZW1mcmVlX21iJ10gPSBpbnQob3V0LnNwbGl0bGluZXMoKVstMV0uc3BsaXQoKVsxXSkgLy8gMTAyNCAvLyAxMDI0CgogICAgICAgIHJldHVybiBtZW1vcnlfZmFjdHMKCgpjbGFzcyBEYXJ3aW5IYXJkd2FyZUNvbGxlY3RvcihIYXJkd2FyZUNvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IERhcndpbkhhcmR3YXJlCiAgICBfcGxhdGZvcm0gPSAnRGFyd2luJwpQSwMEFAAAAAAAy7srS8xzjlL0AwAA9AMAAC8AAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy92aXJ0dWFsL2RyYWdvbmZseS5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnZpcnR1YWwuZnJlZWJzZCBpbXBvcnQgRnJlZUJTRFZpcnR1YWwsIFZpcnR1YWxDb2xsZWN0b3IKCgpjbGFzcyBEcmFnb25GbHlWaXJ0dWFsQ29sbGVjdG9yKFZpcnR1YWxDb2xsZWN0b3IpOgogICAgIyBOb3RlIHRoZSBfZmFjdF9jbGFzcyBpbXBsIGlzIGFjdHVhbGx5IHRoZSBGcmVlQlNEVmlydHVhbCBpbXBsCiAgICBfZmFjdF9jbGFzcyA9IEZyZWVCU0RWaXJ0dWFsCiAgICBfcGxhdGZvcm0gPSAnRHJhZ29uRmx5JwpQSwMEFAAAAAAAy7srS8SzHD9HCAAARwgAADEAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9zeXN0ZW0vc3NoX3B1Yl9rZXlzLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMudXRpbHMgaW1wb3J0IGdldF9maWxlX2NvbnRlbnQKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuY29sbGVjdG9yIGltcG9ydCBCYXNlRmFjdENvbGxlY3RvcgoKCmNsYXNzIFNzaFB1YktleUZhY3RDb2xsZWN0b3IoQmFzZUZhY3RDb2xsZWN0b3IpOgogICAgbmFtZSA9ICdzc2hfcHViX2tleXMnCiAgICBfZmFjdF9pZHMgPSBzZXQoWydzc2hfaG9zdF9wdWJfa2V5cycsCiAgICAgICAgICAgICAgICAgICAgICdzc2hfaG9zdF9rZXlfZHNhX3B1YmxpYycsCiAgICAgICAgICAgICAgICAgICAgICdzc2hfaG9zdF9rZXlfcnNhX3B1YmxpYycsCiAgICAgICAgICAgICAgICAgICAgICdzc2hfaG9zdF9rZXlfZWNkc2FfcHVibGljJywKICAgICAgICAgICAgICAgICAgICAgJ3NzaF9ob3N0X2tleV9lZDI1NTE5X3B1YmxpYyddKQoKICAgIGRlZiBjb2xsZWN0KHNlbGYsIG1vZHVsZT1Ob25lLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgc3NoX3B1Yl9rZXlfZmFjdHMgPSB7fQogICAgICAgIGtleXR5cGVzID0gKCdkc2EnLCAncnNhJywgJ2VjZHNhJywgJ2VkMjU1MTknKQoKICAgICAgICAjIGxpc3Qgb2YgZGlyZWN0b3JpZXMgdG8gY2hlY2sgZm9yIHNzaCBrZXlzCiAgICAgICAgIyB1c2VkIGluIHRoZSBvcmRlciBsaXN0ZWQgaGVyZSwgdGhlIGZpcnN0IG9uZSB3aXRoIGtleXMgaXMgdXNlZAogICAgICAgIGtleWRpcnMgPSBbJy9ldGMvc3NoJywgJy9ldGMvb3BlbnNzaCcsICcvZXRjJ10KCiAgICAgICAgZm9yIGtleWRpciBpbiBrZXlkaXJzOgogICAgICAgICAgICBmb3IgdHlwZV8gaW4ga2V5dHlwZXM6CiAgICAgICAgICAgICAgICBmYWN0bmFtZSA9ICdzc2hfaG9zdF9rZXlfJXNfcHVibGljJyAlIHR5cGVfCiAgICAgICAgICAgICAgICBpZiBmYWN0bmFtZSBpbiBzc2hfcHViX2tleV9mYWN0czoKICAgICAgICAgICAgICAgICAgICAjIGEgcHJldmlvdXMga2V5ZGlyIHdhcyBhbHJlYWR5IHN1Y2Nlc3NmdWwsIHN0b3AgbG9va2luZwogICAgICAgICAgICAgICAgICAgICMgZm9yIGtleXMKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3NoX3B1Yl9rZXlfZmFjdHMKICAgICAgICAgICAgICAgIGtleV9maWxlbmFtZSA9ICclcy9zc2hfaG9zdF8lc19rZXkucHViJyAlIChrZXlkaXIsIHR5cGVfKQogICAgICAgICAgICAgICAga2V5ZGF0YSA9IGdldF9maWxlX2NvbnRlbnQoa2V5X2ZpbGVuYW1lKQogICAgICAgICAgICAgICAgaWYga2V5ZGF0YSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBzc2hfcHViX2tleV9mYWN0c1tmYWN0bmFtZV0gPSBrZXlkYXRhLnNwbGl0KClbMV0KCiAgICAgICAgcmV0dXJuIHNzaF9wdWJfa2V5X2ZhY3RzClBLAwQUAAAAAADLuytLAAAAAAAAAAAAAAAALgAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL25ldHdvcmsvX19pbml0X18ucHlQSwMEFAAAAAAAy7srSwAAAAAAAAAAAAAAAC8AAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9oYXJkd2FyZS9fX2luaXRfXy5weVBLAwQUAAAAAADLuytLwNIE4u8MAADvDAAAKAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9sc2IucHkjIENvbGxlY3QgZmFjdHMgcmVsYXRlZCB0byBMU0IgKExpbnV4IFN0YW5kYXJkIEJhc2UpCiMKIyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCBvcwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy51dGlscyBpbXBvcnQgZ2V0X2ZpbGVfbGluZXMKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5jb2xsZWN0b3IgaW1wb3J0IEJhc2VGYWN0Q29sbGVjdG9yCgoKY2xhc3MgTFNCRmFjdENvbGxlY3RvcihCYXNlRmFjdENvbGxlY3Rvcik6CiAgICBuYW1lID0gJ2xzYicKICAgIF9mYWN0X2lkcyA9IHNldCgpCgogICAgZGVmIF9sc2JfcmVsZWFzZV9iaW4oc2VsZiwgbHNiX3BhdGgsIG1vZHVsZSk6CiAgICAgICAgbHNiX2ZhY3RzID0ge30KCiAgICAgICAgaWYgbm90IGxzYl9wYXRoOgogICAgICAgICAgICByZXR1cm4gbHNiX2ZhY3RzCgogICAgICAgIHJjLCBvdXQsIGVyciA9IG1vZHVsZS5ydW5fY29tbWFuZChbbHNiX3BhdGgsICItYSJdLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKQogICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgIHJldHVybiBsc2JfZmFjdHMKCiAgICAgICAgZm9yIGxpbmUgaW4gb3V0LnNwbGl0bGluZXMoKToKICAgICAgICAgICAgaWYgbGVuKGxpbmUpIDwgMSBvciAnOicgbm90IGluIGxpbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB2YWx1ZSA9IGxpbmUuc3BsaXQoJzonLCAxKVsxXS5zdHJpcCgpCgogICAgICAgICAgICBpZiAnTFNCIFZlcnNpb246JyBpbiBsaW5lOgogICAgICAgICAgICAgICAgbHNiX2ZhY3RzWydyZWxlYXNlJ10gPSB2YWx1ZQogICAgICAgICAgICBlbGlmICdEaXN0cmlidXRvciBJRDonIGluIGxpbmU6CiAgICAgICAgICAgICAgICBsc2JfZmFjdHNbJ2lkJ10gPSB2YWx1ZQogICAgICAgICAgICBlbGlmICdEZXNjcmlwdGlvbjonIGluIGxpbmU6CiAgICAgICAgICAgICAgICBsc2JfZmFjdHNbJ2Rlc2NyaXB0aW9uJ10gPSB2YWx1ZQogICAgICAgICAgICBlbGlmICdSZWxlYXNlOicgaW4gbGluZToKICAgICAgICAgICAgICAgIGxzYl9mYWN0c1sncmVsZWFzZSddID0gdmFsdWUKICAgICAgICAgICAgZWxpZiAnQ29kZW5hbWU6JyBpbiBsaW5lOgogICAgICAgICAgICAgICAgbHNiX2ZhY3RzWydjb2RlbmFtZSddID0gdmFsdWUKCiAgICAgICAgcmV0dXJuIGxzYl9mYWN0cwoKICAgIGRlZiBfbHNiX3JlbGVhc2VfZmlsZShzZWxmLCBldGNfbHNiX3JlbGVhc2VfbG9jYXRpb24pOgogICAgICAgIGxzYl9mYWN0cyA9IHt9CgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhldGNfbHNiX3JlbGVhc2VfbG9jYXRpb24pOgogICAgICAgICAgICByZXR1cm4gbHNiX2ZhY3RzCgogICAgICAgIGZvciBsaW5lIGluIGdldF9maWxlX2xpbmVzKGV0Y19sc2JfcmVsZWFzZV9sb2NhdGlvbik6CiAgICAgICAgICAgIHZhbHVlID0gbGluZS5zcGxpdCgnPScsIDEpWzFdLnN0cmlwKCkKCiAgICAgICAgICAgIGlmICdESVNUUklCX0lEJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgbHNiX2ZhY3RzWydpZCddID0gdmFsdWUKICAgICAgICAgICAgZWxpZiAnRElTVFJJQl9SRUxFQVNFJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgbHNiX2ZhY3RzWydyZWxlYXNlJ10gPSB2YWx1ZQogICAgICAgICAgICBlbGlmICdESVNUUklCX0RFU0NSSVBUSU9OJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgbHNiX2ZhY3RzWydkZXNjcmlwdGlvbiddID0gdmFsdWUKICAgICAgICAgICAgZWxpZiAnRElTVFJJQl9DT0RFTkFNRScgaW4gbGluZToKICAgICAgICAgICAgICAgIGxzYl9mYWN0c1snY29kZW5hbWUnXSA9IHZhbHVlCgogICAgICAgIHJldHVybiBsc2JfZmFjdHMKCiAgICBkZWYgY29sbGVjdChzZWxmLCBtb2R1bGU9Tm9uZSwgY29sbGVjdGVkX2ZhY3RzPU5vbmUpOgogICAgICAgIGZhY3RzX2RpY3QgPSB7fQogICAgICAgIGxzYl9mYWN0cyA9IHt9CgogICAgICAgIGlmIG5vdCBtb2R1bGU6CiAgICAgICAgICAgIHJldHVybiBmYWN0c19kaWN0CgogICAgICAgIGxzYl9wYXRoID0gbW9kdWxlLmdldF9iaW5fcGF0aCgnbHNiX3JlbGVhc2UnKQoKICAgICAgICAjIHRyeSB0aGUgJ2xzYl9yZWxlYXNlJyBzY3JpcHQgZmlyc3QKICAgICAgICBpZiBsc2JfcGF0aDoKICAgICAgICAgICAgbHNiX2ZhY3RzID0gc2VsZi5fbHNiX3JlbGVhc2VfYmluKGxzYl9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlPW1vZHVsZSkKCiAgICAgICAgIyBubyBsc2JfcmVsZWFzZSwgdHJ5IGxvb2tpbmcgaW4gL2V0Yy9sc2ItcmVsZWFzZQogICAgICAgIGlmIG5vdCBsc2JfZmFjdHM6CiAgICAgICAgICAgIGxzYl9mYWN0cyA9IHNlbGYuX2xzYl9yZWxlYXNlX2ZpbGUoJy9ldGMvbHNiLXJlbGVhc2UnKQoKICAgICAgICBpZiBsc2JfZmFjdHMgYW5kICdyZWxlYXNlJyBpbiBsc2JfZmFjdHM6CiAgICAgICAgICAgIGxzYl9mYWN0c1snbWFqb3JfcmVsZWFzZSddID0gbHNiX2ZhY3RzWydyZWxlYXNlJ10uc3BsaXQoJy4nKVswXQoKICAgICAgICBmYWN0c19kaWN0Wydsc2InXSA9IGxzYl9mYWN0cwogICAgICAgIHJldHVybiBmYWN0c19kaWN0ClBLAwQUAAAAAADLuytLIphGbSUKAAAlCgAALgAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9kYXRlX3RpbWUucHkjIERhdGEgYW5kIHRpbWUgcmVsYXRlZCBmYWN0cyBjb2xsZWN0aW9uIGZvciBhbnNpYmxlLgojCiMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHRpbWUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuY29sbGVjdG9yIGltcG9ydCBCYXNlRmFjdENvbGxlY3RvcgoKCmNsYXNzIERhdGVUaW1lRmFjdENvbGxlY3RvcihCYXNlRmFjdENvbGxlY3Rvcik6CiAgICBuYW1lID0gJ2RhdGVfdGltZScKICAgIF9mYWN0X2lkcyA9IHNldCgpCgogICAgZGVmIGNvbGxlY3Qoc2VsZiwgbW9kdWxlPU5vbmUsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBmYWN0c19kaWN0ID0ge30KICAgICAgICBkYXRlX3RpbWVfZmFjdHMgPSB7fQoKICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgIGRhdGVfdGltZV9mYWN0c1sneWVhciddID0gbm93LnN0cmZ0aW1lKCclWScpCiAgICAgICAgZGF0ZV90aW1lX2ZhY3RzWydtb250aCddID0gbm93LnN0cmZ0aW1lKCclbScpCiAgICAgICAgZGF0ZV90aW1lX2ZhY3RzWyd3ZWVrZGF5J10gPSBub3cuc3RyZnRpbWUoJyVBJykKICAgICAgICBkYXRlX3RpbWVfZmFjdHNbJ3dlZWtkYXlfbnVtYmVyJ10gPSBub3cuc3RyZnRpbWUoJyV3JykKICAgICAgICBkYXRlX3RpbWVfZmFjdHNbJ3dlZWtudW1iZXInXSA9IG5vdy5zdHJmdGltZSgnJVcnKQogICAgICAgIGRhdGVfdGltZV9mYWN0c1snZGF5J10gPSBub3cuc3RyZnRpbWUoJyVkJykKICAgICAgICBkYXRlX3RpbWVfZmFjdHNbJ2hvdXInXSA9IG5vdy5zdHJmdGltZSgnJUgnKQogICAgICAgIGRhdGVfdGltZV9mYWN0c1snbWludXRlJ10gPSBub3cuc3RyZnRpbWUoJyVNJykKICAgICAgICBkYXRlX3RpbWVfZmFjdHNbJ3NlY29uZCddID0gbm93LnN0cmZ0aW1lKCclUycpCiAgICAgICAgZGF0ZV90aW1lX2ZhY3RzWydlcG9jaCddID0gbm93LnN0cmZ0aW1lKCclcycpCiAgICAgICAgaWYgZGF0ZV90aW1lX2ZhY3RzWydlcG9jaCddID09ICcnIG9yIGRhdGVfdGltZV9mYWN0c1snZXBvY2gnXVswXSA9PSAnJSc6CiAgICAgICAgICAgICMgTk9URTogaW4gdGhpcyBjYXNlLCB0aGUgZXBvY2ggd29udCBtYXRjaCB0aGUgcmVzdCBvZiB0aGUgZGF0ZV90aW1lIGZhY3RzPyBpZSwgaXQncyBhIGZldyBtaWxsaXNlY29uZHMgbGF0ZXIuLj8gLWFrbAogICAgICAgICAgICBkYXRlX3RpbWVfZmFjdHNbJ2Vwb2NoJ10gPSBzdHIoaW50KHRpbWUudGltZSgpKSkKICAgICAgICBkYXRlX3RpbWVfZmFjdHNbJ2RhdGUnXSA9IG5vdy5zdHJmdGltZSgnJVktJW0tJWQnKQogICAgICAgIGRhdGVfdGltZV9mYWN0c1sndGltZSddID0gbm93LnN0cmZ0aW1lKCclSDolTTolUycpCiAgICAgICAgZGF0ZV90aW1lX2ZhY3RzWydpc284NjAxX21pY3JvJ10gPSBub3cudXRjbm93KCkuc3RyZnRpbWUoIiVZLSVtLSVkVCVIOiVNOiVTLiVmWiIpCiAgICAgICAgZGF0ZV90aW1lX2ZhY3RzWydpc284NjAxJ10gPSBub3cudXRjbm93KCkuc3RyZnRpbWUoIiVZLSVtLSVkVCVIOiVNOiVTWiIpCiAgICAgICAgZGF0ZV90aW1lX2ZhY3RzWydpc284NjAxX2Jhc2ljJ10gPSBub3cuc3RyZnRpbWUoIiVZJW0lZFQlSCVNJVMlZiIpCiAgICAgICAgZGF0ZV90aW1lX2ZhY3RzWydpc284NjAxX2Jhc2ljX3Nob3J0J10gPSBub3cuc3RyZnRpbWUoIiVZJW0lZFQlSCVNJVMiKQogICAgICAgIGRhdGVfdGltZV9mYWN0c1sndHonXSA9IHRpbWUuc3RyZnRpbWUoIiVaIikKICAgICAgICBkYXRlX3RpbWVfZmFjdHNbJ3R6X29mZnNldCddID0gdGltZS5zdHJmdGltZSgiJXoiKQoKICAgICAgICBmYWN0c19kaWN0WydkYXRlX3RpbWUnXSA9IGRhdGVfdGltZV9mYWN0cwogICAgICAgIHJldHVybiBmYWN0c19kaWN0ClBLAwQUAAAAAADLuytLxsfoKykHAAApBwAALAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3ZpcnR1YWwvbmV0YnNkLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCBvcwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy52aXJ0dWFsLmJhc2UgaW1wb3J0IFZpcnR1YWwsIFZpcnR1YWxDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy52aXJ0dWFsLnN5c2N0bCBpbXBvcnQgVmlydHVhbFN5c2N0bERldGVjdGlvbk1peGluCgoKY2xhc3MgTmV0QlNEVmlydHVhbChWaXJ0dWFsLCBWaXJ0dWFsU3lzY3RsRGV0ZWN0aW9uTWl4aW4pOgogICAgcGxhdGZvcm0gPSAnTmV0QlNEJwoKICAgIGRlZiBnZXRfdmlydHVhbF9mYWN0cyhzZWxmKToKICAgICAgICB2aXJ0dWFsX2ZhY3RzID0ge30KICAgICAgICAjIFNldCBlbXB0eSB2YWx1ZXMgYXMgZGVmYXVsdAogICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICcnCiAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJycKCiAgICAgICAgdmlydHVhbF9wcm9kdWN0X2ZhY3RzID0gc2VsZi5kZXRlY3RfdmlydF9wcm9kdWN0KCdtYWNoZGVwLmRtaS5zeXN0ZW0tcHJvZHVjdCcpCiAgICAgICAgdmlydHVhbF9mYWN0cy51cGRhdGUodmlydHVhbF9wcm9kdWN0X2ZhY3RzKQoKICAgICAgICBpZiB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPT0gJyc6CiAgICAgICAgICAgIHZpcnR1YWxfdmVuZG9yX2ZhY3RzID0gc2VsZi5kZXRlY3RfdmlydF92ZW5kb3IoJ21hY2hkZXAuZG1pLnN5c3RlbS12ZW5kb3InKQogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzLnVwZGF0ZSh2aXJ0dWFsX3ZlbmRvcl9mYWN0cykKCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoJy9kZXYveGVuY29ucycpOgogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAneGVuJwogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCgogICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgoKY2xhc3MgTmV0QlNEVmlydHVhbENvbGxlY3RvcihWaXJ0dWFsQ29sbGVjdG9yKToKICAgIF9mYWN0X2NsYXNzID0gTmV0QlNEVmlydHVhbAogICAgX3BsYXRmb3JtID0gJ05ldEJTRCcKUEsDBBQAAAAAAMu7K0vZr+y00gYAANIGAAArAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvaGFyZHdhcmUvYmFzZS5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmNvbGxlY3RvciBpbXBvcnQgQmFzZUZhY3RDb2xsZWN0b3IKCgpjbGFzcyBIYXJkd2FyZToKICAgIHBsYXRmb3JtID0gJ0dlbmVyaWMnCgogICAgIyBGSVhNRTogcmVtb3ZlIGxvYWRfb25faW5pdCB3aGVuIHdlIGNhbgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG1vZHVsZSwgbG9hZF9vbl9pbml0PUZhbHNlKToKICAgICAgICBzZWxmLm1vZHVsZSA9IG1vZHVsZQoKICAgIGRlZiBwb3B1bGF0ZShzZWxmLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgcmV0dXJuIHt9CgoKY2xhc3MgSGFyZHdhcmVDb2xsZWN0b3IoQmFzZUZhY3RDb2xsZWN0b3IpOgogICAgbmFtZSA9ICdoYXJkd2FyZScKICAgIF9mYWN0X2lkcyA9IHNldChbJ3Byb2Nlc3NvcicsCiAgICAgICAgICAgICAgICAgICAgICdwcm9jZXNzb3JfY29yZXMnLAogICAgICAgICAgICAgICAgICAgICAncHJvY2Vzc29yX2NvdW50JywKICAgICAgICAgICAgICAgICAgICAgIyBUT0RPOiBtb3VudHMgaXNudCBleGFjdGx5IGhhcmR3YXJlCiAgICAgICAgICAgICAgICAgICAgICdtb3VudHMnLAogICAgICAgICAgICAgICAgICAgICAnZGV2aWNlcyddKQogICAgX2ZhY3RfY2xhc3MgPSBIYXJkd2FyZQoKICAgIGRlZiBjb2xsZWN0KHNlbGYsIG1vZHVsZT1Ob25lLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgY29sbGVjdGVkX2ZhY3RzID0gY29sbGVjdGVkX2ZhY3RzIG9yIHt9CiAgICAgICAgaWYgbm90IG1vZHVsZToKICAgICAgICAgICAgcmV0dXJuIHt9CgogICAgICAgICMgTmV0d29yayBtdW5nZXMgY2FjaGVkX2ZhY3RzIGJ5IHNpZGUgZWZmZWN0LCBzbyBnaXZlIGl0IGEgY29weQogICAgICAgIGZhY3RzX29iaiA9IHNlbGYuX2ZhY3RfY2xhc3MobW9kdWxlKQoKICAgICAgICBmYWN0c19kaWN0ID0gZmFjdHNfb2JqLnBvcHVsYXRlKGNvbGxlY3RlZF9mYWN0cz1jb2xsZWN0ZWRfZmFjdHMpCgogICAgICAgIHJldHVybiBmYWN0c19kaWN0ClBLAwQUAAAAAADLuytLi4W7bh0GAAAdBgAALAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9jbWRsaW5lLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCBzaGxleAoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy51dGlscyBpbXBvcnQgZ2V0X2ZpbGVfY29udGVudAoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5jb2xsZWN0b3IgaW1wb3J0IEJhc2VGYWN0Q29sbGVjdG9yCgoKY2xhc3MgQ21kTGluZUZhY3RDb2xsZWN0b3IoQmFzZUZhY3RDb2xsZWN0b3IpOgogICAgbmFtZSA9ICdjbWRsaW5lJwogICAgX2ZhY3RfaWRzID0gc2V0KCkKCiAgICBkZWYgY29sbGVjdChzZWxmLCBtb2R1bGU9Tm9uZSwgY29sbGVjdGVkX2ZhY3RzPU5vbmUpOgogICAgICAgIGNtZGxpbmVfZmFjdHMgPSB7fQoKICAgICAgICBkYXRhID0gZ2V0X2ZpbGVfY29udGVudCgnL3Byb2MvY21kbGluZScpCgogICAgICAgIGlmIG5vdCBkYXRhOgogICAgICAgICAgICByZXR1cm4gY21kbGluZV9mYWN0cwoKICAgICAgICBjbWRsaW5lX2ZhY3RzWydjbWRsaW5lJ10gPSB7fQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvciBwaWVjZSBpbiBzaGxleC5zcGxpdChkYXRhKToKICAgICAgICAgICAgICAgIGl0ZW0gPSBwaWVjZS5zcGxpdCgnPScsIDEpCiAgICAgICAgICAgICAgICBpZiBsZW4oaXRlbSkgPT0gMToKICAgICAgICAgICAgICAgICAgICBjbWRsaW5lX2ZhY3RzWydjbWRsaW5lJ11baXRlbVswXV0gPSBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGNtZGxpbmVfZmFjdHNbJ2NtZGxpbmUnXVtpdGVtWzBdXSA9IGl0ZW1bMV0KICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICByZXR1cm4gY21kbGluZV9mYWN0cwpQSwMEFAAAAAAAy7srSz729In+GgAA/hoAAC4AAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9oYXJkd2FyZS9mcmVlYnNkLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmltcG9ydCBvcwppbXBvcnQganNvbgppbXBvcnQgcmUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuaGFyZHdhcmUuYmFzZSBpbXBvcnQgSGFyZHdhcmUsIEhhcmR3YXJlQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMudGltZW91dCBpbXBvcnQgVGltZW91dEVycm9yLCB0aW1lb3V0Cgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnV0aWxzIGltcG9ydCBnZXRfZmlsZV9jb250ZW50LCBnZXRfbW91bnRfc2l6ZQoKCmNsYXNzIEZyZWVCU0RIYXJkd2FyZShIYXJkd2FyZSk6CiAgICAiIiIKICAgIEZyZWVCU0Qtc3BlY2lmaWMgc3ViY2xhc3Mgb2YgSGFyZHdhcmUuICBEZWZpbmVzIG1lbW9yeSBhbmQgQ1BVIGZhY3RzOgogICAgLSBtZW1mcmVlX21iCiAgICAtIG1lbXRvdGFsX21iCiAgICAtIHN3YXBmcmVlX21iCiAgICAtIHN3YXB0b3RhbF9tYgogICAgLSBwcm9jZXNzb3IgKGEgbGlzdCkKICAgIC0gcHJvY2Vzc29yX2NvcmVzCiAgICAtIHByb2Nlc3Nvcl9jb3VudAogICAgLSBkZXZpY2VzCiAgICAiIiIKICAgIHBsYXRmb3JtID0gJ0ZyZWVCU0QnCiAgICBETUVTR19CT09UID0gJy92YXIvcnVuL2RtZXNnLmJvb3QnCgogICAgZGVmIHBvcHVsYXRlKHNlbGYsIGNvbGxlY3RlZF9mYWN0cz1Ob25lKToKICAgICAgICBoYXJkd2FyZV9mYWN0cyA9IHt9CgogICAgICAgIGNwdV9mYWN0cyA9IHNlbGYuZ2V0X2NwdV9mYWN0cygpCiAgICAgICAgbWVtb3J5X2ZhY3RzID0gc2VsZi5nZXRfbWVtb3J5X2ZhY3RzKCkKICAgICAgICBkbWlfZmFjdHMgPSBzZWxmLmdldF9kbWlfZmFjdHMoKQogICAgICAgIGRldmljZV9mYWN0cyA9IHNlbGYuZ2V0X2RldmljZV9mYWN0cygpCgogICAgICAgIG1vdW50X2ZhY3RzID0ge30KICAgICAgICB0cnk6CiAgICAgICAgICAgIG1vdW50X2ZhY3RzID0gc2VsZi5nZXRfbW91bnRfZmFjdHMoKQogICAgICAgIGV4Y2VwdCBUaW1lb3V0RXJyb3I6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKGNwdV9mYWN0cykKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUobWVtb3J5X2ZhY3RzKQogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShkbWlfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKGRldmljZV9mYWN0cykKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUobW91bnRfZmFjdHMpCgogICAgICAgIHJldHVybiBoYXJkd2FyZV9mYWN0cwoKICAgIGRlZiBnZXRfY3B1X2ZhY3RzKHNlbGYpOgogICAgICAgIGNwdV9mYWN0cyA9IHt9CiAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3InXSA9IFtdCiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi9zYmluL3N5c2N0bCAtbiBody5uY3B1IikKICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3Nvcl9jb3VudCddID0gb3V0LnN0cmlwKCkKCiAgICAgICAgZG1lc2dfYm9vdCA9IGdldF9maWxlX2NvbnRlbnQoRnJlZUJTREhhcmR3YXJlLkRNRVNHX0JPT1QpCiAgICAgICAgaWYgbm90IGRtZXNnX2Jvb3Q6CiAgICAgICAgICAgIHJjLCBkbWVzZ19ib290LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiL3NiaW4vZG1lc2ciKQogICAgICAgIGZvciBsaW5lIGluIGRtZXNnX2Jvb3Quc3BsaXRsaW5lcygpOgogICAgICAgICAgICBpZiAnQ1BVOicgaW4gbGluZToKICAgICAgICAgICAgICAgIGNwdSA9IHJlLnN1YihyJ0NQVTpccysnLCByIiIsIGxpbmUpCiAgICAgICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3NvciddLmFwcGVuZChjcHUuc3RyaXAoKSkKICAgICAgICAgICAgaWYgJ0xvZ2ljYWwgQ1BVcyBwZXIgY29yZScgaW4gbGluZToKICAgICAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yX2NvcmVzJ10gPSBsaW5lLnNwbGl0KClbNF0KCiAgICAgICAgcmV0dXJuIGNwdV9mYWN0cwoKICAgIGRlZiBnZXRfbWVtb3J5X2ZhY3RzKHNlbGYpOgogICAgICAgIG1lbW9yeV9mYWN0cyA9IHt9CgogICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvc2Jpbi9zeXNjdGwgdm0uc3RhdHMiKQogICAgICAgIGZvciBsaW5lIGluIG91dC5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgIGRhdGEgPSBsaW5lLnNwbGl0KCkKICAgICAgICAgICAgaWYgJ3ZtLnN0YXRzLnZtLnZfcGFnZV9zaXplJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgcGFnZXNpemUgPSBpbnQoZGF0YVsxXSkKICAgICAgICAgICAgaWYgJ3ZtLnN0YXRzLnZtLnZfcGFnZV9jb3VudCcgaW4gbGluZToKICAgICAgICAgICAgICAgIHBhZ2Vjb3VudCA9IGludChkYXRhWzFdKQogICAgICAgICAgICBpZiAndm0uc3RhdHMudm0udl9mcmVlX2NvdW50JyBpbiBsaW5lOgogICAgICAgICAgICAgICAgZnJlZWNvdW50ID0gaW50KGRhdGFbMV0pCiAgICAgICAgbWVtb3J5X2ZhY3RzWydtZW10b3RhbF9tYiddID0gcGFnZXNpemUgKiBwYWdlY291bnQgLy8gMTAyNCAvLyAxMDI0CiAgICAgICAgbWVtb3J5X2ZhY3RzWydtZW1mcmVlX21iJ10gPSBwYWdlc2l6ZSAqIGZyZWVjb3VudCAvLyAxMDI0IC8vIDEwMjQKICAgICAgICAjIEdldCBzd2FwaW5mby4gIHN3YXBpbmZvIG91dHB1dCBsb29rcyBsaWtlOgogICAgICAgICMgRGV2aWNlICAgICAgICAgIDFNLWJsb2NrcyAgICAgVXNlZCAgICBBdmFpbCBDYXBhY2l0eQogICAgICAgICMgL2Rldi9hZGEwcDMgICAgICAgIDMxNDM2OCAgICAgICAgMCAgIDMxNDM2OCAgICAgMCUKICAgICAgICAjCiAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIi91c3Ivc2Jpbi9zd2FwaW5mbyAtayIpCiAgICAgICAgbGluZXMgPSBvdXQuc3BsaXRsaW5lcygpCiAgICAgICAgaWYgbGVuKGxpbmVzWy0xXSkgPT0gMDoKICAgICAgICAgICAgbGluZXMucG9wKCkKICAgICAgICBkYXRhID0gbGluZXNbLTFdLnNwbGl0KCkKICAgICAgICBpZiBkYXRhWzBdICE9ICdEZXZpY2UnOgogICAgICAgICAgICBtZW1vcnlfZmFjdHNbJ3N3YXB0b3RhbF9tYiddID0gaW50KGRhdGFbMV0pIC8vIDEwMjQKICAgICAgICAgICAgbWVtb3J5X2ZhY3RzWydzd2FwZnJlZV9tYiddID0gaW50KGRhdGFbM10pIC8vIDEwMjQKCiAgICAgICAgcmV0dXJuIG1lbW9yeV9mYWN0cwoKICAgIEB0aW1lb3V0KCkKICAgIGRlZiBnZXRfbW91bnRfZmFjdHMoc2VsZik6CiAgICAgICAgbW91bnRfZmFjdHMgPSB7fQoKICAgICAgICBtb3VudF9mYWN0c1snbW91bnRzJ10gPSBbXQogICAgICAgIGZzdGFiID0gZ2V0X2ZpbGVfY29udGVudCgnL2V0Yy9mc3RhYicpCiAgICAgICAgaWYgZnN0YWI6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGZzdGFiLnNwbGl0bGluZXMoKToKICAgICAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCgnIycpIG9yIGxpbmUuc3RyaXAoKSA9PSAnJzoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZmllbGRzID0gcmUuc3ViKHInXHMrJywgJyAnLCBsaW5lKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBzaXplX3RvdGFsLCBzaXplX2F2YWlsYWJsZSA9IGdldF9tb3VudF9zaXplKGZpZWxkc1sxXSkKICAgICAgICAgICAgICAgIG1vdW50X2ZhY3RzWydtb3VudHMnXS5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICdtb3VudCc6IGZpZWxkc1sxXSwKICAgICAgICAgICAgICAgICAgICAnZGV2aWNlJzogZmllbGRzWzBdLAogICAgICAgICAgICAgICAgICAgICdmc3R5cGUnOiBmaWVsZHNbMl0sCiAgICAgICAgICAgICAgICAgICAgJ29wdGlvbnMnOiBmaWVsZHNbM10sCiAgICAgICAgICAgICAgICAgICAgJ3NpemVfdG90YWwnOiBzaXplX3RvdGFsLAogICAgICAgICAgICAgICAgICAgICdzaXplX2F2YWlsYWJsZSc6IHNpemVfYXZhaWxhYmxlCiAgICAgICAgICAgICAgICB9KQoKICAgICAgICByZXR1cm4gbW91bnRfZmFjdHMKCiAgICBkZWYgZ2V0X2RldmljZV9mYWN0cyhzZWxmKToKICAgICAgICBkZXZpY2VfZmFjdHMgPSB7fQoKICAgICAgICBzeXNkaXIgPSAnL2RldicKICAgICAgICBkZXZpY2VfZmFjdHNbJ2RldmljZXMnXSA9IHt9CiAgICAgICAgZHJpdmVzID0gcmUuY29tcGlsZSgnKGFkYT9cZCt8ZGFcZCt8YT9jZFxkKyknKSAgIyBUT0RPOiByYywgZGlza3MsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKCIvc2Jpbi9zeXNjdGwga2Vybi5kaXNrcyIpCiAgICAgICAgc2xpY2VzID0gcmUuY29tcGlsZSgnKGFkYT9cZCtzXGQrXHcqfGRhXGQrc1xkK1x3KiknKQogICAgICAgIGlmIG9zLnBhdGguaXNkaXIoc3lzZGlyKToKICAgICAgICAgICAgZGlybGlzdCA9IHNvcnRlZChvcy5saXN0ZGlyKHN5c2RpcikpCiAgICAgICAgICAgIGZvciBkZXZpY2UgaW4gZGlybGlzdDoKICAgICAgICAgICAgICAgIGQgPSBkcml2ZXMubWF0Y2goZGV2aWNlKQogICAgICAgICAgICAgICAgaWYgZDoKICAgICAgICAgICAgICAgICAgICBkZXZpY2VfZmFjdHNbJ2RldmljZXMnXVtkLmdyb3VwKDEpXSA9IFtdCiAgICAgICAgICAgICAgICBzID0gc2xpY2VzLm1hdGNoKGRldmljZSkKICAgICAgICAgICAgICAgIGlmIHM6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2ZhY3RzWydkZXZpY2VzJ11bZC5ncm91cCgxKV0uYXBwZW5kKHMuZ3JvdXAoMSkpCgogICAgICAgIHJldHVybiBkZXZpY2VfZmFjdHMKCiAgICBkZWYgZ2V0X2RtaV9mYWN0cyhzZWxmKToKICAgICAgICAnJycgbGVhcm4gZG1pIGZhY3RzIGZyb20gc3lzdGVtCgogICAgICAgIFVzZSBkbWlkZWNvZGUgZXhlY3V0YWJsZSBpZiBhdmFpbGFibGUnJycKCiAgICAgICAgZG1pX2ZhY3RzID0ge30KCiAgICAgICAgIyBGYWxsIGJhY2sgdG8gdXNpbmcgZG1pZGVjb2RlLCBpZiBhdmFpbGFibGUKICAgICAgICBkbWlfYmluID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCdkbWlkZWNvZGUnKQogICAgICAgIERNSV9ESUNUID0gZGljdCgKICAgICAgICAgICAgYmlvc19kYXRlPSdiaW9zLXJlbGVhc2UtZGF0ZScsCiAgICAgICAgICAgIGJpb3NfdmVyc2lvbj0nYmlvcy12ZXJzaW9uJywKICAgICAgICAgICAgZm9ybV9mYWN0b3I9J2NoYXNzaXMtdHlwZScsCiAgICAgICAgICAgIHByb2R1Y3RfbmFtZT0nc3lzdGVtLXByb2R1Y3QtbmFtZScsCiAgICAgICAgICAgIHByb2R1Y3Rfc2VyaWFsPSdzeXN0ZW0tc2VyaWFsLW51bWJlcicsCiAgICAgICAgICAgIHByb2R1Y3RfdXVpZD0nc3lzdGVtLXV1aWQnLAogICAgICAgICAgICBwcm9kdWN0X3ZlcnNpb249J3N5c3RlbS12ZXJzaW9uJywKICAgICAgICAgICAgc3lzdGVtX3ZlbmRvcj0nc3lzdGVtLW1hbnVmYWN0dXJlcicKICAgICAgICApCiAgICAgICAgZm9yIChrLCB2KSBpbiBETUlfRElDVC5pdGVtcygpOgogICAgICAgICAgICBpZiBkbWlfYmluIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgKHJjLCBvdXQsIGVycikgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgnJXMgLXMgJXMnICUgKGRtaV9iaW4sIHYpKQogICAgICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgICAgICAjIFN0cmlwIG91dCBjb21tZW50ZWQgbGluZXMgKHNwZWNpZmljIGRtaWRlY29kZSBvdXRwdXQpCiAgICAgICAgICAgICAgICAgICAgIyBGSVhNRTogd2h5IGFkZCB0aGUgZmFjdCBhbmQgdGhlbiB0ZXN0IGlmIGl0IGlzIGpzb24/CiAgICAgICAgICAgICAgICAgICAgZG1pX2ZhY3RzW2tdID0gJycuam9pbihbbGluZSBmb3IgbGluZSBpbiBvdXQuc3BsaXRsaW5lcygpIGlmIG5vdCBsaW5lLnN0YXJ0c3dpdGgoJyMnKV0pCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBqc29uLmR1bXBzKGRtaV9mYWN0c1trXSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgVW5pY29kZURlY29kZUVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICBkbWlfZmFjdHNba10gPSAnTkEnCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGRtaV9mYWN0c1trXSA9ICdOQScKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGRtaV9mYWN0c1trXSA9ICdOQScKCiAgICAgICAgcmV0dXJuIGRtaV9mYWN0cwoKCmNsYXNzIEZyZWVCU0RIYXJkd2FyZUNvbGxlY3RvcihIYXJkd2FyZUNvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IEZyZWVCU0RIYXJkd2FyZQogICAgX3BsYXRmb3JtID0gJ0ZyZWVCU0QnClBLAwQUAAAAAADLuytLN+Ui4QkHAAAJBwAALAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL25ldHdvcmsvbmV0YnNkLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5iYXNlIGltcG9ydCBOZXR3b3JrQ29sbGVjdG9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMubmV0d29yay5nZW5lcmljX2JzZCBpbXBvcnQgR2VuZXJpY0JzZElmY29uZmlnTmV0d29yawoKCmNsYXNzIE5ldEJTRE5ldHdvcmsoR2VuZXJpY0JzZElmY29uZmlnTmV0d29yayk6CiAgICAiIiIKICAgIFRoaXMgaXMgdGhlIE5ldEJTRCBOZXR3b3JrIENsYXNzLgogICAgSXQgdXNlcyB0aGUgR2VuZXJpY0JzZElmY29uZmlnTmV0d29yawogICAgIiIiCiAgICBwbGF0Zm9ybSA9ICdOZXRCU0QnCgogICAgZGVmIHBhcnNlX21lZGlhX2xpbmUoc2VsZiwgd29yZHMsIGN1cnJlbnRfaWYsIGlwcyk6CiAgICAgICAgIyBleGFtcGxlIG9mIGxpbmU6CiAgICAgICAgIyAkIGlmY29uZmlnCiAgICAgICAgIyBuZTA6IGZsYWdzPTg4NjM8VVAsQlJPQURDQVNULE5PVFJBSUxFUlMsUlVOTklORyxTSU1QTEVYLE1VTFRJQ0FTVD4gbXR1IDE1MDAKICAgICAgICAjICAgIGVjX2NhcGFiaWxpdGllcz0xPFZMQU5fTVRVPgogICAgICAgICMgICAgZWNfZW5hYmxlZD0wCiAgICAgICAgIyAgICBhZGRyZXNzOiAwMDoyMDo5MTo0NTowMDo3OAogICAgICAgICMgICAgbWVkaWE6IEV0aGVybmV0IDEwYmFzZVQgZnVsbC1kdXBsZXgKICAgICAgICAjICAgIGluZXQgMTkyLjE2OC4xNTYuMjkgbmV0bWFzayAweGZmZmZmZjAwIGJyb2FkY2FzdCAxOTIuMTY4LjE1Ni4yNTUKICAgICAgICBjdXJyZW50X2lmWydtZWRpYSddID0gd29yZHNbMV0KICAgICAgICBpZiBsZW4od29yZHMpID4gMjoKICAgICAgICAgICAgY3VycmVudF9pZlsnbWVkaWFfdHlwZSddID0gd29yZHNbMl0KICAgICAgICBpZiBsZW4od29yZHMpID4gMzoKICAgICAgICAgICAgY3VycmVudF9pZlsnbWVkaWFfb3B0aW9ucyddID0gd29yZHNbM10uc3BsaXQoJywnKQoKCmNsYXNzIE5ldEJTRE5ldHdvcmtDb2xsZWN0b3IoTmV0d29ya0NvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IE5ldEJTRE5ldHdvcmsKICAgIF9wbGF0Zm9ybSA9ICdOZXRCU0QnClBLAwQUAAAAAADLuytL6IhCdOsVAADrFQAALQAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL2hhcmR3YXJlL25ldGJzZC5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgppbXBvcnQgb3MKaW1wb3J0IHJlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5tb3ZlcyBpbXBvcnQgcmVkdWNlCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmhhcmR3YXJlLmJhc2UgaW1wb3J0IEhhcmR3YXJlLCBIYXJkd2FyZUNvbGxlY3Rvcgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLnRpbWVvdXQgaW1wb3J0IFRpbWVvdXRFcnJvciwgdGltZW91dAoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy51dGlscyBpbXBvcnQgZ2V0X2ZpbGVfY29udGVudCwgZ2V0X2ZpbGVfbGluZXMsIGdldF9tb3VudF9zaXplCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuc3lzY3RsIGltcG9ydCBnZXRfc3lzY3RsCgoKY2xhc3MgTmV0QlNESGFyZHdhcmUoSGFyZHdhcmUpOgogICAgIiIiCiAgICBOZXRCU0Qtc3BlY2lmaWMgc3ViY2xhc3Mgb2YgSGFyZHdhcmUuICBEZWZpbmVzIG1lbW9yeSBhbmQgQ1BVIGZhY3RzOgogICAgLSBtZW1mcmVlX21iCiAgICAtIG1lbXRvdGFsX21iCiAgICAtIHN3YXBmcmVlX21iCiAgICAtIHN3YXB0b3RhbF9tYgogICAgLSBwcm9jZXNzb3IgKGEgbGlzdCkKICAgIC0gcHJvY2Vzc29yX2NvcmVzCiAgICAtIHByb2Nlc3Nvcl9jb3VudAogICAgLSBkZXZpY2VzCiAgICAiIiIKICAgIHBsYXRmb3JtID0gJ05ldEJTRCcKICAgIE1FTU9SWV9GQUNUUyA9IFsnTWVtVG90YWwnLCAnU3dhcFRvdGFsJywgJ01lbUZyZWUnLCAnU3dhcEZyZWUnXQoKICAgIGRlZiBwb3B1bGF0ZShzZWxmLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgaGFyZHdhcmVfZmFjdHMgPSB7fQogICAgICAgIHNlbGYuc3lzY3RsID0gZ2V0X3N5c2N0bChzZWxmLm1vZHVsZSwgWydtYWNoZGVwJ10pCiAgICAgICAgY3B1X2ZhY3RzID0gc2VsZi5nZXRfY3B1X2ZhY3RzKCkKICAgICAgICBtZW1vcnlfZmFjdHMgPSBzZWxmLmdldF9tZW1vcnlfZmFjdHMoKQoKICAgICAgICBtb3VudF9mYWN0cyA9IHt9CiAgICAgICAgdHJ5OgogICAgICAgICAgICBtb3VudF9mYWN0cyA9IHNlbGYuZ2V0X21vdW50X2ZhY3RzKCkKICAgICAgICBleGNlcHQgVGltZW91dEVycm9yOgogICAgICAgICAgICBwYXNzCgogICAgICAgIGRtaV9mYWN0cyA9IHNlbGYuZ2V0X2RtaV9mYWN0cygpCgogICAgICAgIGhhcmR3YXJlX2ZhY3RzLnVwZGF0ZShjcHVfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKG1lbW9yeV9mYWN0cykKICAgICAgICBoYXJkd2FyZV9mYWN0cy51cGRhdGUobW91bnRfZmFjdHMpCiAgICAgICAgaGFyZHdhcmVfZmFjdHMudXBkYXRlKGRtaV9mYWN0cykKCiAgICAgICAgcmV0dXJuIGhhcmR3YXJlX2ZhY3RzCgogICAgZGVmIGdldF9jcHVfZmFjdHMoc2VsZik6CiAgICAgICAgY3B1X2ZhY3RzID0ge30KCiAgICAgICAgaSA9IDAKICAgICAgICBwaHlzaWQgPSAwCiAgICAgICAgc29ja2V0cyA9IHt9CiAgICAgICAgaWYgbm90IG9zLmFjY2VzcygiL3Byb2MvY3B1aW5mbyIsIG9zLlJfT0spOgogICAgICAgICAgICByZXR1cm4gY3B1X2ZhY3RzCiAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3InXSA9IFtdCiAgICAgICAgZm9yIGxpbmUgaW4gZ2V0X2ZpbGVfbGluZXMoIi9wcm9jL2NwdWluZm8iKToKICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3BsaXQoIjoiLCAxKQogICAgICAgICAgICBrZXkgPSBkYXRhWzBdLnN0cmlwKCkKICAgICAgICAgICAgIyBtb2RlbCBuYW1lIGlzIGZvciBJbnRlbCBhcmNoLCBQcm9jZXNzb3IgKG1pbmQgdGhlIHVwcGVyY2FzZSBQKQogICAgICAgICAgICAjIHdvcmtzIGZvciBzb21lIEFSTSBkZXZpY2VzLCBsaWtlIHRoZSBTaGVldmFwbHVnLgogICAgICAgICAgICBpZiBrZXkgPT0gJ21vZGVsIG5hbWUnIG9yIGtleSA9PSAnUHJvY2Vzc29yJzoKICAgICAgICAgICAgICAgIGlmICdwcm9jZXNzb3InIG5vdCBpbiBjcHVfZmFjdHM6CiAgICAgICAgICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3InXSA9IFtdCiAgICAgICAgICAgICAgICBjcHVfZmFjdHNbJ3Byb2Nlc3NvciddLmFwcGVuZChkYXRhWzFdLnN0cmlwKCkpCiAgICAgICAgICAgICAgICBpICs9IDEKICAgICAgICAgICAgZWxpZiBrZXkgPT0gJ3BoeXNpY2FsIGlkJzoKICAgICAgICAgICAgICAgIHBoeXNpZCA9IGRhdGFbMV0uc3RyaXAoKQogICAgICAgICAgICAgICAgaWYgcGh5c2lkIG5vdCBpbiBzb2NrZXRzOgogICAgICAgICAgICAgICAgICAgIHNvY2tldHNbcGh5c2lkXSA9IDEKICAgICAgICAgICAgZWxpZiBrZXkgPT0gJ2NwdSBjb3Jlcyc6CiAgICAgICAgICAgICAgICBzb2NrZXRzW3BoeXNpZF0gPSBpbnQoZGF0YVsxXS5zdHJpcCgpKQogICAgICAgIGlmIGxlbihzb2NrZXRzKSA+IDA6CiAgICAgICAgICAgIGNwdV9mYWN0c1sncHJvY2Vzc29yX2NvdW50J10gPSBsZW4oc29ja2V0cykKICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY29yZXMnXSA9IHJlZHVjZShsYW1iZGEgeCwgeTogeCArIHksIHNvY2tldHMudmFsdWVzKCkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY291bnQnXSA9IGkKICAgICAgICAgICAgY3B1X2ZhY3RzWydwcm9jZXNzb3JfY29yZXMnXSA9ICdOQScKCiAgICAgICAgcmV0dXJuIGNwdV9mYWN0cwoKICAgIGRlZiBnZXRfbWVtb3J5X2ZhY3RzKHNlbGYpOgogICAgICAgIG1lbW9yeV9mYWN0cyA9IHt9CiAgICAgICAgaWYgbm90IG9zLmFjY2VzcygiL3Byb2MvbWVtaW5mbyIsIG9zLlJfT0spOgogICAgICAgICAgICByZXR1cm4gbWVtb3J5X2ZhY3RzCiAgICAgICAgZm9yIGxpbmUgaW4gZ2V0X2ZpbGVfbGluZXMoIi9wcm9jL21lbWluZm8iKToKICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3BsaXQoIjoiLCAxKQogICAgICAgICAgICBrZXkgPSBkYXRhWzBdCiAgICAgICAgICAgIGlmIGtleSBpbiBOZXRCU0RIYXJkd2FyZS5NRU1PUllfRkFDVFM6CiAgICAgICAgICAgICAgICB2YWwgPSBkYXRhWzFdLnN0cmlwKCkuc3BsaXQoJyAnKVswXQogICAgICAgICAgICAgICAgbWVtb3J5X2ZhY3RzWyIlc19tYiIgJSBrZXkubG93ZXIoKV0gPSBpbnQodmFsKSAvLyAxMDI0CgogICAgICAgIHJldHVybiBtZW1vcnlfZmFjdHMKCiAgICBAdGltZW91dCgpCiAgICBkZWYgZ2V0X21vdW50X2ZhY3RzKHNlbGYpOgogICAgICAgIG1vdW50X2ZhY3RzID0ge30KCiAgICAgICAgbW91bnRfZmFjdHNbJ21vdW50cyddID0gW10KICAgICAgICBmc3RhYiA9IGdldF9maWxlX2NvbnRlbnQoJy9ldGMvZnN0YWInKQoKICAgICAgICBpZiBub3QgZnN0YWI6CiAgICAgICAgICAgIHJldHVybiBtb3VudF9mYWN0cwoKICAgICAgICBmb3IgbGluZSBpbiBmc3RhYi5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCgnIycpIG9yIGxpbmUuc3RyaXAoKSA9PSAnJzoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGZpZWxkcyA9IHJlLnN1YihyJ1xzKycsICcgJywgbGluZSkuc3BsaXQoKQogICAgICAgICAgICBzaXplX3RvdGFsLCBzaXplX2F2YWlsYWJsZSA9IGdldF9tb3VudF9zaXplKGZpZWxkc1sxXSkKICAgICAgICAgICAgbW91bnRfZmFjdHNbJ21vdW50cyddLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAnbW91bnQnOiBmaWVsZHNbMV0sCiAgICAgICAgICAgICAgICAnZGV2aWNlJzogZmllbGRzWzBdLAogICAgICAgICAgICAgICAgJ2ZzdHlwZSc6IGZpZWxkc1syXSwKICAgICAgICAgICAgICAgICdvcHRpb25zJzogZmllbGRzWzNdLAogICAgICAgICAgICAgICAgJ3NpemVfdG90YWwnOiBzaXplX3RvdGFsLAogICAgICAgICAgICAgICAgJ3NpemVfYXZhaWxhYmxlJzogc2l6ZV9hdmFpbGFibGUKICAgICAgICAgICAgfSkKICAgICAgICByZXR1cm4gbW91bnRfZmFjdHMKCiAgICBkZWYgZ2V0X2RtaV9mYWN0cyhzZWxmKToKICAgICAgICBkbWlfZmFjdHMgPSB7fQogICAgICAgICMgV2UgZG9uJ3QgdXNlIGRtaWRlY29kZSgxKSBoZXJlIGJlY2F1c2U6CiAgICAgICAgIyAtIGl0IHdvdWxkIGFkZCBkZXBlbmRlbmN5IG9uIGFuIGV4dGVybmFsIHBhY2thZ2UKICAgICAgICAjIC0gZG1pZGVjb2RlKDEpIGNhbiBvbmx5IGJlIHJhbiBhcyByb290CiAgICAgICAgIyBTbyBpbnN0ZWFkIHdlIHJlbHkgb24gc3lzY3RsKDgpIHRvIHByb3ZpZGUgdXMgdGhlIGluZm9ybWF0aW9uIG9uIGEKICAgICAgICAjIGJlc3QtZWZmb3J0IGJhc2lzLiBBcyBhIGJvbnVzIHdlIGFsc28gZ2V0IGZhY3RzIG9uIG5vbi1hbWQ2NC9pMzg2CiAgICAgICAgIyBwbGF0Zm9ybXMgdGhpcyB3YXkuCiAgICAgICAgc3lzY3RsX3RvX2RtaSA9IHsKICAgICAgICAgICAgJ21hY2hkZXAuZG1pLnN5c3RlbS1wcm9kdWN0JzogJ3Byb2R1Y3RfbmFtZScsCiAgICAgICAgICAgICdtYWNoZGVwLmRtaS5zeXN0ZW0tdmVyc2lvbic6ICdwcm9kdWN0X3ZlcnNpb24nLAogICAgICAgICAgICAnbWFjaGRlcC5kbWkuc3lzdGVtLXV1aWQnOiAncHJvZHVjdF91dWlkJywKICAgICAgICAgICAgJ21hY2hkZXAuZG1pLnN5c3RlbS1zZXJpYWwnOiAncHJvZHVjdF9zZXJpYWwnLAogICAgICAgICAgICAnbWFjaGRlcC5kbWkuc3lzdGVtLXZlbmRvcic6ICdzeXN0ZW1fdmVuZG9yJywKICAgICAgICB9CgogICAgICAgIGZvciBtaWIgaW4gc3lzY3RsX3RvX2RtaToKICAgICAgICAgICAgaWYgbWliIGluIHNlbGYuc3lzY3RsOgogICAgICAgICAgICAgICAgZG1pX2ZhY3RzW3N5c2N0bF90b19kbWlbbWliXV0gPSBzZWxmLnN5c2N0bFttaWJdCgogICAgICAgIHJldHVybiBkbWlfZmFjdHMKCgpjbGFzcyBOZXRCU0RIYXJkd2FyZUNvbGxlY3RvcihIYXJkd2FyZUNvbGxlY3Rvcik6CiAgICBfZmFjdF9jbGFzcyA9IE5ldEJTREhhcmR3YXJlCiAgICBfcGxhdGZvcm0gPSAnTmV0QlNEJwpQSwMEFAAAAAAAy7srS/B4UllpCAAAaQgAACkAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9zeXN0ZW0vY2Fwcy5weSMgQ29sbGVjdCBmYWN0cyByZWxhdGVkIHRvIHN5c3RlbXMgJ2NhcGFiaWxpdGllcycgdmlhIGNhcHNoCiMKIyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IChhYnNvbHV0ZV9pbXBvcnQsIGRpdmlzaW9uLCBwcmludF9mdW5jdGlvbikKX19tZXRhY2xhc3NfXyA9IHR5cGUKCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLmNvbGxlY3RvciBpbXBvcnQgQmFzZUZhY3RDb2xsZWN0b3IKCgpjbGFzcyBTeXN0ZW1DYXBhYmlsaXRpZXNGYWN0Q29sbGVjdG9yKEJhc2VGYWN0Q29sbGVjdG9yKToKICAgIG5hbWUgPSAnY2FwcycKICAgIF9mYWN0X2lkcyA9IHNldChbJ3N5c3RlbV9jYXBhYmlsaXRpZXMnLAogICAgICAgICAgICAgICAgICAgICAnc3lzdGVtX2NhcGFiaWxpdGllc19lbmZvcmNlZCddKQoKICAgIGRlZiBjb2xsZWN0KHNlbGYsIG1vZHVsZT1Ob25lLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgZmFjdHNfZGljdCA9IHt9CiAgICAgICAgaWYgbm90IG1vZHVsZToKICAgICAgICAgICAgcmV0dXJuIGZhY3RzX2RpY3QKCiAgICAgICAgY2Fwc2hfcGF0aCA9IG1vZHVsZS5nZXRfYmluX3BhdGgoJ2NhcHNoJykKICAgICAgICAjIE5PVEU6IGVhcmx5IGV4aXQgJ2lmIG5vdCBjcmFzaF9wYXRoJyBhbmQgdW5pbmRlbnQgcmVzdCBvZiBtZXRob2QgLWFrbAogICAgICAgIGlmIGNhcHNoX3BhdGg6CiAgICAgICAgICAgICMgTk9URTogLT4gZ2V0X2NhcHNfZGF0YSgpL3BhcnNlX2NhcHNfZGF0YSgpIGZvciBlYXNpZXIgbW9ja2luZyAtYWtsCiAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IG1vZHVsZS5ydW5fY29tbWFuZChbY2Fwc2hfcGF0aCwgIi0tcHJpbnQiXSwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykKICAgICAgICAgICAgZW5mb3JjZWRfY2FwcyA9IFtdCiAgICAgICAgICAgIGVuZm9yY2VkID0gJ05BJwogICAgICAgICAgICBmb3IgbGluZSBpbiBvdXQuc3BsaXRsaW5lcygpOgogICAgICAgICAgICAgICAgaWYgbGVuKGxpbmUpIDwgMToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgaWYgbGluZS5zdGFydHN3aXRoKCdDdXJyZW50OicpOgogICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuc3BsaXQoJzonKVsxXS5zdHJpcCgpID09ICc9ZXAnOgogICAgICAgICAgICAgICAgICAgICAgICBlbmZvcmNlZCA9ICdGYWxzZScKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBlbmZvcmNlZCA9ICdUcnVlJwogICAgICAgICAgICAgICAgICAgICAgICBlbmZvcmNlZF9jYXBzID0gW2kuc3RyaXAoKSBmb3IgaSBpbiBsaW5lLnNwbGl0KCc9JylbMV0uc3BsaXQoJywnKV0KCiAgICAgICAgICAgIGZhY3RzX2RpY3RbJ3N5c3RlbV9jYXBhYmlsaXRpZXNfZW5mb3JjZWQnXSA9IGVuZm9yY2VkCiAgICAgICAgICAgIGZhY3RzX2RpY3RbJ3N5c3RlbV9jYXBhYmlsaXRpZXMnXSA9IGVuZm9yY2VkX2NhcHMKCiAgICAgICAgcmV0dXJuIGZhY3RzX2RpY3QKUEsDBBQAAAAAAMu7K0tX8UsNkgQAAJIEAAAoAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvc3lzdGVtL2Vudi5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgppbXBvcnQgb3MKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGltcG9ydCBpdGVyaXRlbXMKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuZmFjdHMuY29sbGVjdG9yIGltcG9ydCBCYXNlRmFjdENvbGxlY3RvcgoKCmNsYXNzIEVudkZhY3RDb2xsZWN0b3IoQmFzZUZhY3RDb2xsZWN0b3IpOgogICAgbmFtZSA9ICdlbnYnCiAgICBfZmFjdF9pZHMgPSBzZXQoKQoKICAgIGRlZiBjb2xsZWN0KHNlbGYsIG1vZHVsZT1Ob25lLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgZW52X2ZhY3RzID0ge30KICAgICAgICBlbnZfZmFjdHNbJ2VudiddID0ge30KCiAgICAgICAgZm9yIGssIHYgaW4gaXRlcml0ZW1zKG9zLmVudmlyb24pOgogICAgICAgICAgICBlbnZfZmFjdHNbJ2VudiddW2tdID0gdgoKICAgICAgICByZXR1cm4gZW52X2ZhY3RzClBLAwQUAAAAAADLuytLgz8pN/0lAAD9JQAAKwAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3ZpcnR1YWwvbGludXgucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKaW1wb3J0IGdsb2IKaW1wb3J0IG9zCmltcG9ydCByZQoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy52aXJ0dWFsLmJhc2UgaW1wb3J0IFZpcnR1YWwsIFZpcnR1YWxDb2xsZWN0b3IKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy51dGlscyBpbXBvcnQgZ2V0X2ZpbGVfY29udGVudCwgZ2V0X2ZpbGVfbGluZXMKCgpjbGFzcyBMaW51eFZpcnR1YWwoVmlydHVhbCk6CiAgICAiIiIKICAgIFRoaXMgaXMgYSBMaW51eC1zcGVjaWZpYyBzdWJjbGFzcyBvZiBWaXJ0dWFsLiAgSXQgZGVmaW5lcwogICAgLSB2aXJ0dWFsaXphdGlvbl90eXBlCiAgICAtIHZpcnR1YWxpemF0aW9uX3JvbGUKICAgICIiIgogICAgcGxhdGZvcm0gPSAnTGludXgnCgogICAgIyBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgY2hlY2s6IGh0dHA6Ly9wZW9wbGUucmVkaGF0LmNvbS9+cmpvbmVzL3ZpcnQtd2hhdC8KICAgIGRlZiBnZXRfdmlydHVhbF9mYWN0cyhzZWxmKToKICAgICAgICB2aXJ0dWFsX2ZhY3RzID0ge30KICAgICAgICAjIGx4Yy9kb2NrZXIKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cygnL3Byb2MvMS9jZ3JvdXAnKToKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZ2V0X2ZpbGVfbGluZXMoJy9wcm9jLzEvY2dyb3VwJyk6CiAgICAgICAgICAgICAgICBpZiByZS5zZWFyY2gocicvZG9ja2VyKC98LVswLTlhLWZdK1wuc2NvcGUpJywgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ2RvY2tlcicKICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZpcnR1YWxfZmFjdHMKICAgICAgICAgICAgICAgIGlmIHJlLnNlYXJjaCgnL2x4Yy8nLCBsaW5lKSBvciByZS5zZWFyY2goJy9tYWNoaW5lLnNsaWNlL21hY2hpbmUtbHhjJywgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ2x4YycKICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZpcnR1YWxfZmFjdHMKCiAgICAgICAgIyBseGMgZG9lcyBub3QgYWx3YXlzIGFwcGVhciBpbiBjZ3JvdXBzIGFueW1vcmUgYnV0IHNldHMgJ2NvbnRhaW5lcj1seGMnIGVudmlyb25tZW50IHZhciwgcmVxdWlyZXMgcm9vdCBwcml2cwogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKCcvcHJvYy8xL2Vudmlyb24nKToKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZ2V0X2ZpbGVfbGluZXMoJy9wcm9jLzEvZW52aXJvbicpOgogICAgICAgICAgICAgICAgaWYgcmUuc2VhcmNoKCdjb250YWluZXI9bHhjJywgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ2x4YycKICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZpcnR1YWxfZmFjdHMKCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoJy9wcm9jL3Z6Jyk6CiAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICdvcGVudnonCiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKCcvcHJvYy9iYycpOgogICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2hvc3QnCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgogICAgICAgIHN5c3RlbWRfY29udGFpbmVyID0gZ2V0X2ZpbGVfY29udGVudCgnL3J1bi9zeXN0ZW1kL2NvbnRhaW5lcicpCiAgICAgICAgaWYgc3lzdGVtZF9jb250YWluZXI6CiAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9IHN5c3RlbWRfY29udGFpbmVyCiAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdndWVzdCcKICAgICAgICAgICAgcmV0dXJuIHZpcnR1YWxfZmFjdHMKCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoIi9wcm9jL3hlbiIpOgogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAneGVuJwogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGdldF9maWxlX2xpbmVzKCcvcHJvYy94ZW4vY2FwYWJpbGl0aWVzJyk6CiAgICAgICAgICAgICAgICAgICAgaWYgImNvbnRyb2xfZCIgaW4gbGluZToKICAgICAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2hvc3QnCiAgICAgICAgICAgIGV4Y2VwdCBJT0Vycm9yOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gdmlydHVhbF9mYWN0cwoKICAgICAgICBwcm9kdWN0X25hbWUgPSBnZXRfZmlsZV9jb250ZW50KCcvc3lzL2RldmljZXMvdmlydHVhbC9kbWkvaWQvcHJvZHVjdF9uYW1lJykKCiAgICAgICAgaWYgcHJvZHVjdF9uYW1lIGluIFsnS1ZNJywgJ0JvY2hzJ106CiAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICdrdm0nCiAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdndWVzdCcKICAgICAgICAgICAgcmV0dXJuIHZpcnR1YWxfZmFjdHMKCiAgICAgICAgaWYgcHJvZHVjdF9uYW1lID09ICdSSEVWIEh5cGVydmlzb3InOgogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAnUkhFVicKICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2d1ZXN0JwogICAgICAgICAgICByZXR1cm4gdmlydHVhbF9mYWN0cwoKICAgICAgICBpZiBwcm9kdWN0X25hbWUgPT0gJ1ZNd2FyZSBWaXJ0dWFsIFBsYXRmb3JtJzoKICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ1ZNd2FyZScKICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2d1ZXN0JwogICAgICAgICAgICByZXR1cm4gdmlydHVhbF9mYWN0cwoKICAgICAgICBpZiBwcm9kdWN0X25hbWUgPT0gJ09wZW5TdGFjayBOb3ZhJzoKICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ29wZW5zdGFjaycKICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2d1ZXN0JwogICAgICAgICAgICByZXR1cm4gdmlydHVhbF9mYWN0cwoKICAgICAgICBiaW9zX3ZlbmRvciA9IGdldF9maWxlX2NvbnRlbnQoJy9zeXMvZGV2aWNlcy92aXJ0dWFsL2RtaS9pZC9iaW9zX3ZlbmRvcicpCgogICAgICAgIGlmIGJpb3NfdmVuZG9yID09ICdYZW4nOgogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAneGVuJwogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgogICAgICAgIGlmIGJpb3NfdmVuZG9yID09ICdpbm5vdGVrIEdtYkgnOgogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAndmlydHVhbGJveCcKICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2d1ZXN0JwogICAgICAgICAgICByZXR1cm4gdmlydHVhbF9mYWN0cwoKICAgICAgICBzeXNfdmVuZG9yID0gZ2V0X2ZpbGVfY29udGVudCgnL3N5cy9kZXZpY2VzL3ZpcnR1YWwvZG1pL2lkL3N5c192ZW5kb3InKQoKICAgICAgICAjIEZJWE1FOiBUaGlzIGRvZXMgYWxzbyBtYXRjaCBoeXBlcnYKICAgICAgICBpZiBzeXNfdmVuZG9yID09ICdNaWNyb3NvZnQgQ29ycG9yYXRpb24nOgogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAnVmlydHVhbFBDJwogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgogICAgICAgIGlmIHN5c192ZW5kb3IgPT0gJ1BhcmFsbGVscyBTb2Z0d2FyZSBJbnRlcm5hdGlvbmFsIEluYy4nOgogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAncGFyYWxsZWxzJwogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgogICAgICAgIGlmIHN5c192ZW5kb3IgPT0gJ1FFTVUnOgogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAna3ZtJwogICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgogICAgICAgIGlmIHN5c192ZW5kb3IgPT0gJ29WaXJ0JzoKICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ2t2bScKICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2d1ZXN0JwogICAgICAgICAgICByZXR1cm4gdmlydHVhbF9mYWN0cwoKICAgICAgICBpZiBzeXNfdmVuZG9yID09ICdPcGVuU3RhY2sgRm91bmRhdGlvbic6CiAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICdvcGVuc3RhY2snCiAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdndWVzdCcKICAgICAgICAgICAgcmV0dXJuIHZpcnR1YWxfZmFjdHMKCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoJy9wcm9jL3NlbGYvc3RhdHVzJyk6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGdldF9maWxlX2xpbmVzKCcvcHJvYy9zZWxmL3N0YXR1cycpOgogICAgICAgICAgICAgICAgaWYgcmUubWF0Y2goJ15WeElEOiBcZCsnLCBsaW5lKToKICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAnbGludXhfdnNlcnZlcicKICAgICAgICAgICAgICAgICAgICBpZiByZS5tYXRjaCgnXlZ4SUQ6IDAnLCBsaW5lKToKICAgICAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2hvc3QnCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2d1ZXN0JwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKCcvcHJvYy9jcHVpbmZvJyk6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGdldF9maWxlX2xpbmVzKCcvcHJvYy9jcHVpbmZvJyk6CiAgICAgICAgICAgICAgICBpZiByZS5tYXRjaCgnXm1vZGVsIG5hbWUuKlFFTVUgVmlydHVhbCBDUFUnLCBsaW5lKToKICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAna3ZtJwogICAgICAgICAgICAgICAgZWxpZiByZS5tYXRjaCgnXnZlbmRvcl9pZC4qVXNlciBNb2RlIExpbnV4JywgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ3VtbCcKICAgICAgICAgICAgICAgIGVsaWYgcmUubWF0Y2goJ15tb2RlbCBuYW1lLipVTUwnLCBsaW5lKToKICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAndW1sJwogICAgICAgICAgICAgICAgZWxpZiByZS5tYXRjaCgnXnZlbmRvcl9pZC4qUG93ZXJWTSBMeDg2JywgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ3Bvd2Vydm1fbHg4NicKICAgICAgICAgICAgICAgIGVsaWYgcmUubWF0Y2goJ152ZW5kb3JfaWQuKklCTS9TMzkwJywgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ1BSL1NNJwogICAgICAgICAgICAgICAgICAgIGxzY3B1ID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCdsc2NwdScpCiAgICAgICAgICAgICAgICAgICAgaWYgbHNjcHU6CiAgICAgICAgICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKFsibHNjcHUiXSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIG91dC5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3BsaXQoIjoiLCAxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGRhdGFbMF0uc3RyaXAoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGtleSA9PSAnSHlwZXJ2aXNvcic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9IGRhdGFbMV0uc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICdpYm1fc3lzdGVteicKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGlmIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9PSAnUFIvU00nOgogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdMUEFSJwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgICAgICByZXR1cm4gdmlydHVhbF9mYWN0cwoKICAgICAgICAjIEJld2FyZSB0aGF0IHdlIGNhbiBoYXZlIGJvdGgga3ZtIGFuZCB2aXJ0dWFsYm94IHJ1bm5pbmcgb24gYSBzaW5nbGUgc3lzdGVtCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoIi9wcm9jL21vZHVsZXMiKSBhbmQgb3MuYWNjZXNzKCcvcHJvYy9tb2R1bGVzJywgb3MuUl9PSyk6CiAgICAgICAgICAgIG1vZHVsZXMgPSBbXQogICAgICAgICAgICBmb3IgbGluZSBpbiBnZXRfZmlsZV9saW5lcygiL3Byb2MvbW9kdWxlcyIpOgogICAgICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3BsaXQoIiAiLCAxKQogICAgICAgICAgICAgICAgbW9kdWxlcy5hcHBlbmQoZGF0YVswXSkKCiAgICAgICAgICAgIGlmICdrdm0nIGluIG1vZHVsZXM6CgogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5pc2RpcignL3JoZXYvJyk6CgogICAgICAgICAgICAgICAgICAgICMgQ2hlY2sgd2hldGhlciB0aGlzIGlzIGEgUkhFViBoeXBlcnZpc29yIChpcyB2ZHNtIHJ1bm5pbmcgPykKICAgICAgICAgICAgICAgICAgICBmb3IgZiBpbiBnbG9iLmdsb2IoJy9wcm9jL1swLTldKi9jb21tJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG9wZW4oZikucmVhZCgpLnJzdHJpcCgpID09ICd2ZHNtJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAnUkhFVicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ2t2bScKCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICdrdm0nCiAgICAgICAgICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnaG9zdCcKICAgICAgICAgICAgICAgIHJldHVybiB2aXJ0dWFsX2ZhY3RzCgogICAgICAgICAgICBpZiAndmJveGRydicgaW4gbW9kdWxlczoKICAgICAgICAgICAgICAgIHZpcnR1YWxfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3R5cGUnXSA9ICd2aXJ0dWFsYm94JwogICAgICAgICAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2hvc3QnCiAgICAgICAgICAgICAgICByZXR1cm4gdmlydHVhbF9mYWN0cwoKICAgICAgICAjIElmIG5vbmUgb2YgdGhlIGFib3ZlIG1hdGNoZXMsIHJldHVybiAnTkEnIGZvciB2aXJ0dWFsaXphdGlvbl90eXBlCiAgICAgICAgIyBhbmQgdmlydHVhbGl6YXRpb25fcm9sZS4gVGhpcyBhbGxvd3MgZm9yIHByb3BlciBncm91cGluZy4KICAgICAgICB2aXJ0dWFsX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAnTkEnCiAgICAgICAgdmlydHVhbF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ05BJwoKICAgICAgICByZXR1cm4gdmlydHVhbF9mYWN0cwoKCmNsYXNzIExpbnV4VmlydHVhbENvbGxlY3RvcihWaXJ0dWFsQ29sbGVjdG9yKToKICAgIF9mYWN0X2NsYXNzID0gTGludXhWaXJ0dWFsCiAgICBfcGxhdGZvcm0gPSAnTGludXgnClBLAwQUAAAAAADLuytL/ZizV88HAADPBwAAKwAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9weXRob24ucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKaW1wb3J0IHN5cwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5mYWN0cy5jb2xsZWN0b3IgaW1wb3J0IEJhc2VGYWN0Q29sbGVjdG9yCgp0cnk6CiAgICAjIENoZWNrIGlmIHdlIGhhdmUgU1NMQ29udGV4dCBzdXBwb3J0CiAgICBmcm9tIHNzbCBpbXBvcnQgY3JlYXRlX2RlZmF1bHRfY29udGV4dCwgU1NMQ29udGV4dAogICAgZGVsIGNyZWF0ZV9kZWZhdWx0X2NvbnRleHQKICAgIGRlbCBTU0xDb250ZXh0CiAgICBIQVNfU1NMQ09OVEVYVCA9IFRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgSEFTX1NTTENPTlRFWFQgPSBGYWxzZQoKCmNsYXNzIFB5dGhvbkZhY3RDb2xsZWN0b3IoQmFzZUZhY3RDb2xsZWN0b3IpOgogICAgbmFtZSA9ICdweXRob24nCiAgICBfZmFjdF9pZHMgPSBzZXQoKQoKICAgIGRlZiBjb2xsZWN0KHNlbGYsIG1vZHVsZT1Ob25lLCBjb2xsZWN0ZWRfZmFjdHM9Tm9uZSk6CiAgICAgICAgcHl0aG9uX2ZhY3RzID0ge30KICAgICAgICBweXRob25fZmFjdHNbJ3B5dGhvbiddID0gewogICAgICAgICAgICAndmVyc2lvbic6IHsKICAgICAgICAgICAgICAgICdtYWpvcic6IHN5cy52ZXJzaW9uX2luZm9bMF0sCiAgICAgICAgICAgICAgICAnbWlub3InOiBzeXMudmVyc2lvbl9pbmZvWzFdLAogICAgICAgICAgICAgICAgJ21pY3JvJzogc3lzLnZlcnNpb25faW5mb1syXSwKICAgICAgICAgICAgICAgICdyZWxlYXNlbGV2ZWwnOiBzeXMudmVyc2lvbl9pbmZvWzNdLAogICAgICAgICAgICAgICAgJ3NlcmlhbCc6IHN5cy52ZXJzaW9uX2luZm9bNF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgJ3ZlcnNpb25faW5mbyc6IGxpc3Qoc3lzLnZlcnNpb25faW5mbyksCiAgICAgICAgICAgICdleGVjdXRhYmxlJzogc3lzLmV4ZWN1dGFibGUsCiAgICAgICAgICAgICdoYXNfc3NsY29udGV4dCc6IEhBU19TU0xDT05URVhUCiAgICAgICAgfQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHB5dGhvbl9mYWN0c1sncHl0aG9uJ11bJ3R5cGUnXSA9IHN5cy5zdWJ2ZXJzaW9uWzBdCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBweXRob25fZmFjdHNbJ3B5dGhvbiddWyd0eXBlJ10gPSBzeXMuaW1wbGVtZW50YXRpb24ubmFtZQogICAgICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgICAgICBweXRob25fZmFjdHNbJ3B5dGhvbiddWyd0eXBlJ10gPSBOb25lCgogICAgICAgIHJldHVybiBweXRob25fZmFjdHMKUEsDBBQAAAAAAMu7K0v6spBJJioAACYqAAAxAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvbmV0d29yay9nZW5lcmljX2JzZC5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCAoYWJzb2x1dGVfaW1wb3J0LCBkaXZpc2lvbiwgcHJpbnRfZnVuY3Rpb24pCl9fbWV0YWNsYXNzX18gPSB0eXBlCgppbXBvcnQgcmUKaW1wb3J0IHNvY2tldAppbXBvcnQgc3RydWN0Cgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLmZhY3RzLm5ldHdvcmsuYmFzZSBpbXBvcnQgTmV0d29yawoKCmNsYXNzIEdlbmVyaWNCc2RJZmNvbmZpZ05ldHdvcmsoTmV0d29yayk6CiAgICAiIiIKICAgIFRoaXMgaXMgYSBnZW5lcmljIEJTRCBzdWJjbGFzcyBvZiBOZXR3b3JrIHVzaW5nIHRoZSBpZmNvbmZpZyBjb21tYW5kLgogICAgSXQgZGVmaW5lcwogICAgLSBpbnRlcmZhY2VzIChhIGxpc3Qgb2YgaW50ZXJmYWNlIG5hbWVzKQogICAgLSBpbnRlcmZhY2VfPG5hbWU+IGRpY3Rpb25hcnkgb2YgaXB2NCwgaXB2NiwgYW5kIG1hYyBhZGRyZXNzIGluZm9ybWF0aW9uLgogICAgLSBhbGxfaXB2NF9hZGRyZXNzZXMgYW5kIGFsbF9pcHY2X2FkZHJlc3NlczogbGlzdHMgb2YgYWxsIGNvbmZpZ3VyZWQgYWRkcmVzc2VzLgogICAgIiIiCiAgICBwbGF0Zm9ybSA9ICdHZW5lcmljX0JTRF9JZmNvbmZpZycKCiAgICBkZWYgcG9wdWxhdGUoc2VsZiwgY29sbGVjdGVkX2ZhY3RzPU5vbmUpOgogICAgICAgIG5ldHdvcmtfZmFjdHMgPSB7fQogICAgICAgIGlmY29uZmlnX3BhdGggPSBzZWxmLm1vZHVsZS5nZXRfYmluX3BhdGgoJ2lmY29uZmlnJykKCiAgICAgICAgaWYgaWZjb25maWdfcGF0aCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gbmV0d29ya19mYWN0cwoKICAgICAgICByb3V0ZV9wYXRoID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCdyb3V0ZScpCgogICAgICAgIGlmIHJvdXRlX3BhdGggaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIG5ldHdvcmtfZmFjdHMKCiAgICAgICAgZGVmYXVsdF9pcHY0LCBkZWZhdWx0X2lwdjYgPSBzZWxmLmdldF9kZWZhdWx0X2ludGVyZmFjZXMocm91dGVfcGF0aCkKICAgICAgICBpbnRlcmZhY2VzLCBpcHMgPSBzZWxmLmdldF9pbnRlcmZhY2VzX2luZm8oaWZjb25maWdfcGF0aCkKICAgICAgICBpbnRlcmZhY2VzID0gc2VsZi5kZXRlY3RfdHlwZV9tZWRpYShpbnRlcmZhY2VzKQoKICAgICAgICBzZWxmLm1lcmdlX2RlZmF1bHRfaW50ZXJmYWNlKGRlZmF1bHRfaXB2NCwgaW50ZXJmYWNlcywgJ2lwdjQnKQogICAgICAgIHNlbGYubWVyZ2VfZGVmYXVsdF9pbnRlcmZhY2UoZGVmYXVsdF9pcHY2LCBpbnRlcmZhY2VzLCAnaXB2NicpCiAgICAgICAgbmV0d29ya19mYWN0c1snaW50ZXJmYWNlcyddID0gaW50ZXJmYWNlcy5rZXlzKCkKCiAgICAgICAgZm9yIGlmYWNlIGluIGludGVyZmFjZXM6CiAgICAgICAgICAgIG5ldHdvcmtfZmFjdHNbaWZhY2VdID0gaW50ZXJmYWNlc1tpZmFjZV0KCiAgICAgICAgbmV0d29ya19mYWN0c1snZGVmYXVsdF9pcHY0J10gPSBkZWZhdWx0X2lwdjQKICAgICAgICBuZXR3b3JrX2ZhY3RzWydkZWZhdWx0X2lwdjYnXSA9IGRlZmF1bHRfaXB2NgogICAgICAgIG5ldHdvcmtfZmFjdHNbJ2FsbF9pcHY0X2FkZHJlc3NlcyddID0gaXBzWydhbGxfaXB2NF9hZGRyZXNzZXMnXQogICAgICAgIG5ldHdvcmtfZmFjdHNbJ2FsbF9pcHY2X2FkZHJlc3NlcyddID0gaXBzWydhbGxfaXB2Nl9hZGRyZXNzZXMnXQoKICAgICAgICByZXR1cm4gbmV0d29ya19mYWN0cwoKICAgIGRlZiBkZXRlY3RfdHlwZV9tZWRpYShzZWxmLCBpbnRlcmZhY2VzKToKICAgICAgICBmb3IgaWZhY2UgaW4gaW50ZXJmYWNlczoKICAgICAgICAgICAgaWYgJ21lZGlhJyBpbiBpbnRlcmZhY2VzW2lmYWNlXToKICAgICAgICAgICAgICAgIGlmICdldGhlcicgaW4gaW50ZXJmYWNlc1tpZmFjZV1bJ21lZGlhJ10ubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2lmYWNlXVsndHlwZSddID0gJ2V0aGVyJwogICAgICAgIHJldHVybiBpbnRlcmZhY2VzCgogICAgZGVmIGdldF9kZWZhdWx0X2ludGVyZmFjZXMoc2VsZiwgcm91dGVfcGF0aCk6CgogICAgICAgICMgVXNlIHRoZSBjb21tYW5kczoKICAgICAgICAjICAgICByb3V0ZSAtbiBnZXQgOC44LjguOCAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPiBHb29nbGUgcHVibGljIEROUwogICAgICAgICMgICAgIHJvdXRlIC1uIGdldCAtaW5ldDYgMjQwNDo2ODAwOjQwMGE6ODAwOjoxMDEyICAgIC0+IGlwdjYuZ29vZ2xlLmNvbQogICAgICAgICMgdG8gZmluZCBvdXQgdGhlIGRlZmF1bHQgb3V0Z29pbmcgaW50ZXJmYWNlLCBhZGRyZXNzLCBhbmQgZ2F0ZXdheQoKICAgICAgICBjb21tYW5kID0gZGljdCh2ND1bcm91dGVfcGF0aCwgJy1uJywgJ2dldCcsICc4LjguOC44J10sCiAgICAgICAgICAgICAgICAgICAgICAgdjY9W3JvdXRlX3BhdGgsICctbicsICdnZXQnLCAnLWluZXQ2JywgJzI0MDQ6NjgwMDo0MDBhOjgwMDo6MTAxMiddKQoKICAgICAgICBpbnRlcmZhY2UgPSBkaWN0KHY0PXt9LCB2Nj17fSkKCiAgICAgICAgZm9yIHYgaW4gJ3Y0JywgJ3Y2JzoKCiAgICAgICAgICAgIGlmIHYgPT0gJ3Y2JyBhbmQgbm90IHNvY2tldC5oYXNfaXB2NjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYubW9kdWxlLnJ1bl9jb21tYW5kKGNvbW1hbmRbdl0pCiAgICAgICAgICAgIGlmIG5vdCBvdXQ6CiAgICAgICAgICAgICAgICAjIHY2IHJvdXRpbmcgbWF5IHJlc3VsdCBpbgogICAgICAgICAgICAgICAgIyAgIFJUTkVUTElOSyBhbnN3ZXJzOiBJbnZhbGlkIGFyZ3VtZW50CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBmb3IgbGluZSBpbiBvdXQuc3BsaXRsaW5lcygpOgogICAgICAgICAgICAgICAgd29yZHMgPSBsaW5lLnNwbGl0KCkKICAgICAgICAgICAgICAgICMgQ29sbGVjdCBvdXRwdXQgZnJvbSByb3V0ZSBjb21tYW5kCiAgICAgICAgICAgICAgICBpZiBsZW4od29yZHMpID4gMToKICAgICAgICAgICAgICAgICAgICBpZiB3b3Jkc1swXSA9PSAnaW50ZXJmYWNlOic6CiAgICAgICAgICAgICAgICAgICAgICAgIGludGVyZmFjZVt2XVsnaW50ZXJmYWNlJ10gPSB3b3Jkc1sxXQogICAgICAgICAgICAgICAgICAgIGlmIHdvcmRzWzBdID09ICdnYXRld2F5Oic6CiAgICAgICAgICAgICAgICAgICAgICAgIGludGVyZmFjZVt2XVsnZ2F0ZXdheSddID0gd29yZHNbMV0KCiAgICAgICAgcmV0dXJuIGludGVyZmFjZVsndjQnXSwgaW50ZXJmYWNlWyd2NiddCgogICAgZGVmIGdldF9pbnRlcmZhY2VzX2luZm8oc2VsZiwgaWZjb25maWdfcGF0aCwgaWZjb25maWdfb3B0aW9ucz0nLWEnKToKICAgICAgICBpbnRlcmZhY2VzID0ge30KICAgICAgICBjdXJyZW50X2lmID0ge30KICAgICAgICBpcHMgPSBkaWN0KAogICAgICAgICAgICBhbGxfaXB2NF9hZGRyZXNzZXM9W10sCiAgICAgICAgICAgIGFsbF9pcHY2X2FkZHJlc3Nlcz1bXSwKICAgICAgICApCiAgICAgICAgIyBGcmVlQlNELCBEcmFnb25mbHlCU0QsIE5ldEJTRCwgT3BlbkJTRCBhbmQgT1MgWCBhbGwgaW1wbGljaXRseSBhZGQgJy1hJwogICAgICAgICMgd2hlbiBydW5uaW5nIHRoZSBjb21tYW5kICdpZmNvbmZpZycuCiAgICAgICAgIyBTb2xhcmlzIG11c3QgZXhwbGljaXRseSBydW4gdGhlIGNvbW1hbmQgJ2lmY29uZmlnIC1hJy4KICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZChbaWZjb25maWdfcGF0aCwgaWZjb25maWdfb3B0aW9uc10pCgogICAgICAgIGZvciBsaW5lIGluIG91dC5zcGxpdGxpbmVzKCk6CgogICAgICAgICAgICBpZiBsaW5lOgogICAgICAgICAgICAgICAgd29yZHMgPSBsaW5lLnNwbGl0KCkKCiAgICAgICAgICAgICAgICBpZiB3b3Jkc1swXSA9PSAncGFzcyc6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGVsaWYgcmUubWF0Y2goJ15cUycsIGxpbmUpIGFuZCBsZW4od29yZHMpID4gMzoKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2lmID0gc2VsZi5wYXJzZV9pbnRlcmZhY2VfbGluZSh3b3JkcykKICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2VzW2N1cnJlbnRfaWZbJ2RldmljZSddXSA9IGN1cnJlbnRfaWYKICAgICAgICAgICAgICAgIGVsaWYgd29yZHNbMF0uc3RhcnRzd2l0aCgnb3B0aW9ucz0nKToKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcnNlX29wdGlvbnNfbGluZSh3b3JkcywgY3VycmVudF9pZiwgaXBzKQogICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1swXSA9PSAnbmQ2JzoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcnNlX25kNl9saW5lKHdvcmRzLCBjdXJyZW50X2lmLCBpcHMpCiAgICAgICAgICAgICAgICBlbGlmIHdvcmRzWzBdID09ICdldGhlcic6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV9ldGhlcl9saW5lKHdvcmRzLCBjdXJyZW50X2lmLCBpcHMpCiAgICAgICAgICAgICAgICBlbGlmIHdvcmRzWzBdID09ICdtZWRpYTonOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyc2VfbWVkaWFfbGluZSh3b3JkcywgY3VycmVudF9pZiwgaXBzKQogICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1swXSA9PSAnc3RhdHVzOic6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJzZV9zdGF0dXNfbGluZSh3b3JkcywgY3VycmVudF9pZiwgaXBzKQogICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1swXSA9PSAnbGxhZGRyJzoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcnNlX2xsYWRkcl9saW5lKHdvcmRzLCBjdXJyZW50X2lmLCBpcHMpCiAgICAgICAgICAgICAgICBlbGlmIHdvcmRzWzBdID09ICdpbmV0JzoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcnNlX2luZXRfbGluZSh3b3JkcywgY3VycmVudF9pZiwgaXBzKQogICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1swXSA9PSAnaW5ldDYnOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyc2VfaW5ldDZfbGluZSh3b3JkcywgY3VycmVudF9pZiwgaXBzKQogICAgICAgICAgICAgICAgZWxpZiB3b3Jkc1swXSA9PSAndHVubmVsJzoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcnNlX3R1bm5lbF9saW5lKHdvcmRzLCBjdXJyZW50X2lmLCBpcHMpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyc2VfdW5rbm93bl9saW5lKHdvcmRzLCBjdXJyZW50X2lmLCBpcHMpCgogICAgICAgIHJldHVybiBpbnRlcmZhY2VzLCBpcHMKCiAgICBkZWYgcGFyc2VfaW50ZXJmYWNlX2xpbmUoc2VsZiwgd29yZHMpOgogICAgICAgIGRldmljZSA9IHdvcmRzWzBdWzA6LTFdCiAgICAgICAgY3VycmVudF9pZiA9IHsnZGV2aWNlJzogZGV2aWNlLCAnaXB2NCc6IFtdLCAnaXB2Nic6IFtdLCAndHlwZSc6ICd1bmtub3duJ30KICAgICAgICBjdXJyZW50X2lmWydmbGFncyddID0gc2VsZi5nZXRfb3B0aW9ucyh3b3Jkc1sxXSkKICAgICAgICBpZiAnTE9PUEJBQ0snIGluIGN1cnJlbnRfaWZbJ2ZsYWdzJ106CiAgICAgICAgICAgIGN1cnJlbnRfaWZbJ3R5cGUnXSA9ICdsb29wYmFjaycKICAgICAgICBjdXJyZW50X2lmWydtYWNhZGRyZXNzJ10gPSAndW5rbm93bicgICAgIyB3aWxsIGJlIG92ZXJ3cml0dGVuIGxhdGVyCgogICAgICAgIGlmIGxlbih3b3JkcykgPj0gNTogICMgTmV3ZXIgRnJlZUJTRCB2ZXJzaW9ucwogICAgICAgICAgICBjdXJyZW50X2lmWydtZXRyaWMnXSA9IHdvcmRzWzNdCiAgICAgICAgICAgIGN1cnJlbnRfaWZbJ210dSddID0gd29yZHNbNV0KICAgICAgICBlbHNlOgogICAgICAgICAgICBjdXJyZW50X2lmWydtdHUnXSA9IHdvcmRzWzNdCgogICAgICAgIHJldHVybiBjdXJyZW50X2lmCgogICAgZGVmIHBhcnNlX29wdGlvbnNfbGluZShzZWxmLCB3b3JkcywgY3VycmVudF9pZiwgaXBzKToKICAgICAgICAjIE1hYyBoYXMgb3B0aW9ucyBsaWtlIHRoaXMuLi4KICAgICAgICBjdXJyZW50X2lmWydvcHRpb25zJ10gPSBzZWxmLmdldF9vcHRpb25zKHdvcmRzWzBdKQoKICAgIGRlZiBwYXJzZV9uZDZfbGluZShzZWxmLCB3b3JkcywgY3VycmVudF9pZiwgaXBzKToKICAgICAgICAjIEZyZWVCU0QgaGFzIG9wdGlvbnMgbGlrZSB0aGlzLi4uCiAgICAgICAgY3VycmVudF9pZlsnb3B0aW9ucyddID0gc2VsZi5nZXRfb3B0aW9ucyh3b3Jkc1sxXSkKCiAgICBkZWYgcGFyc2VfZXRoZXJfbGluZShzZWxmLCB3b3JkcywgY3VycmVudF9pZiwgaXBzKToKICAgICAgICBjdXJyZW50X2lmWydtYWNhZGRyZXNzJ10gPSB3b3Jkc1sxXQogICAgICAgIGN1cnJlbnRfaWZbJ3R5cGUnXSA9ICdldGhlcicKCiAgICBkZWYgcGFyc2VfbWVkaWFfbGluZShzZWxmLCB3b3JkcywgY3VycmVudF9pZiwgaXBzKToKICAgICAgICAjIG5vdCBzdXJlIGlmIHRoaXMgaXMgdXNlZnVsIC0gd2UgYWxzbyBkcm9wIGluZm9ybWF0aW9uCiAgICAgICAgY3VycmVudF9pZlsnbWVkaWEnXSA9IHdvcmRzWzFdCiAgICAgICAgaWYgbGVuKHdvcmRzKSA+IDI6CiAgICAgICAgICAgIGN1cnJlbnRfaWZbJ21lZGlhX3NlbGVjdCddID0gd29yZHNbMl0KICAgICAgICBpZiBsZW4od29yZHMpID4gMzoKICAgICAgICAgICAgY3VycmVudF9pZlsnbWVkaWFfdHlwZSddID0gd29yZHNbM11bMTpdCiAgICAgICAgaWYgbGVuKHdvcmRzKSA+IDQ6CiAgICAgICAgICAgIGN1cnJlbnRfaWZbJ21lZGlhX29wdGlvbnMnXSA9IHNlbGYuZ2V0X29wdGlvbnMod29yZHNbNF0pCgogICAgZGVmIHBhcnNlX3N0YXR1c19saW5lKHNlbGYsIHdvcmRzLCBjdXJyZW50X2lmLCBpcHMpOgogICAgICAgIGN1cnJlbnRfaWZbJ3N0YXR1cyddID0gd29yZHNbMV0KCiAgICBkZWYgcGFyc2VfbGxhZGRyX2xpbmUoc2VsZiwgd29yZHMsIGN1cnJlbnRfaWYsIGlwcyk6CiAgICAgICAgY3VycmVudF9pZlsnbGxhZGRyJ10gPSB3b3Jkc1sxXQoKICAgIGRlZiBwYXJzZV9pbmV0X2xpbmUoc2VsZiwgd29yZHMsIGN1cnJlbnRfaWYsIGlwcyk6CiAgICAgICAgIyBuZXRic2Qgc2hvdyBhbGlhc2VzIGxpa2UgdGhpcwogICAgICAgICMgIGxvMDogZmxhZ3M9ODA0OTxVUCxMT09QQkFDSyxSVU5OSU5HLE1VTFRJQ0FTVD4gbXR1IDMzMTg0CiAgICAgICAgIyAgICAgICAgIGluZXQgMTI3LjAuMC4xIG5ldG1hc2sgMHhmZjAwMDAwMAogICAgICAgICMgICAgICAgICBpbmV0IGFsaWFzIDEyNy4xLjEuMSBuZXRtYXNrIDB4ZmYwMDAwMDAKICAgICAgICBpZiB3b3Jkc1sxXSA9PSAnYWxpYXMnOgogICAgICAgICAgICBkZWwgd29yZHNbMV0KICAgICAgICBhZGRyZXNzID0geydhZGRyZXNzJzogd29yZHNbMV19CiAgICAgICAgIyBkZWFsIHdpdGggaGV4IG5ldG1hc2sKICAgICAgICBpZiByZS5tYXRjaCgnKFswLTlhLWZdKXs4fScsIHdvcmRzWzNdKSBhbmQgbGVuKHdvcmRzWzNdKSA9PSA4OgogICAgICAgICAgICB3b3Jkc1szXSA9ICcweCcgKyB3b3Jkc1szXQogICAgICAgIGlmIHdvcmRzWzNdLnN0YXJ0c3dpdGgoJzB4Jyk6CiAgICAgICAgICAgIGFkZHJlc3NbJ25ldG1hc2snXSA9IHNvY2tldC5pbmV0X250b2Eoc3RydWN0LnBhY2soJyFMJywgaW50KHdvcmRzWzNdLCBiYXNlPTE2KSkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBvdGhlcndpc2UgYXNzdW1lIHRoaXMgaXMgYSBkb3R0ZWQgcXVhZAogICAgICAgICAgICBhZGRyZXNzWyduZXRtYXNrJ10gPSB3b3Jkc1szXQogICAgICAgICMgY2FsY3VsYXRlIHRoZSBuZXR3b3JrCiAgICAgICAgYWRkcmVzc19iaW4gPSBzdHJ1Y3QudW5wYWNrKCchTCcsIHNvY2tldC5pbmV0X2F0b24oYWRkcmVzc1snYWRkcmVzcyddKSlbMF0KICAgICAgICBuZXRtYXNrX2JpbiA9IHN0cnVjdC51bnBhY2soJyFMJywgc29ja2V0LmluZXRfYXRvbihhZGRyZXNzWyduZXRtYXNrJ10pKVswXQogICAgICAgIGFkZHJlc3NbJ25ldHdvcmsnXSA9IHNvY2tldC5pbmV0X250b2Eoc3RydWN0LnBhY2soJyFMJywgYWRkcmVzc19iaW4gJiBuZXRtYXNrX2JpbikpCiAgICAgICAgIyBicm9hZGNhc3QgbWF5IGJlIGdpdmVuIG9yIHdlIG5lZWQgdG8gY2FsY3VsYXRlCiAgICAgICAgaWYgbGVuKHdvcmRzKSA+IDU6CiAgICAgICAgICAgIGFkZHJlc3NbJ2Jyb2FkY2FzdCddID0gd29yZHNbNV0KICAgICAgICBlbHNlOgogICAgICAgICAgICBhZGRyZXNzWydicm9hZGNhc3QnXSA9IHNvY2tldC5pbmV0X250b2Eoc3RydWN0LnBhY2soJyFMJywgYWRkcmVzc19iaW4gfCAofm5ldG1hc2tfYmluICYgMHhmZmZmZmZmZikpKQogICAgICAgICMgYWRkIHRvIG91ciBsaXN0IG9mIGFkZHJlc3NlcwogICAgICAgIGlmIG5vdCB3b3Jkc1sxXS5zdGFydHN3aXRoKCcxMjcuJyk6CiAgICAgICAgICAgIGlwc1snYWxsX2lwdjRfYWRkcmVzc2VzJ10uYXBwZW5kKGFkZHJlc3NbJ2FkZHJlc3MnXSkKICAgICAgICBjdXJyZW50X2lmWydpcHY0J10uYXBwZW5kKGFkZHJlc3MpCgogICAgZGVmIHBhcnNlX2luZXQ2X2xpbmUoc2VsZiwgd29yZHMsIGN1cnJlbnRfaWYsIGlwcyk6CiAgICAgICAgYWRkcmVzcyA9IHsnYWRkcmVzcyc6IHdvcmRzWzFdfQogICAgICAgIGlmIChsZW4od29yZHMpID49IDQpIGFuZCAod29yZHNbMl0gPT0gJ3ByZWZpeGxlbicpOgogICAgICAgICAgICBhZGRyZXNzWydwcmVmaXgnXSA9IHdvcmRzWzNdCiAgICAgICAgaWYgKGxlbih3b3JkcykgPj0gNikgYW5kICh3b3Jkc1s0XSA9PSAnc2NvcGVpZCcpOgogICAgICAgICAgICBhZGRyZXNzWydzY29wZSddID0gd29yZHNbNV0KICAgICAgICBsb2NhbGhvc3Q2ID0gWyc6OjEnLCAnOjoxLzEyOCcsICdmZTgwOjoxJWxvMCddCiAgICAgICAgaWYgYWRkcmVzc1snYWRkcmVzcyddIG5vdCBpbiBsb2NhbGhvc3Q2OgogICAgICAgICAgICBpcHNbJ2FsbF9pcHY2X2FkZHJlc3NlcyddLmFwcGVuZChhZGRyZXNzWydhZGRyZXNzJ10pCiAgICAgICAgY3VycmVudF9pZlsnaXB2NiddLmFwcGVuZChhZGRyZXNzKQoKICAgIGRlZiBwYXJzZV90dW5uZWxfbGluZShzZWxmLCB3b3JkcywgY3VycmVudF9pZiwgaXBzKToKICAgICAgICBjdXJyZW50X2lmWyd0eXBlJ10gPSAndHVubmVsJwoKICAgIGRlZiBwYXJzZV91bmtub3duX2xpbmUoc2VsZiwgd29yZHMsIGN1cnJlbnRfaWYsIGlwcyk6CiAgICAgICAgIyB3ZSBhcmUgZ29pbmcgdG8gaWdub3JlIHVua25vd24gbGluZXMgaGVyZSAtIHRoaXMgbWF5IGJlCiAgICAgICAgIyBhIGJhZCBpZGVhIC0gYnV0IHlvdSBjYW4gb3ZlcnJpZGUgaXQgaW4geW91ciBzdWJjbGFzcwogICAgICAgIHBhc3MKCiAgICAjIFRPRE86IHRoZXNlIGFyZSBtb2R1bGUgc2NvcGUgc3RhdGljIGZ1bmN0aW9uIGNhbmRpZGF0ZXMKICAgICMgICAgICAgKG1vc3Qgb2YgdGhlIGNsYXNzIGlzIHJlYWxseS4uLikKICAgIGRlZiBnZXRfb3B0aW9ucyhzZWxmLCBvcHRpb25fc3RyaW5nKToKICAgICAgICBzdGFydCA9IG9wdGlvbl9zdHJpbmcuZmluZCgnPCcpICsgMQogICAgICAgIGVuZCA9IG9wdGlvbl9zdHJpbmcucmZpbmQoJz4nKQogICAgICAgIGlmIChzdGFydCA+IDApIGFuZCAoZW5kID4gMCkgYW5kIChlbmQgPiBzdGFydCArIDEpOgogICAgICAgICAgICBvcHRpb25fY3N2ID0gb3B0aW9uX3N0cmluZ1tzdGFydDplbmRdCiAgICAgICAgICAgIHJldHVybiBvcHRpb25fY3N2LnNwbGl0KCcsJykKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gW10KCiAgICBkZWYgbWVyZ2VfZGVmYXVsdF9pbnRlcmZhY2Uoc2VsZiwgZGVmYXVsdHMsIGludGVyZmFjZXMsIGlwX3R5cGUpOgogICAgICAgIGlmICdpbnRlcmZhY2UnIG5vdCBpbiBkZWZhdWx0czoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbm90IGRlZmF1bHRzWydpbnRlcmZhY2UnXSBpbiBpbnRlcmZhY2VzOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZmluZm8gPSBpbnRlcmZhY2VzW2RlZmF1bHRzWydpbnRlcmZhY2UnXV0KICAgICAgICAjIGNvcHkgYWxsIHRoZSBpbnRlcmZhY2UgdmFsdWVzIGFjcm9zcyBleGNlcHQgYWRkcmVzc2VzCiAgICAgICAgZm9yIGl0ZW0gaW4gaWZpbmZvOgogICAgICAgICAgICBpZiBpdGVtICE9ICdpcHY0JyBhbmQgaXRlbSAhPSAnaXB2Nic6CiAgICAgICAgICAgICAgICBkZWZhdWx0c1tpdGVtXSA9IGlmaW5mb1tpdGVtXQogICAgICAgIGlmIGxlbihpZmluZm9baXBfdHlwZV0pID4gMDoKICAgICAgICAgICAgZm9yIGl0ZW0gaW4gaWZpbmZvW2lwX3R5cGVdWzBdOgogICAgICAgICAgICAgICAgZGVmYXVsdHNbaXRlbV0gPSBpZmluZm9baXBfdHlwZV1bMF1baXRlbV0KUEsDBBQAAAAAAMu7K0sMvAFjeAwAAHgMAAAsAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvdmlydHVhbC9zeXNjdGwucHkjIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgKGFic29sdXRlX2ltcG9ydCwgZGl2aXNpb24sIHByaW50X2Z1bmN0aW9uKQpfX21ldGFjbGFzc19fID0gdHlwZQoKaW1wb3J0IHJlCgoKY2xhc3MgVmlydHVhbFN5c2N0bERldGVjdGlvbk1peGluKG9iamVjdCk6CiAgICBkZWYgZGV0ZWN0X3N5c2N0bChzZWxmKToKICAgICAgICBzZWxmLnN5c2N0bF9wYXRoID0gc2VsZi5tb2R1bGUuZ2V0X2Jpbl9wYXRoKCdzeXNjdGwnKQoKICAgIGRlZiBkZXRlY3RfdmlydF9wcm9kdWN0KHNlbGYsIGtleSk6CiAgICAgICAgdmlydHVhbF9wcm9kdWN0X2ZhY3RzID0ge30KICAgICAgICBzZWxmLmRldGVjdF9zeXNjdGwoKQogICAgICAgICMgRklYTUU6IGV4aXQgZWFybHkgb24gZmFsc2V5IHNlbGYuc3lzY3RsX3BhdGggYW5kIHVuaW5kZW50CiAgICAgICAgaWYgc2VsZi5zeXNjdGxfcGF0aDoKICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5tb2R1bGUucnVuX2NvbW1hbmQoIiVzIC1uICVzIiAlIChzZWxmLnN5c2N0bF9wYXRoLCBrZXkpKQogICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgaWYgcmUubWF0Y2goJyhLVk18Qm9jaHN8U21hcnREQykuKicsIG91dCk6CiAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9wcm9kdWN0X2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAna3ZtJwogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfcHJvZHVjdF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2d1ZXN0JwogICAgICAgICAgICAgICAgZWxpZiByZS5tYXRjaCgnLipWTXdhcmUuKicsIG91dCk6CiAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9wcm9kdWN0X2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAnVk13YXJlJwogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfcHJvZHVjdF9mYWN0c1sndmlydHVhbGl6YXRpb25fcm9sZSddID0gJ2d1ZXN0JwogICAgICAgICAgICAgICAgZWxpZiBvdXQucnN0cmlwKCkgPT0gJ1ZpcnR1YWxCb3gnOgogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfcHJvZHVjdF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ3ZpcnR1YWxib3gnCiAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9wcm9kdWN0X2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgICAgICBlbGlmIG91dC5yc3RyaXAoKSA9PSAnSFZNIGRvbVUnOgogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfcHJvZHVjdF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ3hlbicKICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX3Byb2R1Y3RfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdndWVzdCcKICAgICAgICAgICAgICAgIGVsaWYgb3V0LnJzdHJpcCgpID09ICdQYXJhbGxlbHMnOgogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfcHJvZHVjdF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ3BhcmFsbGVscycKICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsX3Byb2R1Y3RfZmFjdHNbJ3ZpcnR1YWxpemF0aW9uX3JvbGUnXSA9ICdndWVzdCcKICAgICAgICAgICAgICAgIGVsaWYgb3V0LnJzdHJpcCgpID09ICdSSEVWIEh5cGVydmlzb3InOgogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfcHJvZHVjdF9mYWN0c1sndmlydHVhbGl6YXRpb25fdHlwZSddID0gJ1JIRVYnCiAgICAgICAgICAgICAgICAgICAgdmlydHVhbF9wcm9kdWN0X2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCgogICAgICAgIHJldHVybiB2aXJ0dWFsX3Byb2R1Y3RfZmFjdHMKCiAgICBkZWYgZGV0ZWN0X3ZpcnRfdmVuZG9yKHNlbGYsIGtleSk6CiAgICAgICAgdmlydHVhbF92ZW5kb3JfZmFjdHMgPSB7fQogICAgICAgIHNlbGYuZGV0ZWN0X3N5c2N0bCgpCiAgICAgICAgIyBGSVhNRTogZXhpdCBlYXJseSBvbiBmYWxzZXkgc2VsZi5zeXNjdGxfcGF0aCBhbmQgdW5pbmRlbnQKICAgICAgICBpZiBzZWxmLnN5c2N0bF9wYXRoOgogICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLm1vZHVsZS5ydW5fY29tbWFuZCgiJXMgLW4gJXMiICUgKHNlbGYuc3lzY3RsX3BhdGgsIGtleSkpCiAgICAgICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgICAgICBpZiBvdXQucnN0cmlwKCkgPT0gJ1FFTVUnOgogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfdmVuZG9yX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAna3ZtJwogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfdmVuZG9yX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCiAgICAgICAgICAgICAgICBpZiBvdXQucnN0cmlwKCkgPT0gJ09wZW5CU0QnOgogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfdmVuZG9yX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl90eXBlJ10gPSAndm1tJwogICAgICAgICAgICAgICAgICAgIHZpcnR1YWxfdmVuZG9yX2ZhY3RzWyd2aXJ0dWFsaXphdGlvbl9yb2xlJ10gPSAnZ3Vlc3QnCgogICAgICAgIHJldHVybiB2aXJ0dWFsX3ZlbmRvcl9mYWN0cwpQSwMEFAAAAAAAy7srS9fBbIY3BwAANwcAACMAAABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy91dGlscy5weSMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKaW1wb3J0IG9zCgoKZGVmIGdldF9maWxlX2NvbnRlbnQocGF0aCwgZGVmYXVsdD1Ob25lLCBzdHJpcD1UcnVlKToKICAgIGRhdGEgPSBkZWZhdWx0CiAgICBpZiBvcy5wYXRoLmV4aXN0cyhwYXRoKSBhbmQgb3MuYWNjZXNzKHBhdGgsIG9zLlJfT0spOgogICAgICAgIHRyeToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGF0YWZpbGUgPSBvcGVuKHBhdGgpCiAgICAgICAgICAgICAgICBkYXRhID0gZGF0YWZpbGUucmVhZCgpCiAgICAgICAgICAgICAgICBpZiBzdHJpcDoKICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBsZW4oZGF0YSkgPT0gMDoKICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGVmYXVsdAogICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgZGF0YWZpbGUuY2xvc2UoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgIyBpZ25vcmUgZXJyb3JzIGFzIHNvbWUgamFpbHMvY29udGFpbmVycyBtaWdodCBoYXZlIHJlYWRhYmxlIHBlcm1pc3Npb25zIGJ1dCBub3QgYWxsb3cgcmVhZHMgdG8gcHJvYwogICAgICAgICAgICAjIGRvbmUgaW4gMiBibG9ja3MgZm9yIDIuNCBjb21wYXQKICAgICAgICAgICAgcGFzcwogICAgcmV0dXJuIGRhdGEKCgpkZWYgZ2V0X2ZpbGVfbGluZXMocGF0aCk6CiAgICAnJydnZXQgbGlzdCBvZiBsaW5lcyBmcm9tIGZpbGUnJycKICAgIGRhdGEgPSBnZXRfZmlsZV9jb250ZW50KHBhdGgpCiAgICBpZiBkYXRhOgogICAgICAgIHJldCA9IGRhdGEuc3BsaXRsaW5lcygpCiAgICBlbHNlOgogICAgICAgIHJldCA9IFtdCiAgICByZXR1cm4gcmV0CgoKZGVmIGdldF9tb3VudF9zaXplKG1vdW50cG9pbnQpOgogICAgc2l6ZV90b3RhbCA9IE5vbmUKICAgIHNpemVfYXZhaWxhYmxlID0gTm9uZQogICAgdHJ5OgogICAgICAgIHN0YXR2ZnNfcmVzdWx0ID0gb3Muc3RhdHZmcyhtb3VudHBvaW50KQogICAgICAgIHNpemVfdG90YWwgPSBzdGF0dmZzX3Jlc3VsdC5mX2Zyc2l6ZSAqIHN0YXR2ZnNfcmVzdWx0LmZfYmxvY2tzCiAgICAgICAgc2l6ZV9hdmFpbGFibGUgPSBzdGF0dmZzX3Jlc3VsdC5mX2Zyc2l6ZSAqIChzdGF0dmZzX3Jlc3VsdC5mX2JhdmFpbCkKICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgIHBhc3MKCiAgICByZXR1cm4gc2l6ZV90b3RhbCwgc2l6ZV9hdmFpbGFibGUKUEsDBBQAAAAAAMu7K0uuUy6CRAQAAEQEAAAkAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvc3lzY3RsLnB5IyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCgppbXBvcnQgcmUKCgpkZWYgZ2V0X3N5c2N0bChtb2R1bGUsIHByZWZpeGVzKToKICAgIHN5c2N0bF9jbWQgPSBtb2R1bGUuZ2V0X2Jpbl9wYXRoKCdzeXNjdGwnKQogICAgY21kID0gW3N5c2N0bF9jbWRdCiAgICBjbWQuZXh0ZW5kKHByZWZpeGVzKQoKICAgIHJjLCBvdXQsIGVyciA9IG1vZHVsZS5ydW5fY29tbWFuZChjbWQpCiAgICBpZiByYyAhPSAwOgogICAgICAgIHJldHVybiBkaWN0KCkKCiAgICBzeXNjdGwgPSBkaWN0KCkKICAgIGZvciBsaW5lIGluIG91dC5zcGxpdGxpbmVzKCk6CiAgICAgICAgaWYgbm90IGxpbmU6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgKGtleSwgdmFsdWUpID0gcmUuc3BsaXQoJ1xzPz1ccz98OiAnLCBsaW5lLCBtYXhzcGxpdD0xKQogICAgICAgIHN5c2N0bFtrZXldID0gdmFsdWUuc3RyaXAoKQoKICAgIHJldHVybiBzeXNjdGwKUEsBAhQDFAAAAAAAy7srS4+n8VJ3AAAAdwAAABMAAAAAAAAAAAAAAIABAAAAAGFuc2libGUvX19pbml0X18ucHlQSwECFAMUAAAAAADLuytLncXxa0gAAABIAAAAIAAAAAAAAAAAAAAAgAGoAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX19pbml0X18ucHlQSwECFAMUAAAAAADLuytL6Yyn0g8rAAAPKwAAFwAAAAAAAAAAAAAAgAEuAQAAYW5zaWJsZV9tb2R1bGVfc2V0dXAucHlQSwECFAMUAAAAAADLuytLO985lTCKAQAwigEAHQAAAAAAAAAAAAAAgAFyLAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvYmFzaWMucHlQSwECFAMUAAAAAADLuytLAAAAAAAAAAAAAAAAJgAAAAAAAAAAAAAAgAHdtgEAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvX19pbml0X18ucHlQSwECFAMUAAAAAADLuytLRPQE7WkkAABpJAAAJwAAAAAAAAAAAAAAgAEhtwEAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvY29sbGVjdG9yLnB5UEsBAhQDFAAAAAAAy7srS9MdX51hBQAAYQUAACcAAAAAAAAAAAAAAIABz9sBAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL25hbWVzcGFjZS5weVBLAQIUAxQAAAAAAMu7K0t7rfrOqRgAAKkYAAAwAAAAAAAAAAAAAACAAXXhAQBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9kZWZhdWx0X2NvbGxlY3RvcnMucHlQSwECFAMUAAAAAADLuytLtdgEBiUwAAAlMAAAHQAAAAAAAAAAAAAAgAFs+gEAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX3RleHQucHlQSwECFAMUAAAAAADLuytLJdy0fhMQAAATEAAAIgAAAAAAAAAAAAAAgAHMKgIAYW5zaWJsZS9tb2R1bGVfdXRpbHMvcHljb21wYXQyNC5weVBLAQIUAxQAAAAAAMu7K0sYF3L1AREAAAERAAAkAAAAAAAAAAAAAACAAR87AgBhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX19pbml0X18ucHlQSwECFAMUAAAAAADLuytLOOLH0ZF1AACRdQAAIAAAAAAAAAAAAAAAgAFiTAIAYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19zaXgucHlQSwECFAMUAAAAAADLuytL7HvsAacIAACnCAAAJQAAAAAAAAAAAAAAgAExwgIAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvdGltZW91dC5weVBLAQIUAxQAAAAAAMu7K0ubLJKBpgQAAKYEAAAtAAAAAAAAAAAAAACAARvLAgBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9uZXR3b3JrL2ZyZWVic2QucHlQSwECFAMUAAAAAADLuytLpLPpWw8JAAAPCQAALQAAAAAAAAAAAAAAgAEM0AIAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvdmlydHVhbC9vcGVuYnNkLnB5UEsBAhQDFAAAAAAAy7srSwQ1y+hiCQAAYgkAACoAAAAAAAAAAAAAAIABZtkCAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL25ldHdvcmsvYmFzZS5weVBLAQIUAxQAAAAAAMu7K0u+TyKPQgQAAEIEAAAwAAAAAAAAAAAAAACAARDjAgBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9oYXJkd2FyZS9kcmFnb25mbHkucHlQSwECFAMUAAAAAADLuytLS7ti9rIEAACyBAAALwAAAAAAAAAAAAAAgAGg5wIAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvbmV0d29yay9kcmFnb25mbHkucHlQSwECFAMUAAAAAADLuytLn1krLAwiAAAMIgAAKgAAAAAAAAAAAAAAgAGf7AIAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvaGFyZHdhcmUvYWl4LnB5UEsBAhQDFAAAAAAAy7srS3g4v21dFwAAXRcAACkAAAAAAAAAAAAAAIAB8w4DAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL25ldHdvcmsvYWl4LnB5UEsBAhQDFAAAAAAAy7srS0iul3N2YwAAdmMAACwAAAAAAAAAAAAAAIABlyYDAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL2hhcmR3YXJlL2xpbnV4LnB5UEsBAhQDFAAAAAAAy7srS7BUQXVhDwAAYQ8AAC0AAAAAAAAAAAAAAIABV4oDAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9wbGF0Zm9ybS5weVBLAQIUAxQAAAAAAMu7K0sdXXqiEiAAABIgAAArAAAAAAAAAAAAAACAAQOaAwBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9oYXJkd2FyZS9ocHV4LnB5UEsBAhQDFAAAAAAAy7srS38UP838BgAA/AYAACkAAAAAAAAAAAAAAIABXroDAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS91c2VyLnB5UEsBAhQDFAAAAAAAy7srS2H7yLPZBgAA2QYAACsAAAAAAAAAAAAAAIABocEDAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL2hhcmR3YXJlL2h1cmQucHlQSwECFAMUAAAAAADLuytLTUL6tqkLAACpCwAAKgAAAAAAAAAAAAAAgAHDyAMAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvb3RoZXIvZmFjdGVyLnB5UEsBAhQDFAAAAAAAy7srS4qVblFpFQAAaRUAACsAAAAAAAAAAAAAAIABtNQDAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3ZpcnR1YWwvc3Vub3MucHlQSwECFAMUAAAAAADLuytL5RNDs8cLAADHCwAAKgAAAAAAAAAAAAAAgAFm6gMAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvbmV0d29yay9ocHV4LnB5UEsBAhQDFAAAAAAAy7srSy8PHUuUYQAAlGEAADEAAAAAAAAAAAAAAIABdfYDAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9kaXN0cmlidXRpb24ucHlQSwECFAMUAAAAAADLuytLDCA/cfUFAAD1BQAALQAAAAAAAAAAAAAAgAFYWAQAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvdmlydHVhbC9mcmVlYnNkLnB5UEsBAhQDFAAAAAAAy7srSwAAAAAAAAAAAAAAAC0AAAAAAAAAAAAAAIABmF4EAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9fX2luaXRfXy5weVBLAQIUAxQAAAAAAMu7K0vdoD73QAYAAEAGAAAtAAAAAAAAAAAAAACAAeNeBABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9uZXR3b3JrL29wZW5ic2QucHlQSwECFAMUAAAAAADLuytLaw+vk9oHAADaBwAALAAAAAAAAAAAAAAAgAFuZQQAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvbmV0d29yay9kYXJ3aW4ucHlQSwECFAMUAAAAAADLuytLRYeBVwE/AAABPwAAKwAAAAAAAAAAAAAAgAGSbQQAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvbmV0d29yay9saW51eC5weVBLAQIUAxQAAAAAAMu7K0tEW1+ZfiUAAH4lAAAsAAAAAAAAAAAAAACAAdysBABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9oYXJkd2FyZS9zdW5vcy5weVBLAQIUAxQAAAAAAMu7K0vBQysuxBIAAMQSAAArAAAAAAAAAAAAAACAAaTSBABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9uZXR3b3JrL3N1bm9zLnB5UEsBAhQDFAAAAAAAy7srS4uqs2cfBQAAHwUAAC0AAAAAAAAAAAAAAIABseUEAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9hcHBhcm1vci5weVBLAQIUAxQAAAAAAMu7K0t7dXpLORkAADkZAAAuAAAAAAAAAAAAAACAARvrBABhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9oYXJkd2FyZS9vcGVuYnNkLnB5UEsBAhQDFAAAAAAAy7srS2JcAe5CDAAAQgwAACoAAAAAAAAAAAAAAIABoAQFAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9sb2NhbC5weVBLAQIUAxQAAAAAAMu7K0s0B9wqAwkAAAMJAAAoAAAAAAAAAAAAAACAASoRBQBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9vdGhlci9vaGFpLnB5UEsBAhQDFAAAAAAAy7srSwAAAAAAAAAAAAAAACwAAAAAAAAAAAAAAIABcxoFAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL290aGVyL19faW5pdF9fLnB5UEsBAhQDFAAAAAAAy7srSzwOqwguFwAALhcAADAAAAAAAAAAAAAAAIABvRoFAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9zZXJ2aWNlX21nci5weVBLAQIUAxQAAAAAAMu7K0teFe9iRgwAAEYMAAAqAAAAAAAAAAAAAACAATkyBQBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9uZXR3b3JrL2h1cmQucHlQSwECFAMUAAAAAADLuytLLJFkarYJAAC2CQAAKgAAAAAAAAAAAAAAgAHHPgUAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvdmlydHVhbC9ocHV4LnB5UEsBAhQDFAAAAAAAy7srS0+dkvU6BQAAOgUAACkAAAAAAAAAAAAAAIABxUgFAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9maXBzLnB5UEsBAhQDFAAAAAAAy7srSx3cOaD1CwAA9QsAACwAAAAAAAAAAAAAAIABRk4FAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9zZWxpbnV4LnB5UEsBAhQDFAAAAAAAy7srSwAAAAAAAAAAAAAAAC4AAAAAAAAAAAAAAIABhVoFAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3ZpcnR1YWwvX19pbml0X18ucHlQSwECFAMUAAAAAADLuytL4LzNTuULAADlCwAALAAAAAAAAAAAAAAAgAHRWgUAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvc3lzdGVtL3BrZ19tZ3IucHlQSwECFAMUAAAAAADLuytLjmXgEnYKAAB2CgAAKAAAAAAAAAAAAAAAgAEAZwUAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvc3lzdGVtL2Rucy5weVBLAQIUAxQAAAAAAMu7K0sJr22V+ggAAPoIAAAqAAAAAAAAAAAAAACAAbxxBQBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy92aXJ0dWFsL2Jhc2UucHlQSwECFAMUAAAAAADLuytLnaaTfFsNAABbDQAALQAAAAAAAAAAAAAAgAH+egUAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvaGFyZHdhcmUvZGFyd2luLnB5UEsBAhQDFAAAAAAAy7srS8xzjlL0AwAA9AMAAC8AAAAAAAAAAAAAAIABpIgFAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3ZpcnR1YWwvZHJhZ29uZmx5LnB5UEsBAhQDFAAAAAAAy7srS8SzHD9HCAAARwgAADEAAAAAAAAAAAAAAIAB5YwFAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9zc2hfcHViX2tleXMucHlQSwECFAMUAAAAAADLuytLAAAAAAAAAAAAAAAALgAAAAAAAAAAAAAAgAF7lQUAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvbmV0d29yay9fX2luaXRfXy5weVBLAQIUAxQAAAAAAMu7K0sAAAAAAAAAAAAAAAAvAAAAAAAAAAAAAACAAceVBQBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9oYXJkd2FyZS9fX2luaXRfXy5weVBLAQIUAxQAAAAAAMu7K0vA0gTi7wwAAO8MAAAoAAAAAAAAAAAAAACAARSWBQBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9zeXN0ZW0vbHNiLnB5UEsBAhQDFAAAAAAAy7srSyKYRm0lCgAAJQoAAC4AAAAAAAAAAAAAAIABSaMFAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c3RlbS9kYXRlX3RpbWUucHlQSwECFAMUAAAAAADLuytLxsfoKykHAAApBwAALAAAAAAAAAAAAAAAgAG6rQUAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvdmlydHVhbC9uZXRic2QucHlQSwECFAMUAAAAAADLuytL2a/stNIGAADSBgAAKwAAAAAAAAAAAAAAgAEttQUAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvaGFyZHdhcmUvYmFzZS5weVBLAQIUAxQAAAAAAMu7K0uLhbtuHQYAAB0GAAAsAAAAAAAAAAAAAACAAUi8BQBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9zeXN0ZW0vY21kbGluZS5weVBLAQIUAxQAAAAAAMu7K0s+9vSJ/hoAAP4aAAAuAAAAAAAAAAAAAACAAa/CBQBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9oYXJkd2FyZS9mcmVlYnNkLnB5UEsBAhQDFAAAAAAAy7srSzflIuEJBwAACQcAACwAAAAAAAAAAAAAAIAB+d0FAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL25ldHdvcmsvbmV0YnNkLnB5UEsBAhQDFAAAAAAAy7srS+iIQnTrFQAA6xUAAC0AAAAAAAAAAAAAAIABTOUFAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL2hhcmR3YXJlL25ldGJzZC5weVBLAQIUAxQAAAAAAMu7K0vweFJZaQgAAGkIAAApAAAAAAAAAAAAAACAAYL7BQBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9zeXN0ZW0vY2Fwcy5weVBLAQIUAxQAAAAAAMu7K0tX8UsNkgQAAJIEAAAoAAAAAAAAAAAAAACAATIEBgBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9zeXN0ZW0vZW52LnB5UEsBAhQDFAAAAAAAy7srS4M/KTf9JQAA/SUAACsAAAAAAAAAAAAAAIABCgkGAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3ZpcnR1YWwvbGludXgucHlQSwECFAMUAAAAAADLuytL/ZizV88HAADPBwAAKwAAAAAAAAAAAAAAgAFQLwYAYW5zaWJsZS9tb2R1bGVfdXRpbHMvZmFjdHMvc3lzdGVtL3B5dGhvbi5weVBLAQIUAxQAAAAAAMu7K0v6spBJJioAACYqAAAxAAAAAAAAAAAAAACAAWg3BgBhbnNpYmxlL21vZHVsZV91dGlscy9mYWN0cy9uZXR3b3JrL2dlbmVyaWNfYnNkLnB5UEsBAhQDFAAAAAAAy7srSwy8AWN4DAAAeAwAACwAAAAAAAAAAAAAAIAB3WEGAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3ZpcnR1YWwvc3lzY3RsLnB5UEsBAhQDFAAAAAAAy7srS9fBbIY3BwAANwcAACMAAAAAAAAAAAAAAIABn24GAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3V0aWxzLnB5UEsBAhQDFAAAAAAAy7srS65TLoJEBAAARAQAACQAAAAAAAAAAAAAAIABF3YGAGFuc2libGUvbW9kdWxlX3V0aWxzL2ZhY3RzL3N5c2N0bC5weVBLBQYAAAAARwBHAFsYAACdegYAAAA="""
def invoke_module(module, modlib_path, json_params):
    pythonpath = os.environ.get('PYTHONPATH')
    if pythonpath:
        os.environ['PYTHONPATH'] = ':'.join((modlib_path, pythonpath))
    else:
        os.environ['PYTHONPATH'] = modlib_path
    p = subprocess.Popen(['/usr/bin/python', module], env=os.environ, shell=False, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
    (stdout, stderr) = p.communicate(json_params)
    if not isinstance(stderr, (bytes, unicode)):
        stderr = stderr.read()
    if not isinstance(stdout, (bytes, unicode)):
        stdout = stdout.read()
    if PY3:
        sys.stderr.buffer.write(stderr)
        sys.stdout.buffer.write(stdout)
    else:
        sys.stderr.write(stderr)
        sys.stdout.write(stdout)
    return p.returncode
def debug(command, zipped_mod, json_params):
    basedir = os.path.join(os.path.abspath(os.path.dirname(__file__)), 'debug_dir')
    args_path = os.path.join(basedir, 'args')
    script_path = os.path.join(basedir, 'ansible_module_setup.py')
    if command == 'explode':
        z = zipfile.ZipFile(zipped_mod)
        for filename in z.namelist():
            if filename.startswith('/'):
                raise Exception('Something wrong with this module zip file: should not contain absolute paths')
            dest_filename = os.path.join(basedir, filename)
            if dest_filename.endswith(os.path.sep) and not os.path.exists(dest_filename):
                os.makedirs(dest_filename)
            else:
                directory = os.path.dirname(dest_filename)
                if not os.path.exists(directory):
                    os.makedirs(directory)
                f = open(dest_filename, 'wb')
                f.write(z.read(filename))
                f.close()
        f = open(args_path, 'wb')
        f.write(json_params)
        f.close()
        print('Module expanded into:')
        print('%s' % basedir)
        exitcode = 0
    elif command == 'execute':
        pythonpath = os.environ.get('PYTHONPATH')
        if pythonpath:
            os.environ['PYTHONPATH'] = ':'.join((basedir, pythonpath))
        else:
            os.environ['PYTHONPATH'] = basedir
        p = subprocess.Popen(['/usr/bin/python', script_path, args_path],
                env=os.environ, shell=False, stdout=subprocess.PIPE,
                stderr=subprocess.PIPE, stdin=subprocess.PIPE)
        (stdout, stderr) = p.communicate()
        if not isinstance(stderr, (bytes, unicode)):
            stderr = stderr.read()
        if not isinstance(stdout, (bytes, unicode)):
            stdout = stdout.read()
        if PY3:
            sys.stderr.buffer.write(stderr)
            sys.stdout.buffer.write(stdout)
        else:
            sys.stderr.write(stderr)
            sys.stdout.write(stdout)
        return p.returncode
    elif command == 'excommunicate':
        sys.argv = ['setup', args_path]
        sys.path.insert(0, basedir)
        from ansible_module_setup import main
        main()
        print('WARNING: Module returned to wrapper instead of exiting')
        sys.exit(1)
    else:
        print('WARNING: Unknown debug command.  Doing nothing.')
        exitcode = 0
    return exitcode
if __name__ == '__main__':
    ANSIBALLZ_PARAMS = json.dumps({"ANSIBLE_MODULE_ARGS": json.load(sys.stdin)})
    if PY3:
        ANSIBALLZ_PARAMS = ANSIBALLZ_PARAMS.encode('utf-8')
    try:
        temp_path = tempfile.mkdtemp(prefix='ansible_')
        zipped_mod = os.path.join(temp_path, 'ansible_modlib.zip')
        modlib = open(zipped_mod, 'wb')
        modlib.write(base64.b64decode(ZIPDATA))
        modlib.close()
        if len(sys.argv) == 2:
            exitcode = debug(sys.argv[1], zipped_mod, ANSIBALLZ_PARAMS)
        else:
            z = zipfile.ZipFile(zipped_mod, mode='r')
            module = os.path.join(temp_path, 'ansible_module_setup.py')
            f = open(module, 'wb')
            f.write(z.read('ansible_module_setup.py'))
            f.close()
            z = zipfile.ZipFile(zipped_mod, mode='a')
            sitecustomize = u'import sys\nsys.path.insert(0,"%s")\n' %  zipped_mod
            sitecustomize = sitecustomize.encode('utf-8')
            zinfo = zipfile.ZipInfo()
            zinfo.filename = 'sitecustomize.py'
            zinfo.date_time = ( 2017, 9, 11, 23, 30, 23)
            z.writestr(zinfo, sitecustomize)
            z.close()
            exitcode = invoke_module(module, zipped_mod, ANSIBALLZ_PARAMS)
    finally:
        try:
            shutil.rmtree(temp_path)
        except OSError:
            pass
    sys.exit(exitcode)