#!/usr/bin/python
# -*- coding: utf-8 -*-
ANSIBALLZ_WRAPPER = True # For test-module script to tell this is a ANSIBALLZ_WRAPPER
import os
import os.path
import sys
import __main__
scriptdir = None
try:
    scriptdir = os.path.dirname(os.path.abspath(__main__.__file__))
except (AttributeError, OSError):
    pass
if scriptdir is not None:
    sys.path = [p for p in sys.path if p != scriptdir]
import base64
import json
import shutil
import zipfile
import tempfile
import subprocess
if sys.version_info < (3,):
    bytes = str
    PY3 = False
else:
    unicode = str
    PY3 = True
try:
    from io import BytesIO as IOStream
except ImportError:
    from StringIO import StringIO as IOStream
ZIPDATA = """UEsDBBQAAAAAAMu7K0uPp/FSdwAAAHcAAAATAAAAYW5zaWJsZS9fX2luaXRfXy5weWZyb20gcGtndXRpbCBpbXBvcnQgZXh0ZW5kX3BhdGgKX19wYXRoX189ZXh0ZW5kX3BhdGgoX19wYXRoX18sX19uYW1lX18pCl9fdmVyc2lvbl9fPSIyLjQuMCIKX19hdXRob3JfXz0iQW5zaWJsZSwgSW5jLiIKUEsDBBQAAAAAAMu7K0udxfFrSAAAAEgAAAAgAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX19pbml0X18ucHlmcm9tIHBrZ3V0aWwgaW1wb3J0IGV4dGVuZF9wYXRoCl9fcGF0aF9fPWV4dGVuZF9wYXRoKF9fcGF0aF9fLF9fbmFtZV9fKQpQSwMEFAAAAAAAy7srSxq/QFe0IwAAtCMAAB8AAABhbnNpYmxlX21vZHVsZV9zdXBlcnZpc29yY3RsLnB5IyEvdXNyL2Jpbi9weXRob24KIyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiMgKGMpIDIwMTIsIE1hdHQgV3JpZ2h0IDxtYXR0QG5vYmllbi5uZXQ+CiMKIyBUaGlzIGZpbGUgaXMgcGFydCBvZiBBbnNpYmxlCiMKIyBBbnNpYmxlIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKIyBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KIwojIEFuc2libGUgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKIyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgojIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKIyBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgojCiMgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKIyBhbG9uZyB3aXRoIEFuc2libGUuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCiMKQU5TSUJMRV9NRVRBREFUQSA9IHsnbWV0YWRhdGFfdmVyc2lvbic6ICcxLjAnLAogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiBbJ3ByZXZpZXcnXSwKICAgICAgICAgICAgICAgICAgICAnc3VwcG9ydGVkX2J5JzogJ2NvbW11bml0eSd9CgoKRE9DVU1FTlRBVElPTiA9ICcnJwotLS0KbW9kdWxlOiBzdXBlcnZpc29yY3RsCnNob3J0X2Rlc2NyaXB0aW9uOiBNYW5hZ2UgdGhlIHN0YXRlIG9mIGEgcHJvZ3JhbSBvciBncm91cCBvZiBwcm9ncmFtcyBydW5uaW5nIHZpYSBzdXBlcnZpc29yZApkZXNjcmlwdGlvbjoKICAgICAtIE1hbmFnZSB0aGUgc3RhdGUgb2YgYSBwcm9ncmFtIG9yIGdyb3VwIG9mIHByb2dyYW1zIHJ1bm5pbmcgdmlhIHN1cGVydmlzb3JkCnZlcnNpb25fYWRkZWQ6ICIwLjciCm9wdGlvbnM6CiAgbmFtZToKICAgIGRlc2NyaXB0aW9uOgogICAgICAtIFRoZSBuYW1lIG9mIHRoZSBzdXBlcnZpc29yZCBwcm9ncmFtIG9yIGdyb3VwIHRvIG1hbmFnZS4KICAgICAgLSBUaGUgbmFtZSB3aWxsIGJlIHRha2VuIGFzIGdyb3VwIG5hbWUgd2hlbiBpdCBlbmRzIHdpdGggYSBjb2xvbiBJKDopCiAgICAgIC0gR3JvdXAgc3VwcG9ydCBpcyBvbmx5IGF2YWlsYWJsZSBpbiBBbnNpYmxlIHZlcnNpb24gMS42IG9yIGxhdGVyLgogICAgcmVxdWlyZWQ6IHRydWUKICAgIGRlZmF1bHQ6IG51bGwKICBjb25maWc6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBUaGUgc3VwZXJ2aXNvciBjb25maWd1cmF0aW9uIGZpbGUgcGF0aAogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICBkZWZhdWx0OiBudWxsCiAgICB2ZXJzaW9uX2FkZGVkOiAiMS4zIgogIHNlcnZlcl91cmw6CiAgICBkZXNjcmlwdGlvbjoKICAgICAgLSBVUkwgb24gd2hpY2ggc3VwZXJ2aXNvcmQgc2VydmVyIGlzIGxpc3RlbmluZwogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICBkZWZhdWx0OiBudWxsCiAgICB2ZXJzaW9uX2FkZGVkOiAiMS4zIgogIHVzZXJuYW1lOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gdXNlcm5hbWUgdG8gdXNlIGZvciBhdXRoZW50aWNhdGlvbgogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICBkZWZhdWx0OiBudWxsCiAgICB2ZXJzaW9uX2FkZGVkOiAiMS4zIgogIHBhc3N3b3JkOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gcGFzc3dvcmQgdG8gdXNlIGZvciBhdXRoZW50aWNhdGlvbgogICAgcmVxdWlyZWQ6IGZhbHNlCiAgICBkZWZhdWx0OiBudWxsCiAgICB2ZXJzaW9uX2FkZGVkOiAiMS4zIgogIHN0YXRlOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gVGhlIGRlc2lyZWQgc3RhdGUgb2YgcHJvZ3JhbS9ncm91cC4KICAgIHJlcXVpcmVkOiB0cnVlCiAgICBkZWZhdWx0OiBudWxsCiAgICBjaG9pY2VzOiBbICJwcmVzZW50IiwgInN0YXJ0ZWQiLCAic3RvcHBlZCIsICJyZXN0YXJ0ZWQiLCAiYWJzZW50IiBdCiAgc3VwZXJ2aXNvcmN0bF9wYXRoOgogICAgZGVzY3JpcHRpb246CiAgICAgIC0gcGF0aCB0byBzdXBlcnZpc29yY3RsIGV4ZWN1dGFibGUKICAgIHJlcXVpcmVkOiBmYWxzZQogICAgZGVmYXVsdDogbnVsbAogICAgdmVyc2lvbl9hZGRlZDogIjEuNCIKbm90ZXM6CiAgLSBXaGVuIEMoc3RhdGUpID0gSShwcmVzZW50KSwgdGhlIG1vZHVsZSB3aWxsIGNhbGwgQyhzdXBlcnZpc29yY3RsIHJlcmVhZCkgdGhlbiBDKHN1cGVydmlzb3JjdGwgYWRkKSBpZiB0aGUgcHJvZ3JhbS9ncm91cCBkb2VzIG5vdCBleGlzdC4KICAtIFdoZW4gQyhzdGF0ZSkgPSBJKHJlc3RhcnRlZCksIHRoZSBtb2R1bGUgd2lsbCBjYWxsIEMoc3VwZXJ2aXNvcmN0bCB1cGRhdGUpIHRoZW4gY2FsbCBDKHN1cGVydmlzb3JjdGwgcmVzdGFydCkuCnJlcXVpcmVtZW50czogWyAic3VwZXJ2aXNvcmN0bCIgXQphdXRob3I6CiAgICAtICJNYXR0IFdyaWdodCAoQG1hdHR1cHN0YXRlKSIKICAgIC0gIkFhcm9uIFdhbmcgKEBpbmV0ZnV0dXJlKSA8aW5ldGZ1dHVyZUBnbWFpbC5jb20+IgonJycKCkVYQU1QTEVTID0gJycnCiMgTWFuYWdlIHRoZSBzdGF0ZSBvZiBwcm9ncmFtIHRvIGJlIGluICdzdGFydGVkJyBzdGF0ZS4KLSBzdXBlcnZpc29yY3RsOgogICAgbmFtZTogbXlfYXBwCiAgICBzdGF0ZTogc3RhcnRlZAoKIyBNYW5hZ2UgdGhlIHN0YXRlIG9mIHByb2dyYW0gZ3JvdXAgdG8gYmUgaW4gJ3N0YXJ0ZWQnIHN0YXRlLgotIHN1cGVydmlzb3JjdGw6CiAgICBuYW1lOiAnbXlfYXBwczonCiAgICBzdGF0ZTogc3RhcnRlZAoKIyBSZXN0YXJ0IG15X2FwcCwgcmVhZGluZyBzdXBlcnZpc29yY3RsIGNvbmZpZ3VyYXRpb24gZnJvbSBhIHNwZWNpZmllZCBmaWxlLgotIHN1cGVydmlzb3JjdGw6CiAgICBuYW1lOiBteV9hcHAKICAgIHN0YXRlOiByZXN0YXJ0ZWQKICAgIGNvbmZpZzogL3Zhci9vcHQvbXlfcHJvamVjdC9zdXBlcnZpc29yZC5jb25mCgojIFJlc3RhcnQgbXlfYXBwLCBjb25uZWN0aW5nIHRvIHN1cGVydmlzb3JkIHdpdGggY3JlZGVudGlhbHMgYW5kIHNlcnZlciBVUkwuCi0gc3VwZXJ2aXNvcmN0bDoKICAgIG5hbWU6IG15X2FwcAogICAgc3RhdGU6IHJlc3RhcnRlZAogICAgdXNlcm5hbWU6IHRlc3QKICAgIHBhc3N3b3JkOiB0ZXN0cGFzcwogICAgc2VydmVyX3VybDogaHR0cDovL2xvY2FsaG9zdDo5MDAxCicnJwoKaW1wb3J0IG9zCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuYmFzaWMgaW1wb3J0IEFuc2libGVNb2R1bGUsIGlzX2V4ZWN1dGFibGUKCgpkZWYgbWFpbigpOgogICAgYXJnX3NwZWMgPSBkaWN0KAogICAgICAgIG5hbWU9ZGljdChyZXF1aXJlZD1UcnVlKSwKICAgICAgICBjb25maWc9ZGljdChyZXF1aXJlZD1GYWxzZSwgdHlwZT0ncGF0aCcpLAogICAgICAgIHNlcnZlcl91cmw9ZGljdChyZXF1aXJlZD1GYWxzZSksCiAgICAgICAgdXNlcm5hbWU9ZGljdChyZXF1aXJlZD1GYWxzZSksCiAgICAgICAgcGFzc3dvcmQ9ZGljdChyZXF1aXJlZD1GYWxzZSwgbm9fbG9nPVRydWUpLAogICAgICAgIHN1cGVydmlzb3JjdGxfcGF0aD1kaWN0KHJlcXVpcmVkPUZhbHNlLCB0eXBlPSdwYXRoJyksCiAgICAgICAgc3RhdGU9ZGljdChyZXF1aXJlZD1UcnVlLCBjaG9pY2VzPVsncHJlc2VudCcsICdzdGFydGVkJywgJ3Jlc3RhcnRlZCcsICdzdG9wcGVkJywgJ2Fic2VudCddKQogICAgKQoKICAgIG1vZHVsZSA9IEFuc2libGVNb2R1bGUoYXJndW1lbnRfc3BlYz1hcmdfc3BlYywgc3VwcG9ydHNfY2hlY2tfbW9kZT1UcnVlKQoKICAgIG5hbWUgPSBtb2R1bGUucGFyYW1zWyduYW1lJ10KICAgIGlzX2dyb3VwID0gRmFsc2UKICAgIGlmIG5hbWUuZW5kc3dpdGgoJzonKToKICAgICAgICBpc19ncm91cCA9IFRydWUKICAgICAgICBuYW1lID0gbmFtZS5yc3RyaXAoJzonKQogICAgc3RhdGUgPSBtb2R1bGUucGFyYW1zWydzdGF0ZSddCiAgICBjb25maWcgPSBtb2R1bGUucGFyYW1zLmdldCgnY29uZmlnJykKICAgIHNlcnZlcl91cmwgPSBtb2R1bGUucGFyYW1zLmdldCgnc2VydmVyX3VybCcpCiAgICB1c2VybmFtZSA9IG1vZHVsZS5wYXJhbXMuZ2V0KCd1c2VybmFtZScpCiAgICBwYXNzd29yZCA9IG1vZHVsZS5wYXJhbXMuZ2V0KCdwYXNzd29yZCcpCiAgICBzdXBlcnZpc29yY3RsX3BhdGggPSBtb2R1bGUucGFyYW1zLmdldCgnc3VwZXJ2aXNvcmN0bF9wYXRoJykKCiAgICAjIHdlIGNoZWNrIGVycm9yIG1lc3NhZ2UgZm9yIGEgcGF0dGVybiwgc28gd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdCdzIGluIEMgbG9jYWxlCiAgICBtb2R1bGUucnVuX2NvbW1hbmRfZW52aXJvbl91cGRhdGUgPSBkaWN0KExBTkc9J0MnLCBMQ19BTEw9J0MnLCBMQ19NRVNTQUdFUz0nQycsIExDX0NUWVBFPSdDJykKCiAgICBpZiBzdXBlcnZpc29yY3RsX3BhdGg6CiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc3VwZXJ2aXNvcmN0bF9wYXRoKSBhbmQgaXNfZXhlY3V0YWJsZShzdXBlcnZpc29yY3RsX3BhdGgpOgogICAgICAgICAgICBzdXBlcnZpc29yY3RsX2FyZ3MgPSBbc3VwZXJ2aXNvcmN0bF9wYXRoXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24oCiAgICAgICAgICAgICAgICBtc2c9IlByb3ZpZGVkIHBhdGggdG8gc3VwZXJ2aXNvcmN0bCBkb2VzIG5vdCBleGlzdCBvciBpc24ndCBleGVjdXRhYmxlOiAlcyIgJSBzdXBlcnZpc29yY3RsX3BhdGgpCiAgICBlbHNlOgogICAgICAgIHN1cGVydmlzb3JjdGxfYXJncyA9IFttb2R1bGUuZ2V0X2Jpbl9wYXRoKCdzdXBlcnZpc29yY3RsJywgVHJ1ZSldCgogICAgaWYgY29uZmlnOgogICAgICAgIHN1cGVydmlzb3JjdGxfYXJncy5leHRlbmQoWyctYycsIGNvbmZpZ10pCiAgICBpZiBzZXJ2ZXJfdXJsOgogICAgICAgIHN1cGVydmlzb3JjdGxfYXJncy5leHRlbmQoWyctcycsIHNlcnZlcl91cmxdKQogICAgaWYgdXNlcm5hbWU6CiAgICAgICAgc3VwZXJ2aXNvcmN0bF9hcmdzLmV4dGVuZChbJy11JywgdXNlcm5hbWVdKQogICAgaWYgcGFzc3dvcmQ6CiAgICAgICAgc3VwZXJ2aXNvcmN0bF9hcmdzLmV4dGVuZChbJy1wJywgcGFzc3dvcmRdKQoKICAgIGRlZiBydW5fc3VwZXJ2aXNvcmN0bChjbWQsIG5hbWU9Tm9uZSwgKiprd2FyZ3MpOgogICAgICAgIGFyZ3MgPSBsaXN0KHN1cGVydmlzb3JjdGxfYXJncykgICMgY29weSB0aGUgbWFzdGVyIGFyZ3MKICAgICAgICBhcmdzLmFwcGVuZChjbWQpCiAgICAgICAgaWYgbmFtZToKICAgICAgICAgICAgYXJncy5hcHBlbmQobmFtZSkKICAgICAgICByZXR1cm4gbW9kdWxlLnJ1bl9jb21tYW5kKGFyZ3MsICoqa3dhcmdzKQoKICAgIGRlZiBnZXRfbWF0Y2hlZF9wcm9jZXNzZXMoKToKICAgICAgICBtYXRjaGVkID0gW10KICAgICAgICByYywgb3V0LCBlcnIgPSBydW5fc3VwZXJ2aXNvcmN0bCgnc3RhdHVzJykKICAgICAgICBmb3IgbGluZSBpbiBvdXQuc3BsaXRsaW5lcygpOgogICAgICAgICAgICAjIE9uZSBzdGF0dXMgbGluZSBtYXkgbG9vayBsaWtlIG9uZSBvZiB0aGVzZSB0d286CiAgICAgICAgICAgICMgcHJvY2VzcyBub3QgaW4gZ3JvdXA6CiAgICAgICAgICAgICMgICBlY2hvX2RhdGVfbG9uZWx5IFJVTk5JTkcgcGlkIDc2ODAsIHVwdGltZSAxMzoyMjoxOAogICAgICAgICAgICAjIHByb2Nlc3MgaW4gZ3JvdXA6CiAgICAgICAgICAgICMgICBlY2hvX2RhdGVfZ3JvdXA6ZWNob19kYXRlXzAwIFJVTk5JTkcgcGlkIDc2ODEsIHVwdGltZSAxMzoyMjoxOAogICAgICAgICAgICBmaWVsZHMgPSBbZmllbGQgZm9yIGZpZWxkIGluIGxpbmUuc3BsaXQoJyAnKSBpZiBmaWVsZCAhPSAnJ10KICAgICAgICAgICAgcHJvY2Vzc19uYW1lID0gZmllbGRzWzBdCiAgICAgICAgICAgIHN0YXR1cyA9IGZpZWxkc1sxXQoKICAgICAgICAgICAgaWYgaXNfZ3JvdXA6CiAgICAgICAgICAgICAgICAjIElmIHRoZXJlIGlzICc6JywgdGhpcyBwcm9jZXNzIG11c3QgYmUgaW4gYSBncm91cC4KICAgICAgICAgICAgICAgIGlmICc6JyBpbiBwcm9jZXNzX25hbWU6CiAgICAgICAgICAgICAgICAgICAgZ3JvdXAgPSBwcm9jZXNzX25hbWUuc3BsaXQoJzonKVswXQogICAgICAgICAgICAgICAgICAgIGlmIGdyb3VwICE9IG5hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiBwcm9jZXNzX25hbWUgIT0gbmFtZToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgbWF0Y2hlZC5hcHBlbmQoKHByb2Nlc3NfbmFtZSwgc3RhdHVzKSkKICAgICAgICByZXR1cm4gbWF0Y2hlZAoKICAgIGRlZiB0YWtlX2FjdGlvbl9vbl9wcm9jZXNzZXMocHJvY2Vzc2VzLCBzdGF0dXNfZmlsdGVyLCBhY3Rpb24sIGV4cGVjdGVkX3Jlc3VsdCk6CiAgICAgICAgdG9fdGFrZV9hY3Rpb25fb24gPSBbXQogICAgICAgIGZvciBwcm9jZXNzX25hbWUsIHN0YXR1cyBpbiBwcm9jZXNzZXM6CiAgICAgICAgICAgIGlmIHN0YXR1c19maWx0ZXIoc3RhdHVzKToKICAgICAgICAgICAgICAgIHRvX3Rha2VfYWN0aW9uX29uLmFwcGVuZChwcm9jZXNzX25hbWUpCgogICAgICAgIGlmIGxlbih0b190YWtlX2FjdGlvbl9vbikgPT0gMDoKICAgICAgICAgICAgbW9kdWxlLmV4aXRfanNvbihjaGFuZ2VkPUZhbHNlLCBuYW1lPW5hbWUsIHN0YXRlPXN0YXRlKQogICAgICAgIGlmIG1vZHVsZS5jaGVja19tb2RlOgogICAgICAgICAgICBtb2R1bGUuZXhpdF9qc29uKGNoYW5nZWQ9VHJ1ZSkKICAgICAgICBmb3IgcHJvY2Vzc19uYW1lIGluIHRvX3Rha2VfYWN0aW9uX29uOgogICAgICAgICAgICByYywgb3V0LCBlcnIgPSBydW5fc3VwZXJ2aXNvcmN0bChhY3Rpb24sIHByb2Nlc3NfbmFtZSwgY2hlY2tfcmM9VHJ1ZSkKICAgICAgICAgICAgaWYgJyVzOiAlcycgJSAocHJvY2Vzc19uYW1lLCBleHBlY3RlZF9yZXN1bHQpIG5vdCBpbiBvdXQ6CiAgICAgICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG1zZz1vdXQpCgogICAgICAgIG1vZHVsZS5leGl0X2pzb24oY2hhbmdlZD1UcnVlLCBuYW1lPW5hbWUsIHN0YXRlPXN0YXRlLCBhZmZlY3RlZD10b190YWtlX2FjdGlvbl9vbikKCiAgICBpZiBzdGF0ZSA9PSAncmVzdGFydGVkJzoKICAgICAgICByYywgb3V0LCBlcnIgPSBydW5fc3VwZXJ2aXNvcmN0bCgndXBkYXRlJywgY2hlY2tfcmM9VHJ1ZSkKICAgICAgICBwcm9jZXNzZXMgPSBnZXRfbWF0Y2hlZF9wcm9jZXNzZXMoKQogICAgICAgIGlmIGxlbihwcm9jZXNzZXMpID09IDA6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24obmFtZT1uYW1lLCBtc2c9IkVSUk9SIChubyBzdWNoIHByb2Nlc3MpIikKCiAgICAgICAgdGFrZV9hY3Rpb25fb25fcHJvY2Vzc2VzKHByb2Nlc3NlcywgbGFtYmRhIHM6IFRydWUsICdyZXN0YXJ0JywgJ3N0YXJ0ZWQnKQoKICAgIHByb2Nlc3NlcyA9IGdldF9tYXRjaGVkX3Byb2Nlc3NlcygpCgogICAgaWYgc3RhdGUgPT0gJ2Fic2VudCc6CiAgICAgICAgaWYgbGVuKHByb2Nlc3NlcykgPT0gMDoKICAgICAgICAgICAgbW9kdWxlLmV4aXRfanNvbihjaGFuZ2VkPUZhbHNlLCBuYW1lPW5hbWUsIHN0YXRlPXN0YXRlKQoKICAgICAgICBpZiBtb2R1bGUuY2hlY2tfbW9kZToKICAgICAgICAgICAgbW9kdWxlLmV4aXRfanNvbihjaGFuZ2VkPVRydWUpCiAgICAgICAgcnVuX3N1cGVydmlzb3JjdGwoJ3JlcmVhZCcsIGNoZWNrX3JjPVRydWUpCiAgICAgICAgcmMsIG91dCwgZXJyID0gcnVuX3N1cGVydmlzb3JjdGwoJ3JlbW92ZScsIG5hbWUpCiAgICAgICAgaWYgJyVzOiByZW1vdmVkIHByb2Nlc3MgZ3JvdXAnICUgbmFtZSBpbiBvdXQ6CiAgICAgICAgICAgIG1vZHVsZS5leGl0X2pzb24oY2hhbmdlZD1UcnVlLCBuYW1lPW5hbWUsIHN0YXRlPXN0YXRlKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24obXNnPW91dCwgbmFtZT1uYW1lLCBzdGF0ZT1zdGF0ZSkKCiAgICBpZiBzdGF0ZSA9PSAncHJlc2VudCc6CiAgICAgICAgaWYgbGVuKHByb2Nlc3NlcykgPiAwOgogICAgICAgICAgICBtb2R1bGUuZXhpdF9qc29uKGNoYW5nZWQ9RmFsc2UsIG5hbWU9bmFtZSwgc3RhdGU9c3RhdGUpCgogICAgICAgIGlmIG1vZHVsZS5jaGVja19tb2RlOgogICAgICAgICAgICBtb2R1bGUuZXhpdF9qc29uKGNoYW5nZWQ9VHJ1ZSkKICAgICAgICBydW5fc3VwZXJ2aXNvcmN0bCgncmVyZWFkJywgY2hlY2tfcmM9VHJ1ZSkKICAgICAgICByYywgb3V0LCBlcnIgPSBydW5fc3VwZXJ2aXNvcmN0bCgnYWRkJywgbmFtZSkKICAgICAgICBpZiAnJXM6IGFkZGVkIHByb2Nlc3MgZ3JvdXAnICUgbmFtZSBpbiBvdXQ6CiAgICAgICAgICAgIG1vZHVsZS5leGl0X2pzb24oY2hhbmdlZD1UcnVlLCBuYW1lPW5hbWUsIHN0YXRlPXN0YXRlKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24obXNnPW91dCwgbmFtZT1uYW1lLCBzdGF0ZT1zdGF0ZSkKCiAgICBpZiBzdGF0ZSA9PSAnc3RhcnRlZCc6CiAgICAgICAgaWYgbGVuKHByb2Nlc3NlcykgPT0gMDoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihuYW1lPW5hbWUsIG1zZz0iRVJST1IgKG5vIHN1Y2ggcHJvY2VzcykiKQogICAgICAgIHRha2VfYWN0aW9uX29uX3Byb2Nlc3Nlcyhwcm9jZXNzZXMsIGxhbWJkYSBzOiBzIG5vdCBpbiAoJ1JVTk5JTkcnLCAnU1RBUlRJTkcnKSwgJ3N0YXJ0JywgJ3N0YXJ0ZWQnKQoKICAgIGlmIHN0YXRlID09ICdzdG9wcGVkJzoKICAgICAgICBpZiBsZW4ocHJvY2Vzc2VzKSA9PSAwOgogICAgICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG5hbWU9bmFtZSwgbXNnPSJFUlJPUiAobm8gc3VjaCBwcm9jZXNzKSIpCiAgICAgICAgdGFrZV9hY3Rpb25fb25fcHJvY2Vzc2VzKHByb2Nlc3NlcywgbGFtYmRhIHM6IHMgaW4gKCdSVU5OSU5HJywgJ1NUQVJUSU5HJyksICdzdG9wJywgJ3N0b3BwZWQnKQoKaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICAgIG1haW4oKQpQSwMEFAAAAAAAy7srSzvfOZUwigEAMIoBAB0AAABhbnNpYmxlL21vZHVsZV91dGlscy9iYXNpYy5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpLCBNaWNoYWVsIERlSGFhbiA8bWljaGFlbC5kZWhhYW5AZ21haWwuY29tPiwgMjAxMi0yMDEzCiMgQ29weXJpZ2h0IChjKSwgVG9zaGlvIEt1cmF0b21pIDx0a3VyYXRvbWlAYW5zaWJsZS5jb20+IDIwMTYKIyBBbGwgcmlnaHRzIHJlc2VydmVkLgojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwKIyBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiMgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICAgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICAgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKIyBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAojIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4KIyBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwKIyBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sCiMgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCiMgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVAojIExJQUJJTElUWSwgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRQojIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCgpCT09MRUFOU19UUlVFID0gWyd5JywgJ3llcycsICdvbicsICcxJywgJ3RydWUnLCAxLCBUcnVlXQpCT09MRUFOU19GQUxTRSA9IFsnbicsICdubycsICdvZmYnLCAnMCcsICdmYWxzZScsIDAsIEZhbHNlXQpCT09MRUFOUyA9IEJPT0xFQU5TX1RSVUUgKyBCT09MRUFOU19GQUxTRQoKU0laRV9SQU5HRVMgPSB7ICdZJzogMTw8ODAsICdaJzogMTw8NzAsICdFJzogMTw8NjAsICdQJzogMTw8NTAsICdUJzogMTw8NDAsICdHJzogMTw8MzAsICdNJzogMTw8MjAsICdLJzogMTw8MTAsICdCJzogMSB9CgpGSUxFX0FUVFJJQlVURVMgPSB7CiAgICAnQSc6ICdub2F0aW1lJywKICAgICdhJzogJ2FwcGVuZCcsCiAgICAnYyc6ICdjb21wcmVzc2VkJywKICAgICdDJzogJ25vY293JywKICAgICdkJzogJ25vZHVtcCcsCiAgICAnRCc6ICdkaXJzeW5jJywKICAgICdlJzogJ2V4dGVudHMnLAogICAgJ0UnOiAnZW5jcnlwdGVkJywKICAgICdoJzogJ2Jsb2Nrc2l6ZScsCiAgICAnaSc6ICdpbW11dGFibGUnLAogICAgJ0knOiAnaW5kZXhlZCcsCiAgICAnaic6ICdqb3VybmFsbGVkJywKICAgICdOJzogJ2lubGluZScsCiAgICAncyc6ICd6ZXJvJywKICAgICdTJzogJ3N5bmNocm9ub3VzJywKICAgICd0JzogJ25vdGFpbCcsCiAgICAnVCc6ICdibG9ja3Jvb3QnLAogICAgJ3UnOiAndW5kZWxldGUnLAogICAgJ1gnOiAnY29tcHJlc3NlZHJhdycsCiAgICAnWic6ICdjb21wcmVzc2VkZGlydHknLAp9CgojIGFuc2libGUgbW9kdWxlcyBjYW4gYmUgd3JpdHRlbiBpbiBhbnkgbGFuZ3VhZ2UuICBUbyBzaW1wbGlmeQojIGRldmVsb3BtZW50IG9mIFB5dGhvbiBtb2R1bGVzLCB0aGUgZnVuY3Rpb25zIGF2YWlsYWJsZSBoZXJlIGNhbgojIGJlIHVzZWQgdG8gZG8gbWFueSBjb21tb24gdGFza3MKCmltcG9ydCBsb2NhbGUKaW1wb3J0IG9zCmltcG9ydCByZQppbXBvcnQgc2hsZXgKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHN5cwppbXBvcnQgdHlwZXMKaW1wb3J0IHRpbWUKaW1wb3J0IHNlbGVjdAppbXBvcnQgc2h1dGlsCmltcG9ydCBzdGF0CmltcG9ydCB0ZW1wZmlsZQppbXBvcnQgdHJhY2ViYWNrCmltcG9ydCBncnAKaW1wb3J0IHB3ZAppbXBvcnQgcGxhdGZvcm0KaW1wb3J0IGVycm5vCmltcG9ydCBkYXRldGltZQpmcm9tIGl0ZXJ0b29scyBpbXBvcnQgcmVwZWF0LCBjaGFpbgoKdHJ5OgogICAgaW1wb3J0IHN5c2xvZwogICAgSEFTX1NZU0xPRz1UcnVlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIEhBU19TWVNMT0c9RmFsc2UKCnRyeToKICAgIGZyb20gc3lzdGVtZCBpbXBvcnQgam91cm5hbAogICAgaGFzX2pvdXJuYWwgPSBUcnVlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGhhc19qb3VybmFsID0gRmFsc2UKCkhBVkVfU0VMSU5VWD1GYWxzZQp0cnk6CiAgICBpbXBvcnQgc2VsaW51eAogICAgSEFWRV9TRUxJTlVYPVRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgcGFzcwoKIyBQeXRob24yICYgMyB3YXkgdG8gZ2V0IE5vbmVUeXBlCk5vbmVUeXBlID0gdHlwZShOb25lKQoKdHJ5OgogICAgZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgU2VxdWVuY2UsIE1hcHBpbmcKZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyBweXRob24yLjUKICAgIFNlcXVlbmNlID0gKGxpc3QsIHR1cGxlKQogICAgTWFwcGluZyA9IChkaWN0LCkKCiMgTm90ZTogV2hlbiBnZXR0aW5nIFNlcXVlbmNlIGZyb20gY29sbGVjdGlvbnMsIGl0IG1hdGNoZXMgd2l0aCBzdHJpbmdzLiAgSWYKIyB0aGlzIG1hdHRlcnMsIG1ha2Ugc3VyZSB0byBjaGVjayBmb3Igc3RyaW5ncyBiZWZvcmUgY2hlY2tpbmcgZm9yIHNlcXVlbmNldHlwZQp0cnk6CiAgICBmcm9tIGNvbGxlY3Rpb25zLmFiYyBpbXBvcnQgS2V5c1ZpZXcKICAgIFNFUVVFTkNFVFlQRSA9IChTZXF1ZW5jZSwgS2V5c1ZpZXcpCmV4Y2VwdDoKICAgIFNFUVVFTkNFVFlQRSA9IFNlcXVlbmNlCgp0cnk6CiAgICBpbXBvcnQganNvbgogICAgIyBEZXRlY3QgdGhlIHB5dGhvbi1qc29uIGxpYnJhcnkgd2hpY2ggaXMgaW5jb21wYXRpYmxlCiAgICAjIExvb2sgZm9yIHNpbXBsZWpzb24gaWYgdGhhdCdzIHRoZSBjYXNlCiAgICB0cnk6CiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoanNvbi5sb2FkcywgdHlwZXMuRnVuY3Rpb25UeXBlKSBvciBub3QgaXNpbnN0YW5jZShqc29uLmR1bXBzLCB0eXBlcy5GdW5jdGlvblR5cGUpOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcgogICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgIHJhaXNlIEltcG9ydEVycm9yCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIHRyeToKICAgICAgICBpbXBvcnQgc2ltcGxlanNvbiBhcyBqc29uCiAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgcHJpbnQoJ1xueyJtc2ciOiAiRXJyb3I6IGFuc2libGUgcmVxdWlyZXMgdGhlIHN0ZGxpYiBqc29uIG9yIHNpbXBsZWpzb24gbW9kdWxlLCBuZWl0aGVyIHdhcyBmb3VuZCEiLCAiZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCiAgICBleGNlcHQgU3ludGF4RXJyb3I6CiAgICAgICAgcHJpbnQoJ1xueyJtc2ciOiAiU3ludGF4RXJyb3I6IHByb2JhYmx5IGR1ZSB0byBpbnN0YWxsZWQgc2ltcGxlanNvbiBiZWluZyBmb3IgYSBkaWZmZXJlbnQgcHl0aG9uIHZlcnNpb24iLCAiZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCgpBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TID0gZGljdCgpCnRyeToKICAgIGltcG9ydCBoYXNobGliCgogICAgIyBweXRob24gMi43LjkrIGFuZCAyLjcuMCsKICAgIGZvciBhdHRyaWJ1dGUgaW4gKCdhdmFpbGFibGVfYWxnb3JpdGhtcycsICdhbGdvcml0aG1zJyk6CiAgICAgICAgYWxnb3JpdGhtcyA9IGdldGF0dHIoaGFzaGxpYiwgYXR0cmlidXRlLCBOb25lKQogICAgICAgIGlmIGFsZ29yaXRobXM6CiAgICAgICAgICAgIGJyZWFrCiAgICBpZiBhbGdvcml0aG1zIGlzIE5vbmU6CiAgICAgICAgIyBweXRob24gMi41KwogICAgICAgIGFsZ29yaXRobXMgPSAoJ21kNScsICdzaGExJywgJ3NoYTIyNCcsICdzaGEyNTYnLCAnc2hhMzg0JywgJ3NoYTUxMicpCiAgICBmb3IgYWxnb3JpdGhtIGluIGFsZ29yaXRobXM6CiAgICAgICAgQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNU1thbGdvcml0aG1dID0gZ2V0YXR0cihoYXNobGliLCBhbGdvcml0aG0pCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGltcG9ydCBzaGEKICAgIEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVMgPSB7J3NoYTEnOiBzaGEuc2hhfQogICAgdHJ5OgogICAgICAgIGltcG9ydCBtZDUKICAgICAgICBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TWydtZDUnXSA9IG1kNS5tZDUKICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICBwYXNzCgpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnB5Y29tcGF0MjQgaW1wb3J0IGdldF9leGNlcHRpb24sIGxpdGVyYWxfZXZhbApmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpbXBvcnQgKFBZMiwgUFkzLCBiLCBiaW5hcnlfdHlwZSwgaW50ZWdlcl90eXBlcywKICAgICAgICBpdGVyaXRlbXMsIHRleHRfdHlwZSwgc3RyaW5nX3R5cGVzKQpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5tb3ZlcyBpbXBvcnQgbWFwLCByZWR1Y2UsIHNobGV4X3F1b3RlCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuX3RleHQgaW1wb3J0IHRvX25hdGl2ZSwgdG9fYnl0ZXMsIHRvX3RleHQKClBBU1NXT1JEX01BVENIID0gcmUuY29tcGlsZShyJ14oPzouK1stX1xzXSk/cGFzcyg/OlstX1xzXT8oPzp3b3JkfHBocmFzZXx3cmR8d2QpPykoPzpbLV9cc10uKyk/JCcsIHJlLkkpCgpfTlVNQkVSVFlQRVMgPSB0dXBsZShsaXN0KGludGVnZXJfdHlwZXMpICsgW2Zsb2F0XSkKCiMgRGVwcmVjYXRlZCBjb21wYXQuICBPbmx5IGtlcHQgaW4gY2FzZSBhbm90aGVyIG1vZHVsZSB1c2VkIHRoZXNlIG5hbWVzICBVc2luZwojIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpcyBwcmVmZXJyZWQKCk5VTUJFUlRZUEVTID0gX05VTUJFUlRZUEVTCgppbWFwID0gbWFwCgp0cnk6CiAgICAjIFB5dGhvbiAyCiAgICB1bmljb2RlCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICAjIFB5dGhvbiAzCiAgICB1bmljb2RlID0gdGV4dF90eXBlCgp0cnk6CiAgICAjIFB5dGhvbiAyLjYrCiAgICBieXRlcwpleGNlcHQgTmFtZUVycm9yOgogICAgIyBQeXRob24gMi40CiAgICBieXRlcyA9IGJpbmFyeV90eXBlCgp0cnk6CiAgICAjIFB5dGhvbiAyCiAgICBiYXNlc3RyaW5nCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICAjIFB5dGhvbiAzCiAgICBiYXNlc3RyaW5nID0gc3RyaW5nX3R5cGVzCgpfbGl0ZXJhbF9ldmFsID0gbGl0ZXJhbF9ldmFsCgojIEVuZCBvZiBkZXByZWNhdGVkIG5hbWVzCgojIEludGVybmFsIGdsb2JhbCBob2xkaW5nIHBhc3NlZCBpbiBwYXJhbXMuICBUaGlzIGlzIGNvbnN1bHRlZCBpbiBjYXNlCiMgbXVsdGlwbGUgQW5zaWJsZU1vZHVsZXMgYXJlIGNyZWF0ZWQuICBPdGhlcndpc2UgZWFjaCBBbnNpYmxlTW9kdWxlIHdvdWxkCiMgYXR0ZW1wdCB0byByZWFkIGZyb20gc3RkaW4uICBPdGhlciBjb2RlIHNob3VsZCBub3QgdXNlIHRoaXMgZGlyZWN0bHkgYXMgaXQKIyBpcyBhbiBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBkZXRhaWwKX0FOU0lCTEVfQVJHUyA9IE5vbmUKCkZJTEVfQ09NTU9OX0FSR1VNRU5UUz1kaWN0KAogICAgc3JjID0gZGljdCgpLAogICAgbW9kZSA9IGRpY3QodHlwZT0ncmF3JyksCiAgICBvd25lciA9IGRpY3QoKSwKICAgIGdyb3VwID0gZGljdCgpLAogICAgc2V1c2VyID0gZGljdCgpLAogICAgc2Vyb2xlID0gZGljdCgpLAogICAgc2VsZXZlbCA9IGRpY3QoKSwKICAgIHNldHlwZSA9IGRpY3QoKSwKICAgIGZvbGxvdyA9IGRpY3QodHlwZT0nYm9vbCcsIGRlZmF1bHQ9RmFsc2UpLAogICAgIyBub3QgdGFrZW4gYnkgdGhlIGZpbGUgbW9kdWxlLCBidXQgb3RoZXIgbW9kdWxlcyBjYWxsIGZpbGUgc28gaXQgbXVzdCBpZ25vcmUgdGhlbS4KICAgIGNvbnRlbnQgPSBkaWN0KG5vX2xvZz1UcnVlKSwKICAgIGJhY2t1cCA9IGRpY3QoKSwKICAgIGZvcmNlID0gZGljdCgpLAogICAgcmVtb3RlX3NyYyA9IGRpY3QoKSwgIyB1c2VkIGJ5IGFzc2VtYmxlCiAgICByZWdleHAgPSBkaWN0KCksICMgdXNlZCBieSBhc3NlbWJsZQogICAgZGVsaW1pdGVyID0gZGljdCgpLCAjIHVzZWQgYnkgYXNzZW1ibGUKICAgIGRpcmVjdG9yeV9tb2RlID0gZGljdCgpLCAjIHVzZWQgYnkgY29weQogICAgdW5zYWZlX3dyaXRlcyAgPSBkaWN0KHR5cGU9J2Jvb2wnKSwgIyBzaG91bGQgYmUgYXZhaWxhYmxlIHRvIGFueSBtb2R1bGUgdXNpbmcgYXRvbWljX21vdmUKICAgIGF0dHJpYnV0ZXMgPSBkaWN0KGFsaWFzZXM9WydhdHRyJ10pLAopCgpQQVNTV0RfQVJHX1JFID0gcmUuY29tcGlsZShyJ15bLV17MCwyfXBhc3NbLV0/KHdvcmR8d2QpPycpCgojIENhbid0IHVzZSAwNzc3NyBvbiBQeXRob24gMywgY2FuJ3QgdXNlIDBvNzc3NyBvbiBQeXRob24gMi40ClBFUk1fQklUUyA9IGludCgnMDc3NzcnLCA4KSAgICAgICMgZmlsZSBtb2RlIHBlcm1pc3Npb24gYml0cwpFWEVDX1BFUk1fQklUUyA9IGludCgnMDAxMTEnLCA4KSAjIGV4ZWN1dGUgcGVybWlzc2lvbiBiaXRzCkRFRkFVTFRfUEVSTSA9IGludCgnMDY2NicsIDgpICAgICMgZGVmYXVsdCBmaWxlIHBlcm1pc3Npb24gYml0cwoKCmRlZiBnZXRfcGxhdGZvcm0oKToKICAgICcnJyB3aGF0J3MgdGhlIHBsYXRmb3JtPyAgZXhhbXBsZTogTGludXggaXMgYSBwbGF0Zm9ybS4gJycnCiAgICByZXR1cm4gcGxhdGZvcm0uc3lzdGVtKCkKCmRlZiBnZXRfZGlzdHJpYnV0aW9uKCk6CiAgICAnJycgcmV0dXJuIHRoZSBkaXN0cmlidXRpb24gbmFtZSAnJycKICAgIGlmIHBsYXRmb3JtLnN5c3RlbSgpID09ICdMaW51eCc6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdXBwb3J0ZWRfZGlzdHMgPSBwbGF0Zm9ybS5fc3VwcG9ydGVkX2Rpc3RzICsgKCdhcmNoJywnYWxwaW5lJykKICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gcGxhdGZvcm0ubGludXhfZGlzdHJpYnV0aW9uKHN1cHBvcnRlZF9kaXN0cz1zdXBwb3J0ZWRfZGlzdHMpWzBdLmNhcGl0YWxpemUoKQogICAgICAgICAgICBpZiBub3QgZGlzdHJpYnV0aW9uIGFuZCBvcy5wYXRoLmlzZmlsZSgnL2V0Yy9zeXN0ZW0tcmVsZWFzZScpOgogICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gcGxhdGZvcm0ubGludXhfZGlzdHJpYnV0aW9uKHN1cHBvcnRlZF9kaXN0cz1bJ3N5c3RlbSddKVswXS5jYXBpdGFsaXplKCkKICAgICAgICAgICAgICAgIGlmICdBbWF6b24nIGluIGRpc3RyaWJ1dGlvbjoKICAgICAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSAnQW1hem9uJwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSAnT3RoZXJMaW51eCcKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICMgRklYTUU6IE1ldGhvZE1pc3NpbmcsIEkgYXNzdW1lPwogICAgICAgICAgICBkaXN0cmlidXRpb24gPSBwbGF0Zm9ybS5kaXN0KClbMF0uY2FwaXRhbGl6ZSgpCiAgICBlbHNlOgogICAgICAgIGRpc3RyaWJ1dGlvbiA9IE5vbmUKICAgIHJldHVybiBkaXN0cmlidXRpb24KCmRlZiBnZXRfZGlzdHJpYnV0aW9uX3ZlcnNpb24oKToKICAgICcnJyByZXR1cm4gdGhlIGRpc3RyaWJ1dGlvbiB2ZXJzaW9uICcnJwogICAgaWYgcGxhdGZvcm0uc3lzdGVtKCkgPT0gJ0xpbnV4JzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbl92ZXJzaW9uID0gcGxhdGZvcm0ubGludXhfZGlzdHJpYnV0aW9uKClbMV0KICAgICAgICAgICAgaWYgbm90IGRpc3RyaWJ1dGlvbl92ZXJzaW9uIGFuZCBvcy5wYXRoLmlzZmlsZSgnL2V0Yy9zeXN0ZW0tcmVsZWFzZScpOgogICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oc3VwcG9ydGVkX2Rpc3RzPVsnc3lzdGVtJ10pWzFdCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAjIEZJWE1FOiBNZXRob2RNaXNzaW5nLCBJIGFzc3VtZT8KICAgICAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBwbGF0Zm9ybS5kaXN0KClbMV0KICAgIGVsc2U6CiAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBOb25lCiAgICByZXR1cm4gZGlzdHJpYnV0aW9uX3ZlcnNpb24KCmRlZiBnZXRfYWxsX3N1YmNsYXNzZXMoY2xzKToKICAgICcnJwogICAgdXNlZCBieSBtb2R1bGVzIGxpa2UgSGFyZHdhcmUgb3IgTmV0d29yayBmYWN0IGNsYXNzZXMgdG8gcmV0cmlldmUgYWxsIHN1YmNsYXNzZXMgb2YgYSBnaXZlbiBjbGFzcy4KICAgIF9fc3ViY2xhc3Nlc19fIHJldHVybiBvbmx5IGRpcmVjdCBzdWIgY2xhc3Nlcy4gVGhpcyBvbmUgZ28gZG93biBpbnRvIHRoZSBjbGFzcyB0cmVlLgogICAgJycnCiAgICAjIFJldHJpZXZlIGRpcmVjdCBzdWJjbGFzc2VzCiAgICBzdWJjbGFzc2VzID0gY2xzLl9fc3ViY2xhc3Nlc19fKCkKICAgIHRvX3Zpc2l0ID0gbGlzdChzdWJjbGFzc2VzKQogICAgIyBUaGVuIHZpc2l0IGFsbCBzdWJjbGFzc2VzCiAgICB3aGlsZSB0b192aXNpdDoKICAgICAgICBmb3Igc2MgaW4gdG9fdmlzaXQ6CiAgICAgICAgICAgICMgVGhlIGN1cnJlbnQgY2xhc3MgaXMgbm93IHZpc2l0ZWQsIHNvIHJlbW92ZSBpdCBmcm9tIGxpc3QKICAgICAgICAgICAgdG9fdmlzaXQucmVtb3ZlKHNjKQogICAgICAgICAgICAjIEFwcGVuZGluZyBhbGwgc3ViY2xhc3NlcyB0byB2aXNpdCBhbmQga2VlcCBhIHJlZmVyZW5jZSBvZiBhdmFpbGFibGUgY2xhc3MKICAgICAgICAgICAgZm9yIHNzYyBpbiBzYy5fX3N1YmNsYXNzZXNfXygpOgogICAgICAgICAgICAgICAgc3ViY2xhc3Nlcy5hcHBlbmQoc3NjKQogICAgICAgICAgICAgICAgdG9fdmlzaXQuYXBwZW5kKHNzYykKICAgIHJldHVybiBzdWJjbGFzc2VzCgoKZGVmIGxvYWRfcGxhdGZvcm1fc3ViY2xhc3MoY2xzLCAqYXJncywgKiprd2FyZ3MpOgogICAgJycnCiAgICB1c2VkIGJ5IG1vZHVsZXMgbGlrZSBVc2VyIHRvIGhhdmUgZGlmZmVyZW50IGltcGxlbWVudGF0aW9ucyBiYXNlZCBvbiBkZXRlY3RlZCBwbGF0Zm9ybS4gIFNlZSBVc2VyCiAgICBtb2R1bGUgZm9yIGFuIGV4YW1wbGUuCiAgICAnJycKCiAgICB0aGlzX3BsYXRmb3JtID0gZ2V0X3BsYXRmb3JtKCkKICAgIGRpc3RyaWJ1dGlvbiA9IGdldF9kaXN0cmlidXRpb24oKQogICAgc3ViY2xhc3MgPSBOb25lCgogICAgIyBnZXQgdGhlIG1vc3Qgc3BlY2lmaWMgc3VwZXJjbGFzcyBmb3IgdGhpcyBwbGF0Zm9ybQogICAgaWYgZGlzdHJpYnV0aW9uIGlzIG5vdCBOb25lOgogICAgICAgIGZvciBzYyBpbiBnZXRfYWxsX3N1YmNsYXNzZXMoY2xzKToKICAgICAgICAgICAgaWYgc2MuZGlzdHJpYnV0aW9uIGlzIG5vdCBOb25lIGFuZCBzYy5kaXN0cmlidXRpb24gPT0gZGlzdHJpYnV0aW9uIGFuZCBzYy5wbGF0Zm9ybSA9PSB0aGlzX3BsYXRmb3JtOgogICAgICAgICAgICAgICAgc3ViY2xhc3MgPSBzYwogICAgaWYgc3ViY2xhc3MgaXMgTm9uZToKICAgICAgICBmb3Igc2MgaW4gZ2V0X2FsbF9zdWJjbGFzc2VzKGNscyk6CiAgICAgICAgICAgIGlmIHNjLnBsYXRmb3JtID09IHRoaXNfcGxhdGZvcm0gYW5kIHNjLmRpc3RyaWJ1dGlvbiBpcyBOb25lOgogICAgICAgICAgICAgICAgc3ViY2xhc3MgPSBzYwogICAgaWYgc3ViY2xhc3MgaXMgTm9uZToKICAgICAgICBzdWJjbGFzcyA9IGNscwoKICAgIHJldHVybiBzdXBlcihjbHMsIHN1YmNsYXNzKS5fX25ld19fKHN1YmNsYXNzKQoKCmRlZiBqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcyhkLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKToKICAgICcnJyBSZWN1cnNpdmVseSBjb252ZXJ0IGRpY3Qga2V5cyBhbmQgdmFsdWVzIHRvIGJ5dGUgc3RyCgogICAgICAgIFNwZWNpYWxpemVkIGZvciBqc29uIHJldHVybiBiZWNhdXNlIHRoaXMgb25seSBoYW5kbGVzLCBsaXN0cywgdHVwbGVzLAogICAgICAgIGFuZCBkaWN0IGNvbnRhaW5lciB0eXBlcyAodGhlIGNvbnRhaW5lcnMgdGhhdCB0aGUganNvbiBtb2R1bGUgcmV0dXJucykKICAgICcnJwoKICAgIGlmIGlzaW5zdGFuY2UoZCwgdGV4dF90eXBlKToKICAgICAgICByZXR1cm4gdG9fYnl0ZXMoZCwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgZGljdCk6CiAgICAgICAgcmV0dXJuIGRpY3QobWFwKGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzLCBpdGVyaXRlbXMoZCksIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBsaXN0KToKICAgICAgICByZXR1cm4gbGlzdChtYXAoanNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMsIGQsIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCB0dXBsZSk6CiAgICAgICAgcmV0dXJuIHR1cGxlKG1hcChqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcywgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxzZToKICAgICAgICByZXR1cm4gZAoKZGVmIGpzb25fZGljdF9ieXRlc190b191bmljb2RlKGQsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpOgogICAgJycnIFJlY3Vyc2l2ZWx5IGNvbnZlcnQgZGljdCBrZXlzIGFuZCB2YWx1ZXMgdG8gYnl0ZSBzdHIKCiAgICAgICAgU3BlY2lhbGl6ZWQgZm9yIGpzb24gcmV0dXJuIGJlY2F1c2UgdGhpcyBvbmx5IGhhbmRsZXMsIGxpc3RzLCB0dXBsZXMsCiAgICAgICAgYW5kIGRpY3QgY29udGFpbmVyIHR5cGVzICh0aGUgY29udGFpbmVycyB0aGF0IHRoZSBqc29uIG1vZHVsZSByZXR1cm5zKQogICAgJycnCgogICAgaWYgaXNpbnN0YW5jZShkLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgIyBXYXJuaW5nLCBjYW4gdHJhY2ViYWNrCiAgICAgICAgcmV0dXJuIHRvX3RleHQoZCwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpCiAgICBlbGlmIGlzaW5zdGFuY2UoZCwgZGljdCk6CiAgICAgICAgcmV0dXJuIGRpY3QobWFwKGpzb25fZGljdF9ieXRlc190b191bmljb2RlLCBpdGVyaXRlbXMoZCksIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBsaXN0KToKICAgICAgICByZXR1cm4gbGlzdChtYXAoanNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUsIGQsIHJlcGVhdChlbmNvZGluZyksIHJlcGVhdChlcnJvcnMpKSkKICAgIGVsaWYgaXNpbnN0YW5jZShkLCB0dXBsZSk6CiAgICAgICAgcmV0dXJuIHR1cGxlKG1hcChqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZSwgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxzZToKICAgICAgICByZXR1cm4gZAoKZGVmIHJldHVybl92YWx1ZXMob2JqKToKICAgICIiIiBSZXR1cm4gbmF0aXZlIHN0cmluZ2lmaWVkIHZhbHVlcyBmcm9tIGRhdGFzdHJ1Y3R1cmVzLgoKICAgIEZvciB1c2Ugd2l0aCByZW1vdmluZyBzZW5zaXRpdmUgdmFsdWVzIHByZS1qc29uaWZpY2F0aW9uLiIiIgogICAgaWYgaXNpbnN0YW5jZShvYmosICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgaWYgb2JqOgogICAgICAgICAgICB5aWVsZCB0b19uYXRpdmUob2JqLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIHJldHVybgogICAgZWxpZiBpc2luc3RhbmNlKG9iaiwgU0VRVUVOQ0VUWVBFKToKICAgICAgICBmb3IgZWxlbWVudCBpbiBvYmo6CiAgICAgICAgICAgIGZvciBzdWJlbGVtZW50IGluIHJldHVybl92YWx1ZXMoZWxlbWVudCk6CiAgICAgICAgICAgICAgICB5aWVsZCBzdWJlbGVtZW50CiAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCBNYXBwaW5nKToKICAgICAgICBmb3IgZWxlbWVudCBpbiBvYmouaXRlbXMoKToKICAgICAgICAgICAgZm9yIHN1YmVsZW1lbnQgaW4gcmV0dXJuX3ZhbHVlcyhlbGVtZW50WzFdKToKICAgICAgICAgICAgICAgIHlpZWxkIHN1YmVsZW1lbnQKICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIChib29sLCBOb25lVHlwZSkpOgogICAgICAgICMgVGhpcyBtdXN0IGNvbWUgYmVmb3JlIGludCBiZWNhdXNlIGJvb2xzIGFyZSBhbHNvIGludHMKICAgICAgICByZXR1cm4KICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIE5VTUJFUlRZUEVTKToKICAgICAgICB5aWVsZCB0b19uYXRpdmUob2JqLCBub25zdHJpbmc9J3NpbXBsZXJlcHInKQogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ1Vua25vd24gcGFyYW1ldGVyIHR5cGU6ICVzLCAlcycgJSAodHlwZShvYmopLCBvYmopKQoKZGVmIHJlbW92ZV92YWx1ZXModmFsdWUsIG5vX2xvZ19zdHJpbmdzKToKICAgICIiIiBSZW1vdmUgc3RyaW5ncyBpbiBub19sb2dfc3RyaW5ncyBmcm9tIHZhbHVlLiAgSWYgdmFsdWUgaXMgYSBjb250YWluZXIKICAgIHR5cGUsIHRoZW4gcmVtb3ZlIGEgbG90IG1vcmUiIiIKICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgIyBOZWVkIG5hdGl2ZSBzdHIgdHlwZQogICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSB2YWx1ZQogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHRleHRfdHlwZSk6CiAgICAgICAgICAgIHZhbHVlX2lzX3RleHQgPSBUcnVlCiAgICAgICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSB0b19ieXRlcyh2YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgdmFsdWVfaXNfdGV4dCA9IEZhbHNlCiAgICAgICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSB0b190ZXh0KHZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQoKICAgICAgICBpZiBuYXRpdmVfc3RyX3ZhbHVlIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICByZXR1cm4gJ1ZBTFVFX1NQRUNJRklFRF9JTl9OT19MT0dfUEFSQU1FVEVSJwogICAgICAgIGZvciBvbWl0X21lIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICBuYXRpdmVfc3RyX3ZhbHVlID0gbmF0aXZlX3N0cl92YWx1ZS5yZXBsYWNlKG9taXRfbWUsICcqJyAqIDgpCgogICAgICAgIGlmIHZhbHVlX2lzX3RleHQgYW5kIGlzaW5zdGFuY2UobmF0aXZlX3N0cl92YWx1ZSwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICB2YWx1ZSA9IHRvX3RleHQobmF0aXZlX3N0cl92YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykKICAgICAgICBlbGlmIG5vdCB2YWx1ZV9pc190ZXh0IGFuZCBpc2luc3RhbmNlKG5hdGl2ZV9zdHJfdmFsdWUsIHRleHRfdHlwZSk6CiAgICAgICAgICAgIHZhbHVlID0gdG9fYnl0ZXMobmF0aXZlX3N0cl92YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykKICAgICAgICBlbHNlOgogICAgICAgICAgICB2YWx1ZSA9IG5hdGl2ZV9zdHJfdmFsdWUKICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgU0VRVUVOQ0VUWVBFKToKICAgICAgICByZXR1cm4gW3JlbW92ZV92YWx1ZXMoZWxlbSwgbm9fbG9nX3N0cmluZ3MpIGZvciBlbGVtIGluIHZhbHVlXQogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBNYXBwaW5nKToKICAgICAgICByZXR1cm4gZGljdCgoaywgcmVtb3ZlX3ZhbHVlcyh2LCBub19sb2dfc3RyaW5ncykpIGZvciBrLCB2IGluIHZhbHVlLml0ZW1zKCkpCiAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIHR1cGxlKGNoYWluKE5VTUJFUlRZUEVTLCAoYm9vbCwgTm9uZVR5cGUpKSkpOgogICAgICAgIHN0cmluZ3lfdmFsdWUgPSB0b19uYXRpdmUodmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgaWYgc3RyaW5neV92YWx1ZSBpbiBub19sb2dfc3RyaW5nczoKICAgICAgICAgICAgcmV0dXJuICdWQUxVRV9TUEVDSUZJRURfSU5fTk9fTE9HX1BBUkFNRVRFUicKICAgICAgICBmb3Igb21pdF9tZSBpbiBub19sb2dfc3RyaW5nczoKICAgICAgICAgICAgaWYgb21pdF9tZSBpbiBzdHJpbmd5X3ZhbHVlOgogICAgICAgICAgICAgICAgcmV0dXJuICdWQUxVRV9TUEVDSUZJRURfSU5fTk9fTE9HX1BBUkFNRVRFUicKICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgZGF0ZXRpbWUuZGF0ZXRpbWUpOgogICAgICAgIHZhbHVlID0gdmFsdWUuaXNvZm9ybWF0KCkKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdWYWx1ZSBvZiB1bmtub3duIHR5cGU6ICVzLCAlcycgJSAodHlwZSh2YWx1ZSksIHZhbHVlKSkKICAgIHJldHVybiB2YWx1ZQoKCmRlZiBoZXVyaXN0aWNfbG9nX3Nhbml0aXplKGRhdGEsIG5vX2xvZ192YWx1ZXM9Tm9uZSk6CiAgICAnJycgUmVtb3ZlIHN0cmluZ3MgdGhhdCBsb29rIGxpa2UgcGFzc3dvcmRzIGZyb20gbG9nIG1lc3NhZ2VzICcnJwogICAgIyBDdXJyZW50bHkgZmlsdGVyczoKICAgICMgdXNlcjpwYXNzQGZvby93aGF0ZXZlciBhbmQgaHR0cDovL3VzZXJuYW1lOnBhc3NAd2hlcmV2ZXIvZm9vCiAgICAjIFRoaXMgY29kZSBoYXMgZmFsc2UgcG9zaXRpdmVzIGFuZCBjb25zdW1lcyBwYXJ0cyBvZiBsb2dzIHRoYXQgYXJlCiAgICAjIG5vdCBwYXNzd2RzCgogICAgIyBiZWdpbjogc3RhcnQgb2YgYSBwYXNzd2QgY29udGFpbmluZyBzdHJpbmcKICAgICMgZW5kOiBlbmQgb2YgYSBwYXNzd2QgY29udGFpbmluZyBzdHJpbmcKICAgICMgc2VwOiBjaGFyIGJldHdlZW4gdXNlciBhbmQgcGFzc3dkCiAgICAjIHByZXZfYmVnaW46IHdoZXJlIGluIHRoZSBvdmVyYWxsIHN0cmluZyB0byBzdGFydCBhIHNlYXJjaCBmb3IKICAgICMgICBhIHBhc3N3ZAogICAgIyBzZXBfc2VhcmNoX2VuZDogd2hlcmUgaW4gdGhlIHN0cmluZyB0byBlbmQgYSBzZWFyY2ggZm9yIHRoZSBzZXAKICAgIGRhdGEgPSB0b19uYXRpdmUoZGF0YSkKCiAgICBvdXRwdXQgPSBbXQogICAgYmVnaW4gPSBsZW4oZGF0YSkKICAgIHByZXZfYmVnaW4gPSBiZWdpbgogICAgc2VwID0gMQogICAgd2hpbGUgc2VwOgogICAgICAgICMgRmluZCB0aGUgcG90ZW50aWFsIGVuZCBvZiBhIHBhc3N3ZAogICAgICAgIHRyeToKICAgICAgICAgICAgZW5kID0gZGF0YS5yaW5kZXgoJ0AnLCAwLCBiZWdpbikKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgIyBObyBwYXNzd2QgaW4gdGhlIHJlc3Qgb2YgdGhlIGRhdGEKICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCBkYXRhWzA6YmVnaW5dKQogICAgICAgICAgICBicmVhawoKICAgICAgICAjIFNlYXJjaCBmb3IgdGhlIGJlZ2lubmluZyBvZiBhIHBhc3N3ZAogICAgICAgIHNlcCA9IE5vbmUKICAgICAgICBzZXBfc2VhcmNoX2VuZCA9IGVuZAogICAgICAgIHdoaWxlIG5vdCBzZXA6CiAgICAgICAgICAgICMgVVJMLXN0eWxlIHVzZXJuYW1lK3Bhc3N3b3JkCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGJlZ2luID0gZGF0YS5yaW5kZXgoJzovLycsIDAsIHNlcF9zZWFyY2hfZW5kKQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICMgTm8gdXJsIHN0eWxlIGluIHRoZSBkYXRhLCBjaGVjayBmb3Igc3NoIHN0eWxlIGluIHRoZQogICAgICAgICAgICAgICAgIyByZXN0IG9mIHRoZSBzdHJpbmcKICAgICAgICAgICAgICAgIGJlZ2luID0gMAogICAgICAgICAgICAjIFNlYXJjaCBmb3Igc2VwYXJhdG9yCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlcCA9IGRhdGEuaW5kZXgoJzonLCBiZWdpbiArIDMsIGVuZCkKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAjIE5vIHNlcGFyYXRvcjsgY2hvaWNlczoKICAgICAgICAgICAgICAgIGlmIGJlZ2luID09IDA6CiAgICAgICAgICAgICAgICAgICAgIyBTZWFyY2hlZCB0aGUgd2hvbGUgc3RyaW5nIHNvIHRoZXJlJ3Mgbm8gcGFzc3dvcmQKICAgICAgICAgICAgICAgICAgICAjIGhlcmUuICBSZXR1cm4gdGhlIHJlbWFpbmluZyBkYXRhCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCBkYXRhWzA6YmVnaW5dKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAjIFNlYXJjaCBmb3IgYSBkaWZmZXJlbnQgYmVnaW5uaW5nIG9mIHRoZSBwYXNzd29yZCBmaWVsZC4KICAgICAgICAgICAgICAgIHNlcF9zZWFyY2hfZW5kID0gYmVnaW4KICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgaWYgc2VwOgogICAgICAgICAgICAjIFBhc3N3b3JkIHdhcyBmb3VuZDsgcmVtb3ZlIGl0LgogICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsIGRhdGFbZW5kOnByZXZfYmVnaW5dKQogICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsICcqKioqKioqKicpCiAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgZGF0YVtiZWdpbjpzZXAgKyAxXSkKICAgICAgICAgICAgcHJldl9iZWdpbiA9IGJlZ2luCgogICAgb3V0cHV0ID0gJycuam9pbihvdXRwdXQpCiAgICBpZiBub19sb2dfdmFsdWVzOgogICAgICAgIG91dHB1dCA9IHJlbW92ZV92YWx1ZXMob3V0cHV0LCBub19sb2dfdmFsdWVzKQogICAgcmV0dXJuIG91dHB1dAoKZGVmIGJ5dGVzX3RvX2h1bWFuKHNpemUsIGlzYml0cz1GYWxzZSwgdW5pdD1Ob25lKToKCiAgICBiYXNlID0gJ0J5dGVzJwogICAgaWYgaXNiaXRzOgogICAgICAgIGJhc2UgPSAnYml0cycKICAgIHN1ZmZpeCA9ICcnCgogICAgZm9yIHN1ZmZpeCwgbGltaXQgaW4gc29ydGVkKGl0ZXJpdGVtcyhTSVpFX1JBTkdFUyksIGtleT1sYW1iZGEgaXRlbTogLWl0ZW1bMV0pOgogICAgICAgIGlmICh1bml0IGlzIE5vbmUgYW5kIHNpemUgPj0gbGltaXQpIG9yIHVuaXQgaXMgbm90IE5vbmUgYW5kIHVuaXQudXBwZXIoKSA9PSBzdWZmaXhbMF06CiAgICAgICAgICAgIGJyZWFrCgogICAgaWYgbGltaXQgIT0gMToKICAgICAgICBzdWZmaXggKz0gYmFzZVswXQogICAgZWxzZToKICAgICAgICBzdWZmaXggPSBiYXNlCgogICAgcmV0dXJuICclLjJmICVzJyAlIChmbG9hdChzaXplKS8gbGltaXQsIHN1ZmZpeCkKCmRlZiBodW1hbl90b19ieXRlcyhudW1iZXIsIGRlZmF1bHRfdW5pdD1Ob25lLCBpc2JpdHM9RmFsc2UpOgoKICAgICcnJwogICAgQ29udmVydCBudW1iZXIgaW4gc3RyaW5nIGZvcm1hdCBpbnRvIGJ5dGVzIChleDogJzJLJyA9PiAyMDQ4KSBvciB1c2luZyB1bml0IGFyZ3VtZW50CiAgICBleDoKICAgICAgaHVtYW5fdG9fYnl0ZXMoJzEwTScpIDw9PiBodW1hbl90b19ieXRlcygxMCwgJ00nKQogICAgJycnCiAgICBtID0gcmUuc2VhcmNoKCdeXHMqKFxkKlwuP1xkKilccyooW0EtWmEtel0rKT8nLCBzdHIobnVtYmVyKSwgZmxhZ3M9cmUuSUdOT1JFQ0FTRSkKICAgIGlmIG0gaXMgTm9uZToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJodW1hbl90b19ieXRlcygpIGNhbid0IGludGVycHJldCBmb2xsb3dpbmcgc3RyaW5nOiAlcyIgJSBzdHIobnVtYmVyKSkKICAgIHRyeToKICAgICAgICBudW0gPSBmbG9hdChtLmdyb3VwKDEpKQogICAgZXhjZXB0OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgY2FuJ3QgaW50ZXJwcmV0IGZvbGxvd2luZyBudW1iZXI6ICVzIChvcmlnaW5hbCBpbnB1dCBzdHJpbmc6ICVzKSIgJSAobS5ncm91cCgxKSwgbnVtYmVyKSkKCiAgICB1bml0ID0gbS5ncm91cCgyKQogICAgaWYgdW5pdCBpcyBOb25lOgogICAgICAgIHVuaXQgPSBkZWZhdWx0X3VuaXQKCiAgICBpZiB1bml0IGlzIE5vbmU6CiAgICAgICAgJycnIE5vIHVuaXQgZ2l2ZW4sIHJldHVybmluZyByYXcgbnVtYmVyICcnJwogICAgICAgIHJldHVybiBpbnQocm91bmQobnVtKSkKICAgIHJhbmdlX2tleSA9IHVuaXRbMF0udXBwZXIoKQogICAgdHJ5OgogICAgICAgIGxpbWl0ID0gU0laRV9SQU5HRVNbcmFuZ2Vfa2V5XQogICAgZXhjZXB0OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgZmFpbGVkIHRvIGNvbnZlcnQgJXMgKHVuaXQgPSAlcykuIFRoZSBzdWZmaXggbXVzdCBiZSBvbmUgb2YgJXMiICUgKG51bWJlciwgdW5pdCwgIiwgIi5qb2luKFNJWkVfUkFOR0VTLmtleXMoKSkpKQoKICAgICMgZGVmYXVsdCB2YWx1ZQogICAgdW5pdF9jbGFzcyA9ICdCJwogICAgdW5pdF9jbGFzc19uYW1lID0gJ2J5dGUnCiAgICAjIGhhbmRsaW5nIGJpdHMgY2FzZQogICAgaWYgaXNiaXRzOgogICAgICAgIHVuaXRfY2xhc3MgPSAnYicKICAgICAgICB1bml0X2NsYXNzX25hbWUgPSAnYml0JwogICAgIyBjaGVjayB1bml0IHZhbHVlIGlmIG1vcmUgdGhhbiBvbmUgY2hhcmFjdGVyIChLQiwgTUIpCiAgICBpZiBsZW4odW5pdCkgPiAxOgogICAgICAgIGV4cGVjdF9tZXNzYWdlID0gJ2V4cGVjdCAlcyVzIG9yICVzJyAlIChyYW5nZV9rZXksIHVuaXRfY2xhc3MsIHJhbmdlX2tleSkKICAgICAgICBpZiByYW5nZV9rZXkgPT0gJ0InOgogICAgICAgICAgICBleHBlY3RfbWVzc2FnZSA9ICdleHBlY3QgJXMgb3IgJXMnICUgKHVuaXRfY2xhc3MsIHVuaXRfY2xhc3NfbmFtZSkKCiAgICAgICAgaWYgdW5pdF9jbGFzc19uYW1lIGluIHVuaXQubG93ZXIoKToKICAgICAgICAgICAgcGFzcwogICAgICAgIGVsaWYgdW5pdFsxXSAhPSB1bml0X2NsYXNzOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJodW1hbl90b19ieXRlcygpIGZhaWxlZCB0byBjb252ZXJ0ICVzLiBWYWx1ZSBpcyBub3QgYSB2YWxpZCBzdHJpbmcgKCVzKSIgJSAobnVtYmVyLCBleHBlY3RfbWVzc2FnZSkpCgogICAgcmV0dXJuIGludChyb3VuZChudW0gKiBsaW1pdCkpCgpkZWYgaXNfZXhlY3V0YWJsZShwYXRoKToKICAgICcnJ2lzIHRoZSBnaXZlbiBwYXRoIGV4ZWN1dGFibGU/CgogICAgTGltaXRhdGlvbnM6CiAgICAqIERvZXMgbm90IGFjY291bnQgZm9yIEZTQUNMcy4KICAgICogTW9zdCB0aW1lcyB3ZSByZWFsbHkgd2FudCB0byBrbm93ICJDYW4gdGhlIGN1cnJlbnQgdXNlciBleGVjdXRlIHRoaXMKICAgICAgZmlsZSIgIFRoaXMgZnVuY3Rpb24gZG9lcyBub3QgdGVsbCB1cyB0aGF0LCBvbmx5IGlmIGFuIGV4ZWN1dGUgYml0IGlzIHNldC4KICAgICcnJwogICAgIyBUaGVzZSBhcmUgYWxsIGJpdGZpZWxkcyBzbyBmaXJzdCBiaXR3aXNlLW9yIGFsbCB0aGUgcGVybWlzc2lvbnMgd2UncmUKICAgICMgbG9va2luZyBmb3IsIHRoZW4gYml0d2lzZS1hbmQgd2l0aCB0aGUgZmlsZSdzIG1vZGUgdG8gZGV0ZXJtaW5lIGlmIGFueQogICAgIyBleGVjdXRlIGJpdHMgYXJlIHNldC4KICAgIHJldHVybiAoKHN0YXQuU19JWFVTUiB8IHN0YXQuU19JWEdSUCB8IHN0YXQuU19JWE9USCkgJiBvcy5zdGF0KHBhdGgpW3N0YXQuU1RfTU9ERV0pCgpkZWYgX2xvYWRfcGFyYW1zKCk6CiAgICAnJycgcmVhZCB0aGUgbW9kdWxlcyBwYXJhbWV0ZXJzIGFuZCBzdG9yZSB0aGVtIGdsb2JhbGx5LgoKICAgIFRoaXMgZnVuY3Rpb24gbWF5IGJlIG5lZWRlZCBmb3IgY2VydGFpbiB2ZXJ5IGR5bmFtaWMgY3VzdG9tIG1vZHVsZXMgd2hpY2gKICAgIHdhbnQgdG8gcHJvY2VzcyB0aGUgcGFyYW1ldGVycyB0aGF0IGFyZSBiZWluZyBoYW5kZWQgdGhlIG1vZHVsZS4gIFNpbmNlCiAgICB0aGlzIGlzIHNvIGNsb3NlbHkgdGllZCB0byB0aGUgaW1wbGVtZW50YXRpb24gb2YgbW9kdWxlcyB3ZSBjYW5ub3QKICAgIGd1YXJhbnRlZSBBUEkgc3RhYmlsaXR5IGZvciBpdCAoaXQgbWF5IGNoYW5nZSBiZXR3ZWVuIHZlcnNpb25zKSBob3dldmVyIHdlCiAgICB3aWxsIHRyeSBub3QgdG8gYnJlYWsgaXQgZ3JhdHVpdG91c2x5LiAgSXQgaXMgY2VydGFpbmx5IG1vcmUgZnV0dXJlLXByb29mCiAgICB0byBjYWxsIHRoaXMgZnVuY3Rpb24gYW5kIGNvbnN1bWUgaXRzIG91dHB1dHMgdGhhbiB0byBpbXBsZW1lbnQgdGhlIGxvZ2ljCiAgICBpbnNpZGUgaXQgYXMgYSBjb3B5IGluIHlvdXIgb3duIGNvZGUuCiAgICAnJycKICAgIGdsb2JhbCBfQU5TSUJMRV9BUkdTCiAgICBpZiBfQU5TSUJMRV9BUkdTIGlzIG5vdCBOb25lOgogICAgICAgIGJ1ZmZlciA9IF9BTlNJQkxFX0FSR1MKICAgIGVsc2U6CiAgICAgICAgIyBkZWJ1ZyBvdmVycmlkZXMgdG8gcmVhZCBhcmdzIGZyb20gZmlsZSBvciBjbWRsaW5lCgogICAgICAgICMgQXZvaWQgdHJhY2ViYWNrcyB3aGVuIGxvY2FsZSBpcyBub24tdXRmOAogICAgICAgICMgV2UgY29udHJvbCB0aGUgYXJncyBhbmQgd2UgcGFzcyB0aGVtIGFzIHV0ZjgKICAgICAgICBpZiBsZW4oc3lzLmFyZ3YpID4gMToKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUoc3lzLmFyZ3ZbMV0pOgogICAgICAgICAgICAgICAgZmQgPSBvcGVuKHN5cy5hcmd2WzFdLCAncmInKQogICAgICAgICAgICAgICAgYnVmZmVyID0gZmQucmVhZCgpCiAgICAgICAgICAgICAgICBmZC5jbG9zZSgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzeXMuYXJndlsxXQogICAgICAgICAgICAgICAgaWYgUFkzOgogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IGJ1ZmZlci5lbmNvZGUoJ3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICMgZGVmYXVsdCBjYXNlLCByZWFkIGZyb20gc3RkaW4KICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBQWTI6CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzeXMuc3RkaW4ucmVhZCgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzeXMuc3RkaW4uYnVmZmVyLnJlYWQoKQogICAgICAgIF9BTlNJQkxFX0FSR1MgPSBidWZmZXIKCiAgICB0cnk6CiAgICAgICAgcGFyYW1zID0ganNvbi5sb2FkcyhidWZmZXIuZGVjb2RlKCd1dGYtOCcpKQogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgIyBUaGlzIGhlbHBlciB1c2VkIHRvbyBlYXJseSBmb3IgZmFpbF9qc29uIHRvIHdvcmsuCiAgICAgICAgcHJpbnQoJ1xueyJtc2ciOiAiRXJyb3I6IE1vZHVsZSB1bmFibGUgdG8gZGVjb2RlIHZhbGlkIEpTT04gb24gc3RkaW4uICBVbmFibGUgdG8gZmlndXJlIG91dCB3aGF0IHBhcmFtZXRlcnMgd2VyZSBwYXNzZWQiLCAiZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCgogICAgaWYgUFkyOgogICAgICAgIHBhcmFtcyA9IGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzKHBhcmFtcykKCiAgICB0cnk6CiAgICAgICAgcmV0dXJuIHBhcmFtc1snQU5TSUJMRV9NT0RVTEVfQVJHUyddCiAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgIyBUaGlzIGhlbHBlciBkb2VzIG5vdCBoYXZlIGFjY2VzcyB0byBmYWlsX2pzb24gc28gd2UgaGF2ZSB0byBwcmludAogICAgICAgICMganNvbiBvdXRwdXQgb24gb3VyIG93bi4KICAgICAgICBwcmludCgnXG57Im1zZyI6ICJFcnJvcjogTW9kdWxlIHVuYWJsZSB0byBsb2NhdGUgQU5TSUJMRV9NT0RVTEVfQVJHUyBpbiBqc29uIGRhdGEgZnJvbSBzdGRpbi4gIFVuYWJsZSB0byBmaWd1cmUgb3V0IHdoYXQgcGFyYW1ldGVycyB3ZXJlIHBhc3NlZCIsICcKICAgICAgICAgICAgICAnImZhaWxlZCI6IHRydWV9JykKICAgICAgICBzeXMuZXhpdCgxKQoKZGVmIGVudl9mYWxsYmFjaygqYXJncywgKiprd2FyZ3MpOgogICAgJycnIExvYWQgdmFsdWUgZnJvbSBlbnZpcm9ubWVudCAnJycKICAgIGZvciBhcmcgaW4gYXJnczoKICAgICAgICBpZiBhcmcgaW4gb3MuZW52aXJvbjoKICAgICAgICAgICAgcmV0dXJuIG9zLmVudmlyb25bYXJnXQogICAgZWxzZToKICAgICAgICByYWlzZSBBbnNpYmxlRmFsbGJhY2tOb3RGb3VuZAoKZGVmIF9sZW5pZW50X2xvd2VyY2FzZShsc3QpOgogICAgIiIiTG93ZXJjYXNlIGVsZW1lbnRzIG9mIGEgbGlzdC4KCiAgICBJZiBhbiBlbGVtZW50IGlzIG5vdCBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIHVudG91Y2hlZC4KICAgICIiIgogICAgbG93ZXJlZCA9IFtdCiAgICBmb3IgdmFsdWUgaW4gbHN0OgogICAgICAgIHRyeToKICAgICAgICAgICAgbG93ZXJlZC5hcHBlbmQodmFsdWUubG93ZXIoKSkKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgIGxvd2VyZWQuYXBwZW5kKHZhbHVlKQogICAgcmV0dXJuIGxvd2VyZWQKCmRlZiBmb3JtYXRfYXR0cmlidXRlcyhhdHRyaWJ1dGVzKToKICAgIGF0dHJpYnV0ZV9saXN0ID0gW10KICAgIGZvciBhdHRyIGluIGF0dHJpYnV0ZXM6CiAgICAgICAgaWYgYXR0ciBpbiBGSUxFX0FUVFJJQlVURVM6CiAgICAgICAgICAgIGF0dHJpYnV0ZV9saXN0LmFwcGVuZChGSUxFX0FUVFJJQlVURVNbYXR0cl0pCiAgICByZXR1cm4gYXR0cmlidXRlX2xpc3QKCmRlZiBnZXRfZmxhZ3NfZnJvbV9hdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpOgogICAgZmxhZ3MgPSBbXQogICAgZm9yIGtleSxhdHRyIGluIEZJTEVfQVRUUklCVVRFUy5pdGVtcygpOgogICAgICAgIGlmIGF0dHIgaW4gYXR0cmlidXRlczoKICAgICAgICAgICAgZmxhZ3MuYXBwZW5kKGtleSkKICAgIHJldHVybiAnJy5qb2luKGZsYWdzKQoKY2xhc3MgQW5zaWJsZUZhbGxiYWNrTm90Rm91bmQoRXhjZXB0aW9uKToKICAgIHBhc3MKCgpjbGFzcyBBbnNpYmxlTW9kdWxlKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgYXJndW1lbnRfc3BlYywgYnlwYXNzX2NoZWNrcz1GYWxzZSwgbm9fbG9nPUZhbHNlLAogICAgICAgICAgICAgICAgIGNoZWNrX2ludmFsaWRfYXJndW1lbnRzPVRydWUsIG11dHVhbGx5X2V4Y2x1c2l2ZT1Ob25lLCByZXF1aXJlZF90b2dldGhlcj1Ob25lLAogICAgICAgICAgICAgICAgIHJlcXVpcmVkX29uZV9vZj1Ob25lLCBhZGRfZmlsZV9jb21tb25fYXJncz1GYWxzZSwgc3VwcG9ydHNfY2hlY2tfbW9kZT1GYWxzZSwKICAgICAgICAgICAgICAgICByZXF1aXJlZF9pZj1Ob25lKToKCiAgICAgICAgJycnCiAgICAgICAgY29tbW9uIGNvZGUgZm9yIHF1aWNrbHkgYnVpbGRpbmcgYW4gYW5zaWJsZSBtb2R1bGUgaW4gUHl0aG9uCiAgICAgICAgKGFsdGhvdWdoIHlvdSBjYW4gd3JpdGUgbW9kdWxlcyBpbiBhbnl0aGluZyB0aGF0IGNhbiByZXR1cm4gSlNPTikKICAgICAgICBzZWUgbGlicmFyeS8qIGZvciBleGFtcGxlcwogICAgICAgICcnJwoKICAgICAgICBzZWxmLl9uYW1lID0gb3MucGF0aC5iYXNlbmFtZShfX2ZpbGVfXykgI2luaXRpYWxpemUgbmFtZSB1bnRpbCB3ZSBjYW4gcGFyc2UgZnJvbSBvcHRpb25zCiAgICAgICAgc2VsZi5hcmd1bWVudF9zcGVjID0gYXJndW1lbnRfc3BlYwogICAgICAgIHNlbGYuc3VwcG9ydHNfY2hlY2tfbW9kZSA9IHN1cHBvcnRzX2NoZWNrX21vZGUKICAgICAgICBzZWxmLmNoZWNrX21vZGUgPSBGYWxzZQogICAgICAgIHNlbGYubm9fbG9nID0gbm9fbG9nCiAgICAgICAgc2VsZi5jbGVhbnVwX2ZpbGVzID0gW10KICAgICAgICBzZWxmLl9kZWJ1ZyA9IEZhbHNlCiAgICAgICAgc2VsZi5fZGlmZiA9IEZhbHNlCiAgICAgICAgc2VsZi5fc29ja2V0X3BhdGggPSBOb25lCiAgICAgICAgc2VsZi5fdmVyYm9zaXR5ID0gMAogICAgICAgICMgTWF5IGJlIHVzZWQgdG8gc2V0IG1vZGlmaWNhdGlvbnMgdG8gdGhlIGVudmlyb25tZW50IGZvciBhbnkKICAgICAgICAjIHJ1bl9jb21tYW5kIGludm9jYXRpb24KICAgICAgICBzZWxmLnJ1bl9jb21tYW5kX2Vudmlyb25fdXBkYXRlID0ge30KICAgICAgICBzZWxmLl93YXJuaW5ncyA9IFtdCiAgICAgICAgc2VsZi5fZGVwcmVjYXRpb25zID0gW10KCiAgICAgICAgc2VsZi5hbGlhc2VzID0ge30KICAgICAgICBzZWxmLl9sZWdhbF9pbnB1dHMgPSBbJ19hbnNpYmxlX2NoZWNrX21vZGUnLCAnX2Fuc2libGVfbm9fbG9nJywgJ19hbnNpYmxlX2RlYnVnJywgJ19hbnNpYmxlX2RpZmYnLCAnX2Fuc2libGVfdmVyYm9zaXR5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ19hbnNpYmxlX3NlbGludXhfc3BlY2lhbF9mcycsICdfYW5zaWJsZV9tb2R1bGVfbmFtZScsICdfYW5zaWJsZV92ZXJzaW9uJywgJ19hbnNpYmxlX3N5c2xvZ19mYWNpbGl0eScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdfYW5zaWJsZV9zb2NrZXQnXQoKICAgICAgICBpZiBhZGRfZmlsZV9jb21tb25fYXJnczoKICAgICAgICAgICAgZm9yIGssIHYgaW4gRklMRV9DT01NT05fQVJHVU1FTlRTLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBrIG5vdCBpbiBzZWxmLmFyZ3VtZW50X3NwZWM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5hcmd1bWVudF9zcGVjW2tdID0gdgoKICAgICAgICBzZWxmLl9sb2FkX3BhcmFtcygpCiAgICAgICAgc2VsZi5fc2V0X2ZhbGxiYWNrcygpCgogICAgICAgICMgYXBwZW5kIHRvIGxlZ2FsX2lucHV0cyBhbmQgdGhlbiBwb3NzaWJseSBjaGVjayBhZ2FpbnN0IHRoZW0KICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuYWxpYXNlcyA9IHNlbGYuX2hhbmRsZV9hbGlhc2VzKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICMgVXNlIGV4Y2VwdGlvbnMgaGVyZSBiZWNhdXNlIGl0IGlzbid0IHNhZmUgdG8gY2FsbCBmYWlsX2pzb24gdW50aWwgbm9fbG9nIGlzIHByb2Nlc3NlZAogICAgICAgICAgICBwcmludCgnXG57ImZhaWxlZCI6IHRydWUsICJtc2ciOiAiTW9kdWxlIGFsaWFzIGVycm9yOiAlcyJ9JyAlIHN0cihlKSkKICAgICAgICAgICAgc3lzLmV4aXQoMSkKCiAgICAgICAgIyBTYXZlIHBhcmFtZXRlciB2YWx1ZXMgdGhhdCBzaG91bGQgbmV2ZXIgYmUgbG9nZ2VkCiAgICAgICAgc2VsZi5ub19sb2dfdmFsdWVzID0gc2V0KCkKICAgICAgICAjIFVzZSB0aGUgYXJnc3BlYyB0byBkZXRlcm1pbmUgd2hpY2ggYXJncyBhcmUgbm9fbG9nCiAgICAgICAgZm9yIGFyZ19uYW1lLCBhcmdfb3B0cyBpbiBzZWxmLmFyZ3VtZW50X3NwZWMuaXRlbXMoKToKICAgICAgICAgICAgaWYgYXJnX29wdHMuZ2V0KCdub19sb2cnLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAjIEZpbmQgdGhlIHZhbHVlIGZvciB0aGUgbm9fbG9nJ2QgcGFyYW0KICAgICAgICAgICAgICAgIG5vX2xvZ19vYmplY3QgPSBzZWxmLnBhcmFtcy5nZXQoYXJnX25hbWUsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBub19sb2dfb2JqZWN0OgogICAgICAgICAgICAgICAgICAgIHNlbGYubm9fbG9nX3ZhbHVlcy51cGRhdGUocmV0dXJuX3ZhbHVlcyhub19sb2dfb2JqZWN0KSkKCiAgICAgICAgICAgIGlmIGFyZ19vcHRzLmdldCgncmVtb3ZlZF9pbl92ZXJzaW9uJykgaXMgbm90IE5vbmUgYW5kIGFyZ19uYW1lIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgc2VsZi5fZGVwcmVjYXRpb25zLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAgICAgJ21zZyc6ICJQYXJhbSAnJXMnIGlzIGRlcHJlY2F0ZWQuIFNlZSB0aGUgbW9kdWxlIGRvY3MgZm9yIG1vcmUgaW5mb3JtYXRpb24iICUgYXJnX25hbWUsCiAgICAgICAgICAgICAgICAgICAgJ3ZlcnNpb24nOiBhcmdfb3B0cy5nZXQoJ3JlbW92ZWRfaW5fdmVyc2lvbicpCiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAjIGNoZWNrIHRoZSBsb2NhbGUgYXMgc2V0IGJ5IHRoZSBjdXJyZW50IGVudmlyb25tZW50LCBhbmQgcmVzZXQgdG8KICAgICAgICAjIGEga25vd24gdmFsaWQgKExBTkc9QykgaWYgaXQncyBhbiBpbnZhbGlkL3VuYXZhaWxhYmxlIGxvY2FsZQogICAgICAgIHNlbGYuX2NoZWNrX2xvY2FsZSgpCgogICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50cyhjaGVja19pbnZhbGlkX2FyZ3VtZW50cykKCiAgICAgICAgIyBjaGVjayBleGNsdXNpdmUgZWFybHkKICAgICAgICBpZiBub3QgYnlwYXNzX2NoZWNrczoKICAgICAgICAgICAgc2VsZi5fY2hlY2tfbXV0dWFsbHlfZXhjbHVzaXZlKG11dHVhbGx5X2V4Y2x1c2l2ZSkKCiAgICAgICAgc2VsZi5fc2V0X2RlZmF1bHRzKHByZT1UcnVlKQoKICAgICAgICBzZWxmLl9DSEVDS19BUkdVTUVOVF9UWVBFU19ESVNQQVRDSEVSID0gewogICAgICAgICAgICAnc3RyJzogc2VsZi5fY2hlY2tfdHlwZV9zdHIsCiAgICAgICAgICAgICdsaXN0Jzogc2VsZi5fY2hlY2tfdHlwZV9saXN0LAogICAgICAgICAgICAnZGljdCc6IHNlbGYuX2NoZWNrX3R5cGVfZGljdCwKICAgICAgICAgICAgJ2Jvb2wnOiBzZWxmLl9jaGVja190eXBlX2Jvb2wsCiAgICAgICAgICAgICdpbnQnOiBzZWxmLl9jaGVja190eXBlX2ludCwKICAgICAgICAgICAgJ2Zsb2F0Jzogc2VsZi5fY2hlY2tfdHlwZV9mbG9hdCwKICAgICAgICAgICAgJ3BhdGgnOiBzZWxmLl9jaGVja190eXBlX3BhdGgsCiAgICAgICAgICAgICdyYXcnOiBzZWxmLl9jaGVja190eXBlX3JhdywKICAgICAgICAgICAgJ2pzb25hcmcnOiBzZWxmLl9jaGVja190eXBlX2pzb25hcmcsCiAgICAgICAgICAgICdqc29uJzogc2VsZi5fY2hlY2tfdHlwZV9qc29uYXJnLAogICAgICAgICAgICAnYnl0ZXMnOiBzZWxmLl9jaGVja190eXBlX2J5dGVzLAogICAgICAgICAgICAnYml0cyc6IHNlbGYuX2NoZWNrX3R5cGVfYml0cywKICAgICAgICB9CiAgICAgICAgaWYgbm90IGJ5cGFzc19jaGVja3M6CiAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX2FyZ3VtZW50cygpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FyZ3VtZW50X3R5cGVzKCkKICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdmFsdWVzKCkKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfdG9nZXRoZXIocmVxdWlyZWRfdG9nZXRoZXIpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX29uZV9vZihyZXF1aXJlZF9vbmVfb2YpCiAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX2lmKHJlcXVpcmVkX2lmKQoKICAgICAgICBzZWxmLl9zZXRfZGVmYXVsdHMocHJlPUZhbHNlKQoKICAgICAgICBpZiBub3Qgc2VsZi5ub19sb2c6CiAgICAgICAgICAgIHNlbGYuX2xvZ19pbnZvY2F0aW9uKCkKCiAgICAgICAgIyBmaW5hbGx5LCBtYWtlIHN1cmUgd2UncmUgaW4gYSBzYW5lIHdvcmtpbmcgZGlyCiAgICAgICAgc2VsZi5fc2V0X2N3ZCgpCgogICAgZGVmIHdhcm4oc2VsZiwgd2FybmluZyk6CgogICAgICAgIGlmIGlzaW5zdGFuY2Uod2FybmluZywgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgc2VsZi5fd2FybmluZ3MuYXBwZW5kKHdhcm5pbmcpCiAgICAgICAgICAgIHNlbGYubG9nKCdbV0FSTklOR10gJXMnICUgd2FybmluZykKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoIndhcm4gcmVxdWlyZXMgYSBzdHJpbmcgbm90IGEgJXMiICUgdHlwZSh3YXJuaW5nKSkKCiAgICBkZWYgZGVwcmVjYXRlKHNlbGYsIG1zZywgdmVyc2lvbj1Ob25lKToKICAgICAgICBpZiBpc2luc3RhbmNlKG1zZywgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgc2VsZi5fZGVwcmVjYXRpb25zLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAnbXNnJzogbXNnLAogICAgICAgICAgICAgICAgJ3ZlcnNpb24nOiB2ZXJzaW9uCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIHNlbGYubG9nKCdbREVQUkVDQVRJT04gV0FSTklOR10gJXMgJXMnICUgKG1zZywgdmVyc2lvbikpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJkZXByZWNhdGUgcmVxdWlyZXMgYSBzdHJpbmcgbm90IGEgJXMiICUgdHlwZShtc2cpKQoKICAgIGRlZiBsb2FkX2ZpbGVfY29tbW9uX2FyZ3VtZW50cyhzZWxmLCBwYXJhbXMpOgogICAgICAgICcnJwogICAgICAgIG1hbnkgbW9kdWxlcyBkZWFsIHdpdGggZmlsZXMsIHRoaXMgZW5jYXBzdWxhdGVzIGNvbW1vbgogICAgICAgIG9wdGlvbnMgdGhhdCB0aGUgZmlsZSBtb2R1bGUgYWNjZXB0cyBzdWNoIHRoYXQgaXQgaXMgZGlyZWN0bHkKICAgICAgICBhdmFpbGFibGUgdG8gYWxsIG1vZHVsZXMgYW5kIHRoZXkgY2FuIHNoYXJlIGNvZGUuCiAgICAgICAgJycnCgogICAgICAgIHBhdGggPSBwYXJhbXMuZ2V0KCdwYXRoJywgcGFyYW1zLmdldCgnZGVzdCcsIE5vbmUpKQogICAgICAgIGlmIHBhdGggaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMocGF0aCkpCgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgIyBpZiB0aGUgcGF0aCBpcyBhIHN5bWxpbmssIGFuZCB3ZSdyZSBmb2xsb3dpbmcgbGlua3MsIGdldAogICAgICAgICMgdGhlIHRhcmdldCBvZiB0aGUgbGluayBpbnN0ZWFkIGZvciB0ZXN0aW5nCiAgICAgICAgaWYgcGFyYW1zLmdldCgnZm9sbG93JywgRmFsc2UpIGFuZCBvcy5wYXRoLmlzbGluayhiX3BhdGgpOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLnJlYWxwYXRoKGJfcGF0aCkKICAgICAgICAgICAgcGF0aCA9IHRvX25hdGl2ZShiX3BhdGgpCgogICAgICAgIG1vZGUgICA9IHBhcmFtcy5nZXQoJ21vZGUnLCBOb25lKQogICAgICAgIG93bmVyICA9IHBhcmFtcy5nZXQoJ293bmVyJywgTm9uZSkKICAgICAgICBncm91cCAgPSBwYXJhbXMuZ2V0KCdncm91cCcsIE5vbmUpCgogICAgICAgICMgc2VsaW51eCByZWxhdGVkIG9wdGlvbnMKICAgICAgICBzZXVzZXIgICAgPSBwYXJhbXMuZ2V0KCdzZXVzZXInLCBOb25lKQogICAgICAgIHNlcm9sZSAgICA9IHBhcmFtcy5nZXQoJ3Nlcm9sZScsIE5vbmUpCiAgICAgICAgc2V0eXBlICAgID0gcGFyYW1zLmdldCgnc2V0eXBlJywgTm9uZSkKICAgICAgICBzZWxldmVsICAgPSBwYXJhbXMuZ2V0KCdzZWxldmVsJywgTm9uZSkKICAgICAgICBzZWNvbnRleHQgPSBbc2V1c2VyLCBzZXJvbGUsIHNldHlwZV0KCiAgICAgICAgaWYgc2VsZi5zZWxpbnV4X21sc19lbmFibGVkKCk6CiAgICAgICAgICAgIHNlY29udGV4dC5hcHBlbmQoc2VsZXZlbCkKCiAgICAgICAgZGVmYXVsdF9zZWNvbnRleHQgPSBzZWxmLnNlbGludXhfZGVmYXVsdF9jb250ZXh0KHBhdGgpCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKGRlZmF1bHRfc2Vjb250ZXh0KSk6CiAgICAgICAgICAgIGlmIGkgaXMgbm90IE5vbmUgYW5kIHNlY29udGV4dFtpXSA9PSAnX2RlZmF1bHQnOgogICAgICAgICAgICAgICAgc2Vjb250ZXh0W2ldID0gZGVmYXVsdF9zZWNvbnRleHRbaV0KCiAgICAgICAgYXR0cmlidXRlcyA9IHBhcmFtcy5nZXQoJ2F0dHJpYnV0ZXMnLCBOb25lKQogICAgICAgIHJldHVybiBkaWN0KAogICAgICAgICAgICBwYXRoPXBhdGgsIG1vZGU9bW9kZSwgb3duZXI9b3duZXIsIGdyb3VwPWdyb3VwLAogICAgICAgICAgICBzZXVzZXI9c2V1c2VyLCBzZXJvbGU9c2Vyb2xlLCBzZXR5cGU9c2V0eXBlLAogICAgICAgICAgICBzZWxldmVsPXNlbGV2ZWwsIHNlY29udGV4dD1zZWNvbnRleHQsIGF0dHJpYnV0ZXM9YXR0cmlidXRlcywKICAgICAgICApCgoKICAgICMgRGV0ZWN0IHdoZXRoZXIgdXNpbmcgc2VsaW51eCB0aGF0IGlzIE1MUy1hd2FyZS4KICAgICMgV2hpbGUgdGhpcyBtZWFucyB5b3UgY2FuIHNldCB0aGUgbGV2ZWwvcmFuZ2Ugd2l0aAogICAgIyBzZWxpbnV4LmxzZXRmaWxlY29uKCksIGl0IG1heSBvciBtYXkgbm90IG1lYW4gdGhhdCB5b3UKICAgICMgd2lsbCBnZXQgdGhlIHNlbGV2ZWwgYXMgcGFydCBvZiB0aGUgY29udGV4dCByZXR1cm5lZAogICAgIyBieSBzZWxpbnV4LmxnZXRmaWxlY29uKCkuCgogICAgZGVmIHNlbGludXhfbWxzX2VuYWJsZWQoc2VsZik6CiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgaWYgc2VsaW51eC5pc19zZWxpbnV4X21sc19lbmFibGVkKCkgPT0gMToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgc2VsaW51eF9lbmFibGVkKHNlbGYpOgogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVg6CiAgICAgICAgICAgIHNlZW5hYmxlZCA9IHNlbGYuZ2V0X2Jpbl9wYXRoKCdzZWxpbnV4ZW5hYmxlZCcpCiAgICAgICAgICAgIGlmIHNlZW5hYmxlZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIChyYyxvdXQsZXJyKSA9IHNlbGYucnVuX2NvbW1hbmQoc2VlbmFibGVkKQogICAgICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IkFib3J0aW5nLCB0YXJnZXQgdXNlcyBzZWxpbnV4IGJ1dCBweXRob24gYmluZGluZ3MgKGxpYnNlbGludXgtcHl0aG9uKSBhcmVuJ3QgaW5zdGFsbGVkISIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGlmIHNlbGludXguaXNfc2VsaW51eF9lbmFibGVkKCkgPT0gMToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAjIERldGVybWluZSB3aGV0aGVyIHdlIG5lZWQgYSBwbGFjZWhvbGRlciBmb3Igc2VsZXZlbC9tbHMKICAgIGRlZiBzZWxpbnV4X2luaXRpYWxfY29udGV4dChzZWxmKToKICAgICAgICBjb250ZXh0ID0gW05vbmUsIE5vbmUsIE5vbmVdCiAgICAgICAgaWYgc2VsZi5zZWxpbnV4X21sc19lbmFibGVkKCk6CiAgICAgICAgICAgIGNvbnRleHQuYXBwZW5kKE5vbmUpCiAgICAgICAgcmV0dXJuIGNvbnRleHQKCiAgICAjIElmIHNlbGludXggZmFpbHMgdG8gZmluZCBhIGRlZmF1bHQsIHJldHVybiBhbiBhcnJheSBvZiBOb25lCiAgICBkZWYgc2VsaW51eF9kZWZhdWx0X2NvbnRleHQoc2VsZiwgcGF0aCwgbW9kZT0wKToKICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2luaXRpYWxfY29udGV4dCgpCiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldCA9IHNlbGludXgubWF0Y2hwYXRoY29uKHRvX25hdGl2ZShwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKSwgbW9kZSkKICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICBpZiByZXRbMF0gPT0gLTE6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgIyBMaW1pdCBzcGxpdCB0byA0IGJlY2F1c2UgdGhlIHNlbGV2ZWwsIHRoZSBsYXN0IGluIHRoZSBsaXN0LAogICAgICAgICMgbWF5IGNvbnRhaW4gJzonIGNoYXJhY3RlcnMKICAgICAgICBjb250ZXh0ID0gcmV0WzFdLnNwbGl0KCc6JywgMykKICAgICAgICByZXR1cm4gY29udGV4dAoKICAgIGRlZiBzZWxpbnV4X2NvbnRleHQoc2VsZiwgcGF0aCk6CiAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9pbml0aWFsX2NvbnRleHQoKQogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVggb3Igbm90IHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXQgPSBzZWxpbnV4LmxnZXRmaWxlY29uX3Jhdyh0b19uYXRpdmUocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykpCiAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgaWYgZS5lcnJubyA9PSBlcnJuby5FTk9FTlQ6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0ncGF0aCAlcyBkb2VzIG5vdCBleGlzdCcgJSBwYXRoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2ZhaWxlZCB0byByZXRyaWV2ZSBzZWxpbnV4IGNvbnRleHQnKQogICAgICAgIGlmIHJldFswXSA9PSAtMToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICAjIExpbWl0IHNwbGl0IHRvIDQgYmVjYXVzZSB0aGUgc2VsZXZlbCwgdGhlIGxhc3QgaW4gdGhlIGxpc3QsCiAgICAgICAgIyBtYXkgY29udGFpbiAnOicgY2hhcmFjdGVycwogICAgICAgIGNvbnRleHQgPSByZXRbMV0uc3BsaXQoJzonLCAzKQogICAgICAgIHJldHVybiBjb250ZXh0CgogICAgZGVmIHVzZXJfYW5kX2dyb3VwKHNlbGYsIHBhdGgsIGV4cGFuZD1UcnVlKToKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgc3QgPSBvcy5sc3RhdChiX3BhdGgpCiAgICAgICAgdWlkID0gc3Quc3RfdWlkCiAgICAgICAgZ2lkID0gc3Quc3RfZ2lkCiAgICAgICAgcmV0dXJuICh1aWQsIGdpZCkKCiAgICBkZWYgZmluZF9tb3VudF9wb2ludChzZWxmLCBwYXRoKToKICAgICAgICBwYXRoX2lzX2J5dGVzID0gRmFsc2UKICAgICAgICBpZiBpc2luc3RhbmNlKHBhdGgsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgcGF0aF9pc19ieXRlcyA9IFRydWUKCiAgICAgICAgYl9wYXRoID0gb3MucGF0aC5yZWFscGF0aCh0b19ieXRlcyhvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKHBhdGgpKSwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykpCiAgICAgICAgd2hpbGUgbm90IG9zLnBhdGguaXNtb3VudChiX3BhdGgpOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmRpcm5hbWUoYl9wYXRoKQoKICAgICAgICBpZiBwYXRoX2lzX2J5dGVzOgogICAgICAgICAgICByZXR1cm4gYl9wYXRoCgogICAgICAgIHJldHVybiB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKCiAgICBkZWYgaXNfc3BlY2lhbF9zZWxpbnV4X3BhdGgoc2VsZiwgcGF0aCk6CiAgICAgICAgIiIiCiAgICAgICAgUmV0dXJucyBhIHR1cGxlIGNvbnRhaW5pbmcgKFRydWUsIHNlbGludXhfY29udGV4dCkgaWYgdGhlIGdpdmVuIHBhdGggaXMgb24gYQogICAgICAgIE5GUyBvciBvdGhlciAnc3BlY2lhbCcgZnMgIG1vdW50IHBvaW50LCBvdGhlcndpc2UgdGhlIHJldHVybiB3aWxsIGJlIChGYWxzZSwgTm9uZSkuCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmID0gb3BlbignL3Byb2MvbW91bnRzJywgJ3InKQogICAgICAgICAgICBtb3VudF9kYXRhID0gZi5yZWFkbGluZXMoKQogICAgICAgICAgICBmLmNsb3NlKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiAoRmFsc2UsIE5vbmUpCiAgICAgICAgcGF0aF9tb3VudF9wb2ludCA9IHNlbGYuZmluZF9tb3VudF9wb2ludChwYXRoKQogICAgICAgIGZvciBsaW5lIGluIG1vdW50X2RhdGE6CiAgICAgICAgICAgIChkZXZpY2UsIG1vdW50X3BvaW50LCBmc3R5cGUsIG9wdGlvbnMsIHJlc3QpID0gbGluZS5zcGxpdCgnICcsIDQpCgogICAgICAgICAgICBpZiBwYXRoX21vdW50X3BvaW50ID09IG1vdW50X3BvaW50OgogICAgICAgICAgICAgICAgZm9yIGZzIGluIHNlbGYuX3NlbGludXhfc3BlY2lhbF9mczoKICAgICAgICAgICAgICAgICAgICBpZiBmcyBpbiBmc3R5cGU6CiAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpYWxfY29udGV4dCA9IHNlbGYuc2VsaW51eF9jb250ZXh0KHBhdGhfbW91bnRfcG9pbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoVHJ1ZSwgc3BlY2lhbF9jb250ZXh0KQoKICAgICAgICByZXR1cm4gKEZhbHNlLCBOb25lKQoKICAgIGRlZiBzZXRfZGVmYXVsdF9zZWxpbnV4X2NvbnRleHQoc2VsZiwgcGF0aCwgY2hhbmdlZCk6CiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2RlZmF1bHRfY29udGV4dChwYXRoKQogICAgICAgIHJldHVybiBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudChwYXRoLCBjb250ZXh0LCBGYWxzZSkKCiAgICBkZWYgc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIGNvbnRleHQsIGNoYW5nZWQsIGRpZmY9Tm9uZSk6CgogICAgICAgIGlmIG5vdCBIQVZFX1NFTElOVVggb3Igbm90IHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCiAgICAgICAgY3VyX2NvbnRleHQgPSBzZWxmLnNlbGludXhfY29udGV4dChwYXRoKQogICAgICAgIG5ld19jb250ZXh0ID0gbGlzdChjdXJfY29udGV4dCkKICAgICAgICAjIEl0ZXJhdGUgb3ZlciB0aGUgY3VycmVudCBjb250ZXh0IGluc3RlYWQgb2YgdGhlCiAgICAgICAgIyBhcmd1bWVudCBjb250ZXh0LCB3aGljaCBtYXkgaGF2ZSBzZWxldmVsLgoKICAgICAgICAoaXNfc3BlY2lhbF9zZSwgc3BfY29udGV4dCkgPSBzZWxmLmlzX3NwZWNpYWxfc2VsaW51eF9wYXRoKHBhdGgpCiAgICAgICAgaWYgaXNfc3BlY2lhbF9zZToKICAgICAgICAgICAgbmV3X2NvbnRleHQgPSBzcF9jb250ZXh0CiAgICAgICAgZWxzZToKICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKGN1cl9jb250ZXh0KSk6CiAgICAgICAgICAgICAgICBpZiBsZW4oY29udGV4dCkgPiBpOgogICAgICAgICAgICAgICAgICAgIGlmIGNvbnRleHRbaV0gaXMgbm90IE5vbmUgYW5kIGNvbnRleHRbaV0gIT0gY3VyX2NvbnRleHRbaV06CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld19jb250ZXh0W2ldID0gY29udGV4dFtpXQogICAgICAgICAgICAgICAgICAgIGVsaWYgY29udGV4dFtpXSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICBuZXdfY29udGV4dFtpXSA9IGN1cl9jb250ZXh0W2ldCgogICAgICAgIGlmIGN1cl9jb250ZXh0ICE9IG5ld19jb250ZXh0OgogICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ3NlY29udGV4dCddID0gY3VyX2NvbnRleHQKICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydzZWNvbnRleHQnXSA9IG5ld19jb250ZXh0CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIHJjID0gc2VsaW51eC5sc2V0ZmlsZWNvbih0b19uYXRpdmUocGF0aCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyKCc6Jy5qb2luKG5ld19jb250ZXh0KSkpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2ludmFsaWQgc2VsaW51eCBjb250ZXh0OiAlcycgJSBzdHIoZSksIG5ld19jb250ZXh0PW5ld19jb250ZXh0LCBjdXJfY29udGV4dD1jdXJfY29udGV4dCwgaW5wdXRfd2FzPWNvbnRleHQpCiAgICAgICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nc2V0IHNlbGludXggY29udGV4dCBmYWlsZWQnKQogICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9vd25lcl9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgb3duZXIsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBwYXRoID0gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBvd25lciBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAogICAgICAgIG9yaWdfdWlkLCBvcmlnX2dpZCA9IHNlbGYudXNlcl9hbmRfZ3JvdXAocGF0aCwgZXhwYW5kKQogICAgICAgIHRyeToKICAgICAgICAgICAgdWlkID0gaW50KG93bmVyKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB1aWQgPSBwd2QuZ2V0cHduYW0ob3duZXIpLnB3X3VpZAogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hvd24gZmFpbGVkOiBmYWlsZWQgdG8gbG9vayB1cCB1c2VyICVzJyAlIG93bmVyKQogICAgICAgIGlmIG9yaWdfdWlkICE9IHVpZDoKCiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnb3duZXInXSA9IG9yaWdfdWlkCiAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnb3duZXInXSA9IHVpZAoKICAgICAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MubGNob3duKGJfcGF0aCwgdWlkLCAtMSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hvd24gZmFpbGVkJykKICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfZ3JvdXBfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIGdyb3VwLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgcGF0aCA9IHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZ3JvdXAgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKICAgICAgICBvcmlnX3VpZCwgb3JpZ19naWQgPSBzZWxmLnVzZXJfYW5kX2dyb3VwKGJfcGF0aCwgZXhwYW5kKQogICAgICAgIHRyeToKICAgICAgICAgICAgZ2lkID0gaW50KGdyb3VwKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBnaWQgPSBncnAuZ2V0Z3JuYW0oZ3JvdXApLmdyX2dpZAogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hncnAgZmFpbGVkOiBmYWlsZWQgdG8gbG9vayB1cCBncm91cCAlcycgJSBncm91cCkKICAgICAgICBpZiBvcmlnX2dpZCAhPSBnaWQ6CgogICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ2dyb3VwJ10gPSBvcmlnX2dpZAogICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ2dyb3VwJ10gPSBnaWQKCiAgICAgICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLmxjaG93bihiX3BhdGgsIC0xLCBnaWQpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2NoZ3JwIGZhaWxlZCcpCiAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X21vZGVfaWZfZGlmZmVyZW50KHNlbGYsIHBhdGgsIG1vZGUsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBwYXRoID0gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBwYXRoX3N0YXQgPSBvcy5sc3RhdChiX3BhdGgpCgogICAgICAgIGlmIG1vZGUgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UobW9kZSwgaW50KToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbW9kZSA9IGludChtb2RlLCA4KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG1vZGUgPSBzZWxmLl9zeW1ib2xpY19tb2RlX3RvX29jdGFsKHBhdGhfc3RhdCwgbW9kZSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2c9Im1vZGUgbXVzdCBiZSBpbiBvY3RhbCBvciBzeW1ib2xpYyBmb3JtIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWxzPXN0cihlKSkKCiAgICAgICAgICAgICAgICBpZiBtb2RlICE9IHN0YXQuU19JTU9ERShtb2RlKToKICAgICAgICAgICAgICAgICAgICAjIHByZXZlbnQgbW9kZSBmcm9tIGhhdmluZyBleHRyYSBpbmZvIG9yYmVpbmcgaW52YWxpZCBsb25nIG51bWJlcgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSJJbnZhbGlkIG1vZGUgc3VwcGxpZWQsIG9ubHkgcGVybWlzc2lvbiBpbmZvIGlzIGFsbG93ZWQiLCBkZXRhaWxzPW1vZGUpCgogICAgICAgIHByZXZfbW9kZSA9IHN0YXQuU19JTU9ERShwYXRoX3N0YXQuc3RfbW9kZSkKCiAgICAgICAgaWYgcHJldl9tb2RlICE9IG1vZGU6CgogICAgICAgICAgICBpZiBkaWZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ11bJ21vZGUnXSA9ICcwJTAzbycgJSBwcmV2X21vZGUKICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydtb2RlJ10gPSAnMCUwM28nICUgbW9kZQoKICAgICAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgIyBGSVhNRTogY29tcGFyaXNvbiBhZ2FpbnN0IHN0cmluZyBhYm92ZSB3aWxsIGNhdXNlIHRoaXMgdG8gYmUgZXhlY3V0ZWQKICAgICAgICAgICAgIyBldmVyeSB0aW1lCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIob3MsICdsY2htb2QnKToKICAgICAgICAgICAgICAgICAgICBvcy5sY2htb2QoYl9wYXRoLCBtb2RlKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2xpbmsoYl9wYXRoKToKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2htb2QoYl9wYXRoLCBtb2RlKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQXR0ZW1wdCB0byBzZXQgdGhlIHBlcm1zIG9mIHRoZSBzeW1saW5rIGJ1dCBiZQogICAgICAgICAgICAgICAgICAgICAgICAjIGNhcmVmdWwgbm90IHRvIGNoYW5nZSB0aGUgcGVybXMgb2YgdGhlIHVuZGVybHlpbmcKICAgICAgICAgICAgICAgICAgICAgICAgIyBmaWxlIHdoaWxlIHRyeWluZwogICAgICAgICAgICAgICAgICAgICAgICB1bmRlcmx5aW5nX3N0YXQgPSBvcy5zdGF0KGJfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2htb2QoYl9wYXRoLCBtb2RlKQogICAgICAgICAgICAgICAgICAgICAgICBuZXdfdW5kZXJseWluZ19zdGF0ID0gb3Muc3RhdChiX3BhdGgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVuZGVybHlpbmdfc3RhdC5zdF9tb2RlICE9IG5ld191bmRlcmx5aW5nX3N0YXQuc3RfbW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNobW9kKGJfcGF0aCwgc3RhdC5TX0lNT0RFKHVuZGVybHlpbmdfc3RhdC5zdF9tb2RlKSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmlzbGluayhiX3BhdGgpIGFuZCBlLmVycm5vID09IGVycm5vLkVQRVJNOiAgIyBDYW4ndCBzZXQgbW9kZSBvbiBzeW1ib2xpYyBsaW5rcwogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIGVsaWYgZS5lcnJubyBpbiAoZXJybm8uRU5PRU5ULCBlcnJuby5FTE9PUCk6ICMgQ2FuJ3Qgc2V0IG1vZGUgb24gYnJva2VuIHN5bWJvbGljIGxpbmtzCiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByYWlzZSBlCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2htb2QgZmFpbGVkJywgZGV0YWlscz1zdHIoZSkpCgogICAgICAgICAgICBwYXRoX3N0YXQgPSBvcy5sc3RhdChiX3BhdGgpCiAgICAgICAgICAgIG5ld19tb2RlID0gc3RhdC5TX0lNT0RFKHBhdGhfc3RhdC5zdF9tb2RlKQoKICAgICAgICAgICAgaWYgbmV3X21vZGUgIT0gcHJldl9tb2RlOgogICAgICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgYXR0cmlidXRlcywgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CgogICAgICAgIGlmIGF0dHJpYnV0ZXMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHBhdGggPSB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQoKICAgICAgICBleGlzdGluZyA9IHNlbGYuZ2V0X2ZpbGVfYXR0cmlidXRlcyhiX3BhdGgpCgogICAgICAgIGlmIGV4aXN0aW5nLmdldCgnYXR0cl9mbGFncycsJycpICE9IGF0dHJpYnV0ZXM6CiAgICAgICAgICAgIGF0dHJjbWQgPSBzZWxmLmdldF9iaW5fcGF0aCgnY2hhdHRyJykKICAgICAgICAgICAgaWYgYXR0cmNtZDoKICAgICAgICAgICAgICAgIGF0dHJjbWQgPSBbYXR0cmNtZCwgJz0lcycgJSBhdHRyaWJ1dGVzLCBiX3BhdGhdCiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQoKICAgICAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgaWYgJ2JlZm9yZScgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnYXR0cmlidXRlcyddID0gZXhpc3RpbmcuZ2V0KCdhdHRyX2ZsYWdzJykKICAgICAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydhdHRyaWJ1dGVzJ10gPSBhdHRyaWJ1dGVzCgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJjLCBvdXQsIGVyciA9IHNlbGYucnVuX2NvbW1hbmQoYXR0cmNtZCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmMgIT0gMCBvciBlcnI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIkVycm9yIHdoaWxlIHNldHRpbmcgYXR0cmlidXRlczogJXMiICUgKG91dCArIGVycikpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaGF0dHIgZmFpbGVkJywgZGV0YWlscz1zdHIoZSkpCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgZ2V0X2ZpbGVfYXR0cmlidXRlcyhzZWxmLCBwYXRoKToKICAgICAgICBvdXRwdXQgPSB7fQogICAgICAgIGF0dHJjbWQgPSBzZWxmLmdldF9iaW5fcGF0aCgnbHNhdHRyJywgRmFsc2UpCiAgICAgICAgaWYgYXR0cmNtZDoKICAgICAgICAgICAgYXR0cmNtZCA9IFthdHRyY21kLCAnLXZkJywgcGF0aF0KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5ydW5fY29tbWFuZChhdHRyY21kKQogICAgICAgICAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgICAgICAgICByZXMgPSBvdXQuc3BsaXQoJyAnKVswOjJdCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0WydhdHRyX2ZsYWdzJ10gPSAgcmVzWzFdLnJlcGxhY2UoJy0nLCcnKS5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0Wyd2ZXJzaW9uJ10gPSByZXNbMF0uc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIG91dHB1dFsnYXR0cmlidXRlcyddID0gZm9ybWF0X2F0dHJpYnV0ZXMob3V0cHV0WydhdHRyX2ZsYWdzJ10pCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gb3V0cHV0CgoKICAgIGRlZiBfc3ltYm9saWNfbW9kZV90b19vY3RhbChzZWxmLCBwYXRoX3N0YXQsIHN5bWJvbGljX21vZGUpOgogICAgICAgIG5ld19tb2RlID0gc3RhdC5TX0lNT0RFKHBhdGhfc3RhdC5zdF9tb2RlKQoKICAgICAgICBtb2RlX3JlID0gcmUuY29tcGlsZShyJ14oP1A8dXNlcnM+W3Vnb2FdKykoP1A8b3BlcmF0b3I+Wy0rPV0pKD9QPHBlcm1zPltyd3hYc3QtXSp8W3Vnb10pJCcpCiAgICAgICAgZm9yIG1vZGUgaW4gc3ltYm9saWNfbW9kZS5zcGxpdCgnLCcpOgogICAgICAgICAgICBtYXRjaCA9IG1vZGVfcmUubWF0Y2gobW9kZSkKICAgICAgICAgICAgaWYgbWF0Y2g6CiAgICAgICAgICAgICAgICB1c2VycyA9IG1hdGNoLmdyb3VwKCd1c2VycycpCiAgICAgICAgICAgICAgICBvcGVyYXRvciA9IG1hdGNoLmdyb3VwKCdvcGVyYXRvcicpCiAgICAgICAgICAgICAgICBwZXJtcyA9IG1hdGNoLmdyb3VwKCdwZXJtcycpCgogICAgICAgICAgICAgICAgaWYgdXNlcnMgPT0gJ2EnOgogICAgICAgICAgICAgICAgICAgIHVzZXJzID0gJ3VnbycKCiAgICAgICAgICAgICAgICBmb3IgdXNlciBpbiB1c2VyczoKICAgICAgICAgICAgICAgICAgICBtb2RlX3RvX2FwcGx5ID0gc2VsZi5fZ2V0X29jdGFsX21vZGVfZnJvbV9zeW1ib2xpY19wZXJtcyhwYXRoX3N0YXQsIHVzZXIsIHBlcm1zKQogICAgICAgICAgICAgICAgICAgIG5ld19tb2RlID0gc2VsZi5fYXBwbHlfb3BlcmF0aW9uX3RvX21vZGUodXNlciwgb3BlcmF0b3IsIG1vZGVfdG9fYXBwbHksIG5ld19tb2RlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiYmFkIHN5bWJvbGljIHBlcm1pc3Npb24gZm9yIG1vZGU6ICVzIiAlIG1vZGUpCiAgICAgICAgcmV0dXJuIG5ld19tb2RlCgogICAgZGVmIF9hcHBseV9vcGVyYXRpb25fdG9fbW9kZShzZWxmLCB1c2VyLCBvcGVyYXRvciwgbW9kZV90b19hcHBseSwgY3VycmVudF9tb2RlKToKICAgICAgICBpZiBvcGVyYXRvciAgPT0gICc9JzoKICAgICAgICAgICAgaWYgdXNlciA9PSAndSc6CiAgICAgICAgICAgICAgICBtYXNrID0gc3RhdC5TX0lSV1hVIHwgc3RhdC5TX0lTVUlECiAgICAgICAgICAgIGVsaWYgdXNlciA9PSAnZyc6CiAgICAgICAgICAgICAgICBtYXNrID0gc3RhdC5TX0lSV1hHIHwgc3RhdC5TX0lTR0lECiAgICAgICAgICAgIGVsaWYgdXNlciA9PSAnbyc6CiAgICAgICAgICAgICAgICBtYXNrID0gc3RhdC5TX0lSV1hPIHwgc3RhdC5TX0lTVlRYCgogICAgICAgICAgICAjIG1hc2sgb3V0IHUsIGcsIG9yIG8gcGVybWlzc2lvbnMgZnJvbSBjdXJyZW50X21vZGUgYW5kIGFwcGx5IG5ldyBwZXJtaXNzaW9ucwogICAgICAgICAgICBpbnZlcnNlX21hc2sgPSBtYXNrIF4gUEVSTV9CSVRTCiAgICAgICAgICAgIG5ld19tb2RlID0gKGN1cnJlbnRfbW9kZSAmIGludmVyc2VfbWFzaykgfCBtb2RlX3RvX2FwcGx5CiAgICAgICAgZWxpZiBvcGVyYXRvciA9PSAnKyc6CiAgICAgICAgICAgIG5ld19tb2RlID0gY3VycmVudF9tb2RlIHwgbW9kZV90b19hcHBseQogICAgICAgIGVsaWYgb3BlcmF0b3IgPT0gJy0nOgogICAgICAgICAgICBuZXdfbW9kZSA9IGN1cnJlbnRfbW9kZSAtIChjdXJyZW50X21vZGUgJiBtb2RlX3RvX2FwcGx5KQogICAgICAgIHJldHVybiBuZXdfbW9kZQoKICAgIGRlZiBfZ2V0X29jdGFsX21vZGVfZnJvbV9zeW1ib2xpY19wZXJtcyhzZWxmLCBwYXRoX3N0YXQsIHVzZXIsIHBlcm1zKToKICAgICAgICBwcmV2X21vZGUgPSBzdGF0LlNfSU1PREUocGF0aF9zdGF0LnN0X21vZGUpCgogICAgICAgIGlzX2RpcmVjdG9yeSA9IHN0YXQuU19JU0RJUihwYXRoX3N0YXQuc3RfbW9kZSkKICAgICAgICBoYXNfeF9wZXJtaXNzaW9ucyA9IChwcmV2X21vZGUgJiBFWEVDX1BFUk1fQklUUykgPiAwCiAgICAgICAgYXBwbHlfWF9wZXJtaXNzaW9uID0gaXNfZGlyZWN0b3J5IG9yIGhhc194X3Blcm1pc3Npb25zCgogICAgICAgICMgUGVybWlzc2lvbiBiaXRzIGNvbnN0YW50cyBkb2N1bWVudGVkIGF0OgogICAgICAgICMgaHR0cDovL2RvY3MucHl0aG9uLm9yZy8yL2xpYnJhcnkvc3RhdC5odG1sI3N0YXQuU19JU1VJRAogICAgICAgIGlmIGFwcGx5X1hfcGVybWlzc2lvbjoKICAgICAgICAgICAgWF9wZXJtcyA9IHsKICAgICAgICAgICAgICAgICd1JzogeydYJzogc3RhdC5TX0lYVVNSfSwKICAgICAgICAgICAgICAgICdnJzogeydYJzogc3RhdC5TX0lYR1JQfSwKICAgICAgICAgICAgICAgICdvJzogeydYJzogc3RhdC5TX0lYT1RIfQogICAgICAgICAgICB9CiAgICAgICAgZWxzZToKICAgICAgICAgICAgWF9wZXJtcyA9IHsKICAgICAgICAgICAgICAgICd1JzogeydYJzogMH0sCiAgICAgICAgICAgICAgICAnZyc6IHsnWCc6IDB9LAogICAgICAgICAgICAgICAgJ28nOiB7J1gnOiAwfQogICAgICAgICAgICB9CgogICAgICAgIHVzZXJfcGVybXNfdG9fbW9kZXMgPSB7CiAgICAgICAgICAgICd1JzogewogICAgICAgICAgICAgICAgJ3InOiBzdGF0LlNfSVJVU1IsCiAgICAgICAgICAgICAgICAndyc6IHN0YXQuU19JV1VTUiwKICAgICAgICAgICAgICAgICd4Jzogc3RhdC5TX0lYVVNSLAogICAgICAgICAgICAgICAgJ3MnOiBzdGF0LlNfSVNVSUQsCiAgICAgICAgICAgICAgICAndCc6IDAsCiAgICAgICAgICAgICAgICAndSc6IHByZXZfbW9kZSAmIHN0YXQuU19JUldYVSwKICAgICAgICAgICAgICAgICdnJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYRykgPDwgMywKICAgICAgICAgICAgICAgICdvJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYTykgPDwgNiB9LAogICAgICAgICAgICAnZyc6IHsKICAgICAgICAgICAgICAgICdyJzogc3RhdC5TX0lSR1JQLAogICAgICAgICAgICAgICAgJ3cnOiBzdGF0LlNfSVdHUlAsCiAgICAgICAgICAgICAgICAneCc6IHN0YXQuU19JWEdSUCwKICAgICAgICAgICAgICAgICdzJzogc3RhdC5TX0lTR0lELAogICAgICAgICAgICAgICAgJ3QnOiAwLAogICAgICAgICAgICAgICAgJ3UnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hVKSA+PiAzLAogICAgICAgICAgICAgICAgJ2cnOiBwcmV2X21vZGUgJiBzdGF0LlNfSVJXWEcsCiAgICAgICAgICAgICAgICAnbyc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWE8pIDw8IDMgfSwKICAgICAgICAgICAgJ28nOiB7CiAgICAgICAgICAgICAgICAncic6IHN0YXQuU19JUk9USCwKICAgICAgICAgICAgICAgICd3Jzogc3RhdC5TX0lXT1RILAogICAgICAgICAgICAgICAgJ3gnOiBzdGF0LlNfSVhPVEgsCiAgICAgICAgICAgICAgICAncyc6IDAsCiAgICAgICAgICAgICAgICAndCc6IHN0YXQuU19JU1ZUWCwKICAgICAgICAgICAgICAgICd1JzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYVSkgPj4gNiwKICAgICAgICAgICAgICAgICdnJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYRykgPj4gMywKICAgICAgICAgICAgICAgICdvJzogcHJldl9tb2RlICYgc3RhdC5TX0lSV1hPIH0KICAgICAgICB9CgogICAgICAgICMgSW5zZXJ0IFhfcGVybXMgaW50byB1c2VyX3Blcm1zX3RvX21vZGVzCiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gWF9wZXJtcy5pdGVtcygpOgogICAgICAgICAgICB1c2VyX3Blcm1zX3RvX21vZGVzW2tleV0udXBkYXRlKHZhbHVlKQoKICAgICAgICBvcl9yZWR1Y2UgPSBsYW1iZGEgbW9kZSwgcGVybTogbW9kZSB8IHVzZXJfcGVybXNfdG9fbW9kZXNbdXNlcl1bcGVybV0KICAgICAgICByZXR1cm4gcmVkdWNlKG9yX3JlZHVjZSwgcGVybXMsIDApCgogICAgZGVmIHNldF9mc19hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChzZWxmLCBmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgICMgc2V0IG1vZGVzIG93bmVycyBhbmQgY29udGV4dCBhcyBuZWVkZWQKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ3NlY29udGV4dCddLCBjaGFuZ2VkLCBkaWZmCiAgICAgICAgKQogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9vd25lcl9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ293bmVyJ10sIGNoYW5nZWQsIGRpZmYsIGV4cGFuZAogICAgICAgICkKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfZ3JvdXBfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydncm91cCddLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQKICAgICAgICApCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X21vZGVfaWZfZGlmZmVyZW50KAogICAgICAgICAgICBmaWxlX2FyZ3NbJ3BhdGgnXSwgZmlsZV9hcmdzWydtb2RlJ10sIGNoYW5nZWQsIGRpZmYsIGV4cGFuZAogICAgICAgICkKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ2F0dHJpYnV0ZXMnXSwgY2hhbmdlZCwgZGlmZiwgZXhwYW5kCiAgICAgICAgKQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9kaXJlY3RvcnlfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoc2VsZiwgZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICByZXR1cm4gc2VsZi5zZXRfZnNfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQpCgogICAgZGVmIHNldF9maWxlX2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KHNlbGYsIGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgcmV0dXJuIHNlbGYuc2V0X2ZzX2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZiwgZXhwYW5kKQoKICAgIGRlZiBhZGRfcGF0aF9pbmZvKHNlbGYsIGt3YXJncyk6CiAgICAgICAgJycnCiAgICAgICAgZm9yIHJlc3VsdHMgdGhhdCBhcmUgZmlsZXMsIHN1cHBsZW1lbnQgdGhlIGluZm8gYWJvdXQgdGhlIGZpbGUKICAgICAgICBpbiB0aGUgcmV0dXJuIHBhdGggd2l0aCBzdGF0cyBhYm91dCB0aGUgZmlsZSBwYXRoLgogICAgICAgICcnJwoKICAgICAgICBwYXRoID0ga3dhcmdzLmdldCgncGF0aCcsIGt3YXJncy5nZXQoJ2Rlc3QnLCBOb25lKSkKICAgICAgICBpZiBwYXRoIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBrd2FyZ3MKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGJfcGF0aCk6CiAgICAgICAgICAgICh1aWQsIGdpZCkgPSBzZWxmLnVzZXJfYW5kX2dyb3VwKHBhdGgpCiAgICAgICAgICAgIGt3YXJnc1sndWlkJ10gPSB1aWQKICAgICAgICAgICAga3dhcmdzWydnaWQnXSA9IGdpZAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB1c2VyID0gcHdkLmdldHB3dWlkKHVpZClbMF0KICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgdXNlciA9IHN0cih1aWQpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGdyb3VwID0gZ3JwLmdldGdyZ2lkKGdpZClbMF0KICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgZ3JvdXAgPSBzdHIoZ2lkKQogICAgICAgICAgICBrd2FyZ3NbJ293bmVyJ10gPSB1c2VyCiAgICAgICAgICAgIGt3YXJnc1snZ3JvdXAnXSA9IGdyb3VwCiAgICAgICAgICAgIHN0ID0gb3MubHN0YXQoYl9wYXRoKQogICAgICAgICAgICBrd2FyZ3NbJ21vZGUnXSA9ICcwJTAzbycgJSBzdGF0LlNfSU1PREUoc3Rbc3RhdC5TVF9NT0RFXSkKICAgICAgICAgICAgIyBzZWNvbnRleHQgbm90IHlldCBzdXBwb3J0ZWQKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2xpbmsoYl9wYXRoKToKICAgICAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdsaW5rJwogICAgICAgICAgICBlbGlmIG9zLnBhdGguaXNkaXIoYl9wYXRoKToKICAgICAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdkaXJlY3RvcnknCiAgICAgICAgICAgIGVsaWYgb3Muc3RhdChiX3BhdGgpLnN0X25saW5rID4gMToKICAgICAgICAgICAgICAgIGt3YXJnc1snc3RhdGUnXSA9ICdoYXJkJwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2ZpbGUnCiAgICAgICAgICAgIGlmIEhBVkVfU0VMSU5VWCBhbmQgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgICAgIGt3YXJnc1snc2Vjb250ZXh0J10gPSAnOicuam9pbihzZWxmLnNlbGludXhfY29udGV4dChwYXRoKSkKICAgICAgICAgICAga3dhcmdzWydzaXplJ10gPSBzdFtzdGF0LlNUX1NJWkVdCiAgICAgICAgZWxzZToKICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2Fic2VudCcKICAgICAgICByZXR1cm4ga3dhcmdzCgogICAgZGVmIF9jaGVja19sb2NhbGUoc2VsZik6CiAgICAgICAgJycnCiAgICAgICAgVXNlcyB0aGUgbG9jYWxlIG1vZHVsZSB0byB0ZXN0IHRoZSBjdXJyZW50bHkgc2V0IGxvY2FsZQogICAgICAgIChwZXIgdGhlIExBTkcgYW5kIExDX0NUWVBFIGVudmlyb25tZW50IHNldHRpbmdzKQogICAgICAgICcnJwogICAgICAgIHRyeToKICAgICAgICAgICAgIyBzZXR0aW5nIHRoZSBsb2NhbGUgdG8gJycgdXNlcyB0aGUgZGVmYXVsdCBsb2NhbGUKICAgICAgICAgICAgIyBhcyBpdCB3b3VsZCBiZSByZXR1cm5lZCBieSBsb2NhbGUuZ2V0ZGVmYXVsdGxvY2FsZSgpCiAgICAgICAgICAgIGxvY2FsZS5zZXRsb2NhbGUobG9jYWxlLkxDX0FMTCwgJycpCiAgICAgICAgZXhjZXB0IGxvY2FsZS5FcnJvcjoKICAgICAgICAgICAgIyBmYWxsYmFjayB0byB0aGUgJ0MnIGxvY2FsZSwgd2hpY2ggbWF5IGNhdXNlIHVuaWNvZGUKICAgICAgICAgICAgIyBpc3N1ZXMgYnV0IGlzIHByZWZlcmFibGUgdG8gc2ltcGx5IGZhaWxpbmcgYmVjYXVzZQogICAgICAgICAgICAjIG9mIGFuIHVua25vd24gbG9jYWxlCiAgICAgICAgICAgIGxvY2FsZS5zZXRsb2NhbGUobG9jYWxlLkxDX0FMTCwgJ0MnKQogICAgICAgICAgICBvcy5lbnZpcm9uWydMQU5HJ10gPSAnQycKICAgICAgICAgICAgb3MuZW52aXJvblsnTENfQUxMJ10gPSAnQycKICAgICAgICAgICAgb3MuZW52aXJvblsnTENfTUVTU0FHRVMnXSA9ICdDJwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJBbiB1bmtub3duIGVycm9yIHdhcyBlbmNvdW50ZXJlZCB3aGlsZSBhdHRlbXB0aW5nIHRvIHZhbGlkYXRlIHRoZSBsb2NhbGU6ICVzIiAlIGUpCgogICAgZGVmIF9oYW5kbGVfYWxpYXNlcyhzZWxmLCBzcGVjPU5vbmUpOgogICAgICAgICMgdGhpcyB1c2VzIGV4Y2VwdGlvbnMgYXMgaXQgaGFwcGVucyBiZWZvcmUgd2UgY2FuIHNhZmVseSBjYWxsIGZhaWxfanNvbgogICAgICAgIGFsaWFzZXNfcmVzdWx0cyA9IHt9ICNhbGlhczpjYW5vbgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgc3BlYyA9IHNlbGYuYXJndW1lbnRfc3BlYwogICAgICAgIGZvciAoayx2KSBpbiBzcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIHNlbGYuX2xlZ2FsX2lucHV0cy5hcHBlbmQoaykKICAgICAgICAgICAgYWxpYXNlcyA9IHYuZ2V0KCdhbGlhc2VzJywgTm9uZSkKICAgICAgICAgICAgZGVmYXVsdCA9IHYuZ2V0KCdkZWZhdWx0JywgTm9uZSkKICAgICAgICAgICAgcmVxdWlyZWQgPSB2LmdldCgncmVxdWlyZWQnLCBGYWxzZSkKICAgICAgICAgICAgaWYgZGVmYXVsdCBpcyBub3QgTm9uZSBhbmQgcmVxdWlyZWQ6CiAgICAgICAgICAgICAgICAjIG5vdCBhbGlhcyBzcGVjaWZpYyBidXQgdGhpcyBpcyBhIGdvb2QgcGxhY2UgdG8gY2hlY2sgdGhpcwogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJpbnRlcm5hbCBlcnJvcjogcmVxdWlyZWQgYW5kIGRlZmF1bHQgYXJlIG11dHVhbGx5IGV4Y2x1c2l2ZSBmb3IgJXMiICUgaykKICAgICAgICAgICAgaWYgYWxpYXNlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoYWxpYXNlcywgU0VRVUVOQ0VUWVBFKSBvciBpc2luc3RhbmNlKGFsaWFzZXMsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oJ2ludGVybmFsIGVycm9yOiBhbGlhc2VzIG11c3QgYmUgYSBsaXN0IG9yIHR1cGxlJykKICAgICAgICAgICAgZm9yIGFsaWFzIGluIGFsaWFzZXM6CiAgICAgICAgICAgICAgICBzZWxmLl9sZWdhbF9pbnB1dHMuYXBwZW5kKGFsaWFzKQogICAgICAgICAgICAgICAgYWxpYXNlc19yZXN1bHRzW2FsaWFzXSA9IGsKICAgICAgICAgICAgICAgIGlmIGFsaWFzIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyYW1zW2tdID0gc2VsZi5wYXJhbXNbYWxpYXNdCgogICAgICAgIHJldHVybiBhbGlhc2VzX3Jlc3VsdHMKCiAgICBkZWYgX2NoZWNrX2FyZ3VtZW50cyhzZWxmLCBjaGVja19pbnZhbGlkX2FyZ3VtZW50cyk6CiAgICAgICAgc2VsZi5fc3lzbG9nX2ZhY2lsaXR5ID0gJ0xPR19VU0VSJwogICAgICAgIHVuc3VwcG9ydGVkX3BhcmFtZXRlcnMgPSBzZXQoKQogICAgICAgIGZvciAoayx2KSBpbiBsaXN0KHNlbGYucGFyYW1zLml0ZW1zKCkpOgoKICAgICAgICAgICAgaWYgayA9PSAnX2Fuc2libGVfY2hlY2tfbW9kZScgYW5kIHY6CiAgICAgICAgICAgICAgICBzZWxmLmNoZWNrX21vZGUgPSBUcnVlCgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX25vX2xvZyc6CiAgICAgICAgICAgICAgICBzZWxmLm5vX2xvZyA9IHNlbGYuYm9vbGVhbih2KQoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9kZWJ1Zyc6CiAgICAgICAgICAgICAgICBzZWxmLl9kZWJ1ZyA9IHNlbGYuYm9vbGVhbih2KQoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9kaWZmJzoKICAgICAgICAgICAgICAgIHNlbGYuX2RpZmYgPSBzZWxmLmJvb2xlYW4odikKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfdmVyYm9zaXR5JzoKICAgICAgICAgICAgICAgIHNlbGYuX3ZlcmJvc2l0eSA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfc2VsaW51eF9zcGVjaWFsX2ZzJzoKICAgICAgICAgICAgICAgIHNlbGYuX3NlbGludXhfc3BlY2lhbF9mcyA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfc3lzbG9nX2ZhY2lsaXR5JzoKICAgICAgICAgICAgICAgIHNlbGYuX3N5c2xvZ19mYWNpbGl0eSA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfdmVyc2lvbic6CiAgICAgICAgICAgICAgICBzZWxmLmFuc2libGVfdmVyc2lvbiA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfbW9kdWxlX25hbWUnOgogICAgICAgICAgICAgICAgc2VsZi5fbmFtZSA9IHYKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfc29ja2V0JzoKICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldF9wYXRoID0gdgoKICAgICAgICAgICAgZWxpZiBjaGVja19pbnZhbGlkX2FyZ3VtZW50cyBhbmQgayBub3QgaW4gc2VsZi5fbGVnYWxfaW5wdXRzOgogICAgICAgICAgICAgICAgdW5zdXBwb3J0ZWRfcGFyYW1ldGVycy5hZGQoaykKCiAgICAgICAgICAgICNjbGVhbiB1cCBpbnRlcm5hbCBwYXJhbXM6CiAgICAgICAgICAgIGlmIGsuc3RhcnRzd2l0aCgnX2Fuc2libGVfJyk6CiAgICAgICAgICAgICAgICBkZWwgc2VsZi5wYXJhbXNba10KCiAgICAgICAgaWYgdW5zdXBwb3J0ZWRfcGFyYW1ldGVyczoKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJVbnN1cHBvcnRlZCBwYXJhbWV0ZXJzIGZvciAoJXMpIG1vZHVsZTogJXMuIFN1cHBvcnRlZCBwYXJhbWV0ZXJzIGluY2x1ZGU6ICVzIiAlIChzZWxmLl9uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcsJy5qb2luKHNvcnRlZChsaXN0KHVuc3VwcG9ydGVkX3BhcmFtZXRlcnMpKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJywnLmpvaW4oc29ydGVkKHNlbGYuYXJndW1lbnRfc3BlYy5rZXlzKCkpKSkpCiAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlIGFuZCBub3Qgc2VsZi5zdXBwb3J0c19jaGVja19tb2RlOgogICAgICAgICAgICBzZWxmLmV4aXRfanNvbihza2lwcGVkPVRydWUsIG1zZz0icmVtb3RlIG1vZHVsZSAoJXMpIGRvZXMgbm90IHN1cHBvcnQgY2hlY2sgbW9kZSIgJSBzZWxmLl9uYW1lKQoKICAgIGRlZiBfY291bnRfdGVybXMoc2VsZiwgY2hlY2spOgogICAgICAgIGNvdW50ID0gMAogICAgICAgIGZvciB0ZXJtIGluIGNoZWNrOgogICAgICAgICAgICBpZiB0ZXJtIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgY291bnQgKz0gMQogICAgICAgIHJldHVybiBjb3VudAoKICAgIGRlZiBfY2hlY2tfbXV0dWFsbHlfZXhjbHVzaXZlKHNlbGYsIHNwZWMpOgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZm9yIGNoZWNrIGluIHNwZWM6CiAgICAgICAgICAgIGNvdW50ID0gc2VsZi5fY291bnRfdGVybXMoY2hlY2spCiAgICAgICAgICAgIGlmIGNvdW50ID4gMToKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0icGFyYW1ldGVycyBhcmUgbXV0dWFsbHkgZXhjbHVzaXZlOiAlcyIgJSAoY2hlY2ssKSkKCiAgICBkZWYgX2NoZWNrX3JlcXVpcmVkX29uZV9vZihzZWxmLCBzcGVjKToKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciBjaGVjayBpbiBzcGVjOgogICAgICAgICAgICBjb3VudCA9IHNlbGYuX2NvdW50X3Rlcm1zKGNoZWNrKQogICAgICAgICAgICBpZiBjb3VudCA9PSAwOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJvbmUgb2YgdGhlIGZvbGxvd2luZyBpcyByZXF1aXJlZDogJXMiICUgJywnLmpvaW4oY2hlY2spKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfdG9nZXRoZXIoc2VsZiwgc3BlYyk6CiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3IgY2hlY2sgaW4gc3BlYzoKICAgICAgICAgICAgY291bnRzID0gWyBzZWxmLl9jb3VudF90ZXJtcyhbZmllbGRdKSBmb3IgZmllbGQgaW4gY2hlY2sgXQogICAgICAgICAgICBub25femVybyA9IFsgYyBmb3IgYyBpbiBjb3VudHMgaWYgYyA+IDAgXQogICAgICAgICAgICBpZiBsZW4obm9uX3plcm8pID4gMDoKICAgICAgICAgICAgICAgIGlmIDAgaW4gY291bnRzOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0icGFyYW1ldGVycyBhcmUgcmVxdWlyZWQgdG9nZXRoZXI6ICVzIiAlIChjaGVjaywpKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfYXJndW1lbnRzKHNlbGYsIHNwZWM9Tm9uZSwgcGFyYW09Tm9uZSApOgogICAgICAgICcnJyBlbnN1cmUgYWxsIHJlcXVpcmVkIGFyZ3VtZW50cyBhcmUgcHJlc2VudCAnJycKICAgICAgICBtaXNzaW5nID0gW10KICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHNwZWMgPSBzZWxmLmFyZ3VtZW50X3NwZWMKICAgICAgICBpZiBwYXJhbSBpcyBOb25lOgogICAgICAgICAgICBwYXJhbSA9IHNlbGYucGFyYW1zCiAgICAgICAgZm9yIChrLHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgcmVxdWlyZWQgPSB2LmdldCgncmVxdWlyZWQnLCBGYWxzZSkKICAgICAgICAgICAgaWYgcmVxdWlyZWQgYW5kIGsgbm90IGluIHBhcmFtOgogICAgICAgICAgICAgICAgbWlzc2luZy5hcHBlbmQoaykKICAgICAgICBpZiBsZW4obWlzc2luZykgPiAwOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9Im1pc3NpbmcgcmVxdWlyZWQgYXJndW1lbnRzOiAlcyIgJSAiLCIuam9pbihtaXNzaW5nKSkKCiAgICBkZWYgX2NoZWNrX3JlcXVpcmVkX2lmKHNlbGYsIHNwZWMpOgogICAgICAgICcnJyBlbnN1cmUgdGhhdCBwYXJhbWV0ZXJzIHdoaWNoIGNvbmRpdGlvbmFsbHkgcmVxdWlyZWQgYXJlIHByZXNlbnQgJycnCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3Igc3AgaW4gc3BlYzoKICAgICAgICAgICAgbWlzc2luZyA9IFtdCiAgICAgICAgICAgIG1heF9taXNzaW5nX2NvdW50ID0gMAogICAgICAgICAgICBpc19vbmVfb2YgPSBGYWxzZQogICAgICAgICAgICBpZiBsZW4oc3ApID09IDQ6CiAgICAgICAgICAgICAgICBrZXksIHZhbCwgcmVxdWlyZW1lbnRzLCBpc19vbmVfb2YgPSBzcAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAga2V5LCB2YWwsIHJlcXVpcmVtZW50cyA9IHNwCgogICAgICAgICAgICAjIGlzX29uZV9vZiBpcyBUcnVlIGF0IGxlYXN0IG9uZSByZXF1aXJlbWVudCBzaG91bGQgYmUKICAgICAgICAgICAgIyBwcmVzZW50LCBlbHNlIGFsbCByZXF1aXJlbWVudHMgc2hvdWxkIGJlIHByZXNlbnQuCiAgICAgICAgICAgIGlmIGlzX29uZV9vZjoKICAgICAgICAgICAgICAgIG1heF9taXNzaW5nX2NvdW50ID0gbGVuKHJlcXVpcmVtZW50cykKCiAgICAgICAgICAgIGlmIGtleSBpbiBzZWxmLnBhcmFtcyBhbmQgc2VsZi5wYXJhbXNba2V5XSA9PSB2YWw6CiAgICAgICAgICAgICAgICBmb3IgY2hlY2sgaW4gcmVxdWlyZW1lbnRzOgogICAgICAgICAgICAgICAgICAgIGNvdW50ID0gc2VsZi5fY291bnRfdGVybXMoKGNoZWNrLCkpCiAgICAgICAgICAgICAgICAgICAgaWYgY291bnQgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgbWlzc2luZy5hcHBlbmQoY2hlY2spCiAgICAgICAgICAgIGlmIGxlbihtaXNzaW5nKSBhbmQgbGVuKG1pc3NpbmcpID49IG1heF9taXNzaW5nX2NvdW50OgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSIlcyBpcyAlcyBidXQgdGhlIGZvbGxvd2luZyBhcmUgbWlzc2luZzogJXMiICUgKGtleSwgdmFsLCAnLCcuam9pbihtaXNzaW5nKSkpCgogICAgZGVmIF9jaGVja19hcmd1bWVudF92YWx1ZXMoc2VsZiwgc3BlYz1Ob25lLCBwYXJhbT1Ob25lKToKICAgICAgICAnJycgZW5zdXJlIGFsbCBhcmd1bWVudHMgaGF2ZSB0aGUgcmVxdWVzdGVkIHZhbHVlcywgYW5kIHRoZXJlIGFyZSBubyBzdHJheSBhcmd1bWVudHMgJycnCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICBzcGVjID0gc2VsZi5hcmd1bWVudF9zcGVjCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToKICAgICAgICAgICAgcGFyYW0gPSBzZWxmLnBhcmFtcwogICAgICAgIGZvciAoayx2KSBpbiBzcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIGNob2ljZXMgPSB2LmdldCgnY2hvaWNlcycsTm9uZSkKICAgICAgICAgICAgaWYgY2hvaWNlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShjaG9pY2VzLCBTRVFVRU5DRVRZUEUpIGFuZCBub3QgaXNpbnN0YW5jZShjaG9pY2VzLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpOgogICAgICAgICAgICAgICAgaWYgayBpbiBwYXJhbToKICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSBub3QgaW4gY2hvaWNlczoKICAgICAgICAgICAgICAgICAgICAgICAgIyBQeVlhbWwgY29udmVydHMgY2VydGFpbiBzdHJpbmdzIHRvIGJvb2xzLiAgSWYgd2UgY2FuIHVuYW1iaWd1b3VzbHkgY29udmVydCBiYWNrLCBkbyBzbyBiZWZvcmUgY2hlY2tpbmcKICAgICAgICAgICAgICAgICAgICAgICAgIyB0aGUgdmFsdWUuICBJZiB3ZSBjYW4ndCBmaWd1cmUgdGhpcyBvdXQsIG1vZHVsZSBhdXRob3IgaXMgcmVzcG9uc2libGUuCiAgICAgICAgICAgICAgICAgICAgICAgIGxvd2VyZWRfY2hvaWNlcyA9IE5vbmUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gPT0gJ0ZhbHNlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvd2VyZWRfY2hvaWNlcyA9IF9sZW5pZW50X2xvd2VyY2FzZShjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgRkFMU0VZID0gZnJvemVuc2V0KEJPT0xFQU5TX0ZBTFNFKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmxhcCA9IEZBTFNFWS5pbnRlcnNlY3Rpb24oY2hvaWNlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihvdmVybGFwKSA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgRXh0cmFjdCBmcm9tIGEgc2V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHBhcmFtW2tdLCkgPSBvdmVybGFwCgogICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSA9PSAnVHJ1ZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsb3dlcmVkX2Nob2ljZXMgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb3dlcmVkX2Nob2ljZXMgPSBfbGVuaWVudF9sb3dlcmNhc2UoY2hvaWNlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRSVVRIWSA9IGZyb3plbnNldChCT09MRUFOU19UUlVFKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmxhcCA9IFRSVVRIWS5pbnRlcnNlY3Rpb24oY2hvaWNlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihvdmVybGFwKSA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChwYXJhbVtrXSwpID0gb3ZlcmxhcAoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gbm90IGluIGNob2ljZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2VzX3N0cj0iLCIuam9pbihbdG9fbmF0aXZlKGMpIGZvciBjIGluIGNob2ljZXNdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnPSJ2YWx1ZSBvZiAlcyBtdXN0IGJlIG9uZSBvZjogJXMsIGdvdDogJXMiICUgKGssIGNob2ljZXNfc3RyLCBwYXJhbVtrXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz1tc2cpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImludGVybmFsIGVycm9yOiBjaG9pY2VzIGZvciBhcmd1bWVudCAlcyBhcmUgbm90IGl0ZXJhYmxlOiAlcyIgJSAoaywgY2hvaWNlcykpCgogICAgZGVmIHNhZmVfZXZhbChzZWxmLCB2YWx1ZSwgbG9jYWxzPU5vbmUsIGluY2x1ZGVfZXhjZXB0aW9ucz1GYWxzZSk6CgogICAgICAgICMgZG8gbm90IGFsbG93IG1ldGhvZCBjYWxscyB0byBtb2R1bGVzCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgICMgYWxyZWFkeSB0ZW1wbGF0ZWQgdG8gYSBkYXRhdmFsdWVzdHJ1Y3R1cmUsIHBlcmhhcHM/CiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAodmFsdWUsIE5vbmUpCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIGlmIHJlLnNlYXJjaChyJ1x3XC5cdytcKCcsIHZhbHVlKToKICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgTm9uZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgIyBkbyBub3QgYWxsb3cgaW1wb3J0cwogICAgICAgIGlmIHJlLnNlYXJjaChyJ2ltcG9ydCBcdysnLCB2YWx1ZSk6CiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAodmFsdWUsIE5vbmUpCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzdWx0ID0gbGl0ZXJhbF9ldmFsKHZhbHVlKQogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHJlc3VsdCwgTm9uZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAodmFsdWUsIGUpCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgIGRlZiBfY2hlY2tfdHlwZV9zdHIoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgICMgTm90ZTogVGhpcyBjb3VsZCB0aHJvdyBhIHVuaWNvZGUgZXJyb3IgaWYgdmFsdWUncyBfX3N0cl9fKCkgbWV0aG9kCiAgICAgICAgIyByZXR1cm5zIG5vbi1hc2NpaS4gIEhhdmUgdG8gcG9ydCB1dGlscy50b19ieXRlcygpIGlmIHRoYXQgaGFwcGVucwogICAgICAgIHJldHVybiBzdHIodmFsdWUpCgogICAgZGVmIF9jaGVja190eXBlX2xpc3Qoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGxpc3QpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnNwbGl0KCIsIikKICAgICAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIGludCkgb3IgaXNpbnN0YW5jZSh2YWx1ZSwgZmxvYXQpOgogICAgICAgICAgICByZXR1cm4gWyBzdHIodmFsdWUpIF0KCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgbGlzdCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfZGljdChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgZGljdCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBpZiB2YWx1ZS5zdGFydHN3aXRoKCJ7Iik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHModmFsdWUpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgKHJlc3VsdCwgZXhjKSA9IHNlbGYuc2FmZV9ldmFsKHZhbHVlLCBkaWN0KCksIGluY2x1ZGVfZXhjZXB0aW9ucz1UcnVlKQogICAgICAgICAgICAgICAgICAgIGlmIGV4YyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCd1bmFibGUgdG8gZXZhbHVhdGUgc3RyaW5nIGFzIGRpY3Rpb25hcnknKQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICAgICAgZWxpZiAnPScgaW4gdmFsdWU6CiAgICAgICAgICAgICAgICBmaWVsZHMgPSBbXQogICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyID0gW10KICAgICAgICAgICAgICAgIGluX3F1b3RlID0gRmFsc2UKICAgICAgICAgICAgICAgIGluX2VzY2FwZSA9IEZhbHNlCiAgICAgICAgICAgICAgICBmb3IgYyBpbiB2YWx1ZS5zdHJpcCgpOgogICAgICAgICAgICAgICAgICAgIGlmIGluX2VzY2FwZToKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyLmFwcGVuZChjKQogICAgICAgICAgICAgICAgICAgICAgICBpbl9lc2NhcGUgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsaWYgYyA9PSAnXFwnOgogICAgICAgICAgICAgICAgICAgICAgICBpbl9lc2NhcGUgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgZWxpZiBub3QgaW5fcXVvdGUgYW5kIGMgaW4gKCdcJycsICciJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGluX3F1b3RlID0gYwogICAgICAgICAgICAgICAgICAgIGVsaWYgaW5fcXVvdGUgYW5kIGluX3F1b3RlID09IGM6CiAgICAgICAgICAgICAgICAgICAgICAgIGluX3F1b3RlID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBpbl9xdW90ZSBhbmQgYyBpbiAoJywnLCAnICcpOgogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZCA9ICcnLmpvaW4oZmllbGRfYnVmZmVyKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBmaWVsZDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkcy5hcHBlbmQoZmllbGQpCiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkX2J1ZmZlciA9IFtdCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyLmFwcGVuZChjKQoKICAgICAgICAgICAgICAgIGZpZWxkID0gJycuam9pbihmaWVsZF9idWZmZXIpCiAgICAgICAgICAgICAgICBpZiBmaWVsZDoKICAgICAgICAgICAgICAgICAgICBmaWVsZHMuYXBwZW5kKGZpZWxkKQogICAgICAgICAgICAgICAgcmV0dXJuIGRpY3QoeC5zcGxpdCgiPSIsIDEpIGZvciB4IGluIGZpZWxkcykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiZGljdGlvbmFyeSByZXF1ZXN0ZWQsIGNvdWxkIG5vdCBwYXJzZSBKU09OIG9yIGtleT12YWx1ZSIpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGRpY3QnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2Jvb2woc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGJvb2wpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKSBvciBpc2luc3RhbmNlKHZhbHVlLCBpbnQpOgogICAgICAgICAgICByZXR1cm4gc2VsZi5ib29sZWFuKHZhbHVlKQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBib29sJyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9pbnQoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIGludCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICByZXR1cm4gaW50KHZhbHVlKQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYW4gaW50JyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9mbG9hdChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgZmxvYXQpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUsIGludCkpOgogICAgICAgICAgICByZXR1cm4gZmxvYXQodmFsdWUpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGZsb2F0JyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9wYXRoKHNlbGYsIHZhbHVlKToKICAgICAgICB2YWx1ZSA9IHNlbGYuX2NoZWNrX3R5cGVfc3RyKHZhbHVlKQogICAgICAgIHJldHVybiBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfanNvbmFyZyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgIyBSZXR1cm4gYSBqc29uaWZpZWQgc3RyaW5nLiAgU29tZXRpbWVzIHRoZSBjb250cm9sbGVyIHR1cm5zIGEganNvbgogICAgICAgICMgc3RyaW5nIGludG8gYSBkaWN0L2xpc3Qgc28gdHJhbnNmb3JtIGl0IGJhY2sgaW50byBqc29uIGhlcmUKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUuc3RyaXAoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIChsaXN0LCB0dXBsZSwgZGljdCkpOgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24uZHVtcHModmFsdWUpCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEganNvbiBzdHJpbmcnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX3JhdyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgcmV0dXJuIHZhbHVlCgoKICAgIGRlZiBfY2hlY2tfdHlwZV9ieXRlcyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmh1bWFuX3RvX2J5dGVzKHZhbHVlKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBCeXRlIHZhbHVlJyAlIHR5cGUodmFsdWUpKQoKCiAgICBkZWYgX2NoZWNrX3R5cGVfYml0cyhzZWxmLCB2YWx1ZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmh1bWFuX3RvX2J5dGVzKHZhbHVlLCBpc2JpdHM9VHJ1ZSkKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgQml0IHZhbHVlJyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfYXJndW1lbnRfdHlwZXMoc2VsZiwgc3BlYz1Ob25lLCBwYXJhbT1Ob25lKToKICAgICAgICAnJycgZW5zdXJlIGFsbCBhcmd1bWVudHMgaGF2ZSB0aGUgcmVxdWVzdGVkIHR5cGUgJycnCgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgc3BlYyA9IHNlbGYuYXJndW1lbnRfc3BlYwogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAgICAgIHBhcmFtID0gc2VsZi5wYXJhbXMKCiAgICAgICAgZm9yIChrLCB2KSBpbiBzcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIHdhbnRlZCA9IHYuZ2V0KCd0eXBlJywgTm9uZSkKICAgICAgICAgICAgaWYgayBub3QgaW4gcGFyYW06CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiB3YW50ZWQgaXMgTm9uZToKICAgICAgICAgICAgICAgICMgTW9zdGx5IHdlIHdhbnQgdG8gZGVmYXVsdCB0byBzdHIuCiAgICAgICAgICAgICAgICAjIEZvciB2YWx1ZXMgc2V0IHRvIE5vbmUgZXhwbGljaXRseSwgcmV0dXJuIE5vbmUgaW5zdGVhZCBhcwogICAgICAgICAgICAgICAgIyB0aGF0IGFsbG93cyBhIHVzZXIgdG8gdW5zZXQgYSBwYXJhbWV0ZXIKICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHdhbnRlZCA9ICdzdHInCgogICAgICAgICAgICB2YWx1ZSA9IHBhcmFtW2tdCiAgICAgICAgICAgIGlmIHZhbHVlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdHlwZV9jaGVja2VyID0gc2VsZi5fQ0hFQ0tfQVJHVU1FTlRfVFlQRVNfRElTUEFUQ0hFUlt3YW50ZWRdCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iaW1wbGVtZW50YXRpb24gZXJyb3I6IHVua25vd24gdHlwZSAlcyByZXF1ZXN0ZWQgZm9yICVzIiAlICh3YW50ZWQsIGspKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwYXJhbVtrXSA9IHR5cGVfY2hlY2tlcih2YWx1ZSkKICAgICAgICAgICAgZXhjZXB0IChUeXBlRXJyb3IsIFZhbHVlRXJyb3IpOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJhcmd1bWVudCAlcyBpcyBvZiB0eXBlICVzIGFuZCB3ZSB3ZXJlIHVuYWJsZSB0byBjb252ZXJ0IHRvICVzOiAlcyIgJSAoaywgdHlwZSh2YWx1ZSksIHdhbnRlZCwgZSkpCgogICAgICAgICAgICAjIGRlYWwgd2l0aCBzdWIgb3B0aW9ucyB0byBjcmVhdGUgc3ViIHNwZWMKICAgICAgICAgICAgc3BlYyA9IE5vbmUKICAgICAgICAgICAgaWYgd2FudGVkID09ICdkaWN0JyBvciAod2FudGVkID09ICdsaXN0JyBhbmQgdi5nZXQoJ2VsZW1lbnRzJywgJycpID09ICdkaWN0Jyk6CiAgICAgICAgICAgICAgICBzcGVjID0gdi5nZXQoJ29wdGlvbnMnLCBOb25lKQogICAgICAgICAgICAgICAgaWYgc3BlYzoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF9hcmd1bWVudHMoc3BlYywgcGFyYW1ba10pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdHlwZXMoc3BlYywgcGFyYW1ba10pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdmFsdWVzKHNwZWMsIHBhcmFtW2tdKQoKICAgIGRlZiBfc2V0X2RlZmF1bHRzKHNlbGYsIHByZT1UcnVlKToKICAgICAgICBmb3IgKGssdikgaW4gc2VsZi5hcmd1bWVudF9zcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIGRlZmF1bHQgPSB2LmdldCgnZGVmYXVsdCcsIE5vbmUpCiAgICAgICAgICAgIGlmIHByZSBpcyBUcnVlOgogICAgICAgICAgICAgICAgIyB0aGlzIHByZXZlbnRzIHNldHRpbmcgZGVmYXVsdHMgb24gcmVxdWlyZWQgaXRlbXMKICAgICAgICAgICAgICAgIGlmIGRlZmF1bHQgaXMgbm90IE5vbmUgYW5kIGsgbm90IGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyYW1zW2tdID0gZGVmYXVsdAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBtYWtlIHN1cmUgdGhpbmdzIHdpdGhvdXQgYSBkZWZhdWx0IHN0aWxsIGdldCBzZXQgTm9uZQogICAgICAgICAgICAgICAgaWYgayBub3QgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBkZWZhdWx0CgogICAgZGVmIF9zZXRfZmFsbGJhY2tzKHNlbGYpOgogICAgICAgIGZvciBrLHYgaW4gc2VsZi5hcmd1bWVudF9zcGVjLml0ZW1zKCk6CiAgICAgICAgICAgIGZhbGxiYWNrID0gdi5nZXQoJ2ZhbGxiYWNrJywgKE5vbmUsKSkKICAgICAgICAgICAgZmFsbGJhY2tfc3RyYXRlZ3kgPSBmYWxsYmFja1swXQogICAgICAgICAgICBmYWxsYmFja19hcmdzID0gW10KICAgICAgICAgICAgZmFsbGJhY2tfa3dhcmdzID0ge30KICAgICAgICAgICAgaWYgayBub3QgaW4gc2VsZi5wYXJhbXMgYW5kIGZhbGxiYWNrX3N0cmF0ZWd5IGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgZm9yIGl0ZW0gaW4gZmFsbGJhY2tbMTpdOgogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoaXRlbSwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrX2t3YXJncyA9IGl0ZW0KICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBmYWxsYmFja19hcmdzID0gaXRlbQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucGFyYW1zW2tdID0gZmFsbGJhY2tfc3RyYXRlZ3koKmZhbGxiYWNrX2FyZ3MsICoqZmFsbGJhY2tfa3dhcmdzKQogICAgICAgICAgICAgICAgZXhjZXB0IEFuc2libGVGYWxsYmFja05vdEZvdW5kOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgZGVmIF9sb2FkX3BhcmFtcyhzZWxmKToKICAgICAgICAnJycgcmVhZCB0aGUgaW5wdXQgYW5kIHNldCB0aGUgcGFyYW1zIGF0dHJpYnV0ZS4KCiAgICAgICAgVGhpcyBtZXRob2QgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LiAgVGhlIGd1dHMgb2YgdGhlIGZ1bmN0aW9uCiAgICAgICAgd2VyZSBtb3ZlZCBvdXQgaW4gMi4xIHNvIHRoYXQgY3VzdG9tIG1vZHVsZXMgY291bGQgcmVhZCB0aGUgcGFyYW1ldGVycy4KICAgICAgICAnJycKICAgICAgICAjIGRlYnVnIG92ZXJyaWRlcyB0byByZWFkIGFyZ3MgZnJvbSBmaWxlIG9yIGNtZGxpbmUKICAgICAgICBzZWxmLnBhcmFtcyA9IF9sb2FkX3BhcmFtcygpCgogICAgZGVmIF9sb2dfdG9fc3lzbG9nKHNlbGYsIG1zZyk6CiAgICAgICAgaWYgSEFTX1NZU0xPRzoKICAgICAgICAgICAgbW9kdWxlID0gJ2Fuc2libGUtJXMnICUgc2VsZi5fbmFtZQogICAgICAgICAgICBmYWNpbGl0eSA9IGdldGF0dHIoc3lzbG9nLCBzZWxmLl9zeXNsb2dfZmFjaWxpdHksIHN5c2xvZy5MT0dfVVNFUikKICAgICAgICAgICAgc3lzbG9nLm9wZW5sb2coc3RyKG1vZHVsZSksIDAsIGZhY2lsaXR5KQogICAgICAgICAgICBzeXNsb2cuc3lzbG9nKHN5c2xvZy5MT0dfSU5GTywgbXNnKQoKICAgIGRlZiBkZWJ1ZyhzZWxmLCBtc2cpOgogICAgICAgIGlmIHNlbGYuX2RlYnVnOgogICAgICAgICAgICBzZWxmLmxvZygnW2RlYnVnXSAlcycgJSBtc2cpCgogICAgZGVmIGxvZyhzZWxmLCBtc2csIGxvZ19hcmdzPU5vbmUpOgoKICAgICAgICBpZiBub3Qgc2VsZi5ub19sb2c6CgogICAgICAgICAgICBpZiBsb2dfYXJncyBpcyBOb25lOgogICAgICAgICAgICAgICAgbG9nX2FyZ3MgPSBkaWN0KCkKCiAgICAgICAgICAgIG1vZHVsZSA9ICdhbnNpYmxlLSVzJyAlIHNlbGYuX25hbWUKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShtb2R1bGUsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgICAgIG1vZHVsZSA9IG1vZHVsZS5kZWNvZGUoJ3V0Zi04JywgJ3JlcGxhY2UnKQoKICAgICAgICAgICAgIyA2NjU1IC0gYWxsb3cgZm9yIGFjY2VudGVkIGNoYXJhY3RlcnMKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UobXNnLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJtc2cgc2hvdWxkIGJlIGEgc3RyaW5nIChnb3QgJXMpIiAlIHR5cGUobXNnKSkKCiAgICAgICAgICAgICMgV2Ugd2FudCBqb3VybmFsIHRvIGFsd2F5cyB0YWtlIHRleHQgdHlwZQogICAgICAgICAgICAjIHN5c2xvZyB0YWtlcyBieXRlcyBvbiBweTIsIHRleHQgdHlwZSBvbiBweTMKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShtc2csIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgICAgIGpvdXJuYWxfbXNnID0gcmVtb3ZlX3ZhbHVlcyhtc2cuZGVjb2RlKCd1dGYtOCcsICdyZXBsYWNlJyksIHNlbGYubm9fbG9nX3ZhbHVlcykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVE9ETzogc3Vycm9nYXRlZXNjYXBlIGlzIGEgZGFuZ2VyIGhlcmUgb24gUHkzCiAgICAgICAgICAgICAgICBqb3VybmFsX21zZyA9IHJlbW92ZV92YWx1ZXMobXNnLCBzZWxmLm5vX2xvZ192YWx1ZXMpCgogICAgICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgICAgICBzeXNsb2dfbXNnID0gam91cm5hbF9tc2cKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHN5c2xvZ19tc2cgPSBqb3VybmFsX21zZy5lbmNvZGUoJ3V0Zi04JywgJ3JlcGxhY2UnKQoKICAgICAgICAgICAgaWYgaGFzX2pvdXJuYWw6CiAgICAgICAgICAgICAgICBqb3VybmFsX2FyZ3MgPSBbKCJNT0RVTEUiLCBvcy5wYXRoLmJhc2VuYW1lKF9fZmlsZV9fKSldCiAgICAgICAgICAgICAgICBmb3IgYXJnIGluIGxvZ19hcmdzOgogICAgICAgICAgICAgICAgICAgIGpvdXJuYWxfYXJncy5hcHBlbmQoKGFyZy51cHBlcigpLCBzdHIobG9nX2FyZ3NbYXJnXSkpKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGpvdXJuYWwuc2VuZCh1IiVzICVzIiAlIChtb2R1bGUsIGpvdXJuYWxfbXNnKSwgKipkaWN0KGpvdXJuYWxfYXJncykpCiAgICAgICAgICAgICAgICBleGNlcHQgSU9FcnJvcjoKICAgICAgICAgICAgICAgICAgICAjIGZhbGwgYmFjayB0byBzeXNsb2cgc2luY2UgbG9nZ2luZyB0byBqb3VybmFsIGZhaWxlZAogICAgICAgICAgICAgICAgICAgIHNlbGYuX2xvZ190b19zeXNsb2coc3lzbG9nX21zZykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuX2xvZ190b19zeXNsb2coc3lzbG9nX21zZykKCiAgICBkZWYgX2xvZ19pbnZvY2F0aW9uKHNlbGYpOgogICAgICAgICcnJyBsb2cgdGhhdCBhbnNpYmxlIHJhbiB0aGUgbW9kdWxlICcnJwogICAgICAgICMgVE9ETzogZ2VuZXJhbGl6ZSBhIHNlcGFyYXRlIGxvZyBmdW5jdGlvbiBhbmQgbWFrZSBsb2dfaW52b2NhdGlvbiB1c2UgaXQKICAgICAgICAjIFNhbml0aXplIHBvc3NpYmxlIHBhc3N3b3JkIGFyZ3VtZW50IHdoZW4gbG9nZ2luZy4KICAgICAgICBsb2dfYXJncyA9IGRpY3QoKQoKICAgICAgICBmb3IgcGFyYW0gaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgIGNhbm9uICA9IHNlbGYuYWxpYXNlcy5nZXQocGFyYW0sIHBhcmFtKQogICAgICAgICAgICBhcmdfb3B0cyA9IHNlbGYuYXJndW1lbnRfc3BlYy5nZXQoY2Fub24sIHt9KQogICAgICAgICAgICBub19sb2cgPSBhcmdfb3B0cy5nZXQoJ25vX2xvZycsIEZhbHNlKQoKICAgICAgICAgICAgaWYgc2VsZi5ib29sZWFuKG5vX2xvZyk6CiAgICAgICAgICAgICAgICBsb2dfYXJnc1twYXJhbV0gPSAnTk9UX0xPR0dJTkdfUEFSQU1FVEVSJwogICAgICAgICAgICAjIHRyeSB0byBjYXB0dXJlIGFsbCBwYXNzd29yZHMvcGFzc3BocmFzZSBuYW1lZCBmaWVsZHMgbWlzc2VkIGJ5IG5vX2xvZwogICAgICAgICAgICBlbGlmIFBBU1NXT1JEX01BVENILnNlYXJjaChwYXJhbSkgYW5kIFwKICAgICAgICAgICAgICBhcmdfb3B0cy5nZXQoJ3R5cGUnLCAnc3RyJykgIT0gJ2Jvb2wnIGFuZCBcCiAgICAgICAgICAgICAgbm90IGFyZ19vcHRzLmdldCgnY2hvaWNlcycsIEZhbHNlKToKICAgICAgICAgICAgICAgICMgc2tpcCBib29sZWFuIGFuZCBlbnVtcyBhcyB0aGV5IGFyZSBhYm91dCAncGFzc3dvcmQnIHN0YXRlCiAgICAgICAgICAgICAgICBsb2dfYXJnc1twYXJhbV0gPSAnTk9UX0xPR0dJTkdfUEFTU1dPUkQnCiAgICAgICAgICAgICAgICBzZWxmLndhcm4oJ01vZHVsZSBkaWQgbm90IHNldCBub19sb2cgZm9yICVzJyAlIHBhcmFtKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcGFyYW1fdmFsID0gc2VsZi5wYXJhbXNbcGFyYW1dCiAgICAgICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShwYXJhbV92YWwsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgICAgICAgICAgICAgcGFyYW1fdmFsID0gc3RyKHBhcmFtX3ZhbCkKICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShwYXJhbV92YWwsIHRleHRfdHlwZSk6CiAgICAgICAgICAgICAgICAgICAgcGFyYW1fdmFsID0gcGFyYW1fdmFsLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICAgICAgbG9nX2FyZ3NbcGFyYW1dID0gaGV1cmlzdGljX2xvZ19zYW5pdGl6ZShwYXJhbV92YWwsIHNlbGYubm9fbG9nX3ZhbHVlcykKCiAgICAgICAgbXNnID0gWyclcz0lcycgJSAodG9fbmF0aXZlKGFyZyksIHRvX25hdGl2ZSh2YWwpKSBmb3IgYXJnLCB2YWwgaW4gbG9nX2FyZ3MuaXRlbXMoKV0KICAgICAgICBpZiBtc2c6CiAgICAgICAgICAgIG1zZyA9ICdJbnZva2VkIHdpdGggJXMnICUgJyAnLmpvaW4obXNnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1zZyA9ICdJbnZva2VkJwoKICAgICAgICBzZWxmLmxvZyhtc2csIGxvZ19hcmdzPWxvZ19hcmdzKQoKCiAgICBkZWYgX3NldF9jd2Qoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBjd2QgPSBvcy5nZXRjd2QoKQogICAgICAgICAgICBpZiBub3Qgb3MuYWNjZXNzKGN3ZCwgb3MuRl9PS3xvcy5SX09LKToKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigpCiAgICAgICAgICAgIHJldHVybiBjd2QKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICMgd2UgZG9uJ3QgaGF2ZSBhY2Nlc3MgdG8gdGhlIGN3ZCwgcHJvYmFibHkgYmVjYXVzZSBvZiBzdWRvLgogICAgICAgICAgICAjIFRyeSBhbmQgbW92ZSB0byBhIG5ldXRyYWwgbG9jYXRpb24gdG8gcHJldmVudCBlcnJvcnMKICAgICAgICAgICAgZm9yIGN3ZCBpbiBbb3MucGF0aC5leHBhbmR2YXJzKCckSE9NRScpLCB0ZW1wZmlsZS5nZXR0ZW1wZGlyKCldOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGlmIG9zLmFjY2Vzcyhjd2QsIG9zLkZfT0t8b3MuUl9PSyk6CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNoZGlyKGN3ZCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN3ZAogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAjIHdlIHdvbid0IGVycm9yIGhlcmUsIGFzIGl0IG1heSAqbm90KiBiZSBhIHByb2JsZW0sCiAgICAgICAgIyBhbmQgd2UgZG9uJ3Qgd2FudCB0byBicmVhayBtb2R1bGVzIHVubmVjZXNzYXJpbHkKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBnZXRfYmluX3BhdGgoc2VsZiwgYXJnLCByZXF1aXJlZD1GYWxzZSwgb3B0X2RpcnM9W10pOgogICAgICAgICcnJwogICAgICAgIGZpbmQgc3lzdGVtIGV4ZWN1dGFibGUgaW4gUEFUSC4KICAgICAgICBPcHRpb25hbCBhcmd1bWVudHM6CiAgICAgICAgICAgLSByZXF1aXJlZDogIGlmIGV4ZWN1dGFibGUgaXMgbm90IGZvdW5kIGFuZCByZXF1aXJlZCBpcyB0cnVlLCBmYWlsX2pzb24KICAgICAgICAgICAtIG9wdF9kaXJzOiAgb3B0aW9uYWwgbGlzdCBvZiBkaXJlY3RvcmllcyB0byBzZWFyY2ggaW4gYWRkaXRpb24gdG8gUEFUSAogICAgICAgIGlmIGZvdW5kIHJldHVybiBmdWxsIHBhdGg7IG90aGVyd2lzZSByZXR1cm4gTm9uZQogICAgICAgICcnJwogICAgICAgIHNiaW5fcGF0aHMgPSBbJy9zYmluJywgJy91c3Ivc2JpbicsICcvdXNyL2xvY2FsL3NiaW4nXQogICAgICAgIHBhdGhzID0gW10KICAgICAgICBmb3IgZCBpbiBvcHRfZGlyczoKICAgICAgICAgICAgaWYgZCBpcyBub3QgTm9uZSBhbmQgb3MucGF0aC5leGlzdHMoZCk6CiAgICAgICAgICAgICAgICBwYXRocy5hcHBlbmQoZCkKICAgICAgICBwYXRocyArPSBvcy5lbnZpcm9uLmdldCgnUEFUSCcsICcnKS5zcGxpdChvcy5wYXRoc2VwKQogICAgICAgIGJpbl9wYXRoID0gTm9uZQogICAgICAgICMgbWFuZ2xlIFBBVEggdG8gaW5jbHVkZSAvc2JpbiBkaXJzCiAgICAgICAgZm9yIHAgaW4gc2Jpbl9wYXRoczoKICAgICAgICAgICAgaWYgcCBub3QgaW4gcGF0aHMgYW5kIG9zLnBhdGguZXhpc3RzKHApOgogICAgICAgICAgICAgICAgcGF0aHMuYXBwZW5kKHApCiAgICAgICAgZm9yIGQgaW4gcGF0aHM6CiAgICAgICAgICAgIGlmIG5vdCBkOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgcGF0aCA9IG9zLnBhdGguam9pbihkLCBhcmcpCiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHBhdGgpIGFuZCBub3Qgb3MucGF0aC5pc2RpcihwYXRoKSBhbmQgaXNfZXhlY3V0YWJsZShwYXRoKToKICAgICAgICAgICAgICAgIGJpbl9wYXRoID0gcGF0aAogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICBpZiByZXF1aXJlZCBhbmQgYmluX3BhdGggaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdGYWlsZWQgdG8gZmluZCByZXF1aXJlZCBleGVjdXRhYmxlICVzIGluIHBhdGhzOiAlcycgJSAoYXJnLCBvcy5wYXRoc2VwLmpvaW4ocGF0aHMpKSkKICAgICAgICByZXR1cm4gYmluX3BhdGgKCiAgICBkZWYgYm9vbGVhbihzZWxmLCBhcmcpOgogICAgICAgICcnJyByZXR1cm4gYSBib29sIGZvciB0aGUgYXJnICcnJwogICAgICAgIGlmIGFyZyBpcyBOb25lIG9yIGlzaW5zdGFuY2UoYXJnLCBib29sKToKICAgICAgICAgICAgcmV0dXJuIGFyZwogICAgICAgIGlmIGlzaW5zdGFuY2UoYXJnLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBhcmcgPSBhcmcubG93ZXIoKQogICAgICAgIGlmIGFyZyBpbiBCT09MRUFOU19UUlVFOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsaWYgYXJnIGluIEJPT0xFQU5TX0ZBTFNFOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9JyVzIGlzIG5vdCBhIHZhbGlkIGJvb2xlYW4uIFZhbGlkIGJvb2xlYW5zIGluY2x1ZGU6ICVzJyAlICh0b190ZXh0KGFyZyksICcsJy5qb2luKFsnJXMnICUgeCBmb3IgeCBpbiBCT09MRUFOU10pKSkKCiAgICBkZWYganNvbmlmeShzZWxmLCBkYXRhKToKICAgICAgICBmb3IgZW5jb2RpbmcgaW4gKCJ1dGYtOCIsICJsYXRpbi0xIik6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmR1bXBzKGRhdGEsIGVuY29kaW5nPWVuY29kaW5nKQogICAgICAgICAgICAjIE9sZCBzeXN0ZW1zIHVzaW5nIG9sZCBzaW1wbGVqc29uIG1vZHVsZSBkb2VzIG5vdCBzdXBwb3J0IGVuY29kaW5nIGtleXdvcmQuCiAgICAgICAgICAgIGV4Y2VwdCBUeXBlRXJyb3I6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbmV3X2RhdGEgPSBqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZShkYXRhLCBlbmNvZGluZz1lbmNvZGluZykKICAgICAgICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRGVjb2RlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmR1bXBzKG5ld19kYXRhKQogICAgICAgICAgICBleGNlcHQgVW5pY29kZURlY29kZUVycm9yOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0ludmFsaWQgdW5pY29kZSBlbmNvZGluZyBlbmNvdW50ZXJlZCcpCgogICAgZGVmIGZyb21fanNvbihzZWxmLCBkYXRhKToKICAgICAgICByZXR1cm4ganNvbi5sb2FkcyhkYXRhKQoKICAgIGRlZiBhZGRfY2xlYW51cF9maWxlKHNlbGYsIHBhdGgpOgogICAgICAgIGlmIHBhdGggbm90IGluIHNlbGYuY2xlYW51cF9maWxlczoKICAgICAgICAgICAgc2VsZi5jbGVhbnVwX2ZpbGVzLmFwcGVuZChwYXRoKQoKICAgIGRlZiBkb19jbGVhbnVwX2ZpbGVzKHNlbGYpOgogICAgICAgIGZvciBwYXRoIGluIHNlbGYuY2xlYW51cF9maWxlczoKICAgICAgICAgICAgc2VsZi5jbGVhbnVwKHBhdGgpCgogICAgZGVmIF9yZXR1cm5fZm9ybWF0dGVkKHNlbGYsIGt3YXJncyk6CgogICAgICAgIHNlbGYuYWRkX3BhdGhfaW5mbyhrd2FyZ3MpCgogICAgICAgIGlmICdpbnZvY2F0aW9uJyBub3QgaW4ga3dhcmdzOgogICAgICAgICAgICBrd2FyZ3NbJ2ludm9jYXRpb24nXSA9IHsnbW9kdWxlX2FyZ3MnOiBzZWxmLnBhcmFtc30KCiAgICAgICAgaWYgJ3dhcm5pbmdzJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoa3dhcmdzWyd3YXJuaW5ncyddLCBsaXN0KToKICAgICAgICAgICAgICAgIGZvciB3IGluIGt3YXJnc1snd2FybmluZ3MnXToKICAgICAgICAgICAgICAgICAgICBzZWxmLndhcm4odykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYud2Fybihrd2FyZ3NbJ3dhcm5pbmdzJ10pCgogICAgICAgIGlmIHNlbGYuX3dhcm5pbmdzOgogICAgICAgICAgICBrd2FyZ3NbJ3dhcm5pbmdzJ10gPSBzZWxmLl93YXJuaW5ncwoKICAgICAgICBpZiAnZGVwcmVjYXRpb25zJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoa3dhcmdzWydkZXByZWNhdGlvbnMnXSwgbGlzdCk6CiAgICAgICAgICAgICAgICBmb3IgZCBpbiBrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddOgogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZCwgU0VRVUVOQ0VUWVBFKSBhbmQgbGVuKGQpID09IDI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGVwcmVjYXRlKGRbMF0sIHZlcnNpb249ZFsxXSkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRlcHJlY2F0ZShkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5kZXByZWNhdGUoa3dhcmdzWydkZXByZWNhdGlvbnMnXSkKCiAgICAgICAgaWYgc2VsZi5fZGVwcmVjYXRpb25zOgogICAgICAgICAgICBrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddID0gc2VsZi5fZGVwcmVjYXRpb25zCgogICAgICAgIGt3YXJncyA9IHJlbW92ZV92YWx1ZXMoa3dhcmdzLCBzZWxmLm5vX2xvZ192YWx1ZXMpCiAgICAgICAgcHJpbnQoJ1xuJXMnICUgc2VsZi5qc29uaWZ5KGt3YXJncykpCgogICAgZGVmIGV4aXRfanNvbihzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgJycnIHJldHVybiBmcm9tIHRoZSBtb2R1bGUsIHdpdGhvdXQgZXJyb3IgJycnCgogICAgICAgIGlmIG5vdCAnY2hhbmdlZCcgaW4ga3dhcmdzOgogICAgICAgICAgICBrd2FyZ3NbJ2NoYW5nZWQnXSA9IEZhbHNlCgogICAgICAgIHNlbGYuZG9fY2xlYW51cF9maWxlcygpCiAgICAgICAgc2VsZi5fcmV0dXJuX2Zvcm1hdHRlZChrd2FyZ3MpCiAgICAgICAgc3lzLmV4aXQoMCkKCiAgICBkZWYgZmFpbF9qc29uKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAnJycgcmV0dXJuIGZyb20gdGhlIG1vZHVsZSwgd2l0aCBhbiBlcnJvciBtZXNzYWdlICcnJwoKICAgICAgICBhc3NlcnQgJ21zZycgaW4ga3dhcmdzLCAiaW1wbGVtZW50YXRpb24gZXJyb3IgLS0gbXNnIHRvIGV4cGxhaW4gdGhlIGVycm9yIGlzIHJlcXVpcmVkIgogICAgICAgIGt3YXJnc1snZmFpbGVkJ10gPSBUcnVlCgogICAgICAgIGlmIG5vdCAnY2hhbmdlZCcgaW4ga3dhcmdzOgogICAgICAgICAgICBrd2FyZ3NbJ2NoYW5nZWQnXSA9IEZhbHNlCgogICAgICAgIHNlbGYuZG9fY2xlYW51cF9maWxlcygpCiAgICAgICAgc2VsZi5fcmV0dXJuX2Zvcm1hdHRlZChrd2FyZ3MpCiAgICAgICAgc3lzLmV4aXQoMSkKCiAgICBkZWYgZmFpbF9vbl9taXNzaW5nX3BhcmFtcyhzZWxmLCByZXF1aXJlZF9wYXJhbXM9Tm9uZSk6CiAgICAgICAgJycnIFRoaXMgaXMgZm9yIGNoZWNraW5nIGZvciByZXF1aXJlZCBwYXJhbXMgd2hlbiB3ZSBjYW4gbm90IGNoZWNrIHZpYSBhcmdzcGVjIGJlY2F1c2Ugd2UKICAgICAgICBuZWVkIG1vcmUgaW5mb3JtYXRpb24gdGhhbiBpcyBzaW1wbHkgZ2l2ZW4gaW4gdGhlIGFyZ3NwZWMuCiAgICAgICAgJycnCiAgICAgICAgaWYgbm90IHJlcXVpcmVkX3BhcmFtczoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgbWlzc2luZ19wYXJhbXMgPSBbXQogICAgICAgIGZvciByZXF1aXJlZF9wYXJhbSBpbiByZXF1aXJlZF9wYXJhbXM6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLnBhcmFtcy5nZXQocmVxdWlyZWRfcGFyYW0pOgogICAgICAgICAgICAgICAgbWlzc2luZ19wYXJhbXMuYXBwZW5kKHJlcXVpcmVkX3BhcmFtKQogICAgICAgIGlmIG1pc3NpbmdfcGFyYW1zOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9Im1pc3NpbmcgcmVxdWlyZWQgYXJndW1lbnRzOiAlcyIgJSAnLCcuam9pbihtaXNzaW5nX3BhcmFtcykpCgogICAgZGVmIGRpZ2VzdF9mcm9tX2ZpbGUoc2VsZiwgZmlsZW5hbWUsIGFsZ29yaXRobSk6CiAgICAgICAgJycnIFJldHVybiBoZXggZGlnZXN0IG9mIGxvY2FsIGZpbGUgZm9yIGEgZGlnZXN0X21ldGhvZCBzcGVjaWZpZWQgYnkgbmFtZSwgb3IgTm9uZSBpZiBmaWxlIGlzIG5vdCBwcmVzZW50LiAnJycKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZW5hbWUpOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIG9zLnBhdGguaXNkaXIoZmlsZW5hbWUpOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImF0dGVtcHRlZCB0byB0YWtlIGNoZWNrc3VtIG9mIGRpcmVjdG9yeTogJXMiICUgZmlsZW5hbWUpCgogICAgICAgICMgcHJlc2VydmUgb2xkIGJlaGF2aW91ciB3aGVyZSB0aGUgdGhpcmQgcGFyYW1ldGVyIHdhcyBhIGhhc2ggYWxnb3JpdGhtIG9iamVjdAogICAgICAgIGlmIGhhc2F0dHIoYWxnb3JpdGhtLCAnaGV4ZGlnZXN0Jyk6CiAgICAgICAgICAgIGRpZ2VzdF9tZXRob2QgPSBhbGdvcml0aG0KICAgICAgICBlbHNlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkaWdlc3RfbWV0aG9kID0gQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNU1thbGdvcml0aG1dKCkKICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJDb3VsZCBub3QgaGFzaCBmaWxlICclcycgd2l0aCBhbGdvcml0aG0gJyVzJy4gQXZhaWxhYmxlIGFsZ29yaXRobXM6ICVzIiAlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZpbGVuYW1lLCBhbGdvcml0aG0sICcsICcuam9pbihBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TKSkpCgogICAgICAgIGJsb2Nrc2l6ZSA9IDY0ICogMTAyNAogICAgICAgIGluZmlsZSA9IG9wZW4ob3MucGF0aC5yZWFscGF0aChmaWxlbmFtZSksICdyYicpCiAgICAgICAgYmxvY2sgPSBpbmZpbGUucmVhZChibG9ja3NpemUpCiAgICAgICAgd2hpbGUgYmxvY2s6CiAgICAgICAgICAgIGRpZ2VzdF9tZXRob2QudXBkYXRlKGJsb2NrKQogICAgICAgICAgICBibG9jayA9IGluZmlsZS5yZWFkKGJsb2Nrc2l6ZSkKICAgICAgICBpbmZpbGUuY2xvc2UoKQogICAgICAgIHJldHVybiBkaWdlc3RfbWV0aG9kLmhleGRpZ2VzdCgpCgogICAgZGVmIG1kNShzZWxmLCBmaWxlbmFtZSk6CiAgICAgICAgJycnIFJldHVybiBNRDUgaGV4IGRpZ2VzdCBvZiBsb2NhbCBmaWxlIHVzaW5nIGRpZ2VzdF9mcm9tX2ZpbGUoKS4KCiAgICAgICAgRG8gbm90IHVzZSB0aGlzIGZ1bmN0aW9uIHVubGVzcyB5b3UgaGF2ZSBubyBvdGhlciBjaG9pY2UgZm9yOgogICAgICAgICAgICAxKSBPcHRpb25hbCBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQogICAgICAgICAgICAyKSBDb21wYXRpYmlsaXR5IHdpdGggYSB0aGlyZCBwYXJ0eSBwcm90b2NvbAoKICAgICAgICBUaGlzIGZ1bmN0aW9uIHdpbGwgbm90IHdvcmsgb24gc3lzdGVtcyBjb21wbHlpbmcgd2l0aCBGSVBTLTE0MC0yLgoKICAgICAgICBNb3N0IHVzZXMgb2YgdGhpcyBmdW5jdGlvbiBjYW4gdXNlIHRoZSBtb2R1bGUuc2hhMSBmdW5jdGlvbiBpbnN0ZWFkLgogICAgICAgICcnJwogICAgICAgIGlmICdtZDUnIG5vdCBpbiBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdNRDUgbm90IGF2YWlsYWJsZS4gIFBvc3NpYmx5IHJ1bm5pbmcgaW4gRklQUyBtb2RlJykKICAgICAgICByZXR1cm4gc2VsZi5kaWdlc3RfZnJvbV9maWxlKGZpbGVuYW1lLCAnbWQ1JykKCiAgICBkZWYgc2hhMShzZWxmLCBmaWxlbmFtZSk6CiAgICAgICAgJycnIFJldHVybiBTSEExIGhleCBkaWdlc3Qgb2YgbG9jYWwgZmlsZSB1c2luZyBkaWdlc3RfZnJvbV9maWxlKCkuICcnJwogICAgICAgIHJldHVybiBzZWxmLmRpZ2VzdF9mcm9tX2ZpbGUoZmlsZW5hbWUsICdzaGExJykKCiAgICBkZWYgc2hhMjU2KHNlbGYsIGZpbGVuYW1lKToKICAgICAgICAnJycgUmV0dXJuIFNIQS0yNTYgaGV4IGRpZ2VzdCBvZiBsb2NhbCBmaWxlIHVzaW5nIGRpZ2VzdF9mcm9tX2ZpbGUoKS4gJycnCiAgICAgICAgcmV0dXJuIHNlbGYuZGlnZXN0X2Zyb21fZmlsZShmaWxlbmFtZSwgJ3NoYTI1NicpCgogICAgZGVmIGJhY2t1cF9sb2NhbChzZWxmLCBmbik6CiAgICAgICAgJycnbWFrZSBhIGRhdGUtbWFya2VkIGJhY2t1cCBvZiB0aGUgc3BlY2lmaWVkIGZpbGUsIHJldHVybiBUcnVlIG9yIEZhbHNlIG9uIHN1Y2Nlc3Mgb3IgZmFpbHVyZScnJwoKICAgICAgICBiYWNrdXBkZXN0ID0gJycKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhmbik6CiAgICAgICAgICAgICMgYmFja3VwcyBuYW1lZCBiYXNlbmFtZS5QSUQuWVlZWS1NTS1EREBISDpNTTpTU34KICAgICAgICAgICAgZXh0ID0gdGltZS5zdHJmdGltZSgiJVktJW0tJWRAJUg6JU06JVN+IiwgdGltZS5sb2NhbHRpbWUodGltZS50aW1lKCkpKQogICAgICAgICAgICBiYWNrdXBkZXN0ID0gJyVzLiVzLiVzJyAlIChmbiwgb3MuZ2V0cGlkKCksIGV4dCkKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5MihmbiwgYmFja3VwZGVzdCkKICAgICAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdDb3VsZCBub3QgbWFrZSBiYWNrdXAgb2YgJXMgdG8gJXM6ICVzJyAlIChmbiwgYmFja3VwZGVzdCwgZSkpCgogICAgICAgIHJldHVybiBiYWNrdXBkZXN0CgogICAgZGVmIGNsZWFudXAoc2VsZiwgdG1wZmlsZSk6CiAgICAgICAgaWYgb3MucGF0aC5leGlzdHModG1wZmlsZSk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLnVubGluayh0bXBmaWxlKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHN5cy5zdGRlcnIud3JpdGUoImNvdWxkIG5vdCBjbGVhbnVwICVzOiAlcyIgJSAodG1wZmlsZSwgZSkpCgogICAgZGVmIGF0b21pY19tb3ZlKHNlbGYsIHNyYywgZGVzdCwgdW5zYWZlX3dyaXRlcz1GYWxzZSk6CiAgICAgICAgJycnYXRvbWljYWxseSBtb3ZlIHNyYyB0byBkZXN0LCBjb3B5aW5nIGF0dHJpYnV0ZXMgZnJvbSBkZXN0LCByZXR1cm5zIHRydWUgb24gc3VjY2VzcwogICAgICAgIGl0IHVzZXMgb3MucmVuYW1lIHRvIGVuc3VyZSB0aGlzIGFzIGl0IGlzIGFuIGF0b21pYyBvcGVyYXRpb24sIHJlc3Qgb2YgdGhlIGZ1bmN0aW9uIGlzCiAgICAgICAgdG8gd29yayBhcm91bmQgbGltaXRhdGlvbnMsIGNvcm5lciBjYXNlcyBhbmQgZW5zdXJlIHNlbGludXggY29udGV4dCBpcyBzYXZlZCBpZiBwb3NzaWJsZScnJwogICAgICAgIGNvbnRleHQgPSBOb25lCiAgICAgICAgZGVzdF9zdGF0ID0gTm9uZQogICAgICAgIGJfc3JjID0gdG9fYnl0ZXMoc3JjLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGJfZGVzdCA9IHRvX2J5dGVzKGRlc3QsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoYl9kZXN0KToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGVzdF9zdGF0ID0gb3Muc3RhdChiX2Rlc3QpCgogICAgICAgICAgICAgICAgIyBjb3B5IG1vZGUgYW5kIG93bmVyc2hpcAogICAgICAgICAgICAgICAgb3MuY2htb2QoYl9zcmMsIGRlc3Rfc3RhdC5zdF9tb2RlICYgUEVSTV9CSVRTKQogICAgICAgICAgICAgICAgb3MuY2hvd24oYl9zcmMsIGRlc3Rfc3RhdC5zdF91aWQsIGRlc3Rfc3RhdC5zdF9naWQpCgogICAgICAgICAgICAgICAgIyB0cnkgdG8gY29weSBmbGFncyBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihvcywgJ2NoZmxhZ3MnKSBhbmQgaGFzYXR0cihkZXN0X3N0YXQsICdzdF9mbGFncycpOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2hmbGFncyhiX3NyYywgZGVzdF9zdGF0LnN0X2ZsYWdzKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBlcnIgaW4gJ0VPUE5PVFNVUFAnLCAnRU5PVFNVUCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKGVycm5vLCBlcnIpIGFuZCBlLmVycm5vID09IGdldGF0dHIoZXJybm8sIGVycik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgaWYgZS5lcnJubyAhPSBlcnJuby5FUEVSTToKICAgICAgICAgICAgICAgICAgICByYWlzZQogICAgICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9jb250ZXh0KGRlc3QpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfZGVmYXVsdF9jb250ZXh0KGRlc3QpCgogICAgICAgIGNyZWF0aW5nID0gbm90IG9zLnBhdGguZXhpc3RzKGJfZGVzdCkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIE9wdGltaXN0aWNhbGx5IHRyeSBhIHJlbmFtZSwgc29sdmVzIHNvbWUgY29ybmVyIGNhc2VzIGFuZCBjYW4gYXZvaWQgdXNlbGVzcyB3b3JrLCB0aHJvd3MgZXhjZXB0aW9uIGlmIG5vdCBhdG9taWMuCiAgICAgICAgICAgIG9zLnJlbmFtZShiX3NyYywgYl9kZXN0KQogICAgICAgIGV4Y2VwdCAoSU9FcnJvciwgT1NFcnJvcik6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgaWYgZS5lcnJubyBub3QgaW4gW2Vycm5vLkVQRVJNLCBlcnJuby5FWERFViwgZXJybm8uRUFDQ0VTLCBlcnJuby5FVFhUQlNZLCBlcnJuby5FQlVTWV06CiAgICAgICAgICAgICAgICAjIG9ubHkgdHJ5IHdvcmthcm91bmRzIGZvciBlcnJubyAxOCAoY3Jvc3MgZGV2aWNlKSwgMSAobm90IHBlcm1pdHRlZCksICAxMyAocGVybWlzc2lvbiBkZW5pZWQpCiAgICAgICAgICAgICAgICAjIGFuZCAyNiAodGV4dCBmaWxlIGJ1c3kpIHdoaWNoIGhhcHBlbnMgb24gdmFncmFudCBzeW5jZWQgZm9sZGVycyBhbmQgb3RoZXIgJ2V4b3RpYycgbm9uIHBvc2l4IGZpbGUgc3lzdGVtcwogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdDb3VsZCBub3QgcmVwbGFjZSBmaWxlOiAlcyB0byAlczogJXMnICUgKHNyYywgZGVzdCwgZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYl9kZXN0X2RpciA9IG9zLnBhdGguZGlybmFtZShiX2Rlc3QpCiAgICAgICAgICAgICAgICAjIFVzZSBieXRlcyBoZXJlLiAgSW4gdGhlIHNoaXBwYWJsZSBDSSwgdGhpcyBmYWlscyB3aXRoCiAgICAgICAgICAgICAgICAjIGEgVW5pY29kZUVycm9yIHdpdGggc3Vycm9nYXRlZXNjYXBlJ2Qgc3RyaW5ncyBmb3IgYW4gdW5rbm93bgogICAgICAgICAgICAgICAgIyByZWFzb24gKGRvZXNuJ3QgaGFwcGVuIGluIGEgbG9jYWwgVWJ1bnR1MTYuMDQgVk0pCiAgICAgICAgICAgICAgICBuYXRpdmVfZGVzdF9kaXIgPSBiX2Rlc3RfZGlyCiAgICAgICAgICAgICAgICBuYXRpdmVfc3VmZml4ID0gb3MucGF0aC5iYXNlbmFtZShiX2Rlc3QpCiAgICAgICAgICAgICAgICBuYXRpdmVfcHJlZml4ID0gYignLmFuc2libGVfdG1wJykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB0bXBfZGVzdF9mZCwgdG1wX2Rlc3RfbmFtZSA9IHRlbXBmaWxlLm1rc3RlbXAoIHByZWZpeD1uYXRpdmVfcHJlZml4LCBkaXI9bmF0aXZlX2Rlc3RfZGlyLCBzdWZmaXg9bmF0aXZlX3N1ZmZpeCkKICAgICAgICAgICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nVGhlIGRlc3RpbmF0aW9uIGRpcmVjdG9yeSAoJXMpIGlzIG5vdCB3cml0YWJsZSBieSB0aGUgY3VycmVudCB1c2VyLiBFcnJvciB3YXM6ICVzJyAlIChvcy5wYXRoLmRpcm5hbWUoZGVzdCksIGUpKQogICAgICAgICAgICAgICAgZXhjZXB0IFR5cGVFcnJvcjoKICAgICAgICAgICAgICAgICAgICAjIFdlIGV4cGVjdCB0aGF0IHRoaXMgaXMgaGFwcGVuaW5nIGJlY2F1c2UgcHl0aG9uMy40LnggYW5kCiAgICAgICAgICAgICAgICAgICAgIyBiZWxvdyBjYW4ndCBoYW5kbGUgYnl0ZSBzdHJpbmdzIGluIG1rc3RlbXAoKS4gIFRyYWNlYmFjawogICAgICAgICAgICAgICAgICAgICMgd291bGQgZW5kIGluIHNvbWV0aGluZyBsaWtlOgogICAgICAgICAgICAgICAgICAgICMgICAgIGZpbGUgPSBfb3MucGF0aC5qb2luKGRpciwgcHJlICsgbmFtZSArIHN1ZikKICAgICAgICAgICAgICAgICAgICAjIFR5cGVFcnJvcjogY2FuJ3QgY29uY2F0IGJ5dGVzIHRvIHN0cgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nRmFpbGVkIGNyZWF0aW5nIHRlbXAgZmlsZSBmb3IgYXRvbWljIG1vdmUuICBUaGlzIHVzdWFsbHkgaGFwcGVucyB3aGVuIHVzaW5nIFB5dGhvbjMgbGVzcyB0aGFuIFB5dGhvbjMuNS4gJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnUGxlYXNlIHVzZSBQeXRob24yLnggb3IgUHl0aG9uMy41IG9yIGdyZWF0ZXIuJywgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCgogICAgICAgICAgICAgICAgYl90bXBfZGVzdF9uYW1lID0gdG9fYnl0ZXModG1wX2Rlc3RfbmFtZSwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAjIGNsb3NlIHRtcCBmaWxlIGhhbmRsZSBiZWZvcmUgZmlsZSBvcGVyYXRpb25zIHRvIHByZXZlbnQgdGV4dCBmaWxlIGJ1c3kgZXJyb3JzIG9uIHZib3hmcyBzeW5jZWQgZm9sZGVycyAod2luZG93cyBob3N0KQogICAgICAgICAgICAgICAgICAgICAgICBvcy5jbG9zZSh0bXBfZGVzdF9mZCkKICAgICAgICAgICAgICAgICAgICAgICAgIyBsZWF2ZXMgdG1wIGZpbGUgYmVoaW5kIHdoZW4gc3VkbyBhbmQgbm90IHJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2h1dGlsLm1vdmUoYl9zcmMsIGJfdG1wX2Rlc3RfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIGNsZWFudXAgd2lsbCBoYXBwZW4gYnkgJ3JtJyBvZiB0ZW1wZGlyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIGNvcHkyIHdpbGwgcHJlc2VydmUgc29tZSBtZXRhZGF0YQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2h1dGlsLmNvcHkyKGJfc3JjLCBiX3RtcF9kZXN0X25hbWUpCgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYl90bXBfZGVzdF9uYW1lLCBjb250ZXh0LCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wX3N0YXQgPSBvcy5zdGF0KGJfdG1wX2Rlc3RfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGRlc3Rfc3RhdCBhbmQgKHRtcF9zdGF0LnN0X3VpZCAhPSBkZXN0X3N0YXQuc3RfdWlkIG9yIHRtcF9zdGF0LnN0X2dpZCAhPSBkZXN0X3N0YXQuc3RfZ2lkKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy5jaG93bihiX3RtcF9kZXN0X25hbWUsIGRlc3Rfc3RhdC5zdF91aWQsIGRlc3Rfc3RhdC5zdF9naWQpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZS5lcnJubyAhPSBlcnJuby5FUEVSTToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy5yZW5hbWUoYl90bXBfZGVzdF9uYW1lLCBiX2Rlc3QpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCAoc2h1dGlsLkVycm9yLCBPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVuc2FmZV93cml0ZXMgYW5kIGUuZXJybm8gPT0gZXJybm8uRUJVU1k6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fdW5zYWZlX3dyaXRlcyhiX3RtcF9kZXN0X25hbWUsIGJfZGVzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdVbmFibGUgdG8gcmVuYW1lIGZpbGU6ICVzIHRvICVzOiAlcycgJSAoc3JjLCBkZXN0LCBlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nRmFpbGVkIHRvIHJlcGxhY2UgZmlsZTogJXMgdG8gJXM6ICVzJyAlIChzcmMsIGRlc3QsIGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jbGVhbnVwKGJfdG1wX2Rlc3RfbmFtZSkKCiAgICAgICAgaWYgY3JlYXRpbmc6CiAgICAgICAgICAgICMgbWFrZSBzdXJlIHRoZSBmaWxlIGhhcyB0aGUgY29ycmVjdCBwZXJtaXNzaW9ucwogICAgICAgICAgICAjIGJhc2VkIG9uIHRoZSBjdXJyZW50IHZhbHVlIG9mIHVtYXNrCiAgICAgICAgICAgIHVtYXNrID0gb3MudW1hc2soMCkKICAgICAgICAgICAgb3MudW1hc2sodW1hc2spCiAgICAgICAgICAgIG9zLmNobW9kKGJfZGVzdCwgREVGQVVMVF9QRVJNICYgfnVtYXNrKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5jaG93bihiX2Rlc3QsIG9zLmdldGV1aWQoKSwgb3MuZ2V0ZWdpZCgpKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICMgV2UncmUgb2theSB3aXRoIHRyeWluZyBvdXIgYmVzdCBoZXJlLiAgSWYgdGhlIHVzZXIgaXMgbm90CiAgICAgICAgICAgICAgICAjIHJvb3QgKG9yIG9sZCBVbmljZXMpIHRoZXkgd29uJ3QgYmUgYWJsZSB0byBjaG93bi4KICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgaWYgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgIyByZW5hbWUgbWlnaHQgbm90IHByZXNlcnZlIGNvbnRleHQKICAgICAgICAgICAgc2VsZi5zZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoZGVzdCwgY29udGV4dCwgRmFsc2UpCgogICAgZGVmIF91bnNhZmVfd3JpdGVzKHNlbGYsIHNyYywgZGVzdCk6CiAgICAgICAgIyBzYWRseSB0aGVyZSBhcmUgc29tZSBzaXR1YXRpb25zIHdoZXJlIHdlIGNhbm5vdCBlbnN1cmUgYXRvbWljaXR5LCBidXQgb25seSBpZgogICAgICAgICMgdGhlIHVzZXIgaW5zaXN0cyBhbmQgd2UgZ2V0IHRoZSBhcHByb3ByaWF0ZSBlcnJvciB3ZSB1cGRhdGUgdGhlIGZpbGUgdW5zYWZlbHkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG91dF9kZXN0ID0gb3BlbihkZXN0LCAnd2InKQogICAgICAgICAgICAgICAgaW5fc3JjID0gb3BlbihzcmMsICdyYicpCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weWZpbGVvYmooaW5fc3JjLCBvdXRfZGVzdCkKICAgICAgICAgICAgZmluYWxseTogICMgYXNzdXJpbmcgY2xvc2VkIGZpbGVzIGluIDIuNCBjb21wYXRpYmxlIHdheQogICAgICAgICAgICAgICAgaWYgb3V0X2Rlc3Q6CiAgICAgICAgICAgICAgICAgICAgb3V0X2Rlc3QuY2xvc2UoKQogICAgICAgICAgICAgICAgaWYgaW5fc3JjOgogICAgICAgICAgICAgICAgICAgIGluX3NyYy5jbG9zZSgpCiAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nQ291bGQgbm90IHdyaXRlIGRhdGEgdG8gZmlsZSAoJXMpIGZyb20gKCVzKTogJXMnICUgKGRlc3QsIHNyYywgZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQoKCiAgICBkZWYgX3JlYWRfZnJvbV9waXBlcyhzZWxmLCBycGlwZXMsIHJmZHMsIGZpbGVfZGVzY3JpcHRvcik6CiAgICAgICAgZGF0YSA9IGIoJycpCiAgICAgICAgaWYgZmlsZV9kZXNjcmlwdG9yIGluIHJmZHM6CiAgICAgICAgICAgIGRhdGEgPSBvcy5yZWFkKGZpbGVfZGVzY3JpcHRvci5maWxlbm8oKSwgOTAwMCkKICAgICAgICAgICAgaWYgZGF0YSA9PSBiKCcnKToKICAgICAgICAgICAgICAgIHJwaXBlcy5yZW1vdmUoZmlsZV9kZXNjcmlwdG9yKQoKICAgICAgICByZXR1cm4gZGF0YQoKICAgIGRlZiBydW5fY29tbWFuZChzZWxmLCBhcmdzLCBjaGVja19yYz1GYWxzZSwgY2xvc2VfZmRzPVRydWUsIGV4ZWN1dGFibGU9Tm9uZSwgZGF0YT1Ob25lLCBiaW5hcnlfZGF0YT1GYWxzZSwgcGF0aF9wcmVmaXg9Tm9uZSwgY3dkPU5vbmUsCiAgICAgICAgICAgICAgICAgICAgdXNlX3Vuc2FmZV9zaGVsbD1GYWxzZSwgcHJvbXB0X3JlZ2V4PU5vbmUsIGVudmlyb25fdXBkYXRlPU5vbmUsIHVtYXNrPU5vbmUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpOgogICAgICAgICcnJwogICAgICAgIEV4ZWN1dGUgYSBjb21tYW5kLCByZXR1cm5zIHJjLCBzdGRvdXQsIGFuZCBzdGRlcnIuCgogICAgICAgIDphcmcgYXJnczogaXMgdGhlIGNvbW1hbmQgdG8gcnVuCiAgICAgICAgICAgICogSWYgYXJncyBpcyBhIGxpc3QsIHRoZSBjb21tYW5kIHdpbGwgYmUgcnVuIHdpdGggc2hlbGw9RmFsc2UuCiAgICAgICAgICAgICogSWYgYXJncyBpcyBhIHN0cmluZyBhbmQgdXNlX3Vuc2FmZV9zaGVsbD1GYWxzZSBpdCB3aWxsIHNwbGl0IGFyZ3MgdG8gYSBsaXN0IGFuZCBydW4gd2l0aCBzaGVsbD1GYWxzZQogICAgICAgICAgICAqIElmIGFyZ3MgaXMgYSBzdHJpbmcgYW5kIHVzZV91bnNhZmVfc2hlbGw9VHJ1ZSBpdCBydW5zIHdpdGggc2hlbGw9VHJ1ZS4KICAgICAgICA6a3cgY2hlY2tfcmM6IFdoZXRoZXIgdG8gY2FsbCBmYWlsX2pzb24gaW4gY2FzZSBvZiBub24gemVybyBSQy4KICAgICAgICAgICAgRGVmYXVsdCBGYWxzZQogICAgICAgIDprdyBjbG9zZV9mZHM6IFNlZSBkb2N1bWVudGF0aW9uIGZvciBzdWJwcm9jZXNzLlBvcGVuKCkuIERlZmF1bHQgVHJ1ZQogICAgICAgIDprdyBleGVjdXRhYmxlOiBTZWUgZG9jdW1lbnRhdGlvbiBmb3Igc3VicHJvY2Vzcy5Qb3BlbigpLiBEZWZhdWx0IE5vbmUKICAgICAgICA6a3cgZGF0YTogSWYgZ2l2ZW4sIGluZm9ybWF0aW9uIHRvIHdyaXRlIHRvIHRoZSBzdGRpbiBvZiB0aGUgY29tbWFuZAogICAgICAgIDprdyBiaW5hcnlfZGF0YTogSWYgRmFsc2UsIGFwcGVuZCBhIG5ld2xpbmUgdG8gdGhlIGRhdGEuICBEZWZhdWx0IEZhbHNlCiAgICAgICAgOmt3IHBhdGhfcHJlZml4OiBJZiBnaXZlbiwgYWRkaXRpb25hbCBwYXRoIHRvIGZpbmQgdGhlIGNvbW1hbmQgaW4uCiAgICAgICAgICAgIFRoaXMgYWRkcyB0byB0aGUgUEFUSCBlbnZpcm9ubWVudCB2YWlyYWJsZSBzbyBoZWxwZXIgY29tbWFuZHMgaW4KICAgICAgICAgICAgdGhlIHNhbWUgZGlyZWN0b3J5IGNhbiBhbHNvIGJlIGZvdW5kCiAgICAgICAgOmt3IGN3ZDogSWYgZ2l2ZW4sIHdvcmtpbmcgZGlyZWN0b3J5IHRvIHJ1biB0aGUgY29tbWFuZCBpbnNpZGUKICAgICAgICA6a3cgdXNlX3Vuc2FmZV9zaGVsbDogU2VlIGBhcmdzYCBwYXJhbWV0ZXIuICBEZWZhdWx0IEZhbHNlCiAgICAgICAgOmt3IHByb21wdF9yZWdleDogUmVnZXggc3RyaW5nIChub3QgYSBjb21waWxlZCByZWdleCkgd2hpY2ggY2FuIGJlCiAgICAgICAgICAgIHVzZWQgdG8gZGV0ZWN0IHByb21wdHMgaW4gdGhlIHN0ZG91dCB3aGljaCB3b3VsZCBvdGhlcndpc2UgY2F1c2UKICAgICAgICAgICAgdGhlIGV4ZWN1dGlvbiB0byBoYW5nIChlc3BlY2lhbGx5IGlmIG5vIGlucHV0IGRhdGEgaXMgc3BlY2lmaWVkKQogICAgICAgIDprdyBlbnZpcm9uX3VwZGF0ZTogZGljdGlvbmFyeSB0byAqdXBkYXRlKiBvcy5lbnZpcm9uIHdpdGgKICAgICAgICA6a3cgdW1hc2s6IFVtYXNrIHRvIGJlIHVzZWQgd2hlbiBydW5uaW5nIHRoZSBjb21tYW5kLiBEZWZhdWx0IE5vbmUKICAgICAgICA6a3cgZW5jb2Rpbmc6IFNpbmNlIHdlIHJldHVybiBuYXRpdmUgc3RyaW5ncywgb24gcHl0aG9uMyB3ZSBuZWVkIHRvCiAgICAgICAgICAgIGtub3cgdGhlIGVuY29kaW5nIHRvIHVzZSB0byB0cmFuc2Zvcm0gZnJvbSBieXRlcyB0byB0ZXh0LiAgSWYgeW91CiAgICAgICAgICAgIHdhbnQgdG8gYWx3YXlzIGdldCBieXRlcyBiYWNrLCB1c2UgZW5jb2Rpbmc9Tm9uZS4gIFRoZSBkZWZhdWx0IGlzCiAgICAgICAgICAgICJ1dGYtOCIuICBUaGlzIGRvZXMgbm90IGFmZmVjdCB0cmFuc2Zvcm1hdGlvbiBvZiBzdHJpbmdzIGdpdmVuIGFzCiAgICAgICAgICAgIGFyZ3MuCiAgICAgICAgOmt3IGVycm9yczogU2luY2Ugd2UgcmV0dXJuIG5hdGl2ZSBzdHJpbmdzLCBvbiBweXRob24zIHdlIG5lZWQgdG8KICAgICAgICAgICAgdHJhbnNmb3JtIHN0ZG91dCBhbmQgc3RkZXJyIGZyb20gYnl0ZXMgdG8gdGV4dC4gIElmIHRoZSBieXRlcyBhcmUKICAgICAgICAgICAgdW5kZWNvZGFibGUgaW4gdGhlIGBgZW5jb2RpbmdgYCBzcGVjaWZpZWQsIHRoZW4gdXNlIHRoaXMgZXJyb3IKICAgICAgICAgICAgaGFuZGxlciB0byBkZWFsIHdpdGggdGhlbS4gIFRoZSBkZWZhdWx0IGlzIGBgc3Vycm9nYXRlX29yX3N0cmljdGBgCiAgICAgICAgICAgIHdoaWNoIG1lYW5zIHRoYXQgdGhlIGJ5dGVzIHdpbGwgYmUgZGVjb2RlZCB1c2luZyB0aGUKICAgICAgICAgICAgc3Vycm9nYXRlZXNjYXBlIGVycm9yIGhhbmRsZXIgaWYgYXZhaWxhYmxlIChhdmFpbGFibGUgb24gYWxsCiAgICAgICAgICAgIHB5dGhvbjMgdmVyc2lvbnMgd2Ugc3VwcG9ydCkgb3RoZXJ3aXNlIGEgVW5pY29kZUVycm9yIHRyYWNlYmFjawogICAgICAgICAgICB3aWxsIGJlIHJhaXNlZC4gIFRoaXMgZG9lcyBub3QgYWZmZWN0IHRyYW5zZm9ybWF0aW9ucyBvZiBzdHJpbmdzCiAgICAgICAgICAgIGdpdmVuIGFzIGFyZ3MuCiAgICAgICAgOnJldHVybnM6IEEgMy10dXBsZSBvZiByZXR1cm4gY29kZSAoaW50ZWdlciksIHN0ZG91dCAobmF0aXZlIHN0cmluZyksCiAgICAgICAgICAgIGFuZCBzdGRlcnIgKG5hdGl2ZSBzdHJpbmcpLiAgT24gcHl0aG9uMiwgc3Rkb3V0IGFuZCBzdGRlcnIgYXJlIGJvdGgKICAgICAgICAgICAgYnl0ZSBzdHJpbmdzLiAgT24gcHl0aG9uMywgc3Rkb3V0IGFuZCBzdGRlcnIgYXJlIHRleHQgc3RyaW5ncyBjb252ZXJ0ZWQKICAgICAgICAgICAgYWNjb3JkaW5nIHRvIHRoZSBlbmNvZGluZyBhbmQgZXJyb3JzIHBhcmFtZXRlcnMuICBJZiB5b3Ugd2FudCBieXRlCiAgICAgICAgICAgIHN0cmluZ3Mgb24gcHl0aG9uMywgdXNlIGVuY29kaW5nPU5vbmUgdG8gdHVybiBkZWNvZGluZyB0byB0ZXh0IG9mZi4KICAgICAgICAnJycKCiAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCBsaXN0KToKICAgICAgICAgICAgaWYgdXNlX3Vuc2FmZV9zaGVsbDoKICAgICAgICAgICAgICAgIGFyZ3MgPSAiICIuam9pbihbc2hsZXhfcXVvdGUoeCkgZm9yIHggaW4gYXJnc10pCiAgICAgICAgICAgICAgICBzaGVsbCA9IFRydWUKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoYXJncywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKSBhbmQgdXNlX3Vuc2FmZV9zaGVsbDoKICAgICAgICAgICAgc2hlbGwgPSBUcnVlCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGFyZ3MsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgIGlmIG5vdCB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICAgICAgIyBPbiBweXRob24yLjYgYW5kIGJlbG93LCBzaGxleCBoYXMgcHJvYmxlbXMgd2l0aCB0ZXh0IHR5cGUKICAgICAgICAgICAgICAgICMgT24gcHl0aG9uMywgc2hsZXggbmVlZHMgYSB0ZXh0IHR5cGUuCiAgICAgICAgICAgICAgICBpZiBQWTI6CiAgICAgICAgICAgICAgICAgICAgYXJncyA9IHRvX2J5dGVzKGFyZ3MsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgICAgICAgICBlbGlmIFBZMzoKICAgICAgICAgICAgICAgICAgICBhcmdzID0gdG9fdGV4dChhcmdzLCBlcnJvcnM9J3N1cnJvZ2F0ZWVzY2FwZScpCiAgICAgICAgICAgICAgICBhcmdzID0gc2hsZXguc3BsaXQoYXJncykKICAgICAgICBlbHNlOgogICAgICAgICAgICBtc2cgPSAiQXJndW1lbnQgJ2FyZ3MnIHRvIHJ1bl9jb21tYW5kIG11c3QgYmUgbGlzdCBvciBzdHJpbmciCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPTI1NywgY21kPWFyZ3MsIG1zZz1tc2cpCgogICAgICAgIHNoZWxsID0gRmFsc2UKICAgICAgICBpZiB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICBpZiBleGVjdXRhYmxlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBleGVjdXRhYmxlID0gb3MuZW52aXJvbi5nZXQoJ1NIRUxMJykKICAgICAgICAgICAgaWYgZXhlY3V0YWJsZToKICAgICAgICAgICAgICAgIGFyZ3MgPSBbZXhlY3V0YWJsZSwgJy1jJywgYXJnc10KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNoZWxsID0gVHJ1ZQoKICAgICAgICBwcm9tcHRfcmUgPSBOb25lCiAgICAgICAgaWYgcHJvbXB0X3JlZ2V4OgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHByb21wdF9yZWdleCwgdGV4dF90eXBlKToKICAgICAgICAgICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgICAgICAgICBwcm9tcHRfcmVnZXggPSB0b19ieXRlcyhwcm9tcHRfcmVnZXgsIGVycm9ycz0nc3Vycm9nYXRlZXNjYXBlJykKICAgICAgICAgICAgICAgIGVsaWYgUFkyOgogICAgICAgICAgICAgICAgICAgIHByb21wdF9yZWdleCA9IHRvX2J5dGVzKHByb21wdF9yZWdleCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcHJvbXB0X3JlID0gcmUuY29tcGlsZShwcm9tcHRfcmVnZXgsIHJlLk1VTFRJTElORSkKICAgICAgICAgICAgZXhjZXB0IHJlLmVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJpbnZhbGlkIHByb21wdCByZWd1bGFyIGV4cHJlc3Npb24gZ2l2ZW4gdG8gcnVuX2NvbW1hbmQiKQoKICAgICAgICAjIGV4cGFuZCB0aGluZ3MgbGlrZSAkSE9NRSBhbmQgfgogICAgICAgIGlmIG5vdCBzaGVsbDoKICAgICAgICAgICAgYXJncyA9IFsgb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyh4KSkgZm9yIHggaW4gYXJncyBpZiB4IGlzIG5vdCBOb25lIF0KCiAgICAgICAgcmMgPSAwCiAgICAgICAgbXNnID0gTm9uZQogICAgICAgIHN0X2luID0gTm9uZQoKICAgICAgICAjIE1hbmlwdWxhdGUgdGhlIGVudmlyb24gd2UnbGwgc2VuZCB0byB0aGUgbmV3IHByb2Nlc3MKICAgICAgICBvbGRfZW52X3ZhbHMgPSB7fQogICAgICAgICMgV2UgY2FuIHNldCB0aGlzIGZyb20gYm90aCBhbiBhdHRyaWJ1dGUgYW5kIHBlciBjYWxsCiAgICAgICAgZm9yIGtleSwgdmFsIGluIHNlbGYucnVuX2NvbW1hbmRfZW52aXJvbl91cGRhdGUuaXRlbXMoKToKICAgICAgICAgICAgb2xkX2Vudl92YWxzW2tleV0gPSBvcy5lbnZpcm9uLmdldChrZXksIE5vbmUpCiAgICAgICAgICAgIG9zLmVudmlyb25ba2V5XSA9IHZhbAogICAgICAgIGlmIGVudmlyb25fdXBkYXRlOgogICAgICAgICAgICBmb3Iga2V5LCB2YWwgaW4gZW52aXJvbl91cGRhdGUuaXRlbXMoKToKICAgICAgICAgICAgICAgIG9sZF9lbnZfdmFsc1trZXldID0gb3MuZW52aXJvbi5nZXQoa2V5LCBOb25lKQogICAgICAgICAgICAgICAgb3MuZW52aXJvbltrZXldID0gdmFsCiAgICAgICAgaWYgcGF0aF9wcmVmaXg6CiAgICAgICAgICAgIG9sZF9lbnZfdmFsc1snUEFUSCddID0gb3MuZW52aXJvblsnUEFUSCddCiAgICAgICAgICAgIG9zLmVudmlyb25bJ1BBVEgnXSA9ICIlczolcyIgJSAocGF0aF9wcmVmaXgsIG9zLmVudmlyb25bJ1BBVEgnXSkKCiAgICAgICAgIyBJZiB1c2luZyB0ZXN0LW1vZHVsZSBhbmQgZXhwbG9kZSwgdGhlIHJlbW90ZSBsaWIgcGF0aCB3aWxsIHJlc2VtYmxlIC4uLgogICAgICAgICMgICAvdG1wL3Rlc3RfbW9kdWxlX3NjcmF0Y2gvZGVidWdfZGlyL2Fuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5CiAgICAgICAgIyBJZiB1c2luZyBhbnNpYmxlIG9yIGFuc2libGUtcGxheWJvb2sgd2l0aCBhIHJlbW90ZSBzeXN0ZW0gLi4uCiAgICAgICAgIyAgIC90bXAvYW5zaWJsZV92bXdlTFEvYW5zaWJsZV9tb2RsaWIuemlwL2Fuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5CgogICAgICAgICMgQ2xlYW4gb3V0IHB5dGhvbiBwYXRocyBzZXQgYnkgYW5zaWJhbGx6CiAgICAgICAgaWYgJ1BZVEhPTlBBVEgnIGluIG9zLmVudmlyb246CiAgICAgICAgICAgIHB5cGF0aHMgPSBvcy5lbnZpcm9uWydQWVRIT05QQVRIJ10uc3BsaXQoJzonKQogICAgICAgICAgICBweXBhdGhzID0gW3ggZm9yIHggaW4gcHlwYXRocyBcCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCB4LmVuZHN3aXRoKCcvYW5zaWJsZV9tb2RsaWIuemlwJykgXAogICAgICAgICAgICAgICAgICAgICAgICBhbmQgbm90IHguZW5kc3dpdGgoJy9kZWJ1Z19kaXInKV0KICAgICAgICAgICAgb3MuZW52aXJvblsnUFlUSE9OUEFUSCddID0gJzonLmpvaW4ocHlwYXRocykKICAgICAgICAgICAgaWYgbm90IG9zLmVudmlyb25bJ1BZVEhPTlBBVEgnXToKICAgICAgICAgICAgICAgIGRlbCBvcy5lbnZpcm9uWydQWVRIT05QQVRIJ10KCiAgICAgICAgIyBjcmVhdGUgYSBwcmludGFibGUgdmVyc2lvbiBvZiB0aGUgY29tbWFuZCBmb3IgdXNlCiAgICAgICAgIyBpbiByZXBvcnRpbmcgbGF0ZXIsIHdoaWNoIHN0cmlwcyBvdXQgdGhpbmdzIGxpa2UKICAgICAgICAjIHBhc3N3b3JkcyBmcm9tIHRoZSBhcmdzIGxpc3QKICAgICAgICB0b19jbGVhbl9hcmdzID0gYXJncwogICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICAgICAgdG9fY2xlYW5fYXJncyA9IHRvX2J5dGVzKGFyZ3MpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgICAgICB0b19jbGVhbl9hcmdzID0gdG9fdGV4dChhcmdzKQogICAgICAgIGlmIGlzaW5zdGFuY2UoYXJncywgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICAgICAgdG9fY2xlYW5fYXJncyA9IHNobGV4LnNwbGl0KHRvX2NsZWFuX2FyZ3MpCgogICAgICAgIGNsZWFuX2FyZ3MgPSBbXQogICAgICAgIGlzX3Bhc3N3ZCA9IEZhbHNlCiAgICAgICAgZm9yIGFyZyBpbiB0b19jbGVhbl9hcmdzOgogICAgICAgICAgICBpZiBpc19wYXNzd2Q6CiAgICAgICAgICAgICAgICBpc19wYXNzd2QgPSBGYWxzZQogICAgICAgICAgICAgICAgY2xlYW5fYXJncy5hcHBlbmQoJyoqKioqKioqJykKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIFBBU1NXRF9BUkdfUkUubWF0Y2goYXJnKToKICAgICAgICAgICAgICAgIHNlcF9pZHggPSBhcmcuZmluZCgnPScpCiAgICAgICAgICAgICAgICBpZiBzZXBfaWR4ID4gLTE6CiAgICAgICAgICAgICAgICAgICAgY2xlYW5fYXJncy5hcHBlbmQoJyVzPSoqKioqKioqJyAlIGFyZ1s6c2VwX2lkeF0pCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaXNfcGFzc3dkID0gVHJ1ZQogICAgICAgICAgICBhcmcgPSBoZXVyaXN0aWNfbG9nX3Nhbml0aXplKGFyZywgc2VsZi5ub19sb2dfdmFsdWVzKQogICAgICAgICAgICBjbGVhbl9hcmdzLmFwcGVuZChhcmcpCiAgICAgICAgY2xlYW5fYXJncyA9ICcgJy5qb2luKHNobGV4X3F1b3RlKGFyZykgZm9yIGFyZyBpbiBjbGVhbl9hcmdzKQoKICAgICAgICBpZiBkYXRhOgogICAgICAgICAgICBzdF9pbiA9IHN1YnByb2Nlc3MuUElQRQoKICAgICAgICBrd2FyZ3MgPSBkaWN0KAogICAgICAgICAgICBleGVjdXRhYmxlPWV4ZWN1dGFibGUsCiAgICAgICAgICAgIHNoZWxsPXNoZWxsLAogICAgICAgICAgICBjbG9zZV9mZHM9Y2xvc2VfZmRzLAogICAgICAgICAgICBzdGRpbj1zdF9pbiwKICAgICAgICAgICAgc3Rkb3V0PXN1YnByb2Nlc3MuUElQRSwKICAgICAgICAgICAgc3RkZXJyPXN1YnByb2Nlc3MuUElQRSwKICAgICAgICApCgogICAgICAgICMgc3RvcmUgdGhlIHB3ZAogICAgICAgIHByZXZfZGlyID0gb3MuZ2V0Y3dkKCkKCiAgICAgICAgIyBtYWtlIHN1cmUgd2UncmUgaW4gdGhlIHJpZ2h0IHdvcmtpbmcgZGlyZWN0b3J5CiAgICAgICAgaWYgY3dkIGFuZCBvcy5wYXRoLmlzZGlyKGN3ZCk6CiAgICAgICAgICAgIGN3ZCA9IG9zLnBhdGguYWJzcGF0aChvcy5wYXRoLmV4cGFuZHVzZXIoY3dkKSkKICAgICAgICAgICAga3dhcmdzWydjd2QnXSA9IGN3ZAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5jaGRpcihjd2QpCiAgICAgICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihyYz1lLmVycm5vLCBtc2c9IkNvdWxkIG5vdCBvcGVuICVzLCAlcyIgJSAoY3dkLCBzdHIoZSkpKQoKICAgICAgICBvbGRfdW1hc2sgPSBOb25lCiAgICAgICAgaWYgdW1hc2s6CiAgICAgICAgICAgIG9sZF91bWFzayA9IG9zLnVtYXNrKHVtYXNrKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbGYuX2RlYnVnOgogICAgICAgICAgICAgICAgc2VsZi5sb2coJ0V4ZWN1dGluZzogJyArIGNsZWFuX2FyZ3MpCiAgICAgICAgICAgIGNtZCA9IHN1YnByb2Nlc3MuUG9wZW4oYXJncywgKiprd2FyZ3MpCgogICAgICAgICAgICAjIHRoZSBjb21tdW5pY2F0aW9uIGxvZ2ljIGhlcmUgaXMgZXNzZW50aWFsbHkgdGFrZW4gZnJvbSB0aGF0CiAgICAgICAgICAgICMgb2YgdGhlIF9jb21tdW5pY2F0ZSgpIGZ1bmN0aW9uIGluIHNzaC5weQoKICAgICAgICAgICAgc3Rkb3V0ID0gYignJykKICAgICAgICAgICAgc3RkZXJyID0gYignJykKICAgICAgICAgICAgcnBpcGVzID0gW2NtZC5zdGRvdXQsIGNtZC5zdGRlcnJdCgogICAgICAgICAgICBpZiBkYXRhOgogICAgICAgICAgICAgICAgaWYgbm90IGJpbmFyeV9kYXRhOgogICAgICAgICAgICAgICAgICAgIGRhdGEgKz0gJ1xuJwogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkYXRhLCB0ZXh0X3R5cGUpOgogICAgICAgICAgICAgICAgICAgIGRhdGEgPSB0b19ieXRlcyhkYXRhKQogICAgICAgICAgICAgICAgY21kLnN0ZGluLndyaXRlKGRhdGEpCiAgICAgICAgICAgICAgICBjbWQuc3RkaW4uY2xvc2UoKQoKICAgICAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgICAgIHJmZHMsIHdmZHMsIGVmZHMgPSBzZWxlY3Quc2VsZWN0KHJwaXBlcywgW10sIHJwaXBlcywgMSkKICAgICAgICAgICAgICAgIHN0ZG91dCArPSBzZWxmLl9yZWFkX2Zyb21fcGlwZXMocnBpcGVzLCByZmRzLCBjbWQuc3Rkb3V0KQogICAgICAgICAgICAgICAgc3RkZXJyICs9IHNlbGYuX3JlYWRfZnJvbV9waXBlcyhycGlwZXMsIHJmZHMsIGNtZC5zdGRlcnIpCiAgICAgICAgICAgICAgICAjIGlmIHdlJ3JlIGNoZWNraW5nIGZvciBwcm9tcHRzLCBkbyBpdCBub3cKICAgICAgICAgICAgICAgIGlmIHByb21wdF9yZToKICAgICAgICAgICAgICAgICAgICBpZiBwcm9tcHRfcmUuc2VhcmNoKHN0ZG91dCkgYW5kIG5vdCBkYXRhOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBlbmNvZGluZzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dCA9IHRvX25hdGl2ZShzdGRvdXQsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Rkb3V0ID0gc3Rkb3V0CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoMjU3LCBzdGRvdXQsICJBIHByb21wdCB3YXMgZW5jb3VudGVyZWQgd2hpbGUgcnVubmluZyBhIGNvbW1hbmQsIGJ1dCBubyBpbnB1dCBkYXRhIHdhcyBzcGVjaWZpZWQiKQogICAgICAgICAgICAgICAgIyBvbmx5IGJyZWFrIG91dCBpZiBubyBwaXBlcyBhcmUgbGVmdCB0byByZWFkIG9yCiAgICAgICAgICAgICAgICAjIHRoZSBwaXBlcyBhcmUgY29tcGxldGVseSByZWFkIGFuZAogICAgICAgICAgICAgICAgIyB0aGUgcHJvY2VzcyBpcyB0ZXJtaW5hdGVkCiAgICAgICAgICAgICAgICBpZiAobm90IHJwaXBlcyBvciBub3QgcmZkcykgYW5kIGNtZC5wb2xsKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICMgTm8gcGlwZXMgYXJlIGxlZnQgdG8gcmVhZCBidXQgcHJvY2VzcyBpcyBub3QgeWV0IHRlcm1pbmF0ZWQKICAgICAgICAgICAgICAgICMgT25seSB0aGVuIGl0IGlzIHNhZmUgdG8gd2FpdCBmb3IgdGhlIHByb2Nlc3MgdG8gYmUgZmluaXNoZWQKICAgICAgICAgICAgICAgICMgTk9URTogQWN0dWFsbHkgY21kLnBvbGwoKSBpcyBhbHdheXMgTm9uZSBoZXJlIGlmIHJwaXBlcyBpcyBlbXB0eQogICAgICAgICAgICAgICAgZWxpZiBub3QgcnBpcGVzIGFuZCBjbWQucG9sbCgpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgY21kLndhaXQoKQogICAgICAgICAgICAgICAgICAgICMgVGhlIHByb2Nlc3MgaXMgdGVybWluYXRlZC4gU2luY2Ugbm8gcGlwZXMgdG8gcmVhZCBmcm9tIGFyZQogICAgICAgICAgICAgICAgICAgICMgbGVmdCwgdGhlcmUgaXMgbm8gbmVlZCB0byBjYWxsIHNlbGVjdCgpIGFnYWluLgogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBjbWQuc3Rkb3V0LmNsb3NlKCkKICAgICAgICAgICAgY21kLnN0ZGVyci5jbG9zZSgpCgogICAgICAgICAgICByYyA9IGNtZC5yZXR1cm5jb2RlCiAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLmxvZygiRXJyb3IgRXhlY3V0aW5nIENNRDolcyBFeGNlcHRpb246JXMiICUgKGNsZWFuX2FyZ3MsIHRvX25hdGl2ZShlKSkpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPWUuZXJybm8sIG1zZz10b19uYXRpdmUoZSksIGNtZD1jbGVhbl9hcmdzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5sb2coIkVycm9yIEV4ZWN1dGluZyBDTUQ6JXMgRXhjZXB0aW9uOiVzIiAlIChjbGVhbl9hcmdzLHRvX25hdGl2ZSh0cmFjZWJhY2suZm9ybWF0X2V4YygpKSkpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPTI1NywgbXNnPXRvX25hdGl2ZShlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCksIGNtZD1jbGVhbl9hcmdzKQoKICAgICAgICAjIFJlc3RvcmUgZW52IHNldHRpbmdzCiAgICAgICAgZm9yIGtleSwgdmFsIGluIG9sZF9lbnZfdmFscy5pdGVtcygpOgogICAgICAgICAgICBpZiB2YWwgaXMgTm9uZToKICAgICAgICAgICAgICAgIGRlbCBvcy5lbnZpcm9uW2tleV0KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9zLmVudmlyb25ba2V5XSA9IHZhbAoKICAgICAgICBpZiBvbGRfdW1hc2s6CiAgICAgICAgICAgIG9zLnVtYXNrKG9sZF91bWFzaykKCiAgICAgICAgaWYgcmMgIT0gMCBhbmQgY2hlY2tfcmM6CiAgICAgICAgICAgIG1zZyA9IGhldXJpc3RpY19sb2dfc2FuaXRpemUoc3RkZXJyLnJzdHJpcCgpLCBzZWxmLm5vX2xvZ192YWx1ZXMpCiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKGNtZD1jbGVhbl9hcmdzLCByYz1yYywgc3Rkb3V0PXN0ZG91dCwgc3RkZXJyPXN0ZGVyciwgbXNnPW1zZykKCiAgICAgICAgIyByZXNldCB0aGUgcHdkCiAgICAgICAgb3MuY2hkaXIocHJldl9kaXIpCgogICAgICAgIGlmIGVuY29kaW5nIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXR1cm4gKHJjLCB0b19uYXRpdmUoc3Rkb3V0LCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycyksCiAgICAgICAgICAgICAgICAgICAgdG9fbmF0aXZlKHN0ZGVyciwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpKQogICAgICAgIHJldHVybiAocmMsIHN0ZG91dCwgc3RkZXJyKQoKICAgIGRlZiBhcHBlbmRfdG9fZmlsZShzZWxmLCBmaWxlbmFtZSwgc3RyKToKICAgICAgICBmaWxlbmFtZSA9IG9zLnBhdGguZXhwYW5kdmFycyhvcy5wYXRoLmV4cGFuZHVzZXIoZmlsZW5hbWUpKQogICAgICAgIGZoID0gb3BlbihmaWxlbmFtZSwgJ2EnKQogICAgICAgIGZoLndyaXRlKHN0cikKICAgICAgICBmaC5jbG9zZSgpCgogICAgZGVmIGJ5dGVzX3RvX2h1bWFuKHNlbGYsIHNpemUpOgogICAgICAgIHJldHVybiBieXRlc190b19odW1hbihzaXplKQoKICAgICMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CiAgICBwcmV0dHlfYnl0ZXMgPSBieXRlc190b19odW1hbgoKICAgIGRlZiBodW1hbl90b19ieXRlcyhzZWxmLCBudW1iZXIsIGlzYml0cz1GYWxzZSk6CiAgICAgICAgcmV0dXJuIGh1bWFuX3RvX2J5dGVzKG51bWJlciwgaXNiaXRzKQoKICAgICMKICAgICMgQmFja3dhcmRzIGNvbXBhdAogICAgIwoKICAgICMgSW4gMi4wLCBtb3ZlZCBmcm9tIGluc2lkZSB0aGUgbW9kdWxlIHRvIHRoZSB0b3BsZXZlbAogICAgaXNfZXhlY3V0YWJsZSA9IGlzX2V4ZWN1dGFibGUKCgpkZWYgZ2V0X21vZHVsZV9wYXRoKCk6CiAgICByZXR1cm4gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGgucmVhbHBhdGgoX19maWxlX18pKQpQSwMEFAAAAAAAy7srS7XYBAYlMAAAJTAAAB0AAABhbnNpYmxlL21vZHVsZV91dGlscy9fdGV4dC5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpLCBUb3NoaW8gS3VyYXRvbWkgPGEuYmFkZ2VyQGdtYWlsLmNvbT4sIDIwMTYKIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dCBtb2RpZmljYXRpb24sCiMgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAojICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5ECiMgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRUQKIyBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuCiMgSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsCiMgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLAojIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUwojIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QKIyBMSUFCSUxJVFksIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUKIyBVU0UgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwoKIiIiCi4uIHdhcm46OiBUaGlzIG1vZHVsZV91dGlsIGlzIGN1cnJlbnRseSBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbi4KICAgIFdlIHdhbnQgdG8gZXZhbHVhdGUgdGhpcyBjb2RlIGZvciBzdGFiaWxpdHkgYW5kIEFQSSBzdWl0YWJpbGl0eSBiZWZvcmUKICAgIG1ha2luZyBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBndWFyYW50ZWVzLiAgVGhlIEFQSSBtYXkgY2hhbmdlIGJldHdlZW4KICAgIHJlbGVhc2VzLiAgRG8gbm90IHVzZSB0aGlzIHVubGVzcyB5b3UgYXJlIHdpbGxpbmcgdG8gcG9ydCB5b3VyIG1vZHVsZSBjb2RlLgoiIiIKaW1wb3J0IGNvZGVjcwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IFBZMywgdGV4dF90eXBlLCBiaW5hcnlfdHlwZQoKCnRyeToKICAgIGNvZGVjcy5sb29rdXBfZXJyb3IoJ3N1cnJvZ2F0ZWVzY2FwZScpCiAgICBIQVNfU1VSUk9HQVRFRVNDQVBFID0gVHJ1ZQpleGNlcHQgTG9va3VwRXJyb3I6CiAgICBIQVNfU1VSUk9HQVRFRVNDQVBFID0gRmFsc2UKCgpfQ09NUE9TRURfRVJST1JfSEFORExFUlMgPSBmcm96ZW5zZXQoKE5vbmUsICdzdXJyb2dhdGVfb3JfZXNjYXBlJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdXJyb2dhdGVfb3Jfc3RyaWN0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykpCgoKZGVmIHRvX2J5dGVzKG9iaiwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPU5vbmUsIG5vbnN0cmluZz0nc2ltcGxlcmVwcicpOgogICAgIiIiTWFrZSBzdXJlIHRoYXQgYSBzdHJpbmcgaXMgYSBieXRlIHN0cmluZwoKICAgIDphcmcgb2JqOiBBbiBvYmplY3QgdG8gbWFrZSBzdXJlIGlzIGEgYnl0ZSBzdHJpbmcuICBJbiBtb3N0IGNhc2VzIHRoaXMKICAgICAgICB3aWxsIGJlIGVpdGhlciBhIHRleHQgc3RyaW5nIG9yIGEgYnl0ZSBzdHJpbmcuICBIb3dldmVyLCB3aXRoCiAgICAgICAgYGBub25zdHJpbmc9J3NpbXBsZXJlcHInYGAsIHRoaXMgY2FuIGJlIHVzZWQgYXMgYSB0cmFjZWJhY2stZnJlZQogICAgICAgIHZlcnNpb24gb2YgYGBzdHIob2JqKWBgLgogICAgOmt3YXJnIGVuY29kaW5nOiBUaGUgZW5jb2RpbmcgdG8gdXNlIHRvIHRyYW5zZm9ybSBmcm9tIGEgdGV4dCBzdHJpbmcgdG8KICAgICAgICBhIGJ5dGUgc3RyaW5nLiAgRGVmYXVsdHMgdG8gdXNpbmcgJ3V0Zi04Jy4KICAgIDprd2FyZyBlcnJvcnM6IFRoZSBlcnJvciBoYW5kbGVyIHRvIHVzZSBpZiB0aGUgdGV4dCBzdHJpbmcgaXMgbm90CiAgICAgICAgZW5jb2RhYmxlIHVzaW5nIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcuICBBbnkgdmFsaWQgYGNvZGVjcyBlcnJvcgogICAgICAgIGhhbmRsZXIgPGh0dHBzOi8vZG9jcy5weXRob24ub3JnLzIvbGlicmFyeS9jb2RlY3MuaHRtbCNjb2RlYy1iYXNlLWNsYXNzZXM+YF8KICAgICAgICBtYXkgYmUgc3BlY2lmaWVkLiBUaGVyZSBhcmUgdGhyZWUgYWRkaXRpb25hbCBlcnJvciBzdHJhdGVnaWVzCiAgICAgICAgc3BlY2lmaWNhbGx5IGFpbWVkIGF0IGhlbHBpbmcgcGVvcGxlIHRvIHBvcnQgY29kZS4gIFRoZSBmaXJzdCB0d28gYXJlOgoKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9zdHJpY3Q6IFdpbGwgdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlciwgb3RoZXJ3aXNlIGl0IHdpbGwgdXNlIGBgc3RyaWN0YGAKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9yZXBsYWNlOiBXaWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSBgYHJlcGxhY2VgYC4KCiAgICAgICAgQmVjYXVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIHdhcyBhZGRlZCBpbiBQeXRob24zIHRoaXMgdXN1YWxseSBtZWFucyB0aGF0CiAgICAgICAgUHl0aG9uMyB3aWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGFuZCBQeXRob24yIHdpbGwgdXNlIHRoZSBmYWxsYmFjawogICAgICAgIGVycm9yIGhhbmRsZXIuIE5vdGUgdGhhdCB0aGUgY29kZSBjaGVja3MgZm9yIGBgc3Vycm9nYXRlZXNjYXBlYGAgd2hlbiB0aGUKICAgICAgICBtb2R1bGUgaXMgaW1wb3J0ZWQuICBJZiB5b3UgaGF2ZSBhIGJhY2twb3J0IG9mIGBgc3Vycm9nYXRlZXNjYXBlYGAgZm9yCiAgICAgICAgUHl0aG9uMiwgYmUgc3VyZSB0byByZWdpc3RlciB0aGUgZXJyb3IgaGFuZGxlciBwcmlvciB0byBpbXBvcnRpbmcgdGhpcwogICAgICAgIG1vZHVsZS4KCiAgICAgICAgVGhlIGxhc3QgZXJyb3IgaGFuZGxlciBpczoKCiAgICAgICAgICAgIDpzdXJyb2dhdGVfdGhlbl9yZXBsYWNlOiBXaWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIuICBJZiBlbmNvZGluZyB3aXRoIGBgc3Vycm9nYXRlZXNjYXBlYGAgd291bGQgdHJhY2ViYWNrLAogICAgICAgICAgICAgICAgc3Vycm9nYXRlcyBhcmUgZmlyc3QgcmVwbGFjZWQgd2l0aCBhIHJlcGxhY2VtZW50IGNoYXJhY3RlcnMKICAgICAgICAgICAgICAgIGFuZCB0aGVuIHRoZSBzdHJpbmcgaXMgZW5jb2RlZCB1c2luZyBgYHJlcGxhY2VgYCAod2hpY2ggcmVwbGFjZXMKICAgICAgICAgICAgICAgIHRoZSByZXN0IG9mIHRoZSBub25lbmNvZGFibGUgYnl0ZXMpLiAgSWYgYGBzdXJyb2dhdGVlc2NhcGVgYCBpcwogICAgICAgICAgICAgICAgbm90IHByZXNlbnQgaXQgd2lsbCBzaW1wbHkgdXNlIGBgcmVwbGFjZWBgLiAgKEFkZGVkIGluIEFuc2libGUgMi4zKQogICAgICAgICAgICAgICAgVGhpcyBzdHJhdGVneSBpcyBkZXNpZ25lZCB0byBuZXZlciB0cmFjZWJhY2sgd2hlbiBpdCBhdHRlbXB0cwogICAgICAgICAgICAgICAgdG8gZW5jb2RlIGEgc3RyaW5nLgoKICAgICAgICBUaGUgZGVmYXVsdCB1bnRpbCBBbnNpYmxlLTIuMiB3YXMgYGBzdXJyb2dhdGVfb3JfcmVwbGFjZWBgCiAgICAgICAgRnJvbSBBbnNpYmxlLTIuMyBvbndhcmRzLCB0aGUgZGVmYXVsdCBpcyBgYHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2VgYC4KCiAgICA6a3dhcmcgbm9uc3RyaW5nOiBUaGUgc3RyYXRlZ3kgdG8gdXNlIGlmIGEgbm9uc3RyaW5nIGlzIHNwZWNpZmllZCBpbgogICAgICAgIGBgb2JqYGAuICBEZWZhdWx0IGlzICdzaW1wbGVyZXByJy4gIFZhbGlkIHZhbHVlcyBhcmU6CgogICAgICAgIDpzaW1wbGVyZXByOiBUaGUgZGVmYXVsdC4gIFRoaXMgdGFrZXMgdGhlIGBgc3RyYGAgb2YgdGhlIG9iamVjdCBhbmQKICAgICAgICAgICAgdGhlbiByZXR1cm5zIHRoZSBieXRlcyB2ZXJzaW9uIG9mIHRoYXQgc3RyaW5nLgogICAgICAgIDplbXB0eTogUmV0dXJuIGFuIGVtcHR5IGJ5dGUgc3RyaW5nCiAgICAgICAgOnBhc3N0aHJ1OiBSZXR1cm4gdGhlIG9iamVjdCBwYXNzZWQgaW4KICAgICAgICA6c3RyaWN0OiBSYWlzZSBhIDpleGM6YFR5cGVFcnJvcmAKCiAgICA6cmV0dXJuczogVHlwaWNhbGx5IHRoaXMgcmV0dXJucyBhIGJ5dGUgc3RyaW5nLiAgSWYgYSBub25zdHJpbmcgb2JqZWN0IGlzCiAgICAgICAgcGFzc2VkIGluIHRoaXMgbWF5IGJlIGEgZGlmZmVyZW50IHR5cGUgZGVwZW5kaW5nIG9uIHRoZSBzdHJhdGVneQogICAgICAgIHNwZWNpZmllZCBieSBub25zdHJpbmcuICBUaGlzIHdpbGwgbmV2ZXIgcmV0dXJuIGEgdGV4dCBzdHJpbmcuCgogICAgLi4gbm90ZTo6IElmIHBhc3NlZCBhIGJ5dGUgc3RyaW5nLCB0aGlzIGZ1bmN0aW9uIGRvZXMgbm90IGNoZWNrIHRoYXQgdGhlCiAgICAgICAgc3RyaW5nIGlzIHZhbGlkIGluIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcuICBJZiBpdCdzIGltcG9ydGFudCB0aGF0IHRoZQogICAgICAgIGJ5dGUgc3RyaW5nIGlzIGluIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcgZG86OgoKICAgICAgICAgICAgZW5jb2RlZF9zdHJpbmcgPSB0b19ieXRlcyh0b190ZXh0KGlucHV0X3N0cmluZywgJ2xhdGluLTEnKSwgJ3V0Zi04JykKCiAgICAuLiB2ZXJzaW9uX2NoYW5nZWQ6OiAyLjMKCiAgICAgICAgQWRkZWQgdGhlIGBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWBgIGVycm9yIGhhbmRsZXIgYW5kIG1hZGUgaXQgdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlci4KICAgICIiIgogICAgaWYgaXNpbnN0YW5jZShvYmosIGJpbmFyeV90eXBlKToKICAgICAgICByZXR1cm4gb2JqCgogICAgIyBXZSdyZSBnaXZlbiBhIHRleHQgc3RyaW5nCiAgICAjIElmIGl0IGhhcyBzdXJyb2dhdGVzLCB3ZSBrbm93IGJlY2F1c2UgaXQgd2lsbCBkZWNvZGUKICAgIG9yaWdpbmFsX2Vycm9ycyA9IGVycm9ycwogICAgaWYgZXJyb3JzIGluIF9DT01QT1NFRF9FUlJPUl9IQU5ETEVSUzoKICAgICAgICBpZiBIQVNfU1VSUk9HQVRFRVNDQVBFOgogICAgICAgICAgICBlcnJvcnMgPSAnc3Vycm9nYXRlZXNjYXBlJwogICAgICAgIGVsaWYgZXJyb3JzID09ICdzdXJyb2dhdGVfb3Jfc3RyaWN0JzoKICAgICAgICAgICAgZXJyb3JzID0gJ3N0cmljdCcKICAgICAgICBlbHNlOgogICAgICAgICAgICBlcnJvcnMgPSAncmVwbGFjZScKCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgdGV4dF90eXBlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVHJ5IHRoaXMgZmlyc3QgYXMgaXQncyB0aGUgZmFzdGVzdAogICAgICAgICAgICByZXR1cm4gb2JqLmVuY29kZShlbmNvZGluZywgZXJyb3JzKQogICAgICAgIGV4Y2VwdCBVbmljb2RlRW5jb2RlRXJyb3I6CiAgICAgICAgICAgIGlmIG9yaWdpbmFsX2Vycm9ycyBpbiAoTm9uZSwgJ3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKToKICAgICAgICAgICAgICAgICMgU2xvdyBidXQgd29ya3MKICAgICAgICAgICAgICAgIHJldHVybl9zdHJpbmcgPSBvYmouZW5jb2RlKCd1dGYtOCcsICdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICAgICAgICAgcmV0dXJuX3N0cmluZyA9IHJldHVybl9zdHJpbmcuZGVjb2RlKCd1dGYtOCcsICdyZXBsYWNlJykKICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5fc3RyaW5nLmVuY29kZShlbmNvZGluZywgJ3JlcGxhY2UnKQogICAgICAgICAgICByYWlzZQoKICAgICMgTm90ZTogV2UgZG8gdGhlc2UgbGFzdCBldmVuIHRob3VnaCB3ZSBoYXZlIHRvIGNhbGwgdG9fYnl0ZXMgYWdhaW4gb24gdGhlCiAgICAjIHZhbHVlIGJlY2F1c2Ugd2UncmUgb3B0aW1pemluZyB0aGUgY29tbW9uIGNhc2UKICAgIGlmIG5vbnN0cmluZyA9PSAnc2ltcGxlcmVwcic6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWx1ZSA9IHN0cihvYmopCiAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdmFsdWUgPSByZXByKG9iaikKICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgICMgR2l2aW5nIHVwCiAgICAgICAgICAgICAgICByZXR1cm4gdG9fYnl0ZXMoJycpCiAgICBlbGlmIG5vbnN0cmluZyA9PSAncGFzc3RocnUnOgogICAgICAgIHJldHVybiBvYmoKICAgIGVsaWYgbm9uc3RyaW5nID09ICdlbXB0eSc6CiAgICAgICAgIyBweXRob24yLjQgZG9lc24ndCBoYXZlIGInJwogICAgICAgIHJldHVybiB0b19ieXRlcygnJykKICAgIGVsaWYgbm9uc3RyaW5nID09ICdzdHJpY3QnOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignb2JqIG11c3QgYmUgYSBzdHJpbmcgdHlwZScpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignSW52YWxpZCB2YWx1ZSAlcyBmb3IgdG9fYnl0ZXNcJyBub25zdHJpbmcgcGFyYW1ldGVyJyAlIG5vbnN0cmluZykKCiAgICByZXR1cm4gdG9fYnl0ZXModmFsdWUsIGVuY29kaW5nLCBlcnJvcnMpCgoKZGVmIHRvX3RleHQob2JqLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9Tm9uZSwgbm9uc3RyaW5nPSdzaW1wbGVyZXByJyk6CiAgICAiIiJNYWtlIHN1cmUgdGhhdCBhIHN0cmluZyBpcyBhIHRleHQgc3RyaW5nCgogICAgOmFyZyBvYmo6IEFuIG9iamVjdCB0byBtYWtlIHN1cmUgaXMgYSB0ZXh0IHN0cmluZy4gIEluIG1vc3QgY2FzZXMgdGhpcwogICAgICAgIHdpbGwgYmUgZWl0aGVyIGEgdGV4dCBzdHJpbmcgb3IgYSBieXRlIHN0cmluZy4gIEhvd2V2ZXIsIHdpdGgKICAgICAgICBgYG5vbnN0cmluZz0nc2ltcGxlcmVwcidgYCwgdGhpcyBjYW4gYmUgdXNlZCBhcyBhIHRyYWNlYmFjay1mcmVlCiAgICAgICAgdmVyc2lvbiBvZiBgYHN0cihvYmopYGAuCiAgICA6a3dhcmcgZW5jb2Rpbmc6IFRoZSBlbmNvZGluZyB0byB1c2UgdG8gdHJhbnNmb3JtIGZyb20gYSBieXRlIHN0cmluZyB0bwogICAgICAgIGEgdGV4dCBzdHJpbmcuICBEZWZhdWx0cyB0byB1c2luZyAndXRmLTgnLgogICAgOmt3YXJnIGVycm9yczogVGhlIGVycm9yIGhhbmRsZXIgdG8gdXNlIGlmIHRoZSBieXRlIHN0cmluZyBpcyBub3QKICAgICAgICBkZWNvZGFibGUgdXNpbmcgdGhlIHNwZWNpZmllZCBlbmNvZGluZy4gIEFueSB2YWxpZCBgY29kZWNzIGVycm9yCiAgICAgICAgaGFuZGxlciA8aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMi9saWJyYXJ5L2NvZGVjcy5odG1sI2NvZGVjLWJhc2UtY2xhc3Nlcz5gXwogICAgICAgIG1heSBiZSBzcGVjaWZpZWQuICAgV2Ugc3VwcG9ydCB0aHJlZSBhZGRpdGlvbmFsIGVycm9yIHN0cmF0ZWdpZXMKICAgICAgICBzcGVjaWZpY2FsbHkgYWltZWQgYXQgaGVscGluZyBwZW9wbGUgdG8gcG9ydCBjb2RlOgoKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9zdHJpY3Q6IFdpbGwgdXNlIHN1cnJvZ2F0ZWVzY2FwZSBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLCBvdGhlcndpc2UgaXQgd2lsbCB1c2Ugc3RyaWN0CiAgICAgICAgICAgIDpzdXJyb2dhdGVfb3JfcmVwbGFjZTogV2lsbCB1c2Ugc3Vycm9nYXRlZXNjYXBlIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSByZXBsYWNlLgogICAgICAgICAgICA6c3Vycm9nYXRlX3RoZW5fcmVwbGFjZTogRG9lcyB0aGUgc2FtZSBhcyBzdXJyb2dhdGVfb3JfcmVwbGFjZSBidXQKICAgICAgICAgICAgICAgIGB3YXMgYWRkZWQgZm9yIHN5bW1ldHJ5IHdpdGggdGhlIGVycm9yIGhhbmRsZXJzIGluCiAgICAgICAgICAgICAgICA6ZnVuYzpgYW5zaWJsZS5tb2R1bGVfdXRpbHMuX3RleHQudG9fYnl0ZXNgIChBZGRlZCBpbiBBbnNpYmxlIDIuMykKCiAgICAgICAgQmVjYXVzZSBzdXJyb2dhdGVlc2NhcGUgd2FzIGFkZGVkIGluIFB5dGhvbjMgdGhpcyB1c3VhbGx5IG1lYW5zIHRoYXQKICAgICAgICBQeXRob24zIHdpbGwgdXNlIGBzdXJyb2dhdGVlc2NhcGVgIGFuZCBQeXRob24yIHdpbGwgdXNlIHRoZSBmYWxsYmFjawogICAgICAgIGVycm9yIGhhbmRsZXIuIE5vdGUgdGhhdCB0aGUgY29kZSBjaGVja3MgZm9yIHN1cnJvZ2F0ZWVzY2FwZSB3aGVuIHRoZQogICAgICAgIG1vZHVsZSBpcyBpbXBvcnRlZC4gIElmIHlvdSBoYXZlIGEgYmFja3BvcnQgb2YgYHN1cnJvZ2F0ZWVzY2FwZWAgZm9yCiAgICAgICAgcHl0aG9uMiwgYmUgc3VyZSB0byByZWdpc3RlciB0aGUgZXJyb3IgaGFuZGxlciBwcmlvciB0byBpbXBvcnRpbmcgdGhpcwogICAgICAgIG1vZHVsZS4KCiAgICAgICAgVGhlIGRlZmF1bHQgdW50aWwgQW5zaWJsZS0yLjIgd2FzIGBzdXJyb2dhdGVfb3JfcmVwbGFjZWAKICAgICAgICBJbiBBbnNpYmxlLTIuMyB0aGlzIGRlZmF1bHRzIHRvIGBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlYCBmb3Igc3ltbWV0cnkKICAgICAgICB3aXRoIDpmdW5jOmBhbnNpYmxlLm1vZHVsZV91dGlscy5fdGV4dC50b19ieXRlc2AgLgogICAgOmt3YXJnIG5vbnN0cmluZzogVGhlIHN0cmF0ZWd5IHRvIHVzZSBpZiBhIG5vbnN0cmluZyBpcyBzcGVjaWZpZWQgaW4KICAgICAgICBgYG9iamBgLiAgRGVmYXVsdCBpcyAnc2ltcGxlcmVwcicuICBWYWxpZCB2YWx1ZXMgYXJlOgoKICAgICAgICA6c2ltcGxlcmVwcjogVGhlIGRlZmF1bHQuICBUaGlzIHRha2VzIHRoZSBgYHN0cmBgIG9mIHRoZSBvYmplY3QgYW5kCiAgICAgICAgICAgIHRoZW4gcmV0dXJucyB0aGUgdGV4dCB2ZXJzaW9uIG9mIHRoYXQgc3RyaW5nLgogICAgICAgIDplbXB0eTogUmV0dXJuIGFuIGVtcHR5IHRleHQgc3RyaW5nCiAgICAgICAgOnBhc3N0aHJ1OiBSZXR1cm4gdGhlIG9iamVjdCBwYXNzZWQgaW4KICAgICAgICA6c3RyaWN0OiBSYWlzZSBhIDpleGM6YFR5cGVFcnJvcmAKCiAgICA6cmV0dXJuczogVHlwaWNhbGx5IHRoaXMgcmV0dXJucyBhIHRleHQgc3RyaW5nLiAgSWYgYSBub25zdHJpbmcgb2JqZWN0IGlzCiAgICAgICAgcGFzc2VkIGluIHRoaXMgbWF5IGJlIGEgZGlmZmVyZW50IHR5cGUgZGVwZW5kaW5nIG9uIHRoZSBzdHJhdGVneQogICAgICAgIHNwZWNpZmllZCBieSBub25zdHJpbmcuICBUaGlzIHdpbGwgbmV2ZXIgcmV0dXJuIGEgYnl0ZSBzdHJpbmcuCiAgICAgICAgRnJvbSBBbnNpYmxlLTIuMyBvbndhcmRzLCB0aGUgZGVmYXVsdCBpcyBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWAuCgogICAgLi4gdmVyc2lvbl9jaGFuZ2VkOjogMi4zCgogICAgICAgIEFkZGVkIHRoZSBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlIGVycm9yIGhhbmRsZXIgYW5kIG1hZGUgaXQgdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlci4KICAgICIiIgogICAgaWYgaXNpbnN0YW5jZShvYmosIHRleHRfdHlwZSk6CiAgICAgICAgcmV0dXJuIG9iagoKICAgIGlmIGVycm9ycyBpbiBfQ09NUE9TRURfRVJST1JfSEFORExFUlM6CiAgICAgICAgaWYgSEFTX1NVUlJPR0FURUVTQ0FQRToKICAgICAgICAgICAgZXJyb3JzID0gJ3N1cnJvZ2F0ZWVzY2FwZScKICAgICAgICBlbGlmIGVycm9ycyA9PSAnc3Vycm9nYXRlX29yX3N0cmljdCc6CiAgICAgICAgICAgIGVycm9ycyA9ICdzdHJpY3QnCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZXJyb3JzID0gJ3JlcGxhY2UnCgogICAgaWYgaXNpbnN0YW5jZShvYmosIGJpbmFyeV90eXBlKToKICAgICAgICAjIE5vdGU6IFdlIGRvbid0IG5lZWQgc3BlY2lhbCBoYW5kbGluZyBmb3Igc3Vycm9nYXRlX3RoZW5fcmVwbGFjZQogICAgICAgICMgYmVjYXVzZSBhbGwgYnl0ZXMgd2lsbCBlaXRoZXIgYmUgbWFkZSBpbnRvIHN1cnJvZ2F0ZXMgb3IgYXJlIHZhbGlkCiAgICAgICAgIyB0byBkZWNvZGUuCiAgICAgICAgcmV0dXJuIG9iai5kZWNvZGUoZW5jb2RpbmcsIGVycm9ycykKCiAgICAjIE5vdGU6IFdlIGRvIHRoZXNlIGxhc3QgZXZlbiB0aG91Z2ggd2UgaGF2ZSB0byBjYWxsIHRvX3RleHQgYWdhaW4gb24gdGhlCiAgICAjIHZhbHVlIGJlY2F1c2Ugd2UncmUgb3B0aW1pemluZyB0aGUgY29tbW9uIGNhc2UKICAgIGlmIG5vbnN0cmluZyA9PSAnc2ltcGxlcmVwcic6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWx1ZSA9IHN0cihvYmopCiAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdmFsdWUgPSByZXByKG9iaikKICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgICMgR2l2aW5nIHVwCiAgICAgICAgICAgICAgICByZXR1cm4gdScnCiAgICBlbGlmIG5vbnN0cmluZyA9PSAncGFzc3RocnUnOgogICAgICAgIHJldHVybiBvYmoKICAgIGVsaWYgbm9uc3RyaW5nID09ICdlbXB0eSc6CiAgICAgICAgcmV0dXJuIHUnJwogICAgZWxpZiBub25zdHJpbmcgPT0gJ3N0cmljdCc6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdvYmogbXVzdCBiZSBhIHN0cmluZyB0eXBlJykKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdJbnZhbGlkIHZhbHVlICVzIGZvciB0b190ZXh0XCdzIG5vbnN0cmluZyBwYXJhbWV0ZXInICUgbm9uc3RyaW5nKQoKICAgIHJldHVybiB0b190ZXh0KHZhbHVlLCBlbmNvZGluZywgZXJyb3JzKQoKCiM6IDpweTpmdW5jOmB0b19uYXRpdmVgCiM6ICAgICAgVHJhbnNmb3JtIGEgdmFyaWFibGUgaW50byB0aGUgbmF0aXZlIHN0ciB0eXBlIGZvciB0aGUgcHl0aG9uIHZlcnNpb24KIzoKIzogICAgICBPbiBQeXRob24yLCB0aGlzIGlzIGFuIGFsaWFzIGZvcgojOiAgICAgIDpmdW5jOmB+YW5zaWJsZS5tb2R1bGVfdXRpbHMudG9fYnl0ZXNgLiAgT24gUHl0aG9uMyBpdCBpcyBhbiBhbGlhcyBmb3IKIzogICAgICA6ZnVuYzpgfmFuc2libGUubW9kdWxlX3V0aWxzLnRvX3RleHRgLiAgSXQgbWFrZXMgaXQgZWFzaWVyIHRvCiM6ICAgICAgdHJhbnNmb3JtIGEgdmFyaWFibGUgaW50byB0aGUgbmF0aXZlIHN0ciB0eXBlIGZvciB0aGUgcHl0aG9uIHZlcnNpb24KIzogICAgICB0aGUgY29kZSBpcyBydW5uaW5nIG9uLiAgVXNlIHRoaXMgd2hlbiBjb25zdHJ1Y3RpbmcgdGhlIG1lc3NhZ2UgdG8KIzogICAgICBzZW5kIHRvIGV4Y2VwdGlvbnMgb3Igd2hlbiBkZWFsaW5nIHdpdGggYW4gQVBJIHRoYXQgbmVlZHMgdG8gdGFrZQojOiAgICAgIGEgbmF0aXZlIHN0cmluZy4gIEV4YW1wbGU6OgojOgojOiAgICAgICAgICB0cnk6CiM6ICAgICAgICAgICAgICAxLy8wCiM6ICAgICAgICAgIGV4Y2VwdCBaZXJvRGl2aXNpb25FcnJvciBhcyBlOgojOiAgICAgICAgICAgICAgcmFpc2UgTXlFeGNlcHRpb24oJ0VuY291bnRlcmVkIGFuZCBlcnJvcjogJXMnICUgdG9fbmF0aXZlKGUpKQppZiBQWTM6CiAgICB0b19uYXRpdmUgPSB0b190ZXh0CmVsc2U6CiAgICB0b19uYXRpdmUgPSB0b19ieXRlcwpQSwMEFAAAAAAAy7srSyXctH4TEAAAExAAACIAAABhbnNpYmxlL21vZHVsZV91dGlscy9weWNvbXBhdDI0LnB5IyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojIFRoaXMgcGFydGljdWxhciBmaWxlIHNuaXBwZXQsIGFuZCB0aGlzIGZpbGUgc25pcHBldCBvbmx5LCBpcyBCU0QgbGljZW5zZWQuCiMgTW9kdWxlcyB5b3Ugd3JpdGUgdXNpbmcgdGhpcyBzbmlwcGV0LCB3aGljaCBpcyBlbWJlZGRlZCBkeW5hbWljYWxseSBieSBBbnNpYmxlCiMgc3RpbGwgYmVsb25nIHRvIHRoZSBhdXRob3Igb2YgdGhlIG1vZHVsZSwgYW5kIG1heSBhc3NpZ24gdGhlaXIgb3duIGxpY2Vuc2UKIyB0byB0aGUgY29tcGxldGUgd29yay4KIwojIENvcHlyaWdodCAoYykgMjAxNiwgVG9zaGlvIEt1cmF0b21pIDx0a3VyYXRvbWlAYW5zaWJsZS5jb20+CiMgQ29weXJpZ2h0IChjKSAyMDE1LCBNYXJpdXMgR2VkbWluYXMKIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dCBtb2RpZmljYXRpb24sCiMgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAojICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5ECiMgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRUQKIyBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuCiMgSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsCiMgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLAojIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUwojIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QKIyBMSUFCSUxJVFksIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUKIyBVU0UgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwoKaW1wb3J0IHN5cwoKZGVmIGdldF9leGNlcHRpb24oKToKICAgICIiIkdldCB0aGUgY3VycmVudCBleGNlcHRpb24uCgogICAgVGhpcyBjb2RlIG5lZWRzIHRvIHdvcmsgb24gUHl0aG9uIDIuNCB0aHJvdWdoIDMueCwgc28gd2UgY2Fubm90IHVzZQogICAgImV4Y2VwdCBFeGNlcHRpb24sIGU6IiAoU3ludGF4RXJyb3Igb24gUHl0aG9uIDMueCkgbm9yCiAgICAiZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOiIgKFN5bnRheEVycm9yIG9uIFB5dGhvbiAyLjQtMi41KS4KICAgIEluc3RlYWQgd2UgbXVzdCB1c2UgOjoKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQoKICAgICIiIgogICAgcmV0dXJuIHN5cy5leGNfaW5mbygpWzFdCgp0cnk6CiAgICAjIFB5dGhvbiAyLjYrCiAgICBmcm9tIGFzdCBpbXBvcnQgbGl0ZXJhbF9ldmFsCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICMgYSByZXBsYWNlbWVudCBmb3IgbGl0ZXJhbF9ldmFsIHRoYXQgd29ya3Mgd2l0aCBweXRob24gMi40LiBmcm9tOgogICAgIyBodHRwczovL21haWwucHl0aG9uLm9yZy9waXBlcm1haWwvcHl0aG9uLWxpc3QvMjAwOS1TZXB0ZW1iZXIvNTUxODgwLmh0bWwKICAgICMgd2hpY2ggaXMgZXNzZW50aWFsbHkgYSBjdXQvcGFzdGUgZnJvbSBhbiBlYXJsaWVyICgyLjYpIHZlcnNpb24gb2YgcHl0aG9uJ3MKICAgICMgYXN0LnB5CiAgICBmcm9tIGNvbXBpbGVyIGltcG9ydCBhc3QsIHBhcnNlCiAgICBmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeCBpbXBvcnQgYmluYXJ5X3R5cGUsIHN0cmluZ190eXBlcywgdGV4dF90eXBlCgogICAgZGVmIGxpdGVyYWxfZXZhbChub2RlX29yX3N0cmluZyk6CiAgICAgICAgIiIiCiAgICAgICAgU2FmZWx5IGV2YWx1YXRlIGFuIGV4cHJlc3Npb24gbm9kZSBvciBhIHN0cmluZyBjb250YWluaW5nIGEgUHl0aG9uCiAgICAgICAgZXhwcmVzc2lvbi4gIFRoZSBzdHJpbmcgb3Igbm9kZSBwcm92aWRlZCBtYXkgb25seSBjb25zaXN0IG9mIHRoZSAgZm9sbG93aW5nCiAgICAgICAgUHl0aG9uIGxpdGVyYWwgc3RydWN0dXJlczogc3RyaW5ncywgbnVtYmVycywgdHVwbGVzLCBsaXN0cywgZGljdHMsICBib29sZWFucywKICAgICAgICBhbmQgTm9uZS4KICAgICAgICAiIiIKICAgICAgICBfc2FmZV9uYW1lcyA9IHsnTm9uZSc6IE5vbmUsICdUcnVlJzogVHJ1ZSwgJ0ZhbHNlJzogRmFsc2V9CiAgICAgICAgaWYgaXNpbnN0YW5jZShub2RlX29yX3N0cmluZywgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgbm9kZV9vcl9zdHJpbmcgPSBwYXJzZShub2RlX29yX3N0cmluZywgbW9kZT0nZXZhbCcpCiAgICAgICAgaWYgaXNpbnN0YW5jZShub2RlX29yX3N0cmluZywgYXN0LkV4cHJlc3Npb24pOgogICAgICAgICAgICBub2RlX29yX3N0cmluZyA9IG5vZGVfb3Jfc3RyaW5nLm5vZGUKCiAgICAgICAgZGVmIF9jb252ZXJ0KG5vZGUpOgogICAgICAgICAgICAjIE9rYXkgdG8gdXNlIGxvbmcgaGVyZSBiZWNhdXNlIHRoaXMgaXMgb25seSBmb3IgcHl0aG9uIDIuNCBhbmQgMi41CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0LkNvbnN0KSBhbmQgaXNpbnN0YW5jZShub2RlLnZhbHVlLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSwgaW50LCBmbG9hdCwgbG9uZywgY29tcGxleCkpOgogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUudmFsdWUKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5UdXBsZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gdHVwbGUobWFwKF9jb252ZXJ0LCBub2RlLm5vZGVzKSkKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5MaXN0KToKICAgICAgICAgICAgICAgIHJldHVybiBsaXN0KG1hcChfY29udmVydCwgbm9kZS5ub2RlcykpCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuRGljdCk6CiAgICAgICAgICAgICAgICByZXR1cm4gZGljdCgoX2NvbnZlcnQoayksIF9jb252ZXJ0KHYpKSBmb3IgaywgdiBpbiBub2RlLml0ZW1zKCkpCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuTmFtZSk6CiAgICAgICAgICAgICAgICBpZiBub2RlLm5hbWUgaW4gX3NhZmVfbmFtZXM6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9zYWZlX25hbWVzW25vZGUubmFtZV0KICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5VbmFyeVN1Yik6CiAgICAgICAgICAgICAgICByZXR1cm4gLV9jb252ZXJ0KG5vZGUuZXhwcikKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignbWFsZm9ybWVkIHN0cmluZycpCiAgICAgICAgcmV0dXJuIF9jb252ZXJ0KG5vZGVfb3Jfc3RyaW5nKQoKX19hbGxfXyA9ICgnZ2V0X2V4Y2VwdGlvbicsICdsaXRlcmFsX2V2YWwnKQpQSwMEFAAAAAAAy7srSxgXcvUBEQAAAREAACQAAABhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX19pbml0X18ucHkjIFRoaXMgY29kZSBpcyBwYXJ0IG9mIEFuc2libGUsIGJ1dCBpcyBhbiBpbmRlcGVuZGVudCBjb21wb25lbnQuCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgQ29weXJpZ2h0IChjKSAyMDE3LCBUb3NoaW8gS3VyYXRvbWkgPHRrdXJhdG9taUBhbnNpYmxlLmNvbT4KIwojIFRoaXMgY29kZSBpcyBiYXNlZCBvbiBjb2RlIGZyb20gQXN0cm9weSBhbmQgcmV0YWlucyB0aGVpciAzLWNsYXVzZSBCU0QgbGljZW5zZQojIHJlcHJvZHVjZWQgYmVsb3c6CiMKIyBDb3B5cmlnaHQgKGMpIDIwMTEtMjAxNiwgQXN0cm9weSBEZXZlbG9wZXJzCiMKIyBBbGwgcmlnaHRzIHJlc2VydmVkLgojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0CiMgbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwgdGhpcwojICAgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIyAqIE5laXRoZXIgdGhlIG5hbWUgb2YgdGhlIEFzdHJvcHkgVGVhbSBub3IgdGhlIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5CiMgICBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0cyBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0CiMgICBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIKIyBBTkQgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFCiMgSU1QTElFRCBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFCiMgRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRQojIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMCiMgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IKIyBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUgojIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksCiMgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UKIyBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCiMgQXN0cm9weSBMaWNlbnNlOiBodHRwczovL2dpdGh1Yi5jb20vYXN0cm9weS9hc3Ryb3B5L2Jsb2IvY2YzMjY1ZTQyYTBkYjhlMDBiYjkwNjQ0ZGIzN2M4MTUwZjVhYzAwYy9saWNlbnNlcy9MSUNFTlNFLnJzdAojIEFzdHJvcHkgQ29kZTogaHR0cHM6Ly9naXRodWIuY29tL2FzdHJvcHkvYXN0cm9weS9ibG9iL2NmMzI2NWU0MmEwZGI4ZTAwYmI5MDY0NGRiMzdjODE1MGY1YWMwMGMvYXN0cm9weS9leHRlcm4vc2l4LnB5CgoiIiIKSGFuZGxlIGxvYWRpbmcgc2l4IHBhY2thZ2UgZnJvbSBzeXN0ZW0gb3IgZnJvbSB0aGUgYnVuZGxlZCBjb3B5CiIiIgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IGFic29sdXRlX2ltcG9ydAoKaW1wb3J0IGltcCBhcyBfaW1wCmltcG9ydCBzeXMgYXMgX3N5cwoKdHJ5OgogICAgZnJvbSBkaXN0dXRpbHMudmVyc2lvbiBpbXBvcnQgTG9vc2VWZXJzaW9uIGFzIF9Mb29zZVZlcnNpb24KZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyBTb21lIHBsYXRmb3JtcyAqY291Z2gqU29sYXJpcypjb3VnaCogZG9uJ3Qgc2hpcCB0aGUgd2hvbGUgc3RkbGliCiAgICBfTG9vc2VWZXJzaW9uID0gTm9uZQoKdHJ5OgogICAgaW1wb3J0IHNpeCBhcyBfc3lzdGVtX3NpeApleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBfc3lzdGVtX3NpeCA9IE5vbmUKCmZyb20gLiBpbXBvcnQgX3NpeCBhcyBfYnVuZGxlZF9zaXgKCgpkZWYgX2ZpbmRfbW9kdWxlKG5hbWUsIHBhdGg9Tm9uZSk6CiAgICAiIiJBbHRlcm5hdGl2ZSB0byBgaW1wLmZpbmRfbW9kdWxlYCB0aGF0IGNhbiBhbHNvIHNlYXJjaCBpbiBzdWJwYWNrYWdlcyIiIgogICAgcGFydHMgPSBuYW1lLnNwbGl0KCcuJykKCiAgICBmb3IgcGFydCBpbiBwYXJ0czoKICAgICAgICBpZiBwYXRoIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwYXRoID0gW3BhdGhdCiAgICAgICAgZmgsIHBhdGgsIGRlc2NyID0gX2ltcC5maW5kX21vZHVsZShwYXJ0LCBwYXRoKQogICAgcmV0dXJuIGZoLCBwYXRoLCBkZXNjcgoKCmRlZiBfZ2V0X2J1bmRsZWRfc2l4X3NvdXJjZSgpOgogICAgIyBTcGVjaWFsIGltcG9ydCBsb2FkZXIgKHppcGltcG9ydCBmb3IgaW5zdGFuY2UpCiAgICBmb3VuZCA9IEZhbHNlCiAgICBmb3IgcGF0aCBpbiBfc3lzLnBhdGg6CiAgICAgICAgaW1wb3J0ZXIgPSBfc3lzLnBhdGhfaW1wb3J0ZXJfY2FjaGUuZ2V0KHBhdGgpCiAgICAgICAgaWYgaW1wb3J0ZXI6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZvdW5kID0gaW1wb3J0ZXIuZmluZF9tb2R1bGUoJ2Fuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fc2l4JykKICAgICAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgZm91bmQ6CiAgICAgICAgICAgICAgICBicmVhawogICAgZWxzZToKICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigiQ291bGQgbm90IGZpbmQgYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Ll9zaXgiKQoKICAgIG1vZHVsZV9zb3VyY2UgPSBpbXBvcnRlci5nZXRfc291cmNlKCdhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeCcpCiAgICByZXR1cm4gbW9kdWxlX3NvdXJjZQoKCmRlZiBfZ2V0X3NpeF9zb3VyY2UoKToKICAgICIiIkltcG9ydCB0aGUgbmV3ZXN0IHZlcnNpb24gb2YgdGhlIHNpeCBsaWJyYXJ5IHRoYXQncyBhdmFpbGFibGUiIiIKICAgIG1vZF9pbmZvID0gTm9uZQogICAgdHJ5OgogICAgICAgIGlmIF9zeXN0ZW1fc2l4IGFuZCBfTG9vc2VWZXJzaW9uIGFuZCBcCiAgICAgICAgICAgICAgICBfTG9vc2VWZXJzaW9uKF9zeXN0ZW1fc2l4Ll9fdmVyc2lvbl9fKSA+PSBfTG9vc2VWZXJzaW9uKF9idW5kbGVkX3NpeC5fX3ZlcnNpb25fXyk6CiAgICAgICAgICAgIG1vZF9pbmZvID0gX2ZpbmRfbW9kdWxlKCdzaXgnKQogICAgZXhjZXB0OgogICAgICAgICMgQW55IGVycm9ycyBmaW5kaW5nIHRoZSBzeXN0ZW0gbGlicmFyeSwgdXNlIG91ciBidW5kbGVkIGxpYiBpbnN0ZWFkCiAgICAgICAgcGFzcwoKICAgIGlmIG5vdCBtb2RfaW5mbzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIG1vZF9pbmZvID0gX2ZpbmRfbW9kdWxlKCdhbnNpYmxlLm1vZHVsZV91dGlscy5zaXguX3NpeCcpCiAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICAjIHppcGltcG9ydAogICAgICAgICAgICBtb2R1bGVfc291cmNlID0gX2dldF9idW5kbGVkX3NpeF9zb3VyY2UoKQogICAgICAgICAgICByZXR1cm4gbW9kdWxlX3NvdXJjZQoKICAgIHJldHVybiBtb2RfaW5mb1swXS5yZWFkKCkKCnNvdXJjZSA9IF9nZXRfc2l4X3NvdXJjZSgpCmV4ZWMoc291cmNlKQpQSwMEFAAAAAAAy7srSzjix9GRdQAAkXUAACAAAABhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeC5weSIiIlV0aWxpdGllcyBmb3Igd3JpdGluZyBjb2RlIHRoYXQgcnVucyBvbiBQeXRob24gMiBhbmQgMyIiIgoKIyBDb3B5cmlnaHQgKGMpIDIwMTAtMjAxNSBCZW5qYW1pbiBQZXRlcnNvbgojCiMgUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQojIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiMgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwojIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKIyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKIyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgojCiMgVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCiMgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KIwojIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiMgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiMgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiMgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgojIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiMgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKIyBTT0ZUV0FSRS4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgYWJzb2x1dGVfaW1wb3J0CgppbXBvcnQgZnVuY3Rvb2xzCmltcG9ydCBpdGVydG9vbHMKaW1wb3J0IG9wZXJhdG9yCmltcG9ydCBzeXMKaW1wb3J0IHR5cGVzCgpfX2F1dGhvcl9fID0gIkJlbmphbWluIFBldGVyc29uIDxiZW5qYW1pbkBweXRob24ub3JnPiIKX192ZXJzaW9uX18gPSAiMS4xMC4wIgoKCiMgVXNlZnVsIGZvciB2ZXJ5IGNvYXJzZSB2ZXJzaW9uIGRpZmZlcmVudGlhdGlvbi4KUFkyID0gc3lzLnZlcnNpb25faW5mb1swXSA9PSAyClBZMyA9IHN5cy52ZXJzaW9uX2luZm9bMF0gPT0gMwpQWTM0ID0gc3lzLnZlcnNpb25faW5mb1swOjJdID49ICgzLCA0KQoKaWYgUFkzOgogICAgc3RyaW5nX3R5cGVzID0gc3RyLAogICAgaW50ZWdlcl90eXBlcyA9IGludCwKICAgIGNsYXNzX3R5cGVzID0gdHlwZSwKICAgIHRleHRfdHlwZSA9IHN0cgogICAgYmluYXJ5X3R5cGUgPSBieXRlcwogICAgTUFYU0laRSA9IHN5cy5tYXhzaXplCmVsc2U6CiAgICBzdHJpbmdfdHlwZXMgPSBiYXNlc3RyaW5nLAogICAgaW50ZWdlcl90eXBlcyA9IChpbnQsIGxvbmcpCiAgICBjbGFzc190eXBlcyA9ICh0eXBlLCB0eXBlcy5DbGFzc1R5cGUpCiAgICB0ZXh0X3R5cGUgPSB1bmljb2RlCiAgICBiaW5hcnlfdHlwZSA9IHN0cgoKICAgIGlmIHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCJqYXZhIik6CiAgICAgICAgIyBKeXRob24gYWx3YXlzIHVzZXMgMzIgYml0cy4KICAgICAgICBNQVhTSVpFID0gaW50KCgxIDw8IDMxKSAtIDEpCiAgICBlbHNlOgogICAgICAgICMgSXQncyBwb3NzaWJsZSB0byBoYXZlIHNpemVvZihsb25nKSAhPSBzaXplb2YoUHlfc3NpemVfdCkuCiAgICAgICAgY2xhc3MgWChvYmplY3QpOgoKICAgICAgICAgICAgZGVmIF9fbGVuX18oc2VsZik6CiAgICAgICAgICAgICAgICByZXR1cm4gMSA8PCAzMQogICAgICAgIHRyeToKICAgICAgICAgICAgbGVuKFgoKSkKICAgICAgICBleGNlcHQgT3ZlcmZsb3dFcnJvcjoKICAgICAgICAgICAgIyAzMi1iaXQKICAgICAgICAgICAgTUFYU0laRSA9IGludCgoMSA8PCAzMSkgLSAxKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgNjQtYml0CiAgICAgICAgICAgIE1BWFNJWkUgPSBpbnQoKDEgPDwgNjMpIC0gMSkKICAgICAgICBkZWwgWAoKCmRlZiBfYWRkX2RvYyhmdW5jLCBkb2MpOgogICAgIiIiQWRkIGRvY3VtZW50YXRpb24gdG8gYSBmdW5jdGlvbi4iIiIKICAgIGZ1bmMuX19kb2NfXyA9IGRvYwoKCmRlZiBfaW1wb3J0X21vZHVsZShuYW1lKToKICAgICIiIkltcG9ydCBtb2R1bGUsIHJldHVybmluZyB0aGUgbW9kdWxlIGFmdGVyIHRoZSBsYXN0IGRvdC4iIiIKICAgIF9faW1wb3J0X18obmFtZSkKICAgIHJldHVybiBzeXMubW9kdWxlc1tuYW1lXQoKCmNsYXNzIF9MYXp5RGVzY3Iob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSk6CiAgICAgICAgc2VsZi5uYW1lID0gbmFtZQoKICAgIGRlZiBfX2dldF9fKHNlbGYsIG9iaiwgdHApOgogICAgICAgIHJlc3VsdCA9IHNlbGYuX3Jlc29sdmUoKQogICAgICAgIHNldGF0dHIob2JqLCBzZWxmLm5hbWUsIHJlc3VsdCkgICMgSW52b2tlcyBfX3NldF9fLgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBUaGlzIGlzIGEgYml0IHVnbHksIGJ1dCBpdCBhdm9pZHMgcnVubmluZyB0aGlzIGFnYWluIGJ5CiAgICAgICAgICAgICMgcmVtb3ZpbmcgdGhpcyBkZXNjcmlwdG9yLgogICAgICAgICAgICBkZWxhdHRyKG9iai5fX2NsYXNzX18sIHNlbGYubmFtZSkKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gcmVzdWx0CgoKY2xhc3MgTW92ZWRNb2R1bGUoX0xhenlEZXNjcik6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUsIG9sZCwgbmV3PU5vbmUpOgogICAgICAgIHN1cGVyKE1vdmVkTW9kdWxlLCBzZWxmKS5fX2luaXRfXyhuYW1lKQogICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgaWYgbmV3IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBuZXcgPSBuYW1lCiAgICAgICAgICAgIHNlbGYubW9kID0gbmV3CiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5tb2QgPSBvbGQKCiAgICBkZWYgX3Jlc29sdmUoc2VsZik6CiAgICAgICAgcmV0dXJuIF9pbXBvcnRfbW9kdWxlKHNlbGYubW9kKQoKICAgIGRlZiBfX2dldGF0dHJfXyhzZWxmLCBhdHRyKToKICAgICAgICBfbW9kdWxlID0gc2VsZi5fcmVzb2x2ZSgpCiAgICAgICAgdmFsdWUgPSBnZXRhdHRyKF9tb2R1bGUsIGF0dHIpCiAgICAgICAgc2V0YXR0cihzZWxmLCBhdHRyLCB2YWx1ZSkKICAgICAgICByZXR1cm4gdmFsdWUKCgpjbGFzcyBfTGF6eU1vZHVsZSh0eXBlcy5Nb2R1bGVUeXBlKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSk6CiAgICAgICAgc3VwZXIoX0xhenlNb2R1bGUsIHNlbGYpLl9faW5pdF9fKG5hbWUpCiAgICAgICAgc2VsZi5fX2RvY19fID0gc2VsZi5fX2NsYXNzX18uX19kb2NfXwoKICAgIGRlZiBfX2Rpcl9fKHNlbGYpOgogICAgICAgIGF0dHJzID0gWyJfX2RvY19fIiwgIl9fbmFtZV9fIl0KICAgICAgICBhdHRycyArPSBbYXR0ci5uYW1lIGZvciBhdHRyIGluIHNlbGYuX21vdmVkX2F0dHJpYnV0ZXNdCiAgICAgICAgcmV0dXJuIGF0dHJzCgogICAgIyBTdWJjbGFzc2VzIHNob3VsZCBvdmVycmlkZSB0aGlzCiAgICBfbW92ZWRfYXR0cmlidXRlcyA9IFtdCgoKY2xhc3MgTW92ZWRBdHRyaWJ1dGUoX0xhenlEZXNjcik6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUsIG9sZF9tb2QsIG5ld19tb2QsIG9sZF9hdHRyPU5vbmUsIG5ld19hdHRyPU5vbmUpOgogICAgICAgIHN1cGVyKE1vdmVkQXR0cmlidXRlLCBzZWxmKS5fX2luaXRfXyhuYW1lKQogICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgaWYgbmV3X21vZCBpcyBOb25lOgogICAgICAgICAgICAgICAgbmV3X21vZCA9IG5hbWUKICAgICAgICAgICAgc2VsZi5tb2QgPSBuZXdfbW9kCiAgICAgICAgICAgIGlmIG5ld19hdHRyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBpZiBvbGRfYXR0ciBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIG5ld19hdHRyID0gbmFtZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBuZXdfYXR0ciA9IG9sZF9hdHRyCiAgICAgICAgICAgIHNlbGYuYXR0ciA9IG5ld19hdHRyCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5tb2QgPSBvbGRfbW9kCiAgICAgICAgICAgIGlmIG9sZF9hdHRyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBvbGRfYXR0ciA9IG5hbWUKICAgICAgICAgICAgc2VsZi5hdHRyID0gb2xkX2F0dHIKCiAgICBkZWYgX3Jlc29sdmUoc2VsZik6CiAgICAgICAgbW9kdWxlID0gX2ltcG9ydF9tb2R1bGUoc2VsZi5tb2QpCiAgICAgICAgcmV0dXJuIGdldGF0dHIobW9kdWxlLCBzZWxmLmF0dHIpCgoKY2xhc3MgX1NpeE1ldGFQYXRoSW1wb3J0ZXIob2JqZWN0KToKCiAgICAiIiIKICAgIEEgbWV0YSBwYXRoIGltcG9ydGVyIHRvIGltcG9ydCBzaXgubW92ZXMgYW5kIGl0cyBzdWJtb2R1bGVzLgoKICAgIFRoaXMgY2xhc3MgaW1wbGVtZW50cyBhIFBFUDMwMiBmaW5kZXIgYW5kIGxvYWRlci4gSXQgc2hvdWxkIGJlIGNvbXBhdGlibGUKICAgIHdpdGggUHl0aG9uIDIuNSBhbmQgYWxsIGV4aXN0aW5nIHZlcnNpb25zIG9mIFB5dGhvbjMKICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzaXhfbW9kdWxlX25hbWUpOgogICAgICAgIHNlbGYubmFtZSA9IHNpeF9tb2R1bGVfbmFtZQogICAgICAgIHNlbGYua25vd25fbW9kdWxlcyA9IHt9CgogICAgZGVmIF9hZGRfbW9kdWxlKHNlbGYsIG1vZCwgKmZ1bGxuYW1lcyk6CiAgICAgICAgZm9yIGZ1bGxuYW1lIGluIGZ1bGxuYW1lczoKICAgICAgICAgICAgc2VsZi5rbm93bl9tb2R1bGVzW3NlbGYubmFtZSArICIuIiArIGZ1bGxuYW1lXSA9IG1vZAoKICAgIGRlZiBfZ2V0X21vZHVsZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgcmV0dXJuIHNlbGYua25vd25fbW9kdWxlc1tzZWxmLm5hbWUgKyAiLiIgKyBmdWxsbmFtZV0KCiAgICBkZWYgZmluZF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUsIHBhdGg9Tm9uZSk6CiAgICAgICAgaWYgZnVsbG5hbWUgaW4gc2VsZi5rbm93bl9tb2R1bGVzOgogICAgICAgICAgICByZXR1cm4gc2VsZgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9fZ2V0X21vZHVsZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gc2VsZi5rbm93bl9tb2R1bGVzW2Z1bGxuYW1lXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoIlRoaXMgbG9hZGVyIGRvZXMgbm90IGtub3cgbW9kdWxlICIgKyBmdWxsbmFtZSkKCiAgICBkZWYgbG9hZF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBpbiBjYXNlIG9mIGEgcmVsb2FkCiAgICAgICAgICAgIHJldHVybiBzeXMubW9kdWxlc1tmdWxsbmFtZV0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBtb2QgPSBzZWxmLl9fZ2V0X21vZHVsZShmdWxsbmFtZSkKICAgICAgICBpZiBpc2luc3RhbmNlKG1vZCwgTW92ZWRNb2R1bGUpOgogICAgICAgICAgICBtb2QgPSBtb2QuX3Jlc29sdmUoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1vZC5fX2xvYWRlcl9fID0gc2VsZgogICAgICAgIHN5cy5tb2R1bGVzW2Z1bGxuYW1lXSA9IG1vZAogICAgICAgIHJldHVybiBtb2QKCiAgICBkZWYgaXNfcGFja2FnZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgIiIiCiAgICAgICAgUmV0dXJuIHRydWUsIGlmIHRoZSBuYW1lZCBtb2R1bGUgaXMgYSBwYWNrYWdlLgoKICAgICAgICBXZSBuZWVkIHRoaXMgbWV0aG9kIHRvIGdldCBjb3JyZWN0IHNwZWMgb2JqZWN0cyB3aXRoCiAgICAgICAgUHl0aG9uIDMuNCAoc2VlIFBFUDQ1MSkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gaGFzYXR0cihzZWxmLl9fZ2V0X21vZHVsZShmdWxsbmFtZSksICJfX3BhdGhfXyIpCgogICAgZGVmIGdldF9jb2RlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICAiIiJSZXR1cm4gTm9uZQoKICAgICAgICBSZXF1aXJlZCwgaWYgaXNfcGFja2FnZSBpcyBpbXBsZW1lbnRlZCIiIgogICAgICAgIHNlbGYuX19nZXRfbW9kdWxlKGZ1bGxuYW1lKSAgIyBldmVudHVhbGx5IHJhaXNlcyBJbXBvcnRFcnJvcgogICAgICAgIHJldHVybiBOb25lCiAgICBnZXRfc291cmNlID0gZ2V0X2NvZGUgICMgc2FtZSBhcyBnZXRfY29kZQoKX2ltcG9ydGVyID0gX1NpeE1ldGFQYXRoSW1wb3J0ZXIoX19uYW1lX18pCgoKY2xhc3MgX01vdmVkSXRlbXMoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIiIiCiAgICBfX3BhdGhfXyA9IFtdICAjIG1hcmsgYXMgcGFja2FnZQoKCl9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoImNTdHJpbmdJTyIsICJjU3RyaW5nSU8iLCAiaW8iLCAiU3RyaW5nSU8iKSwKICAgIE1vdmVkQXR0cmlidXRlKCJmaWx0ZXIiLCAiaXRlcnRvb2xzIiwgImJ1aWx0aW5zIiwgImlmaWx0ZXIiLCAiZmlsdGVyIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZmlsdGVyZmFsc2UiLCAiaXRlcnRvb2xzIiwgIml0ZXJ0b29scyIsICJpZmlsdGVyZmFsc2UiLCAiZmlsdGVyZmFsc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnB1dCIsICJfX2J1aWx0aW5fXyIsICJidWlsdGlucyIsICJyYXdfaW5wdXQiLCAiaW5wdXQiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnRlcm4iLCAiX19idWlsdGluX18iLCAic3lzIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgibWFwIiwgIml0ZXJ0b29scyIsICJidWlsdGlucyIsICJpbWFwIiwgIm1hcCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldGN3ZCIsICJvcyIsICJvcyIsICJnZXRjd2R1IiwgImdldGN3ZCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldGN3ZGIiLCAib3MiLCAib3MiLCAiZ2V0Y3dkIiwgImdldGN3ZGIiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJyYW5nZSIsICJfX2J1aWx0aW5fXyIsICJidWlsdGlucyIsICJ4cmFuZ2UiLCAicmFuZ2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJyZWxvYWRfbW9kdWxlIiwgIl9fYnVpbHRpbl9fIiwgImltcG9ydGxpYiIgaWYgUFkzNCBlbHNlICJpbXAiLCAicmVsb2FkIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicmVkdWNlIiwgIl9fYnVpbHRpbl9fIiwgImZ1bmN0b29scyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInNobGV4X3F1b3RlIiwgInBpcGVzIiwgInNobGV4IiwgInF1b3RlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiU3RyaW5nSU8iLCAiU3RyaW5nSU8iLCAiaW8iKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVc2VyRGljdCIsICJVc2VyRGljdCIsICJjb2xsZWN0aW9ucyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVzZXJMaXN0IiwgIlVzZXJMaXN0IiwgImNvbGxlY3Rpb25zIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVXNlclN0cmluZyIsICJVc2VyU3RyaW5nIiwgImNvbGxlY3Rpb25zIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgieHJhbmdlIiwgIl9fYnVpbHRpbl9fIiwgImJ1aWx0aW5zIiwgInhyYW5nZSIsICJyYW5nZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInppcCIsICJpdGVydG9vbHMiLCAiYnVpbHRpbnMiLCAiaXppcCIsICJ6aXAiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ6aXBfbG9uZ2VzdCIsICJpdGVydG9vbHMiLCAiaXRlcnRvb2xzIiwgIml6aXBfbG9uZ2VzdCIsICJ6aXBfbG9uZ2VzdCIpLAogICAgTW92ZWRNb2R1bGUoImJ1aWx0aW5zIiwgIl9fYnVpbHRpbl9fIiksCiAgICBNb3ZlZE1vZHVsZSgiY29uZmlncGFyc2VyIiwgIkNvbmZpZ1BhcnNlciIpLAogICAgTW92ZWRNb2R1bGUoImNvcHlyZWciLCAiY29weV9yZWciKSwKICAgIE1vdmVkTW9kdWxlKCJkYm1fZ251IiwgImdkYm0iLCAiZGJtLmdudSIpLAogICAgTW92ZWRNb2R1bGUoIl9kdW1teV90aHJlYWQiLCAiZHVtbXlfdGhyZWFkIiwgIl9kdW1teV90aHJlYWQiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2Nvb2tpZWphciIsICJjb29raWVsaWIiLCAiaHR0cC5jb29raWVqYXIiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2Nvb2tpZXMiLCAiQ29va2llIiwgImh0dHAuY29va2llcyIpLAogICAgTW92ZWRNb2R1bGUoImh0bWxfZW50aXRpZXMiLCAiaHRtbGVudGl0eWRlZnMiLCAiaHRtbC5lbnRpdGllcyIpLAogICAgTW92ZWRNb2R1bGUoImh0bWxfcGFyc2VyIiwgIkhUTUxQYXJzZXIiLCAiaHRtbC5wYXJzZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2NsaWVudCIsICJodHRwbGliIiwgImh0dHAuY2xpZW50IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV9tdWx0aXBhcnQiLCAiZW1haWwuTUlNRU11bHRpcGFydCIsICJlbWFpbC5taW1lLm11bHRpcGFydCIpLAogICAgTW92ZWRNb2R1bGUoImVtYWlsX21pbWVfbm9ubXVsdGlwYXJ0IiwgImVtYWlsLk1JTUVOb25NdWx0aXBhcnQiLCAiZW1haWwubWltZS5ub25tdWx0aXBhcnQiKSwKICAgIE1vdmVkTW9kdWxlKCJlbWFpbF9taW1lX3RleHQiLCAiZW1haWwuTUlNRVRleHQiLCAiZW1haWwubWltZS50ZXh0IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV9iYXNlIiwgImVtYWlsLk1JTUVCYXNlIiwgImVtYWlsLm1pbWUuYmFzZSIpLAogICAgTW92ZWRNb2R1bGUoIkJhc2VIVFRQU2VydmVyIiwgIkJhc2VIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiQ0dJSFRUUFNlcnZlciIsICJDR0lIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiU2ltcGxlSFRUUFNlcnZlciIsICJTaW1wbGVIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiY1BpY2tsZSIsICJjUGlja2xlIiwgInBpY2tsZSIpLAogICAgTW92ZWRNb2R1bGUoInF1ZXVlIiwgIlF1ZXVlIiksCiAgICBNb3ZlZE1vZHVsZSgicmVwcmxpYiIsICJyZXByIiksCiAgICBNb3ZlZE1vZHVsZSgic29ja2V0c2VydmVyIiwgIlNvY2tldFNlcnZlciIpLAogICAgTW92ZWRNb2R1bGUoIl90aHJlYWQiLCAidGhyZWFkIiwgIl90aHJlYWQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyIiwgIlRraW50ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2RpYWxvZyIsICJEaWFsb2ciLCAidGtpbnRlci5kaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2ZpbGVkaWFsb2ciLCAiRmlsZURpYWxvZyIsICJ0a2ludGVyLmZpbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3Njcm9sbGVkdGV4dCIsICJTY3JvbGxlZFRleHQiLCAidGtpbnRlci5zY3JvbGxlZHRleHQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3NpbXBsZWRpYWxvZyIsICJTaW1wbGVEaWFsb2ciLCAidGtpbnRlci5zaW1wbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3RpeCIsICJUaXgiLCAidGtpbnRlci50aXgiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3R0ayIsICJ0dGsiLCAidGtpbnRlci50dGsiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2NvbnN0YW50cyIsICJUa2NvbnN0YW50cyIsICJ0a2ludGVyLmNvbnN0YW50cyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZG5kIiwgIlRrZG5kIiwgInRraW50ZXIuZG5kIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9jb2xvcmNob29zZXIiLCAidGtDb2xvckNob29zZXIiLAogICAgICAgICAgICAgICAgInRraW50ZXIuY29sb3JjaG9vc2VyIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9jb21tb25kaWFsb2ciLCAidGtDb21tb25EaWFsb2ciLAogICAgICAgICAgICAgICAgInRraW50ZXIuY29tbW9uZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl90a2ZpbGVkaWFsb2ciLCAidGtGaWxlRGlhbG9nIiwgInRraW50ZXIuZmlsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZm9udCIsICJ0a0ZvbnQiLCAidGtpbnRlci5mb250IiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9tZXNzYWdlYm94IiwgInRrTWVzc2FnZUJveCIsICJ0a2ludGVyLm1lc3NhZ2Vib3giKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3Rrc2ltcGxlZGlhbG9nIiwgInRrU2ltcGxlRGlhbG9nIiwKICAgICAgICAgICAgICAgICJ0a2ludGVyLnNpbXBsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYl9wYXJzZSIsIF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWJfcGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZE1vZHVsZSgidXJsbGliX2Vycm9yIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYl9lcnJvciIsICJ1cmxsaWIuZXJyb3IiKSwKICAgIE1vdmVkTW9kdWxlKCJ1cmxsaWIiLCBfX25hbWVfXyArICIubW92ZXMudXJsbGliIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYiIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYl9yb2JvdHBhcnNlciIsICJyb2JvdHBhcnNlciIsICJ1cmxsaWIucm9ib3RwYXJzZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJ4bWxycGNfY2xpZW50IiwgInhtbHJwY2xpYiIsICJ4bWxycGMuY2xpZW50IiksCiAgICBNb3ZlZE1vZHVsZSgieG1scnBjX3NlcnZlciIsICJTaW1wbGVYTUxSUENTZXJ2ZXIiLCAieG1scnBjLnNlcnZlciIpLApdCiMgQWRkIHdpbmRvd3Mgc3BlY2lmaWMgbW9kdWxlcy4KaWYgc3lzLnBsYXRmb3JtID09ICJ3aW4zMiI6CiAgICBfbW92ZWRfYXR0cmlidXRlcyArPSBbCiAgICAgICAgTW92ZWRNb2R1bGUoIndpbnJlZyIsICJfd2lucmVnIiksCiAgICBdCgpmb3IgYXR0ciBpbiBfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoX01vdmVkSXRlbXMsIGF0dHIubmFtZSwgYXR0cikKICAgIGlmIGlzaW5zdGFuY2UoYXR0ciwgTW92ZWRNb2R1bGUpOgogICAgICAgIF9pbXBvcnRlci5fYWRkX21vZHVsZShhdHRyLCAibW92ZXMuIiArIGF0dHIubmFtZSkKZGVsIGF0dHIKCl9Nb3ZlZEl0ZW1zLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX21vdmVkX2F0dHJpYnV0ZXMKCm1vdmVzID0gX01vdmVkSXRlbXMoX19uYW1lX18gKyAiLm1vdmVzIikKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKG1vdmVzLCAibW92ZXMiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3BhcnNlIiIiCgoKX3VybGxpYl9wYXJzZV9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoIlBhcnNlUmVzdWx0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlNwbGl0UmVzdWx0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInBhcnNlX3FzIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInBhcnNlX3FzbCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxkZWZyYWciLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsam9pbiIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxwYXJzZSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxzcGxpdCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmx1bnBhcnNlIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHVuc3BsaXQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicXVvdGUiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInF1b3RlX3BsdXMiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVucXVvdGUiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVucXVvdGVfcGx1cyIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsZW5jb2RlIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzcGxpdHF1ZXJ5IiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzcGxpdHRhZyIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgic3BsaXR1c2VyIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX2ZyYWdtZW50IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfbmV0bG9jIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfcGFyYW1zIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfcXVlcnkiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19yZWxhdGl2ZSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX3BhcnNlX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9wYXJzZS5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfcGFyc2VfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWJfcGFyc2UiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfcGFyc2UiLCAibW92ZXMudXJsbGliLnBhcnNlIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvcihfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9lcnJvciIiIgoKCl91cmxsaWJfZXJyb3JfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJVUkxFcnJvciIsICJ1cmxsaWIyIiwgInVybGxpYi5lcnJvciIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBFcnJvciIsICJ1cmxsaWIyIiwgInVybGxpYi5lcnJvciIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkNvbnRlbnRUb29TaG9ydEVycm9yIiwgInVybGxpYiIsICJ1cmxsaWIuZXJyb3IiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX2Vycm9yX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvci5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfZXJyb3JfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIuZXJyb3IiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfZXJyb3IiLCAibW92ZXMudXJsbGliLmVycm9yIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXF1ZXN0KF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3JlcXVlc3QiIiIKCgpfdXJsbGliX3JlcXVlc3RfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxvcGVuIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnN0YWxsX29wZW5lciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYnVpbGRfb3BlbmVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwYXRobmFtZTJ1cmwiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsMnBhdGhuYW1lIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldHByb3hpZXMiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUmVxdWVzdCIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiT3BlbmVyRGlyZWN0b3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBEZWZhdWx0RXJyb3JIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQUmVkaXJlY3RIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQQ29va2llUHJvY2Vzc29yIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJQcm94eUhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkJhc2VIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQUGFzc3dvcmRNZ3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBQYXNzd29yZE1ncldpdGhEZWZhdWx0UmVhbG0iLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkFic3RyYWN0QmFzaWNBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEJhc2ljQXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlByb3h5QmFzaWNBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQWJzdHJhY3REaWdlc3RBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUERpZ2VzdEF1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJQcm94eURpZ2VzdEF1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUFNIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJGaWxlSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiRlRQSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQ2FjaGVGVFBIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVbmtub3duSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEVycm9yUHJvY2Vzc29yIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxyZXRyaWV2ZSIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxjbGVhbnVwIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVSTG9wZW5lciIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJGYW5jeVVSTG9wZW5lciIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwcm94eV9ieXBhc3MiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9yZXF1ZXN0X21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3JlcXVlc3RfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5yZXF1ZXN0IiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3JlcXVlc3QiLCAibW92ZXMudXJsbGliLnJlcXVlc3QiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3Jlc3BvbnNlKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3Jlc3BvbnNlIiIiCgoKX3VybGxpYl9yZXNwb25zZV9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGJhc2UiLCAidXJsbGliIiwgInVybGxpYi5yZXNwb25zZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGNsb3NlaG9vayIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkaW5mbyIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkaW5mb3VybCIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9yZXNwb25zZV9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZSwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVzcG9uc2UuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3Jlc3BvbnNlX21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZShfX25hbWVfXyArICIubW92ZXMudXJsbGliLnJlc3BvbnNlIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3Jlc3BvbnNlIiwgIm1vdmVzLnVybGxpYi5yZXNwb25zZSIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfcm9ib3RwYXJzZXIiIiIKCgpfdXJsbGliX3JvYm90cGFyc2VyX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUm9ib3RGaWxlUGFyc2VyIiwgInJvYm90cGFyc2VyIiwgInVybGxpYi5yb2JvdHBhcnNlciIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfcm9ib3RwYXJzZXJfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JvYm90cGFyc2VyLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9yb2JvdHBhcnNlcl9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5yb2JvdHBhcnNlciIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9yb2JvdHBhcnNlciIsICJtb3Zlcy51cmxsaWIucm9ib3RwYXJzZXIiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliKHR5cGVzLk1vZHVsZVR5cGUpOgoKICAgICIiIkNyZWF0ZSBhIHNpeC5tb3Zlcy51cmxsaWIgbmFtZXNwYWNlIHRoYXQgcmVzZW1ibGVzIHRoZSBQeXRob24gMyBuYW1lc3BhY2UiIiIKICAgIF9fcGF0aF9fID0gW10gICMgbWFyayBhcyBwYWNrYWdlCiAgICBwYXJzZSA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3BhcnNlIikKICAgIGVycm9yID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfZXJyb3IiKQogICAgcmVxdWVzdCA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3JlcXVlc3QiKQogICAgcmVzcG9uc2UgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9yZXNwb25zZSIpCiAgICByb2JvdHBhcnNlciA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3JvYm90cGFyc2VyIikKCiAgICBkZWYgX19kaXJfXyhzZWxmKToKICAgICAgICByZXR1cm4gWydwYXJzZScsICdlcnJvcicsICdyZXF1ZXN0JywgJ3Jlc3BvbnNlJywgJ3JvYm90cGFyc2VyJ10KCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYihfX25hbWVfXyArICIubW92ZXMudXJsbGliIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliIikKCgpkZWYgYWRkX21vdmUobW92ZSk6CiAgICAiIiJBZGQgYW4gaXRlbSB0byBzaXgubW92ZXMuIiIiCiAgICBzZXRhdHRyKF9Nb3ZlZEl0ZW1zLCBtb3ZlLm5hbWUsIG1vdmUpCgoKZGVmIHJlbW92ZV9tb3ZlKG5hbWUpOgogICAgIiIiUmVtb3ZlIGl0ZW0gZnJvbSBzaXgubW92ZXMuIiIiCiAgICB0cnk6CiAgICAgICAgZGVsYXR0cihfTW92ZWRJdGVtcywgbmFtZSkKICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRlbCBtb3Zlcy5fX2RpY3RfX1tuYW1lXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcmFpc2UgQXR0cmlidXRlRXJyb3IoIm5vIHN1Y2ggbW92ZSwgJXIiICUgKG5hbWUsKSkKCgppZiBQWTM6CiAgICBfbWV0aF9mdW5jID0gIl9fZnVuY19fIgogICAgX21ldGhfc2VsZiA9ICJfX3NlbGZfXyIKCiAgICBfZnVuY19jbG9zdXJlID0gIl9fY2xvc3VyZV9fIgogICAgX2Z1bmNfY29kZSA9ICJfX2NvZGVfXyIKICAgIF9mdW5jX2RlZmF1bHRzID0gIl9fZGVmYXVsdHNfXyIKICAgIF9mdW5jX2dsb2JhbHMgPSAiX19nbG9iYWxzX18iCmVsc2U6CiAgICBfbWV0aF9mdW5jID0gImltX2Z1bmMiCiAgICBfbWV0aF9zZWxmID0gImltX3NlbGYiCgogICAgX2Z1bmNfY2xvc3VyZSA9ICJmdW5jX2Nsb3N1cmUiCiAgICBfZnVuY19jb2RlID0gImZ1bmNfY29kZSIKICAgIF9mdW5jX2RlZmF1bHRzID0gImZ1bmNfZGVmYXVsdHMiCiAgICBfZnVuY19nbG9iYWxzID0gImZ1bmNfZ2xvYmFscyIKCgp0cnk6CiAgICBhZHZhbmNlX2l0ZXJhdG9yID0gbmV4dApleGNlcHQgTmFtZUVycm9yOgogICAgZGVmIGFkdmFuY2VfaXRlcmF0b3IoaXQpOgogICAgICAgIHJldHVybiBpdC5uZXh0KCkKbmV4dCA9IGFkdmFuY2VfaXRlcmF0b3IKCgp0cnk6CiAgICBjYWxsYWJsZSA9IGNhbGxhYmxlCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICBkZWYgY2FsbGFibGUob2JqKToKICAgICAgICByZXR1cm4gYW55KCJfX2NhbGxfXyIgaW4ga2xhc3MuX19kaWN0X18gZm9yIGtsYXNzIGluIHR5cGUob2JqKS5fX21yb19fKQoKCmlmIFBZMzoKICAgIGRlZiBnZXRfdW5ib3VuZF9mdW5jdGlvbih1bmJvdW5kKToKICAgICAgICByZXR1cm4gdW5ib3VuZAoKICAgIGNyZWF0ZV9ib3VuZF9tZXRob2QgPSB0eXBlcy5NZXRob2RUeXBlCgogICAgZGVmIGNyZWF0ZV91bmJvdW5kX21ldGhvZChmdW5jLCBjbHMpOgogICAgICAgIHJldHVybiBmdW5jCgogICAgSXRlcmF0b3IgPSBvYmplY3QKZWxzZToKICAgIGRlZiBnZXRfdW5ib3VuZF9mdW5jdGlvbih1bmJvdW5kKToKICAgICAgICByZXR1cm4gdW5ib3VuZC5pbV9mdW5jCgogICAgZGVmIGNyZWF0ZV9ib3VuZF9tZXRob2QoZnVuYywgb2JqKToKICAgICAgICByZXR1cm4gdHlwZXMuTWV0aG9kVHlwZShmdW5jLCBvYmosIG9iai5fX2NsYXNzX18pCgogICAgZGVmIGNyZWF0ZV91bmJvdW5kX21ldGhvZChmdW5jLCBjbHMpOgogICAgICAgIHJldHVybiB0eXBlcy5NZXRob2RUeXBlKGZ1bmMsIE5vbmUsIGNscykKCiAgICBjbGFzcyBJdGVyYXRvcihvYmplY3QpOgoKICAgICAgICBkZWYgbmV4dChzZWxmKToKICAgICAgICAgICAgcmV0dXJuIHR5cGUoc2VsZikuX19uZXh0X18oc2VsZikKCiAgICBjYWxsYWJsZSA9IGNhbGxhYmxlCl9hZGRfZG9jKGdldF91bmJvdW5kX2Z1bmN0aW9uLAogICAgICAgICAiIiJHZXQgdGhlIGZ1bmN0aW9uIG91dCBvZiBhIHBvc3NpYmx5IHVuYm91bmQgZnVuY3Rpb24iIiIpCgoKZ2V0X21ldGhvZF9mdW5jdGlvbiA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX21ldGhfZnVuYykKZ2V0X21ldGhvZF9zZWxmID0gb3BlcmF0b3IuYXR0cmdldHRlcihfbWV0aF9zZWxmKQpnZXRfZnVuY3Rpb25fY2xvc3VyZSA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfY2xvc3VyZSkKZ2V0X2Z1bmN0aW9uX2NvZGUgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9mdW5jX2NvZGUpCmdldF9mdW5jdGlvbl9kZWZhdWx0cyA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfZGVmYXVsdHMpCmdldF9mdW5jdGlvbl9nbG9iYWxzID0gb3BlcmF0b3IuYXR0cmdldHRlcihfZnVuY19nbG9iYWxzKQoKCmlmIFBZMzoKICAgIGRlZiBpdGVya2V5cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLmtleXMoKiprdykpCgogICAgZGVmIGl0ZXJ2YWx1ZXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC52YWx1ZXMoKiprdykpCgogICAgZGVmIGl0ZXJpdGVtcyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLml0ZW1zKCoqa3cpKQoKICAgIGRlZiBpdGVybGlzdHMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC5saXN0cygqKmt3KSkKCiAgICB2aWV3a2V5cyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigia2V5cyIpCgogICAgdmlld3ZhbHVlcyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigidmFsdWVzIikKCiAgICB2aWV3aXRlbXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoIml0ZW1zIikKZWxzZToKICAgIGRlZiBpdGVya2V5cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gZC5pdGVya2V5cygqKmt3KQoKICAgIGRlZiBpdGVydmFsdWVzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJ2YWx1ZXMoKiprdykKCiAgICBkZWYgaXRlcml0ZW1zKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJpdGVtcygqKmt3KQoKICAgIGRlZiBpdGVybGlzdHMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGQuaXRlcmxpc3RzKCoqa3cpCgogICAgdmlld2tleXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZpZXdrZXlzIikKCiAgICB2aWV3dmFsdWVzID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJ2aWV3dmFsdWVzIikKCiAgICB2aWV3aXRlbXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZpZXdpdGVtcyIpCgpfYWRkX2RvYyhpdGVya2V5cywgIlJldHVybiBhbiBpdGVyYXRvciBvdmVyIHRoZSBrZXlzIG9mIGEgZGljdGlvbmFyeS4iKQpfYWRkX2RvYyhpdGVydmFsdWVzLCAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIHZhbHVlcyBvZiBhIGRpY3Rpb25hcnkuIikKX2FkZF9kb2MoaXRlcml0ZW1zLAogICAgICAgICAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIChrZXksIHZhbHVlKSBwYWlycyBvZiBhIGRpY3Rpb25hcnkuIikKX2FkZF9kb2MoaXRlcmxpc3RzLAogICAgICAgICAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIChrZXksIFt2YWx1ZXNdKSBwYWlycyBvZiBhIGRpY3Rpb25hcnkuIikKCgppZiBQWTM6CiAgICBkZWYgYihzKToKICAgICAgICByZXR1cm4gcy5lbmNvZGUoImxhdGluLTEiKQoKICAgIGRlZiB1KHMpOgogICAgICAgIHJldHVybiBzCiAgICB1bmljaHIgPSBjaHIKICAgIGltcG9ydCBzdHJ1Y3QKICAgIGludDJieXRlID0gc3RydWN0LlN0cnVjdCgiPkIiKS5wYWNrCiAgICBkZWwgc3RydWN0CiAgICBieXRlMmludCA9IG9wZXJhdG9yLml0ZW1nZXR0ZXIoMCkKICAgIGluZGV4Ynl0ZXMgPSBvcGVyYXRvci5nZXRpdGVtCiAgICBpdGVyYnl0ZXMgPSBpdGVyCiAgICBpbXBvcnQgaW8KICAgIFN0cmluZ0lPID0gaW8uU3RyaW5nSU8KICAgIEJ5dGVzSU8gPSBpby5CeXRlc0lPCiAgICBfYXNzZXJ0Q291bnRFcXVhbCA9ICJhc3NlcnRDb3VudEVxdWFsIgogICAgaWYgc3lzLnZlcnNpb25faW5mb1sxXSA8PSAxOgogICAgICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleHAiCiAgICAgICAgX2Fzc2VydFJlZ2V4ID0gImFzc2VydFJlZ2V4cE1hdGNoZXMiCiAgICBlbHNlOgogICAgICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleCIKICAgICAgICBfYXNzZXJ0UmVnZXggPSAiYXNzZXJ0UmVnZXgiCmVsc2U6CiAgICBkZWYgYihzKToKICAgICAgICByZXR1cm4gcwogICAgIyBXb3JrYXJvdW5kIGZvciBzdGFuZGFsb25lIGJhY2tzbGFzaAoKICAgIGRlZiB1KHMpOgogICAgICAgIHJldHVybiB1bmljb2RlKHMucmVwbGFjZShyJ1xcJywgcidcXFxcJyksICJ1bmljb2RlX2VzY2FwZSIpCiAgICB1bmljaHIgPSB1bmljaHIKICAgIGludDJieXRlID0gY2hyCgogICAgZGVmIGJ5dGUyaW50KGJzKToKICAgICAgICByZXR1cm4gb3JkKGJzWzBdKQoKICAgIGRlZiBpbmRleGJ5dGVzKGJ1ZiwgaSk6CiAgICAgICAgcmV0dXJuIG9yZChidWZbaV0pCiAgICBpdGVyYnl0ZXMgPSBmdW5jdG9vbHMucGFydGlhbChpdGVydG9vbHMuaW1hcCwgb3JkKQogICAgaW1wb3J0IFN0cmluZ0lPCiAgICBTdHJpbmdJTyA9IEJ5dGVzSU8gPSBTdHJpbmdJTy5TdHJpbmdJTwogICAgX2Fzc2VydENvdW50RXF1YWwgPSAiYXNzZXJ0SXRlbXNFcXVhbCIKICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleHAiCiAgICBfYXNzZXJ0UmVnZXggPSAiYXNzZXJ0UmVnZXhwTWF0Y2hlcyIKX2FkZF9kb2MoYiwgIiIiQnl0ZSBsaXRlcmFsIiIiKQpfYWRkX2RvYyh1LCAiIiJUZXh0IGxpdGVyYWwiIiIpCgoKZGVmIGFzc2VydENvdW50RXF1YWwoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgIHJldHVybiBnZXRhdHRyKHNlbGYsIF9hc3NlcnRDb3VudEVxdWFsKSgqYXJncywgKiprd2FyZ3MpCgoKZGVmIGFzc2VydFJhaXNlc1JlZ2V4KHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICByZXR1cm4gZ2V0YXR0cihzZWxmLCBfYXNzZXJ0UmFpc2VzUmVnZXgpKCphcmdzLCAqKmt3YXJncykKCgpkZWYgYXNzZXJ0UmVnZXgoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgIHJldHVybiBnZXRhdHRyKHNlbGYsIF9hc3NlcnRSZWdleCkoKmFyZ3MsICoqa3dhcmdzKQoKCmlmIFBZMzoKICAgIGV4ZWNfID0gZ2V0YXR0cihtb3Zlcy5idWlsdGlucywgImV4ZWMiKQoKICAgIGRlZiByZXJhaXNlKHRwLCB2YWx1ZSwgdGI9Tm9uZSk6CiAgICAgICAgaWYgdmFsdWUgaXMgTm9uZToKICAgICAgICAgICAgdmFsdWUgPSB0cCgpCiAgICAgICAgaWYgdmFsdWUuX190cmFjZWJhY2tfXyBpcyBub3QgdGI6CiAgICAgICAgICAgIHJhaXNlIHZhbHVlLndpdGhfdHJhY2ViYWNrKHRiKQogICAgICAgIHJhaXNlIHZhbHVlCgplbHNlOgogICAgZGVmIGV4ZWNfKF9jb2RlXywgX2dsb2JzXz1Ob25lLCBfbG9jc189Tm9uZSk6CiAgICAgICAgIiIiRXhlY3V0ZSBjb2RlIGluIGEgbmFtZXNwYWNlLiIiIgogICAgICAgIGlmIF9nbG9ic18gaXMgTm9uZToKICAgICAgICAgICAgZnJhbWUgPSBzeXMuX2dldGZyYW1lKDEpCiAgICAgICAgICAgIF9nbG9ic18gPSBmcmFtZS5mX2dsb2JhbHMKICAgICAgICAgICAgaWYgX2xvY3NfIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBfbG9jc18gPSBmcmFtZS5mX2xvY2FscwogICAgICAgICAgICBkZWwgZnJhbWUKICAgICAgICBlbGlmIF9sb2NzXyBpcyBOb25lOgogICAgICAgICAgICBfbG9jc18gPSBfZ2xvYnNfCiAgICAgICAgZXhlYygiIiJleGVjIF9jb2RlXyBpbiBfZ2xvYnNfLCBfbG9jc18iIiIpCgogICAgZXhlY18oIiIiZGVmIHJlcmFpc2UodHAsIHZhbHVlLCB0Yj1Ob25lKToKICAgIHJhaXNlIHRwLCB2YWx1ZSwgdGIKIiIiKQoKCmlmIHN5cy52ZXJzaW9uX2luZm9bOjJdID09ICgzLCAyKToKICAgIGV4ZWNfKCIiImRlZiByYWlzZV9mcm9tKHZhbHVlLCBmcm9tX3ZhbHVlKToKICAgIGlmIGZyb21fdmFsdWUgaXMgTm9uZToKICAgICAgICByYWlzZSB2YWx1ZQogICAgcmFpc2UgdmFsdWUgZnJvbSBmcm9tX3ZhbHVlCiIiIikKZWxpZiBzeXMudmVyc2lvbl9pbmZvWzoyXSA+ICgzLCAyKToKICAgIGV4ZWNfKCIiImRlZiByYWlzZV9mcm9tKHZhbHVlLCBmcm9tX3ZhbHVlKToKICAgIHJhaXNlIHZhbHVlIGZyb20gZnJvbV92YWx1ZQoiIiIpCmVsc2U6CiAgICBkZWYgcmFpc2VfZnJvbSh2YWx1ZSwgZnJvbV92YWx1ZSk6CiAgICAgICAgcmFpc2UgdmFsdWUKCgpwcmludF8gPSBnZXRhdHRyKG1vdmVzLmJ1aWx0aW5zLCAicHJpbnQiLCBOb25lKQppZiBwcmludF8gaXMgTm9uZToKICAgIGRlZiBwcmludF8oKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAiIiJUaGUgbmV3LXN0eWxlIHByaW50IGZ1bmN0aW9uIGZvciBQeXRob24gMi40IGFuZCAyLjUuIiIiCiAgICAgICAgZnAgPSBrd2FyZ3MucG9wKCJmaWxlIiwgc3lzLnN0ZG91dCkKICAgICAgICBpZiBmcCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZGVmIHdyaXRlKGRhdGEpOgogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShkYXRhLCBiYXNlc3RyaW5nKToKICAgICAgICAgICAgICAgIGRhdGEgPSBzdHIoZGF0YSkKICAgICAgICAgICAgIyBJZiB0aGUgZmlsZSBoYXMgYW4gZW5jb2RpbmcsIGVuY29kZSB1bmljb2RlIHdpdGggaXQuCiAgICAgICAgICAgIGlmIChpc2luc3RhbmNlKGZwLCBmaWxlKSBhbmQKICAgICAgICAgICAgICAgICAgICBpc2luc3RhbmNlKGRhdGEsIHVuaWNvZGUpIGFuZAogICAgICAgICAgICAgICAgICAgIGZwLmVuY29kaW5nIGlzIG5vdCBOb25lKToKICAgICAgICAgICAgICAgIGVycm9ycyA9IGdldGF0dHIoZnAsICJlcnJvcnMiLCBOb25lKQogICAgICAgICAgICAgICAgaWYgZXJyb3JzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzID0gInN0cmljdCIKICAgICAgICAgICAgICAgIGRhdGEgPSBkYXRhLmVuY29kZShmcC5lbmNvZGluZywgZXJyb3JzKQogICAgICAgICAgICBmcC53cml0ZShkYXRhKQogICAgICAgIHdhbnRfdW5pY29kZSA9IEZhbHNlCiAgICAgICAgc2VwID0ga3dhcmdzLnBvcCgic2VwIiwgTm9uZSkKICAgICAgICBpZiBzZXAgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc2VwLCB1bmljb2RlKToKICAgICAgICAgICAgICAgIHdhbnRfdW5pY29kZSA9IFRydWUKICAgICAgICAgICAgZWxpZiBub3QgaXNpbnN0YW5jZShzZXAsIHN0cik6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoInNlcCBtdXN0IGJlIE5vbmUgb3IgYSBzdHJpbmciKQogICAgICAgIGVuZCA9IGt3YXJncy5wb3AoImVuZCIsIE5vbmUpCiAgICAgICAgaWYgZW5kIGlzIG5vdCBOb25lOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGVuZCwgdW5pY29kZSk6CiAgICAgICAgICAgICAgICB3YW50X3VuaWNvZGUgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2UoZW5kLCBzdHIpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJlbmQgbXVzdCBiZSBOb25lIG9yIGEgc3RyaW5nIikKICAgICAgICBpZiBrd2FyZ3M6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiaW52YWxpZCBrZXl3b3JkIGFyZ3VtZW50cyB0byBwcmludCgpIikKICAgICAgICBpZiBub3Qgd2FudF91bmljb2RlOgogICAgICAgICAgICBmb3IgYXJnIGluIGFyZ3M6CiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGFyZywgdW5pY29kZSk6CiAgICAgICAgICAgICAgICAgICAgd2FudF91bmljb2RlID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgaWYgd2FudF91bmljb2RlOgogICAgICAgICAgICBuZXdsaW5lID0gdW5pY29kZSgiXG4iKQogICAgICAgICAgICBzcGFjZSA9IHVuaWNvZGUoIiAiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG5ld2xpbmUgPSAiXG4iCiAgICAgICAgICAgIHNwYWNlID0gIiAiCiAgICAgICAgaWYgc2VwIGlzIE5vbmU6CiAgICAgICAgICAgIHNlcCA9IHNwYWNlCiAgICAgICAgaWYgZW5kIGlzIE5vbmU6CiAgICAgICAgICAgIGVuZCA9IG5ld2xpbmUKICAgICAgICBmb3IgaSwgYXJnIGluIGVudW1lcmF0ZShhcmdzKToKICAgICAgICAgICAgaWYgaToKICAgICAgICAgICAgICAgIHdyaXRlKHNlcCkKICAgICAgICAgICAgd3JpdGUoYXJnKQogICAgICAgIHdyaXRlKGVuZCkKaWYgc3lzLnZlcnNpb25faW5mb1s6Ml0gPCAoMywgMyk6CiAgICBfcHJpbnQgPSBwcmludF8KCiAgICBkZWYgcHJpbnRfKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgZnAgPSBrd2FyZ3MuZ2V0KCJmaWxlIiwgc3lzLnN0ZG91dCkKICAgICAgICBmbHVzaCA9IGt3YXJncy5wb3AoImZsdXNoIiwgRmFsc2UpCiAgICAgICAgX3ByaW50KCphcmdzLCAqKmt3YXJncykKICAgICAgICBpZiBmbHVzaCBhbmQgZnAgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGZwLmZsdXNoKCkKCl9hZGRfZG9jKHJlcmFpc2UsICIiIlJlcmFpc2UgYW4gZXhjZXB0aW9uLiIiIikKCmlmIHN5cy52ZXJzaW9uX2luZm9bMDoyXSA8ICgzLCA0KToKICAgIGRlZiB3cmFwcyh3cmFwcGVkLCBhc3NpZ25lZD1mdW5jdG9vbHMuV1JBUFBFUl9BU1NJR05NRU5UUywKICAgICAgICAgICAgICB1cGRhdGVkPWZ1bmN0b29scy5XUkFQUEVSX1VQREFURVMpOgogICAgICAgIGRlZiB3cmFwcGVyKGYpOgogICAgICAgICAgICBmID0gZnVuY3Rvb2xzLndyYXBzKHdyYXBwZWQsIGFzc2lnbmVkLCB1cGRhdGVkKShmKQogICAgICAgICAgICBmLl9fd3JhcHBlZF9fID0gd3JhcHBlZAogICAgICAgICAgICByZXR1cm4gZgogICAgICAgIHJldHVybiB3cmFwcGVyCmVsc2U6CiAgICB3cmFwcyA9IGZ1bmN0b29scy53cmFwcwoKCmRlZiB3aXRoX21ldGFjbGFzcyhtZXRhLCAqYmFzZXMpOgogICAgIiIiQ3JlYXRlIGEgYmFzZSBjbGFzcyB3aXRoIGEgbWV0YWNsYXNzLiIiIgogICAgIyBUaGlzIHJlcXVpcmVzIGEgYml0IG9mIGV4cGxhbmF0aW9uOiB0aGUgYmFzaWMgaWRlYSBpcyB0byBtYWtlIGEgZHVtbXkKICAgICMgbWV0YWNsYXNzIGZvciBvbmUgbGV2ZWwgb2YgY2xhc3MgaW5zdGFudGlhdGlvbiB0aGF0IHJlcGxhY2VzIGl0c2VsZiB3aXRoCiAgICAjIHRoZSBhY3R1YWwgbWV0YWNsYXNzLgogICAgY2xhc3MgbWV0YWNsYXNzKG1ldGEpOgoKICAgICAgICBkZWYgX19uZXdfXyhjbHMsIG5hbWUsIHRoaXNfYmFzZXMsIGQpOgogICAgICAgICAgICByZXR1cm4gbWV0YShuYW1lLCBiYXNlcywgZCkKICAgIHJldHVybiB0eXBlLl9fbmV3X18obWV0YWNsYXNzLCAndGVtcG9yYXJ5X2NsYXNzJywgKCksIHt9KQoKCmRlZiBhZGRfbWV0YWNsYXNzKG1ldGFjbGFzcyk6CiAgICAiIiJDbGFzcyBkZWNvcmF0b3IgZm9yIGNyZWF0aW5nIGEgY2xhc3Mgd2l0aCBhIG1ldGFjbGFzcy4iIiIKICAgIGRlZiB3cmFwcGVyKGNscyk6CiAgICAgICAgb3JpZ192YXJzID0gY2xzLl9fZGljdF9fLmNvcHkoKQogICAgICAgIHNsb3RzID0gb3JpZ192YXJzLmdldCgnX19zbG90c19fJykKICAgICAgICBpZiBzbG90cyBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzbG90cywgc3RyKToKICAgICAgICAgICAgICAgIHNsb3RzID0gW3Nsb3RzXQogICAgICAgICAgICBmb3Igc2xvdHNfdmFyIGluIHNsb3RzOgogICAgICAgICAgICAgICAgb3JpZ192YXJzLnBvcChzbG90c192YXIpCiAgICAgICAgb3JpZ192YXJzLnBvcCgnX19kaWN0X18nLCBOb25lKQogICAgICAgIG9yaWdfdmFycy5wb3AoJ19fd2Vha3JlZl9fJywgTm9uZSkKICAgICAgICByZXR1cm4gbWV0YWNsYXNzKGNscy5fX25hbWVfXywgY2xzLl9fYmFzZXNfXywgb3JpZ192YXJzKQogICAgcmV0dXJuIHdyYXBwZXIKCgpkZWYgcHl0aG9uXzJfdW5pY29kZV9jb21wYXRpYmxlKGtsYXNzKToKICAgICIiIgogICAgQSBkZWNvcmF0b3IgdGhhdCBkZWZpbmVzIF9fdW5pY29kZV9fIGFuZCBfX3N0cl9fIG1ldGhvZHMgdW5kZXIgUHl0aG9uIDIuCiAgICBVbmRlciBQeXRob24gMyBpdCBkb2VzIG5vdGhpbmcuCgogICAgVG8gc3VwcG9ydCBQeXRob24gMiBhbmQgMyB3aXRoIGEgc2luZ2xlIGNvZGUgYmFzZSwgZGVmaW5lIGEgX19zdHJfXyBtZXRob2QKICAgIHJldHVybmluZyB0ZXh0IGFuZCBhcHBseSB0aGlzIGRlY29yYXRvciB0byB0aGUgY2xhc3MuCiAgICAiIiIKICAgIGlmIFBZMjoKICAgICAgICBpZiAnX19zdHJfXycgbm90IGluIGtsYXNzLl9fZGljdF9fOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJAcHl0aG9uXzJfdW5pY29kZV9jb21wYXRpYmxlIGNhbm5vdCBiZSBhcHBsaWVkICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidG8gJXMgYmVjYXVzZSBpdCBkb2Vzbid0IGRlZmluZSBfX3N0cl9fKCkuIiAlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2xhc3MuX19uYW1lX18pCiAgICAgICAga2xhc3MuX191bmljb2RlX18gPSBrbGFzcy5fX3N0cl9fCiAgICAgICAga2xhc3MuX19zdHJfXyA9IGxhbWJkYSBzZWxmOiBzZWxmLl9fdW5pY29kZV9fKCkuZW5jb2RlKCd1dGYtOCcpCiAgICByZXR1cm4ga2xhc3MKCgojIENvbXBsZXRlIHRoZSBtb3ZlcyBpbXBsZW1lbnRhdGlvbi4KIyBUaGlzIGNvZGUgaXMgYXQgdGhlIGVuZCBvZiB0aGlzIG1vZHVsZSB0byBzcGVlZCB1cCBtb2R1bGUgbG9hZGluZy4KIyBUdXJuIHRoaXMgbW9kdWxlIGludG8gYSBwYWNrYWdlLgpfX3BhdGhfXyA9IFtdICAjIHJlcXVpcmVkIGZvciBQRVAgMzAyIGFuZCBQRVAgNDUxCl9fcGFja2FnZV9fID0gX19uYW1lX18gICMgc2VlIFBFUCAzNjYgQFJlc2VydmVkQXNzaWdubWVudAppZiBnbG9iYWxzKCkuZ2V0KCJfX3NwZWNfXyIpIGlzIG5vdCBOb25lOgogICAgX19zcGVjX18uc3VibW9kdWxlX3NlYXJjaF9sb2NhdGlvbnMgPSBbXSAgIyBQRVAgNDUxIEBVbmRlZmluZWRWYXJpYWJsZQojIFJlbW92ZSBvdGhlciBzaXggbWV0YSBwYXRoIGltcG9ydGVycywgc2luY2UgdGhleSBjYXVzZSBwcm9ibGVtcy4gVGhpcyBjYW4KIyBoYXBwZW4gaWYgc2l4IGlzIHJlbW92ZWQgZnJvbSBzeXMubW9kdWxlcyBhbmQgdGhlbiByZWxvYWRlZC4gKFNldHVwdG9vbHMgZG9lcwojIHRoaXMgZm9yIHNvbWUgcmVhc29uLikKaWYgc3lzLm1ldGFfcGF0aDoKICAgIGZvciBpLCBpbXBvcnRlciBpbiBlbnVtZXJhdGUoc3lzLm1ldGFfcGF0aCk6CiAgICAgICAgIyBIZXJlJ3Mgc29tZSByZWFsIG5hc3RpbmVzczogQW5vdGhlciAiaW5zdGFuY2UiIG9mIHRoZSBzaXggbW9kdWxlIG1pZ2h0CiAgICAgICAgIyBiZSBmbG9hdGluZyBhcm91bmQuIFRoZXJlZm9yZSwgd2UgY2FuJ3QgdXNlIGlzaW5zdGFuY2UoKSB0byBjaGVjayBmb3IKICAgICAgICAjIHRoZSBzaXggbWV0YSBwYXRoIGltcG9ydGVyLCBzaW5jZSB0aGUgb3RoZXIgc2l4IGluc3RhbmNlIHdpbGwgaGF2ZQogICAgICAgICMgaW5zZXJ0ZWQgYW4gaW1wb3J0ZXIgd2l0aCBkaWZmZXJlbnQgY2xhc3MuCiAgICAgICAgaWYgKHR5cGUoaW1wb3J0ZXIpLl9fbmFtZV9fID09ICJfU2l4TWV0YVBhdGhJbXBvcnRlciIgYW5kCiAgICAgICAgICAgICAgICBpbXBvcnRlci5uYW1lID09IF9fbmFtZV9fKToKICAgICAgICAgICAgZGVsIHN5cy5tZXRhX3BhdGhbaV0KICAgICAgICAgICAgYnJlYWsKICAgIGRlbCBpLCBpbXBvcnRlcgojIEZpbmFsbHksIGFkZCB0aGUgaW1wb3J0ZXIgdG8gdGhlIG1ldGEgcGF0aCBpbXBvcnQgaG9vay4Kc3lzLm1ldGFfcGF0aC5hcHBlbmQoX2ltcG9ydGVyKQpQSwECFAMUAAAAAADLuytLj6fxUncAAAB3AAAAEwAAAAAAAAAAAAAAgAEAAAAAYW5zaWJsZS9fX2luaXRfXy5weVBLAQIUAxQAAAAAAMu7K0udxfFrSAAAAEgAAAAgAAAAAAAAAAAAAACAAagAAABhbnNpYmxlL21vZHVsZV91dGlscy9fX2luaXRfXy5weVBLAQIUAxQAAAAAAMu7K0sav0BXtCMAALQjAAAfAAAAAAAAAAAAAACAAS4BAABhbnNpYmxlX21vZHVsZV9zdXBlcnZpc29yY3RsLnB5UEsBAhQDFAAAAAAAy7srSzvfOZUwigEAMIoBAB0AAAAAAAAAAAAAAIABHyUAAGFuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5UEsBAhQDFAAAAAAAy7srS7XYBAYlMAAAJTAAAB0AAAAAAAAAAAAAAIABiq8BAGFuc2libGUvbW9kdWxlX3V0aWxzL190ZXh0LnB5UEsBAhQDFAAAAAAAy7srSyXctH4TEAAAExAAACIAAAAAAAAAAAAAAIAB6t8BAGFuc2libGUvbW9kdWxlX3V0aWxzL3B5Y29tcGF0MjQucHlQSwECFAMUAAAAAADLuytLGBdy9QERAAABEQAAJAAAAAAAAAAAAAAAgAE98AEAYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19faW5pdF9fLnB5UEsBAhQDFAAAAAAAy7srSzjix9GRdQAAkXUAACAAAAAAAAAAAAAAAIABgAECAGFuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fc2l4LnB5UEsFBgAAAAAIAAgAYgIAAE93AgAAAA=="""
def invoke_module(module, modlib_path, json_params):
    pythonpath = os.environ.get('PYTHONPATH')
    if pythonpath:
        os.environ['PYTHONPATH'] = ':'.join((modlib_path, pythonpath))
    else:
        os.environ['PYTHONPATH'] = modlib_path
    p = subprocess.Popen(['/usr/bin/python', module], env=os.environ, shell=False, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
    (stdout, stderr) = p.communicate(json_params)
    if not isinstance(stderr, (bytes, unicode)):
        stderr = stderr.read()
    if not isinstance(stdout, (bytes, unicode)):
        stdout = stdout.read()
    if PY3:
        sys.stderr.buffer.write(stderr)
        sys.stdout.buffer.write(stdout)
    else:
        sys.stderr.write(stderr)
        sys.stdout.write(stdout)
    return p.returncode
def debug(command, zipped_mod, json_params):
    basedir = os.path.join(os.path.abspath(os.path.dirname(__file__)), 'debug_dir')
    args_path = os.path.join(basedir, 'args')
    script_path = os.path.join(basedir, 'ansible_module_supervisorctl.py')
    if command == 'explode':
        z = zipfile.ZipFile(zipped_mod)
        for filename in z.namelist():
            if filename.startswith('/'):
                raise Exception('Something wrong with this module zip file: should not contain absolute paths')
            dest_filename = os.path.join(basedir, filename)
            if dest_filename.endswith(os.path.sep) and not os.path.exists(dest_filename):
                os.makedirs(dest_filename)
            else:
                directory = os.path.dirname(dest_filename)
                if not os.path.exists(directory):
                    os.makedirs(directory)
                f = open(dest_filename, 'wb')
                f.write(z.read(filename))
                f.close()
        f = open(args_path, 'wb')
        f.write(json_params)
        f.close()
        print('Module expanded into:')
        print('%s' % basedir)
        exitcode = 0
    elif command == 'execute':
        pythonpath = os.environ.get('PYTHONPATH')
        if pythonpath:
            os.environ['PYTHONPATH'] = ':'.join((basedir, pythonpath))
        else:
            os.environ['PYTHONPATH'] = basedir
        p = subprocess.Popen(['/usr/bin/python', script_path, args_path],
                env=os.environ, shell=False, stdout=subprocess.PIPE,
                stderr=subprocess.PIPE, stdin=subprocess.PIPE)
        (stdout, stderr) = p.communicate()
        if not isinstance(stderr, (bytes, unicode)):
            stderr = stderr.read()
        if not isinstance(stdout, (bytes, unicode)):
            stdout = stdout.read()
        if PY3:
            sys.stderr.buffer.write(stderr)
            sys.stdout.buffer.write(stdout)
        else:
            sys.stderr.write(stderr)
            sys.stdout.write(stdout)
        return p.returncode
    elif command == 'excommunicate':
        sys.argv = ['supervisorctl', args_path]
        sys.path.insert(0, basedir)
        from ansible_module_supervisorctl import main
        main()
        print('WARNING: Module returned to wrapper instead of exiting')
        sys.exit(1)
    else:
        print('WARNING: Unknown debug command.  Doing nothing.')
        exitcode = 0
    return exitcode
if __name__ == '__main__':
    ANSIBALLZ_PARAMS = json.dumps({"ANSIBLE_MODULE_ARGS": json.load(sys.stdin)})
    if PY3:
        ANSIBALLZ_PARAMS = ANSIBALLZ_PARAMS.encode('utf-8')
    try:
        temp_path = tempfile.mkdtemp(prefix='ansible_')
        zipped_mod = os.path.join(temp_path, 'ansible_modlib.zip')
        modlib = open(zipped_mod, 'wb')
        modlib.write(base64.b64decode(ZIPDATA))
        modlib.close()
        if len(sys.argv) == 2:
            exitcode = debug(sys.argv[1], zipped_mod, ANSIBALLZ_PARAMS)
        else:
            z = zipfile.ZipFile(zipped_mod, mode='r')
            module = os.path.join(temp_path, 'ansible_module_supervisorctl.py')
            f = open(module, 'wb')
            f.write(z.read('ansible_module_supervisorctl.py'))
            f.close()
            z = zipfile.ZipFile(zipped_mod, mode='a')
            sitecustomize = u'import sys\nsys.path.insert(0,"%s")\n' %  zipped_mod
            sitecustomize = sitecustomize.encode('utf-8')
            zinfo = zipfile.ZipInfo()
            zinfo.filename = 'sitecustomize.py'
            zinfo.date_time = ( 2017, 9, 11, 23, 30, 22)
            z.writestr(zinfo, sitecustomize)
            z.close()
            exitcode = invoke_module(module, zipped_mod, ANSIBALLZ_PARAMS)
    finally:
        try:
            shutil.rmtree(temp_path)
        except OSError:
            pass
    sys.exit(exitcode)