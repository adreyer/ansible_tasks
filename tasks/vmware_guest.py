#!/usr/bin/python
# -*- coding: utf-8 -*-
ANSIBALLZ_WRAPPER = True # For test-module script to tell this is a ANSIBALLZ_WRAPPER
import os
import os.path
import sys
import __main__
scriptdir = None
try:
    scriptdir = os.path.dirname(os.path.abspath(__main__.__file__))
except (AttributeError, OSError):
    pass
if scriptdir is not None:
    sys.path = [p for p in sys.path if p != scriptdir]
import base64
import json
import shutil
import zipfile
import tempfile
import subprocess
if sys.version_info < (3,):
    bytes = str
    PY3 = False
else:
    unicode = str
    PY3 = True
try:
    from io import BytesIO as IOStream
except ImportError:
    from StringIO import StringIO as IOStream
ZIPDATA = """UEsDBBQAAAAAAAG8K0uPp/FSdwAAAHcAAAATAAAAYW5zaWJsZS9fX2luaXRfXy5weWZyb20gcGtndXRpbCBpbXBvcnQgZXh0ZW5kX3BhdGgKX19wYXRoX189ZXh0ZW5kX3BhdGgoX19wYXRoX18sX19uYW1lX18pCl9fdmVyc2lvbl9fPSIyLjQuMCIKX19hdXRob3JfXz0iQW5zaWJsZSwgSW5jLiIKUEsDBBQAAAAAAAG8K0udxfFrSAAAAEgAAAAgAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX19pbml0X18ucHlmcm9tIHBrZ3V0aWwgaW1wb3J0IGV4dGVuZF9wYXRoCl9fcGF0aF9fPWV4dGVuZF9wYXRoKF9fcGF0aF9fLF9fbmFtZV9fKQpQSwMEFAAAAAAAAbwrS4ZnEO9l6gAAZeoAAB4AAABhbnNpYmxlX21vZHVsZV92bXdhcmVfZ3Vlc3QucHkjIS91c3IvYmluL3B5dGhvbgojIC0qLSBjb2Rpbmc6IHV0Zi04IC0qLQojCiMgVGhpcyBtb2R1bGUgaXMgYWxzbyBzcG9uc29yZWQgYnkgRS5ULkEuSS4gKHd3dy5ldGFpLmZyKQojCiMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgQW5zaWJsZQojCiMgQW5zaWJsZSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKIyB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgojIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMKIyBBbnNpYmxlIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KIwojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgYWxvbmcgd2l0aCBBbnNpYmxlLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoKQU5TSUJMRV9NRVRBREFUQSA9IHsnbWV0YWRhdGFfdmVyc2lvbic6ICcxLjAnLAogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiBbJ3ByZXZpZXcnXSwKICAgICAgICAgICAgICAgICAgICAnc3VwcG9ydGVkX2J5JzogJ2NvbW11bml0eSd9CgoKRE9DVU1FTlRBVElPTiA9ICcnJwotLS0KbW9kdWxlOiB2bXdhcmVfZ3Vlc3QKc2hvcnRfZGVzY3JpcHRpb246IE1hbmFnZXMgdmlydHVhbCBtYWNoaW5lcyBpbiB2Y2VudGVyCmRlc2NyaXB0aW9uOgogICAgLSBDcmVhdGUgbmV3IHZpcnR1YWwgbWFjaGluZXMgKGZyb20gdGVtcGxhdGVzIG9yIG5vdCkKICAgIC0gUG93ZXIgb24vcG93ZXIgb2ZmL3Jlc3RhcnQgYSB2aXJ0dWFsIG1hY2hpbmUKICAgIC0gTW9kaWZ5LCByZW5hbWUgb3IgcmVtb3ZlIGEgdmlydHVhbCBtYWNoaW5lCnZlcnNpb25fYWRkZWQ6IDIuMgphdXRob3I6CiAgICAtIEphbWVzIFRhbm5lciAoQGpjdGFubmVyKSA8dGFubmVyLmpjQGdtYWlsLmNvbT4KICAgIC0gTG9pYyBCbG90IChAbmVyemh1bCkgPGxvaWMuYmxvdEB1bml4LWV4cGVyaWVuY2UuZnI+Cm5vdGVzOgogICAgLSBUZXN0ZWQgb24gdlNwaGVyZSA1LjUgYW5kIDYuMApyZXF1aXJlbWVudHM6CiAgICAtICJweXRob24gPj0gMi42IgogICAgLSBQeVZtb21pCm9wdGlvbnM6CiAgIHN0YXRlOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIFdoYXQgc3RhdGUgc2hvdWxkIHRoZSB2aXJ0dWFsIG1hY2hpbmUgYmUgaW4/CiAgICAgICAgICAgIC0gSWYgQyhzdGF0ZSkgaXMgc2V0IHRvIEMocHJlc2VudCkgYW5kIFZNIGV4aXN0cywgZW5zdXJlIHRoZSBWTSBjb25maWd1cmF0aW9uIGNvbmZvcm1zIHRvIHRhc2sgYXJndW1lbnRzCiAgICAgICAgcmVxdWlyZWQ6IFRydWUKICAgICAgICBjaG9pY2VzOiBbJ3ByZXNlbnQnLCAnYWJzZW50JywgJ3Bvd2VyZWRvbicsICdwb3dlcmVkb2ZmJywgJ3Jlc3RhcnRlZCcsICdzdXNwZW5kZWQnLCAnc2h1dGRvd25ndWVzdCcsICdyZWJvb3RndWVzdCddCiAgIG5hbWU6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gTmFtZSBvZiB0aGUgVk0gdG8gd29yayB3aXRoCiAgICAgICAgcmVxdWlyZWQ6IFRydWUKICAgbmFtZV9tYXRjaDoKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSBJZiBtdWx0aXBsZSBWTXMgbWF0Y2hpbmcgdGhlIG5hbWUsIHVzZSB0aGUgZmlyc3Qgb3IgbGFzdCBmb3VuZAogICAgICAgIGRlZmF1bHQ6ICdmaXJzdCcKICAgICAgICBjaG9pY2VzOiBbJ2ZpcnN0JywgJ2xhc3QnXQogICB1dWlkOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIFVVSUQgb2YgdGhlIGluc3RhbmNlIHRvIG1hbmFnZSBpZiBrbm93biwgdGhpcyBpcyBWTXdhcmUncyB1bmlxdWUgaWRlbnRpZmllci4KICAgICAgICAgICAgLSBUaGlzIGlzIHJlcXVpcmVkIGlmIG5hbWUgaXMgbm90IHN1cHBsaWVkLgogICB0ZW1wbGF0ZToKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSBUZW1wbGF0ZSB1c2VkIHRvIGNyZWF0ZSBWTS4KICAgICAgICAgICAgLSBJZiB0aGlzIHZhbHVlIGlzIG5vdCBzZXQsIFZNIGlzIGNyZWF0ZWQgd2l0aG91dCB1c2luZyBhIHRlbXBsYXRlLgogICAgICAgICAgICAtIElmIHRoZSBWTSBleGlzdHMgYWxyZWFkeSB0aGlzIHNldHRpbmcgd2lsbCBiZSBpZ25vcmVkLgogICBpc190ZW1wbGF0ZToKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSBGbGFnIHRoZSBpbnN0YW5jZSBhcyBhIHRlbXBsYXRlCiAgICAgICAgZGVmYXVsdDogRmFsc2UKICAgICAgICB2ZXJzaW9uX2FkZGVkOiAiMi4zIgogICBmb2xkZXI6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gRGVzdGluYXRpb24gZm9sZGVyLCBhYnNvbHV0ZSBwYXRoIHRvIGZpbmQgYW4gZXhpc3RpbmcgZ3Vlc3Qgb3IgY3JlYXRlIHRoZSBuZXcgZ3Vlc3QKICAgaGFyZHdhcmU6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gIk1hbmFnZSBzb21lIFZNIGhhcmR3YXJlIGF0dHJpYnV0ZXMuIgogICAgICAgICAgICAtICJWYWxpZCBhdHRyaWJ1dGVzIGFyZTogbWVtb3J5X21iLCBudW1fY3B1cyBhbmQgc2NzaSIKICAgICAgICAgICAgLSAic2NzaTogVmFsaWQgdmFsdWVzIGFyZSBidXNsb2dpYywgbHNpbG9naWMsIGxzaWxvZ2ljc2FzIGFuZCBwYXJhdmlydHVhbCAoZGVmYXVsdCkiCiAgIGd1ZXN0X2lkOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtICJTZXQgdGhlIGd1ZXN0IElEIChEZWJpYW4sIFJIRUwsIFdpbmRvd3MuLi4pIgogICAgICAgICAgICAtICJUaGlzIGZpZWxkIGlzIHJlcXVpcmVkIHdoZW4gY3JlYXRpbmcgYSBWTSIKICAgICAgICAgICAgLSA+CiAgICAgICAgICAgICAgVmFsaWQgdmFsdWVzIGFyZSByZWZlcmVuY2VkIGhlcmU6CiAgICAgICAgICAgICAgaHR0cHM6Ly93d3cudm13YXJlLmNvbS9zdXBwb3J0L2RldmVsb3Blci9jb252ZXJ0ZXItc2RrL2NvbnY1NV9hcGlyZWZlcmVuY2UvdmltLnZtLkd1ZXN0T3NEZXNjcmlwdG9yLkd1ZXN0T3NJZGVudGlmaWVyLmh0bWwKICAgICAgICB2ZXJzaW9uX2FkZGVkOiAiMi4zIgogICBkaXNrOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtICJBIGxpc3Qgb2YgZGlza3MgdG8gYWRkIgogICAgICAgICAgICAtICJWYWxpZCBhdHRyaWJ1dGVzIGFyZTogc2l6ZV9bdGIsZ2IsbWIsa2JdLCB0eXBlLCBkYXRhc3RvcmUgYW5kIGF1dG9zZWxlY3RfZGF0YXN0b3JlIgogICAgICAgICAgICAtICJ0eXBlOiBWYWxpZCB2YWx1ZSBpcyB0aGluIChkZWZhdWx0OiBOb25lKSIKICAgICAgICAgICAgLSAiZGF0YXN0b3JlOiBEYXRhc3RvcmUgdG8gdXNlIGZvciB0aGUgZGlzay4gSWYgYXV0b3NlbGVjdF9kYXRhc3RvcmUgaXMgVHJ1ZSwgZmlsdGVyIGRhdGFzdG9yZSBzZWxlY3Rpb24uIgogICAgICAgICAgICAtICJhdXRvc2VsZWN0X2RhdGFzdG9yZSAoYm9vbCk6IHNlbGVjdCB0aGUgbGVzcyB1c2VkIGRhdGFzdG9yZS4iCiAgIHJlc291cmNlX3Bvb2w6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gQWZmZWN0IG1hY2hpbmUgdG8gdGhlIGdpdmVuIHJlc291cmNlIHBvb2wKICAgICAgICAgICAgLSBSZXNvdXJjZSBwb29sIHNob3VsZCBiZSBjaGlsZCBvZiB0aGUgc2VsZWN0ZWQgaG9zdCBwYXJlbnQKICAgICAgICBkZWZhdWx0OiBOb25lCiAgICAgICAgdmVyc2lvbl9hZGRlZDogIjIuMyIKICAgd2FpdF9mb3JfaXBfYWRkcmVzczoKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgLSBXYWl0IHVudGlsIHZDZW50ZXIgZGV0ZWN0cyBhbiBJUCBhZGRyZXNzIGZvciB0aGUgVk0KICAgICAgICAgICAgLSBUaGlzIHJlcXVpcmVzIHZtd2FyZS10b29scyAodm10b29sc2QpIHRvIHByb3Blcmx5IHdvcmsgYWZ0ZXIgY3JlYXRpb24KICAgICAgICBkZWZhdWx0OiBGYWxzZQogICBzbmFwc2hvdF9zcmM6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gTmFtZSBvZiBhbiBleGlzdGluZyBzbmFwc2hvdCB0byB1c2UgdG8gY3JlYXRlIGEgY2xvbmUgb2YgYSBWTS4KICAgICAgICBkZWZhdWx0OiBOb25lCiAgICAgICAgdmVyc2lvbl9hZGRlZDogIjIuNCIKICAgbGlua2VkX2Nsb25lOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIFdoZXRoZXIgdG8gY3JlYXRlIGEgTGlua2VkIENsb25lIGZyb20gdGhlIHNuYXBzaG90IHNwZWNpZmllZAogICAgICAgIGRlZmF1bHQ6IEZhbHNlCiAgICAgICAgdmVyc2lvbl9hZGRlZDogIjIuNCIKICAgZm9yY2U6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gSWdub3JlIHdhcm5pbmdzIGFuZCBjb21wbGV0ZSB0aGUgYWN0aW9ucwogICBkYXRhY2VudGVyOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIERlc3RpbmF0aW9uIGRhdGFjZW50ZXIgZm9yIHRoZSBkZXBsb3kgb3BlcmF0aW9uCiAgICAgICAgZGVmYXVsdDogaGEtZGF0YWNlbnRlcgogICBjbHVzdGVyOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIFRoZSBjbHVzdGVyIG5hbWUgd2hlcmUgdGhlIFZNIHdpbGwgcnVuLgogICAgICAgIHZlcnNpb25fYWRkZWQ6ICIyLjMiCiAgIGVzeGlfaG9zdG5hbWU6CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAgIC0gVGhlIGVzeGkgaG9zdG5hbWUgd2hlcmUgdGhlIFZNIHdpbGwgcnVuLgogICBhbm5vdGF0aW9uOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIEEgbm90ZSBvciBhbm5vdGF0aW9uIHRvIGluY2x1ZGUgaW4gdGhlIFZNCiAgICAgICAgdmVyc2lvbl9hZGRlZDogIjIuMyIKICAgY3VzdG9tdmFsdWVzOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAtIERlZmluZSBhIGxpc3Qgb2YgY3VzdG9tdmFsdWVzIHRvIHNldCBvbiBWTS4KICAgICAgICAgICAgLSAiQSBjdXN0b212YWx1ZSBvYmplY3QgdGFrZXMgMiBmaWVsZHMgJ2tleScgYW5kICd2YWx1ZScuIgogICAgICAgIHZlcnNpb25fYWRkZWQ6ICIyLjMiCiAgIG5ldHdvcmtzOgogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgLSBOZXR3b3JrIHRvIHVzZSBzaG91bGQgaW5jbHVkZSBDKG5hbWUpIG9yIEModmxhbikgZW50cnkKICAgICAgICAgIC0gQWRkIGFuIG9wdGlvbmFsIEMoaXApIGFuZCBDKG5ldG1hc2spIGZvciBuZXR3b3JrIGNvbmZpZ3VyYXRpb24KICAgICAgICAgIC0gQWRkIGFuIG9wdGlvbmFsIEMoZ2F0ZXdheSkgZW50cnkgdG8gY29uZmlndXJlIGEgZ2F0ZXdheQogICAgICAgICAgLSBBZGQgYW4gb3B0aW9uYWwgQyhtYWMpIGVudHJ5IHRvIGN1c3RvbWl6ZSBtYWMgYWRkcmVzcwogICAgICAgICAgLSBBZGQgYW4gb3B0aW9uYWwgQyhkbnNfc2VydmVycykgb3IgQyhkb21haW4pIGVudHJ5IHBlciBpbnRlcmZhY2UgKFdpbmRvd3MpCiAgICAgICAgICAtIEFkZCBhbiBvcHRpb25hbCBDKGRldmljZV90eXBlKSB0byBjb25maWd1cmUgdGhlIHZpcnR1YWwgTklDIChwY25ldDMyLCB2bXhuZXQyLCB2bXhuZXQzLCBlMTAwMCwgZTEwMDBlKQogICAgICAgIHZlcnNpb25fYWRkZWQ6ICIyLjMiCiAgIGN1c3RvbWl6YXRpb246CiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAtICJQYXJhbWV0ZXJzIHRvIGN1c3RvbWl6ZSB0ZW1wbGF0ZSIKICAgICAgICAgIC0gIkNvbW1vbiBwYXJhbWV0ZXJzIChMaW51eC9XaW5kb3dzKToiCiAgICAgICAgICAtICIgIEMoZG5zX3NlcnZlcnMpIChsaXN0KTogTGlzdCBvZiBETlMgc2VydmVycyB0byBjb25maWd1cmUiCiAgICAgICAgICAtICIgIEMoZG5zX3N1ZmZpeCkgKGxpc3QpOiBMaXN0IG9mIGRvbWFpbiBzdWZmaXhlcywgYWthIEROUyBzZWFyY2ggcGF0aCAoZGVmYXVsdDogQyhkb21haW4pIHBhcmFtZXRlcikiCiAgICAgICAgICAtICIgIEMoZG9tYWluKSAoc3RyaW5nKTogRE5TIGRvbWFpbiBuYW1lIHRvIHVzZSIKICAgICAgICAgIC0gIiAgQyhob3N0bmFtZSkgKHN0cmluZyk6IENvbXB1dGVyIGhvc3RuYW1lIChkZWZhdWx0OiBDKG5hbWUpIHBhcmFtZXRlcikiCiAgICAgICAgICAtICJQYXJhbWV0ZXJzIHJlbGF0ZWQgdG8gd2luZG93cyBjdXN0b21pemF0aW9uOiIKICAgICAgICAgIC0gIiAgQyhhdXRvbG9nb24pIChib29sKTogQXV0byBsb2dvbiBhZnRlciBWTSBjdXN0b21pemF0aW9uIChkZWZhdWx0OiBGYWxzZSkiCiAgICAgICAgICAtICIgIEMoYXV0b2xvZ29uY291bnQpIChpbnQpOiBOdW1iZXIgb2YgYXV0b2xvZ29uIGFmdGVyIHJlYm9vdCAoZGVmYXVsdDogMSkiCiAgICAgICAgICAtICIgIEMoZG9tYWluYWRtaW4pIChzdHJpbmcpOiBVc2VyIHVzZWQgdG8gam9pbiBpbiBBRCBkb21haW4gKG1hbmRhdG9yeSB3aXRoIGpvaW5kb21haW4pIgogICAgICAgICAgLSAiICBDKGRvbWFpbmFkbWlucGFzc3dvcmQpIChzdHJpbmcpOiBQYXNzd29yZCB1c2VkIHRvIGpvaW4gaW4gQUQgZG9tYWluIChtYW5kYXRvcnkgd2l0aCBqb2luZG9tYWluKSIKICAgICAgICAgIC0gIiAgQyhmdWxsbmFtZSkgKHN0cmluZyk6IFNlcnZlciBvd25lciBuYW1lIChkZWZhdWx0OiBBZG1pbmlzdHJhdG9yKSIKICAgICAgICAgIC0gIiAgQyhqb2luZG9tYWluKSAoc3RyaW5nKTogQUQgZG9tYWluIHRvIGpvaW4gKE5vdCBjb21wYXRpYmxlIHdpdGggQyhqb2lud29ya2dyb3VwKSkiCiAgICAgICAgICAtICIgIEMoam9pbndvcmtncm91cCkgKHN0cmluZyk6IFdvcmtncm91cCB0byBqb2luIChOb3QgY29tcGF0aWJsZSB3aXRoIEMoam9pbmRvbWFpbiksIGRlZmF1bHQ6IFdPUktHUk9VUCkiCiAgICAgICAgICAtICIgIEMob3JnbmFtZSkgKHN0cmluZyk6IE9yZ2FuaXNhdGlvbiBuYW1lIChkZWZhdWx0OiBBQ01FKSIKICAgICAgICAgIC0gIiAgQyhwYXNzd29yZCkgKHN0cmluZyk6IExvY2FsIGFkbWluaXN0cmF0b3IgcGFzc3dvcmQgKG1hbmRhdG9yeSkiCiAgICAgICAgICAtICIgIEMocHJvZHVjdGlkKSAoc3RyaW5nKTogUHJvZHVjdCBJRCIKICAgICAgICAgIC0gIiAgQyhydW5vbmNlKSAobGlzdCk6IExpc3Qgb2YgY29tbWFuZHMgdG8gcnVuIGF0IGZpcnN0IHVzZXIgbG9nb24iCiAgICAgICAgICAtICIgIEModGltZXpvbmUpIChpbnQpOiBUaW1lem9uZSAoZGVmYXVsdDogODUpIFNlZSBVKGh0dHBzOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM5MTIzOTEodj13aW5lbWJlZGRlZC4xMSkuYXNweCkiCiAgICAgICAgdmVyc2lvbl9hZGRlZDogIjIuMyIKZXh0ZW5kc19kb2N1bWVudGF0aW9uX2ZyYWdtZW50OiB2bXdhcmUuZG9jdW1lbnRhdGlvbgonJycKCkVYQU1QTEVTID0gJycnCiMgQ3JlYXRlIGEgVk0gZnJvbSBhIHRlbXBsYXRlCiAgLSBuYW1lOiBjcmVhdGUgdGhlIFZNCiAgICB2bXdhcmVfZ3Vlc3Q6CiAgICAgIGhvc3RuYW1lOiAxOTIuMC4yLjQ0CiAgICAgIHVzZXJuYW1lOiBhZG1pbmlzdHJhdG9yQHZzcGhlcmUubG9jYWwKICAgICAgcGFzc3dvcmQ6IHZtd2FyZQogICAgICB2YWxpZGF0ZV9jZXJ0czogbm8KICAgICAgZXN4aV9ob3N0bmFtZTogMTkyLjAuMi4xMTcKICAgICAgZGF0YWNlbnRlcjogZGF0YWNlbnRlcjEKICAgICAgZm9sZGVyOiB0ZXN0dm1zCiAgICAgIG5hbWU6IHRlc3R2bV8yCiAgICAgIHN0YXRlOiBwb3dlcmVkb24KICAgICAgZ3Vlc3RfaWQ6IGNlbnRvczY0Z3Vlc3QKICAgICAgZGlzazoKICAgICAgLSBzaXplX2diOiAxMAogICAgICAgIHR5cGU6IHRoaW4KICAgICAgICBkYXRhc3RvcmU6IGc3M19kYXRhc3RvcmUKICAgICAgaGFyZHdhcmU6CiAgICAgICAgbWVtb3J5X21iOiA1MTIKICAgICAgICBudW1fY3B1czogMQogICAgICAgIHNjc2k6IHBhcmF2aXJ0dWFsCiAgICAgIG5ldHdvcmtzOgogICAgICAtIG5hbWU6IFZNIE5ldHdvcmsKICAgICAgICBpcDogMTkyLjE2OC4xLjEwMAogICAgICAgIG5ldG1hc2s6IDI1NS4yNTUuMjU1LjAKICAgICAgICBtYWM6ICdhYTpiYjpkZDphYTowMDoxNCcKICAgICAgdGVtcGxhdGU6IHRlbXBsYXRlX2VsNwogICAgICB3YWl0X2Zvcl9pcF9hZGRyZXNzOiB5ZXMKICAgIGRlbGVnYXRlX3RvOiBsb2NhbGhvc3QKICAgIHJlZ2lzdGVyOiBkZXBsb3kKCiMgQ2xvbmUgYSBWTSBmcm9tIFRlbXBsYXRlIGFuZCBjdXN0b21pemUKICAtIG5hbWU6IENsb25lIHRlbXBsYXRlIGFuZCBjdXN0b21pemUKICAgIHZtd2FyZV9ndWVzdDoKICAgICAgaG9zdG5hbWU6IDE5Mi4xNjguMS4yMDkKICAgICAgdXNlcm5hbWU6IGFkbWluaXN0cmF0b3JAdnNwaGVyZS5sb2NhbAogICAgICBwYXNzd29yZDogdm13YXJlCiAgICAgIHZhbGlkYXRlX2NlcnRzOiBubwogICAgICBkYXRhY2VudGVyOiBkYXRhY2VudGVyMQogICAgICBjbHVzdGVyOiBjbHVzdGVyCiAgICAgIG5hbWU6IHRlc3R2bS0yCiAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZV93aW5kb3dzCiAgICAgIG5ldHdvcmtzOgogICAgICAtIG5hbWU6IFZNIE5ldHdvcmsKICAgICAgICBpcDogMTkyLjE2OC4xLjEwMAogICAgICAgIG5ldG1hc2s6IDI1NS4yNTUuMjU1LjAKICAgICAgICBnYXRld2F5OiAxOTIuMTY4LjEuMQogICAgICAgIG1hYzogJ2FhOmJiOmRkOmFhOjAwOjE0JwogICAgICAgIGRvbWFpbjogbXlfZG9tYWluCiAgICAgICAgZG5zX3NlcnZlcnM6CiAgICAgICAgLSAxOTIuMTY4LjEuMQogICAgICAgIC0gMTkyLjE2OC4xLjIKICAgICAgY3VzdG9taXphdGlvbjoKICAgICAgICBhdXRvbG9nb246IFRydWUKICAgICAgICBkbnNfc2VydmVyczoKICAgICAgICAtIDE5Mi4xNjguMS4xCiAgICAgICAgLSAxOTIuMTY4LjEuMgogICAgICAgIGRvbWFpbjogbXlfZG9tYWluCiAgICAgICAgcGFzc3dvcmQ6IG5ld192bV9wYXNzd29yZAogICAgICAgIHJ1bm9uY2U6CiAgICAgICAgLSBwb3dlcnNoZWxsLmV4ZSAtRXhlY3V0aW9uUG9saWN5IFVucmVzdHJpY3RlZCAtRmlsZSBDOlxXaW5kb3dzXFRlbXBcRW5hYmxlLVdpblJNLnBzMSAtRm9yY2VOZXdTU0xDZXJ0CiAgICBkZWxlZ2F0ZV90bzogbG9jYWxob3N0CgojIENyZWF0ZSBhIFZNIHRlbXBsYXRlCiAgLSBuYW1lOiBjcmVhdGUgYSBWTSB0ZW1wbGF0ZQogICAgdm13YXJlX2d1ZXN0OgogICAgICBob3N0bmFtZTogMTkyLjAuMi44OAogICAgICB1c2VybmFtZTogYWRtaW5pc3RyYXRvckB2c3BoZXJlLmxvY2FsCiAgICAgIHBhc3N3b3JkOiB2bXdhcmUKICAgICAgdmFsaWRhdGVfY2VydHM6IG5vCiAgICAgIGRhdGFjZW50ZXI6IGRhdGFjZW50ZXIxCiAgICAgIGNsdXN0ZXI6IHZtd2FyZV9jbHVzdGVyX2VzeAogICAgICByZXNvdXJjZV9wb29sOiBoaWdocGVyZm9ybWFuY2VfcG9vbAogICAgICBmb2xkZXI6IHRlc3R2bXMKICAgICAgbmFtZTogdGVzdHZtXzYKICAgICAgaXNfdGVtcGxhdGU6IHllcwogICAgICBndWVzdF9pZDogZGViaWFuNl82NEd1ZXN0CiAgICAgIGRpc2s6CiAgICAgIC0gc2l6ZV9nYjogMTAKICAgICAgICB0eXBlOiB0aGluCiAgICAgICAgZGF0YXN0b3JlOiBnNzNfZGF0YXN0b3JlCiAgICAgIGhhcmR3YXJlOgogICAgICAgIG1lbW9yeV9tYjogNTEyCiAgICAgICAgbnVtX2NwdXM6IDEKICAgICAgICBzY3NpOiBsc2lsb2dpYwogICAgICB3YWl0X2Zvcl9pcF9hZGRyZXNzOiB5ZXMKICAgIGRlbGVnYXRlX3RvOiBsb2NhbGhvc3QKICAgIHJlZ2lzdGVyOiBkZXBsb3kKCiMgUmVuYW1lIGEgVk0gKHJlcXVpcmVzIHRoZSBWTSdzIHV1aWQpCiAgLSB2bXdhcmVfZ3Vlc3Q6CiAgICAgIGhvc3RuYW1lOiAxOTIuMTY4LjEuMjA5CiAgICAgIHVzZXJuYW1lOiBhZG1pbmlzdHJhdG9yQHZzcGhlcmUubG9jYWwKICAgICAgcGFzc3dvcmQ6IHZtd2FyZQogICAgICB1dWlkOiA0MjFlNDU5Mi1jMDY5LTkyNGQtY2UyMC03ZTc1MzNmYWI5MjYKICAgICAgbmFtZTogbmV3X25hbWUKICAgICAgc3RhdGU6IHByZXNlbnQKICAgIGRlbGVnYXRlX3RvOiBsb2NhbGhvc3QKCiMgUmVtb3ZlIGEgVk0gYnkgdXVpZAogIC0gdm13YXJlX2d1ZXN0OgogICAgICBob3N0bmFtZTogMTkyLjE2OC4xLjIwOQogICAgICB1c2VybmFtZTogYWRtaW5pc3RyYXRvckB2c3BoZXJlLmxvY2FsCiAgICAgIHBhc3N3b3JkOiB2bXdhcmUKICAgICAgdXVpZDogNDIxZTQ1OTItYzA2OS05MjRkLWNlMjAtN2U3NTMzZmFiOTI2CiAgICAgIHN0YXRlOiBhYnNlbnQKICAgIGRlbGVnYXRlX3RvOiBsb2NhbGhvc3QKJycnCgpSRVRVUk4gPSAiIiIKaW5zdGFuY2U6CiAgICBkZXNjcmlwdGlvbjogbWV0YWRhdGEgYWJvdXQgdGhlIG5ldyB2aXJ0dWFsbWFjaGluZQogICAgcmV0dXJuZWQ6IGFsd2F5cwogICAgdHlwZTogZGljdAogICAgc2FtcGxlOiBOb25lCiIiIgoKaW1wb3J0IG9zCmltcG9ydCB0aW1lCgojIGltcG9ydCBtb2R1bGUgc25pcHBldHMKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5iYXNpYyBpbXBvcnQgQW5zaWJsZU1vZHVsZQpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnB5Y29tcGF0MjQgaW1wb3J0IGdldF9leGNlcHRpb24KZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IGl0ZXJpdGVtcwpmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnVybHMgaW1wb3J0IGZldGNoX3VybApmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnZtd2FyZSBpbXBvcnQgZ2V0X2FsbF9vYmpzLCBjb25uZWN0X3RvX2FwaSwgZ2F0aGVyX3ZtX2ZhY3RzCgp0cnk6CiAgICBpbXBvcnQganNvbgpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBpbXBvcnQgc2ltcGxlanNvbiBhcyBqc29uCgpIQVNfUFlWTU9NSSA9IEZhbHNlCnRyeToKICAgIGltcG9ydCBweVZtb21pCiAgICBmcm9tIHB5Vm1vbWkgaW1wb3J0IHZpbQoKICAgIEhBU19QWVZNT01JID0gVHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBwYXNzCgoKY2xhc3MgUHlWbW9taURldmljZUhlbHBlcihvYmplY3QpOgogICAgIiIiIFRoaXMgY2xhc3MgaXMgYSBoZWxwZXIgdG8gY3JlYXRlIGVhc2lseSBWTVdhcmUgT2JqZWN0cyBmb3IgUHlWbW9taUhlbHBlciAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbW9kdWxlKToKICAgICAgICBzZWxmLm1vZHVsZSA9IG1vZHVsZQogICAgICAgIHNlbGYubmV4dF9kaXNrX3VuaXRfbnVtYmVyID0gMAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBjcmVhdGVfc2NzaV9jb250cm9sbGVyKHNjc2lfdHlwZSk6CiAgICAgICAgc2NzaV9jdGwgPSB2aW0udm0uZGV2aWNlLlZpcnR1YWxEZXZpY2VTcGVjKCkKICAgICAgICBzY3NpX2N0bC5vcGVyYXRpb24gPSB2aW0udm0uZGV2aWNlLlZpcnR1YWxEZXZpY2VTcGVjLk9wZXJhdGlvbi5hZGQKICAgICAgICBpZiBzY3NpX3R5cGUgPT0gJ2xzaWxvZ2ljJzoKICAgICAgICAgICAgc2NzaV9jdGwuZGV2aWNlID0gdmltLnZtLmRldmljZS5WaXJ0dWFsTHNpTG9naWNDb250cm9sbGVyKCkKICAgICAgICBlbGlmIHNjc2lfdHlwZSA9PSAncGFyYXZpcnR1YWwnOgogICAgICAgICAgICBzY3NpX2N0bC5kZXZpY2UgPSB2aW0udm0uZGV2aWNlLlBhcmFWaXJ0dWFsU0NTSUNvbnRyb2xsZXIoKQogICAgICAgIGVsaWYgc2NzaV90eXBlID09ICdidXNsb2dpYyc6CiAgICAgICAgICAgIHNjc2lfY3RsLmRldmljZSA9IHZpbS52bS5kZXZpY2UuVmlydHVhbEJ1c0xvZ2ljQ29udHJvbGxlcigpCiAgICAgICAgZWxpZiBzY3NpX3R5cGUgPT0gJ2xzaWxvZ2ljc2FzJzoKICAgICAgICAgICAgc2NzaV9jdGwuZGV2aWNlID0gdmltLnZtLmRldmljZS5WaXJ0dWFsTHNpTG9naWNTQVNDb250cm9sbGVyKCkKCiAgICAgICAgc2NzaV9jdGwuZGV2aWNlLmRldmljZUluZm8gPSB2aW0uRGVzY3JpcHRpb24oKQogICAgICAgIHNjc2lfY3RsLmRldmljZS5zbG90SW5mbyA9IHZpbS52bS5kZXZpY2UuVmlydHVhbERldmljZS5QY2lCdXNTbG90SW5mbygpCiAgICAgICAgc2NzaV9jdGwuZGV2aWNlLnNsb3RJbmZvLnBjaVNsb3ROdW1iZXIgPSAxNgogICAgICAgIHNjc2lfY3RsLmRldmljZS5jb250cm9sbGVyS2V5ID0gMTAwCiAgICAgICAgc2NzaV9jdGwuZGV2aWNlLnVuaXROdW1iZXIgPSAzCiAgICAgICAgc2NzaV9jdGwuZGV2aWNlLmJ1c051bWJlciA9IDAKICAgICAgICBzY3NpX2N0bC5kZXZpY2UuaG90QWRkUmVtb3ZlID0gVHJ1ZQogICAgICAgIHNjc2lfY3RsLmRldmljZS5zaGFyZWRCdXMgPSAnbm9TaGFyaW5nJwogICAgICAgIHNjc2lfY3RsLmRldmljZS5zY3NpQ3RsclVuaXROdW1iZXIgPSA3CgogICAgICAgIHJldHVybiBzY3NpX2N0bAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBpc19zY3NpX2NvbnRyb2xsZXIoZGV2aWNlKToKICAgICAgICByZXR1cm4gaXNpbnN0YW5jZShkZXZpY2UsIHZpbS52bS5kZXZpY2UuVmlydHVhbExzaUxvZ2ljQ29udHJvbGxlcikgb3IgXAogICAgICAgICAgICBpc2luc3RhbmNlKGRldmljZSwgdmltLnZtLmRldmljZS5QYXJhVmlydHVhbFNDU0lDb250cm9sbGVyKSBvciBcCiAgICAgICAgICAgIGlzaW5zdGFuY2UoZGV2aWNlLCB2aW0udm0uZGV2aWNlLlZpcnR1YWxCdXNMb2dpY0NvbnRyb2xsZXIpIG9yIFwKICAgICAgICAgICAgaXNpbnN0YW5jZShkZXZpY2UsIHZpbS52bS5kZXZpY2UuVmlydHVhbExzaUxvZ2ljU0FTQ29udHJvbGxlcikKCiAgICBkZWYgY3JlYXRlX3Njc2lfZGlzayhzZWxmLCBzY3NpX2N0bCwgZGlza19pbmRleD1Ob25lKToKICAgICAgICBkaXNrc3BlYyA9IHZpbS52bS5kZXZpY2UuVmlydHVhbERldmljZVNwZWMoKQogICAgICAgIGRpc2tzcGVjLm9wZXJhdGlvbiA9IHZpbS52bS5kZXZpY2UuVmlydHVhbERldmljZVNwZWMuT3BlcmF0aW9uLmFkZAogICAgICAgIGRpc2tzcGVjLmZpbGVPcGVyYXRpb24gPSB2aW0udm0uZGV2aWNlLlZpcnR1YWxEZXZpY2VTcGVjLkZpbGVPcGVyYXRpb24uY3JlYXRlCiAgICAgICAgZGlza3NwZWMuZGV2aWNlID0gdmltLnZtLmRldmljZS5WaXJ0dWFsRGlzaygpCiAgICAgICAgZGlza3NwZWMuZGV2aWNlLmJhY2tpbmcgPSB2aW0udm0uZGV2aWNlLlZpcnR1YWxEaXNrLkZsYXRWZXIyQmFja2luZ0luZm8oKQogICAgICAgIGRpc2tzcGVjLmRldmljZS5iYWNraW5nLmRpc2tNb2RlID0gJ3BlcnNpc3RlbnQnCiAgICAgICAgZGlza3NwZWMuZGV2aWNlLmNvbnRyb2xsZXJLZXkgPSBzY3NpX2N0bC5kZXZpY2Uua2V5CgogICAgICAgIGFzc2VydCBzZWxmLm5leHRfZGlza191bml0X251bWJlciAhPSA3CiAgICAgICAgYXNzZXJ0IGRpc2tfaW5kZXggIT0gNwogICAgICAgICIiIgogICAgICAgIENvbmZpZ3VyZSBkaXNrIHVuaXQgbnVtYmVyLgogICAgICAgICIiIgogICAgICAgIGlmIGRpc2tfaW5kZXggaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGRpc2tzcGVjLmRldmljZS51bml0TnVtYmVyID0gZGlza19pbmRleAogICAgICAgICAgICBzZWxmLm5leHRfZGlza191bml0X251bWJlciA9IGRpc2tfaW5kZXggKyAxCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZGlza3NwZWMuZGV2aWNlLnVuaXROdW1iZXIgPSBzZWxmLm5leHRfZGlza191bml0X251bWJlcgogICAgICAgICAgICBzZWxmLm5leHRfZGlza191bml0X251bWJlciArPSAxCgogICAgICAgICMgdW5pdCBudW1iZXIgNyBpcyByZXNlcnZlZCB0byBTQ1NJIGNvbnRyb2xsZXIsIGluY3JlYXNlIG5leHQgaW5kZXgKICAgICAgICBpZiBzZWxmLm5leHRfZGlza191bml0X251bWJlciA9PSA3OgogICAgICAgICAgICBzZWxmLm5leHRfZGlza191bml0X251bWJlciArPSAxCgogICAgICAgIHJldHVybiBkaXNrc3BlYwoKICAgIGRlZiBjcmVhdGVfbmljKHNlbGYsIGRldmljZV90eXBlLCBkZXZpY2VfbGFiZWwsIGRldmljZV9pbmZvcyk6CiAgICAgICAgbmljID0gdmltLnZtLmRldmljZS5WaXJ0dWFsRGV2aWNlU3BlYygpCiAgICAgICAgaWYgZGV2aWNlX3R5cGUgPT0gJ3BjbmV0MzInOgogICAgICAgICAgICBuaWMuZGV2aWNlID0gdmltLnZtLmRldmljZS5WaXJ0dWFsUENOZXQzMigpCiAgICAgICAgZWxpZiBkZXZpY2VfdHlwZSA9PSAndm14bmV0Mic6CiAgICAgICAgICAgIG5pYy5kZXZpY2UgPSB2aW0udm0uZGV2aWNlLlZpcnR1YWxWbXhuZXQyKCkKICAgICAgICBlbGlmIGRldmljZV90eXBlID09ICd2bXhuZXQzJzoKICAgICAgICAgICAgbmljLmRldmljZSA9IHZpbS52bS5kZXZpY2UuVmlydHVhbFZteG5ldDMoKQogICAgICAgIGVsaWYgZGV2aWNlX3R5cGUgPT0gJ2UxMDAwJzoKICAgICAgICAgICAgbmljLmRldmljZSA9IHZpbS52bS5kZXZpY2UuVmlydHVhbEUxMDAwKCkKICAgICAgICBlbGlmIGRldmljZV90eXBlID09ICdlMTAwMGUnOgogICAgICAgICAgICBuaWMuZGV2aWNlID0gdmltLnZtLmRldmljZS5WaXJ0dWFsRTEwMDBlKCkKICAgICAgICBlbGlmIGRldmljZV90eXBlID09ICdzcmlvdic6CiAgICAgICAgICAgIG5pYy5kZXZpY2UgPSB2aW0udm0uZGV2aWNlLlZpcnR1YWxTcmlvdkV0aGVybmV0Q2FyZCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iSW52YWxpZCBkZXZpY2VfdHlwZSAnJXMnIGZvciBuZXR3b3JrICVzIiAlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGRldmljZV90eXBlLCBkZXZpY2VfaW5mb3NbJ25hbWUnXSkpCgogICAgICAgIG5pYy5kZXZpY2Uud2FrZU9uTGFuRW5hYmxlZCA9IFRydWUKICAgICAgICBuaWMuZGV2aWNlLmRldmljZUluZm8gPSB2aW0uRGVzY3JpcHRpb24oKQogICAgICAgIG5pYy5kZXZpY2UuZGV2aWNlSW5mby5sYWJlbCA9IGRldmljZV9sYWJlbAogICAgICAgIG5pYy5kZXZpY2UuZGV2aWNlSW5mby5zdW1tYXJ5ID0gZGV2aWNlX2luZm9zWyduYW1lJ10KICAgICAgICBuaWMuZGV2aWNlLmNvbm5lY3RhYmxlID0gdmltLnZtLmRldmljZS5WaXJ0dWFsRGV2aWNlLkNvbm5lY3RJbmZvKCkKICAgICAgICBuaWMuZGV2aWNlLmNvbm5lY3RhYmxlLnN0YXJ0Q29ubmVjdGVkID0gVHJ1ZQogICAgICAgIG5pYy5kZXZpY2UuY29ubmVjdGFibGUuYWxsb3dHdWVzdENvbnRyb2wgPSBUcnVlCiAgICAgICAgbmljLmRldmljZS5jb25uZWN0YWJsZS5jb25uZWN0ZWQgPSBUcnVlCiAgICAgICAgaWYgJ21hYycgaW4gZGV2aWNlX2luZm9zOgogICAgICAgICAgICBuaWMuZGV2aWNlLmFkZHJlc3NUeXBlID0gJ2Fzc2lnbmVkJwogICAgICAgICAgICBuaWMuZGV2aWNlLm1hY0FkZHJlc3MgPSBkZXZpY2VfaW5mb3NbJ21hYyddCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbmljLmRldmljZS5hZGRyZXNzVHlwZSA9ICdnZW5lcmF0ZWQnCgogICAgICAgIHJldHVybiBuaWMKCgpjbGFzcyBQeVZtb21pQ2FjaGUob2JqZWN0KToKICAgICIiIiBUaGlzIGNsYXNzIGNhY2hlcyByZWZlcmVuY2VzIHRvIG9iamVjdHMgd2hpY2ggYXJlIHJlcXVlc3RlZCBtdWx0aXBsZXMgdGltZXMgYnV0IG5vdCBtb2RpZmllZCAiIiIKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb250ZW50KToKICAgICAgICBzZWxmLmNvbnRlbnQgPSBjb250ZW50CiAgICAgICAgc2VsZi5uZXR3b3JrcyA9IHt9CiAgICAgICAgc2VsZi5jbHVzdGVycyA9IHt9CiAgICAgICAgc2VsZi5lc3hfaG9zdHMgPSB7fQoKICAgIGRlZiBnZXRfbmV0d29yayhzZWxmLCBuZXR3b3JrKToKICAgICAgICBpZiBuZXR3b3JrIG5vdCBpbiBzZWxmLm5ldHdvcmtzOgogICAgICAgICAgICBzZWxmLm5ldHdvcmtzW25ldHdvcmtdID0gZ2V0X29iaihzZWxmLmNvbnRlbnQsIFt2aW0uTmV0d29ya10sIG5ldHdvcmspCgogICAgICAgIHJldHVybiBzZWxmLm5ldHdvcmtzW25ldHdvcmtdCgogICAgZGVmIGdldF9jbHVzdGVyKHNlbGYsIGNsdXN0ZXIpOgogICAgICAgIGlmIGNsdXN0ZXIgbm90IGluIHNlbGYuY2x1c3RlcnM6CiAgICAgICAgICAgIHNlbGYuY2x1c3RlcnNbY2x1c3Rlcl0gPSBnZXRfb2JqKHNlbGYuY29udGVudCwgW3ZpbS5DbHVzdGVyQ29tcHV0ZVJlc291cmNlXSwgY2x1c3RlcikKCiAgICAgICAgcmV0dXJuIHNlbGYuY2x1c3RlcnNbY2x1c3Rlcl0KCiAgICBkZWYgZ2V0X2VzeF9ob3N0KHNlbGYsIGhvc3QpOgogICAgICAgIGlmIGhvc3Qgbm90IGluIHNlbGYuZXN4X2hvc3RzOgogICAgICAgICAgICBzZWxmLmVzeF9ob3N0c1tob3N0XSA9IGdldF9vYmooc2VsZi5jb250ZW50LCBbdmltLkhvc3RTeXN0ZW1dLCBob3N0KQoKICAgICAgICByZXR1cm4gc2VsZi5lc3hfaG9zdHNbaG9zdF0KCgpjbGFzcyBQeVZtb21pSGVscGVyKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgbW9kdWxlKToKICAgICAgICBpZiBub3QgSEFTX1BZVk1PTUk6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24obXNnPSdweXZtb21pIG1vZHVsZSByZXF1aXJlZCcpCgogICAgICAgIHNlbGYubW9kdWxlID0gbW9kdWxlCiAgICAgICAgc2VsZi5kZXZpY2VfaGVscGVyID0gUHlWbW9taURldmljZUhlbHBlcihzZWxmLm1vZHVsZSkKICAgICAgICBzZWxmLnBhcmFtcyA9IG1vZHVsZS5wYXJhbXMKICAgICAgICBzZWxmLnNpID0gTm9uZQogICAgICAgIHNlbGYuY29udGVudCA9IGNvbm5lY3RfdG9fYXBpKHNlbGYubW9kdWxlKQogICAgICAgIHNlbGYuY29uZmlnc3BlYyA9IE5vbmUKICAgICAgICBzZWxmLmNoYW5nZV9kZXRlY3RlZCA9IEZhbHNlCiAgICAgICAgc2VsZi5jdXN0b21zcGVjID0gTm9uZQogICAgICAgIHNlbGYuY3VycmVudF92bV9vYmogPSBOb25lCiAgICAgICAgc2VsZi5jYWNoZSA9IFB5Vm1vbWlDYWNoZShzZWxmLmNvbnRlbnQpCgogICAgZGVmIHNob3VsZF9kZXBsb3lfZnJvbV90ZW1wbGF0ZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5wYXJhbXMuZ2V0KCd0ZW1wbGF0ZScpIGlzIG5vdCBOb25lCgogICAgZGVmIGdldHZtKHNlbGYsIG5hbWU9Tm9uZSwgdXVpZD1Ob25lLCBmb2xkZXI9Tm9uZSk6CgogICAgICAgICMgaHR0cHM6Ly93d3cudm13YXJlLmNvbS9zdXBwb3J0L2RldmVsb3Blci92Yy1zZGsvdmlzZGsyeHB1YnMvUmVmZXJlbmNlR3VpZGUvdmltLlNlYXJjaEluZGV4Lmh0bWwKICAgICAgICAjIHNlbGYuc2kuY29udGVudC5zZWFyY2hJbmRleC5GaW5kQnlJbnZlbnRvcnlQYXRoKCdEQzEvdm0vdGVzdF9mb2xkZXInKQoKICAgICAgICB2bSA9IE5vbmUKICAgICAgICBzZWFyY2hwYXRoID0gTm9uZQoKICAgICAgICBpZiB1dWlkOgogICAgICAgICAgICB2bSA9IHNlbGYuY29udGVudC5zZWFyY2hJbmRleC5GaW5kQnlVdWlkKHV1aWQ9dXVpZCwgdm1TZWFyY2g9VHJ1ZSkKICAgICAgICBlbGlmIGZvbGRlcjoKICAgICAgICAgICAgIyBCdWlsZCB0aGUgYWJzb2x1dGUgZm9sZGVyIHBhdGggdG8gcGFzcyBpbnRvIHRoZSBzZWFyY2ggbWV0aG9kCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLnBhcmFtc1snZm9sZGVyJ10uc3RhcnRzd2l0aCgnLycpOgogICAgICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iRm9sZGVyICUoZm9sZGVyKXMgbmVlZHMgdG8gYmUgYW4gYWJzb2x1dGUgcGF0aCwgc3RhcnRpbmcgd2l0aCAnLycuIiAlIHNlbGYucGFyYW1zKQogICAgICAgICAgICBzZWFyY2hwYXRoID0gJyUoZGF0YWNlbnRlcilzJShmb2xkZXIpcycgJSBzZWxmLnBhcmFtcwoKICAgICAgICAgICAgIyBnZXQgYWxsIG9iamVjdHMgZm9yIHRoaXMgcGF0aCAuLi4KICAgICAgICAgICAgZl9vYmogPSBzZWxmLmNvbnRlbnQuc2VhcmNoSW5kZXguRmluZEJ5SW52ZW50b3J5UGF0aChzZWFyY2hwYXRoKQogICAgICAgICAgICBpZiBmX29iajoKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZl9vYmosIHZpbS5EYXRhY2VudGVyKToKICAgICAgICAgICAgICAgICAgICBmX29iaiA9IGZfb2JqLnZtRm9sZGVyCiAgICAgICAgICAgICAgICBmb3IgY19vYmogaW4gZl9vYmouY2hpbGRFbnRpdHk6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoY19vYmosIHZpbS5WaXJ0dWFsTWFjaGluZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgaWYgY19vYmoubmFtZSA9PSBuYW1lOgogICAgICAgICAgICAgICAgICAgICAgICB2bSA9IGNfb2JqCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYucGFyYW1zWyduYW1lX21hdGNoJ10gPT0gJ2ZpcnN0JzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIGlmIHZtOgogICAgICAgICAgICBzZWxmLmN1cnJlbnRfdm1fb2JqID0gdm0KCiAgICAgICAgcmV0dXJuIHZtCgogICAgZGVmIHNldF9wb3dlcnN0YXRlKHNlbGYsIHZtLCBzdGF0ZSwgZm9yY2UpOgogICAgICAgICIiIgogICAgICAgIFNldCB0aGUgcG93ZXIgc3RhdHVzIGZvciBhIFZNIGRldGVybWluZWQgYnkgdGhlIGN1cnJlbnQgYW5kCiAgICAgICAgcmVxdWVzdGVkIHN0YXRlcy4gZm9yY2UgaXMgZm9yY2VmdWwKICAgICAgICAiIiIKICAgICAgICBmYWN0cyA9IHNlbGYuZ2F0aGVyX2ZhY3RzKHZtKQogICAgICAgIGV4cGVjdGVkX3N0YXRlID0gc3RhdGUucmVwbGFjZSgnXycsICcnKS5sb3dlcigpCiAgICAgICAgY3VycmVudF9zdGF0ZSA9IGZhY3RzWydod19wb3dlcl9zdGF0dXMnXS5sb3dlcigpCiAgICAgICAgcmVzdWx0ID0gZGljdCgKICAgICAgICAgICAgY2hhbmdlZD1GYWxzZSwKICAgICAgICAgICAgZmFpbGVkPUZhbHNlLAogICAgICAgICkKCiAgICAgICAgIyBOZWVkIEZvcmNlCiAgICAgICAgaWYgbm90IGZvcmNlIGFuZCBjdXJyZW50X3N0YXRlIG5vdCBpbiBbJ3Bvd2VyZWRvbicsICdwb3dlcmVkb2ZmJ106CiAgICAgICAgICAgIHJlc3VsdFsnZmFpbGVkJ10gPSBUcnVlCiAgICAgICAgICAgIHJlc3VsdFsnbXNnJ10gPSAiVk0gaXMgaW4gJXMgcG93ZXIgc3RhdGUuIEZvcmNlIGlzIHJlcXVpcmVkISIgJSBjdXJyZW50X3N0YXRlCiAgICAgICAgICAgIHJldHVybiByZXN1bHQKCiAgICAgICAgIyBTdGF0ZSBpcyBub3QgYWxyZWFkeSB0cnVlCiAgICAgICAgaWYgY3VycmVudF9zdGF0ZSAhPSBleHBlY3RlZF9zdGF0ZToKICAgICAgICAgICAgdGFzayA9IE5vbmUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgZXhwZWN0ZWRfc3RhdGUgPT0gJ3Bvd2VyZWRvZmYnOgogICAgICAgICAgICAgICAgICAgIHRhc2sgPSB2bS5Qb3dlck9mZigpCgogICAgICAgICAgICAgICAgZWxpZiBleHBlY3RlZF9zdGF0ZSA9PSAncG93ZXJlZG9uJzoKICAgICAgICAgICAgICAgICAgICB0YXNrID0gdm0uUG93ZXJPbigpCgogICAgICAgICAgICAgICAgZWxpZiBleHBlY3RlZF9zdGF0ZSA9PSAncmVzdGFydGVkJzoKICAgICAgICAgICAgICAgICAgICBpZiBjdXJyZW50X3N0YXRlIGluICgncG93ZXJlZG9uJywgJ3Bvd2VyaW5nb24nLCAncmVzZXR0aW5nJywgJ3Bvd2VyZWRvZmYnKToKICAgICAgICAgICAgICAgICAgICAgICAgdGFzayA9IHZtLlJlc2V0KCkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbJ2ZhaWxlZCddID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbJ21zZyddID0gIkNhbm5vdCByZXN0YXJ0IFZNIGluIHRoZSBjdXJyZW50IHN0YXRlICVzIiAlIGN1cnJlbnRfc3RhdGUKCiAgICAgICAgICAgICAgICBlbGlmIGV4cGVjdGVkX3N0YXRlID09ICdzdXNwZW5kZWQnOgogICAgICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfc3RhdGUgaW4gKCdwb3dlcmVkb24nLCAncG93ZXJpbmdvbicpOgogICAgICAgICAgICAgICAgICAgICAgICB0YXNrID0gdm0uU3VzcGVuZCgpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0WydmYWlsZWQnXSA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Wydtc2cnXSA9ICdDYW5ub3Qgc3VzcGVuZCBWTSBpbiB0aGUgY3VycmVudCBzdGF0ZSAlcycgJSBjdXJyZW50X3N0YXRlCgogICAgICAgICAgICAgICAgZWxpZiBleHBlY3RlZF9zdGF0ZSBpbiBbJ3NodXRkb3duZ3Vlc3QnLCAncmVib290Z3Vlc3QnXToKICAgICAgICAgICAgICAgICAgICBpZiBjdXJyZW50X3N0YXRlID09ICdwb3dlcmVkb24nIGFuZCB2bS5ndWVzdC50b29sc1J1bm5pbmdTdGF0dXMgPT0gJ2d1ZXN0VG9vbHNSdW5uaW5nJzoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZXhwZWN0ZWRfc3RhdGUgPT0gJ3NodXRkb3duZ3Vlc3QnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzayA9IHZtLlNodXRkb3duR3Vlc3QoKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzayA9IHZtLlJlYm9vdEd1ZXN0KCkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbJ2ZhaWxlZCddID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbJ21zZyddID0gIlZNICVzIG11c3QgYmUgaW4gcG93ZXJlZG9uIHN0YXRlICYgdG9vbHMgc2hvdWxkIGJlIGluc3RhbGxlZCBmb3IgZ3Vlc3Qgc2h1dGRvd24vcmVib290IiAlIHZtLm5hbWUKCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICByZXN1bHRbJ2ZhaWxlZCddID0gVHJ1ZQogICAgICAgICAgICAgICAgcmVzdWx0Wydtc2cnXSA9IHN0cihlKQoKICAgICAgICAgICAgaWYgdGFzazoKICAgICAgICAgICAgICAgIHNlbGYud2FpdF9mb3JfdGFzayh0YXNrKQogICAgICAgICAgICAgICAgaWYgdGFzay5pbmZvLnN0YXRlID09ICdlcnJvcic6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0WydmYWlsZWQnXSA9IFRydWUKICAgICAgICAgICAgICAgICAgICByZXN1bHRbJ21zZyddID0gc3RyKHRhc2suaW5mby5lcnJvci5tc2cpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdFsnY2hhbmdlZCddID0gVHJ1ZQoKICAgICAgICAjIG5lZWQgdG8gZ2V0IG5ldyBtZXRhZGF0YSBpZiBjaGFuZ2VkCiAgICAgICAgaWYgcmVzdWx0WydjaGFuZ2VkJ106CiAgICAgICAgICAgIG5ld3ZtID0gc2VsZi5nZXR2bSh1dWlkPXZtLmNvbmZpZy51dWlkKQogICAgICAgICAgICBmYWN0cyA9IHNlbGYuZ2F0aGVyX2ZhY3RzKG5ld3ZtKQogICAgICAgICAgICByZXN1bHRbJ2luc3RhbmNlJ10gPSBmYWN0cwoKICAgICAgICByZXR1cm4gcmVzdWx0CgogICAgZGVmIGdhdGhlcl9mYWN0cyhzZWxmLCB2bSk6CiAgICAgICAgcmV0dXJuIGdhdGhlcl92bV9mYWN0cyhzZWxmLmNvbnRlbnQsIHZtKQoKICAgIGRlZiByZW1vdmVfdm0oc2VsZiwgdm0pOgogICAgICAgICMgaHR0cHM6Ly93d3cudm13YXJlLmNvbS9zdXBwb3J0L2RldmVsb3Blci9jb252ZXJ0ZXItc2RrL2NvbnY2MF9hcGlyZWZlcmVuY2UvdmltLk1hbmFnZWRFbnRpdHkuaHRtbCNkZXN0cm95CiAgICAgICAgdGFzayA9IHZtLkRlc3Ryb3koKQogICAgICAgIHNlbGYud2FpdF9mb3JfdGFzayh0YXNrKQoKICAgICAgICBpZiB0YXNrLmluZm8uc3RhdGUgPT0gJ2Vycm9yJzoKICAgICAgICAgICAgcmV0dXJuIHsnY2hhbmdlZCc6IEZhbHNlLCAnZmFpbGVkJzogVHJ1ZSwgJ21zZyc6IHRhc2suaW5mby5lcnJvci5tc2d9CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHsnY2hhbmdlZCc6IFRydWUsICdmYWlsZWQnOiBGYWxzZX0KCiAgICBkZWYgY29uZmlndXJlX2d1ZXN0aWQoc2VsZiwgdm1fb2JqLCB2bV9jcmVhdGlvbj1GYWxzZSk6CiAgICAgICAgIyBndWVzdF9pZCBpcyBub3QgcmVxdWlyZWQgd2hlbiB1c2luZyB0ZW1wbGF0ZXMKICAgICAgICBpZiBzZWxmLnNob3VsZF9kZXBsb3lfZnJvbV90ZW1wbGF0ZSgpIGFuZCBzZWxmLnBhcmFtcy5nZXQoJ2d1ZXN0X2lkJykgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgZ3Vlc3RfaWQgaXMgb25seSBtYW5kYXRvcnkgb24gVk0gY3JlYXRpb24KICAgICAgICBpZiB2bV9jcmVhdGlvbiBhbmQgc2VsZi5wYXJhbXNbJ2d1ZXN0X2lkJ10gaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iZ3Vlc3RfaWQgYXR0cmlidXRlIGlzIG1hbmRhdG9yeSBmb3IgVk0gY3JlYXRpb24iKQoKICAgICAgICBpZiB2bV9vYmogaXMgTm9uZSBvciBzZWxmLnBhcmFtc1snZ3Vlc3RfaWQnXSAhPSB2bV9vYmouc3VtbWFyeS5jb25maWcuZ3Vlc3RJZDoKICAgICAgICAgICAgc2VsZi5jaGFuZ2VfZGV0ZWN0ZWQgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuY29uZmlnc3BlYy5ndWVzdElkID0gc2VsZi5wYXJhbXNbJ2d1ZXN0X2lkJ10KCiAgICBkZWYgY29uZmlndXJlX2NwdV9hbmRfbWVtb3J5KHNlbGYsIHZtX29iaiwgdm1fY3JlYXRpb249RmFsc2UpOgogICAgICAgICMgc2V0IGNwdS9tZW1vcnkvZXRjCiAgICAgICAgaWYgJ2hhcmR3YXJlJyBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgaWYgJ251bV9jcHVzJyBpbiBzZWxmLnBhcmFtc1snaGFyZHdhcmUnXToKICAgICAgICAgICAgICAgIHNlbGYuY29uZmlnc3BlYy5udW1DUFVzID0gaW50KHNlbGYucGFyYW1zWydoYXJkd2FyZSddWydudW1fY3B1cyddKQogICAgICAgICAgICAgICAgaWYgdm1fb2JqIGlzIE5vbmUgb3Igc2VsZi5jb25maWdzcGVjLm51bUNQVXMgIT0gdm1fb2JqLmNvbmZpZy5oYXJkd2FyZS5udW1DUFU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jaGFuZ2VfZGV0ZWN0ZWQgPSBUcnVlCiAgICAgICAgICAgICMgbnVtX2NwdSBpcyBtYW5kYXRvcnkgZm9yIFZNIGNyZWF0aW9uCiAgICAgICAgICAgIGVsaWYgdm1fY3JlYXRpb24gYW5kIG5vdCBzZWxmLnNob3VsZF9kZXBsb3lfZnJvbV90ZW1wbGF0ZSgpOgogICAgICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iaGFyZHdhcmUubnVtX2NwdXMgYXR0cmlidXRlIGlzIG1hbmRhdG9yeSBmb3IgVk0gY3JlYXRpb24iKQoKICAgICAgICAgICAgaWYgJ21lbW9yeV9tYicgaW4gc2VsZi5wYXJhbXNbJ2hhcmR3YXJlJ106CiAgICAgICAgICAgICAgICBzZWxmLmNvbmZpZ3NwZWMubWVtb3J5TUIgPSBpbnQoc2VsZi5wYXJhbXNbJ2hhcmR3YXJlJ11bJ21lbW9yeV9tYiddKQogICAgICAgICAgICAgICAgaWYgdm1fb2JqIGlzIE5vbmUgb3Igc2VsZi5jb25maWdzcGVjLm1lbW9yeU1CICE9IHZtX29iai5jb25maWcuaGFyZHdhcmUubWVtb3J5TUI6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jaGFuZ2VfZGV0ZWN0ZWQgPSBUcnVlCiAgICAgICAgICAgICMgbWVtb3J5X21iIGlzIG1hbmRhdG9yeSBmb3IgVk0gY3JlYXRpb24KICAgICAgICAgICAgZWxpZiB2bV9jcmVhdGlvbiBhbmQgbm90IHNlbGYuc2hvdWxkX2RlcGxveV9mcm9tX3RlbXBsYXRlKCk6CiAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSJoYXJkd2FyZS5tZW1vcnlfbWIgYXR0cmlidXRlIGlzIG1hbmRhdG9yeSBmb3IgVk0gY3JlYXRpb24iKQoKCiAgICBkZWYgZ2V0X3ZtX25ldHdvcmtfaW50ZXJmYWNlcyhzZWxmLCB2bT1Ob25lKToKICAgICAgICBpZiB2bSBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gW10KCiAgICAgICAgZGV2aWNlX2xpc3QgPSBbXQogICAgICAgIGZvciBkZXZpY2UgaW4gdm0uY29uZmlnLmhhcmR3YXJlLmRldmljZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkZXZpY2UsIHZpbS52bS5kZXZpY2UuVmlydHVhbFBDTmV0MzIpIG9yIFwKICAgICAgICAgICAgICAgaXNpbnN0YW5jZShkZXZpY2UsIHZpbS52bS5kZXZpY2UuVmlydHVhbFZteG5ldDIpIG9yIFwKICAgICAgICAgICAgICAgaXNpbnN0YW5jZShkZXZpY2UsIHZpbS52bS5kZXZpY2UuVmlydHVhbFZteG5ldDMpIG9yIFwKICAgICAgICAgICAgICAgaXNpbnN0YW5jZShkZXZpY2UsIHZpbS52bS5kZXZpY2UuVmlydHVhbEUxMDAwKSBvciBcCiAgICAgICAgICAgICAgIGlzaW5zdGFuY2UoZGV2aWNlLCB2aW0udm0uZGV2aWNlLlZpcnR1YWxFMTAwMGUpIG9yIFwKICAgICAgICAgICAgICAgaXNpbnN0YW5jZShkZXZpY2UsIHZpbS52bS5kZXZpY2UuVmlydHVhbFNyaW92RXRoZXJuZXRDYXJkKToKICAgICAgICAgICAgICAgIGRldmljZV9saXN0LmFwcGVuZChkZXZpY2UpCgogICAgICAgIHJldHVybiBkZXZpY2VfbGlzdAoKICAgIGRlZiBjb25maWd1cmVfbmV0d29yayhzZWxmLCB2bV9vYmopOgogICAgICAgICMgSWdub3JlIGVtcHR5IG5ldHdvcmtzLCB0aGlzIHBlcm1pdHMgdG8ga2VlcCBuZXR3b3JrcyB3aGVuIGRlcGxveWluZyBhIHRlbXBsYXRlL2Nsb25pbmcgYSBWTQogICAgICAgIGlmIGxlbihzZWxmLnBhcmFtc1snbmV0d29ya3MnXSkgPT0gMDoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIG5ldHdvcmtfZGV2aWNlcyA9IGxpc3QoKQogICAgICAgIGZvciBuZXR3b3JrIGluIHNlbGYucGFyYW1zWyduZXR3b3JrcyddOgogICAgICAgICAgICBpZiAnaXAnIGluIG5ldHdvcmsgb3IgJ25ldG1hc2snIGluIG5ldHdvcms6CiAgICAgICAgICAgICAgICBpZiAnaXAnIG5vdCBpbiBuZXR3b3JrIG9yIG5vdCAnbmV0bWFzaycgaW4gbmV0d29yazoKICAgICAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSJCb3RoICdpcCcgYW5kICduZXRtYXNrJyBhcmUgcmVxdWlyZWQgdG9nZXRoZXIuIikKCiAgICAgICAgICAgIGlmICduYW1lJyBpbiBuZXR3b3JrOgogICAgICAgICAgICAgICAgaWYgZ2V0X29iaihzZWxmLmNvbnRlbnQsIFt2aW0uTmV0d29ya10sIG5ldHdvcmtbJ25hbWUnXSkgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSJOZXR3b3JrICclKG5hbWUpcycgZG9lcyBub3QgZXhpc3RzIiAlIG5ldHdvcmspCgogICAgICAgICAgICBlbGlmICd2bGFuJyBpbiBuZXR3b3JrOgogICAgICAgICAgICAgICAgZHZwcyA9IGdldF9hbGxfb2JqcyhzZWxmLmNvbnRlbnQsIFt2aW0uZHZzLkRpc3RyaWJ1dGVkVmlydHVhbFBvcnRncm91cF0pCiAgICAgICAgICAgICAgICBmb3IgZHZwIGluIGR2cHM6CiAgICAgICAgICAgICAgICAgICAgaWYgaGFzYXR0cihkdnAuY29uZmlnLmRlZmF1bHRQb3J0Q29uZmlnLCAndmxhbicpIGFuZCBkdnAuY29uZmlnLmRlZmF1bHRQb3J0Q29uZmlnLnZsYW4udmxhbklkID09IG5ldHdvcmtbJ3ZsYW4nXToKICAgICAgICAgICAgICAgICAgICAgICAgbmV0d29ya1snbmFtZSddID0gZHZwLmNvbmZpZy5uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgaWYgZHZwLmNvbmZpZy5uYW1lID09IG5ldHdvcmtbJ3ZsYW4nXToKICAgICAgICAgICAgICAgICAgICAgICAgbmV0d29ya1snbmFtZSddID0gZHZwLmNvbmZpZy5uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubW9kdWxlLmZhaWxfanNvbihtc2c9IlZMQU4gJyUodmxhbilzJyBkb2VzIG5vdCBleGlzdCIgJSBuZXR3b3JrKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iWW91IG5lZWQgdG8gZGVmaW5lIGEgbmV0d29yayBuYW1lIG9yIGEgdmxhbiIpCgogICAgICAgICAgICBuZXR3b3JrX2RldmljZXMuYXBwZW5kKG5ldHdvcmspCgogICAgICAgICMgTGlzdCBjdXJyZW50IGRldmljZSBmb3IgQ2xvbmUgb3IgSWRlbXBvdGVuY3kKICAgICAgICBjdXJyZW50X25ldF9kZXZpY2VzID0gc2VsZi5nZXRfdm1fbmV0d29ya19pbnRlcmZhY2VzKHZtPXZtX29iaikKICAgICAgICBpZiBsZW4obmV0d29ya19kZXZpY2VzKSA8IGxlbihjdXJyZW50X25ldF9kZXZpY2VzKToKICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iZ2l2ZW4gbmV0d29yayBkZXZpY2UgbGlzdCBpcyBsZXNzZXIgdGhhbiBjdXJyZW50IFZNIGRldmljZSBsaXN0ICglZCA8ICVkKS4gIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJSZW1vdmluZyBpbnRlcmZhY2VzIGlzIG5vdCBhbGxvd2VkIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICUgKGxlbihuZXR3b3JrX2RldmljZXMpLCBsZW4oY3VycmVudF9uZXRfZGV2aWNlcykpKQoKICAgICAgICBmb3Iga2V5IGluIHJhbmdlKDAsIGxlbihuZXR3b3JrX2RldmljZXMpKToKICAgICAgICAgICAgIyBEZWZhdWx0IGRldmljZSB0eXBlIGlzIHZteG5ldDMsIFZNV2FyZSBiZXN0IHByYWN0aWNlCiAgICAgICAgICAgIGRldmljZV90eXBlID0gbmV0d29ya19kZXZpY2VzW2tleV0uZ2V0KCdkZXZpY2VfdHlwZScsICd2bXhuZXQzJykKICAgICAgICAgICAgbmljID0gc2VsZi5kZXZpY2VfaGVscGVyLmNyZWF0ZV9uaWMoZGV2aWNlX3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdOZXR3b3JrIEFkYXB0ZXIgJXMnICUgKGtleSArIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXR3b3JrX2RldmljZXNba2V5XSkKCiAgICAgICAgICAgIG5pY19jaGFuZ2VfZGV0ZWN0ZWQgPSBGYWxzZQogICAgICAgICAgICBpZiBrZXkgPCBsZW4oY3VycmVudF9uZXRfZGV2aWNlcykgYW5kICh2bV9vYmogb3Igc2VsZi5zaG91bGRfZGVwbG95X2Zyb21fdGVtcGxhdGUoKSk6CiAgICAgICAgICAgICAgICBuaWMub3BlcmF0aW9uID0gdmltLnZtLmRldmljZS5WaXJ0dWFsRGV2aWNlU3BlYy5PcGVyYXRpb24uZWRpdAogICAgICAgICAgICAgICAgIyBDaGFuZ2luZyBtYWMgYWRkcmVzcyBoYXMgbm8gZWZmZWN0IHdoZW4gZWRpdGluZyBpbnRlcmZhY2UKICAgICAgICAgICAgICAgIGlmICdtYWMnIGluIG5ldHdvcmtfZGV2aWNlc1trZXldIGFuZCBuaWMuZGV2aWNlLm1hY0FkZHJlc3MgIT0gY3VycmVudF9uZXRfZGV2aWNlc1trZXldLm1hY0FkZHJlc3M6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iQ2hhbmdpbmcgTUFDIGFkZHJlc3MgaGFzIG5vdCBlZmZlY3Qgd2hlbiBpbnRlcmZhY2UgaXMgYWxyZWFkeSBwcmVzZW50LiAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiVGhlIGZhaWxpbmcgbmV3IE1BQyBhZGRyZXNzIGlzICVzIiAlIG5pYy5kZXZpY2UubWFjQWRkcmVzcykKCiAgICAgICAgICAgICAgICBuaWMuZGV2aWNlID0gY3VycmVudF9uZXRfZGV2aWNlc1trZXldCiAgICAgICAgICAgICAgICBuaWMuZGV2aWNlLmRldmljZUluZm8gPSB2aW0uRGVzY3JpcHRpb24oKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbmljLm9wZXJhdGlvbiA9IHZpbS52bS5kZXZpY2UuVmlydHVhbERldmljZVNwZWMuT3BlcmF0aW9uLmFkZAogICAgICAgICAgICAgICAgbmljX2NoYW5nZV9kZXRlY3RlZCA9IFRydWUKCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5jYWNoZS5nZXRfbmV0d29yayhuZXR3b3JrX2RldmljZXNba2V5XVsnbmFtZSddKSwgJ3BvcnRLZXlzJyk6CiAgICAgICAgICAgICAgICAjIFZEUyBzd2l0Y2gKICAgICAgICAgICAgICAgIHBnX29iaiA9IGdldF9vYmooc2VsZi5jb250ZW50LCBbdmltLmR2cy5EaXN0cmlidXRlZFZpcnR1YWxQb3J0Z3JvdXBdLCBuZXR3b3JrX2RldmljZXNba2V5XVsnbmFtZSddKQoKICAgICAgICAgICAgICAgIGlmIChuaWMuZGV2aWNlLmJhY2tpbmcgYW5kCiAgICAgICAgICAgICAgICAgICAgICAgIChuaWMuZGV2aWNlLmJhY2tpbmcucG9ydC5wb3J0Z3JvdXBLZXkgIT0gcGdfb2JqLmtleSBvcgogICAgICAgICAgICAgICAgICAgICAgICAgbmljLmRldmljZS5iYWNraW5nLnBvcnQuc3dpdGNoVXVpZCAhPSBwZ19vYmouY29uZmlnLmRpc3RyaWJ1dGVkVmlydHVhbFN3aXRjaC51dWlkKSk6CiAgICAgICAgICAgICAgICAgICAgbmljX2NoYW5nZV9kZXRlY3RlZCA9IFRydWUKCiAgICAgICAgICAgICAgICBkdnNfcG9ydF9jb25uZWN0aW9uID0gdmltLmR2cy5Qb3J0Q29ubmVjdGlvbigpCiAgICAgICAgICAgICAgICBkdnNfcG9ydF9jb25uZWN0aW9uLnBvcnRncm91cEtleSA9IHBnX29iai5rZXkKICAgICAgICAgICAgICAgIGR2c19wb3J0X2Nvbm5lY3Rpb24uc3dpdGNoVXVpZCA9IHBnX29iai5jb25maWcuZGlzdHJpYnV0ZWRWaXJ0dWFsU3dpdGNoLnV1aWQKICAgICAgICAgICAgICAgIG5pYy5kZXZpY2UuYmFja2luZyA9IHZpbS52bS5kZXZpY2UuVmlydHVhbEV0aGVybmV0Q2FyZC5EaXN0cmlidXRlZFZpcnR1YWxQb3J0QmFja2luZ0luZm8oKQogICAgICAgICAgICAgICAgbmljLmRldmljZS5iYWNraW5nLnBvcnQgPSBkdnNfcG9ydF9jb25uZWN0aW9uCiAgICAgICAgICAgICAgICBuaWNfY2hhbmdlX2RldGVjdGVkID0gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyB2U3dpdGNoCiAgICAgICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShuaWMuZGV2aWNlLmJhY2tpbmcsIHZpbS52bS5kZXZpY2UuVmlydHVhbEV0aGVybmV0Q2FyZC5OZXR3b3JrQmFja2luZ0luZm8pOgogICAgICAgICAgICAgICAgICAgIG5pYy5kZXZpY2UuYmFja2luZyA9IHZpbS52bS5kZXZpY2UuVmlydHVhbEV0aGVybmV0Q2FyZC5OZXR3b3JrQmFja2luZ0luZm8oKQogICAgICAgICAgICAgICAgICAgIG5pY19jaGFuZ2VfZGV0ZWN0ZWQgPSBUcnVlCgogICAgICAgICAgICAgICAgbmV0X29iaiA9IHNlbGYuY2FjaGUuZ2V0X25ldHdvcmsobmV0d29ya19kZXZpY2VzW2tleV1bJ25hbWUnXSkKICAgICAgICAgICAgICAgIGlmIG5pYy5kZXZpY2UuYmFja2luZy5uZXR3b3JrICE9IG5ldF9vYmo6CiAgICAgICAgICAgICAgICAgICAgbmljLmRldmljZS5iYWNraW5nLm5ldHdvcmsgPSBuZXRfb2JqCiAgICAgICAgICAgICAgICAgICAgbmljX2NoYW5nZV9kZXRlY3RlZCA9IFRydWUKCiAgICAgICAgICAgICAgICBpZiBuaWMuZGV2aWNlLmJhY2tpbmcuZGV2aWNlTmFtZSAhPSBuZXR3b3JrX2RldmljZXNba2V5XVsnbmFtZSddOgogICAgICAgICAgICAgICAgICAgIG5pYy5kZXZpY2UuYmFja2luZy5kZXZpY2VOYW1lID0gbmV0d29ya19kZXZpY2VzW2tleV1bJ25hbWUnXQogICAgICAgICAgICAgICAgICAgIG5pY19jaGFuZ2VfZGV0ZWN0ZWQgPSBUcnVlCgogICAgICAgICAgICBpZiBuaWNfY2hhbmdlX2RldGVjdGVkOgogICAgICAgICAgICAgICAgc2VsZi5jb25maWdzcGVjLmRldmljZUNoYW5nZS5hcHBlbmQobmljKQogICAgICAgICAgICAgICAgc2VsZi5jaGFuZ2VfZGV0ZWN0ZWQgPSBUcnVlCgogICAgZGVmIGN1c3RvbWl6ZV9jdXN0b212YWx1ZXMoc2VsZiwgdm1fb2JqKToKICAgICAgICBpZiBsZW4oc2VsZi5wYXJhbXNbJ2N1c3RvbXZhbHVlcyddKSA9PSAwOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZmFjdHMgPSBzZWxmLmdhdGhlcl9mYWN0cyh2bV9vYmopCiAgICAgICAgZm9yIGt2IGluIHNlbGYucGFyYW1zWydjdXN0b212YWx1ZXMnXToKICAgICAgICAgICAgaWYgJ2tleScgbm90IGluIGt2IG9yICd2YWx1ZScgbm90IGluIGt2OgogICAgICAgICAgICAgICAgc2VsZi5tb2R1bGUuZXhpdF9qc29uKG1zZz0iY3VzdG9tdmFsdWVzIGl0ZW1zIHJlcXVpcmVkIGJvdGggJ2tleScgYW5kICd2YWx1ZSBmaWVsZHMuIikKCiAgICAgICAgICAgICMgSWYga3YgaXMgbm90IGt2IGZldGNoZWQgZnJvbSBmYWN0cywgY2hhbmdlIGl0CiAgICAgICAgICAgIGlmIGt2WydrZXknXSBub3QgaW4gZmFjdHNbJ2N1c3RvbXZhbHVlcyddIG9yIGZhY3RzWydjdXN0b212YWx1ZXMnXVtrdlsna2V5J11dICE9IGt2Wyd2YWx1ZSddOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHZtX29iai5zZXRDdXN0b21WYWx1ZShrZXk9a3ZbJ2tleSddLCB2YWx1ZT1rdlsndmFsdWUnXSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmNoYW5nZV9kZXRlY3RlZCA9IFRydWUKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgIHNlbGYubW9kdWxlLmZhaWxfanNvbihtc2c9IkZhaWxlZCB0byBzZXQgY3VzdG9tIHZhbHVlIGZvciBrZXk9JyVzJyBhbmQgdmFsdWU9JyVzJy4gRXJyb3Igd2FzOiAlcyIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJSAoa3ZbJ2tleSddLCBrdlsndmFsdWUnXSwgZSkpCgogICAgZGVmIGN1c3RvbWl6ZV92bShzZWxmLCB2bV9vYmopOgogICAgICAgICMgTmV0d29yayBzZXR0aW5ncwogICAgICAgIGFkYXB0ZXJtYXBzID0gW10KICAgICAgICBmb3IgbmV0d29yayBpbiBzZWxmLnBhcmFtc1snbmV0d29ya3MnXToKICAgICAgICAgICAgaWYgJ2lwJyBpbiBuZXR3b3JrIGFuZCAnbmV0bWFzaycgaW4gbmV0d29yazoKICAgICAgICAgICAgICAgIGd1ZXN0X21hcCA9IHZpbS52bS5jdXN0b21pemF0aW9uLkFkYXB0ZXJNYXBwaW5nKCkKICAgICAgICAgICAgICAgIGd1ZXN0X21hcC5hZGFwdGVyID0gdmltLnZtLmN1c3RvbWl6YXRpb24uSVBTZXR0aW5ncygpCiAgICAgICAgICAgICAgICBndWVzdF9tYXAuYWRhcHRlci5pcCA9IHZpbS52bS5jdXN0b21pemF0aW9uLkZpeGVkSXAoKQogICAgICAgICAgICAgICAgZ3Vlc3RfbWFwLmFkYXB0ZXIuaXAuaXBBZGRyZXNzID0gc3RyKG5ldHdvcmtbJ2lwJ10pCiAgICAgICAgICAgICAgICBndWVzdF9tYXAuYWRhcHRlci5zdWJuZXRNYXNrID0gc3RyKG5ldHdvcmtbJ25ldG1hc2snXSkKCiAgICAgICAgICAgICAgICBpZiAnZ2F0ZXdheScgaW4gbmV0d29yazoKICAgICAgICAgICAgICAgICAgICBndWVzdF9tYXAuYWRhcHRlci5nYXRld2F5ID0gbmV0d29ya1snZ2F0ZXdheSddCgogICAgICAgICAgICAgICAgIyBPbiBXaW5kb3dzLCBETlMgZG9tYWluIGFuZCBETlMgc2VydmVycyBjYW4gYmUgc2V0IGJ5IG5ldHdvcmsgaW50ZXJmYWNlCiAgICAgICAgICAgICAgICAjIGh0dHBzOi8vcHVicy52bXdhcmUuY29tL3ZpMy9zZGsvUmVmZXJlbmNlR3VpZGUvdmltLnZtLmN1c3RvbWl6YXRpb24uSVBTZXR0aW5ncy5odG1sCiAgICAgICAgICAgICAgICBpZiAnZG9tYWluJyBpbiBuZXR3b3JrOgogICAgICAgICAgICAgICAgICAgIGd1ZXN0X21hcC5hZGFwdGVyLmRuc0RvbWFpbiA9IG5ldHdvcmtbJ2RvbWFpbiddCiAgICAgICAgICAgICAgICBlbGlmIHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ10uZ2V0KCdkb21haW4nKToKICAgICAgICAgICAgICAgICAgICBndWVzdF9tYXAuYWRhcHRlci5kbnNEb21haW4gPSBzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddWydkb21haW4nXQogICAgICAgICAgICAgICAgaWYgJ2Ruc19zZXJ2ZXJzJyBpbiBuZXR3b3JrOgogICAgICAgICAgICAgICAgICAgIGd1ZXN0X21hcC5hZGFwdGVyLmRuc1NlcnZlckxpc3QgPSBuZXR3b3JrWydkbnNfc2VydmVycyddCiAgICAgICAgICAgICAgICBlbGlmIHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ10uZ2V0KCdkbnNfc2VydmVycycpOgogICAgICAgICAgICAgICAgICAgIGd1ZXN0X21hcC5hZGFwdGVyLmRuc1NlcnZlckxpc3QgPSBzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddWydkbnNfc2VydmVycyddCgogICAgICAgICAgICAgICAgYWRhcHRlcm1hcHMuYXBwZW5kKGd1ZXN0X21hcCkKCiAgICAgICAgIyBHbG9iYWwgRE5TIHNldHRpbmdzCiAgICAgICAgZ2xvYmFsaXAgPSB2aW0udm0uY3VzdG9taXphdGlvbi5HbG9iYWxJUFNldHRpbmdzKCkKICAgICAgICBpZiAnZG5zX3NlcnZlcnMnIGluIHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ106CiAgICAgICAgICAgIGdsb2JhbGlwLmRuc1NlcnZlckxpc3QgPSBzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddLmdldCgnZG5zX3NlcnZlcnMnKQogICAgICAgICMgVE9ETzogTWF5YmUgbGlzdCB0aGUgZGlmZmVyZW50IGRvbWFpbnMgZnJvbSB0aGUgaW50ZXJmYWNlcyBoZXJlIGJ5IGRlZmF1bHQgPwogICAgICAgIGlmICdkbnNfc3VmZml4JyBpbiBzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddIG9yICdkb21haW4nIGluIHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ106CiAgICAgICAgICAgIGdsb2JhbGlwLmRuc1N1ZmZpeExpc3QgPSBzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddLmdldCgnZG5zX3N1ZmZpeCcsIHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ11bJ2RvbWFpbiddKQoKICAgICAgICBpZiBzZWxmLnBhcmFtc1snZ3Vlc3RfaWQnXToKICAgICAgICAgICAgZ3Vlc3RfaWQgPSBzZWxmLnBhcmFtc1snZ3Vlc3RfaWQnXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGd1ZXN0X2lkID0gdm1fb2JqLnN1bW1hcnkuY29uZmlnLmd1ZXN0SWQKCiAgICAgICAgIyBJZiBJIGluc3RhbGwgYSBXaW5kb3dzIHVzZSBTeXNwcmVwCiAgICAgICAgIyBodHRwczovL3B1YnMudm13YXJlLmNvbS92aTMvc2RrL1JlZmVyZW5jZUd1aWRlL3ZpbS52bS5jdXN0b21pemF0aW9uLlN5c3ByZXAuaHRtbCNmaWVsZF9kZXRhaWwKICAgICAgICBpZiAnd2luJyBpbiBndWVzdF9pZDoKICAgICAgICAgICAgaWRlbnQgPSB2aW0udm0uY3VzdG9taXphdGlvbi5TeXNwcmVwKCkKCiAgICAgICAgICAgIGlkZW50LnVzZXJEYXRhID0gdmltLnZtLmN1c3RvbWl6YXRpb24uVXNlckRhdGEoKQogICAgICAgICAgICBpZGVudC51c2VyRGF0YS5jb21wdXRlck5hbWUgPSB2aW0udm0uY3VzdG9taXphdGlvbi5GaXhlZE5hbWUoKQogICAgICAgICAgICBpZGVudC51c2VyRGF0YS5jb21wdXRlck5hbWUubmFtZSA9IHN0cihzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddLmdldCgnaG9zdG5hbWUnLCBzZWxmLnBhcmFtc1snbmFtZSddKSkKICAgICAgICAgICAgaWRlbnQudXNlckRhdGEuZnVsbE5hbWUgPSBzdHIoc2VsZi5wYXJhbXNbJ2N1c3RvbWl6YXRpb24nXS5nZXQoJ2Z1bGxuYW1lJywgJ0FkbWluaXN0cmF0b3InKSkKICAgICAgICAgICAgaWRlbnQudXNlckRhdGEub3JnTmFtZSA9IHN0cihzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddLmdldCgnb3JnbmFtZScsICdBQ01FJykpCgogICAgICAgICAgICBpZGVudC5ndWlVbmF0dGVuZGVkID0gdmltLnZtLmN1c3RvbWl6YXRpb24uR3VpVW5hdHRlbmRlZCgpCiAgICAgICAgICAgIGlkZW50Lmd1aVVuYXR0ZW5kZWQuYXV0b0xvZ29uID0gc2VsZi5wYXJhbXNbJ2N1c3RvbWl6YXRpb24nXS5nZXQoJ2F1dG9sb2dvbicsIEZhbHNlKQogICAgICAgICAgICBpZGVudC5ndWlVbmF0dGVuZGVkLmF1dG9Mb2dvbkNvdW50ID0gc2VsZi5wYXJhbXNbJ2N1c3RvbWl6YXRpb24nXS5nZXQoJ2F1dG9sb2dvbmNvdW50JywgMSkKICAgICAgICAgICAgaWRlbnQuZ3VpVW5hdHRlbmRlZC50aW1lWm9uZSA9IHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ10uZ2V0KCd0aW1lem9uZScsIDg1KQoKICAgICAgICAgICAgaWRlbnQuaWRlbnRpZmljYXRpb24gPSB2aW0udm0uY3VzdG9taXphdGlvbi5JZGVudGlmaWNhdGlvbigpCgogICAgICAgICAgICBpZiBzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddLmdldCgncGFzc3dvcmQnLCAnJykgIT0gJyc6CiAgICAgICAgICAgICAgICBpZGVudC5ndWlVbmF0dGVuZGVkLnBhc3N3b3JkID0gdmltLnZtLmN1c3RvbWl6YXRpb24uUGFzc3dvcmQoKQogICAgICAgICAgICAgICAgaWRlbnQuZ3VpVW5hdHRlbmRlZC5wYXNzd29yZC52YWx1ZSA9IHN0cihzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddWydwYXNzd29yZCddKQogICAgICAgICAgICAgICAgaWRlbnQuZ3VpVW5hdHRlbmRlZC5wYXNzd29yZC5wbGFpblRleHQgPSBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSJUaGUgJ2N1c3RvbWl6YXRpb24nIHNlY3Rpb24gcmVxdWlyZXMgYSAncGFzc3dvcmQnIGVudHJ5LCB3aGljaCBjYW5ub3QgYmUgZW1wdHkuIikKCiAgICAgICAgICAgIGlmICdwcm9kdWN0aWQnIGluIHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ106CiAgICAgICAgICAgICAgICBpZGVudC51c2VyRGF0YS5vcmdOYW1lID0gc3RyKHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ11bJ3Byb2R1Y3RpZCddKQoKICAgICAgICAgICAgaWYgJ2pvaW5kb21haW4nIGluIHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ106CiAgICAgICAgICAgICAgICBpZiAnZG9tYWluYWRtaW4nIG5vdCBpbiBzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddIG9yICdkb21haW5hZG1pbnBhc3N3b3JkJyBub3QgaW4gc2VsZi5wYXJhbXNbJ2N1c3RvbWl6YXRpb24nXToKICAgICAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSInZG9tYWluYWRtaW4nIGFuZCAnZG9tYWluYWRtaW5wYXNzd29yZCcgZW50cmllcyBhcmUgbWFuZGF0b3J5IGluICdjdXN0b21pemF0aW9uJyBzZWN0aW9uIHRvIHVzZSAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9pbmRvbWFpbiBmZWF0dXJlIikKCiAgICAgICAgICAgICAgICBpZGVudC5pZGVudGlmaWNhdGlvbi5kb21haW5BZG1pbiA9IHN0cihzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddLmdldCgnZG9tYWluYWRtaW4nKSkKICAgICAgICAgICAgICAgIGlkZW50LmlkZW50aWZpY2F0aW9uLmpvaW5Eb21haW4gPSBzdHIoc2VsZi5wYXJhbXNbJ2N1c3RvbWl6YXRpb24nXS5nZXQoJ2pvaW5kb21haW4nKSkKICAgICAgICAgICAgICAgIGlkZW50LmlkZW50aWZpY2F0aW9uLmRvbWFpbkFkbWluUGFzc3dvcmQgPSB2aW0udm0uY3VzdG9taXphdGlvbi5QYXNzd29yZCgpCiAgICAgICAgICAgICAgICBpZGVudC5pZGVudGlmaWNhdGlvbi5kb21haW5BZG1pblBhc3N3b3JkLnZhbHVlID0gc3RyKHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ10uZ2V0KCdkb21haW5hZG1pbnBhc3N3b3JkJykpCiAgICAgICAgICAgICAgICBpZGVudC5pZGVudGlmaWNhdGlvbi5kb21haW5BZG1pblBhc3N3b3JkLnBsYWluVGV4dCA9IFRydWUKCiAgICAgICAgICAgIGVsaWYgJ2pvaW53b3JrZ3JvdXAnIGluIHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ106CiAgICAgICAgICAgICAgICBpZGVudC5pZGVudGlmaWNhdGlvbi5qb2luV29ya2dyb3VwID0gc3RyKHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ10uZ2V0KCdqb2lud29ya2dyb3VwJykpCgogICAgICAgICAgICBpZiAncnVub25jZScgaW4gc2VsZi5wYXJhbXNbJ2N1c3RvbWl6YXRpb24nXToKICAgICAgICAgICAgICAgIGlkZW50Lmd1aVJ1bk9uY2UgPSB2aW0udm0uY3VzdG9taXphdGlvbi5HdWlSdW5PbmNlKCkKICAgICAgICAgICAgICAgIGlkZW50Lmd1aVJ1bk9uY2UuY29tbWFuZExpc3QgPSBzZWxmLnBhcmFtc1snY3VzdG9taXphdGlvbiddWydydW5vbmNlJ10KICAgICAgICBlbHNlOgogICAgICAgICAgICAjIEVsc2UgdXNlIExpbnV4UHJlcAogICAgICAgICAgICAjIGh0dHBzOi8vcHVicy52bXdhcmUuY29tL3ZpMy9zZGsvUmVmZXJlbmNlR3VpZGUvdmltLnZtLmN1c3RvbWl6YXRpb24uTGludXhQcmVwLmh0bWwKICAgICAgICAgICAgaWRlbnQgPSB2aW0udm0uY3VzdG9taXphdGlvbi5MaW51eFByZXAoKQogICAgICAgICAgICAjIFRPRE86IE1heWJlIGFkZCBkb21haW4gZnJvbSBpbnRlcmZhY2UgaWYgbWlzc2luZyA/CiAgICAgICAgICAgIGlmICdkb21haW4nIGluIHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ106CiAgICAgICAgICAgICAgICBpZGVudC5kb21haW4gPSBzdHIoc2VsZi5wYXJhbXNbJ2N1c3RvbWl6YXRpb24nXS5nZXQoJ2RvbWFpbicpKQogICAgICAgICAgICBpZGVudC5ob3N0TmFtZSA9IHZpbS52bS5jdXN0b21pemF0aW9uLkZpeGVkTmFtZSgpCiAgICAgICAgICAgIGlkZW50Lmhvc3ROYW1lLm5hbWUgPSBzdHIoc2VsZi5wYXJhbXNbJ2N1c3RvbWl6YXRpb24nXS5nZXQoJ2hvc3RuYW1lJywgc2VsZi5wYXJhbXNbJ25hbWUnXSkpCgogICAgICAgIHNlbGYuY3VzdG9tc3BlYyA9IHZpbS52bS5jdXN0b21pemF0aW9uLlNwZWNpZmljYXRpb24oKQogICAgICAgIHNlbGYuY3VzdG9tc3BlYy5uaWNTZXR0aW5nTWFwID0gYWRhcHRlcm1hcHMKICAgICAgICBzZWxmLmN1c3RvbXNwZWMuZ2xvYmFsSVBTZXR0aW5ncyA9IGdsb2JhbGlwCiAgICAgICAgc2VsZi5jdXN0b21zcGVjLmlkZW50aXR5ID0gaWRlbnQKCiAgICBkZWYgZ2V0X3ZtX3Njc2lfY29udHJvbGxlcihzZWxmLCB2bV9vYmopOgogICAgICAgICMgSWYgdm1fb2JqIGRvZXNuJ3QgZXhpc3RzIG5vIFNDU0kgY29udHJvbGxlciB0byBmaW5kCiAgICAgICAgaWYgdm1fb2JqIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIGZvciBkZXZpY2UgaW4gdm1fb2JqLmNvbmZpZy5oYXJkd2FyZS5kZXZpY2U6CiAgICAgICAgICAgIGlmIHNlbGYuZGV2aWNlX2hlbHBlci5pc19zY3NpX2NvbnRyb2xsZXIoZGV2aWNlKToKICAgICAgICAgICAgICAgIHNjc2lfY3RsID0gdmltLnZtLmRldmljZS5WaXJ0dWFsRGV2aWNlU3BlYygpCiAgICAgICAgICAgICAgICBzY3NpX2N0bC5kZXZpY2UgPSBkZXZpY2UKICAgICAgICAgICAgICAgIHJldHVybiBzY3NpX2N0bAoKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBnZXRfY29uZmlndXJlZF9kaXNrX3NpemUoc2VsZiwgZXhwZWN0ZWRfZGlza19zcGVjKToKICAgICAgICAjIHdoYXQgc2l6ZSBpcyBpdD8KICAgICAgICBpZiBbeCBmb3IgeCBpbiBleHBlY3RlZF9kaXNrX3NwZWMua2V5cygpIGlmIHguc3RhcnRzd2l0aCgnc2l6ZV8nKSBvciB4ID09ICdzaXplJ106CiAgICAgICAgICAgICMgc2l6ZV90Yiwgc2l6ZV9nYiwgc2l6ZV9tYiwgc2l6ZV9rYiwgc2l6ZV9iIC4uLj8KICAgICAgICAgICAgaWYgJ3NpemUnIGluIGV4cGVjdGVkX2Rpc2tfc3BlYzoKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gJycuam9pbihjIGZvciBjIGluIGV4cGVjdGVkX2Rpc2tfc3BlY1snc2l6ZSddIGlmIGMuaXNkaWdpdCgpKQogICAgICAgICAgICAgICAgdW5pdCA9IGV4cGVjdGVkX2Rpc2tfc3BlY1snc2l6ZSddLnJlcGxhY2UoZXhwZWN0ZWQsICcnKS5sb3dlcigpCiAgICAgICAgICAgICAgICBleHBlY3RlZCA9IGludChleHBlY3RlZCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHBhcmFtID0gW3ggZm9yIHggaW4gZXhwZWN0ZWRfZGlza19zcGVjLmtleXMoKSBpZiB4LnN0YXJ0c3dpdGgoJ3NpemVfJyldWzBdCiAgICAgICAgICAgICAgICB1bml0ID0gcGFyYW0uc3BsaXQoJ18nKVstMV0ubG93ZXIoKQogICAgICAgICAgICAgICAgZXhwZWN0ZWQgPSBbeFsxXSBmb3IgeCBpbiBleHBlY3RlZF9kaXNrX3NwZWMuaXRlbXMoKSBpZiB4WzBdLnN0YXJ0c3dpdGgoJ3NpemVfJyldWzBdCiAgICAgICAgICAgICAgICBleHBlY3RlZCA9IGludChleHBlY3RlZCkKCiAgICAgICAgICAgIGlmIHVuaXQgPT0gJ3RiJzoKICAgICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZCAqIDEwMjQgKiAxMDI0ICogMTAyNAogICAgICAgICAgICBlbGlmIHVuaXQgPT0gJ2diJzoKICAgICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZCAqIDEwMjQgKiAxMDI0CiAgICAgICAgICAgIGVsaWYgdW5pdCA9PSAnIG1iJzoKICAgICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZCAqIDEwMjQKICAgICAgICAgICAgZWxpZiB1bml0ID09ICdrYic6CiAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQKCiAgICAgICAgICAgIHNlbGYubW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgIG1zZz0nJXMgaXMgbm90IGEgc3VwcG9ydGVkIHVuaXQgZm9yIGRpc2sgc2l6ZS4gU3VwcG9ydGVkIHVuaXRzIGFyZSBrYiwgbWIsIGdiIG9yIHRiJyAlIHVuaXQpCgogICAgICAgICMgTm8gc2l6ZSBmb3VuZCBidXQgZGlzaywgZmFpbAogICAgICAgIHNlbGYubW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgbXNnPSJObyBzaXplLCBzaXplX2tiLCBzaXplX21iLCBzaXplX2diIG9yIHNpemVfdGIgYXR0cmlidXRlIGZvdW5kIGludG8gZGlzayBjb25maWd1cmF0aW9uIikKCiAgICBkZWYgY29uZmlndXJlX2Rpc2tzKHNlbGYsIHZtX29iaik6CiAgICAgICAgIyBJZ25vcmUgZW1wdHkgZGlzayBsaXN0LCB0aGlzIHBlcm1pdHMgdG8ga2VlcCBkaXNrcyB3aGVuIGRlcGxveWluZyBhIHRlbXBsYXRlL2Nsb25pbmcgYSBWTQogICAgICAgIGlmIGxlbihzZWxmLnBhcmFtc1snZGlzayddKSA9PSAwOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgc2NzaV9jdGwgPSBzZWxmLmdldF92bV9zY3NpX2NvbnRyb2xsZXIodm1fb2JqKQoKICAgICAgICAjIENyZWF0ZSBzY3NpIGNvbnRyb2xsZXIgb25seSBpZiB3ZSBhcmUgZGVwbG95aW5nIGEgbmV3IFZNLCBub3QgYSB0ZW1wbGF0ZSBvciByZWNvbmZpZ3VyaW5nCiAgICAgICAgaWYgdm1fb2JqIGlzIE5vbmUgb3Igc2NzaV9jdGwgaXMgTm9uZToKICAgICAgICAgICAgc2NzaV9jdGwgPSBzZWxmLmRldmljZV9oZWxwZXIuY3JlYXRlX3Njc2lfY29udHJvbGxlcihzZWxmLmdldF9zY3NpX3R5cGUoKSkKICAgICAgICAgICAgc2VsZi5jaGFuZ2VfZGV0ZWN0ZWQgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuY29uZmlnc3BlYy5kZXZpY2VDaGFuZ2UuYXBwZW5kKHNjc2lfY3RsKQoKICAgICAgICBkaXNrcyA9IFt4IGZvciB4IGluIHZtX29iai5jb25maWcuaGFyZHdhcmUuZGV2aWNlIGlmIGlzaW5zdGFuY2UoeCwgdmltLnZtLmRldmljZS5WaXJ0dWFsRGlzayldIFwKICAgICAgICAgICAgaWYgdm1fb2JqIGlzIG5vdCBOb25lIGVsc2UgTm9uZQoKICAgICAgICBpZiBkaXNrcyBpcyBub3QgTm9uZSBhbmQgc2VsZi5wYXJhbXMuZ2V0KCdkaXNrJykgYW5kIGxlbihzZWxmLnBhcmFtcy5nZXQoJ2Rpc2snKSkgPCBsZW4oZGlza3MpOgogICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSJQcm92aWRlZCBkaXNrcyBjb25maWd1cmF0aW9uIGhhcyBsZXNzIGRpc2tzIHRoYW4gIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aGUgdGFyZ2V0IG9iamVjdCAoJWQgdnMgJWQpIiAlIChsZW4oc2VsZi5wYXJhbXMuZ2V0KCdkaXNrJykpLCBsZW4oZGlza3MpKSkKCiAgICAgICAgZGlza19pbmRleCA9IDAKICAgICAgICBmb3IgZXhwZWN0ZWRfZGlza19zcGVjIGluIHNlbGYucGFyYW1zLmdldCgnZGlzaycpOgogICAgICAgICAgICBkaXNrX21vZGlmaWVkID0gRmFsc2UKICAgICAgICAgICAgIyBJZiB3ZSBhcmUgbWFuaXB1bGF0aW5nIGFuZCBleGlzdGluZyBvYmplY3RzIHdoaWNoIGhhcyBkaXNrcyBhbmQgZGlza19pbmRleCBpcyBpbiBkaXNrcwogICAgICAgICAgICBpZiB2bV9vYmogaXMgbm90IE5vbmUgYW5kIGRpc2tzIGlzIG5vdCBOb25lIGFuZCBkaXNrX2luZGV4IDwgbGVuKGRpc2tzKToKICAgICAgICAgICAgICAgIGRpc2tzcGVjID0gdmltLnZtLmRldmljZS5WaXJ0dWFsRGV2aWNlU3BlYygpCiAgICAgICAgICAgICAgICAjIHNldCB0aGUgb3BlcmF0aW9uIHRvIGVkaXQgc28gdGhhdCBpdCBrbm93cyB0byBrZWVwIG90aGVyIHNldHRpbmdzCiAgICAgICAgICAgICAgICBkaXNrc3BlYy5vcGVyYXRpb24gPSB2aW0udm0uZGV2aWNlLlZpcnR1YWxEZXZpY2VTcGVjLk9wZXJhdGlvbi5lZGl0CiAgICAgICAgICAgICAgICBkaXNrc3BlYy5kZXZpY2UgPSBkaXNrc1tkaXNrX2luZGV4XQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZGlza3NwZWMgPSBzZWxmLmRldmljZV9oZWxwZXIuY3JlYXRlX3Njc2lfZGlzayhzY3NpX2N0bCwgZGlza19pbmRleCkKICAgICAgICAgICAgICAgIGRpc2tfbW9kaWZpZWQgPSBUcnVlCgogICAgICAgICAgICAjIGlzIGl0IHRoaW4/CiAgICAgICAgICAgIGlmICd0eXBlJyBpbiBleHBlY3RlZF9kaXNrX3NwZWM6CiAgICAgICAgICAgICAgICBpZiBleHBlY3RlZF9kaXNrX3NwZWMuZ2V0KCd0eXBlJywgJycpLmxvd2VyKCkgPT0gJ3RoaW4nOgogICAgICAgICAgICAgICAgICAgIGRpc2tzcGVjLmRldmljZS5iYWNraW5nLnRoaW5Qcm92aXNpb25lZCA9IFRydWUKCiAgICAgICAgICAgICMgd2hpY2ggZGF0YXN0b3JlPwogICAgICAgICAgICBpZiBleHBlY3RlZF9kaXNrX3NwZWMuZ2V0KCdkYXRhc3RvcmUnKToKICAgICAgICAgICAgICAgICMgVE9ETzogVGhpcyBpcyBhbHJlYWR5IGhhbmRsZWQgYnkgdGhlIHJlbG9jYXRpb24gc3BlYywKICAgICAgICAgICAgICAgICMgYnV0IGl0IG5lZWRzIHRvIGV2ZW50dWFsbHkgYmUgaGFuZGxlZCBmb3IgYWxsIHRoZQogICAgICAgICAgICAgICAgIyBvdGhlciBkaXNrcyBkZWZpbmVkCiAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICAjIGluY3JlbWVudCBpbmRleCBmb3IgbmV4dCBkaXNrIHNlYXJjaAogICAgICAgICAgICBkaXNrX2luZGV4ICs9IDEKICAgICAgICAgICAgIyBpbmRleCA3IGlzIHJlc2VydmVkIHRvIFNDU0kgY29udHJvbGxlcgogICAgICAgICAgICBpZiBkaXNrX2luZGV4ID09IDc6CiAgICAgICAgICAgICAgICBkaXNrX2luZGV4ICs9IDEKCiAgICAgICAgICAgIGtiID0gc2VsZi5nZXRfY29uZmlndXJlZF9kaXNrX3NpemUoZXhwZWN0ZWRfZGlza19zcGVjKQogICAgICAgICAgICAjIFZNV2FyZSBkb2Vzbid0IGFsbG93IHRvIHJlZHVjZSBkaXNrIHNpemVzCiAgICAgICAgICAgIGlmIGtiIDwgZGlza3NwZWMuZGV2aWNlLmNhcGFjaXR5SW5LQjoKICAgICAgICAgICAgICAgIHNlbGYubW9kdWxlLmZhaWxfanNvbigKICAgICAgICAgICAgICAgICAgICBtc2c9IkdpdmVuIGRpc2sgc2l6ZSBpcyBsZXNzZXIgdGhhbiBmb3VuZCAoJWQgPCAlZCkuIFJlZHVjaW5nIGRpc2tzIGlzIG5vdCBhbGxvd2VkLiIgJQogICAgICAgICAgICAgICAgICAgICAgICAoa2IsIGRpc2tzcGVjLmRldmljZS5jYXBhY2l0eUluS0IpKQoKICAgICAgICAgICAgaWYga2IgIT0gZGlza3NwZWMuZGV2aWNlLmNhcGFjaXR5SW5LQiBvciBkaXNrX21vZGlmaWVkOgogICAgICAgICAgICAgICAgZGlza3NwZWMuZGV2aWNlLmNhcGFjaXR5SW5LQiA9IGtiCiAgICAgICAgICAgICAgICBzZWxmLmNvbmZpZ3NwZWMuZGV2aWNlQ2hhbmdlLmFwcGVuZChkaXNrc3BlYykKCiAgICAgICAgICAgICAgICBzZWxmLmNoYW5nZV9kZXRlY3RlZCA9IFRydWUKCiAgICBkZWYgc2VsZWN0X2hvc3Qoc2VsZik6CiAgICAgICAgIyBpZiB0aGUgdXNlciB3YW50cyBhIGNsdXN0ZXIsIGdldCB0aGUgbGlzdCBvZiBob3N0cyBmb3IgdGhlIGNsdXN0ZXIgYW5kIHVzZSB0aGUgZmlyc3Qgb25lCiAgICAgICAgaWYgc2VsZi5wYXJhbXNbJ2NsdXN0ZXInXToKICAgICAgICAgICAgY2x1c3RlciA9IHNlbGYuY2FjaGUuZ2V0X2NsdXN0ZXIoc2VsZi5wYXJhbXNbJ2NsdXN0ZXInXSkKICAgICAgICAgICAgaWYgbm90IGNsdXN0ZXI6CiAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSJGYWlsZWQgdG8gZmluZCBhIGNsdXN0ZXIgbmFtZWQgJShjbHVzdGVyKXMiICUgc2VsZi5wYXJhbXMpCiAgICAgICAgICAgIGhvc3RzeXN0ZW1zID0gW3ggZm9yIHggaW4gY2x1c3Rlci5ob3N0XQogICAgICAgICAgICAjIFRPRE86IGFkZCBhIHBvbGljeSB0byBzZWxlY3QgaG9zdAogICAgICAgICAgICBob3N0c3lzdGVtID0gaG9zdHN5c3RlbXNbMF0KICAgICAgICBlbHNlOgogICAgICAgICAgICBob3N0c3lzdGVtID0gc2VsZi5jYWNoZS5nZXRfZXN4X2hvc3Qoc2VsZi5wYXJhbXNbJ2VzeGlfaG9zdG5hbWUnXSkKICAgICAgICAgICAgaWYgbm90IGhvc3RzeXN0ZW06CiAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSJGYWlsZWQgdG8gZmluZCBhIGhvc3QgbmFtZWQgJShlc3hpX2hvc3RuYW1lKXMiICUgc2VsZi5wYXJhbXMpCgogICAgICAgIHJldHVybiBob3N0c3lzdGVtCgogICAgZGVmIHNlbGVjdF9kYXRhc3RvcmUoc2VsZiwgdm1fb2JqPU5vbmUpOgogICAgICAgIGRhdGFzdG9yZSA9IE5vbmUKICAgICAgICBkYXRhc3RvcmVfbmFtZSA9IE5vbmUKICAgICAgICBpZiBsZW4oc2VsZi5wYXJhbXNbJ2Rpc2snXSkgIT0gMDoKICAgICAgICAgICAgIyBUT0RPOiByZWFsbHkgdXNlIHRoZSBkYXRhc3RvcmUgZm9yIG5ld2x5IGNyZWF0ZWQgZGlza3MKICAgICAgICAgICAgaWYgJ2F1dG9zZWxlY3RfZGF0YXN0b3JlJyBpbiBzZWxmLnBhcmFtc1snZGlzayddWzBdIGFuZCBzZWxmLnBhcmFtc1snZGlzayddWzBdWydhdXRvc2VsZWN0X2RhdGFzdG9yZSddOgogICAgICAgICAgICAgICAgZGF0YXN0b3JlcyA9IGdldF9hbGxfb2JqcyhzZWxmLmNvbnRlbnQsIFt2aW0uRGF0YXN0b3JlXSkKICAgICAgICAgICAgICAgIGlmIGRhdGFzdG9yZXMgaXMgTm9uZSBvciBsZW4oZGF0YXN0b3JlcykgPT0gMDoKICAgICAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSJVbmFibGUgdG8gZmluZCBhIGRhdGFzdG9yZSBsaXN0IHdoZW4gYXV0b3NlbGVjdGluZyIpCgogICAgICAgICAgICAgICAgZGF0YXN0b3JlX2ZyZWVzcGFjZSA9IDAKICAgICAgICAgICAgICAgIGZvciBkcyBpbiBkYXRhc3RvcmVzOgogICAgICAgICAgICAgICAgICAgIGlmIGRzLnN1bW1hcnkuZnJlZVNwYWNlID4gZGF0YXN0b3JlX2ZyZWVzcGFjZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBJZiBkYXRhc3RvcmUgZmllbGQgaXMgcHJvdmlkZWQsIGZpbHRlciBkZXN0aW5hdGlvbiBkYXRhc3RvcmVzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICdkYXRhc3RvcmUnIGluIHNlbGYucGFyYW1zWydkaXNrJ11bMF0gYW5kIFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc2luc3RhbmNlKHNlbGYucGFyYW1zWydkaXNrJ11bMF1bJ2RhdGFzdG9yZSddLCBzdHIpIGFuZCBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHMubmFtZS5maW5kKHNlbGYucGFyYW1zWydkaXNrJ11bMF1bJ2RhdGFzdG9yZSddKSA8IDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YXN0b3JlID0gZHMKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YXN0b3JlX25hbWUgPSBkYXRhc3RvcmUubmFtZQogICAgICAgICAgICAgICAgICAgICAgICBkYXRhc3RvcmVfZnJlZXNwYWNlID0gZHMuc3VtbWFyeS5mcmVlU3BhY2UKCiAgICAgICAgICAgIGVsaWYgJ2RhdGFzdG9yZScgaW4gc2VsZi5wYXJhbXNbJ2Rpc2snXVswXToKICAgICAgICAgICAgICAgIGRhdGFzdG9yZV9uYW1lID0gc2VsZi5wYXJhbXNbJ2Rpc2snXVswXVsnZGF0YXN0b3JlJ10KICAgICAgICAgICAgICAgIGRhdGFzdG9yZSA9IGdldF9vYmooc2VsZi5jb250ZW50LCBbdmltLkRhdGFzdG9yZV0sIGRhdGFzdG9yZV9uYW1lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iRWl0aGVyIGRhdGFzdG9yZSBvciBhdXRvc2VsZWN0X2RhdGFzdG9yZSAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzaG91bGQgYmUgcHJvdmlkZWQgdG8gc2VsZWN0IGRhdGFzdG9yZSIpCiAgICAgICAgaWYgbm90IGRhdGFzdG9yZSBhbmQgc2VsZi5zaG91bGRfZGVwbG95X2Zyb21fdGVtcGxhdGUoKToKICAgICAgICAgICAgIyB1c2UgdGhlIHRlbXBsYXRlJ3MgZXhpc3RpbmcgRFMKICAgICAgICAgICAgZGlza3MgPSBbeCBmb3IgeCBpbiB2bV9vYmouY29uZmlnLmhhcmR3YXJlLmRldmljZSBpZiBpc2luc3RhbmNlKHgsIHZpbS52bS5kZXZpY2UuVmlydHVhbERpc2spXQogICAgICAgICAgICBkYXRhc3RvcmUgPSBkaXNrc1swXS5iYWNraW5nLmRhdGFzdG9yZQogICAgICAgICAgICBkYXRhc3RvcmVfbmFtZSA9IGRhdGFzdG9yZS5uYW1lCiAgICAgICAgaWYgbm90IGRhdGFzdG9yZToKICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iRmFpbGVkIHRvIGZpbmQgYSBtYXRjaGluZyBkYXRhc3RvcmUiKQoKICAgICAgICByZXR1cm4gZGF0YXN0b3JlLCBkYXRhc3RvcmVfbmFtZQoKICAgIGRlZiBvYmpfaGFzX3BhcmVudChzZWxmLCBvYmosIHBhcmVudCk6CiAgICAgICAgYXNzZXJ0IG9iaiBpcyBub3QgTm9uZSBhbmQgcGFyZW50IGlzIG5vdCBOb25lCiAgICAgICAgY3VycmVudF9wYXJlbnQgPSBvYmoKCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgaWYgY3VycmVudF9wYXJlbnQubmFtZSA9PSBwYXJlbnQubmFtZToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgICAgICBjdXJyZW50X3BhcmVudCA9IGN1cnJlbnRfcGFyZW50LnBhcmVudAogICAgICAgICAgICBpZiBjdXJyZW50X3BhcmVudCBpcyBOb25lOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHNlbGVjdF9yZXNvdXJjZV9wb29sKHNlbGYsIGhvc3QpOgogICAgICAgIHJlc291cmNlX3Bvb2xzID0gZ2V0X2FsbF9vYmpzKHNlbGYuY29udGVudCwgW3ZpbS5SZXNvdXJjZVBvb2xdKQogICAgICAgIGZvciBycCBpbiByZXNvdXJjZV9wb29scy5pdGVtcygpOgogICAgICAgICAgICBpZiBub3QgcnBbMF06CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIocnBbMF0sICdwYXJlbnQnKSBvciBub3QgcnBbMF0ucGFyZW50OgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgRmluZCByZXNvdXJjZSBwb29sIG9uIGhvc3QKICAgICAgICAgICAgaWYgc2VsZi5vYmpfaGFzX3BhcmVudChycFswXS5wYXJlbnQsIGhvc3QucGFyZW50KToKICAgICAgICAgICAgICAgICMgSWYgbm8gcmVzb3VyY2VfcG9vbCBzZWxlY3RlZCBvciBpdCdzIHRoZSBzZWxlY3RlZCBwb29sLCByZXR1cm4gaXQKICAgICAgICAgICAgICAgIGlmIHNlbGYubW9kdWxlLnBhcmFtc1sncmVzb3VyY2VfcG9vbCddIGlzIE5vbmUgb3IgcnBbMF0ubmFtZSA9PSBzZWxmLm1vZHVsZS5wYXJhbXNbJ3Jlc291cmNlX3Bvb2wnXToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcnBbMF0KCiAgICAgICAgaWYgc2VsZi5tb2R1bGUucGFyYW1zWydyZXNvdXJjZV9wb29sJ10gaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYubW9kdWxlLmZhaWxfanNvbihtc2c9IkNvdWxkIG5vdCBmaW5kIHJlc291cmNlX3Bvb2wgJXMgZm9yIHNlbGVjdGVkIGhvc3QgJXMiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAlIChzZWxmLm1vZHVsZS5wYXJhbXNbJ3Jlc291cmNlX3Bvb2wnXSwgaG9zdC5uYW1lKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSJGYWlsZWQgdG8gZmluZCBhIHJlc291cmNlIGdyb3VwIGZvciAlcyIgJSBob3N0Lm5hbWUpCgogICAgZGVmIGdldF9zY3NpX3R5cGUoc2VsZik6CiAgICAgICAgZGlza19jb250cm9sbGVyX3R5cGUgPSAicGFyYXZpcnR1YWwiCiAgICAgICAgIyBzZXQgY3B1L21lbW9yeS9ldGMKICAgICAgICBpZiAnaGFyZHdhcmUnIGluIHNlbGYucGFyYW1zOgogICAgICAgICAgICBpZiAnc2NzaScgaW4gc2VsZi5wYXJhbXNbJ2hhcmR3YXJlJ106CiAgICAgICAgICAgICAgICBpZiBzZWxmLnBhcmFtc1snaGFyZHdhcmUnXVsnc2NzaSddIGluIFsnYnVzbG9naWMnLCAncGFyYXZpcnR1YWwnLCAnbHNpbG9naWMnLCAnbHNpbG9naWNzYXMnXToKICAgICAgICAgICAgICAgICAgICBkaXNrX2NvbnRyb2xsZXJfdHlwZSA9IHNlbGYucGFyYW1zWydoYXJkd2FyZSddWydzY3NpJ10KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iaGFyZHdhcmUuc2NzaSBhdHRyaWJ1dGUgc2hvdWxkIGJlICdwYXJhdmlydHVhbCcgb3IgJ2xzaWxvZ2ljJyIpCiAgICAgICAgcmV0dXJuIGRpc2tfY29udHJvbGxlcl90eXBlCgogICAgZGVmIGRlcGxveV92bShzZWxmKToKICAgICAgICAjIGh0dHBzOi8vZ2l0aHViLmNvbS92bXdhcmUvcHl2bW9taS1jb21tdW5pdHktc2FtcGxlcy9ibG9iL21hc3Rlci9zYW1wbGVzL2Nsb25lX3ZtLnB5CiAgICAgICAgIyBodHRwczovL3d3dy52bXdhcmUuY29tL3N1cHBvcnQvZGV2ZWxvcGVyL3ZjLXNkay92aXNkazI1cHVicy9SZWZlcmVuY2VHdWlkZS92aW0udm0uQ2xvbmVTcGVjLmh0bWwKICAgICAgICAjIGh0dHBzOi8vd3d3LnZtd2FyZS5jb20vc3VwcG9ydC9kZXZlbG9wZXIvdmMtc2RrL3Zpc2RrMjVwdWJzL1JlZmVyZW5jZUd1aWRlL3ZpbS52bS5Db25maWdTcGVjLmh0bWwKICAgICAgICAjIGh0dHBzOi8vd3d3LnZtd2FyZS5jb20vc3VwcG9ydC9kZXZlbG9wZXIvdmMtc2RrL3Zpc2RrNDFwdWJzL0FwaVJlZmVyZW5jZS92aW0udm0uUmVsb2NhdGVTcGVjLmh0bWwKCiAgICAgICAgIyBGSVhNRToKICAgICAgICAjICAgLSBtdWx0aXBsZSBkYXRhY2VudGVycwogICAgICAgICMgICAtIG11bHRpcGxlIHRlbXBsYXRlcyBieSB0aGUgc2FtZSBuYW1lCiAgICAgICAgIyAgIC0gc3RhdGljIElQcwoKICAgICAgICAjZGF0YWNlbnRlcnMgPSBnZXRfYWxsX29ianMoc2VsZi5jb250ZW50LCBbdmltLkRhdGFjZW50ZXJdKQogICAgICAgIGRhdGFjZW50ZXIgPSBnZXRfb2JqKHNlbGYuY29udGVudCwgW3ZpbS5EYXRhY2VudGVyXSwgc2VsZi5wYXJhbXNbJ2RhdGFjZW50ZXInXSkKICAgICAgICBpZiBub3QgZGF0YWNlbnRlcjoKICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0nTm8gZGF0YWNlbnRlciBuYW1lZCAlKGRhdGFjZW50ZXIpcyB3YXMgZm91bmQnICUgc2VsZi5wYXJhbXMpCgogICAgICAgIGRlc3Rmb2xkZXIgPSBOb25lCiAgICAgICAgaWYgbm90IHNlbGYucGFyYW1zWydmb2xkZXInXS5zdGFydHN3aXRoKCcvJyk6CiAgICAgICAgICAgIHNlbGYubW9kdWxlLmZhaWxfanNvbihtc2c9IkZvbGRlciAlKGZvbGRlcilzIG5lZWRzIHRvIGJlIGFuIGFic29sdXRlIHBhdGgsIHN0YXJ0aW5nIHdpdGggJy8nLiIgJSBzZWxmLnBhcmFtcykKCiAgICAgICAgZl9vYmogPSBzZWxmLmNvbnRlbnQuc2VhcmNoSW5kZXguRmluZEJ5SW52ZW50b3J5UGF0aCgnLyUoZGF0YWNlbnRlcilzJShmb2xkZXIpcycgJSBzZWxmLnBhcmFtcykKICAgICAgICBpZiBmX29iaiBpcyBOb25lOgogICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSdObyBmb2xkZXIgbWF0Y2hlZCB0aGUgcGF0aDogJShmb2xkZXIpcycgJSBzZWxmLnBhcmFtcykKICAgICAgICBkZXN0Zm9sZGVyID0gZl9vYmoKCiAgICAgICAgaG9zdHN5c3RlbSA9IHNlbGYuc2VsZWN0X2hvc3QoKQoKICAgICAgICBpZiBzZWxmLnNob3VsZF9kZXBsb3lfZnJvbV90ZW1wbGF0ZSgpOgogICAgICAgICAgICAjIEZJWE1FOiBuZWVkIHRvIHNlYXJjaCBmb3IgdGhpcyBpbiB0aGUgc2FtZSB3YXkgYXMgZ3Vlc3RzIHRvIGVuc3VyZSBhY2N1cmFjeQogICAgICAgICAgICB2bV9vYmogPSBnZXRfb2JqKHNlbGYuY29udGVudCwgW3ZpbS5WaXJ0dWFsTWFjaGluZV0sIHNlbGYucGFyYW1zWyd0ZW1wbGF0ZSddKQogICAgICAgICAgICBpZiBub3Qgdm1fb2JqOgogICAgICAgICAgICAgICAgc2VsZi5tb2R1bGUuZmFpbF9qc29uKG1zZz0iQ291bGQgbm90IGZpbmQgYSB0ZW1wbGF0ZSBuYW1lZCAlKHRlbXBsYXRlKXMiICUgc2VsZi5wYXJhbXMpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdm1fb2JqID0gTm9uZQoKICAgICAgICAjIHNldCB0aGUgZGVzdGluYXRpb24gZGF0YXN0b3JlIGZvciBWTSAmIGRpc2tzCiAgICAgICAgKGRhdGFzdG9yZSwgZGF0YXN0b3JlX25hbWUpID0gc2VsZi5zZWxlY3RfZGF0YXN0b3JlKHZtX29iaikKICAgICAgICByZXNvdXJjZV9wb29sID0gc2VsZi5zZWxlY3RfcmVzb3VyY2VfcG9vbChob3N0c3lzdGVtKQoKICAgICAgICBzZWxmLmNvbmZpZ3NwZWMgPSB2aW0udm0uQ29uZmlnU3BlYyhjcHVIb3RBZGRFbmFibGVkPVRydWUsIG1lbW9yeUhvdEFkZEVuYWJsZWQ9VHJ1ZSkKICAgICAgICBzZWxmLmNvbmZpZ3NwZWMuZGV2aWNlQ2hhbmdlID0gW10KICAgICAgICBzZWxmLmNvbmZpZ3VyZV9ndWVzdGlkKHZtX29iaj12bV9vYmosIHZtX2NyZWF0aW9uPVRydWUpCiAgICAgICAgc2VsZi5jb25maWd1cmVfY3B1X2FuZF9tZW1vcnkodm1fb2JqPXZtX29iaiwgdm1fY3JlYXRpb249VHJ1ZSkKICAgICAgICBzZWxmLmNvbmZpZ3VyZV9kaXNrcyh2bV9vYmo9dm1fb2JqKQogICAgICAgIHNlbGYuY29uZmlndXJlX25ldHdvcmsodm1fb2JqPXZtX29iaikKCiAgICAgICAgaWYgbGVuKHNlbGYucGFyYW1zWydjdXN0b21pemF0aW9uJ10pID4gMCBvciBsZW4oc2VsZi5wYXJhbXNbJ25ldHdvcmtzJ10pID4gMDoKICAgICAgICAgICAgc2VsZi5jdXN0b21pemVfdm0odm1fb2JqPXZtX29iaikKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLnNob3VsZF9kZXBsb3lfZnJvbV90ZW1wbGF0ZSgpOgogICAgICAgICAgICAgICAgIyBjcmVhdGUgdGhlIHJlbG9jYXRpb24gc3BlYwogICAgICAgICAgICAgICAgcmVsb3NwZWMgPSB2aW0udm0uUmVsb2NhdGVTcGVjKCkKICAgICAgICAgICAgICAgICMgT25seSBwcm92aWRlIHNwZWNpZmljIGhvc3Qgd2hlbiB1c2luZyBFU1hpIGhvc3QgZGlyZWN0bHkKICAgICAgICAgICAgICAgIGlmIHNlbGYucGFyYW1zWydlc3hpX2hvc3RuYW1lJ106CiAgICAgICAgICAgICAgICAgICAgcmVsb3NwZWMuaG9zdCA9IGhvc3RzeXN0ZW0KICAgICAgICAgICAgICAgIHJlbG9zcGVjLmRhdGFzdG9yZSA9IGRhdGFzdG9yZQogICAgICAgICAgICAgICAgcmVsb3NwZWMucG9vbCA9IHJlc291cmNlX3Bvb2wKCiAgICAgICAgICAgICAgICBpZiBzZWxmLnBhcmFtc1snc25hcHNob3Rfc3JjJ10gaXMgbm90IE5vbmUgYW5kIHNlbGYucGFyYW1zWydsaW5rZWRfY2xvbmUnXToKICAgICAgICAgICAgICAgICAgICByZWxvc3BlYy5kaXNrTW92ZVR5cGUgPSB2aW0udm0uUmVsb2NhdGVTcGVjLkRpc2tNb3ZlT3B0aW9ucy5jcmVhdGVOZXdDaGlsZERpc2tCYWNraW5nCgogICAgICAgICAgICAgICAgY2xvbmVzcGVjID0gdmltLnZtLkNsb25lU3BlYyh0ZW1wbGF0ZT1zZWxmLnBhcmFtc1snaXNfdGVtcGxhdGUnXSwgbG9jYXRpb249cmVsb3NwZWMpCiAgICAgICAgICAgICAgICBpZiBzZWxmLmN1c3RvbXNwZWM6CiAgICAgICAgICAgICAgICAgICAgY2xvbmVzcGVjLmN1c3RvbWl6YXRpb24gPSBzZWxmLmN1c3RvbXNwZWMKCiAgICAgICAgICAgICAgICBpZiBzZWxmLnBhcmFtc1snc25hcHNob3Rfc3JjJ10gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgc25hcHNob3QgPSBzZWxmLmdldF9zbmFwc2hvdHNfYnlfbmFtZV9yZWN1cnNpdmVseShzbmFwc2hvdHM9dm1fb2JqLnNuYXBzaG90LnJvb3RTbmFwc2hvdExpc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbmFwbmFtZT1zZWxmLnBhcmFtc1snc25hcHNob3Rfc3JjJ10pCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHNuYXBzaG90KSAhPSAxOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1vZHVsZS5mYWlsX2pzb24obXNnPSd2aXJ0dWFsIG1hY2hpbmUgInswfSIgZG9lcyBub3QgY29udGFpbiBzbmFwc2hvdCBuYW1lZCAiezF9IicuZm9ybWF0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNbJ3RlbXBsYXRlJ10sIHNlbGYucGFyYW1zWydzbmFwc2hvdF9zcmMnXSkpCgogICAgICAgICAgICAgICAgICAgIGNsb25lc3BlYy5zbmFwc2hvdCA9IHNuYXBzaG90WzBdLnNuYXBzaG90CgogICAgICAgICAgICAgICAgY2xvbmVzcGVjLmNvbmZpZyA9IHNlbGYuY29uZmlnc3BlYwogICAgICAgICAgICAgICAgdGFzayA9IHZtX29iai5DbG9uZShmb2xkZXI9ZGVzdGZvbGRlciwgbmFtZT1zZWxmLnBhcmFtc1snbmFtZSddLCBzcGVjPWNsb25lc3BlYykKICAgICAgICAgICAgICAgIHNlbGYuY2hhbmdlX2RldGVjdGVkID0gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBDb25maWdTcGVjIHJlcXVpcmUgbmFtZSBmb3IgVk0gY3JlYXRpb24KICAgICAgICAgICAgICAgIHNlbGYuY29uZmlnc3BlYy5uYW1lID0gc2VsZi5wYXJhbXNbJ25hbWUnXQogICAgICAgICAgICAgICAgc2VsZi5jb25maWdzcGVjLmZpbGVzID0gdmltLnZtLkZpbGVJbmZvKGxvZ0RpcmVjdG9yeT1Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuYXBzaG90RGlyZWN0b3J5PU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VzcGVuZERpcmVjdG9yeT1Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZtUGF0aE5hbWU9IlsiICsgZGF0YXN0b3JlX25hbWUgKyAiXSAiICsgc2VsZi5wYXJhbXNbIm5hbWUiXSkKCiAgICAgICAgICAgICAgICB0YXNrID0gZGVzdGZvbGRlci5DcmVhdGVWTV9UYXNrKGNvbmZpZz1zZWxmLmNvbmZpZ3NwZWMsIHBvb2w9cmVzb3VyY2VfcG9vbCkKICAgICAgICAgICAgICAgIHNlbGYuY2hhbmdlX2RldGVjdGVkID0gVHJ1ZQogICAgICAgICAgICBzZWxmLndhaXRfZm9yX3Rhc2sodGFzaykKICAgICAgICBleGNlcHQgVHlwZUVycm9yOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYubW9kdWxlLmZhaWxfanNvbihtc2c9IlR5cGVFcnJvciB3YXMgcmV0dXJuZWQsIHBsZWFzZSBlbnN1cmUgdG8gZ2l2ZSBjb3JyZWN0IGlucHV0cy4gJXMiICUgZSkKCiAgICAgICAgaWYgdGFzay5pbmZvLnN0YXRlID09ICdlcnJvcic6CiAgICAgICAgICAgICMgaHR0cHM6Ly9rYi52bXdhcmUuY29tL3NlbGZzZXJ2aWNlL21pY3Jvc2l0ZXMvc2VhcmNoLmRvP2xhbmd1YWdlPWVuX1VTJmNtZD1kaXNwbGF5S0MmZXh0ZXJuYWxJZD0yMDIxMzYxCiAgICAgICAgICAgICMgaHR0cHM6Ly9rYi52bXdhcmUuY29tL3NlbGZzZXJ2aWNlL21pY3Jvc2l0ZXMvc2VhcmNoLmRvP2xhbmd1YWdlPWVuX1VTJmNtZD1kaXNwbGF5S0MmZXh0ZXJuYWxJZD0yMTczCiAgICAgICAgICAgIHJldHVybiB7J2NoYW5nZWQnOiBzZWxmLmNoYW5nZV9kZXRlY3RlZCwgJ2ZhaWxlZCc6IFRydWUsICdtc2cnOiB0YXNrLmluZm8uZXJyb3IubXNnfQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgc2V0IGFubm90YXRpb24KICAgICAgICAgICAgdm0gPSB0YXNrLmluZm8ucmVzdWx0CiAgICAgICAgICAgIGlmIHNlbGYucGFyYW1zWydhbm5vdGF0aW9uJ106CiAgICAgICAgICAgICAgICBhbm5vdGF0aW9uX3NwZWMgPSB2aW0udm0uQ29uZmlnU3BlYygpCiAgICAgICAgICAgICAgICBhbm5vdGF0aW9uX3NwZWMuYW5ub3RhdGlvbiA9IHN0cihzZWxmLnBhcmFtc1snYW5ub3RhdGlvbiddKQogICAgICAgICAgICAgICAgdGFzayA9IHZtLlJlY29uZmlnVk1fVGFzayhhbm5vdGF0aW9uX3NwZWMpCiAgICAgICAgICAgICAgICBzZWxmLndhaXRfZm9yX3Rhc2sodGFzaykKCiAgICAgICAgICAgIHNlbGYuY3VzdG9taXplX2N1c3RvbXZhbHVlcyh2bV9vYmo9dm0pCgogICAgICAgICAgICBpZiBzZWxmLnBhcmFtc1snd2FpdF9mb3JfaXBfYWRkcmVzcyddIG9yIHNlbGYucGFyYW1zWydzdGF0ZSddIGluIFsncG93ZXJlZG9uJywgJ3Jlc3RhcnRlZCddOgogICAgICAgICAgICAgICAgc2VsZi5zZXRfcG93ZXJzdGF0ZSh2bSwgJ3Bvd2VyZWRvbicsIGZvcmNlPUZhbHNlKQoKICAgICAgICAgICAgICAgIGlmIHNlbGYucGFyYW1zWyd3YWl0X2Zvcl9pcF9hZGRyZXNzJ106CiAgICAgICAgICAgICAgICAgICAgc2VsZi53YWl0X2Zvcl92bV9pcCh2bSkKCiAgICAgICAgICAgIHZtX2ZhY3RzID0gc2VsZi5nYXRoZXJfZmFjdHModm0pCiAgICAgICAgICAgIHJldHVybiB7J2NoYW5nZWQnOiBzZWxmLmNoYW5nZV9kZXRlY3RlZCwgJ2ZhaWxlZCc6IEZhbHNlLCAnaW5zdGFuY2UnOiB2bV9mYWN0c30KCiAgICBkZWYgZ2V0X3NuYXBzaG90c19ieV9uYW1lX3JlY3Vyc2l2ZWx5KHNlbGYsIHNuYXBzaG90cywgc25hcG5hbWUpOgogICAgICAgIHNuYXBfb2JqID0gW10KICAgICAgICBmb3Igc25hcHNob3QgaW4gc25hcHNob3RzOgogICAgICAgICAgICBpZiBzbmFwc2hvdC5uYW1lID09IHNuYXBuYW1lOgogICAgICAgICAgICAgICAgc25hcF9vYmouYXBwZW5kKHNuYXBzaG90KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc25hcF9vYmogPSBzbmFwX29iaiArIHNlbGYuZ2V0X3NuYXBzaG90c19ieV9uYW1lX3JlY3Vyc2l2ZWx5KHNuYXBzaG90LmNoaWxkU25hcHNob3RMaXN0LCBzbmFwbmFtZSkKICAgICAgICByZXR1cm4gc25hcF9vYmoKCiAgICBkZWYgcmVjb25maWd1cmVfdm0oc2VsZik6CiAgICAgICAgc2VsZi5jb25maWdzcGVjID0gdmltLnZtLkNvbmZpZ1NwZWMoKQogICAgICAgIHNlbGYuY29uZmlnc3BlYy5kZXZpY2VDaGFuZ2UgPSBbXQoKICAgICAgICBzZWxmLmNvbmZpZ3VyZV9ndWVzdGlkKHZtX29iaj1zZWxmLmN1cnJlbnRfdm1fb2JqKQogICAgICAgIHNlbGYuY29uZmlndXJlX2NwdV9hbmRfbWVtb3J5KHZtX29iaj1zZWxmLmN1cnJlbnRfdm1fb2JqKQogICAgICAgIHNlbGYuY29uZmlndXJlX2Rpc2tzKHZtX29iaj1zZWxmLmN1cnJlbnRfdm1fb2JqKQogICAgICAgIHNlbGYuY29uZmlndXJlX25ldHdvcmsodm1fb2JqPXNlbGYuY3VycmVudF92bV9vYmopCiAgICAgICAgc2VsZi5jdXN0b21pemVfY3VzdG9tdmFsdWVzKHZtX29iaj1zZWxmLmN1cnJlbnRfdm1fb2JqKQoKICAgICAgICBpZiBzZWxmLnBhcmFtc1snYW5ub3RhdGlvbiddIGFuZCBzZWxmLmN1cnJlbnRfdm1fb2JqLmNvbmZpZy5hbm5vdGF0aW9uICE9IHNlbGYucGFyYW1zWydhbm5vdGF0aW9uJ106CiAgICAgICAgICAgIHNlbGYuY29uZmlnc3BlYy5hbm5vdGF0aW9uID0gc3RyKHNlbGYucGFyYW1zWydhbm5vdGF0aW9uJ10pCiAgICAgICAgICAgIHNlbGYuY2hhbmdlX2RldGVjdGVkID0gVHJ1ZQoKICAgICAgICByZWxvc3BlYyA9IHZpbS52bS5SZWxvY2F0ZVNwZWMoKQogICAgICAgIGhvc3RzeXN0ZW0gPSBzZWxmLnNlbGVjdF9ob3N0KCkKICAgICAgICByZWxvc3BlYy5wb29sID0gc2VsZi5zZWxlY3RfcmVzb3VyY2VfcG9vbChob3N0c3lzdGVtKQoKICAgICAgICBjaGFuZ2VfYXBwbGllZCA9IEZhbHNlCiAgICAgICAgaWYgcmVsb3NwZWMucG9vbCAhPSBzZWxmLmN1cnJlbnRfdm1fb2JqLnJlc291cmNlUG9vbDoKICAgICAgICAgICAgdGFzayA9IHNlbGYuY3VycmVudF92bV9vYmouUmVsb2NhdGVWTV9UYXNrKHNwZWM9cmVsb3NwZWMpCiAgICAgICAgICAgIHNlbGYud2FpdF9mb3JfdGFzayh0YXNrKQogICAgICAgICAgICBjaGFuZ2VfYXBwbGllZCA9IFRydWUKCiAgICAgICAgIyBPbmx5IHNlbmQgVk1XYXJlIHRhc2sgaWYgd2Ugc2VlIGEgbW9kaWZpY2F0aW9uCiAgICAgICAgaWYgc2VsZi5jaGFuZ2VfZGV0ZWN0ZWQ6CiAgICAgICAgICAgIHRhc2sgPSBzZWxmLmN1cnJlbnRfdm1fb2JqLlJlY29uZmlnVk1fVGFzayhzcGVjPXNlbGYuY29uZmlnc3BlYykKICAgICAgICAgICAgc2VsZi53YWl0X2Zvcl90YXNrKHRhc2spCiAgICAgICAgICAgIGNoYW5nZV9hcHBsaWVkID0gVHJ1ZQoKICAgICAgICAgICAgaWYgdGFzay5pbmZvLnN0YXRlID09ICdlcnJvcic6CiAgICAgICAgICAgICAgICAjIGh0dHBzOi8va2Iudm13YXJlLmNvbS9zZWxmc2VydmljZS9taWNyb3NpdGVzL3NlYXJjaC5kbz9sYW5ndWFnZT1lbl9VUyZjbWQ9ZGlzcGxheUtDJmV4dGVybmFsSWQ9MjAyMTM2MQogICAgICAgICAgICAgICAgIyBodHRwczovL2tiLnZtd2FyZS5jb20vc2VsZnNlcnZpY2UvbWljcm9zaXRlcy9zZWFyY2guZG8/bGFuZ3VhZ2U9ZW5fVVMmY21kPWRpc3BsYXlLQyZleHRlcm5hbElkPTIxNzMKICAgICAgICAgICAgICAgIHJldHVybiB7J2NoYW5nZWQnOiBjaGFuZ2VfYXBwbGllZCwgJ2ZhaWxlZCc6IFRydWUsICdtc2cnOiB0YXNrLmluZm8uZXJyb3IubXNnfQoKICAgICAgICAjIFJlbmFtZSBWTQogICAgICAgIGlmIHNlbGYucGFyYW1zWyd1dWlkJ10gYW5kIHNlbGYucGFyYW1zWyduYW1lJ10gYW5kIHNlbGYucGFyYW1zWyduYW1lJ10gIT0gc2VsZi5jdXJyZW50X3ZtX29iai5jb25maWcubmFtZToKICAgICAgICAgICAgdGFzayA9IHNlbGYuY3VycmVudF92bV9vYmouUmVuYW1lX1Rhc2soc2VsZi5wYXJhbXNbJ25hbWUnXSkKICAgICAgICAgICAgc2VsZi53YWl0X2Zvcl90YXNrKHRhc2spCiAgICAgICAgICAgIGNoYW5nZV9hcHBsaWVkID0gVHJ1ZQoKICAgICAgICAgICAgaWYgdGFzay5pbmZvLnN0YXRlID09ICdlcnJvcic6CiAgICAgICAgICAgICAgICByZXR1cm4geydjaGFuZ2VkJzogY2hhbmdlX2FwcGxpZWQsICdmYWlsZWQnOiBUcnVlLCAnbXNnJzogdGFzay5pbmZvLmVycm9yLm1zZ30KCiAgICAgICAgIyBNYXJrIFZNIGFzIFRlbXBsYXRlCiAgICAgICAgaWYgc2VsZi5wYXJhbXNbJ2lzX3RlbXBsYXRlJ106CiAgICAgICAgICAgIHNlbGYuY3VycmVudF92bV9vYmouTWFya0FzVGVtcGxhdGUoKQogICAgICAgICAgICBjaGFuZ2VfYXBwbGllZCA9IFRydWUKCiAgICAgICAgdm1fZmFjdHMgPSBzZWxmLmdhdGhlcl9mYWN0cyhzZWxmLmN1cnJlbnRfdm1fb2JqKQogICAgICAgIHJldHVybiB7J2NoYW5nZWQnOiBjaGFuZ2VfYXBwbGllZCwgJ2ZhaWxlZCc6IEZhbHNlLCAnaW5zdGFuY2UnOiB2bV9mYWN0c30KCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgd2FpdF9mb3JfdGFzayh0YXNrKToKICAgICAgICAjIGh0dHBzOi8vd3d3LnZtd2FyZS5jb20vc3VwcG9ydC9kZXZlbG9wZXIvdmMtc2RrL3Zpc2RrMjVwdWJzL1JlZmVyZW5jZUd1aWRlL3ZpbS5UYXNrLmh0bWwKICAgICAgICAjIGh0dHBzOi8vd3d3LnZtd2FyZS5jb20vc3VwcG9ydC9kZXZlbG9wZXIvdmMtc2RrL3Zpc2RrMjVwdWJzL1JlZmVyZW5jZUd1aWRlL3ZpbS5UYXNrSW5mby5odG1sCiAgICAgICAgIyBodHRwczovL2dpdGh1Yi5jb20vdmlydGRldm5pbmphL3B5dm1vbWktY29tbXVuaXR5LXNhbXBsZXMvYmxvYi9tYXN0ZXIvc2FtcGxlcy90b29scy90YXNrcy5weQogICAgICAgIHdoaWxlIHRhc2suaW5mby5zdGF0ZSBub3QgaW4gWydzdWNjZXNzJywgJ2Vycm9yJ106CiAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKCiAgICBkZWYgd2FpdF9mb3Jfdm1faXAoc2VsZiwgdm0sIHBvbGw9MTAwLCBzbGVlcD01KToKICAgICAgICBpcHMgPSBOb25lCiAgICAgICAgZmFjdHMgPSB7fQogICAgICAgIHRoaXNwb2xsID0gMAogICAgICAgIHdoaWxlIG5vdCBpcHMgYW5kIHRoaXNwb2xsIDw9IHBvbGw6CiAgICAgICAgICAgIG5ld3ZtID0gc2VsZi5nZXR2bSh1dWlkPXZtLmNvbmZpZy51dWlkKQogICAgICAgICAgICBmYWN0cyA9IHNlbGYuZ2F0aGVyX2ZhY3RzKG5ld3ZtKQogICAgICAgICAgICBpZiBmYWN0c1snaXB2NCddIG9yIGZhY3RzWydpcHY2J106CiAgICAgICAgICAgICAgICBpcHMgPSBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKHNsZWVwKQogICAgICAgICAgICAgICAgdGhpc3BvbGwgKz0gMQoKICAgICAgICByZXR1cm4gZmFjdHMKCgpkZWYgZ2V0X29iaihjb250ZW50LCB2aW10eXBlLCBuYW1lKToKICAgICIiIgogICAgUmV0dXJuIGFuIG9iamVjdCBieSBuYW1lLCBpZiBuYW1lIGlzIE5vbmUgdGhlCiAgICBmaXJzdCBmb3VuZCBvYmplY3QgaXMgcmV0dXJuZWQKICAgICIiIgogICAgb2JqID0gTm9uZQogICAgY29udGFpbmVyID0gY29udGVudC52aWV3TWFuYWdlci5DcmVhdGVDb250YWluZXJWaWV3KAogICAgICAgIGNvbnRlbnQucm9vdEZvbGRlciwgdmltdHlwZSwgVHJ1ZSkKICAgIGZvciBjIGluIGNvbnRhaW5lci52aWV3OgogICAgICAgIGlmIG5hbWU6CiAgICAgICAgICAgIGlmIGMubmFtZSA9PSBuYW1lOgogICAgICAgICAgICAgICAgb2JqID0gYwogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICBlbHNlOgogICAgICAgICAgICBvYmogPSBjCiAgICAgICAgICAgIGJyZWFrCgogICAgY29udGFpbmVyLkRlc3Ryb3koKQogICAgcmV0dXJuIG9iagoKCmRlZiBtYWluKCk6CiAgICBtb2R1bGUgPSBBbnNpYmxlTW9kdWxlKAogICAgICAgIGFyZ3VtZW50X3NwZWM9ZGljdCgKICAgICAgICAgICAgaG9zdG5hbWU9ZGljdCgKICAgICAgICAgICAgICAgIHR5cGU9J3N0cicsCiAgICAgICAgICAgICAgICBkZWZhdWx0PW9zLmVudmlyb24uZ2V0KCdWTVdBUkVfSE9TVCcpCiAgICAgICAgICAgICksCiAgICAgICAgICAgIHVzZXJuYW1lPWRpY3QoCiAgICAgICAgICAgICAgICB0eXBlPSdzdHInLAogICAgICAgICAgICAgICAgZGVmYXVsdD1vcy5lbnZpcm9uLmdldCgnVk1XQVJFX1VTRVInKQogICAgICAgICAgICApLAogICAgICAgICAgICBwYXNzd29yZD1kaWN0KAogICAgICAgICAgICAgICAgdHlwZT0nc3RyJywgbm9fbG9nPVRydWUsCiAgICAgICAgICAgICAgICBkZWZhdWx0PW9zLmVudmlyb24uZ2V0KCdWTVdBUkVfUEFTU1dPUkQnKQogICAgICAgICAgICApLAogICAgICAgICAgICBzdGF0ZT1kaWN0KAogICAgICAgICAgICAgICAgcmVxdWlyZWQ9RmFsc2UsCiAgICAgICAgICAgICAgICBjaG9pY2VzPVsKICAgICAgICAgICAgICAgICAgICAncG93ZXJlZG9uJywKICAgICAgICAgICAgICAgICAgICAncG93ZXJlZG9mZicsCiAgICAgICAgICAgICAgICAgICAgJ3ByZXNlbnQnLAogICAgICAgICAgICAgICAgICAgICdhYnNlbnQnLAogICAgICAgICAgICAgICAgICAgICdyZXN0YXJ0ZWQnLAogICAgICAgICAgICAgICAgICAgICdzdXNwZW5kZWQnLAogICAgICAgICAgICAgICAgICAgICdzaHV0ZG93bmd1ZXN0JywKICAgICAgICAgICAgICAgICAgICAncmVib290Z3Vlc3QnCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgZGVmYXVsdD0ncHJlc2VudCcpLAogICAgICAgICAgICB2YWxpZGF0ZV9jZXJ0cz1kaWN0KHR5cGU9J2Jvb2wnLCBkZWZhdWx0PVRydWUpLAogICAgICAgICAgICB0ZW1wbGF0ZV9zcmM9ZGljdCh0eXBlPSdzdHInLCBhbGlhc2VzPVsndGVtcGxhdGUnXSksCiAgICAgICAgICAgIGlzX3RlbXBsYXRlPWRpY3QodHlwZT0nYm9vbCcsIGRlZmF1bHQ9RmFsc2UpLAogICAgICAgICAgICBhbm5vdGF0aW9uPWRpY3QodHlwZT0nc3RyJywgYWxpYXNlcz1bJ25vdGVzJ10pLAogICAgICAgICAgICBjdXN0b212YWx1ZXM9ZGljdCh0eXBlPSdsaXN0JywgZGVmYXVsdD1bXSksCiAgICAgICAgICAgIG5hbWU9ZGljdChyZXF1aXJlZD1UcnVlLCB0eXBlPSdzdHInKSwKICAgICAgICAgICAgbmFtZV9tYXRjaD1kaWN0KHR5cGU9J3N0cicsIGRlZmF1bHQ9J2ZpcnN0JyksCiAgICAgICAgICAgIHV1aWQ9ZGljdCh0eXBlPSdzdHInKSwKICAgICAgICAgICAgZm9sZGVyPWRpY3QodHlwZT0nc3RyJywgZGVmYXVsdD0nL3ZtJyksCiAgICAgICAgICAgIGd1ZXN0X2lkPWRpY3QodHlwZT0nc3RyJyksCiAgICAgICAgICAgIGRpc2s9ZGljdCh0eXBlPSdsaXN0JywgZGVmYXVsdD1bXSksCiAgICAgICAgICAgIGhhcmR3YXJlPWRpY3QodHlwZT0nZGljdCcsIGRlZmF1bHQ9e30pLAogICAgICAgICAgICBmb3JjZT1kaWN0KHR5cGU9J2Jvb2wnLCBkZWZhdWx0PUZhbHNlKSwKICAgICAgICAgICAgZGF0YWNlbnRlcj1kaWN0KHR5cGU9J3N0cicsIGRlZmF1bHQ9J2hhLWRhdGFjZW50ZXInKSwKICAgICAgICAgICAgZXN4aV9ob3N0bmFtZT1kaWN0KHR5cGU9J3N0cicpLAogICAgICAgICAgICBjbHVzdGVyPWRpY3QodHlwZT0nc3RyJyksCiAgICAgICAgICAgIHdhaXRfZm9yX2lwX2FkZHJlc3M9ZGljdCh0eXBlPSdib29sJywgZGVmYXVsdD1GYWxzZSksCiAgICAgICAgICAgIHNuYXBzaG90X3NyYz1kaWN0KHR5cGU9J3N0cicsIGRlZmF1bHQ9Tm9uZSksCiAgICAgICAgICAgIGxpbmtlZF9jbG9uZT1kaWN0KHR5cGU9J2Jvb2wnLCBkZWZhdWx0PUZhbHNlKSwKICAgICAgICAgICAgbmV0d29ya3M9ZGljdCh0eXBlPSdsaXN0JywgZGVmYXVsdD1bXSksCiAgICAgICAgICAgIHJlc291cmNlX3Bvb2w9ZGljdCh0eXBlPSdzdHInKSwKICAgICAgICAgICAgY3VzdG9taXphdGlvbj1kaWN0KHR5cGU9J2RpY3QnLCBub19sb2c9VHJ1ZSwgZGVmYXVsdD17fSksCiAgICAgICAgKSwKICAgICAgICBzdXBwb3J0c19jaGVja19tb2RlPVRydWUsCiAgICAgICAgbXV0dWFsbHlfZXhjbHVzaXZlPVsKICAgICAgICAgICAgWydlc3hpX2hvc3RuYW1lJywgJ2NsdXN0ZXInXSwKICAgICAgICBdLAogICAgICAgIHJlcXVpcmVkX3RvZ2V0aGVyPVsKICAgICAgICAgICAgWydzdGF0ZScsICdmb3JjZSddLAogICAgICAgICAgICBbJ3RlbXBsYXRlJ10sCiAgICAgICAgXSwKICAgICkKCiAgICByZXN1bHQgPSB7J2ZhaWxlZCc6IEZhbHNlLCAnY2hhbmdlZCc6IEZhbHNlfQoKICAgICMgUHJlcGVuZCAvdm0gaWYgaXQgd2FzIG1pc3NpbmcgZnJvbSB0aGUgZm9sZGVyIHBhdGgsIGFsc28gc3RyaXAgdHJhaWxpbmcgc2xhc2hlcwogICAgaWYgbm90IG1vZHVsZS5wYXJhbXNbJ2ZvbGRlciddLnN0YXJ0c3dpdGgoJy92bScpIGFuZCBtb2R1bGUucGFyYW1zWydmb2xkZXInXS5zdGFydHN3aXRoKCcvJyk6CiAgICAgICAgbW9kdWxlLnBhcmFtc1snZm9sZGVyJ10gPSAnL3ZtJShmb2xkZXIpcycgJSBtb2R1bGUucGFyYW1zCiAgICBtb2R1bGUucGFyYW1zWydmb2xkZXInXSA9IG1vZHVsZS5wYXJhbXNbJ2ZvbGRlciddLnJzdHJpcCgnLycpCgogICAgcHl2ID0gUHlWbW9taUhlbHBlcihtb2R1bGUpCiAgICAjIENoZWNrIGlmIHRoZSBWTSBleGlzdHMgYmVmb3JlIGNvbnRpbnVpbmcKICAgIHZtID0gcHl2LmdldHZtKG5hbWU9bW9kdWxlLnBhcmFtc1snbmFtZSddLAogICAgICAgICAgICAgICAgICAgZm9sZGVyPW1vZHVsZS5wYXJhbXNbJ2ZvbGRlciddLAogICAgICAgICAgICAgICAgICAgdXVpZD1tb2R1bGUucGFyYW1zWyd1dWlkJ10pCgogICAgIyBWTSBhbHJlYWR5IGV4aXN0cwogICAgaWYgdm06CiAgICAgICAgaWYgbW9kdWxlLnBhcmFtc1snc3RhdGUnXSA9PSAnYWJzZW50JzoKICAgICAgICAgICAgIyBkZXN0cm95IGl0CiAgICAgICAgICAgIGlmIG1vZHVsZS5wYXJhbXNbJ2ZvcmNlJ106CiAgICAgICAgICAgICAgICAjIGhhcyB0byBiZSBwb3dlcmVkb2ZmIGZpcnN0CiAgICAgICAgICAgICAgICBweXYuc2V0X3Bvd2Vyc3RhdGUodm0sICdwb3dlcmVkb2ZmJywgbW9kdWxlLnBhcmFtc1snZm9yY2UnXSkKICAgICAgICAgICAgcmVzdWx0ID0gcHl2LnJlbW92ZV92bSh2bSkKICAgICAgICBlbGlmIG1vZHVsZS5wYXJhbXNbJ3N0YXRlJ10gPT0gJ3ByZXNlbnQnOgogICAgICAgICAgICByZXN1bHQgPSBweXYucmVjb25maWd1cmVfdm0oKQogICAgICAgIGVsaWYgbW9kdWxlLnBhcmFtc1snc3RhdGUnXSBpbiBbJ3Bvd2VyZWRvbicsICdwb3dlcmVkb2ZmJywgJ3Jlc3RhcnRlZCcsICdzdXNwZW5kZWQnLCAnc2h1dGRvd25ndWVzdCcsICdyZWJvb3RndWVzdCddOgogICAgICAgICAgICAjIHNldCBwb3dlcnN0YXRlCiAgICAgICAgICAgIHRtcF9yZXN1bHQgPSBweXYuc2V0X3Bvd2Vyc3RhdGUodm0sIG1vZHVsZS5wYXJhbXNbJ3N0YXRlJ10sIG1vZHVsZS5wYXJhbXNbJ2ZvcmNlJ10pCiAgICAgICAgICAgIGlmIHRtcF9yZXN1bHRbJ2NoYW5nZWQnXToKICAgICAgICAgICAgICAgIHJlc3VsdFsiY2hhbmdlZCJdID0gVHJ1ZQogICAgICAgICAgICBpZiBub3QgdG1wX3Jlc3VsdFsiZmFpbGVkIl06CiAgICAgICAgICAgICAgICByZXN1bHRbImZhaWxlZCJdID0gRmFsc2UKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIFRoaXMgc2hvdWxkIG5vdCBoYXBwZW4KICAgICAgICAgICAgYXNzZXJ0IEZhbHNlCiAgICAjIFZNIGRvZXNuJ3QgZXhpc3QKICAgIGVsc2U6CiAgICAgICAgaWYgbW9kdWxlLnBhcmFtc1snc3RhdGUnXSBpbiBbJ3Bvd2VyZWRvbicsICdwb3dlcmVkb2ZmJywgJ3ByZXNlbnQnLCAncmVzdGFydGVkJywgJ3N1c3BlbmRlZCddOgogICAgICAgICAgICAjIENyZWF0ZSBpdCAuLi4KICAgICAgICAgICAgcmVzdWx0ID0gcHl2LmRlcGxveV92bSgpCgogICAgaWYgJ2ZhaWxlZCcgbm90IGluIHJlc3VsdDoKICAgICAgICByZXN1bHRbJ2ZhaWxlZCddID0gRmFsc2UKCiAgICBpZiByZXN1bHRbJ2ZhaWxlZCddOgogICAgICAgIG1vZHVsZS5mYWlsX2pzb24oKipyZXN1bHQpCiAgICBlbHNlOgogICAgICAgIG1vZHVsZS5leGl0X2pzb24oKipyZXN1bHQpCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgbWFpbigpClBLAwQUAAAAAAABvCtLO985lTCKAQAwigEAHQAAAGFuc2libGUvbW9kdWxlX3V0aWxzL2Jhc2ljLnB5IyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojIFRoaXMgcGFydGljdWxhciBmaWxlIHNuaXBwZXQsIGFuZCB0aGlzIGZpbGUgc25pcHBldCBvbmx5LCBpcyBCU0QgbGljZW5zZWQuCiMgTW9kdWxlcyB5b3Ugd3JpdGUgdXNpbmcgdGhpcyBzbmlwcGV0LCB3aGljaCBpcyBlbWJlZGRlZCBkeW5hbWljYWxseSBieSBBbnNpYmxlCiMgc3RpbGwgYmVsb25nIHRvIHRoZSBhdXRob3Igb2YgdGhlIG1vZHVsZSwgYW5kIG1heSBhc3NpZ24gdGhlaXIgb3duIGxpY2Vuc2UKIyB0byB0aGUgY29tcGxldGUgd29yay4KIwojIENvcHlyaWdodCAoYyksIE1pY2hhZWwgRGVIYWFuIDxtaWNoYWVsLmRlaGFhbkBnbWFpbC5jb20+LCAyMDEyLTIwMTMKIyBDb3B5cmlnaHQgKGMpLCBUb3NoaW8gS3VyYXRvbWkgPHRrdXJhdG9taUBhbnNpYmxlLmNvbT4gMjAxNgojIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiMKIyBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQgbW9kaWZpY2F0aW9uLAojIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKIwojICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKIyAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwKIyAgICAgIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24KIyAgICAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORAojIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVECiMgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRSBESVNDTEFJTUVELgojIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULAojIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywKIyBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MKIyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUCiMgTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFCiMgVVNFIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiMKCkJPT0xFQU5TX1RSVUUgPSBbJ3knLCAneWVzJywgJ29uJywgJzEnLCAndHJ1ZScsIDEsIFRydWVdCkJPT0xFQU5TX0ZBTFNFID0gWyduJywgJ25vJywgJ29mZicsICcwJywgJ2ZhbHNlJywgMCwgRmFsc2VdCkJPT0xFQU5TID0gQk9PTEVBTlNfVFJVRSArIEJPT0xFQU5TX0ZBTFNFCgpTSVpFX1JBTkdFUyA9IHsgJ1knOiAxPDw4MCwgJ1onOiAxPDw3MCwgJ0UnOiAxPDw2MCwgJ1AnOiAxPDw1MCwgJ1QnOiAxPDw0MCwgJ0cnOiAxPDwzMCwgJ00nOiAxPDwyMCwgJ0snOiAxPDwxMCwgJ0InOiAxIH0KCkZJTEVfQVRUUklCVVRFUyA9IHsKICAgICdBJzogJ25vYXRpbWUnLAogICAgJ2EnOiAnYXBwZW5kJywKICAgICdjJzogJ2NvbXByZXNzZWQnLAogICAgJ0MnOiAnbm9jb3cnLAogICAgJ2QnOiAnbm9kdW1wJywKICAgICdEJzogJ2RpcnN5bmMnLAogICAgJ2UnOiAnZXh0ZW50cycsCiAgICAnRSc6ICdlbmNyeXB0ZWQnLAogICAgJ2gnOiAnYmxvY2tzaXplJywKICAgICdpJzogJ2ltbXV0YWJsZScsCiAgICAnSSc6ICdpbmRleGVkJywKICAgICdqJzogJ2pvdXJuYWxsZWQnLAogICAgJ04nOiAnaW5saW5lJywKICAgICdzJzogJ3plcm8nLAogICAgJ1MnOiAnc3luY2hyb25vdXMnLAogICAgJ3QnOiAnbm90YWlsJywKICAgICdUJzogJ2Jsb2Nrcm9vdCcsCiAgICAndSc6ICd1bmRlbGV0ZScsCiAgICAnWCc6ICdjb21wcmVzc2VkcmF3JywKICAgICdaJzogJ2NvbXByZXNzZWRkaXJ0eScsCn0KCiMgYW5zaWJsZSBtb2R1bGVzIGNhbiBiZSB3cml0dGVuIGluIGFueSBsYW5ndWFnZS4gIFRvIHNpbXBsaWZ5CiMgZGV2ZWxvcG1lbnQgb2YgUHl0aG9uIG1vZHVsZXMsIHRoZSBmdW5jdGlvbnMgYXZhaWxhYmxlIGhlcmUgY2FuCiMgYmUgdXNlZCB0byBkbyBtYW55IGNvbW1vbiB0YXNrcwoKaW1wb3J0IGxvY2FsZQppbXBvcnQgb3MKaW1wb3J0IHJlCmltcG9ydCBzaGxleAppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgc3lzCmltcG9ydCB0eXBlcwppbXBvcnQgdGltZQppbXBvcnQgc2VsZWN0CmltcG9ydCBzaHV0aWwKaW1wb3J0IHN0YXQKaW1wb3J0IHRlbXBmaWxlCmltcG9ydCB0cmFjZWJhY2sKaW1wb3J0IGdycAppbXBvcnQgcHdkCmltcG9ydCBwbGF0Zm9ybQppbXBvcnQgZXJybm8KaW1wb3J0IGRhdGV0aW1lCmZyb20gaXRlcnRvb2xzIGltcG9ydCByZXBlYXQsIGNoYWluCgp0cnk6CiAgICBpbXBvcnQgc3lzbG9nCiAgICBIQVNfU1lTTE9HPVRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgSEFTX1NZU0xPRz1GYWxzZQoKdHJ5OgogICAgZnJvbSBzeXN0ZW1kIGltcG9ydCBqb3VybmFsCiAgICBoYXNfam91cm5hbCA9IFRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaGFzX2pvdXJuYWwgPSBGYWxzZQoKSEFWRV9TRUxJTlVYPUZhbHNlCnRyeToKICAgIGltcG9ydCBzZWxpbnV4CiAgICBIQVZFX1NFTElOVVg9VHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBwYXNzCgojIFB5dGhvbjIgJiAzIHdheSB0byBnZXQgTm9uZVR5cGUKTm9uZVR5cGUgPSB0eXBlKE5vbmUpCgp0cnk6CiAgICBmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBTZXF1ZW5jZSwgTWFwcGluZwpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAjIHB5dGhvbjIuNQogICAgU2VxdWVuY2UgPSAobGlzdCwgdHVwbGUpCiAgICBNYXBwaW5nID0gKGRpY3QsKQoKIyBOb3RlOiBXaGVuIGdldHRpbmcgU2VxdWVuY2UgZnJvbSBjb2xsZWN0aW9ucywgaXQgbWF0Y2hlcyB3aXRoIHN0cmluZ3MuICBJZgojIHRoaXMgbWF0dGVycywgbWFrZSBzdXJlIHRvIGNoZWNrIGZvciBzdHJpbmdzIGJlZm9yZSBjaGVja2luZyBmb3Igc2VxdWVuY2V0eXBlCnRyeToKICAgIGZyb20gY29sbGVjdGlvbnMuYWJjIGltcG9ydCBLZXlzVmlldwogICAgU0VRVUVOQ0VUWVBFID0gKFNlcXVlbmNlLCBLZXlzVmlldykKZXhjZXB0OgogICAgU0VRVUVOQ0VUWVBFID0gU2VxdWVuY2UKCnRyeToKICAgIGltcG9ydCBqc29uCiAgICAjIERldGVjdCB0aGUgcHl0aG9uLWpzb24gbGlicmFyeSB3aGljaCBpcyBpbmNvbXBhdGlibGUKICAgICMgTG9vayBmb3Igc2ltcGxlanNvbiBpZiB0aGF0J3MgdGhlIGNhc2UKICAgIHRyeToKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShqc29uLmxvYWRzLCB0eXBlcy5GdW5jdGlvblR5cGUpIG9yIG5vdCBpc2luc3RhbmNlKGpzb24uZHVtcHMsIHR5cGVzLkZ1bmN0aW9uVHlwZSk6CiAgICAgICAgICAgIHJhaXNlIEltcG9ydEVycm9yCiAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IKZXhjZXB0IEltcG9ydEVycm9yOgogICAgdHJ5OgogICAgICAgIGltcG9ydCBzaW1wbGVqc29uIGFzIGpzb24KICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICBwcmludCgnXG57Im1zZyI6ICJFcnJvcjogYW5zaWJsZSByZXF1aXJlcyB0aGUgc3RkbGliIGpzb24gb3Igc2ltcGxlanNvbiBtb2R1bGUsIG5laXRoZXIgd2FzIGZvdW5kISIsICJmYWlsZWQiOiB0cnVlfScpCiAgICAgICAgc3lzLmV4aXQoMSkKICAgIGV4Y2VwdCBTeW50YXhFcnJvcjoKICAgICAgICBwcmludCgnXG57Im1zZyI6ICJTeW50YXhFcnJvcjogcHJvYmFibHkgZHVlIHRvIGluc3RhbGxlZCBzaW1wbGVqc29uIGJlaW5nIGZvciBhIGRpZmZlcmVudCBweXRob24gdmVyc2lvbiIsICJmYWlsZWQiOiB0cnVlfScpCiAgICAgICAgc3lzLmV4aXQoMSkKCkFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVMgPSBkaWN0KCkKdHJ5OgogICAgaW1wb3J0IGhhc2hsaWIKCiAgICAjIHB5dGhvbiAyLjcuOSsgYW5kIDIuNy4wKwogICAgZm9yIGF0dHJpYnV0ZSBpbiAoJ2F2YWlsYWJsZV9hbGdvcml0aG1zJywgJ2FsZ29yaXRobXMnKToKICAgICAgICBhbGdvcml0aG1zID0gZ2V0YXR0cihoYXNobGliLCBhdHRyaWJ1dGUsIE5vbmUpCiAgICAgICAgaWYgYWxnb3JpdGhtczoKICAgICAgICAgICAgYnJlYWsKICAgIGlmIGFsZ29yaXRobXMgaXMgTm9uZToKICAgICAgICAjIHB5dGhvbiAyLjUrCiAgICAgICAgYWxnb3JpdGhtcyA9ICgnbWQ1JywgJ3NoYTEnLCAnc2hhMjI0JywgJ3NoYTI1NicsICdzaGEzODQnLCAnc2hhNTEyJykKICAgIGZvciBhbGdvcml0aG0gaW4gYWxnb3JpdGhtczoKICAgICAgICBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TW2FsZ29yaXRobV0gPSBnZXRhdHRyKGhhc2hsaWIsIGFsZ29yaXRobSkKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaW1wb3J0IHNoYQogICAgQVZBSUxBQkxFX0hBU0hfQUxHT1JJVEhNUyA9IHsnc2hhMSc6IHNoYS5zaGF9CiAgICB0cnk6CiAgICAgICAgaW1wb3J0IG1kNQogICAgICAgIEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVNbJ21kNSddID0gbWQ1Lm1kNQogICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgIHBhc3MKCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMucHljb21wYXQyNCBpbXBvcnQgZ2V0X2V4Y2VwdGlvbiwgbGl0ZXJhbF9ldmFsCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGltcG9ydCAoUFkyLCBQWTMsIGIsIGJpbmFyeV90eXBlLCBpbnRlZ2VyX3R5cGVzLAogICAgICAgIGl0ZXJpdGVtcywgdGV4dF90eXBlLCBzdHJpbmdfdHlwZXMpCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Lm1vdmVzIGltcG9ydCBtYXAsIHJlZHVjZSwgc2hsZXhfcXVvdGUKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5fdGV4dCBpbXBvcnQgdG9fbmF0aXZlLCB0b19ieXRlcywgdG9fdGV4dAoKUEFTU1dPUkRfTUFUQ0ggPSByZS5jb21waWxlKHInXig/Oi4rWy1fXHNdKT9wYXNzKD86Wy1fXHNdPyg/OndvcmR8cGhyYXNlfHdyZHx3ZCk/KSg/OlstX1xzXS4rKT8kJywgcmUuSSkKCl9OVU1CRVJUWVBFUyA9IHR1cGxlKGxpc3QoaW50ZWdlcl90eXBlcykgKyBbZmxvYXRdKQoKIyBEZXByZWNhdGVkIGNvbXBhdC4gIE9ubHkga2VwdCBpbiBjYXNlIGFub3RoZXIgbW9kdWxlIHVzZWQgdGhlc2UgbmFtZXMgIFVzaW5nCiMgYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGlzIHByZWZlcnJlZAoKTlVNQkVSVFlQRVMgPSBfTlVNQkVSVFlQRVMKCmltYXAgPSBtYXAKCnRyeToKICAgICMgUHl0aG9uIDIKICAgIHVuaWNvZGUKZXhjZXB0IE5hbWVFcnJvcjoKICAgICMgUHl0aG9uIDMKICAgIHVuaWNvZGUgPSB0ZXh0X3R5cGUKCnRyeToKICAgICMgUHl0aG9uIDIuNisKICAgIGJ5dGVzCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICAjIFB5dGhvbiAyLjQKICAgIGJ5dGVzID0gYmluYXJ5X3R5cGUKCnRyeToKICAgICMgUHl0aG9uIDIKICAgIGJhc2VzdHJpbmcKZXhjZXB0IE5hbWVFcnJvcjoKICAgICMgUHl0aG9uIDMKICAgIGJhc2VzdHJpbmcgPSBzdHJpbmdfdHlwZXMKCl9saXRlcmFsX2V2YWwgPSBsaXRlcmFsX2V2YWwKCiMgRW5kIG9mIGRlcHJlY2F0ZWQgbmFtZXMKCiMgSW50ZXJuYWwgZ2xvYmFsIGhvbGRpbmcgcGFzc2VkIGluIHBhcmFtcy4gIFRoaXMgaXMgY29uc3VsdGVkIGluIGNhc2UKIyBtdWx0aXBsZSBBbnNpYmxlTW9kdWxlcyBhcmUgY3JlYXRlZC4gIE90aGVyd2lzZSBlYWNoIEFuc2libGVNb2R1bGUgd291bGQKIyBhdHRlbXB0IHRvIHJlYWQgZnJvbSBzdGRpbi4gIE90aGVyIGNvZGUgc2hvdWxkIG5vdCB1c2UgdGhpcyBkaXJlY3RseSBhcyBpdAojIGlzIGFuIGludGVybmFsIGltcGxlbWVudGF0aW9uIGRldGFpbApfQU5TSUJMRV9BUkdTID0gTm9uZQoKRklMRV9DT01NT05fQVJHVU1FTlRTPWRpY3QoCiAgICBzcmMgPSBkaWN0KCksCiAgICBtb2RlID0gZGljdCh0eXBlPSdyYXcnKSwKICAgIG93bmVyID0gZGljdCgpLAogICAgZ3JvdXAgPSBkaWN0KCksCiAgICBzZXVzZXIgPSBkaWN0KCksCiAgICBzZXJvbGUgPSBkaWN0KCksCiAgICBzZWxldmVsID0gZGljdCgpLAogICAgc2V0eXBlID0gZGljdCgpLAogICAgZm9sbG93ID0gZGljdCh0eXBlPSdib29sJywgZGVmYXVsdD1GYWxzZSksCiAgICAjIG5vdCB0YWtlbiBieSB0aGUgZmlsZSBtb2R1bGUsIGJ1dCBvdGhlciBtb2R1bGVzIGNhbGwgZmlsZSBzbyBpdCBtdXN0IGlnbm9yZSB0aGVtLgogICAgY29udGVudCA9IGRpY3Qobm9fbG9nPVRydWUpLAogICAgYmFja3VwID0gZGljdCgpLAogICAgZm9yY2UgPSBkaWN0KCksCiAgICByZW1vdGVfc3JjID0gZGljdCgpLCAjIHVzZWQgYnkgYXNzZW1ibGUKICAgIHJlZ2V4cCA9IGRpY3QoKSwgIyB1c2VkIGJ5IGFzc2VtYmxlCiAgICBkZWxpbWl0ZXIgPSBkaWN0KCksICMgdXNlZCBieSBhc3NlbWJsZQogICAgZGlyZWN0b3J5X21vZGUgPSBkaWN0KCksICMgdXNlZCBieSBjb3B5CiAgICB1bnNhZmVfd3JpdGVzICA9IGRpY3QodHlwZT0nYm9vbCcpLCAjIHNob3VsZCBiZSBhdmFpbGFibGUgdG8gYW55IG1vZHVsZSB1c2luZyBhdG9taWNfbW92ZQogICAgYXR0cmlidXRlcyA9IGRpY3QoYWxpYXNlcz1bJ2F0dHInXSksCikKClBBU1NXRF9BUkdfUkUgPSByZS5jb21waWxlKHInXlstXXswLDJ9cGFzc1stXT8od29yZHx3ZCk/JykKCiMgQ2FuJ3QgdXNlIDA3Nzc3IG9uIFB5dGhvbiAzLCBjYW4ndCB1c2UgMG83Nzc3IG9uIFB5dGhvbiAyLjQKUEVSTV9CSVRTID0gaW50KCcwNzc3NycsIDgpICAgICAgIyBmaWxlIG1vZGUgcGVybWlzc2lvbiBiaXRzCkVYRUNfUEVSTV9CSVRTID0gaW50KCcwMDExMScsIDgpICMgZXhlY3V0ZSBwZXJtaXNzaW9uIGJpdHMKREVGQVVMVF9QRVJNID0gaW50KCcwNjY2JywgOCkgICAgIyBkZWZhdWx0IGZpbGUgcGVybWlzc2lvbiBiaXRzCgoKZGVmIGdldF9wbGF0Zm9ybSgpOgogICAgJycnIHdoYXQncyB0aGUgcGxhdGZvcm0/ICBleGFtcGxlOiBMaW51eCBpcyBhIHBsYXRmb3JtLiAnJycKICAgIHJldHVybiBwbGF0Zm9ybS5zeXN0ZW0oKQoKZGVmIGdldF9kaXN0cmlidXRpb24oKToKICAgICcnJyByZXR1cm4gdGhlIGRpc3RyaWJ1dGlvbiBuYW1lICcnJwogICAgaWYgcGxhdGZvcm0uc3lzdGVtKCkgPT0gJ0xpbnV4JzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN1cHBvcnRlZF9kaXN0cyA9IHBsYXRmb3JtLl9zdXBwb3J0ZWRfZGlzdHMgKyAoJ2FyY2gnLCdhbHBpbmUnKQogICAgICAgICAgICBkaXN0cmlidXRpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oc3VwcG9ydGVkX2Rpc3RzPXN1cHBvcnRlZF9kaXN0cylbMF0uY2FwaXRhbGl6ZSgpCiAgICAgICAgICAgIGlmIG5vdCBkaXN0cmlidXRpb24gYW5kIG9zLnBhdGguaXNmaWxlKCcvZXRjL3N5c3RlbS1yZWxlYXNlJyk6CiAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oc3VwcG9ydGVkX2Rpc3RzPVsnc3lzdGVtJ10pWzBdLmNhcGl0YWxpemUoKQogICAgICAgICAgICAgICAgaWYgJ0FtYXpvbicgaW4gZGlzdHJpYnV0aW9uOgogICAgICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9ICdBbWF6b24nCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9ICdPdGhlckxpbnV4JwogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgIyBGSVhNRTogTWV0aG9kTWlzc2luZywgSSBhc3N1bWU/CiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9IHBsYXRmb3JtLmRpc3QoKVswXS5jYXBpdGFsaXplKCkKICAgIGVsc2U6CiAgICAgICAgZGlzdHJpYnV0aW9uID0gTm9uZQogICAgcmV0dXJuIGRpc3RyaWJ1dGlvbgoKZGVmIGdldF9kaXN0cmlidXRpb25fdmVyc2lvbigpOgogICAgJycnIHJldHVybiB0aGUgZGlzdHJpYnV0aW9uIHZlcnNpb24gJycnCiAgICBpZiBwbGF0Zm9ybS5zeXN0ZW0oKSA9PSAnTGludXgnOgogICAgICAgIHRyeToKICAgICAgICAgICAgZGlzdHJpYnV0aW9uX3ZlcnNpb24gPSBwbGF0Zm9ybS5saW51eF9kaXN0cmlidXRpb24oKVsxXQogICAgICAgICAgICBpZiBub3QgZGlzdHJpYnV0aW9uX3ZlcnNpb24gYW5kIG9zLnBhdGguaXNmaWxlKCcvZXRjL3N5c3RlbS1yZWxlYXNlJyk6CiAgICAgICAgICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IHBsYXRmb3JtLmxpbnV4X2Rpc3RyaWJ1dGlvbihzdXBwb3J0ZWRfZGlzdHM9WydzeXN0ZW0nXSlbMV0KICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICMgRklYTUU6IE1ldGhvZE1pc3NpbmcsIEkgYXNzdW1lPwogICAgICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IHBsYXRmb3JtLmRpc3QoKVsxXQogICAgZWxzZToKICAgICAgICBkaXN0cmlidXRpb25fdmVyc2lvbiA9IE5vbmUKICAgIHJldHVybiBkaXN0cmlidXRpb25fdmVyc2lvbgoKZGVmIGdldF9hbGxfc3ViY2xhc3NlcyhjbHMpOgogICAgJycnCiAgICB1c2VkIGJ5IG1vZHVsZXMgbGlrZSBIYXJkd2FyZSBvciBOZXR3b3JrIGZhY3QgY2xhc3NlcyB0byByZXRyaWV2ZSBhbGwgc3ViY2xhc3NlcyBvZiBhIGdpdmVuIGNsYXNzLgogICAgX19zdWJjbGFzc2VzX18gcmV0dXJuIG9ubHkgZGlyZWN0IHN1YiBjbGFzc2VzLiBUaGlzIG9uZSBnbyBkb3duIGludG8gdGhlIGNsYXNzIHRyZWUuCiAgICAnJycKICAgICMgUmV0cmlldmUgZGlyZWN0IHN1YmNsYXNzZXMKICAgIHN1YmNsYXNzZXMgPSBjbHMuX19zdWJjbGFzc2VzX18oKQogICAgdG9fdmlzaXQgPSBsaXN0KHN1YmNsYXNzZXMpCiAgICAjIFRoZW4gdmlzaXQgYWxsIHN1YmNsYXNzZXMKICAgIHdoaWxlIHRvX3Zpc2l0OgogICAgICAgIGZvciBzYyBpbiB0b192aXNpdDoKICAgICAgICAgICAgIyBUaGUgY3VycmVudCBjbGFzcyBpcyBub3cgdmlzaXRlZCwgc28gcmVtb3ZlIGl0IGZyb20gbGlzdAogICAgICAgICAgICB0b192aXNpdC5yZW1vdmUoc2MpCiAgICAgICAgICAgICMgQXBwZW5kaW5nIGFsbCBzdWJjbGFzc2VzIHRvIHZpc2l0IGFuZCBrZWVwIGEgcmVmZXJlbmNlIG9mIGF2YWlsYWJsZSBjbGFzcwogICAgICAgICAgICBmb3Igc3NjIGluIHNjLl9fc3ViY2xhc3Nlc19fKCk6CiAgICAgICAgICAgICAgICBzdWJjbGFzc2VzLmFwcGVuZChzc2MpCiAgICAgICAgICAgICAgICB0b192aXNpdC5hcHBlbmQoc3NjKQogICAgcmV0dXJuIHN1YmNsYXNzZXMKCgpkZWYgbG9hZF9wbGF0Zm9ybV9zdWJjbGFzcyhjbHMsICphcmdzLCAqKmt3YXJncyk6CiAgICAnJycKICAgIHVzZWQgYnkgbW9kdWxlcyBsaWtlIFVzZXIgdG8gaGF2ZSBkaWZmZXJlbnQgaW1wbGVtZW50YXRpb25zIGJhc2VkIG9uIGRldGVjdGVkIHBsYXRmb3JtLiAgU2VlIFVzZXIKICAgIG1vZHVsZSBmb3IgYW4gZXhhbXBsZS4KICAgICcnJwoKICAgIHRoaXNfcGxhdGZvcm0gPSBnZXRfcGxhdGZvcm0oKQogICAgZGlzdHJpYnV0aW9uID0gZ2V0X2Rpc3RyaWJ1dGlvbigpCiAgICBzdWJjbGFzcyA9IE5vbmUKCiAgICAjIGdldCB0aGUgbW9zdCBzcGVjaWZpYyBzdXBlcmNsYXNzIGZvciB0aGlzIHBsYXRmb3JtCiAgICBpZiBkaXN0cmlidXRpb24gaXMgbm90IE5vbmU6CiAgICAgICAgZm9yIHNjIGluIGdldF9hbGxfc3ViY2xhc3NlcyhjbHMpOgogICAgICAgICAgICBpZiBzYy5kaXN0cmlidXRpb24gaXMgbm90IE5vbmUgYW5kIHNjLmRpc3RyaWJ1dGlvbiA9PSBkaXN0cmlidXRpb24gYW5kIHNjLnBsYXRmb3JtID09IHRoaXNfcGxhdGZvcm06CiAgICAgICAgICAgICAgICBzdWJjbGFzcyA9IHNjCiAgICBpZiBzdWJjbGFzcyBpcyBOb25lOgogICAgICAgIGZvciBzYyBpbiBnZXRfYWxsX3N1YmNsYXNzZXMoY2xzKToKICAgICAgICAgICAgaWYgc2MucGxhdGZvcm0gPT0gdGhpc19wbGF0Zm9ybSBhbmQgc2MuZGlzdHJpYnV0aW9uIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzdWJjbGFzcyA9IHNjCiAgICBpZiBzdWJjbGFzcyBpcyBOb25lOgogICAgICAgIHN1YmNsYXNzID0gY2xzCgogICAgcmV0dXJuIHN1cGVyKGNscywgc3ViY2xhc3MpLl9fbmV3X18oc3ViY2xhc3MpCgoKZGVmIGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzKGQsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpOgogICAgJycnIFJlY3Vyc2l2ZWx5IGNvbnZlcnQgZGljdCBrZXlzIGFuZCB2YWx1ZXMgdG8gYnl0ZSBzdHIKCiAgICAgICAgU3BlY2lhbGl6ZWQgZm9yIGpzb24gcmV0dXJuIGJlY2F1c2UgdGhpcyBvbmx5IGhhbmRsZXMsIGxpc3RzLCB0dXBsZXMsCiAgICAgICAgYW5kIGRpY3QgY29udGFpbmVyIHR5cGVzICh0aGUgY29udGFpbmVycyB0aGF0IHRoZSBqc29uIG1vZHVsZSByZXR1cm5zKQogICAgJycnCgogICAgaWYgaXNpbnN0YW5jZShkLCB0ZXh0X3R5cGUpOgogICAgICAgIHJldHVybiB0b19ieXRlcyhkLCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycykKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBkaWN0KToKICAgICAgICByZXR1cm4gZGljdChtYXAoanNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMsIGl0ZXJpdGVtcyhkKSwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIGxpc3QpOgogICAgICAgIHJldHVybiBsaXN0KG1hcChqc29uX2RpY3RfdW5pY29kZV90b19ieXRlcywgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIHR1cGxlKToKICAgICAgICByZXR1cm4gdHVwbGUobWFwKGpzb25fZGljdF91bmljb2RlX3RvX2J5dGVzLCBkLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbHNlOgogICAgICAgIHJldHVybiBkCgpkZWYganNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUoZCwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0Jyk6CiAgICAnJycgUmVjdXJzaXZlbHkgY29udmVydCBkaWN0IGtleXMgYW5kIHZhbHVlcyB0byBieXRlIHN0cgoKICAgICAgICBTcGVjaWFsaXplZCBmb3IganNvbiByZXR1cm4gYmVjYXVzZSB0aGlzIG9ubHkgaGFuZGxlcywgbGlzdHMsIHR1cGxlcywKICAgICAgICBhbmQgZGljdCBjb250YWluZXIgdHlwZXMgKHRoZSBjb250YWluZXJzIHRoYXQgdGhlIGpzb24gbW9kdWxlIHJldHVybnMpCiAgICAnJycKCiAgICBpZiBpc2luc3RhbmNlKGQsIGJpbmFyeV90eXBlKToKICAgICAgICAjIFdhcm5pbmcsIGNhbiB0cmFjZWJhY2sKICAgICAgICByZXR1cm4gdG9fdGV4dChkLCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycykKICAgIGVsaWYgaXNpbnN0YW5jZShkLCBkaWN0KToKICAgICAgICByZXR1cm4gZGljdChtYXAoanNvbl9kaWN0X2J5dGVzX3RvX3VuaWNvZGUsIGl0ZXJpdGVtcyhkKSwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIGxpc3QpOgogICAgICAgIHJldHVybiBsaXN0KG1hcChqc29uX2RpY3RfYnl0ZXNfdG9fdW5pY29kZSwgZCwgcmVwZWF0KGVuY29kaW5nKSwgcmVwZWF0KGVycm9ycykpKQogICAgZWxpZiBpc2luc3RhbmNlKGQsIHR1cGxlKToKICAgICAgICByZXR1cm4gdHVwbGUobWFwKGpzb25fZGljdF9ieXRlc190b191bmljb2RlLCBkLCByZXBlYXQoZW5jb2RpbmcpLCByZXBlYXQoZXJyb3JzKSkpCiAgICBlbHNlOgogICAgICAgIHJldHVybiBkCgpkZWYgcmV0dXJuX3ZhbHVlcyhvYmopOgogICAgIiIiIFJldHVybiBuYXRpdmUgc3RyaW5naWZpZWQgdmFsdWVzIGZyb20gZGF0YXN0cnVjdHVyZXMuCgogICAgRm9yIHVzZSB3aXRoIHJlbW92aW5nIHNlbnNpdGl2ZSB2YWx1ZXMgcHJlLWpzb25pZmljYXRpb24uIiIiCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICBpZiBvYmo6CiAgICAgICAgICAgIHlpZWxkIHRvX25hdGl2ZShvYmosIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgcmV0dXJuCiAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCBTRVFVRU5DRVRZUEUpOgogICAgICAgIGZvciBlbGVtZW50IGluIG9iajoKICAgICAgICAgICAgZm9yIHN1YmVsZW1lbnQgaW4gcmV0dXJuX3ZhbHVlcyhlbGVtZW50KToKICAgICAgICAgICAgICAgIHlpZWxkIHN1YmVsZW1lbnQKICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIE1hcHBpbmcpOgogICAgICAgIGZvciBlbGVtZW50IGluIG9iai5pdGVtcygpOgogICAgICAgICAgICBmb3Igc3ViZWxlbWVudCBpbiByZXR1cm5fdmFsdWVzKGVsZW1lbnRbMV0pOgogICAgICAgICAgICAgICAgeWllbGQgc3ViZWxlbWVudAogICAgZWxpZiBpc2luc3RhbmNlKG9iaiwgKGJvb2wsIE5vbmVUeXBlKSk6CiAgICAgICAgIyBUaGlzIG11c3QgY29tZSBiZWZvcmUgaW50IGJlY2F1c2UgYm9vbHMgYXJlIGFsc28gaW50cwogICAgICAgIHJldHVybgogICAgZWxpZiBpc2luc3RhbmNlKG9iaiwgTlVNQkVSVFlQRVMpOgogICAgICAgIHlpZWxkIHRvX25hdGl2ZShvYmosIG5vbnN0cmluZz0nc2ltcGxlcmVwcicpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignVW5rbm93biBwYXJhbWV0ZXIgdHlwZTogJXMsICVzJyAlICh0eXBlKG9iaiksIG9iaikpCgpkZWYgcmVtb3ZlX3ZhbHVlcyh2YWx1ZSwgbm9fbG9nX3N0cmluZ3MpOgogICAgIiIiIFJlbW92ZSBzdHJpbmdzIGluIG5vX2xvZ19zdHJpbmdzIGZyb20gdmFsdWUuICBJZiB2YWx1ZSBpcyBhIGNvbnRhaW5lcgogICAgdHlwZSwgdGhlbiByZW1vdmUgYSBsb3QgbW9yZSIiIgogICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICAjIE5lZWQgbmF0aXZlIHN0ciB0eXBlCiAgICAgICAgbmF0aXZlX3N0cl92YWx1ZSA9IHZhbHVlCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgdGV4dF90eXBlKToKICAgICAgICAgICAgdmFsdWVfaXNfdGV4dCA9IFRydWUKICAgICAgICAgICAgaWYgUFkyOgogICAgICAgICAgICAgICAgbmF0aXZlX3N0cl92YWx1ZSA9IHRvX2J5dGVzKHZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICB2YWx1ZV9pc190ZXh0ID0gRmFsc2UKICAgICAgICAgICAgaWYgUFkzOgogICAgICAgICAgICAgICAgbmF0aXZlX3N0cl92YWx1ZSA9IHRvX3RleHQodmFsdWUsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCgogICAgICAgIGlmIG5hdGl2ZV9zdHJfdmFsdWUgaW4gbm9fbG9nX3N0cmluZ3M6CiAgICAgICAgICAgIHJldHVybiAnVkFMVUVfU1BFQ0lGSUVEX0lOX05PX0xPR19QQVJBTUVURVInCiAgICAgICAgZm9yIG9taXRfbWUgaW4gbm9fbG9nX3N0cmluZ3M6CiAgICAgICAgICAgIG5hdGl2ZV9zdHJfdmFsdWUgPSBuYXRpdmVfc3RyX3ZhbHVlLnJlcGxhY2Uob21pdF9tZSwgJyonICogOCkKCiAgICAgICAgaWYgdmFsdWVfaXNfdGV4dCBhbmQgaXNpbnN0YW5jZShuYXRpdmVfc3RyX3ZhbHVlLCBiaW5hcnlfdHlwZSk6CiAgICAgICAgICAgIHZhbHVlID0gdG9fdGV4dChuYXRpdmVfc3RyX3ZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKQogICAgICAgIGVsaWYgbm90IHZhbHVlX2lzX3RleHQgYW5kIGlzaW5zdGFuY2UobmF0aXZlX3N0cl92YWx1ZSwgdGV4dF90eXBlKToKICAgICAgICAgICAgdmFsdWUgPSB0b19ieXRlcyhuYXRpdmVfc3RyX3ZhbHVlLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHZhbHVlID0gbmF0aXZlX3N0cl92YWx1ZQogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBTRVFVRU5DRVRZUEUpOgogICAgICAgIHJldHVybiBbcmVtb3ZlX3ZhbHVlcyhlbGVtLCBub19sb2dfc3RyaW5ncykgZm9yIGVsZW0gaW4gdmFsdWVdCiAgICBlbGlmIGlzaW5zdGFuY2UodmFsdWUsIE1hcHBpbmcpOgogICAgICAgIHJldHVybiBkaWN0KChrLCByZW1vdmVfdmFsdWVzKHYsIG5vX2xvZ19zdHJpbmdzKSkgZm9yIGssIHYgaW4gdmFsdWUuaXRlbXMoKSkKICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgdHVwbGUoY2hhaW4oTlVNQkVSVFlQRVMsIChib29sLCBOb25lVHlwZSkpKSk6CiAgICAgICAgc3RyaW5neV92YWx1ZSA9IHRvX25hdGl2ZSh2YWx1ZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBpZiBzdHJpbmd5X3ZhbHVlIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICByZXR1cm4gJ1ZBTFVFX1NQRUNJRklFRF9JTl9OT19MT0dfUEFSQU1FVEVSJwogICAgICAgIGZvciBvbWl0X21lIGluIG5vX2xvZ19zdHJpbmdzOgogICAgICAgICAgICBpZiBvbWl0X21lIGluIHN0cmluZ3lfdmFsdWU6CiAgICAgICAgICAgICAgICByZXR1cm4gJ1ZBTFVFX1NQRUNJRklFRF9JTl9OT19MT0dfUEFSQU1FVEVSJwogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBkYXRldGltZS5kYXRldGltZSk6CiAgICAgICAgdmFsdWUgPSB2YWx1ZS5pc29mb3JtYXQoKQogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ1ZhbHVlIG9mIHVua25vd24gdHlwZTogJXMsICVzJyAlICh0eXBlKHZhbHVlKSwgdmFsdWUpKQogICAgcmV0dXJuIHZhbHVlCgoKZGVmIGhldXJpc3RpY19sb2dfc2FuaXRpemUoZGF0YSwgbm9fbG9nX3ZhbHVlcz1Ob25lKToKICAgICcnJyBSZW1vdmUgc3RyaW5ncyB0aGF0IGxvb2sgbGlrZSBwYXNzd29yZHMgZnJvbSBsb2cgbWVzc2FnZXMgJycnCiAgICAjIEN1cnJlbnRseSBmaWx0ZXJzOgogICAgIyB1c2VyOnBhc3NAZm9vL3doYXRldmVyIGFuZCBodHRwOi8vdXNlcm5hbWU6cGFzc0B3aGVyZXZlci9mb28KICAgICMgVGhpcyBjb2RlIGhhcyBmYWxzZSBwb3NpdGl2ZXMgYW5kIGNvbnN1bWVzIHBhcnRzIG9mIGxvZ3MgdGhhdCBhcmUKICAgICMgbm90IHBhc3N3ZHMKCiAgICAjIGJlZ2luOiBzdGFydCBvZiBhIHBhc3N3ZCBjb250YWluaW5nIHN0cmluZwogICAgIyBlbmQ6IGVuZCBvZiBhIHBhc3N3ZCBjb250YWluaW5nIHN0cmluZwogICAgIyBzZXA6IGNoYXIgYmV0d2VlbiB1c2VyIGFuZCBwYXNzd2QKICAgICMgcHJldl9iZWdpbjogd2hlcmUgaW4gdGhlIG92ZXJhbGwgc3RyaW5nIHRvIHN0YXJ0IGEgc2VhcmNoIGZvcgogICAgIyAgIGEgcGFzc3dkCiAgICAjIHNlcF9zZWFyY2hfZW5kOiB3aGVyZSBpbiB0aGUgc3RyaW5nIHRvIGVuZCBhIHNlYXJjaCBmb3IgdGhlIHNlcAogICAgZGF0YSA9IHRvX25hdGl2ZShkYXRhKQoKICAgIG91dHB1dCA9IFtdCiAgICBiZWdpbiA9IGxlbihkYXRhKQogICAgcHJldl9iZWdpbiA9IGJlZ2luCiAgICBzZXAgPSAxCiAgICB3aGlsZSBzZXA6CiAgICAgICAgIyBGaW5kIHRoZSBwb3RlbnRpYWwgZW5kIG9mIGEgcGFzc3dkCiAgICAgICAgdHJ5OgogICAgICAgICAgICBlbmQgPSBkYXRhLnJpbmRleCgnQCcsIDAsIGJlZ2luKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAjIE5vIHBhc3N3ZCBpbiB0aGUgcmVzdCBvZiB0aGUgZGF0YQogICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsIGRhdGFbMDpiZWdpbl0pCiAgICAgICAgICAgIGJyZWFrCgogICAgICAgICMgU2VhcmNoIGZvciB0aGUgYmVnaW5uaW5nIG9mIGEgcGFzc3dkCiAgICAgICAgc2VwID0gTm9uZQogICAgICAgIHNlcF9zZWFyY2hfZW5kID0gZW5kCiAgICAgICAgd2hpbGUgbm90IHNlcDoKICAgICAgICAgICAgIyBVUkwtc3R5bGUgdXNlcm5hbWUrcGFzc3dvcmQKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYmVnaW4gPSBkYXRhLnJpbmRleCgnOi8vJywgMCwgc2VwX3NlYXJjaF9lbmQpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgIyBObyB1cmwgc3R5bGUgaW4gdGhlIGRhdGEsIGNoZWNrIGZvciBzc2ggc3R5bGUgaW4gdGhlCiAgICAgICAgICAgICAgICAjIHJlc3Qgb2YgdGhlIHN0cmluZwogICAgICAgICAgICAgICAgYmVnaW4gPSAwCiAgICAgICAgICAgICMgU2VhcmNoIGZvciBzZXBhcmF0b3IKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VwID0gZGF0YS5pbmRleCgnOicsIGJlZ2luICsgMywgZW5kKQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICMgTm8gc2VwYXJhdG9yOyBjaG9pY2VzOgogICAgICAgICAgICAgICAgaWYgYmVnaW4gPT0gMDoKICAgICAgICAgICAgICAgICAgICAjIFNlYXJjaGVkIHRoZSB3aG9sZSBzdHJpbmcgc28gdGhlcmUncyBubyBwYXNzd29yZAogICAgICAgICAgICAgICAgICAgICMgaGVyZS4gIFJldHVybiB0aGUgcmVtYWluaW5nIGRhdGEKICAgICAgICAgICAgICAgICAgICBvdXRwdXQuaW5zZXJ0KDAsIGRhdGFbMDpiZWdpbl0pCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICMgU2VhcmNoIGZvciBhIGRpZmZlcmVudCBiZWdpbm5pbmcgb2YgdGhlIHBhc3N3b3JkIGZpZWxkLgogICAgICAgICAgICAgICAgc2VwX3NlYXJjaF9lbmQgPSBiZWdpbgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICBpZiBzZXA6CiAgICAgICAgICAgICMgUGFzc3dvcmQgd2FzIGZvdW5kOyByZW1vdmUgaXQuCiAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgZGF0YVtlbmQ6cHJldl9iZWdpbl0pCiAgICAgICAgICAgIG91dHB1dC5pbnNlcnQoMCwgJyoqKioqKioqJykKICAgICAgICAgICAgb3V0cHV0Lmluc2VydCgwLCBkYXRhW2JlZ2luOnNlcCArIDFdKQogICAgICAgICAgICBwcmV2X2JlZ2luID0gYmVnaW4KCiAgICBvdXRwdXQgPSAnJy5qb2luKG91dHB1dCkKICAgIGlmIG5vX2xvZ192YWx1ZXM6CiAgICAgICAgb3V0cHV0ID0gcmVtb3ZlX3ZhbHVlcyhvdXRwdXQsIG5vX2xvZ192YWx1ZXMpCiAgICByZXR1cm4gb3V0cHV0CgpkZWYgYnl0ZXNfdG9faHVtYW4oc2l6ZSwgaXNiaXRzPUZhbHNlLCB1bml0PU5vbmUpOgoKICAgIGJhc2UgPSAnQnl0ZXMnCiAgICBpZiBpc2JpdHM6CiAgICAgICAgYmFzZSA9ICdiaXRzJwogICAgc3VmZml4ID0gJycKCiAgICBmb3Igc3VmZml4LCBsaW1pdCBpbiBzb3J0ZWQoaXRlcml0ZW1zKFNJWkVfUkFOR0VTKSwga2V5PWxhbWJkYSBpdGVtOiAtaXRlbVsxXSk6CiAgICAgICAgaWYgKHVuaXQgaXMgTm9uZSBhbmQgc2l6ZSA+PSBsaW1pdCkgb3IgdW5pdCBpcyBub3QgTm9uZSBhbmQgdW5pdC51cHBlcigpID09IHN1ZmZpeFswXToKICAgICAgICAgICAgYnJlYWsKCiAgICBpZiBsaW1pdCAhPSAxOgogICAgICAgIHN1ZmZpeCArPSBiYXNlWzBdCiAgICBlbHNlOgogICAgICAgIHN1ZmZpeCA9IGJhc2UKCiAgICByZXR1cm4gJyUuMmYgJXMnICUgKGZsb2F0KHNpemUpLyBsaW1pdCwgc3VmZml4KQoKZGVmIGh1bWFuX3RvX2J5dGVzKG51bWJlciwgZGVmYXVsdF91bml0PU5vbmUsIGlzYml0cz1GYWxzZSk6CgogICAgJycnCiAgICBDb252ZXJ0IG51bWJlciBpbiBzdHJpbmcgZm9ybWF0IGludG8gYnl0ZXMgKGV4OiAnMksnID0+IDIwNDgpIG9yIHVzaW5nIHVuaXQgYXJndW1lbnQKICAgIGV4OgogICAgICBodW1hbl90b19ieXRlcygnMTBNJykgPD0+IGh1bWFuX3RvX2J5dGVzKDEwLCAnTScpCiAgICAnJycKICAgIG0gPSByZS5zZWFyY2goJ15ccyooXGQqXC4/XGQqKVxzKihbQS1aYS16XSspPycsIHN0cihudW1iZXIpLCBmbGFncz1yZS5JR05PUkVDQVNFKQogICAgaWYgbSBpcyBOb25lOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgY2FuJ3QgaW50ZXJwcmV0IGZvbGxvd2luZyBzdHJpbmc6ICVzIiAlIHN0cihudW1iZXIpKQogICAgdHJ5OgogICAgICAgIG51bSA9IGZsb2F0KG0uZ3JvdXAoMSkpCiAgICBleGNlcHQ6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaHVtYW5fdG9fYnl0ZXMoKSBjYW4ndCBpbnRlcnByZXQgZm9sbG93aW5nIG51bWJlcjogJXMgKG9yaWdpbmFsIGlucHV0IHN0cmluZzogJXMpIiAlIChtLmdyb3VwKDEpLCBudW1iZXIpKQoKICAgIHVuaXQgPSBtLmdyb3VwKDIpCiAgICBpZiB1bml0IGlzIE5vbmU6CiAgICAgICAgdW5pdCA9IGRlZmF1bHRfdW5pdAoKICAgIGlmIHVuaXQgaXMgTm9uZToKICAgICAgICAnJycgTm8gdW5pdCBnaXZlbiwgcmV0dXJuaW5nIHJhdyBudW1iZXIgJycnCiAgICAgICAgcmV0dXJuIGludChyb3VuZChudW0pKQogICAgcmFuZ2Vfa2V5ID0gdW5pdFswXS51cHBlcigpCiAgICB0cnk6CiAgICAgICAgbGltaXQgPSBTSVpFX1JBTkdFU1tyYW5nZV9rZXldCiAgICBleGNlcHQ6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaHVtYW5fdG9fYnl0ZXMoKSBmYWlsZWQgdG8gY29udmVydCAlcyAodW5pdCA9ICVzKS4gVGhlIHN1ZmZpeCBtdXN0IGJlIG9uZSBvZiAlcyIgJSAobnVtYmVyLCB1bml0LCAiLCAiLmpvaW4oU0laRV9SQU5HRVMua2V5cygpKSkpCgogICAgIyBkZWZhdWx0IHZhbHVlCiAgICB1bml0X2NsYXNzID0gJ0InCiAgICB1bml0X2NsYXNzX25hbWUgPSAnYnl0ZScKICAgICMgaGFuZGxpbmcgYml0cyBjYXNlCiAgICBpZiBpc2JpdHM6CiAgICAgICAgdW5pdF9jbGFzcyA9ICdiJwogICAgICAgIHVuaXRfY2xhc3NfbmFtZSA9ICdiaXQnCiAgICAjIGNoZWNrIHVuaXQgdmFsdWUgaWYgbW9yZSB0aGFuIG9uZSBjaGFyYWN0ZXIgKEtCLCBNQikKICAgIGlmIGxlbih1bml0KSA+IDE6CiAgICAgICAgZXhwZWN0X21lc3NhZ2UgPSAnZXhwZWN0ICVzJXMgb3IgJXMnICUgKHJhbmdlX2tleSwgdW5pdF9jbGFzcywgcmFuZ2Vfa2V5KQogICAgICAgIGlmIHJhbmdlX2tleSA9PSAnQic6CiAgICAgICAgICAgIGV4cGVjdF9tZXNzYWdlID0gJ2V4cGVjdCAlcyBvciAlcycgJSAodW5pdF9jbGFzcywgdW5pdF9jbGFzc19uYW1lKQoKICAgICAgICBpZiB1bml0X2NsYXNzX25hbWUgaW4gdW5pdC5sb3dlcigpOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxpZiB1bml0WzFdICE9IHVuaXRfY2xhc3M6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImh1bWFuX3RvX2J5dGVzKCkgZmFpbGVkIHRvIGNvbnZlcnQgJXMuIFZhbHVlIGlzIG5vdCBhIHZhbGlkIHN0cmluZyAoJXMpIiAlIChudW1iZXIsIGV4cGVjdF9tZXNzYWdlKSkKCiAgICByZXR1cm4gaW50KHJvdW5kKG51bSAqIGxpbWl0KSkKCmRlZiBpc19leGVjdXRhYmxlKHBhdGgpOgogICAgJycnaXMgdGhlIGdpdmVuIHBhdGggZXhlY3V0YWJsZT8KCiAgICBMaW1pdGF0aW9uczoKICAgICogRG9lcyBub3QgYWNjb3VudCBmb3IgRlNBQ0xzLgogICAgKiBNb3N0IHRpbWVzIHdlIHJlYWxseSB3YW50IHRvIGtub3cgIkNhbiB0aGUgY3VycmVudCB1c2VyIGV4ZWN1dGUgdGhpcwogICAgICBmaWxlIiAgVGhpcyBmdW5jdGlvbiBkb2VzIG5vdCB0ZWxsIHVzIHRoYXQsIG9ubHkgaWYgYW4gZXhlY3V0ZSBiaXQgaXMgc2V0LgogICAgJycnCiAgICAjIFRoZXNlIGFyZSBhbGwgYml0ZmllbGRzIHNvIGZpcnN0IGJpdHdpc2Utb3IgYWxsIHRoZSBwZXJtaXNzaW9ucyB3ZSdyZQogICAgIyBsb29raW5nIGZvciwgdGhlbiBiaXR3aXNlLWFuZCB3aXRoIHRoZSBmaWxlJ3MgbW9kZSB0byBkZXRlcm1pbmUgaWYgYW55CiAgICAjIGV4ZWN1dGUgYml0cyBhcmUgc2V0LgogICAgcmV0dXJuICgoc3RhdC5TX0lYVVNSIHwgc3RhdC5TX0lYR1JQIHwgc3RhdC5TX0lYT1RIKSAmIG9zLnN0YXQocGF0aClbc3RhdC5TVF9NT0RFXSkKCmRlZiBfbG9hZF9wYXJhbXMoKToKICAgICcnJyByZWFkIHRoZSBtb2R1bGVzIHBhcmFtZXRlcnMgYW5kIHN0b3JlIHRoZW0gZ2xvYmFsbHkuCgogICAgVGhpcyBmdW5jdGlvbiBtYXkgYmUgbmVlZGVkIGZvciBjZXJ0YWluIHZlcnkgZHluYW1pYyBjdXN0b20gbW9kdWxlcyB3aGljaAogICAgd2FudCB0byBwcm9jZXNzIHRoZSBwYXJhbWV0ZXJzIHRoYXQgYXJlIGJlaW5nIGhhbmRlZCB0aGUgbW9kdWxlLiAgU2luY2UKICAgIHRoaXMgaXMgc28gY2xvc2VseSB0aWVkIHRvIHRoZSBpbXBsZW1lbnRhdGlvbiBvZiBtb2R1bGVzIHdlIGNhbm5vdAogICAgZ3VhcmFudGVlIEFQSSBzdGFiaWxpdHkgZm9yIGl0IChpdCBtYXkgY2hhbmdlIGJldHdlZW4gdmVyc2lvbnMpIGhvd2V2ZXIgd2UKICAgIHdpbGwgdHJ5IG5vdCB0byBicmVhayBpdCBncmF0dWl0b3VzbHkuICBJdCBpcyBjZXJ0YWlubHkgbW9yZSBmdXR1cmUtcHJvb2YKICAgIHRvIGNhbGwgdGhpcyBmdW5jdGlvbiBhbmQgY29uc3VtZSBpdHMgb3V0cHV0cyB0aGFuIHRvIGltcGxlbWVudCB0aGUgbG9naWMKICAgIGluc2lkZSBpdCBhcyBhIGNvcHkgaW4geW91ciBvd24gY29kZS4KICAgICcnJwogICAgZ2xvYmFsIF9BTlNJQkxFX0FSR1MKICAgIGlmIF9BTlNJQkxFX0FSR1MgaXMgbm90IE5vbmU6CiAgICAgICAgYnVmZmVyID0gX0FOU0lCTEVfQVJHUwogICAgZWxzZToKICAgICAgICAjIGRlYnVnIG92ZXJyaWRlcyB0byByZWFkIGFyZ3MgZnJvbSBmaWxlIG9yIGNtZGxpbmUKCiAgICAgICAgIyBBdm9pZCB0cmFjZWJhY2tzIHdoZW4gbG9jYWxlIGlzIG5vbi11dGY4CiAgICAgICAgIyBXZSBjb250cm9sIHRoZSBhcmdzIGFuZCB3ZSBwYXNzIHRoZW0gYXMgdXRmOAogICAgICAgIGlmIGxlbihzeXMuYXJndikgPiAxOgogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShzeXMuYXJndlsxXSk6CiAgICAgICAgICAgICAgICBmZCA9IG9wZW4oc3lzLmFyZ3ZbMV0sICdyYicpCiAgICAgICAgICAgICAgICBidWZmZXIgPSBmZC5yZWFkKCkKICAgICAgICAgICAgICAgIGZkLmNsb3NlKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHN5cy5hcmd2WzFdCiAgICAgICAgICAgICAgICBpZiBQWTM6CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gYnVmZmVyLmVuY29kZSgndXRmLTgnLCBlcnJvcnM9J3N1cnJvZ2F0ZWVzY2FwZScpCiAgICAgICAgIyBkZWZhdWx0IGNhc2UsIHJlYWQgZnJvbSBzdGRpbgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHN5cy5zdGRpbi5yZWFkKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHN5cy5zdGRpbi5idWZmZXIucmVhZCgpCiAgICAgICAgX0FOU0lCTEVfQVJHUyA9IGJ1ZmZlcgoKICAgIHRyeToKICAgICAgICBwYXJhbXMgPSBqc29uLmxvYWRzKGJ1ZmZlci5kZWNvZGUoJ3V0Zi04JykpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAjIFRoaXMgaGVscGVyIHVzZWQgdG9vIGVhcmx5IGZvciBmYWlsX2pzb24gdG8gd29yay4KICAgICAgICBwcmludCgnXG57Im1zZyI6ICJFcnJvcjogTW9kdWxlIHVuYWJsZSB0byBkZWNvZGUgdmFsaWQgSlNPTiBvbiBzdGRpbi4gIFVuYWJsZSB0byBmaWd1cmUgb3V0IHdoYXQgcGFyYW1ldGVycyB3ZXJlIHBhc3NlZCIsICJmYWlsZWQiOiB0cnVlfScpCiAgICAgICAgc3lzLmV4aXQoMSkKCiAgICBpZiBQWTI6CiAgICAgICAgcGFyYW1zID0ganNvbl9kaWN0X3VuaWNvZGVfdG9fYnl0ZXMocGFyYW1zKQoKICAgIHRyeToKICAgICAgICByZXR1cm4gcGFyYW1zWydBTlNJQkxFX01PRFVMRV9BUkdTJ10KICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAjIFRoaXMgaGVscGVyIGRvZXMgbm90IGhhdmUgYWNjZXNzIHRvIGZhaWxfanNvbiBzbyB3ZSBoYXZlIHRvIHByaW50CiAgICAgICAgIyBqc29uIG91dHB1dCBvbiBvdXIgb3duLgogICAgICAgIHByaW50KCdcbnsibXNnIjogIkVycm9yOiBNb2R1bGUgdW5hYmxlIHRvIGxvY2F0ZSBBTlNJQkxFX01PRFVMRV9BUkdTIGluIGpzb24gZGF0YSBmcm9tIHN0ZGluLiAgVW5hYmxlIHRvIGZpZ3VyZSBvdXQgd2hhdCBwYXJhbWV0ZXJzIHdlcmUgcGFzc2VkIiwgJwogICAgICAgICAgICAgICciZmFpbGVkIjogdHJ1ZX0nKQogICAgICAgIHN5cy5leGl0KDEpCgpkZWYgZW52X2ZhbGxiYWNrKCphcmdzLCAqKmt3YXJncyk6CiAgICAnJycgTG9hZCB2YWx1ZSBmcm9tIGVudmlyb25tZW50ICcnJwogICAgZm9yIGFyZyBpbiBhcmdzOgogICAgICAgIGlmIGFyZyBpbiBvcy5lbnZpcm9uOgogICAgICAgICAgICByZXR1cm4gb3MuZW52aXJvblthcmddCiAgICBlbHNlOgogICAgICAgIHJhaXNlIEFuc2libGVGYWxsYmFja05vdEZvdW5kCgpkZWYgX2xlbmllbnRfbG93ZXJjYXNlKGxzdCk6CiAgICAiIiJMb3dlcmNhc2UgZWxlbWVudHMgb2YgYSBsaXN0LgoKICAgIElmIGFuIGVsZW1lbnQgaXMgbm90IGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggdW50b3VjaGVkLgogICAgIiIiCiAgICBsb3dlcmVkID0gW10KICAgIGZvciB2YWx1ZSBpbiBsc3Q6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb3dlcmVkLmFwcGVuZCh2YWx1ZS5sb3dlcigpKQogICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgbG93ZXJlZC5hcHBlbmQodmFsdWUpCiAgICByZXR1cm4gbG93ZXJlZAoKZGVmIGZvcm1hdF9hdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpOgogICAgYXR0cmlidXRlX2xpc3QgPSBbXQogICAgZm9yIGF0dHIgaW4gYXR0cmlidXRlczoKICAgICAgICBpZiBhdHRyIGluIEZJTEVfQVRUUklCVVRFUzoKICAgICAgICAgICAgYXR0cmlidXRlX2xpc3QuYXBwZW5kKEZJTEVfQVRUUklCVVRFU1thdHRyXSkKICAgIHJldHVybiBhdHRyaWJ1dGVfbGlzdAoKZGVmIGdldF9mbGFnc19mcm9tX2F0dHJpYnV0ZXMoYXR0cmlidXRlcyk6CiAgICBmbGFncyA9IFtdCiAgICBmb3Iga2V5LGF0dHIgaW4gRklMRV9BVFRSSUJVVEVTLml0ZW1zKCk6CiAgICAgICAgaWYgYXR0ciBpbiBhdHRyaWJ1dGVzOgogICAgICAgICAgICBmbGFncy5hcHBlbmQoa2V5KQogICAgcmV0dXJuICcnLmpvaW4oZmxhZ3MpCgpjbGFzcyBBbnNpYmxlRmFsbGJhY2tOb3RGb3VuZChFeGNlcHRpb24pOgogICAgcGFzcwoKCmNsYXNzIEFuc2libGVNb2R1bGUob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhcmd1bWVudF9zcGVjLCBieXBhc3NfY2hlY2tzPUZhbHNlLCBub19sb2c9RmFsc2UsCiAgICAgICAgICAgICAgICAgY2hlY2tfaW52YWxpZF9hcmd1bWVudHM9VHJ1ZSwgbXV0dWFsbHlfZXhjbHVzaXZlPU5vbmUsIHJlcXVpcmVkX3RvZ2V0aGVyPU5vbmUsCiAgICAgICAgICAgICAgICAgcmVxdWlyZWRfb25lX29mPU5vbmUsIGFkZF9maWxlX2NvbW1vbl9hcmdzPUZhbHNlLCBzdXBwb3J0c19jaGVja19tb2RlPUZhbHNlLAogICAgICAgICAgICAgICAgIHJlcXVpcmVkX2lmPU5vbmUpOgoKICAgICAgICAnJycKICAgICAgICBjb21tb24gY29kZSBmb3IgcXVpY2tseSBidWlsZGluZyBhbiBhbnNpYmxlIG1vZHVsZSBpbiBQeXRob24KICAgICAgICAoYWx0aG91Z2ggeW91IGNhbiB3cml0ZSBtb2R1bGVzIGluIGFueXRoaW5nIHRoYXQgY2FuIHJldHVybiBKU09OKQogICAgICAgIHNlZSBsaWJyYXJ5LyogZm9yIGV4YW1wbGVzCiAgICAgICAgJycnCgogICAgICAgIHNlbGYuX25hbWUgPSBvcy5wYXRoLmJhc2VuYW1lKF9fZmlsZV9fKSAjaW5pdGlhbGl6ZSBuYW1lIHVudGlsIHdlIGNhbiBwYXJzZSBmcm9tIG9wdGlvbnMKICAgICAgICBzZWxmLmFyZ3VtZW50X3NwZWMgPSBhcmd1bWVudF9zcGVjCiAgICAgICAgc2VsZi5zdXBwb3J0c19jaGVja19tb2RlID0gc3VwcG9ydHNfY2hlY2tfbW9kZQogICAgICAgIHNlbGYuY2hlY2tfbW9kZSA9IEZhbHNlCiAgICAgICAgc2VsZi5ub19sb2cgPSBub19sb2cKICAgICAgICBzZWxmLmNsZWFudXBfZmlsZXMgPSBbXQogICAgICAgIHNlbGYuX2RlYnVnID0gRmFsc2UKICAgICAgICBzZWxmLl9kaWZmID0gRmFsc2UKICAgICAgICBzZWxmLl9zb2NrZXRfcGF0aCA9IE5vbmUKICAgICAgICBzZWxmLl92ZXJib3NpdHkgPSAwCiAgICAgICAgIyBNYXkgYmUgdXNlZCB0byBzZXQgbW9kaWZpY2F0aW9ucyB0byB0aGUgZW52aXJvbm1lbnQgZm9yIGFueQogICAgICAgICMgcnVuX2NvbW1hbmQgaW52b2NhdGlvbgogICAgICAgIHNlbGYucnVuX2NvbW1hbmRfZW52aXJvbl91cGRhdGUgPSB7fQogICAgICAgIHNlbGYuX3dhcm5pbmdzID0gW10KICAgICAgICBzZWxmLl9kZXByZWNhdGlvbnMgPSBbXQoKICAgICAgICBzZWxmLmFsaWFzZXMgPSB7fQogICAgICAgIHNlbGYuX2xlZ2FsX2lucHV0cyA9IFsnX2Fuc2libGVfY2hlY2tfbW9kZScsICdfYW5zaWJsZV9ub19sb2cnLCAnX2Fuc2libGVfZGVidWcnLCAnX2Fuc2libGVfZGlmZicsICdfYW5zaWJsZV92ZXJib3NpdHknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnX2Fuc2libGVfc2VsaW51eF9zcGVjaWFsX2ZzJywgJ19hbnNpYmxlX21vZHVsZV9uYW1lJywgJ19hbnNpYmxlX3ZlcnNpb24nLCAnX2Fuc2libGVfc3lzbG9nX2ZhY2lsaXR5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ19hbnNpYmxlX3NvY2tldCddCgogICAgICAgIGlmIGFkZF9maWxlX2NvbW1vbl9hcmdzOgogICAgICAgICAgICBmb3IgaywgdiBpbiBGSUxFX0NPTU1PTl9BUkdVTUVOVFMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGsgbm90IGluIHNlbGYuYXJndW1lbnRfc3BlYzoKICAgICAgICAgICAgICAgICAgICBzZWxmLmFyZ3VtZW50X3NwZWNba10gPSB2CgogICAgICAgIHNlbGYuX2xvYWRfcGFyYW1zKCkKICAgICAgICBzZWxmLl9zZXRfZmFsbGJhY2tzKCkKCiAgICAgICAgIyBhcHBlbmQgdG8gbGVnYWxfaW5wdXRzIGFuZCB0aGVuIHBvc3NpYmx5IGNoZWNrIGFnYWluc3QgdGhlbQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5hbGlhc2VzID0gc2VsZi5faGFuZGxlX2FsaWFzZXMoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgIyBVc2UgZXhjZXB0aW9ucyBoZXJlIGJlY2F1c2UgaXQgaXNuJ3Qgc2FmZSB0byBjYWxsIGZhaWxfanNvbiB1bnRpbCBub19sb2cgaXMgcHJvY2Vzc2VkCiAgICAgICAgICAgIHByaW50KCdcbnsiZmFpbGVkIjogdHJ1ZSwgIm1zZyI6ICJNb2R1bGUgYWxpYXMgZXJyb3I6ICVzIn0nICUgc3RyKGUpKQogICAgICAgICAgICBzeXMuZXhpdCgxKQoKICAgICAgICAjIFNhdmUgcGFyYW1ldGVyIHZhbHVlcyB0aGF0IHNob3VsZCBuZXZlciBiZSBsb2dnZWQKICAgICAgICBzZWxmLm5vX2xvZ192YWx1ZXMgPSBzZXQoKQogICAgICAgICMgVXNlIHRoZSBhcmdzcGVjIHRvIGRldGVybWluZSB3aGljaCBhcmdzIGFyZSBub19sb2cKICAgICAgICBmb3IgYXJnX25hbWUsIGFyZ19vcHRzIGluIHNlbGYuYXJndW1lbnRfc3BlYy5pdGVtcygpOgogICAgICAgICAgICBpZiBhcmdfb3B0cy5nZXQoJ25vX2xvZycsIEZhbHNlKToKICAgICAgICAgICAgICAgICMgRmluZCB0aGUgdmFsdWUgZm9yIHRoZSBub19sb2cnZCBwYXJhbQogICAgICAgICAgICAgICAgbm9fbG9nX29iamVjdCA9IHNlbGYucGFyYW1zLmdldChhcmdfbmFtZSwgTm9uZSkKICAgICAgICAgICAgICAgIGlmIG5vX2xvZ19vYmplY3Q6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5ub19sb2dfdmFsdWVzLnVwZGF0ZShyZXR1cm5fdmFsdWVzKG5vX2xvZ19vYmplY3QpKQoKICAgICAgICAgICAgaWYgYXJnX29wdHMuZ2V0KCdyZW1vdmVkX2luX3ZlcnNpb24nKSBpcyBub3QgTm9uZSBhbmQgYXJnX25hbWUgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICBzZWxmLl9kZXByZWNhdGlvbnMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAnbXNnJzogIlBhcmFtICclcycgaXMgZGVwcmVjYXRlZC4gU2VlIHRoZSBtb2R1bGUgZG9jcyBmb3IgbW9yZSBpbmZvcm1hdGlvbiIgJSBhcmdfbmFtZSwKICAgICAgICAgICAgICAgICAgICAndmVyc2lvbic6IGFyZ19vcHRzLmdldCgncmVtb3ZlZF9pbl92ZXJzaW9uJykKICAgICAgICAgICAgICAgIH0pCgogICAgICAgICMgY2hlY2sgdGhlIGxvY2FsZSBhcyBzZXQgYnkgdGhlIGN1cnJlbnQgZW52aXJvbm1lbnQsIGFuZCByZXNldCB0bwogICAgICAgICMgYSBrbm93biB2YWxpZCAoTEFORz1DKSBpZiBpdCdzIGFuIGludmFsaWQvdW5hdmFpbGFibGUgbG9jYWxlCiAgICAgICAgc2VsZi5fY2hlY2tfbG9jYWxlKCkKCiAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRzKGNoZWNrX2ludmFsaWRfYXJndW1lbnRzKQoKICAgICAgICAjIGNoZWNrIGV4Y2x1c2l2ZSBlYXJseQogICAgICAgIGlmIG5vdCBieXBhc3NfY2hlY2tzOgogICAgICAgICAgICBzZWxmLl9jaGVja19tdXR1YWxseV9leGNsdXNpdmUobXV0dWFsbHlfZXhjbHVzaXZlKQoKICAgICAgICBzZWxmLl9zZXRfZGVmYXVsdHMocHJlPVRydWUpCgogICAgICAgIHNlbGYuX0NIRUNLX0FSR1VNRU5UX1RZUEVTX0RJU1BBVENIRVIgPSB7CiAgICAgICAgICAgICdzdHInOiBzZWxmLl9jaGVja190eXBlX3N0ciwKICAgICAgICAgICAgJ2xpc3QnOiBzZWxmLl9jaGVja190eXBlX2xpc3QsCiAgICAgICAgICAgICdkaWN0Jzogc2VsZi5fY2hlY2tfdHlwZV9kaWN0LAogICAgICAgICAgICAnYm9vbCc6IHNlbGYuX2NoZWNrX3R5cGVfYm9vbCwKICAgICAgICAgICAgJ2ludCc6IHNlbGYuX2NoZWNrX3R5cGVfaW50LAogICAgICAgICAgICAnZmxvYXQnOiBzZWxmLl9jaGVja190eXBlX2Zsb2F0LAogICAgICAgICAgICAncGF0aCc6IHNlbGYuX2NoZWNrX3R5cGVfcGF0aCwKICAgICAgICAgICAgJ3Jhdyc6IHNlbGYuX2NoZWNrX3R5cGVfcmF3LAogICAgICAgICAgICAnanNvbmFyZyc6IHNlbGYuX2NoZWNrX3R5cGVfanNvbmFyZywKICAgICAgICAgICAgJ2pzb24nOiBzZWxmLl9jaGVja190eXBlX2pzb25hcmcsCiAgICAgICAgICAgICdieXRlcyc6IHNlbGYuX2NoZWNrX3R5cGVfYnl0ZXMsCiAgICAgICAgICAgICdiaXRzJzogc2VsZi5fY2hlY2tfdHlwZV9iaXRzLAogICAgICAgIH0KICAgICAgICBpZiBub3QgYnlwYXNzX2NoZWNrczoKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfYXJndW1lbnRzKCkKICAgICAgICAgICAgc2VsZi5fY2hlY2tfYXJndW1lbnRfdHlwZXMoKQogICAgICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudF92YWx1ZXMoKQogICAgICAgICAgICBzZWxmLl9jaGVja19yZXF1aXJlZF90b2dldGhlcihyZXF1aXJlZF90b2dldGhlcikKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfb25lX29mKHJlcXVpcmVkX29uZV9vZikKICAgICAgICAgICAgc2VsZi5fY2hlY2tfcmVxdWlyZWRfaWYocmVxdWlyZWRfaWYpCgogICAgICAgIHNlbGYuX3NldF9kZWZhdWx0cyhwcmU9RmFsc2UpCgogICAgICAgIGlmIG5vdCBzZWxmLm5vX2xvZzoKICAgICAgICAgICAgc2VsZi5fbG9nX2ludm9jYXRpb24oKQoKICAgICAgICAjIGZpbmFsbHksIG1ha2Ugc3VyZSB3ZSdyZSBpbiBhIHNhbmUgd29ya2luZyBkaXIKICAgICAgICBzZWxmLl9zZXRfY3dkKCkKCiAgICBkZWYgd2FybihzZWxmLCB3YXJuaW5nKToKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh3YXJuaW5nLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBzZWxmLl93YXJuaW5ncy5hcHBlbmQod2FybmluZykKICAgICAgICAgICAgc2VsZi5sb2coJ1tXQVJOSU5HXSAlcycgJSB3YXJuaW5nKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigid2FybiByZXF1aXJlcyBhIHN0cmluZyBub3QgYSAlcyIgJSB0eXBlKHdhcm5pbmcpKQoKICAgIGRlZiBkZXByZWNhdGUoc2VsZiwgbXNnLCB2ZXJzaW9uPU5vbmUpOgogICAgICAgIGlmIGlzaW5zdGFuY2UobXNnLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBzZWxmLl9kZXByZWNhdGlvbnMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICdtc2cnOiBtc2csCiAgICAgICAgICAgICAgICAndmVyc2lvbic6IHZlcnNpb24KICAgICAgICAgICAgfSkKICAgICAgICAgICAgc2VsZi5sb2coJ1tERVBSRUNBVElPTiBXQVJOSU5HXSAlcyAlcycgJSAobXNnLCB2ZXJzaW9uKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoImRlcHJlY2F0ZSByZXF1aXJlcyBhIHN0cmluZyBub3QgYSAlcyIgJSB0eXBlKG1zZykpCgogICAgZGVmIGxvYWRfZmlsZV9jb21tb25fYXJndW1lbnRzKHNlbGYsIHBhcmFtcyk6CiAgICAgICAgJycnCiAgICAgICAgbWFueSBtb2R1bGVzIGRlYWwgd2l0aCBmaWxlcywgdGhpcyBlbmNhcHN1bGF0ZXMgY29tbW9uCiAgICAgICAgb3B0aW9ucyB0aGF0IHRoZSBmaWxlIG1vZHVsZSBhY2NlcHRzIHN1Y2ggdGhhdCBpdCBpcyBkaXJlY3RseQogICAgICAgIGF2YWlsYWJsZSB0byBhbGwgbW9kdWxlcyBhbmQgdGhleSBjYW4gc2hhcmUgY29kZS4KICAgICAgICAnJycKCiAgICAgICAgcGF0aCA9IHBhcmFtcy5nZXQoJ3BhdGgnLCBwYXJhbXMuZ2V0KCdkZXN0JywgTm9uZSkpCiAgICAgICAgaWYgcGF0aCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4ge30KICAgICAgICBlbHNlOgogICAgICAgICAgICBwYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhwYXRoKSkKCiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICAjIGlmIHRoZSBwYXRoIGlzIGEgc3ltbGluaywgYW5kIHdlJ3JlIGZvbGxvd2luZyBsaW5rcywgZ2V0CiAgICAgICAgIyB0aGUgdGFyZ2V0IG9mIHRoZSBsaW5rIGluc3RlYWQgZm9yIHRlc3RpbmcKICAgICAgICBpZiBwYXJhbXMuZ2V0KCdmb2xsb3cnLCBGYWxzZSkgYW5kIG9zLnBhdGguaXNsaW5rKGJfcGF0aCk6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGgucmVhbHBhdGgoYl9wYXRoKQogICAgICAgICAgICBwYXRoID0gdG9fbmF0aXZlKGJfcGF0aCkKCiAgICAgICAgbW9kZSAgID0gcGFyYW1zLmdldCgnbW9kZScsIE5vbmUpCiAgICAgICAgb3duZXIgID0gcGFyYW1zLmdldCgnb3duZXInLCBOb25lKQogICAgICAgIGdyb3VwICA9IHBhcmFtcy5nZXQoJ2dyb3VwJywgTm9uZSkKCiAgICAgICAgIyBzZWxpbnV4IHJlbGF0ZWQgb3B0aW9ucwogICAgICAgIHNldXNlciAgICA9IHBhcmFtcy5nZXQoJ3NldXNlcicsIE5vbmUpCiAgICAgICAgc2Vyb2xlICAgID0gcGFyYW1zLmdldCgnc2Vyb2xlJywgTm9uZSkKICAgICAgICBzZXR5cGUgICAgPSBwYXJhbXMuZ2V0KCdzZXR5cGUnLCBOb25lKQogICAgICAgIHNlbGV2ZWwgICA9IHBhcmFtcy5nZXQoJ3NlbGV2ZWwnLCBOb25lKQogICAgICAgIHNlY29udGV4dCA9IFtzZXVzZXIsIHNlcm9sZSwgc2V0eXBlXQoKICAgICAgICBpZiBzZWxmLnNlbGludXhfbWxzX2VuYWJsZWQoKToKICAgICAgICAgICAgc2Vjb250ZXh0LmFwcGVuZChzZWxldmVsKQoKICAgICAgICBkZWZhdWx0X3NlY29udGV4dCA9IHNlbGYuc2VsaW51eF9kZWZhdWx0X2NvbnRleHQocGF0aCkKICAgICAgICBmb3IgaSBpbiByYW5nZShsZW4oZGVmYXVsdF9zZWNvbnRleHQpKToKICAgICAgICAgICAgaWYgaSBpcyBub3QgTm9uZSBhbmQgc2Vjb250ZXh0W2ldID09ICdfZGVmYXVsdCc6CiAgICAgICAgICAgICAgICBzZWNvbnRleHRbaV0gPSBkZWZhdWx0X3NlY29udGV4dFtpXQoKICAgICAgICBhdHRyaWJ1dGVzID0gcGFyYW1zLmdldCgnYXR0cmlidXRlcycsIE5vbmUpCiAgICAgICAgcmV0dXJuIGRpY3QoCiAgICAgICAgICAgIHBhdGg9cGF0aCwgbW9kZT1tb2RlLCBvd25lcj1vd25lciwgZ3JvdXA9Z3JvdXAsCiAgICAgICAgICAgIHNldXNlcj1zZXVzZXIsIHNlcm9sZT1zZXJvbGUsIHNldHlwZT1zZXR5cGUsCiAgICAgICAgICAgIHNlbGV2ZWw9c2VsZXZlbCwgc2Vjb250ZXh0PXNlY29udGV4dCwgYXR0cmlidXRlcz1hdHRyaWJ1dGVzLAogICAgICAgICkKCgogICAgIyBEZXRlY3Qgd2hldGhlciB1c2luZyBzZWxpbnV4IHRoYXQgaXMgTUxTLWF3YXJlLgogICAgIyBXaGlsZSB0aGlzIG1lYW5zIHlvdSBjYW4gc2V0IHRoZSBsZXZlbC9yYW5nZSB3aXRoCiAgICAjIHNlbGludXgubHNldGZpbGVjb24oKSwgaXQgbWF5IG9yIG1heSBub3QgbWVhbiB0aGF0IHlvdQogICAgIyB3aWxsIGdldCB0aGUgc2VsZXZlbCBhcyBwYXJ0IG9mIHRoZSBjb250ZXh0IHJldHVybmVkCiAgICAjIGJ5IHNlbGludXgubGdldGZpbGVjb24oKS4KCiAgICBkZWYgc2VsaW51eF9tbHNfZW5hYmxlZChzZWxmKToKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBpZiBzZWxpbnV4LmlzX3NlbGludXhfbWxzX2VuYWJsZWQoKSA9PSAxOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBzZWxpbnV4X2VuYWJsZWQoc2VsZik6CiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWDoKICAgICAgICAgICAgc2VlbmFibGVkID0gc2VsZi5nZXRfYmluX3BhdGgoJ3NlbGludXhlbmFibGVkJykKICAgICAgICAgICAgaWYgc2VlbmFibGVkIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgKHJjLG91dCxlcnIpID0gc2VsZi5ydW5fY29tbWFuZChzZWVuYWJsZWQpCiAgICAgICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iQWJvcnRpbmcsIHRhcmdldCB1c2VzIHNlbGludXggYnV0IHB5dGhvbiBiaW5kaW5ncyAobGlic2VsaW51eC1weXRob24pIGFyZW4ndCBpbnN0YWxsZWQhIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgaWYgc2VsaW51eC5pc19zZWxpbnV4X2VuYWJsZWQoKSA9PSAxOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICMgRGV0ZXJtaW5lIHdoZXRoZXIgd2UgbmVlZCBhIHBsYWNlaG9sZGVyIGZvciBzZWxldmVsL21scwogICAgZGVmIHNlbGludXhfaW5pdGlhbF9jb250ZXh0KHNlbGYpOgogICAgICAgIGNvbnRleHQgPSBbTm9uZSwgTm9uZSwgTm9uZV0KICAgICAgICBpZiBzZWxmLnNlbGludXhfbWxzX2VuYWJsZWQoKToKICAgICAgICAgICAgY29udGV4dC5hcHBlbmQoTm9uZSkKICAgICAgICByZXR1cm4gY29udGV4dAoKICAgICMgSWYgc2VsaW51eCBmYWlscyB0byBmaW5kIGEgZGVmYXVsdCwgcmV0dXJuIGFuIGFycmF5IG9mIE5vbmUKICAgIGRlZiBzZWxpbnV4X2RlZmF1bHRfY29udGV4dChzZWxmLCBwYXRoLCBtb2RlPTApOgogICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfaW5pdGlhbF9jb250ZXh0KCkKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYIG9yIG5vdCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0ID0gc2VsaW51eC5tYXRjaHBhdGhjb24odG9fbmF0aXZlKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpLCBtb2RlKQogICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgIGlmIHJldFswXSA9PSAtMToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICAjIExpbWl0IHNwbGl0IHRvIDQgYmVjYXVzZSB0aGUgc2VsZXZlbCwgdGhlIGxhc3QgaW4gdGhlIGxpc3QsCiAgICAgICAgIyBtYXkgY29udGFpbiAnOicgY2hhcmFjdGVycwogICAgICAgIGNvbnRleHQgPSByZXRbMV0uc3BsaXQoJzonLCAzKQogICAgICAgIHJldHVybiBjb250ZXh0CgogICAgZGVmIHNlbGludXhfY29udGV4dChzZWxmLCBwYXRoKToKICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2luaXRpYWxfY29udGV4dCgpCiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldCA9IHNlbGludXgubGdldGZpbGVjb25fcmF3KHRvX25hdGl2ZShwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKSkKICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBpZiBlLmVycm5vID09IGVycm5vLkVOT0VOVDoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdwYXRoICVzIGRvZXMgbm90IGV4aXN0JyAlIHBhdGgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nZmFpbGVkIHRvIHJldHJpZXZlIHNlbGludXggY29udGV4dCcpCiAgICAgICAgaWYgcmV0WzBdID09IC0xOgogICAgICAgICAgICByZXR1cm4gY29udGV4dAogICAgICAgICMgTGltaXQgc3BsaXQgdG8gNCBiZWNhdXNlIHRoZSBzZWxldmVsLCB0aGUgbGFzdCBpbiB0aGUgbGlzdCwKICAgICAgICAjIG1heSBjb250YWluICc6JyBjaGFyYWN0ZXJzCiAgICAgICAgY29udGV4dCA9IHJldFsxXS5zcGxpdCgnOicsIDMpCiAgICAgICAgcmV0dXJuIGNvbnRleHQKCiAgICBkZWYgdXNlcl9hbmRfZ3JvdXAoc2VsZiwgcGF0aCwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBzdCA9IG9zLmxzdGF0KGJfcGF0aCkKICAgICAgICB1aWQgPSBzdC5zdF91aWQKICAgICAgICBnaWQgPSBzdC5zdF9naWQKICAgICAgICByZXR1cm4gKHVpZCwgZ2lkKQoKICAgIGRlZiBmaW5kX21vdW50X3BvaW50KHNlbGYsIHBhdGgpOgogICAgICAgIHBhdGhfaXNfYnl0ZXMgPSBGYWxzZQogICAgICAgIGlmIGlzaW5zdGFuY2UocGF0aCwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICBwYXRoX2lzX2J5dGVzID0gVHJ1ZQoKICAgICAgICBiX3BhdGggPSBvcy5wYXRoLnJlYWxwYXRoKHRvX2J5dGVzKG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMocGF0aCkpLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKSkKICAgICAgICB3aGlsZSBub3Qgb3MucGF0aC5pc21vdW50KGJfcGF0aCk6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZGlybmFtZShiX3BhdGgpCgogICAgICAgIGlmIHBhdGhfaXNfYnl0ZXM6CiAgICAgICAgICAgIHJldHVybiBiX3BhdGgKCiAgICAgICAgcmV0dXJuIHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQoKICAgIGRlZiBpc19zcGVjaWFsX3NlbGludXhfcGF0aChzZWxmLCBwYXRoKToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm5zIGEgdHVwbGUgY29udGFpbmluZyAoVHJ1ZSwgc2VsaW51eF9jb250ZXh0KSBpZiB0aGUgZ2l2ZW4gcGF0aCBpcyBvbiBhCiAgICAgICAgTkZTIG9yIG90aGVyICdzcGVjaWFsJyBmcyAgbW91bnQgcG9pbnQsIG90aGVyd2lzZSB0aGUgcmV0dXJuIHdpbGwgYmUgKEZhbHNlLCBOb25lKS4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGYgPSBvcGVuKCcvcHJvYy9tb3VudHMnLCAncicpCiAgICAgICAgICAgIG1vdW50X2RhdGEgPSBmLnJlYWRsaW5lcygpCiAgICAgICAgICAgIGYuY2xvc2UoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcmV0dXJuIChGYWxzZSwgTm9uZSkKICAgICAgICBwYXRoX21vdW50X3BvaW50ID0gc2VsZi5maW5kX21vdW50X3BvaW50KHBhdGgpCiAgICAgICAgZm9yIGxpbmUgaW4gbW91bnRfZGF0YToKICAgICAgICAgICAgKGRldmljZSwgbW91bnRfcG9pbnQsIGZzdHlwZSwgb3B0aW9ucywgcmVzdCkgPSBsaW5lLnNwbGl0KCcgJywgNCkKCiAgICAgICAgICAgIGlmIHBhdGhfbW91bnRfcG9pbnQgPT0gbW91bnRfcG9pbnQ6CiAgICAgICAgICAgICAgICBmb3IgZnMgaW4gc2VsZi5fc2VsaW51eF9zcGVjaWFsX2ZzOgogICAgICAgICAgICAgICAgICAgIGlmIGZzIGluIGZzdHlwZToKICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lhbF9jb250ZXh0ID0gc2VsZi5zZWxpbnV4X2NvbnRleHQocGF0aF9tb3VudF9wb2ludCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChUcnVlLCBzcGVjaWFsX2NvbnRleHQpCgogICAgICAgIHJldHVybiAoRmFsc2UsIE5vbmUpCgogICAgZGVmIHNldF9kZWZhdWx0X3NlbGludXhfY29udGV4dChzZWxmLCBwYXRoLCBjaGFuZ2VkKToKICAgICAgICBpZiBub3QgSEFWRV9TRUxJTlVYIG9yIG5vdCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAogICAgICAgIGNvbnRleHQgPSBzZWxmLnNlbGludXhfZGVmYXVsdF9jb250ZXh0KHBhdGgpCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0X2NvbnRleHRfaWZfZGlmZmVyZW50KHBhdGgsIGNvbnRleHQsIEZhbHNlKQoKICAgIGRlZiBzZXRfY29udGV4dF9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgY29udGV4dCwgY2hhbmdlZCwgZGlmZj1Ob25lKToKCiAgICAgICAgaWYgbm90IEhBVkVfU0VMSU5VWCBvciBub3Qgc2VsZi5zZWxpbnV4X2VuYWJsZWQoKToKICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQKICAgICAgICBjdXJfY29udGV4dCA9IHNlbGYuc2VsaW51eF9jb250ZXh0KHBhdGgpCiAgICAgICAgbmV3X2NvbnRleHQgPSBsaXN0KGN1cl9jb250ZXh0KQogICAgICAgICMgSXRlcmF0ZSBvdmVyIHRoZSBjdXJyZW50IGNvbnRleHQgaW5zdGVhZCBvZiB0aGUKICAgICAgICAjIGFyZ3VtZW50IGNvbnRleHQsIHdoaWNoIG1heSBoYXZlIHNlbGV2ZWwuCgogICAgICAgIChpc19zcGVjaWFsX3NlLCBzcF9jb250ZXh0KSA9IHNlbGYuaXNfc3BlY2lhbF9zZWxpbnV4X3BhdGgocGF0aCkKICAgICAgICBpZiBpc19zcGVjaWFsX3NlOgogICAgICAgICAgICBuZXdfY29udGV4dCA9IHNwX2NvbnRleHQKICAgICAgICBlbHNlOgogICAgICAgICAgICBmb3IgaSBpbiByYW5nZShsZW4oY3VyX2NvbnRleHQpKToKICAgICAgICAgICAgICAgIGlmIGxlbihjb250ZXh0KSA+IGk6CiAgICAgICAgICAgICAgICAgICAgaWYgY29udGV4dFtpXSBpcyBub3QgTm9uZSBhbmQgY29udGV4dFtpXSAhPSBjdXJfY29udGV4dFtpXToKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2NvbnRleHRbaV0gPSBjb250ZXh0W2ldCiAgICAgICAgICAgICAgICAgICAgZWxpZiBjb250ZXh0W2ldIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld19jb250ZXh0W2ldID0gY3VyX2NvbnRleHRbaV0KCiAgICAgICAgaWYgY3VyX2NvbnRleHQgIT0gbmV3X2NvbnRleHQ6CiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnc2Vjb250ZXh0J10gPSBjdXJfY29udGV4dAogICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ3NlY29udGV4dCddID0gbmV3X2NvbnRleHQKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIHNlbGYuY2hlY2tfbW9kZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgcmMgPSBzZWxpbnV4LmxzZXRmaWxlY29uKHRvX25hdGl2ZShwYXRoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHIoJzonLmpvaW4obmV3X2NvbnRleHQpKSkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0naW52YWxpZCBzZWxpbnV4IGNvbnRleHQ6ICVzJyAlIHN0cihlKSwgbmV3X2NvbnRleHQ9bmV3X2NvbnRleHQsIGN1cl9jb250ZXh0PWN1cl9jb250ZXh0LCBpbnB1dF93YXM9Y29udGV4dCkKICAgICAgICAgICAgaWYgcmMgIT0gMDoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdzZXQgc2VsaW51eCBjb250ZXh0IGZhaWxlZCcpCiAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X293bmVyX2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBvd25lciwgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHBhdGggPSB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIG93bmVyIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkCiAgICAgICAgb3JpZ191aWQsIG9yaWdfZ2lkID0gc2VsZi51c2VyX2FuZF9ncm91cChwYXRoLCBleHBhbmQpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB1aWQgPSBpbnQob3duZXIpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHVpZCA9IHB3ZC5nZXRwd25hbShvd25lcikucHdfdWlkCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaG93biBmYWlsZWQ6IGZhaWxlZCB0byBsb29rIHVwIHVzZXIgJXMnICUgb3duZXIpCiAgICAgICAgaWYgb3JpZ191aWQgIT0gdWlkOgoKICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmICdiZWZvcmUnIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydvd25lciddID0gb3JpZ191aWQKICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddWydvd25lciddID0gdWlkCgogICAgICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5sY2hvd24oYl9wYXRoLCB1aWQsIC0xKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaG93biBmYWlsZWQnKQogICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9ncm91cF9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgZ3JvdXAsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBleHBhbmQ6CiAgICAgICAgICAgIGJfcGF0aCA9IG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnMoYl9wYXRoKSkKICAgICAgICBwYXRoID0gdG9fdGV4dChiX3BhdGgsIGVycm9ycz0nc3Vycm9nYXRlX3RoZW5fc3RyaWN0JykKICAgICAgICBpZiBncm91cCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAogICAgICAgIG9yaWdfdWlkLCBvcmlnX2dpZCA9IHNlbGYudXNlcl9hbmRfZ3JvdXAoYl9wYXRoLCBleHBhbmQpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBnaWQgPSBpbnQoZ3JvdXApCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGdpZCA9IGdycC5nZXRncm5hbShncm91cCkuZ3JfZ2lkCiAgICAgICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaGdycCBmYWlsZWQ6IGZhaWxlZCB0byBsb29rIHVwIGdyb3VwICVzJyAlIGdyb3VwKQogICAgICAgIGlmIG9yaWdfZ2lkICE9IGdpZDoKCiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnZ3JvdXAnXSA9IG9yaWdfZ2lkCiAgICAgICAgICAgICAgICBpZiAnYWZ0ZXInIG5vdCBpbiBkaWZmOgogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgZGlmZlsnYWZ0ZXInXVsnZ3JvdXAnXSA9IGdpZAoKICAgICAgICAgICAgaWYgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MubGNob3duKGJfcGF0aCwgLTEsIGdpZCkKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihwYXRoPXBhdGgsIG1zZz0nY2hncnAgZmFpbGVkJykKICAgICAgICAgICAgY2hhbmdlZCA9IFRydWUKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBzZXRfbW9kZV9pZl9kaWZmZXJlbnQoc2VsZiwgcGF0aCwgbW9kZSwgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgYl9wYXRoID0gdG9fYnl0ZXMocGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIGlmIGV4cGFuZDoKICAgICAgICAgICAgYl9wYXRoID0gb3MucGF0aC5leHBhbmR1c2VyKG9zLnBhdGguZXhwYW5kdmFycyhiX3BhdGgpKQogICAgICAgIHBhdGggPSB0b190ZXh0KGJfcGF0aCwgZXJyb3JzPSdzdXJyb2dhdGVfdGhlbl9zdHJpY3QnKQogICAgICAgIHBhdGhfc3RhdCA9IG9zLmxzdGF0KGJfcGF0aCkKCiAgICAgICAgaWYgbW9kZSBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShtb2RlLCBpbnQpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBtb2RlID0gaW50KG1vZGUsIDgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbW9kZSA9IHNlbGYuX3N5bWJvbGljX21vZGVfdG9fb2N0YWwocGF0aF9zdGF0LCBtb2RlKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZz0ibW9kZSBtdXN0IGJlIGluIG9jdGFsIG9yIHN5bWJvbGljIGZvcm0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldGFpbHM9c3RyKGUpKQoKICAgICAgICAgICAgICAgIGlmIG1vZGUgIT0gc3RhdC5TX0lNT0RFKG1vZGUpOgogICAgICAgICAgICAgICAgICAgICMgcHJldmVudCBtb2RlIGZyb20gaGF2aW5nIGV4dHJhIGluZm8gb3JiZWluZyBpbnZhbGlkIGxvbmcgbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9IkludmFsaWQgbW9kZSBzdXBwbGllZCwgb25seSBwZXJtaXNzaW9uIGluZm8gaXMgYWxsb3dlZCIsIGRldGFpbHM9bW9kZSkKCiAgICAgICAgcHJldl9tb2RlID0gc3RhdC5TX0lNT0RFKHBhdGhfc3RhdC5zdF9tb2RlKQoKICAgICAgICBpZiBwcmV2X21vZGUgIT0gbW9kZToKCiAgICAgICAgICAgIGlmIGRpZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXSA9IHt9CiAgICAgICAgICAgICAgICBkaWZmWydiZWZvcmUnXVsnbW9kZSddID0gJzAlMDNvJyAlIHByZXZfbW9kZQogICAgICAgICAgICAgICAgaWYgJ2FmdGVyJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICBkaWZmWydhZnRlciddID0ge30KICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ21vZGUnXSA9ICcwJTAzbycgJSBtb2RlCgogICAgICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGU6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAjIEZJWE1FOiBjb21wYXJpc29uIGFnYWluc3Qgc3RyaW5nIGFib3ZlIHdpbGwgY2F1c2UgdGhpcyB0byBiZSBleGVjdXRlZAogICAgICAgICAgICAjIGV2ZXJ5IHRpbWUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihvcywgJ2xjaG1vZCcpOgogICAgICAgICAgICAgICAgICAgIG9zLmxjaG1vZChiX3BhdGgsIG1vZGUpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzbGluayhiX3BhdGgpOgogICAgICAgICAgICAgICAgICAgICAgICBvcy5jaG1vZChiX3BhdGgsIG1vZGUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBBdHRlbXB0IHRvIHNldCB0aGUgcGVybXMgb2YgdGhlIHN5bWxpbmsgYnV0IGJlCiAgICAgICAgICAgICAgICAgICAgICAgICMgY2FyZWZ1bCBub3QgdG8gY2hhbmdlIHRoZSBwZXJtcyBvZiB0aGUgdW5kZXJseWluZwogICAgICAgICAgICAgICAgICAgICAgICAjIGZpbGUgd2hpbGUgdHJ5aW5nCiAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVybHlpbmdfc3RhdCA9IG9zLnN0YXQoYl9wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICBvcy5jaG1vZChiX3BhdGgsIG1vZGUpCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld191bmRlcmx5aW5nX3N0YXQgPSBvcy5zdGF0KGJfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdW5kZXJseWluZ19zdGF0LnN0X21vZGUgIT0gbmV3X3VuZGVybHlpbmdfc3RhdC5zdF9tb2RlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2htb2QoYl9wYXRoLCBzdGF0LlNfSU1PREUodW5kZXJseWluZ19zdGF0LnN0X21vZGUpKQogICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguaXNsaW5rKGJfcGF0aCkgYW5kIGUuZXJybm8gPT0gZXJybm8uRVBFUk06ICAjIENhbid0IHNldCBtb2RlIG9uIHN5bWJvbGljIGxpbmtzCiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgZWxpZiBlLmVycm5vIGluIChlcnJuby5FTk9FTlQsIGVycm5vLkVMT09QKTogIyBDYW4ndCBzZXQgbW9kZSBvbiBicm9rZW4gc3ltYm9saWMgbGlua3MKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIGUKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHBhdGg9cGF0aCwgbXNnPSdjaG1vZCBmYWlsZWQnLCBkZXRhaWxzPXN0cihlKSkKCiAgICAgICAgICAgIHBhdGhfc3RhdCA9IG9zLmxzdGF0KGJfcGF0aCkKICAgICAgICAgICAgbmV3X21vZGUgPSBzdGF0LlNfSU1PREUocGF0aF9zdGF0LnN0X21vZGUpCgogICAgICAgICAgICBpZiBuZXdfbW9kZSAhPSBwcmV2X21vZGU6CiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgIHJldHVybiBjaGFuZ2VkCgogICAgZGVmIHNldF9hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChzZWxmLCBwYXRoLCBhdHRyaWJ1dGVzLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKCiAgICAgICAgaWYgYXR0cmlidXRlcyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgICAgICBiX3BhdGggPSB0b19ieXRlcyhwYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCiAgICAgICAgaWYgZXhwYW5kOgogICAgICAgICAgICBiX3BhdGggPSBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKGJfcGF0aCkpCiAgICAgICAgcGF0aCA9IHRvX3RleHQoYl9wYXRoLCBlcnJvcnM9J3N1cnJvZ2F0ZV90aGVuX3N0cmljdCcpCgogICAgICAgIGV4aXN0aW5nID0gc2VsZi5nZXRfZmlsZV9hdHRyaWJ1dGVzKGJfcGF0aCkKCiAgICAgICAgaWYgZXhpc3RpbmcuZ2V0KCdhdHRyX2ZsYWdzJywnJykgIT0gYXR0cmlidXRlczoKICAgICAgICAgICAgYXR0cmNtZCA9IHNlbGYuZ2V0X2Jpbl9wYXRoKCdjaGF0dHInKQogICAgICAgICAgICBpZiBhdHRyY21kOgogICAgICAgICAgICAgICAgYXR0cmNtZCA9IFthdHRyY21kLCAnPSVzJyAlIGF0dHJpYnV0ZXMsIGJfcGF0aF0KICAgICAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCgogICAgICAgICAgICAgICAgaWYgZGlmZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBpZiAnYmVmb3JlJyBub3QgaW4gZGlmZjoKICAgICAgICAgICAgICAgICAgICAgICAgZGlmZlsnYmVmb3JlJ10gPSB7fQogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2JlZm9yZSddWydhdHRyaWJ1dGVzJ10gPSBleGlzdGluZy5nZXQoJ2F0dHJfZmxhZ3MnKQogICAgICAgICAgICAgICAgICAgIGlmICdhZnRlcicgbm90IGluIGRpZmY6CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ10gPSB7fQogICAgICAgICAgICAgICAgICAgIGRpZmZbJ2FmdGVyJ11bJ2F0dHJpYnV0ZXMnXSA9IGF0dHJpYnV0ZXMKCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5jaGVja19tb2RlOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgcmMsIG91dCwgZXJyID0gc2VsZi5ydW5fY29tbWFuZChhdHRyY21kKQogICAgICAgICAgICAgICAgICAgICAgICBpZiByYyAhPSAwIG9yIGVycjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiRXJyb3Igd2hpbGUgc2V0dGluZyBhdHRyaWJ1dGVzOiAlcyIgJSAob3V0ICsgZXJyKSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocGF0aD1wYXRoLCBtc2c9J2NoYXR0ciBmYWlsZWQnLCBkZXRhaWxzPXN0cihlKSkKICAgICAgICByZXR1cm4gY2hhbmdlZAoKICAgIGRlZiBnZXRfZmlsZV9hdHRyaWJ1dGVzKHNlbGYsIHBhdGgpOgogICAgICAgIG91dHB1dCA9IHt9CiAgICAgICAgYXR0cmNtZCA9IHNlbGYuZ2V0X2Jpbl9wYXRoKCdsc2F0dHInLCBGYWxzZSkKICAgICAgICBpZiBhdHRyY21kOgogICAgICAgICAgICBhdHRyY21kID0gW2F0dHJjbWQsICctdmQnLCBwYXRoXQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByYywgb3V0LCBlcnIgPSBzZWxmLnJ1bl9jb21tYW5kKGF0dHJjbWQpCiAgICAgICAgICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICAgICAgICAgIHJlcyA9IG91dC5zcGxpdCgnICcpWzA6Ml0KICAgICAgICAgICAgICAgICAgICBvdXRwdXRbJ2F0dHJfZmxhZ3MnXSA9ICByZXNbMV0ucmVwbGFjZSgnLScsJycpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBvdXRwdXRbJ3ZlcnNpb24nXSA9IHJlc1swXS5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0WydhdHRyaWJ1dGVzJ10gPSBmb3JtYXRfYXR0cmlidXRlcyhvdXRwdXRbJ2F0dHJfZmxhZ3MnXSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBvdXRwdXQKCgogICAgZGVmIF9zeW1ib2xpY19tb2RlX3RvX29jdGFsKHNlbGYsIHBhdGhfc3RhdCwgc3ltYm9saWNfbW9kZSk6CiAgICAgICAgbmV3X21vZGUgPSBzdGF0LlNfSU1PREUocGF0aF9zdGF0LnN0X21vZGUpCgogICAgICAgIG1vZGVfcmUgPSByZS5jb21waWxlKHInXig/UDx1c2Vycz5bdWdvYV0rKSg/UDxvcGVyYXRvcj5bLSs9XSkoP1A8cGVybXM+W3J3eFhzdC1dKnxbdWdvXSkkJykKICAgICAgICBmb3IgbW9kZSBpbiBzeW1ib2xpY19tb2RlLnNwbGl0KCcsJyk6CiAgICAgICAgICAgIG1hdGNoID0gbW9kZV9yZS5tYXRjaChtb2RlKQogICAgICAgICAgICBpZiBtYXRjaDoKICAgICAgICAgICAgICAgIHVzZXJzID0gbWF0Y2guZ3JvdXAoJ3VzZXJzJykKICAgICAgICAgICAgICAgIG9wZXJhdG9yID0gbWF0Y2guZ3JvdXAoJ29wZXJhdG9yJykKICAgICAgICAgICAgICAgIHBlcm1zID0gbWF0Y2guZ3JvdXAoJ3Blcm1zJykKCiAgICAgICAgICAgICAgICBpZiB1c2VycyA9PSAnYSc6CiAgICAgICAgICAgICAgICAgICAgdXNlcnMgPSAndWdvJwoKICAgICAgICAgICAgICAgIGZvciB1c2VyIGluIHVzZXJzOgogICAgICAgICAgICAgICAgICAgIG1vZGVfdG9fYXBwbHkgPSBzZWxmLl9nZXRfb2N0YWxfbW9kZV9mcm9tX3N5bWJvbGljX3Blcm1zKHBhdGhfc3RhdCwgdXNlciwgcGVybXMpCiAgICAgICAgICAgICAgICAgICAgbmV3X21vZGUgPSBzZWxmLl9hcHBseV9vcGVyYXRpb25fdG9fbW9kZSh1c2VyLCBvcGVyYXRvciwgbW9kZV90b19hcHBseSwgbmV3X21vZGUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJiYWQgc3ltYm9saWMgcGVybWlzc2lvbiBmb3IgbW9kZTogJXMiICUgbW9kZSkKICAgICAgICByZXR1cm4gbmV3X21vZGUKCiAgICBkZWYgX2FwcGx5X29wZXJhdGlvbl90b19tb2RlKHNlbGYsIHVzZXIsIG9wZXJhdG9yLCBtb2RlX3RvX2FwcGx5LCBjdXJyZW50X21vZGUpOgogICAgICAgIGlmIG9wZXJhdG9yICA9PSAgJz0nOgogICAgICAgICAgICBpZiB1c2VyID09ICd1JzoKICAgICAgICAgICAgICAgIG1hc2sgPSBzdGF0LlNfSVJXWFUgfCBzdGF0LlNfSVNVSUQKICAgICAgICAgICAgZWxpZiB1c2VyID09ICdnJzoKICAgICAgICAgICAgICAgIG1hc2sgPSBzdGF0LlNfSVJXWEcgfCBzdGF0LlNfSVNHSUQKICAgICAgICAgICAgZWxpZiB1c2VyID09ICdvJzoKICAgICAgICAgICAgICAgIG1hc2sgPSBzdGF0LlNfSVJXWE8gfCBzdGF0LlNfSVNWVFgKCiAgICAgICAgICAgICMgbWFzayBvdXQgdSwgZywgb3IgbyBwZXJtaXNzaW9ucyBmcm9tIGN1cnJlbnRfbW9kZSBhbmQgYXBwbHkgbmV3IHBlcm1pc3Npb25zCiAgICAgICAgICAgIGludmVyc2VfbWFzayA9IG1hc2sgXiBQRVJNX0JJVFMKICAgICAgICAgICAgbmV3X21vZGUgPSAoY3VycmVudF9tb2RlICYgaW52ZXJzZV9tYXNrKSB8IG1vZGVfdG9fYXBwbHkKICAgICAgICBlbGlmIG9wZXJhdG9yID09ICcrJzoKICAgICAgICAgICAgbmV3X21vZGUgPSBjdXJyZW50X21vZGUgfCBtb2RlX3RvX2FwcGx5CiAgICAgICAgZWxpZiBvcGVyYXRvciA9PSAnLSc6CiAgICAgICAgICAgIG5ld19tb2RlID0gY3VycmVudF9tb2RlIC0gKGN1cnJlbnRfbW9kZSAmIG1vZGVfdG9fYXBwbHkpCiAgICAgICAgcmV0dXJuIG5ld19tb2RlCgogICAgZGVmIF9nZXRfb2N0YWxfbW9kZV9mcm9tX3N5bWJvbGljX3Blcm1zKHNlbGYsIHBhdGhfc3RhdCwgdXNlciwgcGVybXMpOgogICAgICAgIHByZXZfbW9kZSA9IHN0YXQuU19JTU9ERShwYXRoX3N0YXQuc3RfbW9kZSkKCiAgICAgICAgaXNfZGlyZWN0b3J5ID0gc3RhdC5TX0lTRElSKHBhdGhfc3RhdC5zdF9tb2RlKQogICAgICAgIGhhc194X3Blcm1pc3Npb25zID0gKHByZXZfbW9kZSAmIEVYRUNfUEVSTV9CSVRTKSA+IDAKICAgICAgICBhcHBseV9YX3Blcm1pc3Npb24gPSBpc19kaXJlY3Rvcnkgb3IgaGFzX3hfcGVybWlzc2lvbnMKCiAgICAgICAgIyBQZXJtaXNzaW9uIGJpdHMgY29uc3RhbnRzIGRvY3VtZW50ZWQgYXQ6CiAgICAgICAgIyBodHRwOi8vZG9jcy5weXRob24ub3JnLzIvbGlicmFyeS9zdGF0Lmh0bWwjc3RhdC5TX0lTVUlECiAgICAgICAgaWYgYXBwbHlfWF9wZXJtaXNzaW9uOgogICAgICAgICAgICBYX3Blcm1zID0gewogICAgICAgICAgICAgICAgJ3UnOiB7J1gnOiBzdGF0LlNfSVhVU1J9LAogICAgICAgICAgICAgICAgJ2cnOiB7J1gnOiBzdGF0LlNfSVhHUlB9LAogICAgICAgICAgICAgICAgJ28nOiB7J1gnOiBzdGF0LlNfSVhPVEh9CiAgICAgICAgICAgIH0KICAgICAgICBlbHNlOgogICAgICAgICAgICBYX3Blcm1zID0gewogICAgICAgICAgICAgICAgJ3UnOiB7J1gnOiAwfSwKICAgICAgICAgICAgICAgICdnJzogeydYJzogMH0sCiAgICAgICAgICAgICAgICAnbyc6IHsnWCc6IDB9CiAgICAgICAgICAgIH0KCiAgICAgICAgdXNlcl9wZXJtc190b19tb2RlcyA9IHsKICAgICAgICAgICAgJ3UnOiB7CiAgICAgICAgICAgICAgICAncic6IHN0YXQuU19JUlVTUiwKICAgICAgICAgICAgICAgICd3Jzogc3RhdC5TX0lXVVNSLAogICAgICAgICAgICAgICAgJ3gnOiBzdGF0LlNfSVhVU1IsCiAgICAgICAgICAgICAgICAncyc6IHN0YXQuU19JU1VJRCwKICAgICAgICAgICAgICAgICd0JzogMCwKICAgICAgICAgICAgICAgICd1JzogcHJldl9tb2RlICYgc3RhdC5TX0lSV1hVLAogICAgICAgICAgICAgICAgJ2cnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hHKSA8PCAzLAogICAgICAgICAgICAgICAgJ28nOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hPKSA8PCA2IH0sCiAgICAgICAgICAgICdnJzogewogICAgICAgICAgICAgICAgJ3InOiBzdGF0LlNfSVJHUlAsCiAgICAgICAgICAgICAgICAndyc6IHN0YXQuU19JV0dSUCwKICAgICAgICAgICAgICAgICd4Jzogc3RhdC5TX0lYR1JQLAogICAgICAgICAgICAgICAgJ3MnOiBzdGF0LlNfSVNHSUQsCiAgICAgICAgICAgICAgICAndCc6IDAsCiAgICAgICAgICAgICAgICAndSc6IChwcmV2X21vZGUgJiBzdGF0LlNfSVJXWFUpID4+IDMsCiAgICAgICAgICAgICAgICAnZyc6IHByZXZfbW9kZSAmIHN0YXQuU19JUldYRywKICAgICAgICAgICAgICAgICdvJzogKHByZXZfbW9kZSAmIHN0YXQuU19JUldYTykgPDwgMyB9LAogICAgICAgICAgICAnbyc6IHsKICAgICAgICAgICAgICAgICdyJzogc3RhdC5TX0lST1RILAogICAgICAgICAgICAgICAgJ3cnOiBzdGF0LlNfSVdPVEgsCiAgICAgICAgICAgICAgICAneCc6IHN0YXQuU19JWE9USCwKICAgICAgICAgICAgICAgICdzJzogMCwKICAgICAgICAgICAgICAgICd0Jzogc3RhdC5TX0lTVlRYLAogICAgICAgICAgICAgICAgJ3UnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hVKSA+PiA2LAogICAgICAgICAgICAgICAgJ2cnOiAocHJldl9tb2RlICYgc3RhdC5TX0lSV1hHKSA+PiAzLAogICAgICAgICAgICAgICAgJ28nOiBwcmV2X21vZGUgJiBzdGF0LlNfSVJXWE8gfQogICAgICAgIH0KCiAgICAgICAgIyBJbnNlcnQgWF9wZXJtcyBpbnRvIHVzZXJfcGVybXNfdG9fbW9kZXMKICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBYX3Blcm1zLml0ZW1zKCk6CiAgICAgICAgICAgIHVzZXJfcGVybXNfdG9fbW9kZXNba2V5XS51cGRhdGUodmFsdWUpCgogICAgICAgIG9yX3JlZHVjZSA9IGxhbWJkYSBtb2RlLCBwZXJtOiBtb2RlIHwgdXNlcl9wZXJtc190b19tb2Rlc1t1c2VyXVtwZXJtXQogICAgICAgIHJldHVybiByZWR1Y2Uob3JfcmVkdWNlLCBwZXJtcywgMCkKCiAgICBkZWYgc2V0X2ZzX2F0dHJpYnV0ZXNfaWZfZGlmZmVyZW50KHNlbGYsIGZpbGVfYXJncywgY2hhbmdlZCwgZGlmZj1Ob25lLCBleHBhbmQ9VHJ1ZSk6CiAgICAgICAgIyBzZXQgbW9kZXMgb3duZXJzIGFuZCBjb250ZXh0IGFzIG5lZWRlZAogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snc2Vjb250ZXh0J10sIGNoYW5nZWQsIGRpZmYKICAgICAgICApCiAgICAgICAgY2hhbmdlZCA9IHNlbGYuc2V0X293bmVyX2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snb3duZXInXSwgY2hhbmdlZCwgZGlmZiwgZXhwYW5kCiAgICAgICAgKQogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9ncm91cF9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ2dyb3VwJ10sIGNoYW5nZWQsIGRpZmYsIGV4cGFuZAogICAgICAgICkKICAgICAgICBjaGFuZ2VkID0gc2VsZi5zZXRfbW9kZV9pZl9kaWZmZXJlbnQoCiAgICAgICAgICAgIGZpbGVfYXJnc1sncGF0aCddLCBmaWxlX2FyZ3NbJ21vZGUnXSwgY2hhbmdlZCwgZGlmZiwgZXhwYW5kCiAgICAgICAgKQogICAgICAgIGNoYW5nZWQgPSBzZWxmLnNldF9hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgZmlsZV9hcmdzWydwYXRoJ10sIGZpbGVfYXJnc1snYXR0cmlidXRlcyddLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQKICAgICAgICApCiAgICAgICAgcmV0dXJuIGNoYW5nZWQKCiAgICBkZWYgc2V0X2RpcmVjdG9yeV9hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChzZWxmLCBmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmY9Tm9uZSwgZXhwYW5kPVRydWUpOgogICAgICAgIHJldHVybiBzZWxmLnNldF9mc19hdHRyaWJ1dGVzX2lmX2RpZmZlcmVudChmaWxlX2FyZ3MsIGNoYW5nZWQsIGRpZmYsIGV4cGFuZCkKCiAgICBkZWYgc2V0X2ZpbGVfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoc2VsZiwgZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmPU5vbmUsIGV4cGFuZD1UcnVlKToKICAgICAgICByZXR1cm4gc2VsZi5zZXRfZnNfYXR0cmlidXRlc19pZl9kaWZmZXJlbnQoZmlsZV9hcmdzLCBjaGFuZ2VkLCBkaWZmLCBleHBhbmQpCgogICAgZGVmIGFkZF9wYXRoX2luZm8oc2VsZiwga3dhcmdzKToKICAgICAgICAnJycKICAgICAgICBmb3IgcmVzdWx0cyB0aGF0IGFyZSBmaWxlcywgc3VwcGxlbWVudCB0aGUgaW5mbyBhYm91dCB0aGUgZmlsZQogICAgICAgIGluIHRoZSByZXR1cm4gcGF0aCB3aXRoIHN0YXRzIGFib3V0IHRoZSBmaWxlIHBhdGguCiAgICAgICAgJycnCgogICAgICAgIHBhdGggPSBrd2FyZ3MuZ2V0KCdwYXRoJywga3dhcmdzLmdldCgnZGVzdCcsIE5vbmUpKQogICAgICAgIGlmIHBhdGggaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGt3YXJncwogICAgICAgIGJfcGF0aCA9IHRvX2J5dGVzKHBhdGgsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoYl9wYXRoKToKICAgICAgICAgICAgKHVpZCwgZ2lkKSA9IHNlbGYudXNlcl9hbmRfZ3JvdXAocGF0aCkKICAgICAgICAgICAga3dhcmdzWyd1aWQnXSA9IHVpZAogICAgICAgICAgICBrd2FyZ3NbJ2dpZCddID0gZ2lkCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHVzZXIgPSBwd2QuZ2V0cHd1aWQodWlkKVswXQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICB1c2VyID0gc3RyKHVpZCkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZ3JvdXAgPSBncnAuZ2V0Z3JnaWQoZ2lkKVswXQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBncm91cCA9IHN0cihnaWQpCiAgICAgICAgICAgIGt3YXJnc1snb3duZXInXSA9IHVzZXIKICAgICAgICAgICAga3dhcmdzWydncm91cCddID0gZ3JvdXAKICAgICAgICAgICAgc3QgPSBvcy5sc3RhdChiX3BhdGgpCiAgICAgICAgICAgIGt3YXJnc1snbW9kZSddID0gJzAlMDNvJyAlIHN0YXQuU19JTU9ERShzdFtzdGF0LlNUX01PREVdKQogICAgICAgICAgICAjIHNlY29udGV4dCBub3QgeWV0IHN1cHBvcnRlZAogICAgICAgICAgICBpZiBvcy5wYXRoLmlzbGluayhiX3BhdGgpOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2xpbmsnCiAgICAgICAgICAgIGVsaWYgb3MucGF0aC5pc2RpcihiX3BhdGgpOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2RpcmVjdG9yeScKICAgICAgICAgICAgZWxpZiBvcy5zdGF0KGJfcGF0aCkuc3RfbmxpbmsgPiAxOgogICAgICAgICAgICAgICAga3dhcmdzWydzdGF0ZSddID0gJ2hhcmQnCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnZmlsZScKICAgICAgICAgICAgaWYgSEFWRV9TRUxJTlVYIGFuZCBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAga3dhcmdzWydzZWNvbnRleHQnXSA9ICc6Jy5qb2luKHNlbGYuc2VsaW51eF9jb250ZXh0KHBhdGgpKQogICAgICAgICAgICBrd2FyZ3NbJ3NpemUnXSA9IHN0W3N0YXQuU1RfU0laRV0KICAgICAgICBlbHNlOgogICAgICAgICAgICBrd2FyZ3NbJ3N0YXRlJ10gPSAnYWJzZW50JwogICAgICAgIHJldHVybiBrd2FyZ3MKCiAgICBkZWYgX2NoZWNrX2xvY2FsZShzZWxmKToKICAgICAgICAnJycKICAgICAgICBVc2VzIHRoZSBsb2NhbGUgbW9kdWxlIHRvIHRlc3QgdGhlIGN1cnJlbnRseSBzZXQgbG9jYWxlCiAgICAgICAgKHBlciB0aGUgTEFORyBhbmQgTENfQ1RZUEUgZW52aXJvbm1lbnQgc2V0dGluZ3MpCiAgICAgICAgJycnCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIHNldHRpbmcgdGhlIGxvY2FsZSB0byAnJyB1c2VzIHRoZSBkZWZhdWx0IGxvY2FsZQogICAgICAgICAgICAjIGFzIGl0IHdvdWxkIGJlIHJldHVybmVkIGJ5IGxvY2FsZS5nZXRkZWZhdWx0bG9jYWxlKCkKICAgICAgICAgICAgbG9jYWxlLnNldGxvY2FsZShsb2NhbGUuTENfQUxMLCAnJykKICAgICAgICBleGNlcHQgbG9jYWxlLkVycm9yOgogICAgICAgICAgICAjIGZhbGxiYWNrIHRvIHRoZSAnQycgbG9jYWxlLCB3aGljaCBtYXkgY2F1c2UgdW5pY29kZQogICAgICAgICAgICAjIGlzc3VlcyBidXQgaXMgcHJlZmVyYWJsZSB0byBzaW1wbHkgZmFpbGluZyBiZWNhdXNlCiAgICAgICAgICAgICMgb2YgYW4gdW5rbm93biBsb2NhbGUKICAgICAgICAgICAgbG9jYWxlLnNldGxvY2FsZShsb2NhbGUuTENfQUxMLCAnQycpCiAgICAgICAgICAgIG9zLmVudmlyb25bJ0xBTkcnXSA9ICdDJwogICAgICAgICAgICBvcy5lbnZpcm9uWydMQ19BTEwnXSA9ICdDJwogICAgICAgICAgICBvcy5lbnZpcm9uWydMQ19NRVNTQUdFUyddID0gJ0MnCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IkFuIHVua25vd24gZXJyb3Igd2FzIGVuY291bnRlcmVkIHdoaWxlIGF0dGVtcHRpbmcgdG8gdmFsaWRhdGUgdGhlIGxvY2FsZTogJXMiICUgZSkKCiAgICBkZWYgX2hhbmRsZV9hbGlhc2VzKHNlbGYsIHNwZWM9Tm9uZSk6CiAgICAgICAgIyB0aGlzIHVzZXMgZXhjZXB0aW9ucyBhcyBpdCBoYXBwZW5zIGJlZm9yZSB3ZSBjYW4gc2FmZWx5IGNhbGwgZmFpbF9qc29uCiAgICAgICAgYWxpYXNlc19yZXN1bHRzID0ge30gI2FsaWFzOmNhbm9uCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICBzcGVjID0gc2VsZi5hcmd1bWVudF9zcGVjCiAgICAgICAgZm9yIChrLHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgc2VsZi5fbGVnYWxfaW5wdXRzLmFwcGVuZChrKQogICAgICAgICAgICBhbGlhc2VzID0gdi5nZXQoJ2FsaWFzZXMnLCBOb25lKQogICAgICAgICAgICBkZWZhdWx0ID0gdi5nZXQoJ2RlZmF1bHQnLCBOb25lKQogICAgICAgICAgICByZXF1aXJlZCA9IHYuZ2V0KCdyZXF1aXJlZCcsIEZhbHNlKQogICAgICAgICAgICBpZiBkZWZhdWx0IGlzIG5vdCBOb25lIGFuZCByZXF1aXJlZDoKICAgICAgICAgICAgICAgICMgbm90IGFsaWFzIHNwZWNpZmljIGJ1dCB0aGlzIGlzIGEgZ29vZCBwbGFjZSB0byBjaGVjayB0aGlzCiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oImludGVybmFsIGVycm9yOiByZXF1aXJlZCBhbmQgZGVmYXVsdCBhcmUgbXV0dWFsbHkgZXhjbHVzaXZlIGZvciAlcyIgJSBrKQogICAgICAgICAgICBpZiBhbGlhc2VzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShhbGlhc2VzLCBTRVFVRU5DRVRZUEUpIG9yIGlzaW5zdGFuY2UoYWxpYXNlcywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKToKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbignaW50ZXJuYWwgZXJyb3I6IGFsaWFzZXMgbXVzdCBiZSBhIGxpc3Qgb3IgdHVwbGUnKQogICAgICAgICAgICBmb3IgYWxpYXMgaW4gYWxpYXNlczoKICAgICAgICAgICAgICAgIHNlbGYuX2xlZ2FsX2lucHV0cy5hcHBlbmQoYWxpYXMpCiAgICAgICAgICAgICAgICBhbGlhc2VzX3Jlc3VsdHNbYWxpYXNdID0gawogICAgICAgICAgICAgICAgaWYgYWxpYXMgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBzZWxmLnBhcmFtc1thbGlhc10KCiAgICAgICAgcmV0dXJuIGFsaWFzZXNfcmVzdWx0cwoKICAgIGRlZiBfY2hlY2tfYXJndW1lbnRzKHNlbGYsIGNoZWNrX2ludmFsaWRfYXJndW1lbnRzKToKICAgICAgICBzZWxmLl9zeXNsb2dfZmFjaWxpdHkgPSAnTE9HX1VTRVInCiAgICAgICAgdW5zdXBwb3J0ZWRfcGFyYW1ldGVycyA9IHNldCgpCiAgICAgICAgZm9yIChrLHYpIGluIGxpc3Qoc2VsZi5wYXJhbXMuaXRlbXMoKSk6CgogICAgICAgICAgICBpZiBrID09ICdfYW5zaWJsZV9jaGVja19tb2RlJyBhbmQgdjoKICAgICAgICAgICAgICAgIHNlbGYuY2hlY2tfbW9kZSA9IFRydWUKCiAgICAgICAgICAgIGVsaWYgayA9PSAnX2Fuc2libGVfbm9fbG9nJzoKICAgICAgICAgICAgICAgIHNlbGYubm9fbG9nID0gc2VsZi5ib29sZWFuKHYpCgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX2RlYnVnJzoKICAgICAgICAgICAgICAgIHNlbGYuX2RlYnVnID0gc2VsZi5ib29sZWFuKHYpCgogICAgICAgICAgICBlbGlmIGsgPT0gJ19hbnNpYmxlX2RpZmYnOgogICAgICAgICAgICAgICAgc2VsZi5fZGlmZiA9IHNlbGYuYm9vbGVhbih2KQoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV92ZXJib3NpdHknOgogICAgICAgICAgICAgICAgc2VsZi5fdmVyYm9zaXR5ID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9zZWxpbnV4X3NwZWNpYWxfZnMnOgogICAgICAgICAgICAgICAgc2VsZi5fc2VsaW51eF9zcGVjaWFsX2ZzID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9zeXNsb2dfZmFjaWxpdHknOgogICAgICAgICAgICAgICAgc2VsZi5fc3lzbG9nX2ZhY2lsaXR5ID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV92ZXJzaW9uJzoKICAgICAgICAgICAgICAgIHNlbGYuYW5zaWJsZV92ZXJzaW9uID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9tb2R1bGVfbmFtZSc6CiAgICAgICAgICAgICAgICBzZWxmLl9uYW1lID0gdgoKICAgICAgICAgICAgZWxpZiBrID09ICdfYW5zaWJsZV9zb2NrZXQnOgogICAgICAgICAgICAgICAgc2VsZi5fc29ja2V0X3BhdGggPSB2CgogICAgICAgICAgICBlbGlmIGNoZWNrX2ludmFsaWRfYXJndW1lbnRzIGFuZCBrIG5vdCBpbiBzZWxmLl9sZWdhbF9pbnB1dHM6CiAgICAgICAgICAgICAgICB1bnN1cHBvcnRlZF9wYXJhbWV0ZXJzLmFkZChrKQoKICAgICAgICAgICAgI2NsZWFuIHVwIGludGVybmFsIHBhcmFtczoKICAgICAgICAgICAgaWYgay5zdGFydHN3aXRoKCdfYW5zaWJsZV8nKToKICAgICAgICAgICAgICAgIGRlbCBzZWxmLnBhcmFtc1trXQoKICAgICAgICBpZiB1bnN1cHBvcnRlZF9wYXJhbWV0ZXJzOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IlVuc3VwcG9ydGVkIHBhcmFtZXRlcnMgZm9yICglcykgbW9kdWxlOiAlcy4gU3VwcG9ydGVkIHBhcmFtZXRlcnMgaW5jbHVkZTogJXMiICUgKHNlbGYuX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJywnLmpvaW4oc29ydGVkKGxpc3QodW5zdXBwb3J0ZWRfcGFyYW1ldGVycykpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLCcuam9pbihzb3J0ZWQoc2VsZi5hcmd1bWVudF9zcGVjLmtleXMoKSkpKSkKICAgICAgICBpZiBzZWxmLmNoZWNrX21vZGUgYW5kIG5vdCBzZWxmLnN1cHBvcnRzX2NoZWNrX21vZGU6CiAgICAgICAgICAgIHNlbGYuZXhpdF9qc29uKHNraXBwZWQ9VHJ1ZSwgbXNnPSJyZW1vdGUgbW9kdWxlICglcykgZG9lcyBub3Qgc3VwcG9ydCBjaGVjayBtb2RlIiAlIHNlbGYuX25hbWUpCgogICAgZGVmIF9jb3VudF90ZXJtcyhzZWxmLCBjaGVjayk6CiAgICAgICAgY291bnQgPSAwCiAgICAgICAgZm9yIHRlcm0gaW4gY2hlY2s6CiAgICAgICAgICAgIGlmIHRlcm0gaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICBjb3VudCArPSAxCiAgICAgICAgcmV0dXJuIGNvdW50CgogICAgZGVmIF9jaGVja19tdXR1YWxseV9leGNsdXNpdmUoc2VsZiwgc3BlYyk6CiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3IgY2hlY2sgaW4gc3BlYzoKICAgICAgICAgICAgY291bnQgPSBzZWxmLl9jb3VudF90ZXJtcyhjaGVjaykKICAgICAgICAgICAgaWYgY291bnQgPiAxOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJwYXJhbWV0ZXJzIGFyZSBtdXR1YWxseSBleGNsdXNpdmU6ICVzIiAlIChjaGVjaywpKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfb25lX29mKHNlbGYsIHNwZWMpOgogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZm9yIGNoZWNrIGluIHNwZWM6CiAgICAgICAgICAgIGNvdW50ID0gc2VsZi5fY291bnRfdGVybXMoY2hlY2spCiAgICAgICAgICAgIGlmIGNvdW50ID09IDA6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9Im9uZSBvZiB0aGUgZm9sbG93aW5nIGlzIHJlcXVpcmVkOiAlcyIgJSAnLCcuam9pbihjaGVjaykpCgogICAgZGVmIF9jaGVja19yZXF1aXJlZF90b2dldGhlcihzZWxmLCBzcGVjKToKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciBjaGVjayBpbiBzcGVjOgogICAgICAgICAgICBjb3VudHMgPSBbIHNlbGYuX2NvdW50X3Rlcm1zKFtmaWVsZF0pIGZvciBmaWVsZCBpbiBjaGVjayBdCiAgICAgICAgICAgIG5vbl96ZXJvID0gWyBjIGZvciBjIGluIGNvdW50cyBpZiBjID4gMCBdCiAgICAgICAgICAgIGlmIGxlbihub25femVybykgPiAwOgogICAgICAgICAgICAgICAgaWYgMCBpbiBjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJwYXJhbWV0ZXJzIGFyZSByZXF1aXJlZCB0b2dldGhlcjogJXMiICUgKGNoZWNrLCkpCgogICAgZGVmIF9jaGVja19yZXF1aXJlZF9hcmd1bWVudHMoc2VsZiwgc3BlYz1Ob25lLCBwYXJhbT1Ob25lICk6CiAgICAgICAgJycnIGVuc3VyZSBhbGwgcmVxdWlyZWQgYXJndW1lbnRzIGFyZSBwcmVzZW50ICcnJwogICAgICAgIG1pc3NpbmcgPSBbXQogICAgICAgIGlmIHNwZWMgaXMgTm9uZToKICAgICAgICAgICAgc3BlYyA9IHNlbGYuYXJndW1lbnRfc3BlYwogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAgICAgIHBhcmFtID0gc2VsZi5wYXJhbXMKICAgICAgICBmb3IgKGssdikgaW4gc3BlYy5pdGVtcygpOgogICAgICAgICAgICByZXF1aXJlZCA9IHYuZ2V0KCdyZXF1aXJlZCcsIEZhbHNlKQogICAgICAgICAgICBpZiByZXF1aXJlZCBhbmQgayBub3QgaW4gcGFyYW06CiAgICAgICAgICAgICAgICBtaXNzaW5nLmFwcGVuZChrKQogICAgICAgIGlmIGxlbihtaXNzaW5nKSA+IDA6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0ibWlzc2luZyByZXF1aXJlZCBhcmd1bWVudHM6ICVzIiAlICIsIi5qb2luKG1pc3NpbmcpKQoKICAgIGRlZiBfY2hlY2tfcmVxdWlyZWRfaWYoc2VsZiwgc3BlYyk6CiAgICAgICAgJycnIGVuc3VyZSB0aGF0IHBhcmFtZXRlcnMgd2hpY2ggY29uZGl0aW9uYWxseSByZXF1aXJlZCBhcmUgcHJlc2VudCAnJycKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciBzcCBpbiBzcGVjOgogICAgICAgICAgICBtaXNzaW5nID0gW10KICAgICAgICAgICAgbWF4X21pc3NpbmdfY291bnQgPSAwCiAgICAgICAgICAgIGlzX29uZV9vZiA9IEZhbHNlCiAgICAgICAgICAgIGlmIGxlbihzcCkgPT0gNDoKICAgICAgICAgICAgICAgIGtleSwgdmFsLCByZXF1aXJlbWVudHMsIGlzX29uZV9vZiA9IHNwCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBrZXksIHZhbCwgcmVxdWlyZW1lbnRzID0gc3AKCiAgICAgICAgICAgICMgaXNfb25lX29mIGlzIFRydWUgYXQgbGVhc3Qgb25lIHJlcXVpcmVtZW50IHNob3VsZCBiZQogICAgICAgICAgICAjIHByZXNlbnQsIGVsc2UgYWxsIHJlcXVpcmVtZW50cyBzaG91bGQgYmUgcHJlc2VudC4KICAgICAgICAgICAgaWYgaXNfb25lX29mOgogICAgICAgICAgICAgICAgbWF4X21pc3NpbmdfY291bnQgPSBsZW4ocmVxdWlyZW1lbnRzKQoKICAgICAgICAgICAgaWYga2V5IGluIHNlbGYucGFyYW1zIGFuZCBzZWxmLnBhcmFtc1trZXldID09IHZhbDoKICAgICAgICAgICAgICAgIGZvciBjaGVjayBpbiByZXF1aXJlbWVudHM6CiAgICAgICAgICAgICAgICAgICAgY291bnQgPSBzZWxmLl9jb3VudF90ZXJtcygoY2hlY2ssKSkKICAgICAgICAgICAgICAgICAgICBpZiBjb3VudCA9PSAwOgogICAgICAgICAgICAgICAgICAgICAgICBtaXNzaW5nLmFwcGVuZChjaGVjaykKICAgICAgICAgICAgaWYgbGVuKG1pc3NpbmcpIGFuZCBsZW4obWlzc2luZykgPj0gbWF4X21pc3NpbmdfY291bnQ6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IiVzIGlzICVzIGJ1dCB0aGUgZm9sbG93aW5nIGFyZSBtaXNzaW5nOiAlcyIgJSAoa2V5LCB2YWwsICcsJy5qb2luKG1pc3NpbmcpKSkKCiAgICBkZWYgX2NoZWNrX2FyZ3VtZW50X3ZhbHVlcyhzZWxmLCBzcGVjPU5vbmUsIHBhcmFtPU5vbmUpOgogICAgICAgICcnJyBlbnN1cmUgYWxsIGFyZ3VtZW50cyBoYXZlIHRoZSByZXF1ZXN0ZWQgdmFsdWVzLCBhbmQgdGhlcmUgYXJlIG5vIHN0cmF5IGFyZ3VtZW50cyAnJycKICAgICAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgICAgIHNwZWMgPSBzZWxmLmFyZ3VtZW50X3NwZWMKICAgICAgICBpZiBwYXJhbSBpcyBOb25lOgogICAgICAgICAgICBwYXJhbSA9IHNlbGYucGFyYW1zCiAgICAgICAgZm9yIChrLHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgY2hvaWNlcyA9IHYuZ2V0KCdjaG9pY2VzJyxOb25lKQogICAgICAgICAgICBpZiBjaG9pY2VzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGNob2ljZXMsIFNFUVVFTkNFVFlQRSkgYW5kIG5vdCBpc2luc3RhbmNlKGNob2ljZXMsIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgICAgICBpZiBrIGluIHBhcmFtOgogICAgICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdIG5vdCBpbiBjaG9pY2VzOgogICAgICAgICAgICAgICAgICAgICAgICAjIFB5WWFtbCBjb252ZXJ0cyBjZXJ0YWluIHN0cmluZ3MgdG8gYm9vbHMuICBJZiB3ZSBjYW4gdW5hbWJpZ3VvdXNseSBjb252ZXJ0IGJhY2ssIGRvIHNvIGJlZm9yZSBjaGVja2luZwogICAgICAgICAgICAgICAgICAgICAgICAjIHRoZSB2YWx1ZS4gIElmIHdlIGNhbid0IGZpZ3VyZSB0aGlzIG91dCwgbW9kdWxlIGF1dGhvciBpcyByZXNwb25zaWJsZS4KICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJlZF9jaG9pY2VzID0gTm9uZQogICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSA9PSAnRmFsc2UnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJlZF9jaG9pY2VzID0gX2xlbmllbnRfbG93ZXJjYXNlKGNob2ljZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGQUxTRVkgPSBmcm96ZW5zZXQoQk9PTEVBTlNfRkFMU0UpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdmVybGFwID0gRkFMU0VZLmludGVyc2VjdGlvbihjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKG92ZXJsYXApID09IDE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBFeHRyYWN0IGZyb20gYSBzZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAocGFyYW1ba10sKSA9IG92ZXJsYXAKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHBhcmFtW2tdID09ICdUcnVlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxvd2VyZWRfY2hvaWNlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvd2VyZWRfY2hvaWNlcyA9IF9sZW5pZW50X2xvd2VyY2FzZShjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgVFJVVEhZID0gZnJvemVuc2V0KEJPT0xFQU5TX1RSVUUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdmVybGFwID0gVFJVVEhZLmludGVyc2VjdGlvbihjaG9pY2VzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKG92ZXJsYXApID09IDE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHBhcmFtW2tdLCkgPSBvdmVybGFwCgogICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbVtrXSBub3QgaW4gY2hvaWNlczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXNfc3RyPSIsIi5qb2luKFt0b19uYXRpdmUoYykgZm9yIGMgaW4gY2hvaWNlc10pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2c9InZhbHVlIG9mICVzIG11c3QgYmUgb25lIG9mOiAlcywgZ290OiAlcyIgJSAoaywgY2hvaWNlc19zdHIsIHBhcmFtW2tdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPW1zZykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iaW50ZXJuYWwgZXJyb3I6IGNob2ljZXMgZm9yIGFyZ3VtZW50ICVzIGFyZSBub3QgaXRlcmFibGU6ICVzIiAlIChrLCBjaG9pY2VzKSkKCiAgICBkZWYgc2FmZV9ldmFsKHNlbGYsIHZhbHVlLCBsb2NhbHM9Tm9uZSwgaW5jbHVkZV9leGNlcHRpb25zPUZhbHNlKToKCiAgICAgICAgIyBkbyBub3QgYWxsb3cgbWV0aG9kIGNhbGxzIHRvIG1vZHVsZXMKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgIyBhbHJlYWR5IHRlbXBsYXRlZCB0byBhIGRhdGF2YWx1ZXN0cnVjdHVyZSwgcGVyaGFwcz8KICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgTm9uZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgaWYgcmUuc2VhcmNoKHInXHdcLlx3K1woJywgdmFsdWUpOgogICAgICAgICAgICBpZiBpbmNsdWRlX2V4Y2VwdGlvbnM6CiAgICAgICAgICAgICAgICByZXR1cm4gKHZhbHVlLCBOb25lKQogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICAjIGRvIG5vdCBhbGxvdyBpbXBvcnRzCiAgICAgICAgaWYgcmUuc2VhcmNoKHInaW1wb3J0IFx3KycsIHZhbHVlKToKICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgTm9uZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXN1bHQgPSBsaXRlcmFsX2V2YWwodmFsdWUpCiAgICAgICAgICAgIGlmIGluY2x1ZGVfZXhjZXB0aW9uczoKICAgICAgICAgICAgICAgIHJldHVybiAocmVzdWx0LCBOb25lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgaWYgaW5jbHVkZV9leGNlcHRpb25zOgogICAgICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSwgZSkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgZGVmIF9jaGVja190eXBlX3N0cihzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgc3RyaW5nX3R5cGVzKToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgIyBOb3RlOiBUaGlzIGNvdWxkIHRocm93IGEgdW5pY29kZSBlcnJvciBpZiB2YWx1ZSdzIF9fc3RyX18oKSBtZXRob2QKICAgICAgICAjIHJldHVybnMgbm9uLWFzY2lpLiAgSGF2ZSB0byBwb3J0IHV0aWxzLnRvX2J5dGVzKCkgaWYgdGhhdCBoYXBwZW5zCiAgICAgICAgcmV0dXJuIHN0cih2YWx1ZSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfbGlzdChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgbGlzdCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICByZXR1cm4gdmFsdWUuc3BsaXQoIiwiKQogICAgICAgIGVsaWYgaXNpbnN0YW5jZSh2YWx1ZSwgaW50KSBvciBpc2luc3RhbmNlKHZhbHVlLCBmbG9hdCk6CiAgICAgICAgICAgIHJldHVybiBbIHN0cih2YWx1ZSkgXQoKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBsaXN0JyAlIHR5cGUodmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9kaWN0KHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBkaWN0KToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIGlmIHZhbHVlLnN0YXJ0c3dpdGgoInsiKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5sb2Fkcyh2YWx1ZSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAocmVzdWx0LCBleGMpID0gc2VsZi5zYWZlX2V2YWwodmFsdWUsIGRpY3QoKSwgaW5jbHVkZV9leGNlcHRpb25zPVRydWUpCiAgICAgICAgICAgICAgICAgICAgaWYgZXhjIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ3VuYWJsZSB0byBldmFsdWF0ZSBzdHJpbmcgYXMgZGljdGlvbmFyeScpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICAgICAgICBlbGlmICc9JyBpbiB2YWx1ZToKICAgICAgICAgICAgICAgIGZpZWxkcyA9IFtdCiAgICAgICAgICAgICAgICBmaWVsZF9idWZmZXIgPSBbXQogICAgICAgICAgICAgICAgaW5fcXVvdGUgPSBGYWxzZQogICAgICAgICAgICAgICAgaW5fZXNjYXBlID0gRmFsc2UKICAgICAgICAgICAgICAgIGZvciBjIGluIHZhbHVlLnN0cmlwKCk6CiAgICAgICAgICAgICAgICAgICAgaWYgaW5fZXNjYXBlOgogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZF9idWZmZXIuYXBwZW5kKGMpCiAgICAgICAgICAgICAgICAgICAgICAgIGluX2VzY2FwZSA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgZWxpZiBjID09ICdcXCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGluX2VzY2FwZSA9IFRydWUKICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBpbl9xdW90ZSBhbmQgYyBpbiAoJ1wnJywgJyInKToKICAgICAgICAgICAgICAgICAgICAgICAgaW5fcXVvdGUgPSBjCiAgICAgICAgICAgICAgICAgICAgZWxpZiBpbl9xdW90ZSBhbmQgaW5fcXVvdGUgPT0gYzoKICAgICAgICAgICAgICAgICAgICAgICAgaW5fcXVvdGUgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsaWYgbm90IGluX3F1b3RlIGFuZCBjIGluICgnLCcsICcgJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkID0gJycuam9pbihmaWVsZF9idWZmZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGZpZWxkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzLmFwcGVuZChmaWVsZCkKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRfYnVmZmVyID0gW10KICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZF9idWZmZXIuYXBwZW5kKGMpCgogICAgICAgICAgICAgICAgZmllbGQgPSAnJy5qb2luKGZpZWxkX2J1ZmZlcikKICAgICAgICAgICAgICAgIGlmIGZpZWxkOgogICAgICAgICAgICAgICAgICAgIGZpZWxkcy5hcHBlbmQoZmllbGQpCiAgICAgICAgICAgICAgICByZXR1cm4gZGljdCh4LnNwbGl0KCI9IiwgMSkgZm9yIHggaW4gZmllbGRzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJkaWN0aW9uYXJ5IHJlcXVlc3RlZCwgY291bGQgbm90IHBhcnNlIEpTT04gb3Iga2V5PXZhbHVlIikKCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgZGljdCcgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfYm9vbChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgYm9vbCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHJpbmdfdHlwZXMpIG9yIGlzaW5zdGFuY2UodmFsdWUsIGludCk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmJvb2xlYW4odmFsdWUpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIGJvb2wnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2ludChzZWxmLCB2YWx1ZSk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgaW50KToKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIHJldHVybiBpbnQodmFsdWUpCgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhbiBpbnQnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX2Zsb2F0KHNlbGYsIHZhbHVlKToKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBmbG9hdCk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZQoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSwgaW50KSk6CiAgICAgICAgICAgIHJldHVybiBmbG9hdCh2YWx1ZSkKCiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCclcyBjYW5ub3QgYmUgY29udmVydGVkIHRvIGEgZmxvYXQnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja190eXBlX3BhdGgoc2VsZiwgdmFsdWUpOgogICAgICAgIHZhbHVlID0gc2VsZi5fY2hlY2tfdHlwZV9zdHIodmFsdWUpCiAgICAgICAgcmV0dXJuIG9zLnBhdGguZXhwYW5kdXNlcihvcy5wYXRoLmV4cGFuZHZhcnModmFsdWUpKQoKICAgIGRlZiBfY2hlY2tfdHlwZV9qc29uYXJnKHNlbGYsIHZhbHVlKToKICAgICAgICAjIFJldHVybiBhIGpzb25pZmllZCBzdHJpbmcuICBTb21ldGltZXMgdGhlIGNvbnRyb2xsZXIgdHVybnMgYSBqc29uCiAgICAgICAgIyBzdHJpbmcgaW50byBhIGRpY3QvbGlzdCBzbyB0cmFuc2Zvcm0gaXQgYmFjayBpbnRvIGpzb24gaGVyZQogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlKSk6CiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5zdHJpcCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgKGxpc3QsIHR1cGxlLCBkaWN0KSk6CiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5kdW1wcyh2YWx1ZSkKICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBqc29uIHN0cmluZycgJSB0eXBlKHZhbHVlKSkKCiAgICBkZWYgX2NoZWNrX3R5cGVfcmF3KHNlbGYsIHZhbHVlKToKICAgICAgICByZXR1cm4gdmFsdWUKCgogICAgZGVmIF9jaGVja190eXBlX2J5dGVzKHNlbGYsIHZhbHVlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuaHVtYW5fdG9fYnl0ZXModmFsdWUpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcignJXMgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhIEJ5dGUgdmFsdWUnICUgdHlwZSh2YWx1ZSkpCgoKICAgIGRlZiBfY2hlY2tfdHlwZV9iaXRzKHNlbGYsIHZhbHVlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuaHVtYW5fdG9fYnl0ZXModmFsdWUsIGlzYml0cz1UcnVlKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJyVzIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gYSBCaXQgdmFsdWUnICUgdHlwZSh2YWx1ZSkpCgogICAgZGVmIF9jaGVja19hcmd1bWVudF90eXBlcyhzZWxmLCBzcGVjPU5vbmUsIHBhcmFtPU5vbmUpOgogICAgICAgICcnJyBlbnN1cmUgYWxsIGFyZ3VtZW50cyBoYXZlIHRoZSByZXF1ZXN0ZWQgdHlwZSAnJycKCiAgICAgICAgaWYgc3BlYyBpcyBOb25lOgogICAgICAgICAgICBzcGVjID0gc2VsZi5hcmd1bWVudF9zcGVjCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToKICAgICAgICAgICAgcGFyYW0gPSBzZWxmLnBhcmFtcwoKICAgICAgICBmb3IgKGssIHYpIGluIHNwZWMuaXRlbXMoKToKICAgICAgICAgICAgd2FudGVkID0gdi5nZXQoJ3R5cGUnLCBOb25lKQogICAgICAgICAgICBpZiBrIG5vdCBpbiBwYXJhbToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIHdhbnRlZCBpcyBOb25lOgogICAgICAgICAgICAgICAgIyBNb3N0bHkgd2Ugd2FudCB0byBkZWZhdWx0IHRvIHN0ci4KICAgICAgICAgICAgICAgICMgRm9yIHZhbHVlcyBzZXQgdG8gTm9uZSBleHBsaWNpdGx5LCByZXR1cm4gTm9uZSBpbnN0ZWFkIGFzCiAgICAgICAgICAgICAgICAjIHRoYXQgYWxsb3dzIGEgdXNlciB0byB1bnNldCBhIHBhcmFtZXRlcgogICAgICAgICAgICAgICAgaWYgcGFyYW1ba10gaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgd2FudGVkID0gJ3N0cicKCiAgICAgICAgICAgIHZhbHVlID0gcGFyYW1ba10KICAgICAgICAgICAgaWYgdmFsdWUgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB0eXBlX2NoZWNrZXIgPSBzZWxmLl9DSEVDS19BUkdVTUVOVF9UWVBFU19ESVNQQVRDSEVSW3dhbnRlZF0KICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSJpbXBsZW1lbnRhdGlvbiBlcnJvcjogdW5rbm93biB0eXBlICVzIHJlcXVlc3RlZCBmb3IgJXMiICUgKHdhbnRlZCwgaykpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHBhcmFtW2tdID0gdHlwZV9jaGVja2VyKHZhbHVlKQogICAgICAgICAgICBleGNlcHQgKFR5cGVFcnJvciwgVmFsdWVFcnJvcik6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImFyZ3VtZW50ICVzIGlzIG9mIHR5cGUgJXMgYW5kIHdlIHdlcmUgdW5hYmxlIHRvIGNvbnZlcnQgdG8gJXM6ICVzIiAlIChrLCB0eXBlKHZhbHVlKSwgd2FudGVkLCBlKSkKCiAgICAgICAgICAgICMgZGVhbCB3aXRoIHN1YiBvcHRpb25zIHRvIGNyZWF0ZSBzdWIgc3BlYwogICAgICAgICAgICBzcGVjID0gTm9uZQogICAgICAgICAgICBpZiB3YW50ZWQgPT0gJ2RpY3QnIG9yICh3YW50ZWQgPT0gJ2xpc3QnIGFuZCB2LmdldCgnZWxlbWVudHMnLCAnJykgPT0gJ2RpY3QnKToKICAgICAgICAgICAgICAgIHNwZWMgPSB2LmdldCgnb3B0aW9ucycsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBzcGVjOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX3JlcXVpcmVkX2FyZ3VtZW50cyhzcGVjLCBwYXJhbVtrXSkKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudF90eXBlcyhzcGVjLCBwYXJhbVtrXSkKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19hcmd1bWVudF92YWx1ZXMoc3BlYywgcGFyYW1ba10pCgogICAgZGVmIF9zZXRfZGVmYXVsdHMoc2VsZiwgcHJlPVRydWUpOgogICAgICAgIGZvciAoayx2KSBpbiBzZWxmLmFyZ3VtZW50X3NwZWMuaXRlbXMoKToKICAgICAgICAgICAgZGVmYXVsdCA9IHYuZ2V0KCdkZWZhdWx0JywgTm9uZSkKICAgICAgICAgICAgaWYgcHJlIGlzIFRydWU6CiAgICAgICAgICAgICAgICAjIHRoaXMgcHJldmVudHMgc2V0dGluZyBkZWZhdWx0cyBvbiByZXF1aXJlZCBpdGVtcwogICAgICAgICAgICAgICAgaWYgZGVmYXVsdCBpcyBub3QgTm9uZSBhbmQgayBub3QgaW4gc2VsZi5wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBkZWZhdWx0CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIG1ha2Ugc3VyZSB0aGluZ3Mgd2l0aG91dCBhIGRlZmF1bHQgc3RpbGwgZ2V0IHNldCBOb25lCiAgICAgICAgICAgICAgICBpZiBrIG5vdCBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhcmFtc1trXSA9IGRlZmF1bHQKCiAgICBkZWYgX3NldF9mYWxsYmFja3Moc2VsZik6CiAgICAgICAgZm9yIGssdiBpbiBzZWxmLmFyZ3VtZW50X3NwZWMuaXRlbXMoKToKICAgICAgICAgICAgZmFsbGJhY2sgPSB2LmdldCgnZmFsbGJhY2snLCAoTm9uZSwpKQogICAgICAgICAgICBmYWxsYmFja19zdHJhdGVneSA9IGZhbGxiYWNrWzBdCiAgICAgICAgICAgIGZhbGxiYWNrX2FyZ3MgPSBbXQogICAgICAgICAgICBmYWxsYmFja19rd2FyZ3MgPSB7fQogICAgICAgICAgICBpZiBrIG5vdCBpbiBzZWxmLnBhcmFtcyBhbmQgZmFsbGJhY2tfc3RyYXRlZ3kgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBmb3IgaXRlbSBpbiBmYWxsYmFja1sxOl06CiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShpdGVtLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tfa3dhcmdzID0gaXRlbQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrX2FyZ3MgPSBpdGVtCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYXJhbXNba10gPSBmYWxsYmFja19zdHJhdGVneSgqZmFsbGJhY2tfYXJncywgKipmYWxsYmFja19rd2FyZ3MpCiAgICAgICAgICAgICAgICBleGNlcHQgQW5zaWJsZUZhbGxiYWNrTm90Rm91bmQ6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICBkZWYgX2xvYWRfcGFyYW1zKHNlbGYpOgogICAgICAgICcnJyByZWFkIHRoZSBpbnB1dCBhbmQgc2V0IHRoZSBwYXJhbXMgYXR0cmlidXRlLgoKICAgICAgICBUaGlzIG1ldGhvZCBpcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuICBUaGUgZ3V0cyBvZiB0aGUgZnVuY3Rpb24KICAgICAgICB3ZXJlIG1vdmVkIG91dCBpbiAyLjEgc28gdGhhdCBjdXN0b20gbW9kdWxlcyBjb3VsZCByZWFkIHRoZSBwYXJhbWV0ZXJzLgogICAgICAgICcnJwogICAgICAgICMgZGVidWcgb3ZlcnJpZGVzIHRvIHJlYWQgYXJncyBmcm9tIGZpbGUgb3IgY21kbGluZQogICAgICAgIHNlbGYucGFyYW1zID0gX2xvYWRfcGFyYW1zKCkKCiAgICBkZWYgX2xvZ190b19zeXNsb2coc2VsZiwgbXNnKToKICAgICAgICBpZiBIQVNfU1lTTE9HOgogICAgICAgICAgICBtb2R1bGUgPSAnYW5zaWJsZS0lcycgJSBzZWxmLl9uYW1lCiAgICAgICAgICAgIGZhY2lsaXR5ID0gZ2V0YXR0cihzeXNsb2csIHNlbGYuX3N5c2xvZ19mYWNpbGl0eSwgc3lzbG9nLkxPR19VU0VSKQogICAgICAgICAgICBzeXNsb2cub3BlbmxvZyhzdHIobW9kdWxlKSwgMCwgZmFjaWxpdHkpCiAgICAgICAgICAgIHN5c2xvZy5zeXNsb2coc3lzbG9nLkxPR19JTkZPLCBtc2cpCgogICAgZGVmIGRlYnVnKHNlbGYsIG1zZyk6CiAgICAgICAgaWYgc2VsZi5fZGVidWc6CiAgICAgICAgICAgIHNlbGYubG9nKCdbZGVidWddICVzJyAlIG1zZykKCiAgICBkZWYgbG9nKHNlbGYsIG1zZywgbG9nX2FyZ3M9Tm9uZSk6CgogICAgICAgIGlmIG5vdCBzZWxmLm5vX2xvZzoKCiAgICAgICAgICAgIGlmIGxvZ19hcmdzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBsb2dfYXJncyA9IGRpY3QoKQoKICAgICAgICAgICAgbW9kdWxlID0gJ2Fuc2libGUtJXMnICUgc2VsZi5fbmFtZQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKG1vZHVsZSwgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICAgICAgbW9kdWxlID0gbW9kdWxlLmRlY29kZSgndXRmLTgnLCAncmVwbGFjZScpCgogICAgICAgICAgICAjIDY2NTUgLSBhbGxvdyBmb3IgYWNjZW50ZWQgY2hhcmFjdGVycwogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShtc2csIChiaW5hcnlfdHlwZSwgdGV4dF90eXBlKSk6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoIm1zZyBzaG91bGQgYmUgYSBzdHJpbmcgKGdvdCAlcykiICUgdHlwZShtc2cpKQoKICAgICAgICAgICAgIyBXZSB3YW50IGpvdXJuYWwgdG8gYWx3YXlzIHRha2UgdGV4dCB0eXBlCiAgICAgICAgICAgICMgc3lzbG9nIHRha2VzIGJ5dGVzIG9uIHB5MiwgdGV4dCB0eXBlIG9uIHB5MwogICAgICAgICAgICBpZiBpc2luc3RhbmNlKG1zZywgYmluYXJ5X3R5cGUpOgogICAgICAgICAgICAgICAgam91cm5hbF9tc2cgPSByZW1vdmVfdmFsdWVzKG1zZy5kZWNvZGUoJ3V0Zi04JywgJ3JlcGxhY2UnKSwgc2VsZi5ub19sb2dfdmFsdWVzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBUT0RPOiBzdXJyb2dhdGVlc2NhcGUgaXMgYSBkYW5nZXIgaGVyZSBvbiBQeTMKICAgICAgICAgICAgICAgIGpvdXJuYWxfbXNnID0gcmVtb3ZlX3ZhbHVlcyhtc2csIHNlbGYubm9fbG9nX3ZhbHVlcykKCiAgICAgICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgICAgIHN5c2xvZ19tc2cgPSBqb3VybmFsX21zZwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc3lzbG9nX21zZyA9IGpvdXJuYWxfbXNnLmVuY29kZSgndXRmLTgnLCAncmVwbGFjZScpCgogICAgICAgICAgICBpZiBoYXNfam91cm5hbDoKICAgICAgICAgICAgICAgIGpvdXJuYWxfYXJncyA9IFsoIk1PRFVMRSIsIG9zLnBhdGguYmFzZW5hbWUoX19maWxlX18pKV0KICAgICAgICAgICAgICAgIGZvciBhcmcgaW4gbG9nX2FyZ3M6CiAgICAgICAgICAgICAgICAgICAgam91cm5hbF9hcmdzLmFwcGVuZCgoYXJnLnVwcGVyKCksIHN0cihsb2dfYXJnc1thcmddKSkpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgam91cm5hbC5zZW5kKHUiJXMgJXMiICUgKG1vZHVsZSwgam91cm5hbF9tc2cpLCAqKmRpY3Qoam91cm5hbF9hcmdzKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBJT0Vycm9yOgogICAgICAgICAgICAgICAgICAgICMgZmFsbCBiYWNrIHRvIHN5c2xvZyBzaW5jZSBsb2dnaW5nIHRvIGpvdXJuYWwgZmFpbGVkCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fbG9nX3RvX3N5c2xvZyhzeXNsb2dfbXNnKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5fbG9nX3RvX3N5c2xvZyhzeXNsb2dfbXNnKQoKICAgIGRlZiBfbG9nX2ludm9jYXRpb24oc2VsZik6CiAgICAgICAgJycnIGxvZyB0aGF0IGFuc2libGUgcmFuIHRoZSBtb2R1bGUgJycnCiAgICAgICAgIyBUT0RPOiBnZW5lcmFsaXplIGEgc2VwYXJhdGUgbG9nIGZ1bmN0aW9uIGFuZCBtYWtlIGxvZ19pbnZvY2F0aW9uIHVzZSBpdAogICAgICAgICMgU2FuaXRpemUgcG9zc2libGUgcGFzc3dvcmQgYXJndW1lbnQgd2hlbiBsb2dnaW5nLgogICAgICAgIGxvZ19hcmdzID0gZGljdCgpCgogICAgICAgIGZvciBwYXJhbSBpbiBzZWxmLnBhcmFtczoKICAgICAgICAgICAgY2Fub24gID0gc2VsZi5hbGlhc2VzLmdldChwYXJhbSwgcGFyYW0pCiAgICAgICAgICAgIGFyZ19vcHRzID0gc2VsZi5hcmd1bWVudF9zcGVjLmdldChjYW5vbiwge30pCiAgICAgICAgICAgIG5vX2xvZyA9IGFyZ19vcHRzLmdldCgnbm9fbG9nJywgRmFsc2UpCgogICAgICAgICAgICBpZiBzZWxmLmJvb2xlYW4obm9fbG9nKToKICAgICAgICAgICAgICAgIGxvZ19hcmdzW3BhcmFtXSA9ICdOT1RfTE9HR0lOR19QQVJBTUVURVInCiAgICAgICAgICAgICMgdHJ5IHRvIGNhcHR1cmUgYWxsIHBhc3N3b3Jkcy9wYXNzcGhyYXNlIG5hbWVkIGZpZWxkcyBtaXNzZWQgYnkgbm9fbG9nCiAgICAgICAgICAgIGVsaWYgUEFTU1dPUkRfTUFUQ0guc2VhcmNoKHBhcmFtKSBhbmQgXAogICAgICAgICAgICAgIGFyZ19vcHRzLmdldCgndHlwZScsICdzdHInKSAhPSAnYm9vbCcgYW5kIFwKICAgICAgICAgICAgICBub3QgYXJnX29wdHMuZ2V0KCdjaG9pY2VzJywgRmFsc2UpOgogICAgICAgICAgICAgICAgIyBza2lwIGJvb2xlYW4gYW5kIGVudW1zIGFzIHRoZXkgYXJlIGFib3V0ICdwYXNzd29yZCcgc3RhdGUKICAgICAgICAgICAgICAgIGxvZ19hcmdzW3BhcmFtXSA9ICdOT1RfTE9HR0lOR19QQVNTV09SRCcKICAgICAgICAgICAgICAgIHNlbGYud2FybignTW9kdWxlIGRpZCBub3Qgc2V0IG5vX2xvZyBmb3IgJXMnICUgcGFyYW0pCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwYXJhbV92YWwgPSBzZWxmLnBhcmFtc1twYXJhbV0KICAgICAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHBhcmFtX3ZhbCwgKHRleHRfdHlwZSwgYmluYXJ5X3R5cGUpKToKICAgICAgICAgICAgICAgICAgICBwYXJhbV92YWwgPSBzdHIocGFyYW1fdmFsKQogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKHBhcmFtX3ZhbCwgdGV4dF90eXBlKToKICAgICAgICAgICAgICAgICAgICBwYXJhbV92YWwgPSBwYXJhbV92YWwuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgICAgICBsb2dfYXJnc1twYXJhbV0gPSBoZXVyaXN0aWNfbG9nX3Nhbml0aXplKHBhcmFtX3ZhbCwgc2VsZi5ub19sb2dfdmFsdWVzKQoKICAgICAgICBtc2cgPSBbJyVzPSVzJyAlICh0b19uYXRpdmUoYXJnKSwgdG9fbmF0aXZlKHZhbCkpIGZvciBhcmcsIHZhbCBpbiBsb2dfYXJncy5pdGVtcygpXQogICAgICAgIGlmIG1zZzoKICAgICAgICAgICAgbXNnID0gJ0ludm9rZWQgd2l0aCAlcycgJSAnICcuam9pbihtc2cpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbXNnID0gJ0ludm9rZWQnCgogICAgICAgIHNlbGYubG9nKG1zZywgbG9nX2FyZ3M9bG9nX2FyZ3MpCgoKICAgIGRlZiBfc2V0X2N3ZChzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN3ZCA9IG9zLmdldGN3ZCgpCiAgICAgICAgICAgIGlmIG5vdCBvcy5hY2Nlc3MoY3dkLCBvcy5GX09LfG9zLlJfT0spOgogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCkKICAgICAgICAgICAgcmV0dXJuIGN3ZAogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgIyB3ZSBkb24ndCBoYXZlIGFjY2VzcyB0byB0aGUgY3dkLCBwcm9iYWJseSBiZWNhdXNlIG9mIHN1ZG8uCiAgICAgICAgICAgICMgVHJ5IGFuZCBtb3ZlIHRvIGEgbmV1dHJhbCBsb2NhdGlvbiB0byBwcmV2ZW50IGVycm9ycwogICAgICAgICAgICBmb3IgY3dkIGluIFtvcy5wYXRoLmV4cGFuZHZhcnMoJyRIT01FJyksIHRlbXBmaWxlLmdldHRlbXBkaXIoKV06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgb3MuYWNjZXNzKGN3ZCwgb3MuRl9PS3xvcy5SX09LKToKICAgICAgICAgICAgICAgICAgICAgICAgb3MuY2hkaXIoY3dkKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3dkCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICMgd2Ugd29uJ3QgZXJyb3IgaGVyZSwgYXMgaXQgbWF5ICpub3QqIGJlIGEgcHJvYmxlbSwKICAgICAgICAjIGFuZCB3ZSBkb24ndCB3YW50IHRvIGJyZWFrIG1vZHVsZXMgdW5uZWNlc3NhcmlseQogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGdldF9iaW5fcGF0aChzZWxmLCBhcmcsIHJlcXVpcmVkPUZhbHNlLCBvcHRfZGlycz1bXSk6CiAgICAgICAgJycnCiAgICAgICAgZmluZCBzeXN0ZW0gZXhlY3V0YWJsZSBpbiBQQVRILgogICAgICAgIE9wdGlvbmFsIGFyZ3VtZW50czoKICAgICAgICAgICAtIHJlcXVpcmVkOiAgaWYgZXhlY3V0YWJsZSBpcyBub3QgZm91bmQgYW5kIHJlcXVpcmVkIGlzIHRydWUsIGZhaWxfanNvbgogICAgICAgICAgIC0gb3B0X2RpcnM6ICBvcHRpb25hbCBsaXN0IG9mIGRpcmVjdG9yaWVzIHRvIHNlYXJjaCBpbiBhZGRpdGlvbiB0byBQQVRICiAgICAgICAgaWYgZm91bmQgcmV0dXJuIGZ1bGwgcGF0aDsgb3RoZXJ3aXNlIHJldHVybiBOb25lCiAgICAgICAgJycnCiAgICAgICAgc2Jpbl9wYXRocyA9IFsnL3NiaW4nLCAnL3Vzci9zYmluJywgJy91c3IvbG9jYWwvc2JpbiddCiAgICAgICAgcGF0aHMgPSBbXQogICAgICAgIGZvciBkIGluIG9wdF9kaXJzOgogICAgICAgICAgICBpZiBkIGlzIG5vdCBOb25lIGFuZCBvcy5wYXRoLmV4aXN0cyhkKToKICAgICAgICAgICAgICAgIHBhdGhzLmFwcGVuZChkKQogICAgICAgIHBhdGhzICs9IG9zLmVudmlyb24uZ2V0KCdQQVRIJywgJycpLnNwbGl0KG9zLnBhdGhzZXApCiAgICAgICAgYmluX3BhdGggPSBOb25lCiAgICAgICAgIyBtYW5nbGUgUEFUSCB0byBpbmNsdWRlIC9zYmluIGRpcnMKICAgICAgICBmb3IgcCBpbiBzYmluX3BhdGhzOgogICAgICAgICAgICBpZiBwIG5vdCBpbiBwYXRocyBhbmQgb3MucGF0aC5leGlzdHMocCk6CiAgICAgICAgICAgICAgICBwYXRocy5hcHBlbmQocCkKICAgICAgICBmb3IgZCBpbiBwYXRoczoKICAgICAgICAgICAgaWYgbm90IGQ6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBwYXRoID0gb3MucGF0aC5qb2luKGQsIGFyZykKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocGF0aCkgYW5kIG5vdCBvcy5wYXRoLmlzZGlyKHBhdGgpIGFuZCBpc19leGVjdXRhYmxlKHBhdGgpOgogICAgICAgICAgICAgICAgYmluX3BhdGggPSBwYXRoCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGlmIHJlcXVpcmVkIGFuZCBiaW5fcGF0aCBpcyBOb25lOgogICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0ZhaWxlZCB0byBmaW5kIHJlcXVpcmVkIGV4ZWN1dGFibGUgJXMgaW4gcGF0aHM6ICVzJyAlIChhcmcsIG9zLnBhdGhzZXAuam9pbihwYXRocykpKQogICAgICAgIHJldHVybiBiaW5fcGF0aAoKICAgIGRlZiBib29sZWFuKHNlbGYsIGFyZyk6CiAgICAgICAgJycnIHJldHVybiBhIGJvb2wgZm9yIHRoZSBhcmcgJycnCiAgICAgICAgaWYgYXJnIGlzIE5vbmUgb3IgaXNpbnN0YW5jZShhcmcsIGJvb2wpOgogICAgICAgICAgICByZXR1cm4gYXJnCiAgICAgICAgaWYgaXNpbnN0YW5jZShhcmcsIHN0cmluZ190eXBlcyk6CiAgICAgICAgICAgIGFyZyA9IGFyZy5sb3dlcigpCiAgICAgICAgaWYgYXJnIGluIEJPT0xFQU5TX1RSVUU6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxpZiBhcmcgaW4gQk9PTEVBTlNfRkFMU0U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nJXMgaXMgbm90IGEgdmFsaWQgYm9vbGVhbi4gVmFsaWQgYm9vbGVhbnMgaW5jbHVkZTogJXMnICUgKHRvX3RleHQoYXJnKSwgJywnLmpvaW4oWyclcycgJSB4IGZvciB4IGluIEJPT0xFQU5TXSkpKQoKICAgIGRlZiBqc29uaWZ5KHNlbGYsIGRhdGEpOgogICAgICAgIGZvciBlbmNvZGluZyBpbiAoInV0Zi04IiwgImxhdGluLTEiKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24uZHVtcHMoZGF0YSwgZW5jb2Rpbmc9ZW5jb2RpbmcpCiAgICAgICAgICAgICMgT2xkIHN5c3RlbXMgdXNpbmcgb2xkIHNpbXBsZWpzb24gbW9kdWxlIGRvZXMgbm90IHN1cHBvcnQgZW5jb2Rpbmcga2V5d29yZC4KICAgICAgICAgICAgZXhjZXB0IFR5cGVFcnJvcjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBuZXdfZGF0YSA9IGpzb25fZGljdF9ieXRlc190b191bmljb2RlKGRhdGEsIGVuY29kaW5nPWVuY29kaW5nKQogICAgICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVEZWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24uZHVtcHMobmV3X2RhdGEpCiAgICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRGVjb2RlRXJyb3I6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0nSW52YWxpZCB1bmljb2RlIGVuY29kaW5nIGVuY291bnRlcmVkJykKCiAgICBkZWYgZnJvbV9qc29uKHNlbGYsIGRhdGEpOgogICAgICAgIHJldHVybiBqc29uLmxvYWRzKGRhdGEpCgogICAgZGVmIGFkZF9jbGVhbnVwX2ZpbGUoc2VsZiwgcGF0aCk6CiAgICAgICAgaWYgcGF0aCBub3QgaW4gc2VsZi5jbGVhbnVwX2ZpbGVzOgogICAgICAgICAgICBzZWxmLmNsZWFudXBfZmlsZXMuYXBwZW5kKHBhdGgpCgogICAgZGVmIGRvX2NsZWFudXBfZmlsZXMoc2VsZik6CiAgICAgICAgZm9yIHBhdGggaW4gc2VsZi5jbGVhbnVwX2ZpbGVzOgogICAgICAgICAgICBzZWxmLmNsZWFudXAocGF0aCkKCiAgICBkZWYgX3JldHVybl9mb3JtYXR0ZWQoc2VsZiwga3dhcmdzKToKCiAgICAgICAgc2VsZi5hZGRfcGF0aF9pbmZvKGt3YXJncykKCiAgICAgICAgaWYgJ2ludm9jYXRpb24nIG5vdCBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGt3YXJnc1snaW52b2NhdGlvbiddID0geydtb2R1bGVfYXJncyc6IHNlbGYucGFyYW1zfQoKICAgICAgICBpZiAnd2FybmluZ3MnIGluIGt3YXJnczoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShrd2FyZ3NbJ3dhcm5pbmdzJ10sIGxpc3QpOgogICAgICAgICAgICAgICAgZm9yIHcgaW4ga3dhcmdzWyd3YXJuaW5ncyddOgogICAgICAgICAgICAgICAgICAgIHNlbGYud2Fybih3KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi53YXJuKGt3YXJnc1snd2FybmluZ3MnXSkKCiAgICAgICAgaWYgc2VsZi5fd2FybmluZ3M6CiAgICAgICAgICAgIGt3YXJnc1snd2FybmluZ3MnXSA9IHNlbGYuX3dhcm5pbmdzCgogICAgICAgIGlmICdkZXByZWNhdGlvbnMnIGluIGt3YXJnczoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddLCBsaXN0KToKICAgICAgICAgICAgICAgIGZvciBkIGluIGt3YXJnc1snZGVwcmVjYXRpb25zJ106CiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkLCBTRVFVRU5DRVRZUEUpIGFuZCBsZW4oZCkgPT0gMjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kZXByZWNhdGUoZFswXSwgdmVyc2lvbj1kWzFdKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGVwcmVjYXRlKGQpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmRlcHJlY2F0ZShrd2FyZ3NbJ2RlcHJlY2F0aW9ucyddKQoKICAgICAgICBpZiBzZWxmLl9kZXByZWNhdGlvbnM6CiAgICAgICAgICAgIGt3YXJnc1snZGVwcmVjYXRpb25zJ10gPSBzZWxmLl9kZXByZWNhdGlvbnMKCiAgICAgICAga3dhcmdzID0gcmVtb3ZlX3ZhbHVlcyhrd2FyZ3MsIHNlbGYubm9fbG9nX3ZhbHVlcykKICAgICAgICBwcmludCgnXG4lcycgJSBzZWxmLmpzb25pZnkoa3dhcmdzKSkKCiAgICBkZWYgZXhpdF9qc29uKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAnJycgcmV0dXJuIGZyb20gdGhlIG1vZHVsZSwgd2l0aG91dCBlcnJvciAnJycKCiAgICAgICAgaWYgbm90ICdjaGFuZ2VkJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGt3YXJnc1snY2hhbmdlZCddID0gRmFsc2UKCiAgICAgICAgc2VsZi5kb19jbGVhbnVwX2ZpbGVzKCkKICAgICAgICBzZWxmLl9yZXR1cm5fZm9ybWF0dGVkKGt3YXJncykKICAgICAgICBzeXMuZXhpdCgwKQoKICAgIGRlZiBmYWlsX2pzb24oc2VsZiwgKiprd2FyZ3MpOgogICAgICAgICcnJyByZXR1cm4gZnJvbSB0aGUgbW9kdWxlLCB3aXRoIGFuIGVycm9yIG1lc3NhZ2UgJycnCgogICAgICAgIGFzc2VydCAnbXNnJyBpbiBrd2FyZ3MsICJpbXBsZW1lbnRhdGlvbiBlcnJvciAtLSBtc2cgdG8gZXhwbGFpbiB0aGUgZXJyb3IgaXMgcmVxdWlyZWQiCiAgICAgICAga3dhcmdzWydmYWlsZWQnXSA9IFRydWUKCiAgICAgICAgaWYgbm90ICdjaGFuZ2VkJyBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGt3YXJnc1snY2hhbmdlZCddID0gRmFsc2UKCiAgICAgICAgc2VsZi5kb19jbGVhbnVwX2ZpbGVzKCkKICAgICAgICBzZWxmLl9yZXR1cm5fZm9ybWF0dGVkKGt3YXJncykKICAgICAgICBzeXMuZXhpdCgxKQoKICAgIGRlZiBmYWlsX29uX21pc3NpbmdfcGFyYW1zKHNlbGYsIHJlcXVpcmVkX3BhcmFtcz1Ob25lKToKICAgICAgICAnJycgVGhpcyBpcyBmb3IgY2hlY2tpbmcgZm9yIHJlcXVpcmVkIHBhcmFtcyB3aGVuIHdlIGNhbiBub3QgY2hlY2sgdmlhIGFyZ3NwZWMgYmVjYXVzZSB3ZQogICAgICAgIG5lZWQgbW9yZSBpbmZvcm1hdGlvbiB0aGFuIGlzIHNpbXBseSBnaXZlbiBpbiB0aGUgYXJnc3BlYy4KICAgICAgICAnJycKICAgICAgICBpZiBub3QgcmVxdWlyZWRfcGFyYW1zOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBtaXNzaW5nX3BhcmFtcyA9IFtdCiAgICAgICAgZm9yIHJlcXVpcmVkX3BhcmFtIGluIHJlcXVpcmVkX3BhcmFtczoKICAgICAgICAgICAgaWYgbm90IHNlbGYucGFyYW1zLmdldChyZXF1aXJlZF9wYXJhbSk6CiAgICAgICAgICAgICAgICBtaXNzaW5nX3BhcmFtcy5hcHBlbmQocmVxdWlyZWRfcGFyYW0pCiAgICAgICAgaWYgbWlzc2luZ19wYXJhbXM6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0ibWlzc2luZyByZXF1aXJlZCBhcmd1bWVudHM6ICVzIiAlICcsJy5qb2luKG1pc3NpbmdfcGFyYW1zKSkKCiAgICBkZWYgZGlnZXN0X2Zyb21fZmlsZShzZWxmLCBmaWxlbmFtZSwgYWxnb3JpdGhtKToKICAgICAgICAnJycgUmV0dXJuIGhleCBkaWdlc3Qgb2YgbG9jYWwgZmlsZSBmb3IgYSBkaWdlc3RfbWV0aG9kIHNwZWNpZmllZCBieSBuYW1lLCBvciBOb25lIGlmIGZpbGUgaXMgbm90IHByZXNlbnQuICcnJwogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlbmFtZSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgaWYgb3MucGF0aC5pc2RpcihmaWxlbmFtZSk6CiAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKG1zZz0iYXR0ZW1wdGVkIHRvIHRha2UgY2hlY2tzdW0gb2YgZGlyZWN0b3J5OiAlcyIgJSBmaWxlbmFtZSkKCiAgICAgICAgIyBwcmVzZXJ2ZSBvbGQgYmVoYXZpb3VyIHdoZXJlIHRoZSB0aGlyZCBwYXJhbWV0ZXIgd2FzIGEgaGFzaCBhbGdvcml0aG0gb2JqZWN0CiAgICAgICAgaWYgaGFzYXR0cihhbGdvcml0aG0sICdoZXhkaWdlc3QnKToKICAgICAgICAgICAgZGlnZXN0X21ldGhvZCA9IGFsZ29yaXRobQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRpZ2VzdF9tZXRob2QgPSBBVkFJTEFCTEVfSEFTSF9BTEdPUklUSE1TW2FsZ29yaXRobV0oKQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9IkNvdWxkIG5vdCBoYXNoIGZpbGUgJyVzJyB3aXRoIGFsZ29yaXRobSAnJXMnLiBBdmFpbGFibGUgYWxnb3JpdGhtczogJXMiICUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZmlsZW5hbWUsIGFsZ29yaXRobSwgJywgJy5qb2luKEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVMpKSkKCiAgICAgICAgYmxvY2tzaXplID0gNjQgKiAxMDI0CiAgICAgICAgaW5maWxlID0gb3Blbihvcy5wYXRoLnJlYWxwYXRoKGZpbGVuYW1lKSwgJ3JiJykKICAgICAgICBibG9jayA9IGluZmlsZS5yZWFkKGJsb2Nrc2l6ZSkKICAgICAgICB3aGlsZSBibG9jazoKICAgICAgICAgICAgZGlnZXN0X21ldGhvZC51cGRhdGUoYmxvY2spCiAgICAgICAgICAgIGJsb2NrID0gaW5maWxlLnJlYWQoYmxvY2tzaXplKQogICAgICAgIGluZmlsZS5jbG9zZSgpCiAgICAgICAgcmV0dXJuIGRpZ2VzdF9tZXRob2QuaGV4ZGlnZXN0KCkKCiAgICBkZWYgbWQ1KHNlbGYsIGZpbGVuYW1lKToKICAgICAgICAnJycgUmV0dXJuIE1ENSBoZXggZGlnZXN0IG9mIGxvY2FsIGZpbGUgdXNpbmcgZGlnZXN0X2Zyb21fZmlsZSgpLgoKICAgICAgICBEbyBub3QgdXNlIHRoaXMgZnVuY3Rpb24gdW5sZXNzIHlvdSBoYXZlIG5vIG90aGVyIGNob2ljZSBmb3I6CiAgICAgICAgICAgIDEpIE9wdGlvbmFsIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CiAgICAgICAgICAgIDIpIENvbXBhdGliaWxpdHkgd2l0aCBhIHRoaXJkIHBhcnR5IHByb3RvY29sCgogICAgICAgIFRoaXMgZnVuY3Rpb24gd2lsbCBub3Qgd29yayBvbiBzeXN0ZW1zIGNvbXBseWluZyB3aXRoIEZJUFMtMTQwLTIuCgogICAgICAgIE1vc3QgdXNlcyBvZiB0aGlzIGZ1bmN0aW9uIGNhbiB1c2UgdGhlIG1vZHVsZS5zaGExIGZ1bmN0aW9uIGluc3RlYWQuCiAgICAgICAgJycnCiAgICAgICAgaWYgJ21kNScgbm90IGluIEFWQUlMQUJMRV9IQVNIX0FMR09SSVRITVM6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ01ENSBub3QgYXZhaWxhYmxlLiAgUG9zc2libHkgcnVubmluZyBpbiBGSVBTIG1vZGUnKQogICAgICAgIHJldHVybiBzZWxmLmRpZ2VzdF9mcm9tX2ZpbGUoZmlsZW5hbWUsICdtZDUnKQoKICAgIGRlZiBzaGExKHNlbGYsIGZpbGVuYW1lKToKICAgICAgICAnJycgUmV0dXJuIFNIQTEgaGV4IGRpZ2VzdCBvZiBsb2NhbCBmaWxlIHVzaW5nIGRpZ2VzdF9mcm9tX2ZpbGUoKS4gJycnCiAgICAgICAgcmV0dXJuIHNlbGYuZGlnZXN0X2Zyb21fZmlsZShmaWxlbmFtZSwgJ3NoYTEnKQoKICAgIGRlZiBzaGEyNTYoc2VsZiwgZmlsZW5hbWUpOgogICAgICAgICcnJyBSZXR1cm4gU0hBLTI1NiBoZXggZGlnZXN0IG9mIGxvY2FsIGZpbGUgdXNpbmcgZGlnZXN0X2Zyb21fZmlsZSgpLiAnJycKICAgICAgICByZXR1cm4gc2VsZi5kaWdlc3RfZnJvbV9maWxlKGZpbGVuYW1lLCAnc2hhMjU2JykKCiAgICBkZWYgYmFja3VwX2xvY2FsKHNlbGYsIGZuKToKICAgICAgICAnJydtYWtlIGEgZGF0ZS1tYXJrZWQgYmFja3VwIG9mIHRoZSBzcGVjaWZpZWQgZmlsZSwgcmV0dXJuIFRydWUgb3IgRmFsc2Ugb24gc3VjY2VzcyBvciBmYWlsdXJlJycnCgogICAgICAgIGJhY2t1cGRlc3QgPSAnJwogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGZuKToKICAgICAgICAgICAgIyBiYWNrdXBzIG5hbWVkIGJhc2VuYW1lLlBJRC5ZWVlZLU1NLUREQEhIOk1NOlNTfgogICAgICAgICAgICBleHQgPSB0aW1lLnN0cmZ0aW1lKCIlWS0lbS0lZEAlSDolTTolU34iLCB0aW1lLmxvY2FsdGltZSh0aW1lLnRpbWUoKSkpCiAgICAgICAgICAgIGJhY2t1cGRlc3QgPSAnJXMuJXMuJXMnICUgKGZuLCBvcy5nZXRwaWQoKSwgZXh0KQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHkyKGZuLCBiYWNrdXBkZXN0KQogICAgICAgICAgICBleGNlcHQgKHNodXRpbC5FcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0NvdWxkIG5vdCBtYWtlIGJhY2t1cCBvZiAlcyB0byAlczogJXMnICUgKGZuLCBiYWNrdXBkZXN0LCBlKSkKCiAgICAgICAgcmV0dXJuIGJhY2t1cGRlc3QKCiAgICBkZWYgY2xlYW51cChzZWxmLCB0bXBmaWxlKToKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh0bXBmaWxlKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MudW5saW5rKHRtcGZpbGUpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgc3lzLnN0ZGVyci53cml0ZSgiY291bGQgbm90IGNsZWFudXAgJXM6ICVzIiAlICh0bXBmaWxlLCBlKSkKCiAgICBkZWYgYXRvbWljX21vdmUoc2VsZiwgc3JjLCBkZXN0LCB1bnNhZmVfd3JpdGVzPUZhbHNlKToKICAgICAgICAnJydhdG9taWNhbGx5IG1vdmUgc3JjIHRvIGRlc3QsIGNvcHlpbmcgYXR0cmlidXRlcyBmcm9tIGRlc3QsIHJldHVybnMgdHJ1ZSBvbiBzdWNjZXNzCiAgICAgICAgaXQgdXNlcyBvcy5yZW5hbWUgdG8gZW5zdXJlIHRoaXMgYXMgaXQgaXMgYW4gYXRvbWljIG9wZXJhdGlvbiwgcmVzdCBvZiB0aGUgZnVuY3Rpb24gaXMKICAgICAgICB0byB3b3JrIGFyb3VuZCBsaW1pdGF0aW9ucywgY29ybmVyIGNhc2VzIGFuZCBlbnN1cmUgc2VsaW51eCBjb250ZXh0IGlzIHNhdmVkIGlmIHBvc3NpYmxlJycnCiAgICAgICAgY29udGV4dCA9IE5vbmUKICAgICAgICBkZXN0X3N0YXQgPSBOb25lCiAgICAgICAgYl9zcmMgPSB0b19ieXRlcyhzcmMsIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgYl9kZXN0ID0gdG9fYnl0ZXMoZGVzdCwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhiX2Rlc3QpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZXN0X3N0YXQgPSBvcy5zdGF0KGJfZGVzdCkKCiAgICAgICAgICAgICAgICAjIGNvcHkgbW9kZSBhbmQgb3duZXJzaGlwCiAgICAgICAgICAgICAgICBvcy5jaG1vZChiX3NyYywgZGVzdF9zdGF0LnN0X21vZGUgJiBQRVJNX0JJVFMpCiAgICAgICAgICAgICAgICBvcy5jaG93bihiX3NyYywgZGVzdF9zdGF0LnN0X3VpZCwgZGVzdF9zdGF0LnN0X2dpZCkKCiAgICAgICAgICAgICAgICAjIHRyeSB0byBjb3B5IGZsYWdzIGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKG9zLCAnY2hmbGFncycpIGFuZCBoYXNhdHRyKGRlc3Rfc3RhdCwgJ3N0X2ZsYWdzJyk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBvcy5jaGZsYWdzKGJfc3JjLCBkZXN0X3N0YXQuc3RfZmxhZ3MpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGVyciBpbiAnRU9QTk9UU1VQUCcsICdFTk9UU1VQJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoZXJybm8sIGVycikgYW5kIGUuZXJybm8gPT0gZ2V0YXR0cihlcnJubywgZXJyKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICBpZiBlLmVycm5vICE9IGVycm5vLkVQRVJNOgogICAgICAgICAgICAgICAgICAgIHJhaXNlCiAgICAgICAgICAgIGlmIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gc2VsZi5zZWxpbnV4X2NvbnRleHQoZGVzdCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAgICAgY29udGV4dCA9IHNlbGYuc2VsaW51eF9kZWZhdWx0X2NvbnRleHQoZGVzdCkKCiAgICAgICAgY3JlYXRpbmcgPSBub3Qgb3MucGF0aC5leGlzdHMoYl9kZXN0KQoKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgT3B0aW1pc3RpY2FsbHkgdHJ5IGEgcmVuYW1lLCBzb2x2ZXMgc29tZSBjb3JuZXIgY2FzZXMgYW5kIGNhbiBhdm9pZCB1c2VsZXNzIHdvcmssIHRocm93cyBleGNlcHRpb24gaWYgbm90IGF0b21pYy4KICAgICAgICAgICAgb3MucmVuYW1lKGJfc3JjLCBiX2Rlc3QpCiAgICAgICAgZXhjZXB0IChJT0Vycm9yLCBPU0Vycm9yKToKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBpZiBlLmVycm5vIG5vdCBpbiBbZXJybm8uRVBFUk0sIGVycm5vLkVYREVWLCBlcnJuby5FQUNDRVMsIGVycm5vLkVUWFRCU1ksIGVycm5vLkVCVVNZXToKICAgICAgICAgICAgICAgICMgb25seSB0cnkgd29ya2Fyb3VuZHMgZm9yIGVycm5vIDE4IChjcm9zcyBkZXZpY2UpLCAxIChub3QgcGVybWl0dGVkKSwgIDEzIChwZXJtaXNzaW9uIGRlbmllZCkKICAgICAgICAgICAgICAgICMgYW5kIDI2ICh0ZXh0IGZpbGUgYnVzeSkgd2hpY2ggaGFwcGVucyBvbiB2YWdyYW50IHN5bmNlZCBmb2xkZXJzIGFuZCBvdGhlciAnZXhvdGljJyBub24gcG9zaXggZmlsZSBzeXN0ZW1zCiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J0NvdWxkIG5vdCByZXBsYWNlIGZpbGU6ICVzIHRvICVzOiAlcycgJSAoc3JjLCBkZXN0LCBlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBiX2Rlc3RfZGlyID0gb3MucGF0aC5kaXJuYW1lKGJfZGVzdCkKICAgICAgICAgICAgICAgICMgVXNlIGJ5dGVzIGhlcmUuICBJbiB0aGUgc2hpcHBhYmxlIENJLCB0aGlzIGZhaWxzIHdpdGgKICAgICAgICAgICAgICAgICMgYSBVbmljb2RlRXJyb3Igd2l0aCBzdXJyb2dhdGVlc2NhcGUnZCBzdHJpbmdzIGZvciBhbiB1bmtub3duCiAgICAgICAgICAgICAgICAjIHJlYXNvbiAoZG9lc24ndCBoYXBwZW4gaW4gYSBsb2NhbCBVYnVudHUxNi4wNCBWTSkKICAgICAgICAgICAgICAgIG5hdGl2ZV9kZXN0X2RpciA9IGJfZGVzdF9kaXIKICAgICAgICAgICAgICAgIG5hdGl2ZV9zdWZmaXggPSBvcy5wYXRoLmJhc2VuYW1lKGJfZGVzdCkKICAgICAgICAgICAgICAgIG5hdGl2ZV9wcmVmaXggPSBiKCcuYW5zaWJsZV90bXAnKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHRtcF9kZXN0X2ZkLCB0bXBfZGVzdF9uYW1lID0gdGVtcGZpbGUubWtzdGVtcCggcHJlZml4PW5hdGl2ZV9wcmVmaXgsIGRpcj1uYXRpdmVfZGVzdF9kaXIsIHN1ZmZpeD1uYXRpdmVfc3VmZml4KQogICAgICAgICAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdUaGUgZGVzdGluYXRpb24gZGlyZWN0b3J5ICglcykgaXMgbm90IHdyaXRhYmxlIGJ5IHRoZSBjdXJyZW50IHVzZXIuIEVycm9yIHdhczogJXMnICUgKG9zLnBhdGguZGlybmFtZShkZXN0KSwgZSkpCiAgICAgICAgICAgICAgICBleGNlcHQgVHlwZUVycm9yOgogICAgICAgICAgICAgICAgICAgICMgV2UgZXhwZWN0IHRoYXQgdGhpcyBpcyBoYXBwZW5pbmcgYmVjYXVzZSBweXRob24zLjQueCBhbmQKICAgICAgICAgICAgICAgICAgICAjIGJlbG93IGNhbid0IGhhbmRsZSBieXRlIHN0cmluZ3MgaW4gbWtzdGVtcCgpLiAgVHJhY2ViYWNrCiAgICAgICAgICAgICAgICAgICAgIyB3b3VsZCBlbmQgaW4gc29tZXRoaW5nIGxpa2U6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgZmlsZSA9IF9vcy5wYXRoLmpvaW4oZGlyLCBwcmUgKyBuYW1lICsgc3VmKQogICAgICAgICAgICAgICAgICAgICMgVHlwZUVycm9yOiBjYW4ndCBjb25jYXQgYnl0ZXMgdG8gc3RyCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdGYWlsZWQgY3JlYXRpbmcgdGVtcCBmaWxlIGZvciBhdG9taWMgbW92ZS4gIFRoaXMgdXN1YWxseSBoYXBwZW5zIHdoZW4gdXNpbmcgUHl0aG9uMyBsZXNzIHRoYW4gUHl0aG9uMy41LiAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdQbGVhc2UgdXNlIFB5dGhvbjIueCBvciBQeXRob24zLjUgb3IgZ3JlYXRlci4nLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKCiAgICAgICAgICAgICAgICBiX3RtcF9kZXN0X25hbWUgPSB0b19ieXRlcyh0bXBfZGVzdF9uYW1lLCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgY2xvc2UgdG1wIGZpbGUgaGFuZGxlIGJlZm9yZSBmaWxlIG9wZXJhdGlvbnMgdG8gcHJldmVudCB0ZXh0IGZpbGUgYnVzeSBlcnJvcnMgb24gdmJveGZzIHN5bmNlZCBmb2xkZXJzICh3aW5kb3dzIGhvc3QpCiAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNsb3NlKHRtcF9kZXN0X2ZkKQogICAgICAgICAgICAgICAgICAgICAgICAjIGxlYXZlcyB0bXAgZmlsZSBiZWhpbmQgd2hlbiBzdWRvIGFuZCBub3Qgcm9vdAogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaHV0aWwubW92ZShiX3NyYywgYl90bXBfZGVzdF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgY2xlYW51cCB3aWxsIGhhcHBlbiBieSAncm0nIG9mIHRlbXBkaXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgY29weTIgd2lsbCBwcmVzZXJ2ZSBzb21lIG1ldGFkYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaHV0aWwuY29weTIoYl9zcmMsIGJfdG1wX2Rlc3RfbmFtZSkKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuc2VsaW51eF9lbmFibGVkKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiX3RtcF9kZXN0X25hbWUsIGNvbnRleHQsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBfc3RhdCA9IG9zLnN0YXQoYl90bXBfZGVzdF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZGVzdF9zdGF0IGFuZCAodG1wX3N0YXQuc3RfdWlkICE9IGRlc3Rfc3RhdC5zdF91aWQgb3IgdG1wX3N0YXQuc3RfZ2lkICE9IGRlc3Rfc3RhdC5zdF9naWQpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLmNob3duKGJfdG1wX2Rlc3RfbmFtZSwgZGVzdF9zdGF0LnN0X3VpZCwgZGVzdF9zdGF0LnN0X2dpZCkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBlLmVycm5vICE9IGVycm5vLkVQRVJNOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLnJlbmFtZShiX3RtcF9kZXN0X25hbWUsIGJfZGVzdCkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IChzaHV0aWwuRXJyb3IsIE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdW5zYWZlX3dyaXRlcyBhbmQgZS5lcnJubyA9PSBlcnJuby5FQlVTWToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91bnNhZmVfd3JpdGVzKGJfdG1wX2Rlc3RfbmFtZSwgYl9kZXN0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9J1VuYWJsZSB0byByZW5hbWUgZmlsZTogJXMgdG8gJXM6ICVzJyAlIChzcmMsIGRlc3QsIGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgKHNodXRpbC5FcnJvciwgT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdGYWlsZWQgdG8gcmVwbGFjZSBmaWxlOiAlcyB0byAlczogJXMnICUgKHNyYywgZGVzdCwgZSksIGV4Y2VwdGlvbj10cmFjZWJhY2suZm9ybWF0X2V4YygpKQogICAgICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgICAgICBzZWxmLmNsZWFudXAoYl90bXBfZGVzdF9uYW1lKQoKICAgICAgICBpZiBjcmVhdGluZzoKICAgICAgICAgICAgIyBtYWtlIHN1cmUgdGhlIGZpbGUgaGFzIHRoZSBjb3JyZWN0IHBlcm1pc3Npb25zCiAgICAgICAgICAgICMgYmFzZWQgb24gdGhlIGN1cnJlbnQgdmFsdWUgb2YgdW1hc2sKICAgICAgICAgICAgdW1hc2sgPSBvcy51bWFzaygwKQogICAgICAgICAgICBvcy51bWFzayh1bWFzaykKICAgICAgICAgICAgb3MuY2htb2QoYl9kZXN0LCBERUZBVUxUX1BFUk0gJiB+dW1hc2spCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLmNob3duKGJfZGVzdCwgb3MuZ2V0ZXVpZCgpLCBvcy5nZXRlZ2lkKCkpCiAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgIyBXZSdyZSBva2F5IHdpdGggdHJ5aW5nIG91ciBiZXN0IGhlcmUuICBJZiB0aGUgdXNlciBpcyBub3QKICAgICAgICAgICAgICAgICMgcm9vdCAob3Igb2xkIFVuaWNlcykgdGhleSB3b24ndCBiZSBhYmxlIHRvIGNob3duLgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICBpZiBzZWxmLnNlbGludXhfZW5hYmxlZCgpOgogICAgICAgICAgICAjIHJlbmFtZSBtaWdodCBub3QgcHJlc2VydmUgY29udGV4dAogICAgICAgICAgICBzZWxmLnNldF9jb250ZXh0X2lmX2RpZmZlcmVudChkZXN0LCBjb250ZXh0LCBGYWxzZSkKCiAgICBkZWYgX3Vuc2FmZV93cml0ZXMoc2VsZiwgc3JjLCBkZXN0KToKICAgICAgICAjIHNhZGx5IHRoZXJlIGFyZSBzb21lIHNpdHVhdGlvbnMgd2hlcmUgd2UgY2Fubm90IGVuc3VyZSBhdG9taWNpdHksIGJ1dCBvbmx5IGlmCiAgICAgICAgIyB0aGUgdXNlciBpbnNpc3RzIGFuZCB3ZSBnZXQgdGhlIGFwcHJvcHJpYXRlIGVycm9yIHdlIHVwZGF0ZSB0aGUgZmlsZSB1bnNhZmVseQogICAgICAgIHRyeToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3V0X2Rlc3QgPSBvcGVuKGRlc3QsICd3YicpCiAgICAgICAgICAgICAgICBpbl9zcmMgPSBvcGVuKHNyYywgJ3JiJykKICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5ZmlsZW9iaihpbl9zcmMsIG91dF9kZXN0KQogICAgICAgICAgICBmaW5hbGx5OiAgIyBhc3N1cmluZyBjbG9zZWQgZmlsZXMgaW4gMi40IGNvbXBhdGlibGUgd2F5CiAgICAgICAgICAgICAgICBpZiBvdXRfZGVzdDoKICAgICAgICAgICAgICAgICAgICBvdXRfZGVzdC5jbG9zZSgpCiAgICAgICAgICAgICAgICBpZiBpbl9zcmM6CiAgICAgICAgICAgICAgICAgICAgaW5fc3JjLmNsb3NlKCkKICAgICAgICBleGNlcHQgKHNodXRpbC5FcnJvciwgT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24obXNnPSdDb3VsZCBub3Qgd3JpdGUgZGF0YSB0byBmaWxlICglcykgZnJvbSAoJXMpOiAlcycgJSAoZGVzdCwgc3JjLCBlKSwgZXhjZXB0aW9uPXRyYWNlYmFjay5mb3JtYXRfZXhjKCkpCgoKICAgIGRlZiBfcmVhZF9mcm9tX3BpcGVzKHNlbGYsIHJwaXBlcywgcmZkcywgZmlsZV9kZXNjcmlwdG9yKToKICAgICAgICBkYXRhID0gYignJykKICAgICAgICBpZiBmaWxlX2Rlc2NyaXB0b3IgaW4gcmZkczoKICAgICAgICAgICAgZGF0YSA9IG9zLnJlYWQoZmlsZV9kZXNjcmlwdG9yLmZpbGVubygpLCA5MDAwKQogICAgICAgICAgICBpZiBkYXRhID09IGIoJycpOgogICAgICAgICAgICAgICAgcnBpcGVzLnJlbW92ZShmaWxlX2Rlc2NyaXB0b3IpCgogICAgICAgIHJldHVybiBkYXRhCgogICAgZGVmIHJ1bl9jb21tYW5kKHNlbGYsIGFyZ3MsIGNoZWNrX3JjPUZhbHNlLCBjbG9zZV9mZHM9VHJ1ZSwgZXhlY3V0YWJsZT1Ob25lLCBkYXRhPU5vbmUsIGJpbmFyeV9kYXRhPUZhbHNlLCBwYXRoX3ByZWZpeD1Ob25lLCBjd2Q9Tm9uZSwKICAgICAgICAgICAgICAgICAgICB1c2VfdW5zYWZlX3NoZWxsPUZhbHNlLCBwcm9tcHRfcmVnZXg9Tm9uZSwgZW52aXJvbl91cGRhdGU9Tm9uZSwgdW1hc2s9Tm9uZSwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0Jyk6CiAgICAgICAgJycnCiAgICAgICAgRXhlY3V0ZSBhIGNvbW1hbmQsIHJldHVybnMgcmMsIHN0ZG91dCwgYW5kIHN0ZGVyci4KCiAgICAgICAgOmFyZyBhcmdzOiBpcyB0aGUgY29tbWFuZCB0byBydW4KICAgICAgICAgICAgKiBJZiBhcmdzIGlzIGEgbGlzdCwgdGhlIGNvbW1hbmQgd2lsbCBiZSBydW4gd2l0aCBzaGVsbD1GYWxzZS4KICAgICAgICAgICAgKiBJZiBhcmdzIGlzIGEgc3RyaW5nIGFuZCB1c2VfdW5zYWZlX3NoZWxsPUZhbHNlIGl0IHdpbGwgc3BsaXQgYXJncyB0byBhIGxpc3QgYW5kIHJ1biB3aXRoIHNoZWxsPUZhbHNlCiAgICAgICAgICAgICogSWYgYXJncyBpcyBhIHN0cmluZyBhbmQgdXNlX3Vuc2FmZV9zaGVsbD1UcnVlIGl0IHJ1bnMgd2l0aCBzaGVsbD1UcnVlLgogICAgICAgIDprdyBjaGVja19yYzogV2hldGhlciB0byBjYWxsIGZhaWxfanNvbiBpbiBjYXNlIG9mIG5vbiB6ZXJvIFJDLgogICAgICAgICAgICBEZWZhdWx0IEZhbHNlCiAgICAgICAgOmt3IGNsb3NlX2ZkczogU2VlIGRvY3VtZW50YXRpb24gZm9yIHN1YnByb2Nlc3MuUG9wZW4oKS4gRGVmYXVsdCBUcnVlCiAgICAgICAgOmt3IGV4ZWN1dGFibGU6IFNlZSBkb2N1bWVudGF0aW9uIGZvciBzdWJwcm9jZXNzLlBvcGVuKCkuIERlZmF1bHQgTm9uZQogICAgICAgIDprdyBkYXRhOiBJZiBnaXZlbiwgaW5mb3JtYXRpb24gdG8gd3JpdGUgdG8gdGhlIHN0ZGluIG9mIHRoZSBjb21tYW5kCiAgICAgICAgOmt3IGJpbmFyeV9kYXRhOiBJZiBGYWxzZSwgYXBwZW5kIGEgbmV3bGluZSB0byB0aGUgZGF0YS4gIERlZmF1bHQgRmFsc2UKICAgICAgICA6a3cgcGF0aF9wcmVmaXg6IElmIGdpdmVuLCBhZGRpdGlvbmFsIHBhdGggdG8gZmluZCB0aGUgY29tbWFuZCBpbi4KICAgICAgICAgICAgVGhpcyBhZGRzIHRvIHRoZSBQQVRIIGVudmlyb25tZW50IHZhaXJhYmxlIHNvIGhlbHBlciBjb21tYW5kcyBpbgogICAgICAgICAgICB0aGUgc2FtZSBkaXJlY3RvcnkgY2FuIGFsc28gYmUgZm91bmQKICAgICAgICA6a3cgY3dkOiBJZiBnaXZlbiwgd29ya2luZyBkaXJlY3RvcnkgdG8gcnVuIHRoZSBjb21tYW5kIGluc2lkZQogICAgICAgIDprdyB1c2VfdW5zYWZlX3NoZWxsOiBTZWUgYGFyZ3NgIHBhcmFtZXRlci4gIERlZmF1bHQgRmFsc2UKICAgICAgICA6a3cgcHJvbXB0X3JlZ2V4OiBSZWdleCBzdHJpbmcgKG5vdCBhIGNvbXBpbGVkIHJlZ2V4KSB3aGljaCBjYW4gYmUKICAgICAgICAgICAgdXNlZCB0byBkZXRlY3QgcHJvbXB0cyBpbiB0aGUgc3Rkb3V0IHdoaWNoIHdvdWxkIG90aGVyd2lzZSBjYXVzZQogICAgICAgICAgICB0aGUgZXhlY3V0aW9uIHRvIGhhbmcgKGVzcGVjaWFsbHkgaWYgbm8gaW5wdXQgZGF0YSBpcyBzcGVjaWZpZWQpCiAgICAgICAgOmt3IGVudmlyb25fdXBkYXRlOiBkaWN0aW9uYXJ5IHRvICp1cGRhdGUqIG9zLmVudmlyb24gd2l0aAogICAgICAgIDprdyB1bWFzazogVW1hc2sgdG8gYmUgdXNlZCB3aGVuIHJ1bm5pbmcgdGhlIGNvbW1hbmQuIERlZmF1bHQgTm9uZQogICAgICAgIDprdyBlbmNvZGluZzogU2luY2Ugd2UgcmV0dXJuIG5hdGl2ZSBzdHJpbmdzLCBvbiBweXRob24zIHdlIG5lZWQgdG8KICAgICAgICAgICAga25vdyB0aGUgZW5jb2RpbmcgdG8gdXNlIHRvIHRyYW5zZm9ybSBmcm9tIGJ5dGVzIHRvIHRleHQuICBJZiB5b3UKICAgICAgICAgICAgd2FudCB0byBhbHdheXMgZ2V0IGJ5dGVzIGJhY2ssIHVzZSBlbmNvZGluZz1Ob25lLiAgVGhlIGRlZmF1bHQgaXMKICAgICAgICAgICAgInV0Zi04Ii4gIFRoaXMgZG9lcyBub3QgYWZmZWN0IHRyYW5zZm9ybWF0aW9uIG9mIHN0cmluZ3MgZ2l2ZW4gYXMKICAgICAgICAgICAgYXJncy4KICAgICAgICA6a3cgZXJyb3JzOiBTaW5jZSB3ZSByZXR1cm4gbmF0aXZlIHN0cmluZ3MsIG9uIHB5dGhvbjMgd2UgbmVlZCB0bwogICAgICAgICAgICB0cmFuc2Zvcm0gc3Rkb3V0IGFuZCBzdGRlcnIgZnJvbSBieXRlcyB0byB0ZXh0LiAgSWYgdGhlIGJ5dGVzIGFyZQogICAgICAgICAgICB1bmRlY29kYWJsZSBpbiB0aGUgYGBlbmNvZGluZ2BgIHNwZWNpZmllZCwgdGhlbiB1c2UgdGhpcyBlcnJvcgogICAgICAgICAgICBoYW5kbGVyIHRvIGRlYWwgd2l0aCB0aGVtLiAgVGhlIGRlZmF1bHQgaXMgYGBzdXJyb2dhdGVfb3Jfc3RyaWN0YGAKICAgICAgICAgICAgd2hpY2ggbWVhbnMgdGhhdCB0aGUgYnl0ZXMgd2lsbCBiZSBkZWNvZGVkIHVzaW5nIHRoZQogICAgICAgICAgICBzdXJyb2dhdGVlc2NhcGUgZXJyb3IgaGFuZGxlciBpZiBhdmFpbGFibGUgKGF2YWlsYWJsZSBvbiBhbGwKICAgICAgICAgICAgcHl0aG9uMyB2ZXJzaW9ucyB3ZSBzdXBwb3J0KSBvdGhlcndpc2UgYSBVbmljb2RlRXJyb3IgdHJhY2ViYWNrCiAgICAgICAgICAgIHdpbGwgYmUgcmFpc2VkLiAgVGhpcyBkb2VzIG5vdCBhZmZlY3QgdHJhbnNmb3JtYXRpb25zIG9mIHN0cmluZ3MKICAgICAgICAgICAgZ2l2ZW4gYXMgYXJncy4KICAgICAgICA6cmV0dXJuczogQSAzLXR1cGxlIG9mIHJldHVybiBjb2RlIChpbnRlZ2VyKSwgc3Rkb3V0IChuYXRpdmUgc3RyaW5nKSwKICAgICAgICAgICAgYW5kIHN0ZGVyciAobmF0aXZlIHN0cmluZykuICBPbiBweXRob24yLCBzdGRvdXQgYW5kIHN0ZGVyciBhcmUgYm90aAogICAgICAgICAgICBieXRlIHN0cmluZ3MuICBPbiBweXRob24zLCBzdGRvdXQgYW5kIHN0ZGVyciBhcmUgdGV4dCBzdHJpbmdzIGNvbnZlcnRlZAogICAgICAgICAgICBhY2NvcmRpbmcgdG8gdGhlIGVuY29kaW5nIGFuZCBlcnJvcnMgcGFyYW1ldGVycy4gIElmIHlvdSB3YW50IGJ5dGUKICAgICAgICAgICAgc3RyaW5ncyBvbiBweXRob24zLCB1c2UgZW5jb2Rpbmc9Tm9uZSB0byB0dXJuIGRlY29kaW5nIHRvIHRleHQgb2ZmLgogICAgICAgICcnJwoKICAgICAgICBpZiBpc2luc3RhbmNlKGFyZ3MsIGxpc3QpOgogICAgICAgICAgICBpZiB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICAgICAgYXJncyA9ICIgIi5qb2luKFtzaGxleF9xdW90ZSh4KSBmb3IgeCBpbiBhcmdzXSkKICAgICAgICAgICAgICAgIHNoZWxsID0gVHJ1ZQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShhcmdzLCAoYmluYXJ5X3R5cGUsIHRleHRfdHlwZSkpIGFuZCB1c2VfdW5zYWZlX3NoZWxsOgogICAgICAgICAgICBzaGVsbCA9IFRydWUKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoYXJncywgKGJpbmFyeV90eXBlLCB0ZXh0X3R5cGUpKToKICAgICAgICAgICAgaWYgbm90IHVzZV91bnNhZmVfc2hlbGw6CiAgICAgICAgICAgICAgICAjIE9uIHB5dGhvbjIuNiBhbmQgYmVsb3csIHNobGV4IGhhcyBwcm9ibGVtcyB3aXRoIHRleHQgdHlwZQogICAgICAgICAgICAgICAgIyBPbiBweXRob24zLCBzaGxleCBuZWVkcyBhIHRleHQgdHlwZS4KICAgICAgICAgICAgICAgIGlmIFBZMjoKICAgICAgICAgICAgICAgICAgICBhcmdzID0gdG9fYnl0ZXMoYXJncywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykKICAgICAgICAgICAgICAgIGVsaWYgUFkzOgogICAgICAgICAgICAgICAgICAgIGFyZ3MgPSB0b190ZXh0KGFyZ3MsIGVycm9ycz0nc3Vycm9nYXRlZXNjYXBlJykKICAgICAgICAgICAgICAgIGFyZ3MgPSBzaGxleC5zcGxpdChhcmdzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1zZyA9ICJBcmd1bWVudCAnYXJncycgdG8gcnVuX2NvbW1hbmQgbXVzdCBiZSBsaXN0IG9yIHN0cmluZyIKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocmM9MjU3LCBjbWQ9YXJncywgbXNnPW1zZykKCiAgICAgICAgc2hlbGwgPSBGYWxzZQogICAgICAgIGlmIHVzZV91bnNhZmVfc2hlbGw6CiAgICAgICAgICAgIGlmIGV4ZWN1dGFibGUgaXMgTm9uZToKICAgICAgICAgICAgICAgIGV4ZWN1dGFibGUgPSBvcy5lbnZpcm9uLmdldCgnU0hFTEwnKQogICAgICAgICAgICBpZiBleGVjdXRhYmxlOgogICAgICAgICAgICAgICAgYXJncyA9IFtleGVjdXRhYmxlLCAnLWMnLCBhcmdzXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2hlbGwgPSBUcnVlCgogICAgICAgIHByb21wdF9yZSA9IE5vbmUKICAgICAgICBpZiBwcm9tcHRfcmVnZXg6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocHJvbXB0X3JlZ2V4LCB0ZXh0X3R5cGUpOgogICAgICAgICAgICAgICAgaWYgUFkzOgogICAgICAgICAgICAgICAgICAgIHByb21wdF9yZWdleCA9IHRvX2J5dGVzKHByb21wdF9yZWdleCwgZXJyb3JzPSdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICAgICAgICAgZWxpZiBQWTI6CiAgICAgICAgICAgICAgICAgICAgcHJvbXB0X3JlZ2V4ID0gdG9fYnl0ZXMocHJvbXB0X3JlZ2V4LCBlcnJvcnM9J3N1cnJvZ2F0ZV9vcl9zdHJpY3QnKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwcm9tcHRfcmUgPSByZS5jb21waWxlKHByb21wdF9yZWdleCwgcmUuTVVMVElMSU5FKQogICAgICAgICAgICBleGNlcHQgcmUuZXJyb3I6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWxfanNvbihtc2c9ImludmFsaWQgcHJvbXB0IHJlZ3VsYXIgZXhwcmVzc2lvbiBnaXZlbiB0byBydW5fY29tbWFuZCIpCgogICAgICAgICMgZXhwYW5kIHRoaW5ncyBsaWtlICRIT01FIGFuZCB+CiAgICAgICAgaWYgbm90IHNoZWxsOgogICAgICAgICAgICBhcmdzID0gWyBvcy5wYXRoLmV4cGFuZHVzZXIob3MucGF0aC5leHBhbmR2YXJzKHgpKSBmb3IgeCBpbiBhcmdzIGlmIHggaXMgbm90IE5vbmUgXQoKICAgICAgICByYyA9IDAKICAgICAgICBtc2cgPSBOb25lCiAgICAgICAgc3RfaW4gPSBOb25lCgogICAgICAgICMgTWFuaXB1bGF0ZSB0aGUgZW52aXJvbiB3ZSdsbCBzZW5kIHRvIHRoZSBuZXcgcHJvY2VzcwogICAgICAgIG9sZF9lbnZfdmFscyA9IHt9CiAgICAgICAgIyBXZSBjYW4gc2V0IHRoaXMgZnJvbSBib3RoIGFuIGF0dHJpYnV0ZSBhbmQgcGVyIGNhbGwKICAgICAgICBmb3Iga2V5LCB2YWwgaW4gc2VsZi5ydW5fY29tbWFuZF9lbnZpcm9uX3VwZGF0ZS5pdGVtcygpOgogICAgICAgICAgICBvbGRfZW52X3ZhbHNba2V5XSA9IG9zLmVudmlyb24uZ2V0KGtleSwgTm9uZSkKICAgICAgICAgICAgb3MuZW52aXJvbltrZXldID0gdmFsCiAgICAgICAgaWYgZW52aXJvbl91cGRhdGU6CiAgICAgICAgICAgIGZvciBrZXksIHZhbCBpbiBlbnZpcm9uX3VwZGF0ZS5pdGVtcygpOgogICAgICAgICAgICAgICAgb2xkX2Vudl92YWxzW2tleV0gPSBvcy5lbnZpcm9uLmdldChrZXksIE5vbmUpCiAgICAgICAgICAgICAgICBvcy5lbnZpcm9uW2tleV0gPSB2YWwKICAgICAgICBpZiBwYXRoX3ByZWZpeDoKICAgICAgICAgICAgb2xkX2Vudl92YWxzWydQQVRIJ10gPSBvcy5lbnZpcm9uWydQQVRIJ10KICAgICAgICAgICAgb3MuZW52aXJvblsnUEFUSCddID0gIiVzOiVzIiAlIChwYXRoX3ByZWZpeCwgb3MuZW52aXJvblsnUEFUSCddKQoKICAgICAgICAjIElmIHVzaW5nIHRlc3QtbW9kdWxlIGFuZCBleHBsb2RlLCB0aGUgcmVtb3RlIGxpYiBwYXRoIHdpbGwgcmVzZW1ibGUgLi4uCiAgICAgICAgIyAgIC90bXAvdGVzdF9tb2R1bGVfc2NyYXRjaC9kZWJ1Z19kaXIvYW5zaWJsZS9tb2R1bGVfdXRpbHMvYmFzaWMucHkKICAgICAgICAjIElmIHVzaW5nIGFuc2libGUgb3IgYW5zaWJsZS1wbGF5Ym9vayB3aXRoIGEgcmVtb3RlIHN5c3RlbSAuLi4KICAgICAgICAjICAgL3RtcC9hbnNpYmxlX3Ztd2VMUS9hbnNpYmxlX21vZGxpYi56aXAvYW5zaWJsZS9tb2R1bGVfdXRpbHMvYmFzaWMucHkKCiAgICAgICAgIyBDbGVhbiBvdXQgcHl0aG9uIHBhdGhzIHNldCBieSBhbnNpYmFsbHoKICAgICAgICBpZiAnUFlUSE9OUEFUSCcgaW4gb3MuZW52aXJvbjoKICAgICAgICAgICAgcHlwYXRocyA9IG9zLmVudmlyb25bJ1BZVEhPTlBBVEgnXS5zcGxpdCgnOicpCiAgICAgICAgICAgIHB5cGF0aHMgPSBbeCBmb3IgeCBpbiBweXBhdGhzIFwKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHguZW5kc3dpdGgoJy9hbnNpYmxlX21vZGxpYi56aXAnKSBcCiAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBub3QgeC5lbmRzd2l0aCgnL2RlYnVnX2RpcicpXQogICAgICAgICAgICBvcy5lbnZpcm9uWydQWVRIT05QQVRIJ10gPSAnOicuam9pbihweXBhdGhzKQogICAgICAgICAgICBpZiBub3Qgb3MuZW52aXJvblsnUFlUSE9OUEFUSCddOgogICAgICAgICAgICAgICAgZGVsIG9zLmVudmlyb25bJ1BZVEhPTlBBVEgnXQoKICAgICAgICAjIGNyZWF0ZSBhIHByaW50YWJsZSB2ZXJzaW9uIG9mIHRoZSBjb21tYW5kIGZvciB1c2UKICAgICAgICAjIGluIHJlcG9ydGluZyBsYXRlciwgd2hpY2ggc3RyaXBzIG91dCB0aGluZ3MgbGlrZQogICAgICAgICMgcGFzc3dvcmRzIGZyb20gdGhlIGFyZ3MgbGlzdAogICAgICAgIHRvX2NsZWFuX2FyZ3MgPSBhcmdzCiAgICAgICAgaWYgUFkyOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGFyZ3MsIHRleHRfdHlwZSk6CiAgICAgICAgICAgICAgICB0b19jbGVhbl9hcmdzID0gdG9fYnl0ZXMoYXJncykKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGFyZ3MsIGJpbmFyeV90eXBlKToKICAgICAgICAgICAgICAgIHRvX2NsZWFuX2FyZ3MgPSB0b190ZXh0KGFyZ3MpCiAgICAgICAgaWYgaXNpbnN0YW5jZShhcmdzLCAodGV4dF90eXBlLCBiaW5hcnlfdHlwZSkpOgogICAgICAgICAgICB0b19jbGVhbl9hcmdzID0gc2hsZXguc3BsaXQodG9fY2xlYW5fYXJncykKCiAgICAgICAgY2xlYW5fYXJncyA9IFtdCiAgICAgICAgaXNfcGFzc3dkID0gRmFsc2UKICAgICAgICBmb3IgYXJnIGluIHRvX2NsZWFuX2FyZ3M6CiAgICAgICAgICAgIGlmIGlzX3Bhc3N3ZDoKICAgICAgICAgICAgICAgIGlzX3Bhc3N3ZCA9IEZhbHNlCiAgICAgICAgICAgICAgICBjbGVhbl9hcmdzLmFwcGVuZCgnKioqKioqKionKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgUEFTU1dEX0FSR19SRS5tYXRjaChhcmcpOgogICAgICAgICAgICAgICAgc2VwX2lkeCA9IGFyZy5maW5kKCc9JykKICAgICAgICAgICAgICAgIGlmIHNlcF9pZHggPiAtMToKICAgICAgICAgICAgICAgICAgICBjbGVhbl9hcmdzLmFwcGVuZCgnJXM9KioqKioqKionICUgYXJnWzpzZXBfaWR4XSkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBpc19wYXNzd2QgPSBUcnVlCiAgICAgICAgICAgIGFyZyA9IGhldXJpc3RpY19sb2dfc2FuaXRpemUoYXJnLCBzZWxmLm5vX2xvZ192YWx1ZXMpCiAgICAgICAgICAgIGNsZWFuX2FyZ3MuYXBwZW5kKGFyZykKICAgICAgICBjbGVhbl9hcmdzID0gJyAnLmpvaW4oc2hsZXhfcXVvdGUoYXJnKSBmb3IgYXJnIGluIGNsZWFuX2FyZ3MpCgogICAgICAgIGlmIGRhdGE6CiAgICAgICAgICAgIHN0X2luID0gc3VicHJvY2Vzcy5QSVBFCgogICAgICAgIGt3YXJncyA9IGRpY3QoCiAgICAgICAgICAgIGV4ZWN1dGFibGU9ZXhlY3V0YWJsZSwKICAgICAgICAgICAgc2hlbGw9c2hlbGwsCiAgICAgICAgICAgIGNsb3NlX2Zkcz1jbG9zZV9mZHMsCiAgICAgICAgICAgIHN0ZGluPXN0X2luLAogICAgICAgICAgICBzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICkKCiAgICAgICAgIyBzdG9yZSB0aGUgcHdkCiAgICAgICAgcHJldl9kaXIgPSBvcy5nZXRjd2QoKQoKICAgICAgICAjIG1ha2Ugc3VyZSB3ZSdyZSBpbiB0aGUgcmlnaHQgd29ya2luZyBkaXJlY3RvcnkKICAgICAgICBpZiBjd2QgYW5kIG9zLnBhdGguaXNkaXIoY3dkKToKICAgICAgICAgICAgY3dkID0gb3MucGF0aC5hYnNwYXRoKG9zLnBhdGguZXhwYW5kdXNlcihjd2QpKQogICAgICAgICAgICBrd2FyZ3NbJ2N3ZCddID0gY3dkCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLmNoZGlyKGN3ZCkKICAgICAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuZmFpbF9qc29uKHJjPWUuZXJybm8sIG1zZz0iQ291bGQgbm90IG9wZW4gJXMsICVzIiAlIChjd2QsIHN0cihlKSkpCgogICAgICAgIG9sZF91bWFzayA9IE5vbmUKICAgICAgICBpZiB1bWFzazoKICAgICAgICAgICAgb2xkX3VtYXNrID0gb3MudW1hc2sodW1hc2spCgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5fZGVidWc6CiAgICAgICAgICAgICAgICBzZWxmLmxvZygnRXhlY3V0aW5nOiAnICsgY2xlYW5fYXJncykKICAgICAgICAgICAgY21kID0gc3VicHJvY2Vzcy5Qb3BlbihhcmdzLCAqKmt3YXJncykKCiAgICAgICAgICAgICMgdGhlIGNvbW11bmljYXRpb24gbG9naWMgaGVyZSBpcyBlc3NlbnRpYWxseSB0YWtlbiBmcm9tIHRoYXQKICAgICAgICAgICAgIyBvZiB0aGUgX2NvbW11bmljYXRlKCkgZnVuY3Rpb24gaW4gc3NoLnB5CgogICAgICAgICAgICBzdGRvdXQgPSBiKCcnKQogICAgICAgICAgICBzdGRlcnIgPSBiKCcnKQogICAgICAgICAgICBycGlwZXMgPSBbY21kLnN0ZG91dCwgY21kLnN0ZGVycl0KCiAgICAgICAgICAgIGlmIGRhdGE6CiAgICAgICAgICAgICAgICBpZiBub3QgYmluYXJ5X2RhdGE6CiAgICAgICAgICAgICAgICAgICAgZGF0YSArPSAnXG4nCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGRhdGEsIHRleHRfdHlwZSk6CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHRvX2J5dGVzKGRhdGEpCiAgICAgICAgICAgICAgICBjbWQuc3RkaW4ud3JpdGUoZGF0YSkKICAgICAgICAgICAgICAgIGNtZC5zdGRpbi5jbG9zZSgpCgogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgcmZkcywgd2ZkcywgZWZkcyA9IHNlbGVjdC5zZWxlY3QocnBpcGVzLCBbXSwgcnBpcGVzLCAxKQogICAgICAgICAgICAgICAgc3Rkb3V0ICs9IHNlbGYuX3JlYWRfZnJvbV9waXBlcyhycGlwZXMsIHJmZHMsIGNtZC5zdGRvdXQpCiAgICAgICAgICAgICAgICBzdGRlcnIgKz0gc2VsZi5fcmVhZF9mcm9tX3BpcGVzKHJwaXBlcywgcmZkcywgY21kLnN0ZGVycikKICAgICAgICAgICAgICAgICMgaWYgd2UncmUgY2hlY2tpbmcgZm9yIHByb21wdHMsIGRvIGl0IG5vdwogICAgICAgICAgICAgICAgaWYgcHJvbXB0X3JlOgogICAgICAgICAgICAgICAgICAgIGlmIHByb21wdF9yZS5zZWFyY2goc3Rkb3V0KSBhbmQgbm90IGRhdGE6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGVuY29kaW5nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Rkb3V0ID0gdG9fbmF0aXZlKHN0ZG91dCwgZW5jb2Rpbmc9ZW5jb2RpbmcsIGVycm9ycz1lcnJvcnMpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQgPSBzdGRvdXQKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgyNTcsIHN0ZG91dCwgIkEgcHJvbXB0IHdhcyBlbmNvdW50ZXJlZCB3aGlsZSBydW5uaW5nIGEgY29tbWFuZCwgYnV0IG5vIGlucHV0IGRhdGEgd2FzIHNwZWNpZmllZCIpCiAgICAgICAgICAgICAgICAjIG9ubHkgYnJlYWsgb3V0IGlmIG5vIHBpcGVzIGFyZSBsZWZ0IHRvIHJlYWQgb3IKICAgICAgICAgICAgICAgICMgdGhlIHBpcGVzIGFyZSBjb21wbGV0ZWx5IHJlYWQgYW5kCiAgICAgICAgICAgICAgICAjIHRoZSBwcm9jZXNzIGlzIHRlcm1pbmF0ZWQKICAgICAgICAgICAgICAgIGlmIChub3QgcnBpcGVzIG9yIG5vdCByZmRzKSBhbmQgY21kLnBvbGwoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgIyBObyBwaXBlcyBhcmUgbGVmdCB0byByZWFkIGJ1dCBwcm9jZXNzIGlzIG5vdCB5ZXQgdGVybWluYXRlZAogICAgICAgICAgICAgICAgIyBPbmx5IHRoZW4gaXQgaXMgc2FmZSB0byB3YWl0IGZvciB0aGUgcHJvY2VzcyB0byBiZSBmaW5pc2hlZAogICAgICAgICAgICAgICAgIyBOT1RFOiBBY3R1YWxseSBjbWQucG9sbCgpIGlzIGFsd2F5cyBOb25lIGhlcmUgaWYgcnBpcGVzIGlzIGVtcHR5CiAgICAgICAgICAgICAgICBlbGlmIG5vdCBycGlwZXMgYW5kIGNtZC5wb2xsKCkgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBjbWQud2FpdCgpCiAgICAgICAgICAgICAgICAgICAgIyBUaGUgcHJvY2VzcyBpcyB0ZXJtaW5hdGVkLiBTaW5jZSBubyBwaXBlcyB0byByZWFkIGZyb20gYXJlCiAgICAgICAgICAgICAgICAgICAgIyBsZWZ0LCB0aGVyZSBpcyBubyBuZWVkIHRvIGNhbGwgc2VsZWN0KCkgYWdhaW4uCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIGNtZC5zdGRvdXQuY2xvc2UoKQogICAgICAgICAgICBjbWQuc3RkZXJyLmNsb3NlKCkKCiAgICAgICAgICAgIHJjID0gY21kLnJldHVybmNvZGUKICAgICAgICBleGNlcHQgKE9TRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHNlbGYubG9nKCJFcnJvciBFeGVjdXRpbmcgQ01EOiVzIEV4Y2VwdGlvbjolcyIgJSAoY2xlYW5fYXJncywgdG9fbmF0aXZlKGUpKSkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocmM9ZS5lcnJubywgbXNnPXRvX25hdGl2ZShlKSwgY21kPWNsZWFuX2FyZ3MpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgICAgICBzZWxmLmxvZygiRXJyb3IgRXhlY3V0aW5nIENNRDolcyBFeGNlcHRpb246JXMiICUgKGNsZWFuX2FyZ3MsdG9fbmF0aXZlKHRyYWNlYmFjay5mb3JtYXRfZXhjKCkpKSkKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24ocmM9MjU3LCBtc2c9dG9fbmF0aXZlKGUpLCBleGNlcHRpb249dHJhY2ViYWNrLmZvcm1hdF9leGMoKSwgY21kPWNsZWFuX2FyZ3MpCgogICAgICAgICMgUmVzdG9yZSBlbnYgc2V0dGluZ3MKICAgICAgICBmb3Iga2V5LCB2YWwgaW4gb2xkX2Vudl92YWxzLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIHZhbCBpcyBOb25lOgogICAgICAgICAgICAgICAgZGVsIG9zLmVudmlyb25ba2V5XQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb3MuZW52aXJvbltrZXldID0gdmFsCgogICAgICAgIGlmIG9sZF91bWFzazoKICAgICAgICAgICAgb3MudW1hc2sob2xkX3VtYXNrKQoKICAgICAgICBpZiByYyAhPSAwIGFuZCBjaGVja19yYzoKICAgICAgICAgICAgbXNnID0gaGV1cmlzdGljX2xvZ19zYW5pdGl6ZShzdGRlcnIucnN0cmlwKCksIHNlbGYubm9fbG9nX3ZhbHVlcykKICAgICAgICAgICAgc2VsZi5mYWlsX2pzb24oY21kPWNsZWFuX2FyZ3MsIHJjPXJjLCBzdGRvdXQ9c3Rkb3V0LCBzdGRlcnI9c3RkZXJyLCBtc2c9bXNnKQoKICAgICAgICAjIHJlc2V0IHRoZSBwd2QKICAgICAgICBvcy5jaGRpcihwcmV2X2RpcikKCiAgICAgICAgaWYgZW5jb2RpbmcgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldHVybiAocmMsIHRvX25hdGl2ZShzdGRvdXQsIGVuY29kaW5nPWVuY29kaW5nLCBlcnJvcnM9ZXJyb3JzKSwKICAgICAgICAgICAgICAgICAgICB0b19uYXRpdmUoc3RkZXJyLCBlbmNvZGluZz1lbmNvZGluZywgZXJyb3JzPWVycm9ycykpCiAgICAgICAgcmV0dXJuIChyYywgc3Rkb3V0LCBzdGRlcnIpCgogICAgZGVmIGFwcGVuZF90b19maWxlKHNlbGYsIGZpbGVuYW1lLCBzdHIpOgogICAgICAgIGZpbGVuYW1lID0gb3MucGF0aC5leHBhbmR2YXJzKG9zLnBhdGguZXhwYW5kdXNlcihmaWxlbmFtZSkpCiAgICAgICAgZmggPSBvcGVuKGZpbGVuYW1lLCAnYScpCiAgICAgICAgZmgud3JpdGUoc3RyKQogICAgICAgIGZoLmNsb3NlKCkKCiAgICBkZWYgYnl0ZXNfdG9faHVtYW4oc2VsZiwgc2l6ZSk6CiAgICAgICAgcmV0dXJuIGJ5dGVzX3RvX2h1bWFuKHNpemUpCgogICAgIyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkKICAgIHByZXR0eV9ieXRlcyA9IGJ5dGVzX3RvX2h1bWFuCgogICAgZGVmIGh1bWFuX3RvX2J5dGVzKHNlbGYsIG51bWJlciwgaXNiaXRzPUZhbHNlKToKICAgICAgICByZXR1cm4gaHVtYW5fdG9fYnl0ZXMobnVtYmVyLCBpc2JpdHMpCgogICAgIwogICAgIyBCYWNrd2FyZHMgY29tcGF0CiAgICAjCgogICAgIyBJbiAyLjAsIG1vdmVkIGZyb20gaW5zaWRlIHRoZSBtb2R1bGUgdG8gdGhlIHRvcGxldmVsCiAgICBpc19leGVjdXRhYmxlID0gaXNfZXhlY3V0YWJsZQoKCmRlZiBnZXRfbW9kdWxlX3BhdGgoKToKICAgIHJldHVybiBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5yZWFscGF0aChfX2ZpbGVfXykpClBLAwQUAAAAAAABvCtLJdy0fhMQAAATEAAAIgAAAGFuc2libGUvbW9kdWxlX3V0aWxzL3B5Y29tcGF0MjQucHkjIFRoaXMgY29kZSBpcyBwYXJ0IG9mIEFuc2libGUsIGJ1dCBpcyBhbiBpbmRlcGVuZGVudCBjb21wb25lbnQuCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBUb3NoaW8gS3VyYXRvbWkgPHRrdXJhdG9taUBhbnNpYmxlLmNvbT4KIyBDb3B5cmlnaHQgKGMpIDIwMTUsIE1hcml1cyBHZWRtaW5hcwojCiMgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwKIyBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiMKIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiMgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiMgICAgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiMgICAgICBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KIwojIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKIyBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAojIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4KIyBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIEhPTERFUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwKIyBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sCiMgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCiMgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVAojIExJQUJJTElUWSwgT1IgVE9SVCAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRQojIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgojCgppbXBvcnQgc3lzCgpkZWYgZ2V0X2V4Y2VwdGlvbigpOgogICAgIiIiR2V0IHRoZSBjdXJyZW50IGV4Y2VwdGlvbi4KCiAgICBUaGlzIGNvZGUgbmVlZHMgdG8gd29yayBvbiBQeXRob24gMi40IHRocm91Z2ggMy54LCBzbyB3ZSBjYW5ub3QgdXNlCiAgICAiZXhjZXB0IEV4Y2VwdGlvbiwgZToiIChTeW50YXhFcnJvciBvbiBQeXRob24gMy54KSBub3IKICAgICJleGNlcHQgRXhjZXB0aW9uIGFzIGU6IiAoU3ludGF4RXJyb3Igb24gUHl0aG9uIDIuNC0yLjUpLgogICAgSW5zdGVhZCB3ZSBtdXN0IHVzZSA6OgoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCgogICAgIiIiCiAgICByZXR1cm4gc3lzLmV4Y19pbmZvKClbMV0KCnRyeToKICAgICMgUHl0aG9uIDIuNisKICAgIGZyb20gYXN0IGltcG9ydCBsaXRlcmFsX2V2YWwKZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyBhIHJlcGxhY2VtZW50IGZvciBsaXRlcmFsX2V2YWwgdGhhdCB3b3JrcyB3aXRoIHB5dGhvbiAyLjQuIGZyb206CiAgICAjIGh0dHBzOi8vbWFpbC5weXRob24ub3JnL3BpcGVybWFpbC9weXRob24tbGlzdC8yMDA5LVNlcHRlbWJlci81NTE4ODAuaHRtbAogICAgIyB3aGljaCBpcyBlc3NlbnRpYWxseSBhIGN1dC9wYXN0ZSBmcm9tIGFuIGVhcmxpZXIgKDIuNikgdmVyc2lvbiBvZiBweXRob24ncwogICAgIyBhc3QucHkKICAgIGZyb20gY29tcGlsZXIgaW1wb3J0IGFzdCwgcGFyc2UKICAgIGZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGltcG9ydCBiaW5hcnlfdHlwZSwgc3RyaW5nX3R5cGVzLCB0ZXh0X3R5cGUKCiAgICBkZWYgbGl0ZXJhbF9ldmFsKG5vZGVfb3Jfc3RyaW5nKToKICAgICAgICAiIiIKICAgICAgICBTYWZlbHkgZXZhbHVhdGUgYW4gZXhwcmVzc2lvbiBub2RlIG9yIGEgc3RyaW5nIGNvbnRhaW5pbmcgYSBQeXRob24KICAgICAgICBleHByZXNzaW9uLiAgVGhlIHN0cmluZyBvciBub2RlIHByb3ZpZGVkIG1heSBvbmx5IGNvbnNpc3Qgb2YgdGhlICBmb2xsb3dpbmcKICAgICAgICBQeXRob24gbGl0ZXJhbCBzdHJ1Y3R1cmVzOiBzdHJpbmdzLCBudW1iZXJzLCB0dXBsZXMsIGxpc3RzLCBkaWN0cywgIGJvb2xlYW5zLAogICAgICAgIGFuZCBOb25lLgogICAgICAgICIiIgogICAgICAgIF9zYWZlX25hbWVzID0geydOb25lJzogTm9uZSwgJ1RydWUnOiBUcnVlLCAnRmFsc2UnOiBGYWxzZX0KICAgICAgICBpZiBpc2luc3RhbmNlKG5vZGVfb3Jfc3RyaW5nLCBzdHJpbmdfdHlwZXMpOgogICAgICAgICAgICBub2RlX29yX3N0cmluZyA9IHBhcnNlKG5vZGVfb3Jfc3RyaW5nLCBtb2RlPSdldmFsJykKICAgICAgICBpZiBpc2luc3RhbmNlKG5vZGVfb3Jfc3RyaW5nLCBhc3QuRXhwcmVzc2lvbik6CiAgICAgICAgICAgIG5vZGVfb3Jfc3RyaW5nID0gbm9kZV9vcl9zdHJpbmcubm9kZQoKICAgICAgICBkZWYgX2NvbnZlcnQobm9kZSk6CiAgICAgICAgICAgICMgT2theSB0byB1c2UgbG9uZyBoZXJlIGJlY2F1c2UgdGhpcyBpcyBvbmx5IGZvciBweXRob24gMi40IGFuZCAyLjUKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuQ29uc3QpIGFuZCBpc2luc3RhbmNlKG5vZGUudmFsdWUsICh0ZXh0X3R5cGUsIGJpbmFyeV90eXBlLCBpbnQsIGZsb2F0LCBsb25nLCBjb21wbGV4KSk6CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0LlR1cGxlKToKICAgICAgICAgICAgICAgIHJldHVybiB0dXBsZShtYXAoX2NvbnZlcnQsIG5vZGUubm9kZXMpKQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0Lkxpc3QpOgogICAgICAgICAgICAgICAgcmV0dXJuIGxpc3QobWFwKF9jb252ZXJ0LCBub2RlLm5vZGVzKSkKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5EaWN0KToKICAgICAgICAgICAgICAgIHJldHVybiBkaWN0KChfY29udmVydChrKSwgX2NvbnZlcnQodikpIGZvciBrLCB2IGluIG5vZGUuaXRlbXMoKSkKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGUsIGFzdC5OYW1lKToKICAgICAgICAgICAgICAgIGlmIG5vZGUubmFtZSBpbiBfc2FmZV9uYW1lczoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3NhZmVfbmFtZXNbbm9kZS5uYW1lXQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZSwgYXN0LlVuYXJ5U3ViKToKICAgICAgICAgICAgICAgIHJldHVybiAtX2NvbnZlcnQobm9kZS5leHByKQogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdtYWxmb3JtZWQgc3RyaW5nJykKICAgICAgICByZXR1cm4gX2NvbnZlcnQobm9kZV9vcl9zdHJpbmcpCgpfX2FsbF9fID0gKCdnZXRfZXhjZXB0aW9uJywgJ2xpdGVyYWxfZXZhbCcpClBLAwQUAAAAAAABvCtLXYa1bzutAAA7rQAAHAAAAGFuc2libGUvbW9kdWxlX3V0aWxzL3VybHMucHkjIFRoaXMgY29kZSBpcyBwYXJ0IG9mIEFuc2libGUsIGJ1dCBpcyBhbiBpbmRlcGVuZGVudCBjb21wb25lbnQuCiMgVGhpcyBwYXJ0aWN1bGFyIGZpbGUgc25pcHBldCwgYW5kIHRoaXMgZmlsZSBzbmlwcGV0IG9ubHksIGlzIEJTRCBsaWNlbnNlZC4KIyBNb2R1bGVzIHlvdSB3cml0ZSB1c2luZyB0aGlzIHNuaXBwZXQsIHdoaWNoIGlzIGVtYmVkZGVkIGR5bmFtaWNhbGx5IGJ5IEFuc2libGUKIyBzdGlsbCBiZWxvbmcgdG8gdGhlIGF1dGhvciBvZiB0aGUgbW9kdWxlLCBhbmQgbWF5IGFzc2lnbiB0aGVpciBvd24gbGljZW5zZQojIHRvIHRoZSBjb21wbGV0ZSB3b3JrLgojCiMgQ29weXJpZ2h0IChjKSwgTWljaGFlbCBEZUhhYW4gPG1pY2hhZWwuZGVoYWFuQGdtYWlsLmNvbT4sIDIwMTItMjAxMwojIENvcHlyaWdodCAoYyksIFRvc2hpbyBLdXJhdG9taSA8dGt1cmF0b21pQGFuc2libGUuY29tPiwgMjAxNQojIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiMKIyBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQgbW9kaWZpY2F0aW9uLAojIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKIwojICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKIyAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KIyAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwKIyAgICAgIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24KIyAgICAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORAojIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVECiMgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRSBESVNDTEFJTUVELgojIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULAojIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywKIyBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MKIyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUCiMgTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFCiMgVVNFIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiMKIyBUaGUgbWF0Y2hfaG9zdG5hbWUgZnVuY3Rpb24gYW5kIHN1cHBvcnRpbmcgY29kZSBpcyB1bmRlciB0aGUgdGVybXMgYW5kCiMgY29uZGl0aW9ucyBvZiB0aGUgUHl0aG9uIFNvZnR3YXJlIEZvdW5kYXRpb24gTGljZW5zZS4gIFRoZXkgd2VyZSB0YWtlbiBmcm9tCiMgdGhlIFB5dGhvbjMgc3RhbmRhcmQgbGlicmFyeSBhbmQgYWRhcHRlZCBmb3IgdXNlIGluIFB5dGhvbjIuICBTZWUgY29tbWVudHMgaW4gdGhlCiMgc291cmNlIGZvciB3aGljaCBjb2RlIHByZWNpc2VseSBpcyB1bmRlciB0aGlzIExpY2Vuc2UuICBQU0YgTGljZW5zZSB0ZXh0CiMgZm9sbG93czoKIwojIFBZVEhPTiBTT0ZUV0FSRSBGT1VOREFUSU9OIExJQ0VOU0UgVkVSU0lPTiAyCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIwojIDEuIFRoaXMgTElDRU5TRSBBR1JFRU1FTlQgaXMgYmV0d2VlbiB0aGUgUHl0aG9uIFNvZnR3YXJlIEZvdW5kYXRpb24KIyAoIlBTRiIpLCBhbmQgdGhlIEluZGl2aWR1YWwgb3IgT3JnYW5pemF0aW9uICgiTGljZW5zZWUiKSBhY2Nlc3NpbmcgYW5kCiMgb3RoZXJ3aXNlIHVzaW5nIHRoaXMgc29mdHdhcmUgKCJQeXRob24iKSBpbiBzb3VyY2Ugb3IgYmluYXJ5IGZvcm0gYW5kCiMgaXRzIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbi4KIwojIDIuIFN1YmplY3QgdG8gdGhlIHRlcm1zIGFuZCBjb25kaXRpb25zIG9mIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQsIFBTRiBoZXJlYnkKIyBncmFudHMgTGljZW5zZWUgYSBub25leGNsdXNpdmUsIHJveWFsdHktZnJlZSwgd29ybGQtd2lkZSBsaWNlbnNlIHRvIHJlcHJvZHVjZSwKIyBhbmFseXplLCB0ZXN0LCBwZXJmb3JtIGFuZC9vciBkaXNwbGF5IHB1YmxpY2x5LCBwcmVwYXJlIGRlcml2YXRpdmUgd29ya3MsCiMgZGlzdHJpYnV0ZSwgYW5kIG90aGVyd2lzZSB1c2UgUHl0aG9uIGFsb25lIG9yIGluIGFueSBkZXJpdmF0aXZlIHZlcnNpb24sCiMgcHJvdmlkZWQsIGhvd2V2ZXIsIHRoYXQgUFNGJ3MgTGljZW5zZSBBZ3JlZW1lbnQgYW5kIFBTRidzIG5vdGljZSBvZiBjb3B5cmlnaHQsCiMgaS5lLiwgIkNvcHlyaWdodCAoYykgMjAwMSwgMjAwMiwgMjAwMywgMjAwNCwgMjAwNSwgMjAwNiwgMjAwNywgMjAwOCwgMjAwOSwgMjAxMCwKIyAyMDExLCAyMDEyLCAyMDEzLCAyMDE0IFB5dGhvbiBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBBbGwgUmlnaHRzIFJlc2VydmVkIiBhcmUKIyByZXRhaW5lZCBpbiBQeXRob24gYWxvbmUgb3IgaW4gYW55IGRlcml2YXRpdmUgdmVyc2lvbiBwcmVwYXJlZCBieSBMaWNlbnNlZS4KIwojIDMuIEluIHRoZSBldmVudCBMaWNlbnNlZSBwcmVwYXJlcyBhIGRlcml2YXRpdmUgd29yayB0aGF0IGlzIGJhc2VkIG9uCiMgb3IgaW5jb3Jwb3JhdGVzIFB5dGhvbiBvciBhbnkgcGFydCB0aGVyZW9mLCBhbmQgd2FudHMgdG8gbWFrZQojIHRoZSBkZXJpdmF0aXZlIHdvcmsgYXZhaWxhYmxlIHRvIG90aGVycyBhcyBwcm92aWRlZCBoZXJlaW4sIHRoZW4KIyBMaWNlbnNlZSBoZXJlYnkgYWdyZWVzIHRvIGluY2x1ZGUgaW4gYW55IHN1Y2ggd29yayBhIGJyaWVmIHN1bW1hcnkgb2YKIyB0aGUgY2hhbmdlcyBtYWRlIHRvIFB5dGhvbi4KIwojIDQuIFBTRiBpcyBtYWtpbmcgUHl0aG9uIGF2YWlsYWJsZSB0byBMaWNlbnNlZSBvbiBhbiAiQVMgSVMiCiMgYmFzaXMuICBQU0YgTUFLRVMgTk8gUkVQUkVTRU5UQVRJT05TIE9SIFdBUlJBTlRJRVMsIEVYUFJFU1MgT1IKIyBJTVBMSUVELiAgQlkgV0FZIE9GIEVYQU1QTEUsIEJVVCBOT1QgTElNSVRBVElPTiwgUFNGIE1BS0VTIE5PIEFORAojIERJU0NMQUlNUyBBTlkgUkVQUkVTRU5UQVRJT04gT1IgV0FSUkFOVFkgT0YgTUVSQ0hBTlRBQklMSVRZIE9SIEZJVE5FU1MKIyBGT1IgQU5ZIFBBUlRJQ1VMQVIgUFVSUE9TRSBPUiBUSEFUIFRIRSBVU0UgT0YgUFlUSE9OIFdJTEwgTk9UCiMgSU5GUklOR0UgQU5ZIFRISVJEIFBBUlRZIFJJR0hUUy4KIwojIDUuIFBTRiBTSEFMTCBOT1QgQkUgTElBQkxFIFRPIExJQ0VOU0VFIE9SIEFOWSBPVEhFUiBVU0VSUyBPRiBQWVRIT04KIyBGT1IgQU5ZIElOQ0lERU5UQUwsIFNQRUNJQUwsIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyBPUiBMT1NTIEFTCiMgQSBSRVNVTFQgT0YgTU9ESUZZSU5HLCBESVNUUklCVVRJTkcsIE9SIE9USEVSV0lTRSBVU0lORyBQWVRIT04sCiMgT1IgQU5ZIERFUklWQVRJVkUgVEhFUkVPRiwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBUSEVSRU9GLgojCiMgNi4gVGhpcyBMaWNlbnNlIEFncmVlbWVudCB3aWxsIGF1dG9tYXRpY2FsbHkgdGVybWluYXRlIHVwb24gYSBtYXRlcmlhbAojIGJyZWFjaCBvZiBpdHMgdGVybXMgYW5kIGNvbmRpdGlvbnMuCiMKIyA3LiBOb3RoaW5nIGluIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgc2hhbGwgYmUgZGVlbWVkIHRvIGNyZWF0ZSBhbnkKIyByZWxhdGlvbnNoaXAgb2YgYWdlbmN5LCBwYXJ0bmVyc2hpcCwgb3Igam9pbnQgdmVudHVyZSBiZXR3ZWVuIFBTRiBhbmQKIyBMaWNlbnNlZS4gIFRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgZG9lcyBub3QgZ3JhbnQgcGVybWlzc2lvbiB0byB1c2UgUFNGCiMgdHJhZGVtYXJrcyBvciB0cmFkZSBuYW1lIGluIGEgdHJhZGVtYXJrIHNlbnNlIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZQojIHByb2R1Y3RzIG9yIHNlcnZpY2VzIG9mIExpY2Vuc2VlLCBvciBhbnkgdGhpcmQgcGFydHkuCiMKIyA4LiBCeSBjb3B5aW5nLCBpbnN0YWxsaW5nIG9yIG90aGVyd2lzZSB1c2luZyBQeXRob24sIExpY2Vuc2VlCiMgYWdyZWVzIHRvIGJlIGJvdW5kIGJ5IHRoZSB0ZXJtcyBhbmQgY29uZGl0aW9ucyBvZiB0aGlzIExpY2Vuc2UKIyBBZ3JlZW1lbnQuCgonJycKVGhlICoqdXJscyoqIHV0aWxzIG1vZHVsZSBvZmZlcnMgYSByZXBsYWNlbWVudCBmb3IgdGhlIHVybGxpYjIgcHl0aG9uIGxpYnJhcnkuCgp1cmxsaWIyIGlzIHRoZSBweXRob24gc3RkbGliIHdheSB0byByZXRyaWV2ZSBmaWxlcyBmcm9tIHRoZSBJbnRlcm5ldCBidXQgaXQKbGFja3Mgc29tZSBzZWN1cml0eSBmZWF0dXJlcyAoYXJvdW5kIHZlcmlmeWluZyBTU0wgY2VydGlmaWNhdGVzKSB0aGF0IHVzZXJzCnNob3VsZCBjYXJlIGFib3V0IGluIG1vc3Qgc2l0dWF0aW9ucy4gVXNpbmcgdGhlIGZ1bmN0aW9ucyBpbiB0aGlzIG1vZHVsZSBjb3JyZWN0cwpkZWZpY2llbmNpZXMgaW4gdGhlIHVybGxpYjIgbW9kdWxlIHdoZXJldmVyIHBvc3NpYmxlLgoKVGhlcmUgYXJlIGFsc28gdGhpcmQtcGFydHkgbGlicmFyaWVzIChmb3IgaW5zdGFuY2UsIHJlcXVlc3RzKSB3aGljaCBjYW4gYmUgdXNlZAp0byByZXBsYWNlIHVybGxpYjIgd2l0aCBhIG1vcmUgc2VjdXJlIGxpYnJhcnkuIEhvd2V2ZXIsIGFsbCB0aGlyZCBwYXJ0eSBsaWJyYXJpZXMKcmVxdWlyZSB0aGF0IHRoZSBsaWJyYXJ5IGJlIGluc3RhbGxlZCBvbiB0aGUgbWFuYWdlZCBtYWNoaW5lLiBUaGF0IGlzIGFuIGV4dHJhIHN0ZXAKZm9yIHVzZXJzIG1ha2luZyB1c2Ugb2YgYSBtb2R1bGUuIElmIHBvc3NpYmxlLCBhdm9pZCB0aGlyZCBwYXJ0eSBsaWJyYXJpZXMgYnkgdXNpbmcKdGhpcyBjb2RlIGluc3RlYWQuCicnJwoKaW1wb3J0IG5ldHJjCmltcG9ydCBvcwppbXBvcnQgcmUKaW1wb3J0IHN5cwppbXBvcnQgc29ja2V0CmltcG9ydCBwbGF0Zm9ybQppbXBvcnQgdGVtcGZpbGUKaW1wb3J0IGJhc2U2NAoKdHJ5OgogICAgaW1wb3J0IGh0dHBsaWIKZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyBQeXRob24gMwogICAgaW1wb3J0IGh0dHAuY2xpZW50IGFzIGh0dHBsaWIKCmltcG9ydCBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXgubW92ZXMudXJsbGliLnJlcXVlc3QgYXMgdXJsbGliX3JlcXVlc3QKaW1wb3J0IGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5tb3Zlcy51cmxsaWIuZXJyb3IgYXMgdXJsbGliX2Vycm9yCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuYmFzaWMgaW1wb3J0IGdldF9kaXN0cmlidXRpb24sIGdldF9leGNlcHRpb24KZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IGIKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5fdGV4dCBpbXBvcnQgdG9fYnl0ZXMsIHRvX25hdGl2ZSwgdG9fdGV4dAoKdHJ5OgogICAgIyBweXRob24zCiAgICBpbXBvcnQgdXJsbGliLnJlcXVlc3QgYXMgdXJsbGliX3JlcXVlc3QKICAgIGZyb20gdXJsbGliLnJlcXVlc3QgaW1wb3J0IEFic3RyYWN0SFRUUEhhbmRsZXIKZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyBweXRob24yCiAgICBpbXBvcnQgdXJsbGliMiBhcyB1cmxsaWJfcmVxdWVzdAogICAgZnJvbSB1cmxsaWIyIGltcG9ydCBBYnN0cmFjdEhUVFBIYW5kbGVyCgp0cnk6CiAgICBmcm9tIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5tb3Zlcy51cmxsaWIucGFyc2UgaW1wb3J0IHVybHBhcnNlLCB1cmx1bnBhcnNlCiAgICBIQVNfVVJMUEFSU0UgPSBUcnVlCmV4Y2VwdDoKICAgIEhBU19VUkxQQVJTRSA9IEZhbHNlCgp0cnk6CiAgICBpbXBvcnQgc3NsCiAgICBIQVNfU1NMID0gVHJ1ZQpleGNlcHQ6CiAgICBIQVNfU1NMID0gRmFsc2UKCnRyeToKICAgICMgU05JIEhhbmRsaW5nIG5lZWRzIHB5dGhvbjIuNy45J3MgU1NMQ29udGV4dAogICAgZnJvbSBzc2wgaW1wb3J0IGNyZWF0ZV9kZWZhdWx0X2NvbnRleHQsIFNTTENvbnRleHQKICAgIEhBU19TU0xDT05URVhUID0gVHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBIQVNfU1NMQ09OVEVYVCA9IEZhbHNlCgojIFNOSSBIYW5kbGluZyBmb3IgcHl0aG9uIDwgMi43Ljkgd2l0aCB1cmxsaWIzIHN1cHBvcnQKdHJ5OgogICAgIyB1cmxsaWIzPj0xLjE1CiAgICBIQVNfVVJMTElCM19TU0xfV1JBUF9TT0NLRVQgPSBGYWxzZQogICAgdHJ5OgogICAgICAgIGZyb20gdXJsbGliMy5jb250cmliLnB5b3BlbnNzbCBpbXBvcnQgUHlPcGVuU1NMQ29udGV4dAogICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgIGZyb20gcmVxdWVzdHMucGFja2FnZXMudXJsbGliMy5jb250cmliLnB5b3BlbnNzbCBpbXBvcnQgUHlPcGVuU1NMQ29udGV4dAogICAgSEFTX1VSTExJQjNfUFlPUEVOU1NMQ09OVEVYVCA9IFRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgIyB1cmxsaWIzPDEuMTUsPj0xLjYKICAgIEhBU19VUkxMSUIzX1BZT1BFTlNTTENPTlRFWFQgPSBGYWxzZQogICAgdHJ5OgogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSB1cmxsaWIzLmNvbnRyaWIucHlvcGVuc3NsIGltcG9ydCBzc2xfd3JhcF9zb2NrZXQKICAgICAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgICAgIGZyb20gcmVxdWVzdHMucGFja2FnZXMudXJsbGliMy5jb250cmliLnB5b3BlbnNzbCBpbXBvcnQgc3NsX3dyYXBfc29ja2V0CiAgICAgICAgSEFTX1VSTExJQjNfU1NMX1dSQVBfU09DS0VUID0gVHJ1ZQogICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgIHBhc3MKCiMgU2VsZWN0IGEgcHJvdG9jb2wgdGhhdCBpbmNsdWRlcyBhbGwgc2VjdXJlIHRscyBwcm90b2NvbHMKIyBFeGNsdWRlIGluc2VjdXJlIHNzbCBwcm90b2NvbHMgaWYgcG9zc2libGUKCmlmIEhBU19TU0w6CiAgICAjIElmIHdlIGNhbid0IGZpbmQgZXh0cmEgdGxzIG1ldGhvZHMsIHNzbC5QUk9UT0NPTF9UTFN2MSBpcyBzdWZmaWNpZW50CiAgICBQUk9UT0NPTCA9IHNzbC5QUk9UT0NPTF9UTFN2MQppZiBub3QgSEFTX1NTTENPTlRFWFQgYW5kIEhBU19TU0w6CiAgICB0cnk6CiAgICAgICAgaW1wb3J0IGN0eXBlcwogICAgICAgIGltcG9ydCBjdHlwZXMudXRpbAogICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICMgcHl0aG9uIDIuNCAobGlrZWx5IHJoZWw1IHdoaWNoIGRvZXNuJ3QgaGF2ZSB0bHMxLjEgc3VwcG9ydCBpbiBpdHMgb3BlbnNzbCkKICAgICAgICBwYXNzCiAgICBlbHNlOgogICAgICAgIGxpYnNzbF9uYW1lID0gY3R5cGVzLnV0aWwuZmluZF9saWJyYXJ5KCdzc2wnKQogICAgICAgIGxpYnNzbCA9IGN0eXBlcy5DRExMKGxpYnNzbF9uYW1lKQogICAgICAgIGZvciBtZXRob2QgaW4gKCdUTFN2MV8xX21ldGhvZCcsICdUTFN2MV8yX21ldGhvZCcpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBsaWJzc2xbbWV0aG9kXQogICAgICAgICAgICAgICAgIyBGb3VuZCBzb21ldGhpbmcgLSB3ZSdsbCBsZXQgb3BlbnNzbCBhdXRvbmVnb3RpYXRlIGFuZCBob3BlCiAgICAgICAgICAgICAgICAjIHRoZSBzZXJ2ZXIgaGFzIGRpc2FibGVkIHNzbHYyIGFuZCAzLiAgYmVzdCB3ZSBjYW4gZG8uCiAgICAgICAgICAgICAgICBQUk9UT0NPTCA9IHNzbC5QUk9UT0NPTF9TU0x2MjMKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBkZWwgbGlic3NsCgoKTE9BREVEX1ZFUklGWV9MT0NBVElPTlMgPSBzZXQoKQoKSEFTX01BVENIX0hPU1ROQU1FID0gVHJ1ZQp0cnk6CiAgICBmcm9tIHNzbCBpbXBvcnQgbWF0Y2hfaG9zdG5hbWUsIENlcnRpZmljYXRlRXJyb3IKZXhjZXB0IEltcG9ydEVycm9yOgogICAgdHJ5OgogICAgICAgIGZyb20gYmFja3BvcnRzLnNzbF9tYXRjaF9ob3N0bmFtZSBpbXBvcnQgbWF0Y2hfaG9zdG5hbWUsIENlcnRpZmljYXRlRXJyb3IKICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICBIQVNfTUFUQ0hfSE9TVE5BTUUgPSBGYWxzZQoKaWYgbm90IEhBU19NQVRDSF9IT1NUTkFNRToKICAgICMjIwogICAgIyMjIFRoZSBmb2xsb3dpbmcgYmxvY2sgb2YgY29kZSBpcyB1bmRlciB0aGUgdGVybXMgYW5kIGNvbmRpdGlvbnMgb2YgdGhlCiAgICAjIyMgUHl0aG9uIFNvZnR3YXJlIEZvdW5kYXRpb24gTGljZW5zZQogICAgIyMjCgogICAgIiIiVGhlIG1hdGNoX2hvc3RuYW1lKCkgZnVuY3Rpb24gZnJvbSBQeXRob24gMy40LCBlc3NlbnRpYWwgd2hlbiB1c2luZyBTU0wuIiIiCgogICAgY2xhc3MgQ2VydGlmaWNhdGVFcnJvcihWYWx1ZUVycm9yKToKICAgICAgICBwYXNzCgoKICAgIGRlZiBfZG5zbmFtZV9tYXRjaChkbiwgaG9zdG5hbWUsIG1heF93aWxkY2FyZHM9MSk6CiAgICAgICAgIiIiTWF0Y2hpbmcgYWNjb3JkaW5nIHRvIFJGQyA2MTI1LCBzZWN0aW9uIDYuNC4zCgogICAgICAgIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzYxMjUjc2VjdGlvbi02LjQuMwogICAgICAgICIiIgogICAgICAgIHBhdHMgPSBbXQogICAgICAgIGlmIG5vdCBkbjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICMgUG9ydGVkIGZyb20gcHl0aG9uMy1zeW50YXg6CiAgICAgICAgIyBsZWZ0bW9zdCwgKnJlbWFpbmRlciA9IGRuLnNwbGl0KHInLicpCiAgICAgICAgcGFydHMgPSBkbi5zcGxpdChyJy4nKQogICAgICAgIGxlZnRtb3N0ID0gcGFydHNbMF0KICAgICAgICByZW1haW5kZXIgPSBwYXJ0c1sxOl0KCiAgICAgICAgd2lsZGNhcmRzID0gbGVmdG1vc3QuY291bnQoJyonKQogICAgICAgIGlmIHdpbGRjYXJkcyA+IG1heF93aWxkY2FyZHM6CiAgICAgICAgICAgICMgSXNzdWUgIzE3OTgwOiBhdm9pZCBkZW5pYWxzIG9mIHNlcnZpY2UgYnkgcmVmdXNpbmcgbW9yZQogICAgICAgICAgICAjIHRoYW4gb25lIHdpbGRjYXJkIHBlciBmcmFnbWVudC4gIEEgc3VydmV5IG9mIGVzdGFibGlzaGVkCiAgICAgICAgICAgICMgcG9saWN5IGFtb25nIFNTTCBpbXBsZW1lbnRhdGlvbnMgc2hvd2VkIGl0IHRvIGJlIGEKICAgICAgICAgICAgIyByZWFzb25hYmxlIGNob2ljZS4KICAgICAgICAgICAgcmFpc2UgQ2VydGlmaWNhdGVFcnJvcigKICAgICAgICAgICAgICAgICJ0b28gbWFueSB3aWxkY2FyZHMgaW4gY2VydGlmaWNhdGUgRE5TIG5hbWU6ICIgKyByZXByKGRuKSkKCiAgICAgICAgIyBzcGVlZCB1cCBjb21tb24gY2FzZSB3L28gd2lsZGNhcmRzCiAgICAgICAgaWYgbm90IHdpbGRjYXJkczoKICAgICAgICAgICAgcmV0dXJuIGRuLmxvd2VyKCkgPT0gaG9zdG5hbWUubG93ZXIoKQoKICAgICAgICAjIFJGQyA2MTI1LCBzZWN0aW9uIDYuNC4zLCBzdWJpdGVtIDEuCiAgICAgICAgIyBUaGUgY2xpZW50IFNIT1VMRCBOT1QgYXR0ZW1wdCB0byBtYXRjaCBhIHByZXNlbnRlZCBpZGVudGlmaWVyIGluIHdoaWNoCiAgICAgICAgIyB0aGUgd2lsZGNhcmQgY2hhcmFjdGVyIGNvbXByaXNlcyBhIGxhYmVsIG90aGVyIHRoYW4gdGhlIGxlZnQtbW9zdCBsYWJlbC4KICAgICAgICBpZiBsZWZ0bW9zdCA9PSAnKic6CiAgICAgICAgICAgICMgV2hlbiAnKicgaXMgYSBmcmFnbWVudCBieSBpdHNlbGYsIGl0IG1hdGNoZXMgYSBub24tZW1wdHkgZG90bGVzcwogICAgICAgICAgICAjIGZyYWdtZW50LgogICAgICAgICAgICBwYXRzLmFwcGVuZCgnW14uXSsnKQogICAgICAgIGVsaWYgbGVmdG1vc3Quc3RhcnRzd2l0aCgneG4tLScpIG9yIGhvc3RuYW1lLnN0YXJ0c3dpdGgoJ3huLS0nKToKICAgICAgICAgICAgIyBSRkMgNjEyNSwgc2VjdGlvbiA2LjQuMywgc3ViaXRlbSAzLgogICAgICAgICAgICAjIFRoZSBjbGllbnQgU0hPVUxEIE5PVCBhdHRlbXB0IHRvIG1hdGNoIGEgcHJlc2VudGVkIGlkZW50aWZpZXIKICAgICAgICAgICAgIyB3aGVyZSB0aGUgd2lsZGNhcmQgY2hhcmFjdGVyIGlzIGVtYmVkZGVkIHdpdGhpbiBhbiBBLWxhYmVsIG9yCiAgICAgICAgICAgICMgVS1sYWJlbCBvZiBhbiBpbnRlcm5hdGlvbmFsaXplZCBkb21haW4gbmFtZS4KICAgICAgICAgICAgcGF0cy5hcHBlbmQocmUuZXNjYXBlKGxlZnRtb3N0KSkKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIE90aGVyd2lzZSwgJyonIG1hdGNoZXMgYW55IGRvdGxlc3Mgc3RyaW5nLCBlLmcuIHd3dyoKICAgICAgICAgICAgcGF0cy5hcHBlbmQocmUuZXNjYXBlKGxlZnRtb3N0KS5yZXBsYWNlKHInXConLCAnW14uXSonKSkKCiAgICAgICAgIyBhZGQgdGhlIHJlbWFpbmluZyBmcmFnbWVudHMsIGlnbm9yZSBhbnkgd2lsZGNhcmRzCiAgICAgICAgZm9yIGZyYWcgaW4gcmVtYWluZGVyOgogICAgICAgICAgICBwYXRzLmFwcGVuZChyZS5lc2NhcGUoZnJhZykpCgogICAgICAgIHBhdCA9IHJlLmNvbXBpbGUocidcQScgKyByJ1wuJy5qb2luKHBhdHMpICsgcidcWicsIHJlLklHTk9SRUNBU0UpCiAgICAgICAgcmV0dXJuIHBhdC5tYXRjaChob3N0bmFtZSkKCgogICAgZGVmIG1hdGNoX2hvc3RuYW1lKGNlcnQsIGhvc3RuYW1lKToKICAgICAgICAiIiJWZXJpZnkgdGhhdCAqY2VydCogKGluIGRlY29kZWQgZm9ybWF0IGFzIHJldHVybmVkIGJ5CiAgICAgICAgU1NMU29ja2V0LmdldHBlZXJjZXJ0KCkpIG1hdGNoZXMgdGhlICpob3N0bmFtZSouICBSRkMgMjgxOCBhbmQgUkZDIDYxMjUKICAgICAgICBydWxlcyBhcmUgZm9sbG93ZWQsIGJ1dCBJUCBhZGRyZXNzZXMgYXJlIG5vdCBhY2NlcHRlZCBmb3IgKmhvc3RuYW1lKi4KCiAgICAgICAgQ2VydGlmaWNhdGVFcnJvciBpcyByYWlzZWQgb24gZmFpbHVyZS4gT24gc3VjY2VzcywgdGhlIGZ1bmN0aW9uCiAgICAgICAgcmV0dXJucyBub3RoaW5nLgogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBjZXJ0OgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJlbXB0eSBvciBubyBjZXJ0aWZpY2F0ZSIpCiAgICAgICAgZG5zbmFtZXMgPSBbXQogICAgICAgIHNhbiA9IGNlcnQuZ2V0KCdzdWJqZWN0QWx0TmFtZScsICgpKQogICAgICAgIGZvciBrZXksIHZhbHVlIGluIHNhbjoKICAgICAgICAgICAgaWYga2V5ID09ICdETlMnOgogICAgICAgICAgICAgICAgaWYgX2Ruc25hbWVfbWF0Y2godmFsdWUsIGhvc3RuYW1lKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIGRuc25hbWVzLmFwcGVuZCh2YWx1ZSkKICAgICAgICBpZiBub3QgZG5zbmFtZXM6CiAgICAgICAgICAgICMgVGhlIHN1YmplY3QgaXMgb25seSBjaGVja2VkIHdoZW4gdGhlcmUgaXMgbm8gZE5TTmFtZSBlbnRyeQogICAgICAgICAgICAjIGluIHN1YmplY3RBbHROYW1lCiAgICAgICAgICAgIGZvciBzdWIgaW4gY2VydC5nZXQoJ3N1YmplY3QnLCAoKSk6CiAgICAgICAgICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBzdWI6CiAgICAgICAgICAgICAgICAgICAgIyBYWFggYWNjb3JkaW5nIHRvIFJGQyAyODE4LCB0aGUgbW9zdCBzcGVjaWZpYyBDb21tb24gTmFtZQogICAgICAgICAgICAgICAgICAgICMgbXVzdCBiZSB1c2VkLgogICAgICAgICAgICAgICAgICAgIGlmIGtleSA9PSAnY29tbW9uTmFtZSc6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIF9kbnNuYW1lX21hdGNoKHZhbHVlLCBob3N0bmFtZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgICAgICAgICAgZG5zbmFtZXMuYXBwZW5kKHZhbHVlKQogICAgICAgIGlmIGxlbihkbnNuYW1lcykgPiAxOgogICAgICAgICAgICByYWlzZSBDZXJ0aWZpY2F0ZUVycm9yKCJob3N0bmFtZSAlciAiCiAgICAgICAgICAgICAgICAiZG9lc24ndCBtYXRjaCBlaXRoZXIgb2YgJXMiCiAgICAgICAgICAgICAgICAlIChob3N0bmFtZSwgJywgJy5qb2luKG1hcChyZXByLCBkbnNuYW1lcykpKSkKICAgICAgICBlbGlmIGxlbihkbnNuYW1lcykgPT0gMToKICAgICAgICAgICAgcmFpc2UgQ2VydGlmaWNhdGVFcnJvcigiaG9zdG5hbWUgJXIgIgogICAgICAgICAgICAgICAgImRvZXNuJ3QgbWF0Y2ggJXIiCiAgICAgICAgICAgICAgICAlIChob3N0bmFtZSwgZG5zbmFtZXNbMF0pKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIENlcnRpZmljYXRlRXJyb3IoIm5vIGFwcHJvcHJpYXRlIGNvbW1vbk5hbWUgb3IgIgogICAgICAgICAgICAgICAgInN1YmplY3RBbHROYW1lIGZpZWxkcyB3ZXJlIGZvdW5kIikKCiAgICAjIyMKICAgICMjIyBFbmQgb2YgUHl0aG9uIFNvZnR3YXJlIEZvdW5kYXRpb24gTGljZW5zZWQgY29kZQogICAgIyMjCgogICAgSEFTX01BVENIX0hPU1ROQU1FID0gVHJ1ZQoKCiMgVGhpcyBpcyBhIGR1bW15IGNhY2VydCBwcm92aWRlZCBmb3IgTWFjIE9TIHNpbmNlIHlvdSBuZWVkIGF0IGxlYXN0IDEKIyBjYSBjZXJ0LCByZWdhcmRsZXNzIG9mIHZhbGlkaXR5LCBmb3IgUHl0aG9uIG9uIE1hYyBPUyB0byB1c2UgdGhlCiMga2V5Y2hhaW4gZnVuY3Rpb25hbGl0eSBpbiBPcGVuU1NMIGZvciB2YWxpZGF0aW5nIFNTTCBjZXJ0aWZpY2F0ZXMuCiMgU2VlOiBodHRwOi8vbWVyY3VyaWFsLnNlbGVuaWMuY29tL3dpa2kvQ0FDZXJ0aWZpY2F0ZXMjTWFjX09TX1hfMTAuNl9hbmRfaGlnaGVyCmJfRFVNTVlfQ0FfQ0VSVCA9IGIoIiIiLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWlXZ0F3SUJBZ0lKQU84RTEyUzcvcUVwTUEwR0NTcUdTSWIzRFFFQkJRVUFNRWt4Q3pBSkJnTlYKQkFZVEFsVlRNUmN3RlFZRFZRUUlFdzVPYjNKMGFDQkRZWEp2YkdsdVlURVBNQTBHQTFVRUJ4TUdSSFZ5YUdGdApNUkF3RGdZRFZRUUtFd2RCYm5OcFlteGxNQjRYRFRFME1ETXhPREl5TURBeU1sb1hEVEkwTURNeE5USXlNREF5Ck1sb3dTVEVMTUFrR0ExVUVCaE1DVlZNeEZ6QVZCZ05WQkFnVERrNXZjblJvSUVOaGNtOXNhVzVoTVE4d0RRWUQKVlFRSEV3WkVkWEpvWVcweEVEQU9CZ05WQkFvVEIwRnVjMmxpYkdVd2daOHdEUVlKS29aSWh2Y05BUUVCQlFBRApnWTBBTUlHSkFvR0JBTnR2cFBxM0lsTmxSYkNIaFpBY1A2V0N6aGM1UmJzRHF5aDF6cmttTGkwR3djUTN6L3I5CmdhV2ZRQlloSHBvYksyVGlxMTFUZnJhSGVOQjMvVmZOSW1qWmNHcE44RmwzTVd3dTdMZlZrSnkzZ05ObnhrQTEKNEdvMC9MbUl2UkZIaGJ6Z2Z1bzlORmdqUG1tYWI5ZXFYSmNlcVpJbHoyQzh4QTdFZUc3a3UwK3ZBZ01CQUFHagpnYXN3Z2Fnd0hRWURWUjBPQkJZRUZQbk4xblBScU5EWEdsQ3FDdmRaY2hSTmkvRmFNSGtHQTFVZEl3UnlNSENBCkZQbk4xblBScU5EWEdsQ3FDdmRaY2hSTmkvRmFvVTJrU3pCSk1Rc3dDUVlEVlFRR0V3SlZVekVYTUJVR0ExVUUKQ0JNT1RtOXlkR2dnUTJGeWIyeHBibUV4RHpBTkJnTlZCQWNUQmtSMWNtaGhiVEVRTUE0R0ExVUVDaE1IUVc1egphV0pzWllJSkFPOEUxMlM3L3FFcE1Bd0dBMVVkRXdRRk1BTUJBZjh3RFFZSktvWklodmNOQVFFRkJRQURnWUVBCk1VQjgwSVI2a25xOUsvdFkraHZQc1plcjZlRk16TzNKR2tSRkJoMmtuNkpkTURuaFlHWDdBWFZIR2ZscndOUUgKcUZ5K2FlbldYc0MwWnZyaWtGeGJRblg4R1Z0REFEdFZ6bnhPaTdYekZ3N0pPeGRzVnJwWGdTTjBlaDBhTXp2Vgp6S1Bac1oybWlWR2NsaWNKSHptNXEwODBiMXAvc1p0dUtJRVprNnZacUVnPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCiIiIikKCiMKIyBFeGNlcHRpb25zCiMKCgpjbGFzcyBDb25uZWN0aW9uRXJyb3IoRXhjZXB0aW9uKToKICAgICIiIkZhaWxlZCB0byBjb25uZWN0IHRvIHRoZSBzZXJ2ZXIiIiIKICAgIHBhc3MKCgpjbGFzcyBQcm94eUVycm9yKENvbm5lY3Rpb25FcnJvcik6CiAgICAiIiJGYWlsdXJlIHRvIGNvbm5lY3QgYmVjYXVzZSBvZiBhIHByb3h5IiIiCiAgICBwYXNzCgoKY2xhc3MgU1NMVmFsaWRhdGlvbkVycm9yKENvbm5lY3Rpb25FcnJvcik6CiAgICAiIiJGYWlsdXJlIHRvIGNvbm5lY3QgZHVlIHRvIFNTTCB2YWxpZGF0aW9uIGZhaWxpbmciIiIKICAgIHBhc3MKCgpjbGFzcyBOb1NTTEVycm9yKFNTTFZhbGlkYXRpb25FcnJvcik6CiAgICAiIiJOZWVkZWQgdG8gY29ubmVjdCB0byBhbiBIVFRQUyB1cmwgYnV0IG5vIHNzbCBsaWJyYXJ5IGF2YWlsYWJsZSB0byB2ZXJpZnkgdGhlIGNlcnRpZmljYXRlIiIiCiAgICBwYXNzCgojIFNvbWUgZW52aXJvbm1lbnRzIChHb29nbGUgQ29tcHV0ZSBFbmdpbmUncyBDb3JlT1MgZGVwbG95cykgZG8gbm90IGNvbXBpbGUKIyBhZ2FpbnN0IG9wZW5zc2wgYW5kIHRodXMgZG8gbm90IGhhdmUgYW55IEhUVFBTIHN1cHBvcnQuCkN1c3RvbUhUVFBTQ29ubmVjdGlvbiA9IEN1c3RvbUhUVFBTSGFuZGxlciA9IE5vbmUKaWYgaGFzYXR0cihodHRwbGliLCAnSFRUUFNDb25uZWN0aW9uJykgYW5kIGhhc2F0dHIodXJsbGliX3JlcXVlc3QsICdIVFRQU0hhbmRsZXInKToKICAgIGNsYXNzIEN1c3RvbUhUVFBTQ29ubmVjdGlvbihodHRwbGliLkhUVFBTQ29ubmVjdGlvbik6CiAgICAgICAgZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgICAgIGh0dHBsaWIuSFRUUFNDb25uZWN0aW9uLl9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncykKICAgICAgICAgICAgc2VsZi5jb250ZXh0ID0gTm9uZQogICAgICAgICAgICBpZiBIQVNfU1NMQ09OVEVYVDoKICAgICAgICAgICAgICAgIHNlbGYuY29udGV4dCA9IGNyZWF0ZV9kZWZhdWx0X2NvbnRleHQoKQogICAgICAgICAgICBlbGlmIEhBU19VUkxMSUIzX1BZT1BFTlNTTENPTlRFWFQ6CiAgICAgICAgICAgICAgICBzZWxmLmNvbnRleHQgPSBQeU9wZW5TU0xDb250ZXh0KFBST1RPQ09MKQogICAgICAgICAgICBpZiBzZWxmLmNvbnRleHQgYW5kIHNlbGYuY2VydF9maWxlOgogICAgICAgICAgICAgICAgc2VsZi5jb250ZXh0LmxvYWRfY2VydF9jaGFpbihzZWxmLmNlcnRfZmlsZSwgc2VsZi5rZXlfZmlsZSkKCiAgICAgICAgZGVmIGNvbm5lY3Qoc2VsZik6CiAgICAgICAgICAgICJDb25uZWN0IHRvIGEgaG9zdCBvbiBhIGdpdmVuIChTU0wpIHBvcnQuIgoKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnc291cmNlX2FkZHJlc3MnKToKICAgICAgICAgICAgICAgIHNvY2sgPSBzb2NrZXQuY3JlYXRlX2Nvbm5lY3Rpb24oKHNlbGYuaG9zdCwgc2VsZi5wb3J0KSwgc2VsZi50aW1lb3V0LCBzZWxmLnNvdXJjZV9hZGRyZXNzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc29jayA9IHNvY2tldC5jcmVhdGVfY29ubmVjdGlvbigoc2VsZi5ob3N0LCBzZWxmLnBvcnQpLCBzZWxmLnRpbWVvdXQpCgogICAgICAgICAgICBzZXJ2ZXJfaG9zdG5hbWUgPSBzZWxmLmhvc3QKICAgICAgICAgICAgIyBOb3RlOiBzZWxmLl90dW5uZWxfaG9zdCBpcyBub3QgYXZhaWxhYmxlIG9uIHB5IDwgMi42IGJ1dCB0aGlzIGNvZGUKICAgICAgICAgICAgIyBpc24ndCB1c2VkIG9uIHB5IDwgMi42IChsYWNrIG9mIGNyZWF0ZV9jb25uZWN0aW9uKQogICAgICAgICAgICBpZiBzZWxmLl90dW5uZWxfaG9zdDoKICAgICAgICAgICAgICAgIHNlbGYuc29jayA9IHNvY2sKICAgICAgICAgICAgICAgIHNlbGYuX3R1bm5lbCgpCiAgICAgICAgICAgICAgICBzZXJ2ZXJfaG9zdG5hbWUgPSBzZWxmLl90dW5uZWxfaG9zdAoKICAgICAgICAgICAgaWYgSEFTX1NTTENPTlRFWFQgb3IgSEFTX1VSTExJQjNfUFlPUEVOU1NMQ09OVEVYVDoKICAgICAgICAgICAgICAgIHNlbGYuc29jayA9IHNlbGYuY29udGV4dC53cmFwX3NvY2tldChzb2NrLCBzZXJ2ZXJfaG9zdG5hbWU9c2VydmVyX2hvc3RuYW1lKQogICAgICAgICAgICBlbGlmIEhBU19VUkxMSUIzX1NTTF9XUkFQX1NPQ0tFVDoKICAgICAgICAgICAgICAgIHNlbGYuc29jayA9IHNzbF93cmFwX3NvY2tldChzb2NrLCBrZXlmaWxlPXNlbGYua2V5X2ZpbGUsIGNlcnRfcmVxcz1zc2wuQ0VSVF9OT05FLCBjZXJ0ZmlsZT1zZWxmLmNlcnRfZmlsZSwgc3NsX3ZlcnNpb249UFJPVE9DT0wsCiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlcl9ob3N0bmFtZT1zZXJ2ZXJfaG9zdG5hbWUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLnNvY2sgPSBzc2wud3JhcF9zb2NrZXQoc29jaywga2V5ZmlsZT1zZWxmLmtleV9maWxlLCBjZXJ0ZmlsZT1zZWxmLmNlcnRfZmlsZSwgc3NsX3ZlcnNpb249UFJPVE9DT0wpCgogICAgY2xhc3MgQ3VzdG9tSFRUUFNIYW5kbGVyKHVybGxpYl9yZXF1ZXN0LkhUVFBTSGFuZGxlcik6CgogICAgICAgIGRlZiBodHRwc19vcGVuKHNlbGYsIHJlcSk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmRvX29wZW4oQ3VzdG9tSFRUUFNDb25uZWN0aW9uLCByZXEpCgogICAgICAgIGh0dHBzX3JlcXVlc3QgPSBBYnN0cmFjdEhUVFBIYW5kbGVyLmRvX3JlcXVlc3RfCgoKY2xhc3MgSFRUUFNDbGllbnRBdXRoSGFuZGxlcih1cmxsaWJfcmVxdWVzdC5IVFRQU0hhbmRsZXIpOgogICAgJycnSGFuZGxlcyBjbGllbnQgYXV0aGVudGljYXRpb24gdmlhIGNlcnQva2V5CgogICAgVGhpcyBpcyBhIGZhaXJseSBsaWdodHdlaWdodCBleHRlbnNpb24gb24gSFRUUFNIYW5kbGVyLCBhbmQgY2FuIGJlIHVzZWQKICAgIGluIHBsYWNlIG9mIEhUVFBTSGFuZGxlcgogICAgJycnCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNsaWVudF9jZXJ0PU5vbmUsIGNsaWVudF9rZXk9Tm9uZSwgKiprd2FyZ3MpOgogICAgICAgIHVybGxpYl9yZXF1ZXN0LkhUVFBTSGFuZGxlci5fX2luaXRfXyhzZWxmLCAqKmt3YXJncykKICAgICAgICBzZWxmLmNsaWVudF9jZXJ0ID0gY2xpZW50X2NlcnQKICAgICAgICBzZWxmLmNsaWVudF9rZXkgPSBjbGllbnRfa2V5CgogICAgZGVmIGh0dHBzX29wZW4oc2VsZiwgcmVxKToKICAgICAgICByZXR1cm4gc2VsZi5kb19vcGVuKHNlbGYuX2J1aWxkX2h0dHBzX2Nvbm5lY3Rpb24sIHJlcSkKCiAgICBkZWYgX2J1aWxkX2h0dHBzX2Nvbm5lY3Rpb24oc2VsZiwgaG9zdCwgKiprd2FyZ3MpOgogICAgICAgIGt3YXJncy51cGRhdGUoewogICAgICAgICAgICAnY2VydF9maWxlJzogc2VsZi5jbGllbnRfY2VydCwKICAgICAgICAgICAgJ2tleV9maWxlJzogc2VsZi5jbGllbnRfa2V5LAogICAgICAgIH0pCiAgICAgICAgdHJ5OgogICAgICAgICAgICBrd2FyZ3NbJ2NvbnRleHQnXSA9IHNlbGYuX2NvbnRleHQKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gaHR0cGxpYi5IVFRQU0Nvbm5lY3Rpb24oaG9zdCwgKiprd2FyZ3MpCgoKZGVmIGdlbmVyaWNfdXJscGFyc2UocGFydHMpOgogICAgJycnCiAgICBSZXR1cm5zIGEgZGljdGlvbmFyeSBvZiB1cmwgcGFydHMgYXMgcGFyc2VkIGJ5IHVybHBhcnNlLAogICAgYnV0IGFjY291bnRzIGZvciB0aGUgZmFjdCB0aGF0IG9sZGVyIHZlcnNpb25zIG9mIHRoYXQKICAgIGxpYnJhcnkgZG8gbm90IHN1cHBvcnQgbmFtZWQgYXR0cmlidXRlcyAoaWUuIC5uZXRsb2MpCiAgICAnJycKICAgIGdlbmVyaWNfcGFydHMgPSBkaWN0KCkKICAgIGlmIGhhc2F0dHIocGFydHMsICduZXRsb2MnKToKICAgICAgICAjIHVybHBhcnNlIGlzIG5ld2VyLCBqdXN0IHJlYWQgdGhlIGZpZWxkcyBzdHJhaWdodAogICAgICAgICMgZnJvbSB0aGUgcGFydHMgb2JqZWN0CiAgICAgICAgZ2VuZXJpY19wYXJ0c1snc2NoZW1lJ10gICA9IHBhcnRzLnNjaGVtZQogICAgICAgIGdlbmVyaWNfcGFydHNbJ25ldGxvYyddICAgPSBwYXJ0cy5uZXRsb2MKICAgICAgICBnZW5lcmljX3BhcnRzWydwYXRoJ10gICAgID0gcGFydHMucGF0aAogICAgICAgIGdlbmVyaWNfcGFydHNbJ3BhcmFtcyddICAgPSBwYXJ0cy5wYXJhbXMKICAgICAgICBnZW5lcmljX3BhcnRzWydxdWVyeSddICAgID0gcGFydHMucXVlcnkKICAgICAgICBnZW5lcmljX3BhcnRzWydmcmFnbWVudCddID0gcGFydHMuZnJhZ21lbnQKICAgICAgICBnZW5lcmljX3BhcnRzWyd1c2VybmFtZSddID0gcGFydHMudXNlcm5hbWUKICAgICAgICBnZW5lcmljX3BhcnRzWydwYXNzd29yZCddID0gcGFydHMucGFzc3dvcmQKICAgICAgICBnZW5lcmljX3BhcnRzWydob3N0bmFtZSddID0gcGFydHMuaG9zdG5hbWUKICAgICAgICBnZW5lcmljX3BhcnRzWydwb3J0J10gICAgID0gcGFydHMucG9ydAogICAgZWxzZToKICAgICAgICAjIHdlIGhhdmUgdG8gdXNlIGluZGV4ZXMsIGFuZCB0aGVuIHBhcnNlIG91dAogICAgICAgICMgdGhlIG90aGVyIHBhcnRzIG5vdCBzdXBwb3J0ZWQgYnkgaW5kZXhpbmcKICAgICAgICBnZW5lcmljX3BhcnRzWydzY2hlbWUnXSAgID0gcGFydHNbMF0KICAgICAgICBnZW5lcmljX3BhcnRzWyduZXRsb2MnXSAgID0gcGFydHNbMV0KICAgICAgICBnZW5lcmljX3BhcnRzWydwYXRoJ10gICAgID0gcGFydHNbMl0KICAgICAgICBnZW5lcmljX3BhcnRzWydwYXJhbXMnXSAgID0gcGFydHNbM10KICAgICAgICBnZW5lcmljX3BhcnRzWydxdWVyeSddICAgID0gcGFydHNbNF0KICAgICAgICBnZW5lcmljX3BhcnRzWydmcmFnbWVudCddID0gcGFydHNbNV0KICAgICAgICAjIGdldCB0aGUgdXNlcm5hbWUsIHBhc3N3b3JkLCBldGMuCiAgICAgICAgdHJ5OgogICAgICAgICAgICBuZXRsb2NfcmUgPSByZS5jb21waWxlKHInXigoPzpcdykrKD86Oig/Olx3KSspP0ApPyhbQS1aYS16MC05Li1dKykoOlxkKyk/JCcpCiAgICAgICAgICAgIG1hdGNoID0gbmV0bG9jX3JlLm1hdGNoKHBhcnRzWzFdKQogICAgICAgICAgICBhdXRoID0gbWF0Y2guZ3JvdXAoMSkKICAgICAgICAgICAgaG9zdG5hbWUgPSBtYXRjaC5ncm91cCgyKQogICAgICAgICAgICBwb3J0ID0gbWF0Y2guZ3JvdXAoMykKICAgICAgICAgICAgaWYgcG9ydDoKICAgICAgICAgICAgICAgICMgdGhlIGNhcHR1cmUgZ3JvdXAgZm9yIHRoZSBwb3J0IHdpbGwgaW5jbHVkZSB0aGUgJzonLAogICAgICAgICAgICAgICAgIyBzbyByZW1vdmUgaXQgYW5kIGNvbnZlcnQgdGhlIHBvcnQgdG8gYW4gaW50ZWdlcgogICAgICAgICAgICAgICAgcG9ydCA9IGludChwb3J0WzE6XSkKICAgICAgICAgICAgaWYgYXV0aDoKICAgICAgICAgICAgICAgICMgdGhlIGNhcHR1cmUgZ3JvdXAgYWJvdmUgaW5jbHVlcyB0aGUgQCwgc28gcmVtb3ZlIGl0CiAgICAgICAgICAgICAgICAjIGFuZCB0aGVuIHNwbGl0IGl0IHVwIGJhc2VkIG9uIHRoZSBmaXJzdCAnOicgZm91bmQKICAgICAgICAgICAgICAgIGF1dGggPSBhdXRoWzotMV0KICAgICAgICAgICAgICAgIHVzZXJuYW1lLCBwYXNzd29yZCA9IGF1dGguc3BsaXQoJzonLCAxKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBwYXNzd29yZCA9IE5vbmUKICAgICAgICAgICAgZ2VuZXJpY19wYXJ0c1sndXNlcm5hbWUnXSA9IHVzZXJuYW1lCiAgICAgICAgICAgIGdlbmVyaWNfcGFydHNbJ3Bhc3N3b3JkJ10gPSBwYXNzd29yZAogICAgICAgICAgICBnZW5lcmljX3BhcnRzWydob3N0bmFtZSddID0gaG9zdG5hbWUKICAgICAgICAgICAgZ2VuZXJpY19wYXJ0c1sncG9ydCddICAgICA9IHBvcnQKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIGdlbmVyaWNfcGFydHNbJ3VzZXJuYW1lJ10gPSBOb25lCiAgICAgICAgICAgIGdlbmVyaWNfcGFydHNbJ3Bhc3N3b3JkJ10gPSBOb25lCiAgICAgICAgICAgIGdlbmVyaWNfcGFydHNbJ2hvc3RuYW1lJ10gPSBwYXJ0c1sxXQogICAgICAgICAgICBnZW5lcmljX3BhcnRzWydwb3J0J10gICAgID0gTm9uZQogICAgcmV0dXJuIGdlbmVyaWNfcGFydHMKCgpjbGFzcyBSZXF1ZXN0V2l0aE1ldGhvZCh1cmxsaWJfcmVxdWVzdC5SZXF1ZXN0KToKICAgICcnJwogICAgV29ya2Fyb3VuZCBmb3IgdXNpbmcgREVMRVRFL1BVVC9ldGMgd2l0aCB1cmxsaWIyCiAgICBPcmlnaW5hbGx5IGNvbnRhaW5lZCBpbiBsaWJyYXJ5L25ldF9pbmZyYXN0cnVjdHVyZS9kbnNtYWRlZWFzeQogICAgJycnCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHVybCwgbWV0aG9kLCBkYXRhPU5vbmUsIGhlYWRlcnM9Tm9uZSk6CiAgICAgICAgaWYgaGVhZGVycyBpcyBOb25lOgogICAgICAgICAgICBoZWFkZXJzID0ge30KICAgICAgICBzZWxmLl9tZXRob2QgPSBtZXRob2QudXBwZXIoKQogICAgICAgIHVybGxpYl9yZXF1ZXN0LlJlcXVlc3QuX19pbml0X18oc2VsZiwgdXJsLCBkYXRhLCBoZWFkZXJzKQoKICAgIGRlZiBnZXRfbWV0aG9kKHNlbGYpOgogICAgICAgIGlmIHNlbGYuX21ldGhvZDoKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX21ldGhvZAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiB1cmxsaWJfcmVxdWVzdC5SZXF1ZXN0LmdldF9tZXRob2Qoc2VsZikKCgpkZWYgUmVkaXJlY3RIYW5kbGVyRmFjdG9yeShmb2xsb3dfcmVkaXJlY3RzPU5vbmUsIHZhbGlkYXRlX2NlcnRzPVRydWUpOgogICAgIiIiVGhpcyBpcyBhIGNsYXNzIGZhY3RvcnkgdGhhdCBjbG9zZXMgb3ZlciB0aGUgdmFsdWUgb2YKICAgIGBgZm9sbG93X3JlZGlyZWN0c2BgIHNvIHRoYXQgdGhlIFJlZGlyZWN0SGFuZGxlciBjbGFzcyBoYXMgYWNjZXNzIHRvCiAgICB0aGF0IHZhbHVlIHdpdGhvdXQgaGF2aW5nIHRvIHVzZSBnbG9iYWxzLCBhbmQgcG90ZW50aWFsbHkgY2F1c2UgcHJvYmxlbXMKICAgIHdoZXJlIGBgb3Blbl91cmxgYCBvciBgYGZldGNoX3VybGBgIGFyZSB1c2VkIG11bHRpcGxlIHRpbWVzIGluIGEgbW9kdWxlLgogICAgIiIiCgogICAgY2xhc3MgUmVkaXJlY3RIYW5kbGVyKHVybGxpYl9yZXF1ZXN0LkhUVFBSZWRpcmVjdEhhbmRsZXIpOgogICAgICAgICIiIlRoaXMgaXMgYW4gaW1wbGVtZW50YXRpb24gb2YgYSBSZWRpcmVjdEhhbmRsZXIgdG8gbWF0Y2ggdGhlCiAgICAgICAgZnVuY3Rpb25hbGl0eSBwcm92aWRlZCBieSBodHRwbGliMi4gSXQgd2lsbCB1dGlsaXplIHRoZSB2YWx1ZSBvZgogICAgICAgIGBgZm9sbG93X3JlZGlyZWN0c2BgIHRoYXQgaXMgcGFzc2VkIGludG8gYGBSZWRpcmVjdEhhbmRsZXJGYWN0b3J5YGAKICAgICAgICB0byBkZXRlcm1pbmUgaG93IHJlZGlyZWN0cyBzaG91bGQgYmUgaGFuZGxlZCBpbiB1cmxsaWIyLgogICAgICAgICIiIgoKICAgICAgICBkZWYgcmVkaXJlY3RfcmVxdWVzdChzZWxmLCByZXEsIGZwLCBjb2RlLCBtc2csIGhkcnMsIG5ld3VybCk6CiAgICAgICAgICAgIGhhbmRsZXIgPSBtYXliZV9hZGRfc3NsX2hhbmRsZXIobmV3dXJsLCB2YWxpZGF0ZV9jZXJ0cykKICAgICAgICAgICAgaWYgaGFuZGxlcjoKICAgICAgICAgICAgICAgIHVybGxpYl9yZXF1ZXN0Ll9vcGVuZXIuYWRkX2hhbmRsZXIoaGFuZGxlcikKCiAgICAgICAgICAgIGlmIGZvbGxvd19yZWRpcmVjdHMgPT0gJ3VybGxpYjInOgogICAgICAgICAgICAgICAgcmV0dXJuIHVybGxpYl9yZXF1ZXN0LkhUVFBSZWRpcmVjdEhhbmRsZXIucmVkaXJlY3RfcmVxdWVzdChzZWxmLCByZXEsIGZwLCBjb2RlLCBtc2csIGhkcnMsIG5ld3VybCkKICAgICAgICAgICAgZWxpZiBmb2xsb3dfcmVkaXJlY3RzIGluIFsnbm8nLCAnbm9uZScsIEZhbHNlXToKICAgICAgICAgICAgICAgIHJhaXNlIHVybGxpYl9lcnJvci5IVFRQRXJyb3IobmV3dXJsLCBjb2RlLCBtc2csIGhkcnMsIGZwKQoKICAgICAgICAgICAgZG9fcmVkaXJlY3QgPSBGYWxzZQogICAgICAgICAgICBpZiBmb2xsb3dfcmVkaXJlY3RzIGluIFsnYWxsJywgJ3llcycsIFRydWVdOgogICAgICAgICAgICAgICAgZG9fcmVkaXJlY3QgPSAoY29kZSA+PSAzMDAgYW5kIGNvZGUgPCA0MDApCgogICAgICAgICAgICBlbGlmIGZvbGxvd19yZWRpcmVjdHMgPT0gJ3NhZmUnOgogICAgICAgICAgICAgICAgbSA9IHJlcS5nZXRfbWV0aG9kKCkKICAgICAgICAgICAgICAgIGRvX3JlZGlyZWN0ID0gKGNvZGUgPj0gMzAwIGFuZCBjb2RlIDwgNDAwIGFuZCBtIGluICgnR0VUJywgJ0hFQUQnKSkKCiAgICAgICAgICAgIGlmIGRvX3JlZGlyZWN0OgogICAgICAgICAgICAgICAgIyBiZSBjb25jaWxpYW50IHdpdGggVVJJcyBjb250YWluaW5nIGEgc3BhY2UKICAgICAgICAgICAgICAgIG5ld3VybCA9IG5ld3VybC5yZXBsYWNlKCcgJywgJyUyMCcpCiAgICAgICAgICAgICAgICBuZXdoZWFkZXJzID0gZGljdCgoayx2KSBmb3Igayx2IGluIHJlcS5oZWFkZXJzLml0ZW1zKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGsubG93ZXIoKSBub3QgaW4gKCJjb250ZW50LWxlbmd0aCIsICJjb250ZW50LXR5cGUiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyBQeXRob24gMi0zLjMKICAgICAgICAgICAgICAgICAgICBvcmlnaW5fcmVxX2hvc3QgPSByZXEuZ2V0X29yaWdpbl9yZXFfaG9zdCgpCiAgICAgICAgICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgIyBQeXRob24gMy40KwogICAgICAgICAgICAgICAgICAgIG9yaWdpbl9yZXFfaG9zdCA9IHJlcS5vcmlnaW5fcmVxX2hvc3QKICAgICAgICAgICAgICAgIHJldHVybiB1cmxsaWJfcmVxdWVzdC5SZXF1ZXN0KG5ld3VybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9bmV3aGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbl9yZXFfaG9zdD1vcmlnaW5fcmVxX2hvc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bnZlcmlmaWFibGU9VHJ1ZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJhaXNlIHVybGxpYl9lcnJvci5IVFRQRXJyb3IocmVxLmdldF9mdWxsX3VybCgpLCBjb2RlLCBtc2csIGhkcnMsIGZwKQoKICAgIHJldHVybiBSZWRpcmVjdEhhbmRsZXIKCgpkZWYgYnVpbGRfc3NsX3ZhbGlkYXRpb25fZXJyb3IoaG9zdG5hbWUsIHBvcnQsIHBhdGhzLCBleGM9Tm9uZSk6CiAgICAnJydJbnRlbGlnZW50bHkgYnVpbGQgb3V0IHRoZSBTU0xWYWxpZGF0aW9uRXJyb3IgYmFzZWQgb24gd2hhdCBzdXBwb3J0CiAgICB5b3UgaGF2ZSBpbnN0YWxsZWQKICAgICcnJwoKICAgIG1zZyA9IFsKICAgICAgICAoJ0ZhaWxlZCB0byB2YWxpZGF0ZSB0aGUgU1NMIGNlcnRpZmljYXRlIGZvciAlczolcy4nCiAgICAgICAgICcgTWFrZSBzdXJlIHlvdXIgbWFuYWdlZCBzeXN0ZW1zIGhhdmUgYSB2YWxpZCBDQScKICAgICAgICAgJyBjZXJ0aWZpY2F0ZSBpbnN0YWxsZWQuJykKICAgIF0KICAgIGlmIG5vdCBIQVNfU1NMQ09OVEVYVDoKICAgICAgICBtc2cuYXBwZW5kKCdJZiB0aGUgd2Vic2l0ZSBzZXJ2aW5nIHRoZSB1cmwgdXNlcyBTTkkgeW91IG5lZWQnCiAgICAgICAgICAgICAgICAgICAnIHB5dGhvbiA+PSAyLjcuOSBvbiB5b3VyIG1hbmFnZWQgbWFjaGluZScpCiAgICAgICAgaWYgbm90IEhBU19VUkxMSUIzX1BZT1BFTlNTTENPTlRFWFQgb3Igbm90IEhBU19VUkxMSUIzX1NTTF9XUkFQX1NPQ0tFVDoKICAgICAgICAgICAgbXNnLmFwcGVuZCgnb3IgeW91IGNhbiBpbnN0YWxsIHRoZSBgdXJsbGliM2AsIGBweU9wZW5TU0xgLCcKICAgICAgICAgICAgICAgICAgICAgICAnIGBuZGctaHR0cHNjbGllbnRgLCBhbmQgYHB5YXNuMWAgcHl0aG9uIG1vZHVsZXMnKQoKICAgICAgICBtc2cuYXBwZW5kKCd0byBwZXJmb3JtIFNOSSB2ZXJpZmljYXRpb24gaW4gcHl0aG9uID49IDIuNi4nKQoKICAgIG1zZy5hcHBlbmQoJ1lvdSBjYW4gdXNlIHZhbGlkYXRlX2NlcnRzPUZhbHNlIGlmIHlvdSBkbycKICAgICAgICAgICAgICAgJyBub3QgbmVlZCB0byBjb25maXJtIHRoZSBzZXJ2ZXJzIGlkZW50aXR5IGJ1dCB0aGlzIGlzJwogICAgICAgICAgICAgICAnIHVuc2FmZSBhbmQgbm90IHJlY29tbWVuZGVkLicKICAgICAgICAgICAgICAgJyBQYXRocyBjaGVja2VkIGZvciB0aGlzIHBsYXRmb3JtOiAlcy4nKQoKICAgIGlmIGV4YzoKICAgICAgICBtc2cuYXBwZW5kKCdUaGUgZXhjZXB0aW9uIG1zZyB3YXM6ICVzLicgJSB0b19uYXRpdmUoZXhjKSkKCiAgICByYWlzZSBTU0xWYWxpZGF0aW9uRXJyb3IoJyAnLmpvaW4obXNnKSAlIChob3N0bmFtZSwgcG9ydCwgIiwgIi5qb2luKHBhdGhzKSkpCgoKY2xhc3MgU1NMVmFsaWRhdGlvbkhhbmRsZXIodXJsbGliX3JlcXVlc3QuQmFzZUhhbmRsZXIpOgogICAgJycnCiAgICBBIGN1c3RvbSBoYW5kbGVyIGNsYXNzIGZvciBTU0wgdmFsaWRhdGlvbi4KCiAgICBCYXNlZCBvbjoKICAgIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTA4NzIyNy92YWxpZGF0ZS1zc2wtY2VydGlmaWNhdGVzLXdpdGgtcHl0aG9uCiAgICBodHRwOi8vdGVjaGtuYWNrLm5ldC9weXRob24tdXJsbGliMi1oYW5kbGVycy8KICAgICcnJwogICAgQ09OTkVDVF9DT01NQU5EID0gIkNPTk5FQ1QgJXM6JXMgSFRUUC8xLjBcclxuQ29ubmVjdGlvbjogY2xvc2VcclxuIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBob3N0bmFtZSwgcG9ydCk6CiAgICAgICAgc2VsZi5ob3N0bmFtZSA9IGhvc3RuYW1lCiAgICAgICAgc2VsZi5wb3J0ID0gcG9ydAoKICAgIGRlZiBnZXRfY2FfY2VydHMoc2VsZik6CiAgICAgICAgIyB0cmllcyB0byBmaW5kIGEgdmFsaWQgQ0EgY2VydCBpbiBvbmUgb2YgdGhlCiAgICAgICAgIyBzdGFuZGFyZCBsb2NhdGlvbnMgZm9yIHRoZSBjdXJyZW50IGRpc3RyaWJ1dGlvbgoKICAgICAgICBjYV9jZXJ0cyA9IFtdCiAgICAgICAgcGF0aHNfY2hlY2tlZCA9IFtdCgogICAgICAgIHN5c3RlbSA9IHRvX3RleHQocGxhdGZvcm0uc3lzdGVtKCksIGVycm9ycz0nc3Vycm9nYXRlX29yX3N0cmljdCcpCiAgICAgICAgIyBidWlsZCBhIGxpc3Qgb2YgcGF0aHMgdG8gY2hlY2sgZm9yIC5jcnQvLnBlbSBmaWxlcwogICAgICAgICMgYmFzZWQgb24gdGhlIHBsYXRmb3JtIHR5cGUKICAgICAgICBwYXRoc19jaGVja2VkLmFwcGVuZCgnL2V0Yy9zc2wvY2VydHMnKQogICAgICAgIGlmIHN5c3RlbSA9PSB1J0xpbnV4JzoKICAgICAgICAgICAgcGF0aHNfY2hlY2tlZC5hcHBlbmQoJy9ldGMvcGtpL2NhLXRydXN0L2V4dHJhY3RlZC9wZW0nKQogICAgICAgICAgICBwYXRoc19jaGVja2VkLmFwcGVuZCgnL2V0Yy9wa2kvdGxzL2NlcnRzJykKICAgICAgICAgICAgcGF0aHNfY2hlY2tlZC5hcHBlbmQoJy91c3Ivc2hhcmUvY2EtY2VydGlmaWNhdGVzL2NhY2VydC5vcmcnKQogICAgICAgIGVsaWYgc3lzdGVtID09IHUnRnJlZUJTRCc6CiAgICAgICAgICAgIHBhdGhzX2NoZWNrZWQuYXBwZW5kKCcvdXNyL2xvY2FsL3NoYXJlL2NlcnRzJykKICAgICAgICBlbGlmIHN5c3RlbSA9PSB1J09wZW5CU0QnOgogICAgICAgICAgICBwYXRoc19jaGVja2VkLmFwcGVuZCgnL2V0Yy9zc2wnKQogICAgICAgIGVsaWYgc3lzdGVtID09IHUnTmV0QlNEJzoKICAgICAgICAgICAgY2FfY2VydHMuYXBwZW5kKCcvZXRjL29wZW5zc2wvY2VydHMnKQogICAgICAgIGVsaWYgc3lzdGVtID09IHUnU3VuT1MnOgogICAgICAgICAgICBwYXRoc19jaGVja2VkLmFwcGVuZCgnL29wdC9sb2NhbC9ldGMvb3BlbnNzbC9jZXJ0cycpCgogICAgICAgICMgZmFsbCBiYWNrIHRvIGEgdXNlci1kZXBsb3llZCBjZXJ0IGluIGEgc3RhbmRhcmQKICAgICAgICAjIGxvY2F0aW9uIGlmIHRoZSBPUyBwbGF0Zm9ybSBvbmUgaXMgbm90IGF2YWlsYWJsZQogICAgICAgIHBhdGhzX2NoZWNrZWQuYXBwZW5kKCcvZXRjL2Fuc2libGUnKQoKICAgICAgICB0bXBfZmQsIHRtcF9wYXRoID0gdGVtcGZpbGUubWtzdGVtcCgpCiAgICAgICAgdG9fYWRkX2ZkLCB0b19hZGRfcGF0aCA9IHRlbXBmaWxlLm1rc3RlbXAoKQogICAgICAgIHRvX2FkZCA9IEZhbHNlCgogICAgICAgICMgV3JpdGUgdGhlIGR1bW15IGNhIGNlcnQgaWYgd2UgYXJlIHJ1bm5pbmcgb24gTWFjIE9TIFgKICAgICAgICBpZiBzeXN0ZW0gPT0gdSdEYXJ3aW4nOgogICAgICAgICAgICBvcy53cml0ZSh0bXBfZmQsIGJfRFVNTVlfQ0FfQ0VSVCkKICAgICAgICAgICAgIyBEZWZhdWx0IEhvbWVicmV3IHBhdGggZm9yIE9wZW5TU0wgY2VydHMKICAgICAgICAgICAgcGF0aHNfY2hlY2tlZC5hcHBlbmQoJy91c3IvbG9jYWwvZXRjL29wZW5zc2wnKQoKICAgICAgICAjIGZvciBhbGwgb2YgdGhlIHBhdGhzLCBmaW5kIGFueSAgLmNydCBvciAucGVtIGZpbGVzCiAgICAgICAgIyBhbmQgY29tcGlsZSB0aGVtIGludG8gc2luZ2xlIHRlbXAgZmlsZSBmb3IgdXNlCiAgICAgICAgIyBpbiB0aGUgc3NsIGNoZWNrIHRvIHNwZWVkIHVwIHRoZSB0ZXN0CiAgICAgICAgZm9yIHBhdGggaW4gcGF0aHNfY2hlY2tlZDoKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocGF0aCkgYW5kIG9zLnBhdGguaXNkaXIocGF0aCk6CiAgICAgICAgICAgICAgICBkaXJfY29udGVudHMgPSBvcy5saXN0ZGlyKHBhdGgpCiAgICAgICAgICAgICAgICBmb3IgZiBpbiBkaXJfY29udGVudHM6CiAgICAgICAgICAgICAgICAgICAgZnVsbF9wYXRoID0gb3MucGF0aC5qb2luKHBhdGgsIGYpCiAgICAgICAgICAgICAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUoZnVsbF9wYXRoKSBhbmQgb3MucGF0aC5zcGxpdGV4dChmKVsxXSBpbiAoJy5jcnQnLCcucGVtJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlcnRfZmlsZSA9IG9wZW4oZnVsbF9wYXRoLCAncmInKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydCA9IGNlcnRfZmlsZS5yZWFkKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlcnRfZmlsZS5jbG9zZSgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy53cml0ZSh0bXBfZmQsIGNlcnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy53cml0ZSh0bXBfZmQsIGIoJ1xuJykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBmdWxsX3BhdGggbm90IGluIExPQURFRF9WRVJJRllfTE9DQVRJT05TOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvX2FkZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy53cml0ZSh0b19hZGRfZmQsIGNlcnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3Mud3JpdGUodG9fYWRkX2ZkLCBiKCdcbicpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExPQURFRF9WRVJJRllfTE9DQVRJT05TLmFkZChmdWxsX3BhdGgpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgSU9FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgIGlmIG5vdCB0b19hZGQ6CiAgICAgICAgICAgIHRvX2FkZF9wYXRoID0gTm9uZQogICAgICAgIHJldHVybiAodG1wX3BhdGgsIHRvX2FkZF9wYXRoLCBwYXRoc19jaGVja2VkKQoKICAgIGRlZiB2YWxpZGF0ZV9wcm94eV9yZXNwb25zZShzZWxmLCByZXNwb25zZSwgdmFsaWRfY29kZXM9WzIwMF0pOgogICAgICAgICcnJwogICAgICAgIG1ha2Ugc3VyZSB3ZSBnZXQgYmFjayBhIHZhbGlkIGNvZGUgZnJvbSB0aGUgcHJveHkKICAgICAgICAnJycKICAgICAgICB0cnk6CiAgICAgICAgICAgIChodHRwX3ZlcnNpb24sIHJlc3BfY29kZSwgbXNnKSA9IHJlLm1hdGNoKHInKEhUVFAvXGRcLlxkKSAoXGRcZFxkKSAoLiopJywgcmVzcG9uc2UpLmdyb3VwcygpCiAgICAgICAgICAgIGlmIGludChyZXNwX2NvZGUpIG5vdCBpbiB2YWxpZF9jb2RlczoKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbgogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcmFpc2UgUHJveHlFcnJvcignQ29ubmVjdGlvbiB0byBwcm94eSBmYWlsZWQnKQoKICAgIGRlZiBkZXRlY3Rfbm9fcHJveHkoc2VsZiwgdXJsKToKICAgICAgICAnJycKICAgICAgICBEZXRlY3QgaWYgdGhlICdub19wcm94eScgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgc2V0IGFuZCBob25vciB0aG9zZSBsb2NhdGlvbnMuCiAgICAgICAgJycnCiAgICAgICAgZW52X25vX3Byb3h5ID0gb3MuZW52aXJvbi5nZXQoJ25vX3Byb3h5JykKICAgICAgICBpZiBlbnZfbm9fcHJveHk6CiAgICAgICAgICAgIGVudl9ub19wcm94eSA9IGVudl9ub19wcm94eS5zcGxpdCgnLCcpCiAgICAgICAgICAgIG5ldGxvYyA9IHVybHBhcnNlKHVybCkubmV0bG9jCgogICAgICAgICAgICBmb3IgaG9zdCBpbiBlbnZfbm9fcHJveHk6CiAgICAgICAgICAgICAgICBpZiBuZXRsb2MuZW5kc3dpdGgoaG9zdCkgb3IgbmV0bG9jLnNwbGl0KCc6JylbMF0uZW5kc3dpdGgoaG9zdCk6CiAgICAgICAgICAgICAgICAgICAgIyBPdXIgcmVxdWVzdGVkIFVSTCBtYXRjaGVzIHNvbWV0aGluZyBpbiBub19wcm94eSwgc28gZG9uJ3QKICAgICAgICAgICAgICAgICAgICAjIHVzZSB0aGUgcHJveHkgZm9yIHRoaXMKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBfbWFrZV9jb250ZXh0KHNlbGYsIHRvX2FkZF9jYV9jZXJ0X3BhdGgpOgogICAgICAgIGlmIEhBU19VUkxMSUIzX1BZT1BFTlNTTENPTlRFWFQ6CiAgICAgICAgICAgIGNvbnRleHQgPSBQeU9wZW5TU0xDb250ZXh0KFBST1RPQ09MKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNvbnRleHQgPSBjcmVhdGVfZGVmYXVsdF9jb250ZXh0KCkKICAgICAgICBpZiB0b19hZGRfY2FfY2VydF9wYXRoOgogICAgICAgICAgICBjb250ZXh0LmxvYWRfdmVyaWZ5X2xvY2F0aW9ucyh0b19hZGRfY2FfY2VydF9wYXRoKQogICAgICAgIHJldHVybiBjb250ZXh0CgogICAgZGVmIGh0dHBfcmVxdWVzdChzZWxmLCByZXEpOgogICAgICAgIHRtcF9jYV9jZXJ0X3BhdGgsIHRvX2FkZF9jYV9jZXJ0X3BhdGgsIHBhdGhzX2NoZWNrZWQgPSBzZWxmLmdldF9jYV9jZXJ0cygpCiAgICAgICAgaHR0cHNfcHJveHkgPSBvcy5lbnZpcm9uLmdldCgnaHR0cHNfcHJveHknKQogICAgICAgIGNvbnRleHQgPSBOb25lCiAgICAgICAgaWYgSEFTX1NTTENPTlRFWFQgb3IgSEFTX1VSTExJQjNfUFlPUEVOU1NMQ09OVEVYVDoKICAgICAgICAgICAgY29udGV4dCA9IHNlbGYuX21ha2VfY29udGV4dCh0b19hZGRfY2FfY2VydF9wYXRoKQoKICAgICAgICAjIERldGVjdCBpZiAnbm9fcHJveHknIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIHNldCBhbmQgaWYgb3VyIFVSTCBpcyBpbmNsdWRlZAogICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGV0ZWN0X25vX3Byb3h5KHJlcS5nZXRfZnVsbF91cmwoKSkKCiAgICAgICAgaWYgbm90IHVzZV9wcm94eToKICAgICAgICAgICAgIyBpZ25vcmUgcHJveHkgc2V0dGluZ3MgZm9yIHRoaXMgaG9zdCByZXF1ZXN0CiAgICAgICAgICAgIHJldHVybiByZXEKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzID0gc29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFNKQogICAgICAgICAgICBpZiBodHRwc19wcm94eToKICAgICAgICAgICAgICAgIHByb3h5X3BhcnRzID0gZ2VuZXJpY191cmxwYXJzZSh1cmxwYXJzZShodHRwc19wcm94eSkpCiAgICAgICAgICAgICAgICBwb3J0ID0gcHJveHlfcGFydHMuZ2V0KCdwb3J0Jykgb3IgNDQzCiAgICAgICAgICAgICAgICBzLmNvbm5lY3QoKHByb3h5X3BhcnRzLmdldCgnaG9zdG5hbWUnKSwgcG9ydCkpCiAgICAgICAgICAgICAgICBpZiBwcm94eV9wYXJ0cy5nZXQoJ3NjaGVtZScpID09ICdodHRwJzoKICAgICAgICAgICAgICAgICAgICBzLnNlbmRhbGwoc2VsZi5DT05ORUNUX0NPTU1BTkQgJSAoc2VsZi5ob3N0bmFtZSwgc2VsZi5wb3J0KSkKICAgICAgICAgICAgICAgICAgICBpZiBwcm94eV9wYXJ0cy5nZXQoJ3VzZXJuYW1lJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWRlbnRpYWxzID0gIiVzOiVzIiAlIChwcm94eV9wYXJ0cy5nZXQoJ3VzZXJuYW1lJywnJyksIHByb3h5X3BhcnRzLmdldCgncGFzc3dvcmQnLCcnKSkKICAgICAgICAgICAgICAgICAgICAgICAgcy5zZW5kYWxsKGIoJ1Byb3h5LUF1dGhvcml6YXRpb246IEJhc2ljICVzXHJcbicpICUgYmFzZTY0LmI2NGVuY29kZSh0b19ieXRlcyhjcmVkZW50aWFscywgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykpLnN0cmlwKCkpCiAgICAgICAgICAgICAgICAgICAgcy5zZW5kYWxsKGIoJ1xyXG4nKSkKICAgICAgICAgICAgICAgICAgICBjb25uZWN0X3Jlc3VsdCA9IGIoIiIpCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgY29ubmVjdF9yZXN1bHQuZmluZChiKCJcclxuXHJcbiIpKSA8PSAwOgogICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0X3Jlc3VsdCArPSBzLnJlY3YoNDA5NikKICAgICAgICAgICAgICAgICAgICAgICAgIyAxMjgga2lsb2J5dGVzIG9mIGhlYWRlcnMgc2hvdWxkIGJlIGVub3VnaCBmb3IgZXZlcnlvbmUuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihjb25uZWN0X3Jlc3VsdCkgPiAxMzEwNzI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBQcm94eUVycm9yKCdQcm94eSBzZW50IHRvbyB2ZXJib3NlIGhlYWRlcnMuIE9ubHkgMTI4S2lCIGFsbG93ZWQuJykKICAgICAgICAgICAgICAgICAgICBzZWxmLnZhbGlkYXRlX3Byb3h5X3Jlc3BvbnNlKGNvbm5lY3RfcmVzdWx0KQogICAgICAgICAgICAgICAgICAgIGlmIGNvbnRleHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNzbF9zID0gY29udGV4dC53cmFwX3NvY2tldChzLCBzZXJ2ZXJfaG9zdG5hbWU9c2VsZi5ob3N0bmFtZSkKICAgICAgICAgICAgICAgICAgICBlbGlmIEhBU19VUkxMSUIzX1NTTF9XUkFQX1NPQ0tFVDoKICAgICAgICAgICAgICAgICAgICAgICAgc3NsX3MgPSBzc2xfd3JhcF9zb2NrZXQocywgY2FfY2VydHM9dG1wX2NhX2NlcnRfcGF0aCwgY2VydF9yZXFzPXNzbC5DRVJUX1JFUVVJUkVELCBzc2xfdmVyc2lvbj1QUk9UT0NPTCwgc2VydmVyX2hvc3RuYW1lPXNlbGYuaG9zdG5hbWUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc3NsX3MgPSBzc2wud3JhcF9zb2NrZXQocywgY2FfY2VydHM9dG1wX2NhX2NlcnRfcGF0aCwgY2VydF9yZXFzPXNzbC5DRVJUX1JFUVVJUkVELCBzc2xfdmVyc2lvbj1QUk9UT0NPTCkKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hfaG9zdG5hbWUoc3NsX3MuZ2V0cGVlcmNlcnQoKSwgc2VsZi5ob3N0bmFtZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgUHJveHlFcnJvcignVW5zdXBwb3J0ZWQgcHJveHkgc2NoZW1lOiAlcy4gQ3VycmVudGx5IGFuc2libGUgb25seSBzdXBwb3J0cyBIVFRQIHByb3hpZXMuJyAlIHByb3h5X3BhcnRzLmdldCgnc2NoZW1lJykpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzLmNvbm5lY3QoKHNlbGYuaG9zdG5hbWUsIHNlbGYucG9ydCkpCiAgICAgICAgICAgICAgICBpZiBjb250ZXh0OgogICAgICAgICAgICAgICAgICAgIHNzbF9zID0gY29udGV4dC53cmFwX3NvY2tldChzLCBzZXJ2ZXJfaG9zdG5hbWU9c2VsZi5ob3N0bmFtZSkKICAgICAgICAgICAgICAgIGVsaWYgSEFTX1VSTExJQjNfU1NMX1dSQVBfU09DS0VUOgogICAgICAgICAgICAgICAgICAgIHNzbF9zID0gc3NsX3dyYXBfc29ja2V0KHMsIGNhX2NlcnRzPXRtcF9jYV9jZXJ0X3BhdGgsIGNlcnRfcmVxcz1zc2wuQ0VSVF9SRVFVSVJFRCwgc3NsX3ZlcnNpb249UFJPVE9DT0wsIHNlcnZlcl9ob3N0bmFtZT1zZWxmLmhvc3RuYW1lKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzc2xfcyA9IHNzbC53cmFwX3NvY2tldChzLCBjYV9jZXJ0cz10bXBfY2FfY2VydF9wYXRoLCBjZXJ0X3JlcXM9c3NsLkNFUlRfUkVRVUlSRUQsIHNzbF92ZXJzaW9uPVBST1RPQ09MKQogICAgICAgICAgICAgICAgICAgIG1hdGNoX2hvc3RuYW1lKHNzbF9zLmdldHBlZXJjZXJ0KCksIHNlbGYuaG9zdG5hbWUpCiAgICAgICAgICAgICMgY2xvc2UgdGhlIHNzbCBjb25uZWN0aW9uCiAgICAgICAgICAgICNzc2xfcy51bndyYXAoKQogICAgICAgICAgICBzLmNsb3NlKCkKICAgICAgICBleGNlcHQgKHNzbC5TU0xFcnJvciwgQ2VydGlmaWNhdGVFcnJvcik6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgYnVpbGRfc3NsX3ZhbGlkYXRpb25fZXJyb3Ioc2VsZi5ob3N0bmFtZSwgc2VsZi5wb3J0LCBwYXRoc19jaGVja2VkLCBlKQogICAgICAgIGV4Y2VwdCBzb2NrZXQuZXJyb3I6CiAgICAgICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgcmFpc2UgQ29ubmVjdGlvbkVycm9yKCdGYWlsZWQgdG8gY29ubmVjdCB0byAlcyBhdCBwb3J0ICVzOiAlcycgJSAoc2VsZi5ob3N0bmFtZSwgc2VsZi5wb3J0LCB0b19uYXRpdmUoZSkpKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgY2xlYW51cCB0aGUgdGVtcCBmaWxlIGNyZWF0ZWQsIGRvbid0IHdvcnJ5CiAgICAgICAgICAgICMgaWYgaXQgZmFpbHMgZm9yIHNvbWUgcmVhc29uCiAgICAgICAgICAgIG9zLnJlbW92ZSh0bXBfY2FfY2VydF9wYXRoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgY2xlYW51cCB0aGUgdGVtcCBmaWxlIGNyZWF0ZWQsIGRvbid0IHdvcnJ5CiAgICAgICAgICAgICMgaWYgaXQgZmFpbHMgZm9yIHNvbWUgcmVhc29uCiAgICAgICAgICAgIGlmIHRvX2FkZF9jYV9jZXJ0X3BhdGg6CiAgICAgICAgICAgICAgICBvcy5yZW1vdmUodG9fYWRkX2NhX2NlcnRfcGF0aCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgcmV0dXJuIHJlcQoKICAgIGh0dHBzX3JlcXVlc3QgPSBodHRwX3JlcXVlc3QKCgpkZWYgbWF5YmVfYWRkX3NzbF9oYW5kbGVyKHVybCwgdmFsaWRhdGVfY2VydHMpOgogICAgIyBGSVhNRTogY2hhbmdlIHRoZSBmb2xsb3dpbmcgdG8gdXNlIHRoZSBnZW5lcmljX3VybHBhcnNlIGZ1bmN0aW9uCiAgICAjICAgICAgICB0byByZW1vdmUgdGhlIGluZGV4ZWQgcmVmZXJlbmNlcyBmb3IgJ3BhcnNlZCcKICAgIHBhcnNlZCA9IHVybHBhcnNlKHVybCkKICAgIGlmIHBhcnNlZFswXSA9PSAnaHR0cHMnIGFuZCB2YWxpZGF0ZV9jZXJ0czoKICAgICAgICBpZiBub3QgSEFTX1NTTDoKICAgICAgICAgICAgcmFpc2UgTm9TU0xFcnJvcignU1NMIHZhbGlkYXRpb24gaXMgbm90IGF2YWlsYWJsZSBpbiB5b3VyIHZlcnNpb24gb2YgcHl0aG9uLiBZb3UgY2FuIHVzZSB2YWxpZGF0ZV9jZXJ0cz1GYWxzZSwnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyBob3dldmVyIHRoaXMgaXMgdW5zYWZlIGFuZCBub3QgcmVjb21tZW5kZWQnKQoKICAgICAgICAjIGRvIHRoZSBjZXJ0IHZhbGlkYXRpb24KICAgICAgICBuZXRsb2MgPSBwYXJzZWRbMV0KICAgICAgICBpZiAnQCcgaW4gbmV0bG9jOgogICAgICAgICAgICBuZXRsb2MgPSBuZXRsb2Muc3BsaXQoJ0AnLCAxKVsxXQogICAgICAgIGlmICc6JyBpbiBuZXRsb2M6CiAgICAgICAgICAgIGhvc3RuYW1lLCBwb3J0ID0gbmV0bG9jLnNwbGl0KCc6JywgMSkKICAgICAgICAgICAgcG9ydCA9IGludChwb3J0KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGhvc3RuYW1lID0gbmV0bG9jCiAgICAgICAgICAgIHBvcnQgPSA0NDMKICAgICAgICAjIGNyZWF0ZSB0aGUgU1NMIHZhbGlkYXRpb24gaGFuZGxlciBhbmQKICAgICAgICAjIGFkZCBpdCB0byB0aGUgbGlzdCBvZiBoYW5kbGVycwogICAgICAgIHJldHVybiBTU0xWYWxpZGF0aW9uSGFuZGxlcihob3N0bmFtZSwgcG9ydCkKCgpkZWYgb3Blbl91cmwodXJsLCBkYXRhPU5vbmUsIGhlYWRlcnM9Tm9uZSwgbWV0aG9kPU5vbmUsIHVzZV9wcm94eT1UcnVlLAogICAgICAgICAgICAgZm9yY2U9RmFsc2UsIGxhc3RfbW9kX3RpbWU9Tm9uZSwgdGltZW91dD0xMCwgdmFsaWRhdGVfY2VydHM9VHJ1ZSwKICAgICAgICAgICAgIHVybF91c2VybmFtZT1Ob25lLCB1cmxfcGFzc3dvcmQ9Tm9uZSwgaHR0cF9hZ2VudD1Ob25lLAogICAgICAgICAgICAgZm9yY2VfYmFzaWNfYXV0aD1GYWxzZSwgZm9sbG93X3JlZGlyZWN0cz0ndXJsbGliMicsCiAgICAgICAgICAgICBjbGllbnRfY2VydD1Ob25lLCBjbGllbnRfa2V5PU5vbmUpOgogICAgJycnCiAgICBTZW5kcyBhIHJlcXVlc3QgdmlhIEhUVFAoUykgb3IgRlRQIHVzaW5nIHVybGxpYjIgKFB5dGhvbjIpIG9yIHVybGxpYiAoUHl0aG9uMykKCiAgICBEb2VzIG5vdCByZXF1aXJlIHRoZSBtb2R1bGUgZW52aXJvbm1lbnQKICAgICcnJwogICAgaGFuZGxlcnMgPSBbXQogICAgc3NsX2hhbmRsZXIgPSBtYXliZV9hZGRfc3NsX2hhbmRsZXIodXJsLCB2YWxpZGF0ZV9jZXJ0cykKICAgIGlmIHNzbF9oYW5kbGVyOgogICAgICAgIGhhbmRsZXJzLmFwcGVuZChzc2xfaGFuZGxlcikKCiAgICAjIEZJWE1FOiBjaGFuZ2UgdGhlIGZvbGxvd2luZyB0byB1c2UgdGhlIGdlbmVyaWNfdXJscGFyc2UgZnVuY3Rpb24KICAgICMgICAgICAgIHRvIHJlbW92ZSB0aGUgaW5kZXhlZCByZWZlcmVuY2VzIGZvciAncGFyc2VkJwogICAgcGFyc2VkID0gdXJscGFyc2UodXJsKQogICAgaWYgcGFyc2VkWzBdICE9ICdmdHAnOgogICAgICAgIHVzZXJuYW1lID0gdXJsX3VzZXJuYW1lCgogICAgICAgIGlmIGhlYWRlcnMgaXMgTm9uZToKICAgICAgICAgICAgaGVhZGVycyA9IHt9CgogICAgICAgIGlmIHVzZXJuYW1lOgogICAgICAgICAgICBwYXNzd29yZCA9IHVybF9wYXNzd29yZAogICAgICAgICAgICBuZXRsb2MgPSBwYXJzZWRbMV0KICAgICAgICBlbGlmICdAJyBpbiBwYXJzZWRbMV06CiAgICAgICAgICAgIGNyZWRlbnRpYWxzLCBuZXRsb2MgPSBwYXJzZWRbMV0uc3BsaXQoJ0AnLCAxKQogICAgICAgICAgICBpZiAnOicgaW4gY3JlZGVudGlhbHM6CiAgICAgICAgICAgICAgICB1c2VybmFtZSwgcGFzc3dvcmQgPSBjcmVkZW50aWFscy5zcGxpdCgnOicsIDEpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGNyZWRlbnRpYWxzCiAgICAgICAgICAgICAgICBwYXNzd29yZCA9ICcnCgogICAgICAgICAgICBwYXJzZWQgPSBsaXN0KHBhcnNlZCkKICAgICAgICAgICAgcGFyc2VkWzFdID0gbmV0bG9jCgogICAgICAgICAgICAjIHJlY29uc3RydWN0IHVybCB3aXRob3V0IGNyZWRlbnRpYWxzCiAgICAgICAgICAgIHVybCA9IHVybHVucGFyc2UocGFyc2VkKQoKICAgICAgICBpZiB1c2VybmFtZSBhbmQgbm90IGZvcmNlX2Jhc2ljX2F1dGg6CiAgICAgICAgICAgIHBhc3NtYW4gPSB1cmxsaWJfcmVxdWVzdC5IVFRQUGFzc3dvcmRNZ3JXaXRoRGVmYXVsdFJlYWxtKCkKCiAgICAgICAgICAgICMgdGhpcyBjcmVhdGVzIGEgcGFzc3dvcmQgbWFuYWdlcgogICAgICAgICAgICBwYXNzbWFuLmFkZF9wYXNzd29yZChOb25lLCBuZXRsb2MsIHVzZXJuYW1lLCBwYXNzd29yZCkKCiAgICAgICAgICAgICMgYmVjYXVzZSB3ZSBoYXZlIHB1dCBOb25lIGF0IHRoZSBzdGFydCBpdCB3aWxsIGFsd2F5cwogICAgICAgICAgICAjIHVzZSB0aGlzIHVzZXJuYW1lL3Bhc3N3b3JkIGNvbWJpbmF0aW9uIGZvciAgdXJscwogICAgICAgICAgICAjIGZvciB3aGljaCBgdGhldXJsYCBpcyBhIHN1cGVyLXVybAogICAgICAgICAgICBhdXRoaGFuZGxlciA9IHVybGxpYl9yZXF1ZXN0LkhUVFBCYXNpY0F1dGhIYW5kbGVyKHBhc3NtYW4pCiAgICAgICAgICAgIGRpZ2VzdF9hdXRoaGFuZGxlciA9IHVybGxpYl9yZXF1ZXN0LkhUVFBEaWdlc3RBdXRoSGFuZGxlcihwYXNzbWFuKQoKICAgICAgICAgICAgIyBjcmVhdGUgdGhlIEF1dGhIYW5kbGVyCiAgICAgICAgICAgIGhhbmRsZXJzLmFwcGVuZChhdXRoaGFuZGxlcikKICAgICAgICAgICAgaGFuZGxlcnMuYXBwZW5kKGRpZ2VzdF9hdXRoaGFuZGxlcikKCiAgICAgICAgZWxpZiB1c2VybmFtZSBhbmQgZm9yY2VfYmFzaWNfYXV0aDoKICAgICAgICAgICAgaGVhZGVyc1siQXV0aG9yaXphdGlvbiJdID0gYmFzaWNfYXV0aF9oZWFkZXIodXNlcm5hbWUsIHBhc3N3b3JkKQoKICAgICAgICBlbHNlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByYyA9IG5ldHJjLm5ldHJjKG9zLmVudmlyb24uZ2V0KCdORVRSQycpKQogICAgICAgICAgICAgICAgbG9naW4gPSByYy5hdXRoZW50aWNhdG9ycyhwYXJzZWRbMV0pCiAgICAgICAgICAgIGV4Y2VwdCBJT0Vycm9yOgogICAgICAgICAgICAgICAgbG9naW4gPSBOb25lCgogICAgICAgICAgICBpZiBsb2dpbjoKICAgICAgICAgICAgICAgIHVzZXJuYW1lLCBfLCBwYXNzd29yZCA9IGxvZ2luCiAgICAgICAgICAgICAgICBpZiB1c2VybmFtZSBhbmQgcGFzc3dvcmQ6CiAgICAgICAgICAgICAgICAgICAgaGVhZGVyc1siQXV0aG9yaXphdGlvbiJdID0gYmFzaWNfYXV0aF9oZWFkZXIodXNlcm5hbWUsIHBhc3N3b3JkKQoKICAgIGlmIG5vdCB1c2VfcHJveHk6CiAgICAgICAgcHJveHloYW5kbGVyID0gdXJsbGliX3JlcXVlc3QuUHJveHlIYW5kbGVyKHt9KQogICAgICAgIGhhbmRsZXJzLmFwcGVuZChwcm94eWhhbmRsZXIpCgogICAgaWYgSEFTX1NTTENPTlRFWFQgYW5kIG5vdCB2YWxpZGF0ZV9jZXJ0czoKICAgICAgICAjIEluIDIuNy45LCB0aGUgZGVmYXVsdCBjb250ZXh0IHZhbGlkYXRlcyBjZXJ0aWZpY2F0ZXMKICAgICAgICBjb250ZXh0ID0gU1NMQ29udGV4dChzc2wuUFJPVE9DT0xfU1NMdjIzKQogICAgICAgIGNvbnRleHQub3B0aW9ucyB8PSBzc2wuT1BfTk9fU1NMdjIKICAgICAgICBjb250ZXh0Lm9wdGlvbnMgfD0gc3NsLk9QX05PX1NTTHYzCiAgICAgICAgY29udGV4dC52ZXJpZnlfbW9kZSA9IHNzbC5DRVJUX05PTkUKICAgICAgICBjb250ZXh0LmNoZWNrX2hvc3RuYW1lID0gRmFsc2UKICAgICAgICBoYW5kbGVycy5hcHBlbmQoSFRUUFNDbGllbnRBdXRoSGFuZGxlcihjbGllbnRfY2VydD1jbGllbnRfY2VydCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGllbnRfa2V5PWNsaWVudF9rZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dD1jb250ZXh0KSkKICAgIGVsaWYgY2xpZW50X2NlcnQ6CiAgICAgICAgaGFuZGxlcnMuYXBwZW5kKEhUVFBTQ2xpZW50QXV0aEhhbmRsZXIoY2xpZW50X2NlcnQ9Y2xpZW50X2NlcnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xpZW50X2tleT1jbGllbnRfa2V5KSkKCiAgICAjIHByZS0yLjYgdmVyc2lvbnMgb2YgcHl0aG9uIGNhbm5vdCB1c2UgdGhlIGN1c3RvbSBodHRwcwogICAgIyBoYW5kbGVyLCBzaW5jZSB0aGUgc29ja2V0IGNsYXNzIGlzIGxhY2tpbmcgY3JlYXRlX2Nvbm5lY3Rpb24uCiAgICAjIFNvbWUgcHl0aG9uIGJ1aWxkcyBsYWNrIEhUVFBTIHN1cHBvcnQuCiAgICBpZiBoYXNhdHRyKHNvY2tldCwgJ2NyZWF0ZV9jb25uZWN0aW9uJykgYW5kIEN1c3RvbUhUVFBTSGFuZGxlcjoKICAgICAgICBoYW5kbGVycy5hcHBlbmQoQ3VzdG9tSFRUUFNIYW5kbGVyKQoKICAgIGhhbmRsZXJzLmFwcGVuZChSZWRpcmVjdEhhbmRsZXJGYWN0b3J5KGZvbGxvd19yZWRpcmVjdHMsIHZhbGlkYXRlX2NlcnRzKSkKCiAgICBvcGVuZXIgPSB1cmxsaWJfcmVxdWVzdC5idWlsZF9vcGVuZXIoKmhhbmRsZXJzKQogICAgdXJsbGliX3JlcXVlc3QuaW5zdGFsbF9vcGVuZXIob3BlbmVyKQoKICAgIGRhdGEgPSB0b19ieXRlcyhkYXRhLCBub25zdHJpbmc9J3Bhc3N0aHJ1JykKICAgIGlmIG1ldGhvZDoKICAgICAgICBpZiBtZXRob2QudXBwZXIoKSBub3QgaW4gKCdPUFRJT05TJywnR0VUJywnSEVBRCcsJ1BPU1QnLCdQVVQnLCdERUxFVEUnLCdUUkFDRScsJ0NPTk5FQ1QnLCdQQVRDSCcpOgogICAgICAgICAgICByYWlzZSBDb25uZWN0aW9uRXJyb3IoJ2ludmFsaWQgSFRUUCByZXF1ZXN0IG1ldGhvZDsgJXMnICUgbWV0aG9kLnVwcGVyKCkpCiAgICAgICAgcmVxdWVzdCA9IFJlcXVlc3RXaXRoTWV0aG9kKHVybCwgbWV0aG9kLnVwcGVyKCksIGRhdGEpCiAgICBlbHNlOgogICAgICAgIHJlcXVlc3QgPSB1cmxsaWJfcmVxdWVzdC5SZXF1ZXN0KHVybCwgZGF0YSkKCiAgICAjIGFkZCB0aGUgY3VzdG9tIGFnZW50IGhlYWRlciwgdG8gaGVscCBwcmV2ZW50IGlzc3VlcwogICAgIyB3aXRoIHNpdGVzIHRoYXQgYmxvY2sgdGhlIGRlZmF1bHQgdXJsbGliIGFnZW50IHN0cmluZwogICAgaWYgaHR0cF9hZ2VudDoKICAgICAgICByZXF1ZXN0LmFkZF9oZWFkZXIoJ1VzZXItYWdlbnQnLCBodHRwX2FnZW50KQoKICAgICMgQ2FjaGUgY29udHJvbAogICAgIyBFaXRoZXIgd2UgZGlyZWN0bHkgZm9yY2UgYSBjYWNoZSByZWZyZXNoCiAgICBpZiBmb3JjZToKICAgICAgICByZXF1ZXN0LmFkZF9oZWFkZXIoJ2NhY2hlLWNvbnRyb2wnLCAnbm8tY2FjaGUnKQogICAgIyBvciB3ZSBkbyBpdCBpZiB0aGUgb3JpZ2luYWwgaXMgbW9yZSByZWNlbnQgdGhhbiBvdXIgY29weQogICAgZWxpZiBsYXN0X21vZF90aW1lOgogICAgICAgIHRzdGFtcCA9IGxhc3RfbW9kX3RpbWUuc3RyZnRpbWUoJyVhLCAlZCAlYiAlWSAlSDolTTolUyArMDAwMCcpCiAgICAgICAgcmVxdWVzdC5hZGRfaGVhZGVyKCdJZi1Nb2RpZmllZC1TaW5jZScsIHRzdGFtcCkKCiAgICAjIHVzZXIgZGVmaW5lZCBoZWFkZXJzIG5vdywgd2hpY2ggbWF5IG92ZXJyaWRlIHRoaW5ncyB3ZSd2ZSBzZXQgYWJvdmUKICAgIGlmIGhlYWRlcnM6CiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoaGVhZGVycywgZGljdCk6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoImhlYWRlcnMgcHJvdmlkZWQgdG8gZmV0Y2hfdXJsKCkgbXVzdCBiZSBhIGRpY3QiKQogICAgICAgIGZvciBoZWFkZXIgaW4gaGVhZGVyczoKICAgICAgICAgICAgcmVxdWVzdC5hZGRfaGVhZGVyKGhlYWRlciwgaGVhZGVyc1toZWFkZXJdKQoKICAgIHVybG9wZW5fYXJncyA9IFtyZXF1ZXN0LCBOb25lXQogICAgaWYgc3lzLnZlcnNpb25faW5mbyA+PSAoMiw2LDApOgogICAgICAgICMgdXJsb3BlbiBpbiBweXRob24gcHJpb3IgdG8gMi42LjAgZGlkIG5vdAogICAgICAgICMgaGF2ZSBhIHRpbWVvdXQgcGFyYW1ldGVyCiAgICAgICAgdXJsb3Blbl9hcmdzLmFwcGVuZCh0aW1lb3V0KQoKICAgIHIgPSB1cmxsaWJfcmVxdWVzdC51cmxvcGVuKCp1cmxvcGVuX2FyZ3MpCiAgICByZXR1cm4gcgoKIwojIE1vZHVsZS1yZWxhdGVkIGZ1bmN0aW9ucwojCgoKZGVmIGJhc2ljX2F1dGhfaGVhZGVyKHVzZXJuYW1lLCBwYXNzd29yZCk6CiAgICAiIiJUYWtlcyBhIHVzZXJuYW1lIGFuZCBwYXNzd29yZCBhbmQgcmV0dXJucyBhIGJ5dGUgc3RyaW5nIHN1aXRhYmxlIGZvcgogICAgdXNpbmcgYXMgdmFsdWUgb2YgYW4gQXV0aG9yaXphdGlvbiBoZWFkZXIgdG8gZG8gYmFzaWMgYXV0aC4KICAgICIiIgogICAgcmV0dXJuIGIoIkJhc2ljICVzIikgJSBiYXNlNjQuYjY0ZW5jb2RlKHRvX2J5dGVzKCIlczolcyIgJSAodXNlcm5hbWUsIHBhc3N3b3JkKSwgZXJyb3JzPSdzdXJyb2dhdGVfb3Jfc3RyaWN0JykpCgoKZGVmIHVybF9hcmd1bWVudF9zcGVjKCk6CiAgICAnJycKICAgIENyZWF0ZXMgYW4gYXJndW1lbnQgc3BlYyB0aGF0IGNhbiBiZSB1c2VkIHdpdGggYW55IG1vZHVsZQogICAgdGhhdCB3aWxsIGJlIHJlcXVlc3RpbmcgY29udGVudCB2aWEgdXJsbGliL3VybGxpYjIKICAgICcnJwogICAgcmV0dXJuIGRpY3QoCiAgICAgICAgdXJsPWRpY3QoKSwKICAgICAgICBmb3JjZT1kaWN0KGRlZmF1bHQ9J25vJywgYWxpYXNlcz1bJ3RoaXJzdHknXSwgdHlwZT0nYm9vbCcpLAogICAgICAgIGh0dHBfYWdlbnQ9ZGljdChkZWZhdWx0PSdhbnNpYmxlLWh0dHBnZXQnKSwKICAgICAgICB1c2VfcHJveHk9ZGljdChkZWZhdWx0PSd5ZXMnLCB0eXBlPSdib29sJyksCiAgICAgICAgdmFsaWRhdGVfY2VydHM9ZGljdChkZWZhdWx0PSd5ZXMnLCB0eXBlPSdib29sJyksCiAgICAgICAgdXJsX3VzZXJuYW1lPWRpY3QocmVxdWlyZWQ9RmFsc2UpLAogICAgICAgIHVybF9wYXNzd29yZD1kaWN0KHJlcXVpcmVkPUZhbHNlLCBub19sb2c9VHJ1ZSksCiAgICAgICAgZm9yY2VfYmFzaWNfYXV0aD1kaWN0KHJlcXVpcmVkPUZhbHNlLCB0eXBlPSdib29sJywgZGVmYXVsdD0nbm8nKSwKICAgICAgICBjbGllbnRfY2VydD1kaWN0KHJlcXVpcmVkPUZhbHNlLCB0eXBlPSdwYXRoJywgZGVmYXVsdD1Ob25lKSwKICAgICAgICBjbGllbnRfa2V5PWRpY3QocmVxdWlyZWQ9RmFsc2UsIHR5cGU9J3BhdGgnLCBkZWZhdWx0PU5vbmUpLAogICAgKQoKCmRlZiBmZXRjaF91cmwobW9kdWxlLCB1cmwsIGRhdGE9Tm9uZSwgaGVhZGVycz1Ob25lLCBtZXRob2Q9Tm9uZSwKICAgICAgICAgICAgICB1c2VfcHJveHk9VHJ1ZSwgZm9yY2U9RmFsc2UsIGxhc3RfbW9kX3RpbWU9Tm9uZSwgdGltZW91dD0xMCk6CiAgICAiIiJTZW5kcyBhIHJlcXVlc3QgdmlhIEhUVFAoUykgb3IgRlRQIChuZWVkcyB0aGUgbW9kdWxlIGFzIHBhcmFtZXRlcikKCiAgICA6YXJnIG1vZHVsZTogVGhlIEFuc2libGVNb2R1bGUgKHVzZWQgdG8gZ2V0IHVzZXJuYW1lLCBwYXNzd29yZCBldGMuIChzLmIuKS4KICAgIDphcmcgdXJsOiAgICAgICAgICAgICBUaGUgdXJsIHRvIHVzZS4KCiAgICA6a3dhcmcgZGF0YTogICAgICAgICAgVGhlIGRhdGEgdG8gYmUgc2VudCAoaW4gY2FzZSBvZiBQT1NUL1BVVCkuCiAgICA6a3dhcmcgaGVhZGVyczogICAgICAgQSBkaWN0IHdpdGggdGhlIHJlcXVlc3QgaGVhZGVycy4KICAgIDprd2FyZyBtZXRob2Q6ICAgICAgICAiUE9TVCIsICJQVVQiLCBldGMuCiAgICA6a3dhcmcgYm9vbGVhbiB1c2VfcHJveHk6ICAgICBEZWZhdWx0OiBUcnVlCiAgICA6a3dhcmcgYm9vbGVhbiBmb3JjZTogSWYgVHJ1ZTogRG8gbm90IGdldCBhIGNhY2hlZCBjb3B5IChEZWZhdWx0OiBGYWxzZSkKICAgIDprd2FyZyBsYXN0X21vZF90aW1lOiBEZWZhdWx0OiBOb25lCiAgICA6a3dhcmcgaW50IHRpbWVvdXQ6ICAgRGVmYXVsdDogMTAKCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZiAoKipyZXNwb25zZSoqLCAqKmluZm8qKikuIFVzZSBgYHJlc3BvbnNlLmJvZHkoKWBgIHRvIHJlYWQgdGhlIGRhdGEuCiAgICAgICAgVGhlICoqaW5mbyoqIGNvbnRhaW5zIHRoZSAnc3RhdHVzJyBhbmQgb3RoZXIgbWV0YSBkYXRhLiBXaGVuIGEgSHR0cEVycm9yIChzdGF0dXMgPiA0MDApCiAgICAgICAgb2NjdXJyZWQgdGhlbiBgYGluZm9bJ2JvZHknXWBgIGNvbnRhaW5zIHRoZSBlcnJvciByZXNwb25zZSBkYXRhOjoKCiAgICBFeGFtcGxlOjoKCiAgICAgICAgZGF0YT17Li4ufQogICAgICAgIHJlc3AsIGluZm8gPSBmZXRjaF91cmwobW9kdWxlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImh0dHA6Ly9leGFtcGxlLmNvbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhPW1vZHVsZS5qc29uaWZ5KGRhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXI9e0NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q9IlBPU1QiKQogICAgICAgIHN0YXR1c19jb2RlID0gaW5mb1sic3RhdHVzIl0KICAgICAgICBib2R5ID0gcmVzcC5yZWFkKCkKICAgICAgICBpZiBzdGF0dXNfY29kZSA+PSA0MDAgOgogICAgICAgICAgICBib2R5ID0gaW5mb1snYm9keSddCiAgICAiIiIKCiAgICBpZiBub3QgSEFTX1VSTFBBUlNFOgogICAgICAgIG1vZHVsZS5mYWlsX2pzb24obXNnPSd1cmxwYXJzZSBpcyBub3QgaW5zdGFsbGVkJykKCiAgICAjIEdldCB2YWxpZGF0ZV9jZXJ0cyBmcm9tIHRoZSBtb2R1bGUgcGFyYW1zCiAgICB2YWxpZGF0ZV9jZXJ0cyA9IG1vZHVsZS5wYXJhbXMuZ2V0KCd2YWxpZGF0ZV9jZXJ0cycsIFRydWUpCgogICAgdXNlcm5hbWUgPSBtb2R1bGUucGFyYW1zLmdldCgndXJsX3VzZXJuYW1lJywgJycpCiAgICBwYXNzd29yZCA9IG1vZHVsZS5wYXJhbXMuZ2V0KCd1cmxfcGFzc3dvcmQnLCAnJykKICAgIGh0dHBfYWdlbnQgPSBtb2R1bGUucGFyYW1zLmdldCgnaHR0cF9hZ2VudCcsIE5vbmUpCiAgICBmb3JjZV9iYXNpY19hdXRoID0gbW9kdWxlLnBhcmFtcy5nZXQoJ2ZvcmNlX2Jhc2ljX2F1dGgnLCAnJykKCiAgICBmb2xsb3dfcmVkaXJlY3RzID0gbW9kdWxlLnBhcmFtcy5nZXQoJ2ZvbGxvd19yZWRpcmVjdHMnLCAndXJsbGliMicpCgogICAgY2xpZW50X2NlcnQgPSBtb2R1bGUucGFyYW1zLmdldCgnY2xpZW50X2NlcnQnKQogICAgY2xpZW50X2tleSA9IG1vZHVsZS5wYXJhbXMuZ2V0KCdjbGllbnRfa2V5JykKCiAgICByID0gTm9uZQogICAgaW5mbyA9IGRpY3QodXJsPXVybCkKICAgIHRyeToKICAgICAgICByID0gb3Blbl91cmwodXJsLCBkYXRhPWRhdGEsIGhlYWRlcnM9aGVhZGVycywgbWV0aG9kPW1ldGhvZCwKICAgICAgICAgICAgICAgICAgICAgdXNlX3Byb3h5PXVzZV9wcm94eSwgZm9yY2U9Zm9yY2UsIGxhc3RfbW9kX3RpbWU9bGFzdF9tb2RfdGltZSwgdGltZW91dD10aW1lb3V0LAogICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZV9jZXJ0cz12YWxpZGF0ZV9jZXJ0cywgdXJsX3VzZXJuYW1lPXVzZXJuYW1lLAogICAgICAgICAgICAgICAgICAgICB1cmxfcGFzc3dvcmQ9cGFzc3dvcmQsIGh0dHBfYWdlbnQ9aHR0cF9hZ2VudCwgZm9yY2VfYmFzaWNfYXV0aD1mb3JjZV9iYXNpY19hdXRoLAogICAgICAgICAgICAgICAgICAgICBmb2xsb3dfcmVkaXJlY3RzPWZvbGxvd19yZWRpcmVjdHMsIGNsaWVudF9jZXJ0PWNsaWVudF9jZXJ0LAogICAgICAgICAgICAgICAgICAgICBjbGllbnRfa2V5PWNsaWVudF9rZXkpCiAgICAgICAgaW5mby51cGRhdGUoci5pbmZvKCkpCiAgICAgICAgaW5mby51cGRhdGUoZGljdChtc2c9Ik9LICglcyBieXRlcykiICUgci5oZWFkZXJzLmdldCgnQ29udGVudC1MZW5ndGgnLCAndW5rbm93bicpLCB1cmw9ci5nZXR1cmwoKSwgc3RhdHVzPXIuY29kZSkpCiAgICBleGNlcHQgTm9TU0xFcnJvcjoKICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgZGlzdHJpYnV0aW9uID0gZ2V0X2Rpc3RyaWJ1dGlvbigpCiAgICAgICAgaWYgZGlzdHJpYnV0aW9uIGlzIG5vdCBOb25lIGFuZCBkaXN0cmlidXRpb24ubG93ZXIoKSA9PSAncmVkaGF0JzoKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9JyVzLiBZb3UgY2FuIGFsc28gaW5zdGFsbCBweXRob24tc3NsIGZyb20gRVBFTCcgJSBzdHIoZSkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9JyVzJyAlIHN0cihlKSkKICAgIGV4Y2VwdCAoQ29ubmVjdGlvbkVycm9yLCBWYWx1ZUVycm9yKToKICAgICAgICBlID0gZ2V0X2V4Y2VwdGlvbigpCiAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9c3RyKGUpKQogICAgZXhjZXB0IHVybGxpYl9lcnJvci5IVFRQRXJyb3I6CiAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgIHRyeToKICAgICAgICAgICAgYm9keSA9IGUucmVhZCgpCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICBib2R5ID0gJycKCiAgICAgICAgIyBUcnkgdG8gYWRkIGV4Y2VwdGlvbiBpbmZvIHRvIHRoZSBvdXRwdXQgYnV0IGRvbid0IGZhaWwgaWYgd2UgY2FuJ3QKICAgICAgICBleGNfaW5mbyA9IGUuaW5mbygpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbmZvLnVwZGF0ZShkaWN0KCoqZS5pbmZvKCkpKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKICAgICAgICBpbmZvLnVwZGF0ZSh7J21zZyc6IHN0cihlKSwgJ2JvZHknOiBib2R5LCAnc3RhdHVzJzogZS5jb2RlfSkKCiAgICBleGNlcHQgdXJsbGliX2Vycm9yLlVSTEVycm9yOgogICAgICAgIGUgPSBnZXRfZXhjZXB0aW9uKCkKICAgICAgICBjb2RlID0gaW50KGdldGF0dHIoZSwgJ2NvZGUnLCAtMSkpCiAgICAgICAgaW5mby51cGRhdGUoZGljdChtc2c9IlJlcXVlc3QgZmFpbGVkOiAlcyIgJSBzdHIoZSksIHN0YXR1cz1jb2RlKSkKICAgIGV4Y2VwdCBzb2NrZXQuZXJyb3I6CiAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgIGluZm8udXBkYXRlKGRpY3QobXNnPSJDb25uZWN0aW9uIGZhaWx1cmU6ICVzIiAlIHN0cihlKSwgc3RhdHVzPS0xKSkKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgZSA9IGdldF9leGNlcHRpb24oKQogICAgICAgIGluZm8udXBkYXRlKGRpY3QobXNnPSJBbiB1bmtub3duIGVycm9yIG9jY3VycmVkOiAlcyIgJSBzdHIoZSksIHN0YXR1cz0tMSkpCgogICAgcmV0dXJuIHIsIGluZm8KUEsDBBQAAAAAAAG8K0sYF3L1AREAAAERAAAkAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19faW5pdF9fLnB5IyBUaGlzIGNvZGUgaXMgcGFydCBvZiBBbnNpYmxlLCBidXQgaXMgYW4gaW5kZXBlbmRlbnQgY29tcG9uZW50LgojIFRoaXMgcGFydGljdWxhciBmaWxlIHNuaXBwZXQsIGFuZCB0aGlzIGZpbGUgc25pcHBldCBvbmx5LCBpcyBCU0QgbGljZW5zZWQuCiMgTW9kdWxlcyB5b3Ugd3JpdGUgdXNpbmcgdGhpcyBzbmlwcGV0LCB3aGljaCBpcyBlbWJlZGRlZCBkeW5hbWljYWxseSBieSBBbnNpYmxlCiMgc3RpbGwgYmVsb25nIHRvIHRoZSBhdXRob3Igb2YgdGhlIG1vZHVsZSwgYW5kIG1heSBhc3NpZ24gdGhlaXIgb3duIGxpY2Vuc2UKIyB0byB0aGUgY29tcGxldGUgd29yay4KIwojIENvcHlyaWdodCAoYykgMjAxNywgVG9zaGlvIEt1cmF0b21pIDx0a3VyYXRvbWlAYW5zaWJsZS5jb20+CiMKIyBUaGlzIGNvZGUgaXMgYmFzZWQgb24gY29kZSBmcm9tIEFzdHJvcHkgYW5kIHJldGFpbnMgdGhlaXIgMy1jbGF1c2UgQlNEIGxpY2Vuc2UKIyByZXByb2R1Y2VkIGJlbG93OgojCiMgQ29weXJpZ2h0IChjKSAyMDExLTIwMTYsIEFzdHJvcHkgRGV2ZWxvcGVycwojCiMgQWxsIHJpZ2h0cyByZXNlcnZlZC4KIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dAojIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsIHRoaXMKIyAgIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMgKiBOZWl0aGVyIHRoZSBuYW1lIG9mIHRoZSBBc3Ryb3B5IFRlYW0gbm9yIHRoZSBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heQojICAgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHMgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dAojICAgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLgojCiMgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiCiMgQU5EIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRQojIElNUExJRUQgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRQojIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUKIyBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTAojIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SCiMgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIKIyBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLAojIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFCiMgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwojIEFzdHJvcHkgTGljZW5zZTogaHR0cHM6Ly9naXRodWIuY29tL2FzdHJvcHkvYXN0cm9weS9ibG9iL2NmMzI2NWU0MmEwZGI4ZTAwYmI5MDY0NGRiMzdjODE1MGY1YWMwMGMvbGljZW5zZXMvTElDRU5TRS5yc3QKIyBBc3Ryb3B5IENvZGU6IGh0dHBzOi8vZ2l0aHViLmNvbS9hc3Ryb3B5L2FzdHJvcHkvYmxvYi9jZjMyNjVlNDJhMGRiOGUwMGJiOTA2NDRkYjM3YzgxNTBmNWFjMDBjL2FzdHJvcHkvZXh0ZXJuL3NpeC5weQoKIiIiCkhhbmRsZSBsb2FkaW5nIHNpeCBwYWNrYWdlIGZyb20gc3lzdGVtIG9yIGZyb20gdGhlIGJ1bmRsZWQgY29weQoiIiIKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCBhYnNvbHV0ZV9pbXBvcnQKCmltcG9ydCBpbXAgYXMgX2ltcAppbXBvcnQgc3lzIGFzIF9zeXMKCnRyeToKICAgIGZyb20gZGlzdHV0aWxzLnZlcnNpb24gaW1wb3J0IExvb3NlVmVyc2lvbiBhcyBfTG9vc2VWZXJzaW9uCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICMgU29tZSBwbGF0Zm9ybXMgKmNvdWdoKlNvbGFyaXMqY291Z2gqIGRvbid0IHNoaXAgdGhlIHdob2xlIHN0ZGxpYgogICAgX0xvb3NlVmVyc2lvbiA9IE5vbmUKCnRyeToKICAgIGltcG9ydCBzaXggYXMgX3N5c3RlbV9zaXgKZXhjZXB0IEltcG9ydEVycm9yOgogICAgX3N5c3RlbV9zaXggPSBOb25lCgpmcm9tIC4gaW1wb3J0IF9zaXggYXMgX2J1bmRsZWRfc2l4CgoKZGVmIF9maW5kX21vZHVsZShuYW1lLCBwYXRoPU5vbmUpOgogICAgIiIiQWx0ZXJuYXRpdmUgdG8gYGltcC5maW5kX21vZHVsZWAgdGhhdCBjYW4gYWxzbyBzZWFyY2ggaW4gc3VicGFja2FnZXMiIiIKICAgIHBhcnRzID0gbmFtZS5zcGxpdCgnLicpCgogICAgZm9yIHBhcnQgaW4gcGFydHM6CiAgICAgICAgaWYgcGF0aCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGF0aCA9IFtwYXRoXQogICAgICAgIGZoLCBwYXRoLCBkZXNjciA9IF9pbXAuZmluZF9tb2R1bGUocGFydCwgcGF0aCkKICAgIHJldHVybiBmaCwgcGF0aCwgZGVzY3IKCgpkZWYgX2dldF9idW5kbGVkX3NpeF9zb3VyY2UoKToKICAgICMgU3BlY2lhbCBpbXBvcnQgbG9hZGVyICh6aXBpbXBvcnQgZm9yIGluc3RhbmNlKQogICAgZm91bmQgPSBGYWxzZQogICAgZm9yIHBhdGggaW4gX3N5cy5wYXRoOgogICAgICAgIGltcG9ydGVyID0gX3N5cy5wYXRoX2ltcG9ydGVyX2NhY2hlLmdldChwYXRoKQogICAgICAgIGlmIGltcG9ydGVyOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmb3VuZCA9IGltcG9ydGVyLmZpbmRfbW9kdWxlKCdhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeCcpCiAgICAgICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGlmIGZvdW5kOgogICAgICAgICAgICAgICAgYnJlYWsKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoIkNvdWxkIG5vdCBmaW5kIGFuc2libGUubW9kdWxlX3V0aWxzLnNpeC5fc2l4IikKCiAgICBtb2R1bGVfc291cmNlID0gaW1wb3J0ZXIuZ2V0X3NvdXJjZSgnYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19zaXgnKQogICAgcmV0dXJuIG1vZHVsZV9zb3VyY2UKCgpkZWYgX2dldF9zaXhfc291cmNlKCk6CiAgICAiIiJJbXBvcnQgdGhlIG5ld2VzdCB2ZXJzaW9uIG9mIHRoZSBzaXggbGlicmFyeSB0aGF0J3MgYXZhaWxhYmxlIiIiCiAgICBtb2RfaW5mbyA9IE5vbmUKICAgIHRyeToKICAgICAgICBpZiBfc3lzdGVtX3NpeCBhbmQgX0xvb3NlVmVyc2lvbiBhbmQgXAogICAgICAgICAgICAgICAgX0xvb3NlVmVyc2lvbihfc3lzdGVtX3NpeC5fX3ZlcnNpb25fXykgPj0gX0xvb3NlVmVyc2lvbihfYnVuZGxlZF9zaXguX192ZXJzaW9uX18pOgogICAgICAgICAgICBtb2RfaW5mbyA9IF9maW5kX21vZHVsZSgnc2l4JykKICAgIGV4Y2VwdDoKICAgICAgICAjIEFueSBlcnJvcnMgZmluZGluZyB0aGUgc3lzdGVtIGxpYnJhcnksIHVzZSBvdXIgYnVuZGxlZCBsaWIgaW5zdGVhZAogICAgICAgIHBhc3MKCiAgICBpZiBub3QgbW9kX2luZm86CiAgICAgICAgdHJ5OgogICAgICAgICAgICBtb2RfaW5mbyA9IF9maW5kX21vZHVsZSgnYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4Ll9zaXgnKQogICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICAgICAgIyB6aXBpbXBvcnQKICAgICAgICAgICAgbW9kdWxlX3NvdXJjZSA9IF9nZXRfYnVuZGxlZF9zaXhfc291cmNlKCkKICAgICAgICAgICAgcmV0dXJuIG1vZHVsZV9zb3VyY2UKCiAgICByZXR1cm4gbW9kX2luZm9bMF0ucmVhZCgpCgpzb3VyY2UgPSBfZ2V0X3NpeF9zb3VyY2UoKQpleGVjKHNvdXJjZSkKUEsDBBQAAAAAAAG8K0vweDjF9kEAAPZBAAAeAAAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvdm13YXJlLnB5IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiMgKGMpIDIwMTUsIEpvc2VwaCBDYWxsZW4gPGpjYWxsZW4gKCkgY3NjLmNvbT4KIwojIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIEFuc2libGUKIwojIEFuc2libGUgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKIyAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgojCiMgQW5zaWJsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQojIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMKIyBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggQW5zaWJsZS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gYW5zaWJsZS5tb2R1bGVfdXRpbHMuc2l4IGltcG9ydCBpdGVyaXRlbXMKaW1wb3J0IGF0ZXhpdAppbXBvcnQgc3NsCmltcG9ydCB0aW1lCgp0cnk6CiAgICAjIHJlcXVlc3RzIGlzIHJlcXVpcmVkIGZvciBleGNlcHRpb24gaGFuZGxpbmcgb2YgdGhlIENvbm5lY3Rpb25FcnJvcgogICAgaW1wb3J0IHJlcXVlc3RzCiAgICBmcm9tIHB5VmltIGltcG9ydCBjb25uZWN0CiAgICBmcm9tIHB5Vm1vbWkgaW1wb3J0IHZpbQogICAgSEFTX1BZVk1PTUkgPSBUcnVlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIEhBU19QWVZNT01JID0gRmFsc2UKCgpjbGFzcyBUYXNrRXJyb3IoRXhjZXB0aW9uKToKICAgIHBhc3MKCgpkZWYgd2FpdF9mb3JfdGFzayh0YXNrKToKCiAgICB3aGlsZSBUcnVlOgogICAgICAgIGlmIHRhc2suaW5mby5zdGF0ZSA9PSB2aW0uVGFza0luZm8uU3RhdGUuc3VjY2VzczoKICAgICAgICAgICAgcmV0dXJuIFRydWUsIHRhc2suaW5mby5yZXN1bHQKICAgICAgICBpZiB0YXNrLmluZm8uc3RhdGUgPT0gdmltLlRhc2tJbmZvLlN0YXRlLmVycm9yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByYWlzZSBUYXNrRXJyb3IodGFzay5pbmZvLmVycm9yKQogICAgICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgICAgICByYWlzZSBUYXNrRXJyb3IoIkFuIHVua25vd24gZXJyb3IgaGFzIG9jY3VycmVkIikKICAgICAgICBpZiB0YXNrLmluZm8uc3RhdGUgPT0gdmltLlRhc2tJbmZvLlN0YXRlLnJ1bm5pbmc6CiAgICAgICAgICAgIHRpbWUuc2xlZXAoMTUpCiAgICAgICAgaWYgdGFzay5pbmZvLnN0YXRlID09IHZpbS5UYXNrSW5mby5TdGF0ZS5xdWV1ZWQ6CiAgICAgICAgICAgIHRpbWUuc2xlZXAoMTUpCgoKZGVmIGZpbmRfZHZzcGdfYnlfbmFtZShkdl9zd2l0Y2gsIHBvcnRncm91cF9uYW1lKToKCiAgICBwb3J0Z3JvdXBzID0gZHZfc3dpdGNoLnBvcnRncm91cAoKICAgIGZvciBwZyBpbiBwb3J0Z3JvdXBzOgogICAgICAgIGlmIHBnLm5hbWUgPT0gcG9ydGdyb3VwX25hbWU6CiAgICAgICAgICAgIHJldHVybiBwZwoKICAgIHJldHVybiBOb25lCgoKZGVmIGZpbmRfZW50aXR5X2NoaWxkX2J5X3BhdGgoY29udGVudCwgZW50aXR5Um9vdEZvbGRlciwgcGF0aCk6CgogICAgZW50aXR5ID0gZW50aXR5Um9vdEZvbGRlcgogICAgc2VhcmNoSW5kZXggPSBjb250ZW50LnNlYXJjaEluZGV4CiAgICBwYXRocyA9IHBhdGguc3BsaXQoIi8iKQogICAgdHJ5OgogICAgICAgIGZvciBwYXRoIGluIHBhdGhzOgogICAgICAgICAgICBlbnRpdHkgPSBzZWFyY2hJbmRleC5GaW5kQ2hpbGQgKGVudGl0eSwgcGF0aCkKCiAgICAgICAgaWYgZW50aXR5Lm5hbWUgPT0gcGF0aHNbLTFdOgogICAgICAgICAgICByZXR1cm4gZW50aXR5CiAgICBleGNlcHQ6CiAgICAgICAgcGFzcwoKICAgIHJldHVybiBOb25lCgoKIyBNYWludGFpbiBmb3IgbGVnYWN5LCBvciByZW1vdmUgd2l0aCAyLjEgPwojIFNob3VsZCBiZSByZXBsYWNlZCB3aXRoIGZpbmRfY2x1c3Rlcl9ieV9uYW1lCmRlZiBmaW5kX2NsdXN0ZXJfYnlfbmFtZV9kYXRhY2VudGVyKGRhdGFjZW50ZXIsIGNsdXN0ZXJfbmFtZSk6CgogICAgaG9zdF9mb2xkZXIgPSBkYXRhY2VudGVyLmhvc3RGb2xkZXIKICAgIGZvciBmb2xkZXIgaW4gaG9zdF9mb2xkZXIuY2hpbGRFbnRpdHk6CiAgICAgICAgaWYgZm9sZGVyLm5hbWUgPT0gY2x1c3Rlcl9uYW1lOgogICAgICAgICAgICByZXR1cm4gZm9sZGVyCiAgICByZXR1cm4gTm9uZQoKCmRlZiBmaW5kX2NsdXN0ZXJfYnlfbmFtZShjb250ZW50LCBjbHVzdGVyX25hbWUsIGRhdGFjZW50ZXI9Tm9uZSk6CgogICAgaWYgZGF0YWNlbnRlcjoKICAgICAgICBmb2xkZXIgPSBkYXRhY2VudGVyLmhvc3RGb2xkZXIKICAgIGVsc2U6CiAgICAgICAgZm9sZGVyID0gY29udGVudC5yb290Rm9sZGVyCgogICAgY2x1c3RlcnMgPSBnZXRfYWxsX29ianMoY29udGVudCwgW3ZpbS5DbHVzdGVyQ29tcHV0ZVJlc291cmNlXSwgZm9sZGVyKQogICAgZm9yIGNsdXN0ZXIgaW4gY2x1c3RlcnM6CiAgICAgICAgaWYgY2x1c3Rlci5uYW1lID09IGNsdXN0ZXJfbmFtZToKICAgICAgICAgICAgcmV0dXJuIGNsdXN0ZXIKCiAgICByZXR1cm4gTm9uZQoKCmRlZiBmaW5kX2RhdGFjZW50ZXJfYnlfbmFtZShjb250ZW50LCBkYXRhY2VudGVyX25hbWUpOgoKICAgIGRhdGFjZW50ZXJzID0gZ2V0X2FsbF9vYmpzKGNvbnRlbnQsIFt2aW0uRGF0YWNlbnRlcl0pCiAgICBmb3IgZGMgaW4gZGF0YWNlbnRlcnM6CiAgICAgICAgaWYgZGMubmFtZSA9PSBkYXRhY2VudGVyX25hbWU6CiAgICAgICAgICAgIHJldHVybiBkYwoKICAgIHJldHVybiBOb25lCgpkZWYgZmluZF9kYXRhc3RvcmVfYnlfbmFtZShjb250ZW50LCBkYXRhc3RvcmVfbmFtZSk6CgogICAgZGF0YXN0b3JlcyA9IGdldF9hbGxfb2Jqcyhjb250ZW50LCBbdmltLkRhdGFzdG9yZV0pCiAgICBmb3IgZHMgaW4gZGF0YXN0b3JlczoKICAgICAgICBpZiBkcy5uYW1lID09IGRhdGFzdG9yZV9uYW1lOgogICAgICAgICAgICByZXR1cm4gZHMKCiAgICByZXR1cm4gTm9uZQoKCmRlZiBmaW5kX2R2c19ieV9uYW1lKGNvbnRlbnQsIHN3aXRjaF9uYW1lKToKCiAgICB2bXdhcmVfZGlzdHJpYnV0ZWRfc3dpdGNoZXMgPSBnZXRfYWxsX29ianMoY29udGVudCwgW3ZpbS5kdnMuVm13YXJlRGlzdHJpYnV0ZWRWaXJ0dWFsU3dpdGNoXSkKICAgIGZvciBkdnMgaW4gdm13YXJlX2Rpc3RyaWJ1dGVkX3N3aXRjaGVzOgogICAgICAgIGlmIGR2cy5uYW1lID09IHN3aXRjaF9uYW1lOgogICAgICAgICAgICByZXR1cm4gZHZzCiAgICByZXR1cm4gTm9uZQoKCmRlZiBmaW5kX2hvc3RzeXN0ZW1fYnlfbmFtZShjb250ZW50LCBob3N0bmFtZSk6CgogICAgaG9zdF9zeXN0ZW0gPSBnZXRfYWxsX29ianMoY29udGVudCwgW3ZpbS5Ib3N0U3lzdGVtXSkKICAgIGZvciBob3N0IGluIGhvc3Rfc3lzdGVtOgogICAgICAgIGlmIGhvc3QubmFtZSA9PSBob3N0bmFtZToKICAgICAgICAgICAgcmV0dXJuIGhvc3QKICAgIHJldHVybiBOb25lCgoKZGVmIGZpbmRfdm1fYnlfaWQoY29udGVudCwgdm1faWQsIHZtX2lkX3R5cGU9InZtX25hbWUiLCBkYXRhY2VudGVyPU5vbmUsIGNsdXN0ZXI9Tm9uZSk6CiAgICAiIiIgVVVJRCBpcyB1bmlxdWUgdG8gYSBWTSwgZXZlcnkgb3RoZXIgaWQgcmV0dXJucyB0aGUgZmlyc3QgbWF0Y2guICIiIgogICAgc2kgPSBjb250ZW50LnNlYXJjaEluZGV4CiAgICB2bSA9IE5vbmUKCiAgICBpZiB2bV9pZF90eXBlID09ICdkbnNfbmFtZSc6CiAgICAgICAgdm0gPSBzaS5GaW5kQnlEbnNOYW1lKGRhdGFjZW50ZXI9ZGF0YWNlbnRlciwgZG5zTmFtZT12bV9pZCwgdm1TZWFyY2g9VHJ1ZSkKICAgIGVsaWYgdm1faWRfdHlwZSA9PSAnaW52ZW50b3J5X3BhdGgnOgogICAgICAgIHZtID0gc2kuRmluZEJ5SW52ZW50b3J5UGF0aChpbnZlbnRvcnlQYXRoPXZtX2lkKQogICAgICAgIGlmIGlzaW5zdGFuY2Uodm0sIHZpbS5WaXJ0dWFsTWFjaGluZSk6CiAgICAgICAgICAgIHZtID0gTm9uZQogICAgZWxpZiB2bV9pZF90eXBlID09ICd1dWlkJzoKICAgICAgICB2bSA9IHNpLkZpbmRCeVV1aWQoZGF0YWNlbnRlcj1kYXRhY2VudGVyLCBpbnN0YW5jZVV1aWQ9dm1faWQsIHZtU2VhcmNoPVRydWUpCiAgICBlbGlmIHZtX2lkX3R5cGUgPT0gJ2lwJzoKICAgICAgICB2bSA9IHNpLkZpbmRCeUlwKGRhdGFjZW50ZXI9ZGF0YWNlbnRlciwgaXA9dm1faWQsIHZtU2VhcmNoPVRydWUpCiAgICBlbGlmIHZtX2lkX3R5cGUgPT0gJ3ZtX25hbWUnOgogICAgICAgIGZvbGRlciA9IE5vbmUKICAgICAgICBpZiBjbHVzdGVyOgogICAgICAgICAgICBmb2xkZXIgPSBjbHVzdGVyCiAgICAgICAgZWxpZiBkYXRhY2VudGVyOgogICAgICAgICAgICBmb2xkZXIgPSBkYXRhY2VudGVyLmhvc3RGb2xkZXIKICAgICAgICB2bSA9IGZpbmRfdm1fYnlfbmFtZShjb250ZW50LCB2bV9pZCwgZm9sZGVyKQoKICAgIHJldHVybiB2bQoKCmRlZiBmaW5kX3ZtX2J5X25hbWUoY29udGVudCwgdm1fbmFtZSwgZm9sZGVyPU5vbmUsIHJlY3Vyc2U9VHJ1ZSk6CgogICAgdm1zID0gZ2V0X2FsbF9vYmpzKGNvbnRlbnQsIFt2aW0uVmlydHVhbE1hY2hpbmVdLCBmb2xkZXIsIHJlY3Vyc2U9cmVjdXJzZSkKICAgIGZvciB2bSBpbiB2bXM6CiAgICAgICAgaWYgdm0ubmFtZSA9PSB2bV9uYW1lOgogICAgICAgICAgICByZXR1cm4gdm0KICAgIHJldHVybiBOb25lCgoKZGVmIGZpbmRfaG9zdF9wb3J0Z3JvdXBfYnlfbmFtZShob3N0LCBwb3J0Z3JvdXBfbmFtZSk6CgogICAgZm9yIHBvcnRncm91cCBpbiBob3N0LmNvbmZpZy5uZXR3b3JrLnBvcnRncm91cDoKICAgICAgICBpZiBwb3J0Z3JvdXAuc3BlYy5uYW1lID09IHBvcnRncm91cF9uYW1lOgogICAgICAgICAgICByZXR1cm4gcG9ydGdyb3VwCiAgICByZXR1cm4gTm9uZQoKCmRlZiBnYXRoZXJfdm1fZmFjdHMoY29udGVudCwgdm0pOgogICAgIiIiIEdhdGhlciBmYWN0cyBmcm9tIHZpbS5WaXJ0dWFsTWFjaGluZSBvYmplY3QuICIiIgogICAgZmFjdHMgPSB7CiAgICAgICAgJ21vZHVsZV9odyc6IFRydWUsCiAgICAgICAgJ2h3X25hbWUnOiB2bS5jb25maWcubmFtZSwKICAgICAgICAnaHdfcG93ZXJfc3RhdHVzJzogdm0uc3VtbWFyeS5ydW50aW1lLnBvd2VyU3RhdGUsCiAgICAgICAgJ2h3X2d1ZXN0X2Z1bGxfbmFtZSc6IHZtLnN1bW1hcnkuZ3Vlc3QuZ3Vlc3RGdWxsTmFtZSwKICAgICAgICAnaHdfZ3Vlc3RfaWQnOiB2bS5zdW1tYXJ5Lmd1ZXN0Lmd1ZXN0SWQsCiAgICAgICAgJ2h3X3Byb2R1Y3RfdXVpZCc6IHZtLmNvbmZpZy51dWlkLAogICAgICAgICdod19wcm9jZXNzb3JfY291bnQnOiB2bS5jb25maWcuaGFyZHdhcmUubnVtQ1BVLAogICAgICAgICdod19tZW10b3RhbF9tYic6IHZtLmNvbmZpZy5oYXJkd2FyZS5tZW1vcnlNQiwKICAgICAgICAnaHdfaW50ZXJmYWNlcyc6IFtdLAogICAgICAgICdndWVzdF90b29sc19zdGF0dXMnOiB2bS5ndWVzdC50b29sc1J1bm5pbmdTdGF0dXMsCiAgICAgICAgJ2d1ZXN0X3Rvb2xzX3ZlcnNpb24nOiB2bS5ndWVzdC50b29sc1ZlcnNpb24sCiAgICAgICAgJ2lwdjQnOiBOb25lLAogICAgICAgICdpcHY2JzogTm9uZSwKICAgICAgICAnYW5ub3RhdGlvbic6IHZtLmNvbmZpZy5hbm5vdGF0aW9uLAogICAgICAgICdjdXN0b212YWx1ZXMnOiB7fSwKICAgICAgICAnc25hcHNob3RzJzogW10sCiAgICAgICAgJ2N1cnJlbnRfc25hcHNob3QnOiBOb25lLAogICAgfQoKICAgIGNmbSA9IGNvbnRlbnQuY3VzdG9tRmllbGRzTWFuYWdlcgogICAgIyBSZXNvbHZlIGN1c3RvbSB2YWx1ZXMKICAgIGZvciB2YWx1ZV9vYmogaW4gdm0uc3VtbWFyeS5jdXN0b21WYWx1ZToKICAgICAgICBrbiA9IHZhbHVlX29iai5rZXkKICAgICAgICBpZiBjZm0gaXMgbm90IE5vbmUgYW5kIGNmbS5maWVsZDoKICAgICAgICAgICAgZm9yIGYgaW4gY2ZtLmZpZWxkOgogICAgICAgICAgICAgICAgaWYgZi5rZXkgPT0gdmFsdWVfb2JqLmtleToKICAgICAgICAgICAgICAgICAgICBrbiA9IGYubmFtZQogICAgICAgICAgICAgICAgICAgICMgRXhpdCB0aGUgbG9vcCBpbW1lZGlhdGVseSwgd2UgZm91bmQgaXQKICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICBmYWN0c1snY3VzdG9tdmFsdWVzJ11ba25dID0gdmFsdWVfb2JqLnZhbHVlCgogICAgbmV0X2RpY3QgPSB7fQogICAgZm9yIGRldmljZSBpbiB2bS5ndWVzdC5uZXQ6CiAgICAgICAgbmV0X2RpY3RbZGV2aWNlLm1hY0FkZHJlc3NdID0gbGlzdChkZXZpY2UuaXBBZGRyZXNzKQoKICAgIGZvciBrLCB2IGluIGl0ZXJpdGVtcyhuZXRfZGljdCk6CiAgICAgICAgZm9yIGlwYWRkcmVzcyBpbiB2OgogICAgICAgICAgICBpZiBpcGFkZHJlc3M6CiAgICAgICAgICAgICAgICBpZiAnOjonIGluIGlwYWRkcmVzczoKICAgICAgICAgICAgICAgICAgICBmYWN0c1snaXB2NiddID0gaXBhZGRyZXNzCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGZhY3RzWydpcHY0J10gPSBpcGFkZHJlc3MKCiAgICBldGhlcm5ldF9pZHggPSAwCiAgICBmb3IgaWR4LCBlbnRyeSBpbiBlbnVtZXJhdGUodm0uY29uZmlnLmhhcmR3YXJlLmRldmljZSk6CiAgICAgICAgaWYgbm90IGhhc2F0dHIoZW50cnksICdtYWNBZGRyZXNzJyk6CiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGlmIGVudHJ5Lm1hY0FkZHJlc3M6CiAgICAgICAgICAgIG1hY19hZGRyID0gZW50cnkubWFjQWRkcmVzcwogICAgICAgICAgICBtYWNfYWRkcl9kYXNoID0gbWFjX2FkZHIucmVwbGFjZSgnOicsICctJykKICAgICAgICBlbHNlOgogICAgICAgICAgICBtYWNfYWRkciA9IG1hY19hZGRyX2Rhc2ggPSBOb25lCgogICAgICAgIGZhY3RuYW1lID0gJ2h3X2V0aCcgKyBzdHIoZXRoZXJuZXRfaWR4KQogICAgICAgIGZhY3RzW2ZhY3RuYW1lXSA9IHsKICAgICAgICAgICAgJ2FkZHJlc3N0eXBlJzogZW50cnkuYWRkcmVzc1R5cGUsCiAgICAgICAgICAgICdsYWJlbCc6IGVudHJ5LmRldmljZUluZm8ubGFiZWwsCiAgICAgICAgICAgICdtYWNhZGRyZXNzJzogbWFjX2FkZHIsCiAgICAgICAgICAgICdpcGFkZHJlc3Nlcyc6IG5ldF9kaWN0LmdldChlbnRyeS5tYWNBZGRyZXNzLCBOb25lKSwKICAgICAgICAgICAgJ21hY2FkZHJlc3NfZGFzaCc6IG1hY19hZGRyX2Rhc2gsCiAgICAgICAgICAgICdzdW1tYXJ5JzogZW50cnkuZGV2aWNlSW5mby5zdW1tYXJ5LAogICAgICAgIH0KICAgICAgICBmYWN0c1snaHdfaW50ZXJmYWNlcyddLmFwcGVuZCgnZXRoJyArIHN0cihldGhlcm5ldF9pZHgpKQogICAgICAgIGV0aGVybmV0X2lkeCArPSAxCgogICAgc25hcHNob3RfZmFjdHMgPSBsaXN0X3NuYXBzaG90cyh2bSkKICAgIGlmICdzbmFwc2hvdHMnIGluIHNuYXBzaG90X2ZhY3RzOgogICAgICAgIGZhY3RzWydzbmFwc2hvdHMnXSA9IHNuYXBzaG90X2ZhY3RzWydzbmFwc2hvdHMnXQogICAgICAgIGZhY3RzWydjdXJyZW50X3NuYXBzaG90J10gPSBzbmFwc2hvdF9mYWN0c1snY3VycmVudF9zbmFwc2hvdCddCiAgICByZXR1cm4gZmFjdHMKCgpkZWYgZGVzZXJpYWxpemVfc25hcHNob3Rfb2JqKG9iaik6CiAgICByZXR1cm4geydpZCc6IG9iai5pZCwKICAgICAgICAgICAgJ25hbWUnOiBvYmoubmFtZSwKICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJzogb2JqLmRlc2NyaXB0aW9uLAogICAgICAgICAgICAnY3JlYXRpb25fdGltZSc6IG9iai5jcmVhdGVUaW1lLAogICAgICAgICAgICAnc3RhdGUnOiBvYmouc3RhdGV9CgoKZGVmIGxpc3Rfc25hcHNob3RzX3JlY3Vyc2l2ZWx5KHNuYXBzaG90cyk6CiAgICBzbmFwc2hvdF9kYXRhID0gW10KICAgIGZvciBzbmFwc2hvdCBpbiBzbmFwc2hvdHM6CiAgICAgICAgc25hcHNob3RfZGF0YS5hcHBlbmQoZGVzZXJpYWxpemVfc25hcHNob3Rfb2JqKHNuYXBzaG90KSkKICAgICAgICBzbmFwc2hvdF9kYXRhID0gc25hcHNob3RfZGF0YSArIGxpc3Rfc25hcHNob3RzX3JlY3Vyc2l2ZWx5KHNuYXBzaG90LmNoaWxkU25hcHNob3RMaXN0KQogICAgcmV0dXJuIHNuYXBzaG90X2RhdGEKCgpkZWYgZ2V0X2N1cnJlbnRfc25hcF9vYmooc25hcHNob3RzLCBzbmFwb2IpOgogICAgc25hcF9vYmogPSBbXQogICAgZm9yIHNuYXBzaG90IGluIHNuYXBzaG90czoKICAgICAgICBpZiBzbmFwc2hvdC5zbmFwc2hvdCA9PSBzbmFwb2I6CiAgICAgICAgICAgIHNuYXBfb2JqLmFwcGVuZChzbmFwc2hvdCkKICAgICAgICBzbmFwX29iaiA9IHNuYXBfb2JqICsgZ2V0X2N1cnJlbnRfc25hcF9vYmooc25hcHNob3QuY2hpbGRTbmFwc2hvdExpc3QsIHNuYXBvYikKICAgIHJldHVybiBzbmFwX29iagoKCmRlZiBsaXN0X3NuYXBzaG90cyh2bSk6CiAgICByZXN1bHQgPSB7fQogICAgaWYgdm0uc25hcHNob3QgaXMgTm9uZToKICAgICAgICByZXR1cm4gcmVzdWx0CgogICAgcmVzdWx0WydzbmFwc2hvdHMnXSA9IGxpc3Rfc25hcHNob3RzX3JlY3Vyc2l2ZWx5KHZtLnNuYXBzaG90LnJvb3RTbmFwc2hvdExpc3QpCiAgICBjdXJyZW50X3NuYXByZWYgPSB2bS5zbmFwc2hvdC5jdXJyZW50U25hcHNob3QKICAgIGN1cnJlbnRfc25hcF9vYmogPSBnZXRfY3VycmVudF9zbmFwX29iaih2bS5zbmFwc2hvdC5yb290U25hcHNob3RMaXN0LCBjdXJyZW50X3NuYXByZWYpCiAgICByZXN1bHRbJ2N1cnJlbnRfc25hcHNob3QnXSA9IGRlc2VyaWFsaXplX3NuYXBzaG90X29iaihjdXJyZW50X3NuYXBfb2JqWzBdKQoKICAgIHJldHVybiByZXN1bHQKCgpkZWYgdm13YXJlX2FyZ3VtZW50X3NwZWMoKToKCiAgICByZXR1cm4gZGljdCgKICAgICAgICBob3N0bmFtZT1kaWN0KHR5cGU9J3N0cicsIHJlcXVpcmVkPVRydWUpLAogICAgICAgIHVzZXJuYW1lPWRpY3QodHlwZT0nc3RyJywgYWxpYXNlcz1bJ3VzZXInLCAnYWRtaW4nXSwgcmVxdWlyZWQ9VHJ1ZSksCiAgICAgICAgcGFzc3dvcmQ9ZGljdCh0eXBlPSdzdHInLCBhbGlhc2VzPVsncGFzcycsICdwd2QnXSwgcmVxdWlyZWQ9VHJ1ZSwgbm9fbG9nPVRydWUpLAogICAgICAgIHZhbGlkYXRlX2NlcnRzPWRpY3QodHlwZT0nYm9vbCcsIHJlcXVpcmVkPUZhbHNlLCBkZWZhdWx0PVRydWUpLAogICAgKQoKCmRlZiBjb25uZWN0X3RvX2FwaShtb2R1bGUsIGRpc2Nvbm5lY3RfYXRleGl0PVRydWUpOgoKICAgIGhvc3RuYW1lID0gbW9kdWxlLnBhcmFtc1snaG9zdG5hbWUnXQogICAgdXNlcm5hbWUgPSBtb2R1bGUucGFyYW1zWyd1c2VybmFtZSddCiAgICBwYXNzd29yZCA9IG1vZHVsZS5wYXJhbXNbJ3Bhc3N3b3JkJ10KICAgIHZhbGlkYXRlX2NlcnRzID0gbW9kdWxlLnBhcmFtc1sndmFsaWRhdGVfY2VydHMnXQoKICAgIGlmIHZhbGlkYXRlX2NlcnRzIGFuZCBub3QgaGFzYXR0cihzc2wsICdTU0xDb250ZXh0Jyk6CiAgICAgICAgbW9kdWxlLmZhaWxfanNvbihtc2c9J3B5VmltIGRvZXMgbm90IHN1cHBvcnQgY2hhbmdpbmcgdmVyaWZpY2F0aW9uIG1vZGUgd2l0aCBweXRob24gPCAyLjcuOS4gRWl0aGVyIHVwZGF0ZSAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3B5dGhvbiBvciBvciB1c2UgdmFsaWRhdGVfY2VydHM9ZmFsc2UnKQoKICAgIHRyeToKICAgICAgICBzZXJ2aWNlX2luc3RhbmNlID0gY29ubmVjdC5TbWFydENvbm5lY3QoaG9zdD1ob3N0bmFtZSwgdXNlcj11c2VybmFtZSwgcHdkPXBhc3N3b3JkKQogICAgZXhjZXB0IHZpbS5mYXVsdC5JbnZhbGlkTG9naW4gYXMgaW52YWxpZF9sb2dpbjoKICAgICAgICBtb2R1bGUuZmFpbF9qc29uKG1zZz1pbnZhbGlkX2xvZ2luLm1zZywgYXBpZXJyb3I9c3RyKGludmFsaWRfbG9naW4pKQogICAgZXhjZXB0IChyZXF1ZXN0cy5Db25uZWN0aW9uRXJyb3IsIHNzbC5TU0xFcnJvcikgYXMgY29ubmVjdGlvbl9lcnJvcjoKICAgICAgICBpZiAnW1NTTDogQ0VSVElGSUNBVEVfVkVSSUZZX0ZBSUxFRF0nIGluIHN0cihjb25uZWN0aW9uX2Vycm9yKSBhbmQgbm90IHZhbGlkYXRlX2NlcnRzOgogICAgICAgICAgICBjb250ZXh0ID0gc3NsLlNTTENvbnRleHQoc3NsLlBST1RPQ09MX1NTTHYyMykKICAgICAgICAgICAgY29udGV4dC52ZXJpZnlfbW9kZSA9IHNzbC5DRVJUX05PTkUKICAgICAgICAgICAgc2VydmljZV9pbnN0YW5jZSA9IGNvbm5lY3QuU21hcnRDb25uZWN0KGhvc3Q9aG9zdG5hbWUsIHVzZXI9dXNlcm5hbWUsIHB3ZD1wYXNzd29yZCwgc3NsQ29udGV4dD1jb250ZXh0KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1vZHVsZS5mYWlsX2pzb24obXNnPSJVbmFibGUgdG8gY29ubmVjdCB0byB2Q2VudGVyIG9yIEVTWGkgQVBJIG9uIFRDUC80NDMuIiwgYXBpZXJyb3I9c3RyKGNvbm5lY3Rpb25fZXJyb3IpKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGNvbnRleHQgPSBzc2wuU1NMQ29udGV4dChzc2wuUFJPVE9DT0xfU1NMdjIzKQogICAgICAgIGNvbnRleHQudmVyaWZ5X21vZGUgPSBzc2wuQ0VSVF9OT05FCiAgICAgICAgc2VydmljZV9pbnN0YW5jZSA9IGNvbm5lY3QuU21hcnRDb25uZWN0KGhvc3Q9aG9zdG5hbWUsIHVzZXI9dXNlcm5hbWUsIHB3ZD1wYXNzd29yZCwgc3NsQ29udGV4dD1jb250ZXh0KQoKICAgICMgRGlzYWJsaW5nIGF0ZXhpdCBzaG91bGQgYmUgdXNlZCBpbiBzcGVjaWFsIGNhc2VzIG9ubHkuCiAgICAjIFN1Y2ggYXMgSVAgY2hhbmdlIG9mIHRoZSBFU1hpIGhvc3Qgd2hpY2ggcmVtb3ZlcyB0aGUgY29ubmVjdGlvbiBhbnl3YXkuCiAgICAjIEFsc28gcmVtb3ZhbCBzaWduaWZpY2FudGx5IHNwZWVkcyB1cCB0aGUgcmV0dXJuIG9mIHRoZSBtb2R1bGUKICAgIGlmIGRpc2Nvbm5lY3RfYXRleGl0OgogICAgICAgIGF0ZXhpdC5yZWdpc3Rlcihjb25uZWN0LkRpc2Nvbm5lY3QsIHNlcnZpY2VfaW5zdGFuY2UpCiAgICByZXR1cm4gc2VydmljZV9pbnN0YW5jZS5SZXRyaWV2ZUNvbnRlbnQoKQoKCmRlZiBnZXRfYWxsX29ianMoY29udGVudCwgdmltdHlwZSwgZm9sZGVyPU5vbmUsIHJlY3Vyc2U9VHJ1ZSk6CiAgICBpZiBub3QgZm9sZGVyOgogICAgICAgIGZvbGRlciA9IGNvbnRlbnQucm9vdEZvbGRlcgoKICAgIG9iaiA9IHt9CiAgICBjb250YWluZXIgPSBjb250ZW50LnZpZXdNYW5hZ2VyLkNyZWF0ZUNvbnRhaW5lclZpZXcoZm9sZGVyLCB2aW10eXBlLCByZWN1cnNlKQogICAgZm9yIG1hbmFnZWRfb2JqZWN0X3JlZiBpbiBjb250YWluZXIudmlldzoKICAgICAgICBvYmoudXBkYXRlKHttYW5hZ2VkX29iamVjdF9yZWY6IG1hbmFnZWRfb2JqZWN0X3JlZi5uYW1lfSkKICAgIHJldHVybiBvYmoKCgpkZWYgZmV0Y2hfZmlsZV9mcm9tX2d1ZXN0KGNvbnRlbnQsIHZtLCB1c2VybmFtZSwgcGFzc3dvcmQsIHNyYywgZGVzdCk6CgogICAgIiIiIFVzZSBWTVdhcmUncyBmaWxlbWFuYWdlciBhcGkgdG8gZmV0Y2ggYSBmaWxlIG92ZXIgaHR0cCAiIiIKCiAgICByZXN1bHQgPSB7J2ZhaWxlZCc6IEZhbHNlfQoKICAgIHRvb2xzX3N0YXR1cyA9IHZtLmd1ZXN0LnRvb2xzU3RhdHVzCiAgICBpZiB0b29sc19zdGF0dXMgPT0gJ3Rvb2xzTm90SW5zdGFsbGVkJyBvciB0b29sc19zdGF0dXMgPT0gJ3Rvb2xzTm90UnVubmluZyc6CiAgICAgICAgcmVzdWx0WydmYWlsZWQnXSA9IFRydWUKICAgICAgICByZXN1bHRbJ21zZyddID0gIlZNd2FyZVRvb2xzIGlzIG5vdCBpbnN0YWxsZWQgb3IgaXMgbm90IHJ1bm5pbmcgaW4gdGhlIGd1ZXN0IgogICAgICAgIHJldHVybiByZXN1bHQKCiAgICAjIGh0dHBzOi8vZ2l0aHViLmNvbS92bXdhcmUvcHl2bW9taS9ibG9iL21hc3Rlci9kb2NzL3ZpbS92bS9ndWVzdC9OYW1lUGFzc3dvcmRBdXRoZW50aWNhdGlvbi5yc3QKICAgIGNyZWRzID0gdmltLnZtLmd1ZXN0Lk5hbWVQYXNzd29yZEF1dGhlbnRpY2F0aW9uKAogICAgICAgIHVzZXJuYW1lPXVzZXJuYW1lLCBwYXNzd29yZD1wYXNzd29yZAogICAgKQoKICAgICMgaHR0cHM6Ly9naXRodWIuY29tL3Ztd2FyZS9weXZtb21pL2Jsb2IvbWFzdGVyL2RvY3MvdmltL3ZtL2d1ZXN0L0ZpbGVNYW5hZ2VyL0ZpbGVUcmFuc2ZlckluZm9ybWF0aW9uLnJzdAogICAgZnRpID0gY29udGVudC5ndWVzdE9wZXJhdGlvbnNNYW5hZ2VyLmZpbGVNYW5hZ2VyLiBcCiAgICAgICAgSW5pdGlhdGVGaWxlVHJhbnNmZXJGcm9tR3Vlc3Qodm0sIGNyZWRzLCBzcmMpCgogICAgcmVzdWx0WydzaXplJ10gPSBmdGkuc2l6ZQogICAgcmVzdWx0Wyd1cmwnXSA9IGZ0aS51cmwKCiAgICAjIFVzZSBtb2R1bGVfdXRpbHMgdG8gZmV0Y2ggdGhlIHJlbW90ZSB1cmwgcmV0dXJuZWQgZnJvbSB0aGUgYXBpCiAgICByc3AsIGluZm8gPSBmZXRjaF91cmwoc2VsZi5tb2R1bGUsIGZ0aS51cmwsIHVzZV9wcm94eT1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JjZT1UcnVlLCBsYXN0X21vZF90aW1lPU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dD0xMCwgaGVhZGVycz1Ob25lKQoKICAgICMgc2F2ZSBhbGwgb2YgdGhlIHRyYW5zZmVyIGRhdGEKICAgIGZvciBrLCB2IGluIGl0ZXJpdGVtcyhpbmZvKToKICAgICAgICByZXN1bHRba10gPSB2CgogICAgIyBleGl0IGVhcmx5IGlmIHhmZXIgZmFpbGVkCiAgICBpZiBpbmZvWydzdGF0dXMnXSAhPSAyMDA6CiAgICAgICAgcmVzdWx0WydmYWlsZWQnXSA9IFRydWUKICAgICAgICByZXR1cm4gcmVzdWx0CgogICAgIyBhdHRlbXB0IHRvIHJlYWQgdGhlIGNvbnRlbnQgYW5kIHdyaXRlIGl0CiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGRlc3QsICd3YicpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUocnNwLnJlYWQoKSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXN1bHRbJ2ZhaWxlZCddID0gVHJ1ZQogICAgICAgIHJlc3VsdFsnbXNnJ10gPSBzdHIoZSkKCiAgICByZXR1cm4gcmVzdWx0CgoKZGVmIHB1c2hfZmlsZV90b19ndWVzdChjb250ZW50LCB2bSwgdXNlcm5hbWUsIHBhc3N3b3JkLCBzcmMsIGRlc3QsIG92ZXJ3cml0ZT1UcnVlKToKCiAgICAiIiIgVXNlIFZNV2FyZSdzIGZpbGVtYW5hZ2VyIGFwaSB0byBmZXRjaCBhIGZpbGUgb3ZlciBodHRwICIiIgoKICAgIHJlc3VsdCA9IHsnZmFpbGVkJzogRmFsc2V9CgogICAgdG9vbHNfc3RhdHVzID0gdm0uZ3Vlc3QudG9vbHNTdGF0dXMKICAgIGlmIHRvb2xzX3N0YXR1cyA9PSAndG9vbHNOb3RJbnN0YWxsZWQnIG9yIHRvb2xzX3N0YXR1cyA9PSAndG9vbHNOb3RSdW5uaW5nJzoKICAgICAgICByZXN1bHRbJ2ZhaWxlZCddID0gVHJ1ZQogICAgICAgIHJlc3VsdFsnbXNnJ10gPSAiVk13YXJlVG9vbHMgaXMgbm90IGluc3RhbGxlZCBvciBpcyBub3QgcnVubmluZyBpbiB0aGUgZ3Vlc3QiCiAgICAgICAgcmV0dXJuIHJlc3VsdAoKICAgICMgaHR0cHM6Ly9naXRodWIuY29tL3Ztd2FyZS9weXZtb21pL2Jsb2IvbWFzdGVyL2RvY3MvdmltL3ZtL2d1ZXN0L05hbWVQYXNzd29yZEF1dGhlbnRpY2F0aW9uLnJzdAogICAgY3JlZHMgPSB2aW0udm0uZ3Vlc3QuTmFtZVBhc3N3b3JkQXV0aGVudGljYXRpb24oCiAgICAgICAgdXNlcm5hbWU9dXNlcm5hbWUsIHBhc3N3b3JkPXBhc3N3b3JkCiAgICApCgogICAgIyB0aGUgYXBpIHJlcXVpcmVzIGEgZmlsZXNpemUgaW4gYnl0ZXMKICAgIGZkYXRhID0gTm9uZQogICAgdHJ5OgogICAgICAgICMgZmlsZXNpemUgPSBvcy5wYXRoLmdldHNpemUoc3JjKQogICAgICAgIGZpbGVzaXplID0gb3Muc3RhdChzcmMpLnN0X3NpemUKICAgICAgICB3aXRoIG9wZW4oc3JjLCAncmInKSBhcyBmOgogICAgICAgICAgICBmZGF0YSA9IGYucmVhZCgpCiAgICAgICAgcmVzdWx0Wydsb2NhbF9maWxlc2l6ZSddID0gZmlsZXNpemUKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXN1bHRbJ2ZhaWxlZCddID0gVHJ1ZQogICAgICAgIHJlc3VsdFsnbXNnJ10gPSAiVW5hYmxlIHRvIHJlYWQgc3JjIGZpbGU6ICVzIiAlIHN0cihlKQogICAgICAgIHJldHVybiByZXN1bHQKCiAgICAjIGh0dHBzOi8vd3d3LnZtd2FyZS5jb20vc3VwcG9ydC9kZXZlbG9wZXIvY29udmVydGVyLXNkay9jb252NjBfYXBpcmVmZXJlbmNlL3ZpbS52bS5ndWVzdC5GaWxlTWFuYWdlci5odG1sI2luaXRpYXRlRmlsZVRyYW5zZmVyVG9HdWVzdAogICAgZmlsZV9hdHRyaWJ1dGUgPSB2aW0udm0uZ3Vlc3QuRmlsZU1hbmFnZXIuRmlsZUF0dHJpYnV0ZXMoKQogICAgdXJsID0gY29udGVudC5ndWVzdE9wZXJhdGlvbnNNYW5hZ2VyLmZpbGVNYW5hZ2VyLiBcCiAgICAgICAgSW5pdGlhdGVGaWxlVHJhbnNmZXJUb0d1ZXN0KHZtLCBjcmVkcywgZGVzdCwgZmlsZV9hdHRyaWJ1dGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzaXplLCBvdmVyd3JpdGUpCgogICAgIyBQVVQgdGhlIGZpbGVkYXRhIHRvIHRoZSB1cmwgLi4uCiAgICByc3AsIGluZm8gPSBmZXRjaF91cmwoc2VsZi5tb2R1bGUsIHVybCwgbWV0aG9kPSJwdXQiLCBkYXRhPWZkYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgIHVzZV9wcm94eT1GYWxzZSwgZm9yY2U9VHJ1ZSwgbGFzdF9tb2RfdGltZT1Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQ9MTAsIGhlYWRlcnM9Tm9uZSkKCiAgICByZXN1bHRbJ21zZyddID0gc3RyKHJzcC5yZWFkKCkpCgogICAgIyBzYXZlIGFsbCBvZiB0aGUgdHJhbnNmZXIgZGF0YQogICAgZm9yIGssIHYgaW4gaXRlcml0ZW1zKGluZm8pOgogICAgICAgIHJlc3VsdFtrXSA9IHYKCiAgICByZXR1cm4gcmVzdWx0CgoKZGVmIHJ1bl9jb21tYW5kX2luX2d1ZXN0KGNvbnRlbnQsIHZtLCB1c2VybmFtZSwgcGFzc3dvcmQsIHByb2dyYW1fcGF0aCwgcHJvZ3JhbV9hcmdzLCBwcm9ncmFtX2N3ZCwgcHJvZ3JhbV9lbnYpOgoKICAgIHJlc3VsdCA9IHsnZmFpbGVkJzogRmFsc2V9CgogICAgdG9vbHNfc3RhdHVzID0gdm0uZ3Vlc3QudG9vbHNTdGF0dXMKICAgIGlmICh0b29sc19zdGF0dXMgPT0gJ3Rvb2xzTm90SW5zdGFsbGVkJyBvcgogICAgICAgICAgICAgICAgdG9vbHNfc3RhdHVzID09ICd0b29sc05vdFJ1bm5pbmcnKToKICAgICAgICByZXN1bHRbJ2ZhaWxlZCddID0gVHJ1ZQogICAgICAgIHJlc3VsdFsnbXNnJ10gPSAiVk13YXJlVG9vbHMgaXMgbm90IGluc3RhbGxlZCBvciBpcyBub3QgcnVubmluZyBpbiB0aGUgZ3Vlc3QiCiAgICAgICAgcmV0dXJuIHJlc3VsdAoKICAgICMgaHR0cHM6Ly9naXRodWIuY29tL3Ztd2FyZS9weXZtb21pL2Jsb2IvbWFzdGVyL2RvY3MvdmltL3ZtL2d1ZXN0L05hbWVQYXNzd29yZEF1dGhlbnRpY2F0aW9uLnJzdAogICAgY3JlZHMgPSB2aW0udm0uZ3Vlc3QuTmFtZVBhc3N3b3JkQXV0aGVudGljYXRpb24oCiAgICAgICAgdXNlcm5hbWU9dXNlcm5hbWUsIHBhc3N3b3JkPXBhc3N3b3JkCiAgICApCgogICAgdHJ5OgogICAgICAgICMgaHR0cHM6Ly9naXRodWIuY29tL3Ztd2FyZS9weXZtb21pL2Jsb2IvbWFzdGVyL2RvY3MvdmltL3ZtL2d1ZXN0L1Byb2Nlc3NNYW5hZ2VyLnJzdAogICAgICAgIHBtID0gY29udGVudC5ndWVzdE9wZXJhdGlvbnNNYW5hZ2VyLnByb2Nlc3NNYW5hZ2VyCiAgICAgICAgIyBodHRwczovL3d3dy52bXdhcmUuY29tL3N1cHBvcnQvZGV2ZWxvcGVyL2NvbnZlcnRlci1zZGsvY29udjUxX2FwaXJlZmVyZW5jZS92aW0udm0uZ3Vlc3QuUHJvY2Vzc01hbmFnZXIuUHJvZ3JhbVNwZWMuaHRtbAogICAgICAgIHBzID0gdmltLnZtLmd1ZXN0LlByb2Nlc3NNYW5hZ2VyLlByb2dyYW1TcGVjKAogICAgICAgICAgICAjIHByb2dyYW1QYXRoPXByb2dyYW0sCiAgICAgICAgICAgICMgYXJndW1lbnRzPWFyZ3MKICAgICAgICAgICAgcHJvZ3JhbVBhdGg9cHJvZ3JhbV9wYXRoLAogICAgICAgICAgICBhcmd1bWVudHM9cHJvZ3JhbV9hcmdzLAogICAgICAgICAgICB3b3JraW5nRGlyZWN0b3J5PXByb2dyYW1fY3dkLAogICAgICAgICkKCiAgICAgICAgcmVzID0gcG0uU3RhcnRQcm9ncmFtSW5HdWVzdCh2bSwgY3JlZHMsIHBzKQogICAgICAgIHJlc3VsdFsncGlkJ10gPSByZXMKICAgICAgICBwZGF0YSA9IHBtLkxpc3RQcm9jZXNzZXNJbkd1ZXN0KHZtLCBjcmVkcywgW3Jlc10pCgogICAgICAgICMgd2FpdCBmb3IgcGlkIHRvIGZpbmlzaAogICAgICAgIHdoaWxlIG5vdCBwZGF0YVswXS5lbmRUaW1lOgogICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAgICAgICAgIHBkYXRhID0gcG0uTGlzdFByb2Nlc3Nlc0luR3Vlc3Qodm0sIGNyZWRzLCBbcmVzXSkKCiAgICAgICAgcmVzdWx0Wydvd25lciddID0gcGRhdGFbMF0ub3duZXIKICAgICAgICByZXN1bHRbJ3N0YXJ0VGltZSddID0gcGRhdGFbMF0uc3RhcnRUaW1lLmlzb2Zvcm1hdCgpCiAgICAgICAgcmVzdWx0WydlbmRUaW1lJ10gPSBwZGF0YVswXS5lbmRUaW1lLmlzb2Zvcm1hdCgpCiAgICAgICAgcmVzdWx0WydleGl0Q29kZSddID0gcGRhdGFbMF0uZXhpdENvZGUKICAgICAgICBpZiByZXN1bHRbJ2V4aXRDb2RlJ10gIT0gMDoKICAgICAgICAgICAgcmVzdWx0WydmYWlsZWQnXSA9IFRydWUKICAgICAgICAgICAgcmVzdWx0Wydtc2cnXSA9ICJwcm9ncmFtIGV4aXRlZCBub24temVybyIKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXN1bHRbJ21zZyddID0gInByb2dyYW0gY29tcGxldGVkIHN1Y2Nlc3NmdWxseSIKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmVzdWx0Wydtc2cnXSA9IHN0cihlKQogICAgICAgIHJlc3VsdFsnZmFpbGVkJ10gPSBUcnVlCgogICAgcmV0dXJuIHJlc3VsdApQSwMEFAAAAAAAAbwrS7XYBAYlMAAAJTAAAB0AAABhbnNpYmxlL21vZHVsZV91dGlscy9fdGV4dC5weSMgVGhpcyBjb2RlIGlzIHBhcnQgb2YgQW5zaWJsZSwgYnV0IGlzIGFuIGluZGVwZW5kZW50IGNvbXBvbmVudC4KIyBUaGlzIHBhcnRpY3VsYXIgZmlsZSBzbmlwcGV0LCBhbmQgdGhpcyBmaWxlIHNuaXBwZXQgb25seSwgaXMgQlNEIGxpY2Vuc2VkLgojIE1vZHVsZXMgeW91IHdyaXRlIHVzaW5nIHRoaXMgc25pcHBldCwgd2hpY2ggaXMgZW1iZWRkZWQgZHluYW1pY2FsbHkgYnkgQW5zaWJsZQojIHN0aWxsIGJlbG9uZyB0byB0aGUgYXV0aG9yIG9mIHRoZSBtb2R1bGUsIGFuZCBtYXkgYXNzaWduIHRoZWlyIG93biBsaWNlbnNlCiMgdG8gdGhlIGNvbXBsZXRlIHdvcmsuCiMKIyBDb3B5cmlnaHQgKGMpLCBUb3NoaW8gS3VyYXRvbWkgPGEuYmFkZ2VyQGdtYWlsLmNvbT4sIDIwMTYKIwojIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dCBtb2RpZmljYXRpb24sCiMgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgojCiMgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAojICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgojICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAojICAgICAgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbgojICAgICAgYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCiMKIyBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5ECiMgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRUQKIyBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuCiMgSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsCiMgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLAojIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUwojIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QKIyBMSUFCSUxJVFksIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUKIyBVU0UgT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KIwoKIiIiCi4uIHdhcm46OiBUaGlzIG1vZHVsZV91dGlsIGlzIGN1cnJlbnRseSBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbi4KICAgIFdlIHdhbnQgdG8gZXZhbHVhdGUgdGhpcyBjb2RlIGZvciBzdGFiaWxpdHkgYW5kIEFQSSBzdWl0YWJpbGl0eSBiZWZvcmUKICAgIG1ha2luZyBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBndWFyYW50ZWVzLiAgVGhlIEFQSSBtYXkgY2hhbmdlIGJldHdlZW4KICAgIHJlbGVhc2VzLiAgRG8gbm90IHVzZSB0aGlzIHVubGVzcyB5b3UgYXJlIHdpbGxpbmcgdG8gcG9ydCB5b3VyIG1vZHVsZSBjb2RlLgoiIiIKaW1wb3J0IGNvZGVjcwoKZnJvbSBhbnNpYmxlLm1vZHVsZV91dGlscy5zaXggaW1wb3J0IFBZMywgdGV4dF90eXBlLCBiaW5hcnlfdHlwZQoKCnRyeToKICAgIGNvZGVjcy5sb29rdXBfZXJyb3IoJ3N1cnJvZ2F0ZWVzY2FwZScpCiAgICBIQVNfU1VSUk9HQVRFRVNDQVBFID0gVHJ1ZQpleGNlcHQgTG9va3VwRXJyb3I6CiAgICBIQVNfU1VSUk9HQVRFRVNDQVBFID0gRmFsc2UKCgpfQ09NUE9TRURfRVJST1JfSEFORExFUlMgPSBmcm96ZW5zZXQoKE5vbmUsICdzdXJyb2dhdGVfb3JfZXNjYXBlJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdXJyb2dhdGVfb3Jfc3RyaWN0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdXJyb2dhdGVfdGhlbl9yZXBsYWNlJykpCgoKZGVmIHRvX2J5dGVzKG9iaiwgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPU5vbmUsIG5vbnN0cmluZz0nc2ltcGxlcmVwcicpOgogICAgIiIiTWFrZSBzdXJlIHRoYXQgYSBzdHJpbmcgaXMgYSBieXRlIHN0cmluZwoKICAgIDphcmcgb2JqOiBBbiBvYmplY3QgdG8gbWFrZSBzdXJlIGlzIGEgYnl0ZSBzdHJpbmcuICBJbiBtb3N0IGNhc2VzIHRoaXMKICAgICAgICB3aWxsIGJlIGVpdGhlciBhIHRleHQgc3RyaW5nIG9yIGEgYnl0ZSBzdHJpbmcuICBIb3dldmVyLCB3aXRoCiAgICAgICAgYGBub25zdHJpbmc9J3NpbXBsZXJlcHInYGAsIHRoaXMgY2FuIGJlIHVzZWQgYXMgYSB0cmFjZWJhY2stZnJlZQogICAgICAgIHZlcnNpb24gb2YgYGBzdHIob2JqKWBgLgogICAgOmt3YXJnIGVuY29kaW5nOiBUaGUgZW5jb2RpbmcgdG8gdXNlIHRvIHRyYW5zZm9ybSBmcm9tIGEgdGV4dCBzdHJpbmcgdG8KICAgICAgICBhIGJ5dGUgc3RyaW5nLiAgRGVmYXVsdHMgdG8gdXNpbmcgJ3V0Zi04Jy4KICAgIDprd2FyZyBlcnJvcnM6IFRoZSBlcnJvciBoYW5kbGVyIHRvIHVzZSBpZiB0aGUgdGV4dCBzdHJpbmcgaXMgbm90CiAgICAgICAgZW5jb2RhYmxlIHVzaW5nIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcuICBBbnkgdmFsaWQgYGNvZGVjcyBlcnJvcgogICAgICAgIGhhbmRsZXIgPGh0dHBzOi8vZG9jcy5weXRob24ub3JnLzIvbGlicmFyeS9jb2RlY3MuaHRtbCNjb2RlYy1iYXNlLWNsYXNzZXM+YF8KICAgICAgICBtYXkgYmUgc3BlY2lmaWVkLiBUaGVyZSBhcmUgdGhyZWUgYWRkaXRpb25hbCBlcnJvciBzdHJhdGVnaWVzCiAgICAgICAgc3BlY2lmaWNhbGx5IGFpbWVkIGF0IGhlbHBpbmcgcGVvcGxlIHRvIHBvcnQgY29kZS4gIFRoZSBmaXJzdCB0d28gYXJlOgoKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9zdHJpY3Q6IFdpbGwgdXNlIGBgc3Vycm9nYXRlZXNjYXBlYGAgaWYgaXQgaXMgYSB2YWxpZAogICAgICAgICAgICAgICAgaGFuZGxlciwgb3RoZXJ3aXNlIGl0IHdpbGwgdXNlIGBgc3RyaWN0YGAKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9yZXBsYWNlOiBXaWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSBgYHJlcGxhY2VgYC4KCiAgICAgICAgQmVjYXVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIHdhcyBhZGRlZCBpbiBQeXRob24zIHRoaXMgdXN1YWxseSBtZWFucyB0aGF0CiAgICAgICAgUHl0aG9uMyB3aWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGFuZCBQeXRob24yIHdpbGwgdXNlIHRoZSBmYWxsYmFjawogICAgICAgIGVycm9yIGhhbmRsZXIuIE5vdGUgdGhhdCB0aGUgY29kZSBjaGVja3MgZm9yIGBgc3Vycm9nYXRlZXNjYXBlYGAgd2hlbiB0aGUKICAgICAgICBtb2R1bGUgaXMgaW1wb3J0ZWQuICBJZiB5b3UgaGF2ZSBhIGJhY2twb3J0IG9mIGBgc3Vycm9nYXRlZXNjYXBlYGAgZm9yCiAgICAgICAgUHl0aG9uMiwgYmUgc3VyZSB0byByZWdpc3RlciB0aGUgZXJyb3IgaGFuZGxlciBwcmlvciB0byBpbXBvcnRpbmcgdGhpcwogICAgICAgIG1vZHVsZS4KCiAgICAgICAgVGhlIGxhc3QgZXJyb3IgaGFuZGxlciBpczoKCiAgICAgICAgICAgIDpzdXJyb2dhdGVfdGhlbl9yZXBsYWNlOiBXaWxsIHVzZSBgYHN1cnJvZ2F0ZWVzY2FwZWBgIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIuICBJZiBlbmNvZGluZyB3aXRoIGBgc3Vycm9nYXRlZXNjYXBlYGAgd291bGQgdHJhY2ViYWNrLAogICAgICAgICAgICAgICAgc3Vycm9nYXRlcyBhcmUgZmlyc3QgcmVwbGFjZWQgd2l0aCBhIHJlcGxhY2VtZW50IGNoYXJhY3RlcnMKICAgICAgICAgICAgICAgIGFuZCB0aGVuIHRoZSBzdHJpbmcgaXMgZW5jb2RlZCB1c2luZyBgYHJlcGxhY2VgYCAod2hpY2ggcmVwbGFjZXMKICAgICAgICAgICAgICAgIHRoZSByZXN0IG9mIHRoZSBub25lbmNvZGFibGUgYnl0ZXMpLiAgSWYgYGBzdXJyb2dhdGVlc2NhcGVgYCBpcwogICAgICAgICAgICAgICAgbm90IHByZXNlbnQgaXQgd2lsbCBzaW1wbHkgdXNlIGBgcmVwbGFjZWBgLiAgKEFkZGVkIGluIEFuc2libGUgMi4zKQogICAgICAgICAgICAgICAgVGhpcyBzdHJhdGVneSBpcyBkZXNpZ25lZCB0byBuZXZlciB0cmFjZWJhY2sgd2hlbiBpdCBhdHRlbXB0cwogICAgICAgICAgICAgICAgdG8gZW5jb2RlIGEgc3RyaW5nLgoKICAgICAgICBUaGUgZGVmYXVsdCB1bnRpbCBBbnNpYmxlLTIuMiB3YXMgYGBzdXJyb2dhdGVfb3JfcmVwbGFjZWBgCiAgICAgICAgRnJvbSBBbnNpYmxlLTIuMyBvbndhcmRzLCB0aGUgZGVmYXVsdCBpcyBgYHN1cnJvZ2F0ZV90aGVuX3JlcGxhY2VgYC4KCiAgICA6a3dhcmcgbm9uc3RyaW5nOiBUaGUgc3RyYXRlZ3kgdG8gdXNlIGlmIGEgbm9uc3RyaW5nIGlzIHNwZWNpZmllZCBpbgogICAgICAgIGBgb2JqYGAuICBEZWZhdWx0IGlzICdzaW1wbGVyZXByJy4gIFZhbGlkIHZhbHVlcyBhcmU6CgogICAgICAgIDpzaW1wbGVyZXByOiBUaGUgZGVmYXVsdC4gIFRoaXMgdGFrZXMgdGhlIGBgc3RyYGAgb2YgdGhlIG9iamVjdCBhbmQKICAgICAgICAgICAgdGhlbiByZXR1cm5zIHRoZSBieXRlcyB2ZXJzaW9uIG9mIHRoYXQgc3RyaW5nLgogICAgICAgIDplbXB0eTogUmV0dXJuIGFuIGVtcHR5IGJ5dGUgc3RyaW5nCiAgICAgICAgOnBhc3N0aHJ1OiBSZXR1cm4gdGhlIG9iamVjdCBwYXNzZWQgaW4KICAgICAgICA6c3RyaWN0OiBSYWlzZSBhIDpleGM6YFR5cGVFcnJvcmAKCiAgICA6cmV0dXJuczogVHlwaWNhbGx5IHRoaXMgcmV0dXJucyBhIGJ5dGUgc3RyaW5nLiAgSWYgYSBub25zdHJpbmcgb2JqZWN0IGlzCiAgICAgICAgcGFzc2VkIGluIHRoaXMgbWF5IGJlIGEgZGlmZmVyZW50IHR5cGUgZGVwZW5kaW5nIG9uIHRoZSBzdHJhdGVneQogICAgICAgIHNwZWNpZmllZCBieSBub25zdHJpbmcuICBUaGlzIHdpbGwgbmV2ZXIgcmV0dXJuIGEgdGV4dCBzdHJpbmcuCgogICAgLi4gbm90ZTo6IElmIHBhc3NlZCBhIGJ5dGUgc3RyaW5nLCB0aGlzIGZ1bmN0aW9uIGRvZXMgbm90IGNoZWNrIHRoYXQgdGhlCiAgICAgICAgc3RyaW5nIGlzIHZhbGlkIGluIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcuICBJZiBpdCdzIGltcG9ydGFudCB0aGF0IHRoZQogICAgICAgIGJ5dGUgc3RyaW5nIGlzIGluIHRoZSBzcGVjaWZpZWQgZW5jb2RpbmcgZG86OgoKICAgICAgICAgICAgZW5jb2RlZF9zdHJpbmcgPSB0b19ieXRlcyh0b190ZXh0KGlucHV0X3N0cmluZywgJ2xhdGluLTEnKSwgJ3V0Zi04JykKCiAgICAuLiB2ZXJzaW9uX2NoYW5nZWQ6OiAyLjMKCiAgICAgICAgQWRkZWQgdGhlIGBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWBgIGVycm9yIGhhbmRsZXIgYW5kIG1hZGUgaXQgdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlci4KICAgICIiIgogICAgaWYgaXNpbnN0YW5jZShvYmosIGJpbmFyeV90eXBlKToKICAgICAgICByZXR1cm4gb2JqCgogICAgIyBXZSdyZSBnaXZlbiBhIHRleHQgc3RyaW5nCiAgICAjIElmIGl0IGhhcyBzdXJyb2dhdGVzLCB3ZSBrbm93IGJlY2F1c2UgaXQgd2lsbCBkZWNvZGUKICAgIG9yaWdpbmFsX2Vycm9ycyA9IGVycm9ycwogICAgaWYgZXJyb3JzIGluIF9DT01QT1NFRF9FUlJPUl9IQU5ETEVSUzoKICAgICAgICBpZiBIQVNfU1VSUk9HQVRFRVNDQVBFOgogICAgICAgICAgICBlcnJvcnMgPSAnc3Vycm9nYXRlZXNjYXBlJwogICAgICAgIGVsaWYgZXJyb3JzID09ICdzdXJyb2dhdGVfb3Jfc3RyaWN0JzoKICAgICAgICAgICAgZXJyb3JzID0gJ3N0cmljdCcKICAgICAgICBlbHNlOgogICAgICAgICAgICBlcnJvcnMgPSAncmVwbGFjZScKCiAgICBpZiBpc2luc3RhbmNlKG9iaiwgdGV4dF90eXBlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVHJ5IHRoaXMgZmlyc3QgYXMgaXQncyB0aGUgZmFzdGVzdAogICAgICAgICAgICByZXR1cm4gb2JqLmVuY29kZShlbmNvZGluZywgZXJyb3JzKQogICAgICAgIGV4Y2VwdCBVbmljb2RlRW5jb2RlRXJyb3I6CiAgICAgICAgICAgIGlmIG9yaWdpbmFsX2Vycm9ycyBpbiAoTm9uZSwgJ3N1cnJvZ2F0ZV90aGVuX3JlcGxhY2UnKToKICAgICAgICAgICAgICAgICMgU2xvdyBidXQgd29ya3MKICAgICAgICAgICAgICAgIHJldHVybl9zdHJpbmcgPSBvYmouZW5jb2RlKCd1dGYtOCcsICdzdXJyb2dhdGVlc2NhcGUnKQogICAgICAgICAgICAgICAgcmV0dXJuX3N0cmluZyA9IHJldHVybl9zdHJpbmcuZGVjb2RlKCd1dGYtOCcsICdyZXBsYWNlJykKICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5fc3RyaW5nLmVuY29kZShlbmNvZGluZywgJ3JlcGxhY2UnKQogICAgICAgICAgICByYWlzZQoKICAgICMgTm90ZTogV2UgZG8gdGhlc2UgbGFzdCBldmVuIHRob3VnaCB3ZSBoYXZlIHRvIGNhbGwgdG9fYnl0ZXMgYWdhaW4gb24gdGhlCiAgICAjIHZhbHVlIGJlY2F1c2Ugd2UncmUgb3B0aW1pemluZyB0aGUgY29tbW9uIGNhc2UKICAgIGlmIG5vbnN0cmluZyA9PSAnc2ltcGxlcmVwcic6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWx1ZSA9IHN0cihvYmopCiAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdmFsdWUgPSByZXByKG9iaikKICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgICMgR2l2aW5nIHVwCiAgICAgICAgICAgICAgICByZXR1cm4gdG9fYnl0ZXMoJycpCiAgICBlbGlmIG5vbnN0cmluZyA9PSAncGFzc3RocnUnOgogICAgICAgIHJldHVybiBvYmoKICAgIGVsaWYgbm9uc3RyaW5nID09ICdlbXB0eSc6CiAgICAgICAgIyBweXRob24yLjQgZG9lc24ndCBoYXZlIGInJwogICAgICAgIHJldHVybiB0b19ieXRlcygnJykKICAgIGVsaWYgbm9uc3RyaW5nID09ICdzdHJpY3QnOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignb2JqIG11c3QgYmUgYSBzdHJpbmcgdHlwZScpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcignSW52YWxpZCB2YWx1ZSAlcyBmb3IgdG9fYnl0ZXNcJyBub25zdHJpbmcgcGFyYW1ldGVyJyAlIG5vbnN0cmluZykKCiAgICByZXR1cm4gdG9fYnl0ZXModmFsdWUsIGVuY29kaW5nLCBlcnJvcnMpCgoKZGVmIHRvX3RleHQob2JqLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9Tm9uZSwgbm9uc3RyaW5nPSdzaW1wbGVyZXByJyk6CiAgICAiIiJNYWtlIHN1cmUgdGhhdCBhIHN0cmluZyBpcyBhIHRleHQgc3RyaW5nCgogICAgOmFyZyBvYmo6IEFuIG9iamVjdCB0byBtYWtlIHN1cmUgaXMgYSB0ZXh0IHN0cmluZy4gIEluIG1vc3QgY2FzZXMgdGhpcwogICAgICAgIHdpbGwgYmUgZWl0aGVyIGEgdGV4dCBzdHJpbmcgb3IgYSBieXRlIHN0cmluZy4gIEhvd2V2ZXIsIHdpdGgKICAgICAgICBgYG5vbnN0cmluZz0nc2ltcGxlcmVwcidgYCwgdGhpcyBjYW4gYmUgdXNlZCBhcyBhIHRyYWNlYmFjay1mcmVlCiAgICAgICAgdmVyc2lvbiBvZiBgYHN0cihvYmopYGAuCiAgICA6a3dhcmcgZW5jb2Rpbmc6IFRoZSBlbmNvZGluZyB0byB1c2UgdG8gdHJhbnNmb3JtIGZyb20gYSBieXRlIHN0cmluZyB0bwogICAgICAgIGEgdGV4dCBzdHJpbmcuICBEZWZhdWx0cyB0byB1c2luZyAndXRmLTgnLgogICAgOmt3YXJnIGVycm9yczogVGhlIGVycm9yIGhhbmRsZXIgdG8gdXNlIGlmIHRoZSBieXRlIHN0cmluZyBpcyBub3QKICAgICAgICBkZWNvZGFibGUgdXNpbmcgdGhlIHNwZWNpZmllZCBlbmNvZGluZy4gIEFueSB2YWxpZCBgY29kZWNzIGVycm9yCiAgICAgICAgaGFuZGxlciA8aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMi9saWJyYXJ5L2NvZGVjcy5odG1sI2NvZGVjLWJhc2UtY2xhc3Nlcz5gXwogICAgICAgIG1heSBiZSBzcGVjaWZpZWQuICAgV2Ugc3VwcG9ydCB0aHJlZSBhZGRpdGlvbmFsIGVycm9yIHN0cmF0ZWdpZXMKICAgICAgICBzcGVjaWZpY2FsbHkgYWltZWQgYXQgaGVscGluZyBwZW9wbGUgdG8gcG9ydCBjb2RlOgoKICAgICAgICAgICAgOnN1cnJvZ2F0ZV9vcl9zdHJpY3Q6IFdpbGwgdXNlIHN1cnJvZ2F0ZWVzY2FwZSBpZiBpdCBpcyBhIHZhbGlkCiAgICAgICAgICAgICAgICBoYW5kbGVyLCBvdGhlcndpc2UgaXQgd2lsbCB1c2Ugc3RyaWN0CiAgICAgICAgICAgIDpzdXJyb2dhdGVfb3JfcmVwbGFjZTogV2lsbCB1c2Ugc3Vycm9nYXRlZXNjYXBlIGlmIGl0IGlzIGEgdmFsaWQKICAgICAgICAgICAgICAgIGhhbmRsZXIsIG90aGVyd2lzZSBpdCB3aWxsIHVzZSByZXBsYWNlLgogICAgICAgICAgICA6c3Vycm9nYXRlX3RoZW5fcmVwbGFjZTogRG9lcyB0aGUgc2FtZSBhcyBzdXJyb2dhdGVfb3JfcmVwbGFjZSBidXQKICAgICAgICAgICAgICAgIGB3YXMgYWRkZWQgZm9yIHN5bW1ldHJ5IHdpdGggdGhlIGVycm9yIGhhbmRsZXJzIGluCiAgICAgICAgICAgICAgICA6ZnVuYzpgYW5zaWJsZS5tb2R1bGVfdXRpbHMuX3RleHQudG9fYnl0ZXNgIChBZGRlZCBpbiBBbnNpYmxlIDIuMykKCiAgICAgICAgQmVjYXVzZSBzdXJyb2dhdGVlc2NhcGUgd2FzIGFkZGVkIGluIFB5dGhvbjMgdGhpcyB1c3VhbGx5IG1lYW5zIHRoYXQKICAgICAgICBQeXRob24zIHdpbGwgdXNlIGBzdXJyb2dhdGVlc2NhcGVgIGFuZCBQeXRob24yIHdpbGwgdXNlIHRoZSBmYWxsYmFjawogICAgICAgIGVycm9yIGhhbmRsZXIuIE5vdGUgdGhhdCB0aGUgY29kZSBjaGVja3MgZm9yIHN1cnJvZ2F0ZWVzY2FwZSB3aGVuIHRoZQogICAgICAgIG1vZHVsZSBpcyBpbXBvcnRlZC4gIElmIHlvdSBoYXZlIGEgYmFja3BvcnQgb2YgYHN1cnJvZ2F0ZWVzY2FwZWAgZm9yCiAgICAgICAgcHl0aG9uMiwgYmUgc3VyZSB0byByZWdpc3RlciB0aGUgZXJyb3IgaGFuZGxlciBwcmlvciB0byBpbXBvcnRpbmcgdGhpcwogICAgICAgIG1vZHVsZS4KCiAgICAgICAgVGhlIGRlZmF1bHQgdW50aWwgQW5zaWJsZS0yLjIgd2FzIGBzdXJyb2dhdGVfb3JfcmVwbGFjZWAKICAgICAgICBJbiBBbnNpYmxlLTIuMyB0aGlzIGRlZmF1bHRzIHRvIGBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlYCBmb3Igc3ltbWV0cnkKICAgICAgICB3aXRoIDpmdW5jOmBhbnNpYmxlLm1vZHVsZV91dGlscy5fdGV4dC50b19ieXRlc2AgLgogICAgOmt3YXJnIG5vbnN0cmluZzogVGhlIHN0cmF0ZWd5IHRvIHVzZSBpZiBhIG5vbnN0cmluZyBpcyBzcGVjaWZpZWQgaW4KICAgICAgICBgYG9iamBgLiAgRGVmYXVsdCBpcyAnc2ltcGxlcmVwcicuICBWYWxpZCB2YWx1ZXMgYXJlOgoKICAgICAgICA6c2ltcGxlcmVwcjogVGhlIGRlZmF1bHQuICBUaGlzIHRha2VzIHRoZSBgYHN0cmBgIG9mIHRoZSBvYmplY3QgYW5kCiAgICAgICAgICAgIHRoZW4gcmV0dXJucyB0aGUgdGV4dCB2ZXJzaW9uIG9mIHRoYXQgc3RyaW5nLgogICAgICAgIDplbXB0eTogUmV0dXJuIGFuIGVtcHR5IHRleHQgc3RyaW5nCiAgICAgICAgOnBhc3N0aHJ1OiBSZXR1cm4gdGhlIG9iamVjdCBwYXNzZWQgaW4KICAgICAgICA6c3RyaWN0OiBSYWlzZSBhIDpleGM6YFR5cGVFcnJvcmAKCiAgICA6cmV0dXJuczogVHlwaWNhbGx5IHRoaXMgcmV0dXJucyBhIHRleHQgc3RyaW5nLiAgSWYgYSBub25zdHJpbmcgb2JqZWN0IGlzCiAgICAgICAgcGFzc2VkIGluIHRoaXMgbWF5IGJlIGEgZGlmZmVyZW50IHR5cGUgZGVwZW5kaW5nIG9uIHRoZSBzdHJhdGVneQogICAgICAgIHNwZWNpZmllZCBieSBub25zdHJpbmcuICBUaGlzIHdpbGwgbmV2ZXIgcmV0dXJuIGEgYnl0ZSBzdHJpbmcuCiAgICAgICAgRnJvbSBBbnNpYmxlLTIuMyBvbndhcmRzLCB0aGUgZGVmYXVsdCBpcyBgc3Vycm9nYXRlX3RoZW5fcmVwbGFjZWAuCgogICAgLi4gdmVyc2lvbl9jaGFuZ2VkOjogMi4zCgogICAgICAgIEFkZGVkIHRoZSBzdXJyb2dhdGVfdGhlbl9yZXBsYWNlIGVycm9yIGhhbmRsZXIgYW5kIG1hZGUgaXQgdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlci4KICAgICIiIgogICAgaWYgaXNpbnN0YW5jZShvYmosIHRleHRfdHlwZSk6CiAgICAgICAgcmV0dXJuIG9iagoKICAgIGlmIGVycm9ycyBpbiBfQ09NUE9TRURfRVJST1JfSEFORExFUlM6CiAgICAgICAgaWYgSEFTX1NVUlJPR0FURUVTQ0FQRToKICAgICAgICAgICAgZXJyb3JzID0gJ3N1cnJvZ2F0ZWVzY2FwZScKICAgICAgICBlbGlmIGVycm9ycyA9PSAnc3Vycm9nYXRlX29yX3N0cmljdCc6CiAgICAgICAgICAgIGVycm9ycyA9ICdzdHJpY3QnCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZXJyb3JzID0gJ3JlcGxhY2UnCgogICAgaWYgaXNpbnN0YW5jZShvYmosIGJpbmFyeV90eXBlKToKICAgICAgICAjIE5vdGU6IFdlIGRvbid0IG5lZWQgc3BlY2lhbCBoYW5kbGluZyBmb3Igc3Vycm9nYXRlX3RoZW5fcmVwbGFjZQogICAgICAgICMgYmVjYXVzZSBhbGwgYnl0ZXMgd2lsbCBlaXRoZXIgYmUgbWFkZSBpbnRvIHN1cnJvZ2F0ZXMgb3IgYXJlIHZhbGlkCiAgICAgICAgIyB0byBkZWNvZGUuCiAgICAgICAgcmV0dXJuIG9iai5kZWNvZGUoZW5jb2RpbmcsIGVycm9ycykKCiAgICAjIE5vdGU6IFdlIGRvIHRoZXNlIGxhc3QgZXZlbiB0aG91Z2ggd2UgaGF2ZSB0byBjYWxsIHRvX3RleHQgYWdhaW4gb24gdGhlCiAgICAjIHZhbHVlIGJlY2F1c2Ugd2UncmUgb3B0aW1pemluZyB0aGUgY29tbW9uIGNhc2UKICAgIGlmIG5vbnN0cmluZyA9PSAnc2ltcGxlcmVwcic6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWx1ZSA9IHN0cihvYmopCiAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdmFsdWUgPSByZXByKG9iaikKICAgICAgICAgICAgZXhjZXB0IFVuaWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgICMgR2l2aW5nIHVwCiAgICAgICAgICAgICAgICByZXR1cm4gdScnCiAgICBlbGlmIG5vbnN0cmluZyA9PSAncGFzc3RocnUnOgogICAgICAgIHJldHVybiBvYmoKICAgIGVsaWYgbm9uc3RyaW5nID09ICdlbXB0eSc6CiAgICAgICAgcmV0dXJuIHUnJwogICAgZWxpZiBub25zdHJpbmcgPT0gJ3N0cmljdCc6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdvYmogbXVzdCBiZSBhIHN0cmluZyB0eXBlJykKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdJbnZhbGlkIHZhbHVlICVzIGZvciB0b190ZXh0XCdzIG5vbnN0cmluZyBwYXJhbWV0ZXInICUgbm9uc3RyaW5nKQoKICAgIHJldHVybiB0b190ZXh0KHZhbHVlLCBlbmNvZGluZywgZXJyb3JzKQoKCiM6IDpweTpmdW5jOmB0b19uYXRpdmVgCiM6ICAgICAgVHJhbnNmb3JtIGEgdmFyaWFibGUgaW50byB0aGUgbmF0aXZlIHN0ciB0eXBlIGZvciB0aGUgcHl0aG9uIHZlcnNpb24KIzoKIzogICAgICBPbiBQeXRob24yLCB0aGlzIGlzIGFuIGFsaWFzIGZvcgojOiAgICAgIDpmdW5jOmB+YW5zaWJsZS5tb2R1bGVfdXRpbHMudG9fYnl0ZXNgLiAgT24gUHl0aG9uMyBpdCBpcyBhbiBhbGlhcyBmb3IKIzogICAgICA6ZnVuYzpgfmFuc2libGUubW9kdWxlX3V0aWxzLnRvX3RleHRgLiAgSXQgbWFrZXMgaXQgZWFzaWVyIHRvCiM6ICAgICAgdHJhbnNmb3JtIGEgdmFyaWFibGUgaW50byB0aGUgbmF0aXZlIHN0ciB0eXBlIGZvciB0aGUgcHl0aG9uIHZlcnNpb24KIzogICAgICB0aGUgY29kZSBpcyBydW5uaW5nIG9uLiAgVXNlIHRoaXMgd2hlbiBjb25zdHJ1Y3RpbmcgdGhlIG1lc3NhZ2UgdG8KIzogICAgICBzZW5kIHRvIGV4Y2VwdGlvbnMgb3Igd2hlbiBkZWFsaW5nIHdpdGggYW4gQVBJIHRoYXQgbmVlZHMgdG8gdGFrZQojOiAgICAgIGEgbmF0aXZlIHN0cmluZy4gIEV4YW1wbGU6OgojOgojOiAgICAgICAgICB0cnk6CiM6ICAgICAgICAgICAgICAxLy8wCiM6ICAgICAgICAgIGV4Y2VwdCBaZXJvRGl2aXNpb25FcnJvciBhcyBlOgojOiAgICAgICAgICAgICAgcmFpc2UgTXlFeGNlcHRpb24oJ0VuY291bnRlcmVkIGFuZCBlcnJvcjogJXMnICUgdG9fbmF0aXZlKGUpKQppZiBQWTM6CiAgICB0b19uYXRpdmUgPSB0b190ZXh0CmVsc2U6CiAgICB0b19uYXRpdmUgPSB0b19ieXRlcwpQSwMEFAAAAAAAAbwrSzjix9GRdQAAkXUAACAAAABhbnNpYmxlL21vZHVsZV91dGlscy9zaXgvX3NpeC5weSIiIlV0aWxpdGllcyBmb3Igd3JpdGluZyBjb2RlIHRoYXQgcnVucyBvbiBQeXRob24gMiBhbmQgMyIiIgoKIyBDb3B5cmlnaHQgKGMpIDIwMTAtMjAxNSBCZW5qYW1pbiBQZXRlcnNvbgojCiMgUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQojIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiMgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwojIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKIyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKIyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgojCiMgVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCiMgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KIwojIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiMgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiMgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiMgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgojIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiMgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKIyBTT0ZUV0FSRS4KCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgYWJzb2x1dGVfaW1wb3J0CgppbXBvcnQgZnVuY3Rvb2xzCmltcG9ydCBpdGVydG9vbHMKaW1wb3J0IG9wZXJhdG9yCmltcG9ydCBzeXMKaW1wb3J0IHR5cGVzCgpfX2F1dGhvcl9fID0gIkJlbmphbWluIFBldGVyc29uIDxiZW5qYW1pbkBweXRob24ub3JnPiIKX192ZXJzaW9uX18gPSAiMS4xMC4wIgoKCiMgVXNlZnVsIGZvciB2ZXJ5IGNvYXJzZSB2ZXJzaW9uIGRpZmZlcmVudGlhdGlvbi4KUFkyID0gc3lzLnZlcnNpb25faW5mb1swXSA9PSAyClBZMyA9IHN5cy52ZXJzaW9uX2luZm9bMF0gPT0gMwpQWTM0ID0gc3lzLnZlcnNpb25faW5mb1swOjJdID49ICgzLCA0KQoKaWYgUFkzOgogICAgc3RyaW5nX3R5cGVzID0gc3RyLAogICAgaW50ZWdlcl90eXBlcyA9IGludCwKICAgIGNsYXNzX3R5cGVzID0gdHlwZSwKICAgIHRleHRfdHlwZSA9IHN0cgogICAgYmluYXJ5X3R5cGUgPSBieXRlcwogICAgTUFYU0laRSA9IHN5cy5tYXhzaXplCmVsc2U6CiAgICBzdHJpbmdfdHlwZXMgPSBiYXNlc3RyaW5nLAogICAgaW50ZWdlcl90eXBlcyA9IChpbnQsIGxvbmcpCiAgICBjbGFzc190eXBlcyA9ICh0eXBlLCB0eXBlcy5DbGFzc1R5cGUpCiAgICB0ZXh0X3R5cGUgPSB1bmljb2RlCiAgICBiaW5hcnlfdHlwZSA9IHN0cgoKICAgIGlmIHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCJqYXZhIik6CiAgICAgICAgIyBKeXRob24gYWx3YXlzIHVzZXMgMzIgYml0cy4KICAgICAgICBNQVhTSVpFID0gaW50KCgxIDw8IDMxKSAtIDEpCiAgICBlbHNlOgogICAgICAgICMgSXQncyBwb3NzaWJsZSB0byBoYXZlIHNpemVvZihsb25nKSAhPSBzaXplb2YoUHlfc3NpemVfdCkuCiAgICAgICAgY2xhc3MgWChvYmplY3QpOgoKICAgICAgICAgICAgZGVmIF9fbGVuX18oc2VsZik6CiAgICAgICAgICAgICAgICByZXR1cm4gMSA8PCAzMQogICAgICAgIHRyeToKICAgICAgICAgICAgbGVuKFgoKSkKICAgICAgICBleGNlcHQgT3ZlcmZsb3dFcnJvcjoKICAgICAgICAgICAgIyAzMi1iaXQKICAgICAgICAgICAgTUFYU0laRSA9IGludCgoMSA8PCAzMSkgLSAxKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgNjQtYml0CiAgICAgICAgICAgIE1BWFNJWkUgPSBpbnQoKDEgPDwgNjMpIC0gMSkKICAgICAgICBkZWwgWAoKCmRlZiBfYWRkX2RvYyhmdW5jLCBkb2MpOgogICAgIiIiQWRkIGRvY3VtZW50YXRpb24gdG8gYSBmdW5jdGlvbi4iIiIKICAgIGZ1bmMuX19kb2NfXyA9IGRvYwoKCmRlZiBfaW1wb3J0X21vZHVsZShuYW1lKToKICAgICIiIkltcG9ydCBtb2R1bGUsIHJldHVybmluZyB0aGUgbW9kdWxlIGFmdGVyIHRoZSBsYXN0IGRvdC4iIiIKICAgIF9faW1wb3J0X18obmFtZSkKICAgIHJldHVybiBzeXMubW9kdWxlc1tuYW1lXQoKCmNsYXNzIF9MYXp5RGVzY3Iob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSk6CiAgICAgICAgc2VsZi5uYW1lID0gbmFtZQoKICAgIGRlZiBfX2dldF9fKHNlbGYsIG9iaiwgdHApOgogICAgICAgIHJlc3VsdCA9IHNlbGYuX3Jlc29sdmUoKQogICAgICAgIHNldGF0dHIob2JqLCBzZWxmLm5hbWUsIHJlc3VsdCkgICMgSW52b2tlcyBfX3NldF9fLgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBUaGlzIGlzIGEgYml0IHVnbHksIGJ1dCBpdCBhdm9pZHMgcnVubmluZyB0aGlzIGFnYWluIGJ5CiAgICAgICAgICAgICMgcmVtb3ZpbmcgdGhpcyBkZXNjcmlwdG9yLgogICAgICAgICAgICBkZWxhdHRyKG9iai5fX2NsYXNzX18sIHNlbGYubmFtZSkKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gcmVzdWx0CgoKY2xhc3MgTW92ZWRNb2R1bGUoX0xhenlEZXNjcik6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUsIG9sZCwgbmV3PU5vbmUpOgogICAgICAgIHN1cGVyKE1vdmVkTW9kdWxlLCBzZWxmKS5fX2luaXRfXyhuYW1lKQogICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgaWYgbmV3IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBuZXcgPSBuYW1lCiAgICAgICAgICAgIHNlbGYubW9kID0gbmV3CiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5tb2QgPSBvbGQKCiAgICBkZWYgX3Jlc29sdmUoc2VsZik6CiAgICAgICAgcmV0dXJuIF9pbXBvcnRfbW9kdWxlKHNlbGYubW9kKQoKICAgIGRlZiBfX2dldGF0dHJfXyhzZWxmLCBhdHRyKToKICAgICAgICBfbW9kdWxlID0gc2VsZi5fcmVzb2x2ZSgpCiAgICAgICAgdmFsdWUgPSBnZXRhdHRyKF9tb2R1bGUsIGF0dHIpCiAgICAgICAgc2V0YXR0cihzZWxmLCBhdHRyLCB2YWx1ZSkKICAgICAgICByZXR1cm4gdmFsdWUKCgpjbGFzcyBfTGF6eU1vZHVsZSh0eXBlcy5Nb2R1bGVUeXBlKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSk6CiAgICAgICAgc3VwZXIoX0xhenlNb2R1bGUsIHNlbGYpLl9faW5pdF9fKG5hbWUpCiAgICAgICAgc2VsZi5fX2RvY19fID0gc2VsZi5fX2NsYXNzX18uX19kb2NfXwoKICAgIGRlZiBfX2Rpcl9fKHNlbGYpOgogICAgICAgIGF0dHJzID0gWyJfX2RvY19fIiwgIl9fbmFtZV9fIl0KICAgICAgICBhdHRycyArPSBbYXR0ci5uYW1lIGZvciBhdHRyIGluIHNlbGYuX21vdmVkX2F0dHJpYnV0ZXNdCiAgICAgICAgcmV0dXJuIGF0dHJzCgogICAgIyBTdWJjbGFzc2VzIHNob3VsZCBvdmVycmlkZSB0aGlzCiAgICBfbW92ZWRfYXR0cmlidXRlcyA9IFtdCgoKY2xhc3MgTW92ZWRBdHRyaWJ1dGUoX0xhenlEZXNjcik6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUsIG9sZF9tb2QsIG5ld19tb2QsIG9sZF9hdHRyPU5vbmUsIG5ld19hdHRyPU5vbmUpOgogICAgICAgIHN1cGVyKE1vdmVkQXR0cmlidXRlLCBzZWxmKS5fX2luaXRfXyhuYW1lKQogICAgICAgIGlmIFBZMzoKICAgICAgICAgICAgaWYgbmV3X21vZCBpcyBOb25lOgogICAgICAgICAgICAgICAgbmV3X21vZCA9IG5hbWUKICAgICAgICAgICAgc2VsZi5tb2QgPSBuZXdfbW9kCiAgICAgICAgICAgIGlmIG5ld19hdHRyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBpZiBvbGRfYXR0ciBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIG5ld19hdHRyID0gbmFtZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBuZXdfYXR0ciA9IG9sZF9hdHRyCiAgICAgICAgICAgIHNlbGYuYXR0ciA9IG5ld19hdHRyCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5tb2QgPSBvbGRfbW9kCiAgICAgICAgICAgIGlmIG9sZF9hdHRyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBvbGRfYXR0ciA9IG5hbWUKICAgICAgICAgICAgc2VsZi5hdHRyID0gb2xkX2F0dHIKCiAgICBkZWYgX3Jlc29sdmUoc2VsZik6CiAgICAgICAgbW9kdWxlID0gX2ltcG9ydF9tb2R1bGUoc2VsZi5tb2QpCiAgICAgICAgcmV0dXJuIGdldGF0dHIobW9kdWxlLCBzZWxmLmF0dHIpCgoKY2xhc3MgX1NpeE1ldGFQYXRoSW1wb3J0ZXIob2JqZWN0KToKCiAgICAiIiIKICAgIEEgbWV0YSBwYXRoIGltcG9ydGVyIHRvIGltcG9ydCBzaXgubW92ZXMgYW5kIGl0cyBzdWJtb2R1bGVzLgoKICAgIFRoaXMgY2xhc3MgaW1wbGVtZW50cyBhIFBFUDMwMiBmaW5kZXIgYW5kIGxvYWRlci4gSXQgc2hvdWxkIGJlIGNvbXBhdGlibGUKICAgIHdpdGggUHl0aG9uIDIuNSBhbmQgYWxsIGV4aXN0aW5nIHZlcnNpb25zIG9mIFB5dGhvbjMKICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzaXhfbW9kdWxlX25hbWUpOgogICAgICAgIHNlbGYubmFtZSA9IHNpeF9tb2R1bGVfbmFtZQogICAgICAgIHNlbGYua25vd25fbW9kdWxlcyA9IHt9CgogICAgZGVmIF9hZGRfbW9kdWxlKHNlbGYsIG1vZCwgKmZ1bGxuYW1lcyk6CiAgICAgICAgZm9yIGZ1bGxuYW1lIGluIGZ1bGxuYW1lczoKICAgICAgICAgICAgc2VsZi5rbm93bl9tb2R1bGVzW3NlbGYubmFtZSArICIuIiArIGZ1bGxuYW1lXSA9IG1vZAoKICAgIGRlZiBfZ2V0X21vZHVsZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgcmV0dXJuIHNlbGYua25vd25fbW9kdWxlc1tzZWxmLm5hbWUgKyAiLiIgKyBmdWxsbmFtZV0KCiAgICBkZWYgZmluZF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUsIHBhdGg9Tm9uZSk6CiAgICAgICAgaWYgZnVsbG5hbWUgaW4gc2VsZi5rbm93bl9tb2R1bGVzOgogICAgICAgICAgICByZXR1cm4gc2VsZgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9fZ2V0X21vZHVsZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gc2VsZi5rbm93bl9tb2R1bGVzW2Z1bGxuYW1lXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoIlRoaXMgbG9hZGVyIGRvZXMgbm90IGtub3cgbW9kdWxlICIgKyBmdWxsbmFtZSkKCiAgICBkZWYgbG9hZF9tb2R1bGUoc2VsZiwgZnVsbG5hbWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBpbiBjYXNlIG9mIGEgcmVsb2FkCiAgICAgICAgICAgIHJldHVybiBzeXMubW9kdWxlc1tmdWxsbmFtZV0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBtb2QgPSBzZWxmLl9fZ2V0X21vZHVsZShmdWxsbmFtZSkKICAgICAgICBpZiBpc2luc3RhbmNlKG1vZCwgTW92ZWRNb2R1bGUpOgogICAgICAgICAgICBtb2QgPSBtb2QuX3Jlc29sdmUoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1vZC5fX2xvYWRlcl9fID0gc2VsZgogICAgICAgIHN5cy5tb2R1bGVzW2Z1bGxuYW1lXSA9IG1vZAogICAgICAgIHJldHVybiBtb2QKCiAgICBkZWYgaXNfcGFja2FnZShzZWxmLCBmdWxsbmFtZSk6CiAgICAgICAgIiIiCiAgICAgICAgUmV0dXJuIHRydWUsIGlmIHRoZSBuYW1lZCBtb2R1bGUgaXMgYSBwYWNrYWdlLgoKICAgICAgICBXZSBuZWVkIHRoaXMgbWV0aG9kIHRvIGdldCBjb3JyZWN0IHNwZWMgb2JqZWN0cyB3aXRoCiAgICAgICAgUHl0aG9uIDMuNCAoc2VlIFBFUDQ1MSkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gaGFzYXR0cihzZWxmLl9fZ2V0X21vZHVsZShmdWxsbmFtZSksICJfX3BhdGhfXyIpCgogICAgZGVmIGdldF9jb2RlKHNlbGYsIGZ1bGxuYW1lKToKICAgICAgICAiIiJSZXR1cm4gTm9uZQoKICAgICAgICBSZXF1aXJlZCwgaWYgaXNfcGFja2FnZSBpcyBpbXBsZW1lbnRlZCIiIgogICAgICAgIHNlbGYuX19nZXRfbW9kdWxlKGZ1bGxuYW1lKSAgIyBldmVudHVhbGx5IHJhaXNlcyBJbXBvcnRFcnJvcgogICAgICAgIHJldHVybiBOb25lCiAgICBnZXRfc291cmNlID0gZ2V0X2NvZGUgICMgc2FtZSBhcyBnZXRfY29kZQoKX2ltcG9ydGVyID0gX1NpeE1ldGFQYXRoSW1wb3J0ZXIoX19uYW1lX18pCgoKY2xhc3MgX01vdmVkSXRlbXMoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIiIiCiAgICBfX3BhdGhfXyA9IFtdICAjIG1hcmsgYXMgcGFja2FnZQoKCl9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoImNTdHJpbmdJTyIsICJjU3RyaW5nSU8iLCAiaW8iLCAiU3RyaW5nSU8iKSwKICAgIE1vdmVkQXR0cmlidXRlKCJmaWx0ZXIiLCAiaXRlcnRvb2xzIiwgImJ1aWx0aW5zIiwgImlmaWx0ZXIiLCAiZmlsdGVyIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiZmlsdGVyZmFsc2UiLCAiaXRlcnRvb2xzIiwgIml0ZXJ0b29scyIsICJpZmlsdGVyZmFsc2UiLCAiZmlsdGVyZmFsc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnB1dCIsICJfX2J1aWx0aW5fXyIsICJidWlsdGlucyIsICJyYXdfaW5wdXQiLCAiaW5wdXQiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnRlcm4iLCAiX19idWlsdGluX18iLCAic3lzIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgibWFwIiwgIml0ZXJ0b29scyIsICJidWlsdGlucyIsICJpbWFwIiwgIm1hcCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldGN3ZCIsICJvcyIsICJvcyIsICJnZXRjd2R1IiwgImdldGN3ZCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldGN3ZGIiLCAib3MiLCAib3MiLCAiZ2V0Y3dkIiwgImdldGN3ZGIiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJyYW5nZSIsICJfX2J1aWx0aW5fXyIsICJidWlsdGlucyIsICJ4cmFuZ2UiLCAicmFuZ2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJyZWxvYWRfbW9kdWxlIiwgIl9fYnVpbHRpbl9fIiwgImltcG9ydGxpYiIgaWYgUFkzNCBlbHNlICJpbXAiLCAicmVsb2FkIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicmVkdWNlIiwgIl9fYnVpbHRpbl9fIiwgImZ1bmN0b29scyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInNobGV4X3F1b3RlIiwgInBpcGVzIiwgInNobGV4IiwgInF1b3RlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiU3RyaW5nSU8iLCAiU3RyaW5nSU8iLCAiaW8iKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVc2VyRGljdCIsICJVc2VyRGljdCIsICJjb2xsZWN0aW9ucyIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVzZXJMaXN0IiwgIlVzZXJMaXN0IiwgImNvbGxlY3Rpb25zIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiVXNlclN0cmluZyIsICJVc2VyU3RyaW5nIiwgImNvbGxlY3Rpb25zIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgieHJhbmdlIiwgIl9fYnVpbHRpbl9fIiwgImJ1aWx0aW5zIiwgInhyYW5nZSIsICJyYW5nZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInppcCIsICJpdGVydG9vbHMiLCAiYnVpbHRpbnMiLCAiaXppcCIsICJ6aXAiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ6aXBfbG9uZ2VzdCIsICJpdGVydG9vbHMiLCAiaXRlcnRvb2xzIiwgIml6aXBfbG9uZ2VzdCIsICJ6aXBfbG9uZ2VzdCIpLAogICAgTW92ZWRNb2R1bGUoImJ1aWx0aW5zIiwgIl9fYnVpbHRpbl9fIiksCiAgICBNb3ZlZE1vZHVsZSgiY29uZmlncGFyc2VyIiwgIkNvbmZpZ1BhcnNlciIpLAogICAgTW92ZWRNb2R1bGUoImNvcHlyZWciLCAiY29weV9yZWciKSwKICAgIE1vdmVkTW9kdWxlKCJkYm1fZ251IiwgImdkYm0iLCAiZGJtLmdudSIpLAogICAgTW92ZWRNb2R1bGUoIl9kdW1teV90aHJlYWQiLCAiZHVtbXlfdGhyZWFkIiwgIl9kdW1teV90aHJlYWQiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2Nvb2tpZWphciIsICJjb29raWVsaWIiLCAiaHR0cC5jb29raWVqYXIiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2Nvb2tpZXMiLCAiQ29va2llIiwgImh0dHAuY29va2llcyIpLAogICAgTW92ZWRNb2R1bGUoImh0bWxfZW50aXRpZXMiLCAiaHRtbGVudGl0eWRlZnMiLCAiaHRtbC5lbnRpdGllcyIpLAogICAgTW92ZWRNb2R1bGUoImh0bWxfcGFyc2VyIiwgIkhUTUxQYXJzZXIiLCAiaHRtbC5wYXJzZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJodHRwX2NsaWVudCIsICJodHRwbGliIiwgImh0dHAuY2xpZW50IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV9tdWx0aXBhcnQiLCAiZW1haWwuTUlNRU11bHRpcGFydCIsICJlbWFpbC5taW1lLm11bHRpcGFydCIpLAogICAgTW92ZWRNb2R1bGUoImVtYWlsX21pbWVfbm9ubXVsdGlwYXJ0IiwgImVtYWlsLk1JTUVOb25NdWx0aXBhcnQiLCAiZW1haWwubWltZS5ub25tdWx0aXBhcnQiKSwKICAgIE1vdmVkTW9kdWxlKCJlbWFpbF9taW1lX3RleHQiLCAiZW1haWwuTUlNRVRleHQiLCAiZW1haWwubWltZS50ZXh0IiksCiAgICBNb3ZlZE1vZHVsZSgiZW1haWxfbWltZV9iYXNlIiwgImVtYWlsLk1JTUVCYXNlIiwgImVtYWlsLm1pbWUuYmFzZSIpLAogICAgTW92ZWRNb2R1bGUoIkJhc2VIVFRQU2VydmVyIiwgIkJhc2VIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiQ0dJSFRUUFNlcnZlciIsICJDR0lIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiU2ltcGxlSFRUUFNlcnZlciIsICJTaW1wbGVIVFRQU2VydmVyIiwgImh0dHAuc2VydmVyIiksCiAgICBNb3ZlZE1vZHVsZSgiY1BpY2tsZSIsICJjUGlja2xlIiwgInBpY2tsZSIpLAogICAgTW92ZWRNb2R1bGUoInF1ZXVlIiwgIlF1ZXVlIiksCiAgICBNb3ZlZE1vZHVsZSgicmVwcmxpYiIsICJyZXByIiksCiAgICBNb3ZlZE1vZHVsZSgic29ja2V0c2VydmVyIiwgIlNvY2tldFNlcnZlciIpLAogICAgTW92ZWRNb2R1bGUoIl90aHJlYWQiLCAidGhyZWFkIiwgIl90aHJlYWQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyIiwgIlRraW50ZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2RpYWxvZyIsICJEaWFsb2ciLCAidGtpbnRlci5kaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2ZpbGVkaWFsb2ciLCAiRmlsZURpYWxvZyIsICJ0a2ludGVyLmZpbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3Njcm9sbGVkdGV4dCIsICJTY3JvbGxlZFRleHQiLCAidGtpbnRlci5zY3JvbGxlZHRleHQiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3NpbXBsZWRpYWxvZyIsICJTaW1wbGVEaWFsb2ciLCAidGtpbnRlci5zaW1wbGVkaWFsb2ciKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3RpeCIsICJUaXgiLCAidGtpbnRlci50aXgiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3R0ayIsICJ0dGsiLCAidGtpbnRlci50dGsiKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX2NvbnN0YW50cyIsICJUa2NvbnN0YW50cyIsICJ0a2ludGVyLmNvbnN0YW50cyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZG5kIiwgIlRrZG5kIiwgInRraW50ZXIuZG5kIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9jb2xvcmNob29zZXIiLCAidGtDb2xvckNob29zZXIiLAogICAgICAgICAgICAgICAgInRraW50ZXIuY29sb3JjaG9vc2VyIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9jb21tb25kaWFsb2ciLCAidGtDb21tb25EaWFsb2ciLAogICAgICAgICAgICAgICAgInRraW50ZXIuY29tbW9uZGlhbG9nIiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl90a2ZpbGVkaWFsb2ciLCAidGtGaWxlRGlhbG9nIiwgInRraW50ZXIuZmlsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInRraW50ZXJfZm9udCIsICJ0a0ZvbnQiLCAidGtpbnRlci5mb250IiksCiAgICBNb3ZlZE1vZHVsZSgidGtpbnRlcl9tZXNzYWdlYm94IiwgInRrTWVzc2FnZUJveCIsICJ0a2ludGVyLm1lc3NhZ2Vib3giKSwKICAgIE1vdmVkTW9kdWxlKCJ0a2ludGVyX3Rrc2ltcGxlZGlhbG9nIiwgInRrU2ltcGxlRGlhbG9nIiwKICAgICAgICAgICAgICAgICJ0a2ludGVyLnNpbXBsZWRpYWxvZyIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYl9wYXJzZSIsIF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWJfcGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZE1vZHVsZSgidXJsbGliX2Vycm9yIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYl9lcnJvciIsICJ1cmxsaWIuZXJyb3IiKSwKICAgIE1vdmVkTW9kdWxlKCJ1cmxsaWIiLCBfX25hbWVfXyArICIubW92ZXMudXJsbGliIiwgX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYiIpLAogICAgTW92ZWRNb2R1bGUoInVybGxpYl9yb2JvdHBhcnNlciIsICJyb2JvdHBhcnNlciIsICJ1cmxsaWIucm9ib3RwYXJzZXIiKSwKICAgIE1vdmVkTW9kdWxlKCJ4bWxycGNfY2xpZW50IiwgInhtbHJwY2xpYiIsICJ4bWxycGMuY2xpZW50IiksCiAgICBNb3ZlZE1vZHVsZSgieG1scnBjX3NlcnZlciIsICJTaW1wbGVYTUxSUENTZXJ2ZXIiLCAieG1scnBjLnNlcnZlciIpLApdCiMgQWRkIHdpbmRvd3Mgc3BlY2lmaWMgbW9kdWxlcy4KaWYgc3lzLnBsYXRmb3JtID09ICJ3aW4zMiI6CiAgICBfbW92ZWRfYXR0cmlidXRlcyArPSBbCiAgICAgICAgTW92ZWRNb2R1bGUoIndpbnJlZyIsICJfd2lucmVnIiksCiAgICBdCgpmb3IgYXR0ciBpbiBfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoX01vdmVkSXRlbXMsIGF0dHIubmFtZSwgYXR0cikKICAgIGlmIGlzaW5zdGFuY2UoYXR0ciwgTW92ZWRNb2R1bGUpOgogICAgICAgIF9pbXBvcnRlci5fYWRkX21vZHVsZShhdHRyLCAibW92ZXMuIiArIGF0dHIubmFtZSkKZGVsIGF0dHIKCl9Nb3ZlZEl0ZW1zLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX21vdmVkX2F0dHJpYnV0ZXMKCm1vdmVzID0gX01vdmVkSXRlbXMoX19uYW1lX18gKyAiLm1vdmVzIikKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKG1vdmVzLCAibW92ZXMiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3BhcnNlIiIiCgoKX3VybGxpYl9wYXJzZV9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoIlBhcnNlUmVzdWx0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlNwbGl0UmVzdWx0IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInBhcnNlX3FzIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInBhcnNlX3FzbCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxkZWZyYWciLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsam9pbiIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxwYXJzZSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxzcGxpdCIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmx1bnBhcnNlIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVybHVuc3BsaXQiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgicXVvdGUiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInF1b3RlX3BsdXMiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVucXVvdGUiLCAidXJsbGliIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVucXVvdGVfcGx1cyIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsZW5jb2RlIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzcGxpdHF1ZXJ5IiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJzcGxpdHRhZyIsICJ1cmxsaWIiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgic3BsaXR1c2VyIiwgInVybGxpYiIsICJ1cmxsaWIucGFyc2UiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1c2VzX2ZyYWdtZW50IiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfbmV0bG9jIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfcGFyYW1zIiwgInVybHBhcnNlIiwgInVybGxpYi5wYXJzZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoInVzZXNfcXVlcnkiLCAidXJscGFyc2UiLCAidXJsbGliLnBhcnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXNlc19yZWxhdGl2ZSIsICJ1cmxwYXJzZSIsICJ1cmxsaWIucGFyc2UiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX3BhcnNlX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9wYXJzZS5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfcGFyc2VfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3BhcnNlKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWJfcGFyc2UiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfcGFyc2UiLCAibW92ZXMudXJsbGliLnBhcnNlIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvcihfTGF6eU1vZHVsZSk6CgogICAgIiIiTGF6eSBsb2FkaW5nIG9mIG1vdmVkIG9iamVjdHMgaW4gc2l4Lm1vdmVzLnVybGxpYl9lcnJvciIiIgoKCl91cmxsaWJfZXJyb3JfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJVUkxFcnJvciIsICJ1cmxsaWIyIiwgInVybGxpYi5lcnJvciIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBFcnJvciIsICJ1cmxsaWIyIiwgInVybGxpYi5lcnJvciIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkNvbnRlbnRUb29TaG9ydEVycm9yIiwgInVybGxpYiIsICJ1cmxsaWIuZXJyb3IiKSwKXQpmb3IgYXR0ciBpbiBfdXJsbGliX2Vycm9yX21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yLCBhdHRyLm5hbWUsIGF0dHIpCmRlbCBhdHRyCgpNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9lcnJvci5fbW92ZWRfYXR0cmlidXRlcyA9IF91cmxsaWJfZXJyb3JfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX2Vycm9yKF9fbmFtZV9fICsgIi5tb3Zlcy51cmxsaWIuZXJyb3IiKSwKICAgICAgICAgICAgICAgICAgICAgICJtb3Zlcy51cmxsaWJfZXJyb3IiLCAibW92ZXMudXJsbGliLmVycm9yIikKCgpjbGFzcyBNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXF1ZXN0KF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3JlcXVlc3QiIiIKCgpfdXJsbGliX3JlcXVlc3RfbW92ZWRfYXR0cmlidXRlcyA9IFsKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxvcGVuIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJpbnN0YWxsX29wZW5lciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYnVpbGRfb3BlbmVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwYXRobmFtZTJ1cmwiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgidXJsMnBhdGhuYW1lIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImdldHByb3hpZXMiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUmVxdWVzdCIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiT3BlbmVyRGlyZWN0b3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBEZWZhdWx0RXJyb3JIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQUmVkaXJlY3RIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQQ29va2llUHJvY2Vzc29yIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJQcm94eUhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkJhc2VIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQUGFzc3dvcmRNZ3IiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkhUVFBQYXNzd29yZE1ncldpdGhEZWZhdWx0UmVhbG0iLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIkFic3RyYWN0QmFzaWNBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEJhc2ljQXV0aEhhbmRsZXIiLCAidXJsbGliMiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlByb3h5QmFzaWNBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQWJzdHJhY3REaWdlc3RBdXRoSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUERpZ2VzdEF1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJQcm94eURpZ2VzdEF1dGhIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJIVFRQSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUFNIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJGaWxlSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiRlRQSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiQ2FjaGVGVFBIYW5kbGVyIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJVbmtub3duSGFuZGxlciIsICJ1cmxsaWIyIiwgInVybGxpYi5yZXF1ZXN0IiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiSFRUUEVycm9yUHJvY2Vzc29yIiwgInVybGxpYjIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxyZXRyaWV2ZSIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJ1cmxjbGVhbnVwIiwgInVybGxpYiIsICJ1cmxsaWIucmVxdWVzdCIpLAogICAgTW92ZWRBdHRyaWJ1dGUoIlVSTG9wZW5lciIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJGYW5jeVVSTG9wZW5lciIsICJ1cmxsaWIiLCAidXJsbGliLnJlcXVlc3QiKSwKICAgIE1vdmVkQXR0cmlidXRlKCJwcm94eV9ieXBhc3MiLCAidXJsbGliIiwgInVybGxpYi5yZXF1ZXN0IiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9yZXF1ZXN0X21vdmVkX2F0dHJpYnV0ZXM6CiAgICBzZXRhdHRyKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3JlcXVlc3RfbW92ZWRfYXR0cmlidXRlcwoKX2ltcG9ydGVyLl9hZGRfbW9kdWxlKE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JlcXVlc3QoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5yZXF1ZXN0IiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3JlcXVlc3QiLCAibW92ZXMudXJsbGliLnJlcXVlc3QiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3Jlc3BvbnNlKF9MYXp5TW9kdWxlKToKCiAgICAiIiJMYXp5IGxvYWRpbmcgb2YgbW92ZWQgb2JqZWN0cyBpbiBzaXgubW92ZXMudXJsbGliX3Jlc3BvbnNlIiIiCgoKX3VybGxpYl9yZXNwb25zZV9tb3ZlZF9hdHRyaWJ1dGVzID0gWwogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGJhc2UiLCAidXJsbGliIiwgInVybGxpYi5yZXNwb25zZSIpLAogICAgTW92ZWRBdHRyaWJ1dGUoImFkZGNsb3NlaG9vayIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkaW5mbyIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCiAgICBNb3ZlZEF0dHJpYnV0ZSgiYWRkaW5mb3VybCIsICJ1cmxsaWIiLCAidXJsbGliLnJlc3BvbnNlIiksCl0KZm9yIGF0dHIgaW4gX3VybGxpYl9yZXNwb25zZV9tb3ZlZF9hdHRyaWJ1dGVzOgogICAgc2V0YXR0cihNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZSwgYXR0ci5uYW1lLCBhdHRyKQpkZWwgYXR0cgoKTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcmVzcG9uc2UuX21vdmVkX2F0dHJpYnV0ZXMgPSBfdXJsbGliX3Jlc3BvbnNlX21vdmVkX2F0dHJpYnV0ZXMKCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYl9yZXNwb25zZShfX25hbWVfXyArICIubW92ZXMudXJsbGliLnJlc3BvbnNlIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliX3Jlc3BvbnNlIiwgIm1vdmVzLnVybGxpYi5yZXNwb25zZSIpCgoKY2xhc3MgTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIoX0xhenlNb2R1bGUpOgoKICAgICIiIkxhenkgbG9hZGluZyBvZiBtb3ZlZCBvYmplY3RzIGluIHNpeC5tb3Zlcy51cmxsaWJfcm9ib3RwYXJzZXIiIiIKCgpfdXJsbGliX3JvYm90cGFyc2VyX21vdmVkX2F0dHJpYnV0ZXMgPSBbCiAgICBNb3ZlZEF0dHJpYnV0ZSgiUm9ib3RGaWxlUGFyc2VyIiwgInJvYm90cGFyc2VyIiwgInVybGxpYi5yb2JvdHBhcnNlciIpLApdCmZvciBhdHRyIGluIF91cmxsaWJfcm9ib3RwYXJzZXJfbW92ZWRfYXR0cmlidXRlczoKICAgIHNldGF0dHIoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIsIGF0dHIubmFtZSwgYXR0cikKZGVsIGF0dHIKCk1vZHVsZV9zaXhfbW92ZXNfdXJsbGliX3JvYm90cGFyc2VyLl9tb3ZlZF9hdHRyaWJ1dGVzID0gX3VybGxpYl9yb2JvdHBhcnNlcl9tb3ZlZF9hdHRyaWJ1dGVzCgpfaW1wb3J0ZXIuX2FkZF9tb2R1bGUoTW9kdWxlX3NpeF9tb3Zlc191cmxsaWJfcm9ib3RwYXJzZXIoX19uYW1lX18gKyAiLm1vdmVzLnVybGxpYi5yb2JvdHBhcnNlciIpLAogICAgICAgICAgICAgICAgICAgICAgIm1vdmVzLnVybGxpYl9yb2JvdHBhcnNlciIsICJtb3Zlcy51cmxsaWIucm9ib3RwYXJzZXIiKQoKCmNsYXNzIE1vZHVsZV9zaXhfbW92ZXNfdXJsbGliKHR5cGVzLk1vZHVsZVR5cGUpOgoKICAgICIiIkNyZWF0ZSBhIHNpeC5tb3Zlcy51cmxsaWIgbmFtZXNwYWNlIHRoYXQgcmVzZW1ibGVzIHRoZSBQeXRob24gMyBuYW1lc3BhY2UiIiIKICAgIF9fcGF0aF9fID0gW10gICMgbWFyayBhcyBwYWNrYWdlCiAgICBwYXJzZSA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3BhcnNlIikKICAgIGVycm9yID0gX2ltcG9ydGVyLl9nZXRfbW9kdWxlKCJtb3Zlcy51cmxsaWJfZXJyb3IiKQogICAgcmVxdWVzdCA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3JlcXVlc3QiKQogICAgcmVzcG9uc2UgPSBfaW1wb3J0ZXIuX2dldF9tb2R1bGUoIm1vdmVzLnVybGxpYl9yZXNwb25zZSIpCiAgICByb2JvdHBhcnNlciA9IF9pbXBvcnRlci5fZ2V0X21vZHVsZSgibW92ZXMudXJsbGliX3JvYm90cGFyc2VyIikKCiAgICBkZWYgX19kaXJfXyhzZWxmKToKICAgICAgICByZXR1cm4gWydwYXJzZScsICdlcnJvcicsICdyZXF1ZXN0JywgJ3Jlc3BvbnNlJywgJ3JvYm90cGFyc2VyJ10KCl9pbXBvcnRlci5fYWRkX21vZHVsZShNb2R1bGVfc2l4X21vdmVzX3VybGxpYihfX25hbWVfXyArICIubW92ZXMudXJsbGliIiksCiAgICAgICAgICAgICAgICAgICAgICAibW92ZXMudXJsbGliIikKCgpkZWYgYWRkX21vdmUobW92ZSk6CiAgICAiIiJBZGQgYW4gaXRlbSB0byBzaXgubW92ZXMuIiIiCiAgICBzZXRhdHRyKF9Nb3ZlZEl0ZW1zLCBtb3ZlLm5hbWUsIG1vdmUpCgoKZGVmIHJlbW92ZV9tb3ZlKG5hbWUpOgogICAgIiIiUmVtb3ZlIGl0ZW0gZnJvbSBzaXgubW92ZXMuIiIiCiAgICB0cnk6CiAgICAgICAgZGVsYXR0cihfTW92ZWRJdGVtcywgbmFtZSkKICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRlbCBtb3Zlcy5fX2RpY3RfX1tuYW1lXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcmFpc2UgQXR0cmlidXRlRXJyb3IoIm5vIHN1Y2ggbW92ZSwgJXIiICUgKG5hbWUsKSkKCgppZiBQWTM6CiAgICBfbWV0aF9mdW5jID0gIl9fZnVuY19fIgogICAgX21ldGhfc2VsZiA9ICJfX3NlbGZfXyIKCiAgICBfZnVuY19jbG9zdXJlID0gIl9fY2xvc3VyZV9fIgogICAgX2Z1bmNfY29kZSA9ICJfX2NvZGVfXyIKICAgIF9mdW5jX2RlZmF1bHRzID0gIl9fZGVmYXVsdHNfXyIKICAgIF9mdW5jX2dsb2JhbHMgPSAiX19nbG9iYWxzX18iCmVsc2U6CiAgICBfbWV0aF9mdW5jID0gImltX2Z1bmMiCiAgICBfbWV0aF9zZWxmID0gImltX3NlbGYiCgogICAgX2Z1bmNfY2xvc3VyZSA9ICJmdW5jX2Nsb3N1cmUiCiAgICBfZnVuY19jb2RlID0gImZ1bmNfY29kZSIKICAgIF9mdW5jX2RlZmF1bHRzID0gImZ1bmNfZGVmYXVsdHMiCiAgICBfZnVuY19nbG9iYWxzID0gImZ1bmNfZ2xvYmFscyIKCgp0cnk6CiAgICBhZHZhbmNlX2l0ZXJhdG9yID0gbmV4dApleGNlcHQgTmFtZUVycm9yOgogICAgZGVmIGFkdmFuY2VfaXRlcmF0b3IoaXQpOgogICAgICAgIHJldHVybiBpdC5uZXh0KCkKbmV4dCA9IGFkdmFuY2VfaXRlcmF0b3IKCgp0cnk6CiAgICBjYWxsYWJsZSA9IGNhbGxhYmxlCmV4Y2VwdCBOYW1lRXJyb3I6CiAgICBkZWYgY2FsbGFibGUob2JqKToKICAgICAgICByZXR1cm4gYW55KCJfX2NhbGxfXyIgaW4ga2xhc3MuX19kaWN0X18gZm9yIGtsYXNzIGluIHR5cGUob2JqKS5fX21yb19fKQoKCmlmIFBZMzoKICAgIGRlZiBnZXRfdW5ib3VuZF9mdW5jdGlvbih1bmJvdW5kKToKICAgICAgICByZXR1cm4gdW5ib3VuZAoKICAgIGNyZWF0ZV9ib3VuZF9tZXRob2QgPSB0eXBlcy5NZXRob2RUeXBlCgogICAgZGVmIGNyZWF0ZV91bmJvdW5kX21ldGhvZChmdW5jLCBjbHMpOgogICAgICAgIHJldHVybiBmdW5jCgogICAgSXRlcmF0b3IgPSBvYmplY3QKZWxzZToKICAgIGRlZiBnZXRfdW5ib3VuZF9mdW5jdGlvbih1bmJvdW5kKToKICAgICAgICByZXR1cm4gdW5ib3VuZC5pbV9mdW5jCgogICAgZGVmIGNyZWF0ZV9ib3VuZF9tZXRob2QoZnVuYywgb2JqKToKICAgICAgICByZXR1cm4gdHlwZXMuTWV0aG9kVHlwZShmdW5jLCBvYmosIG9iai5fX2NsYXNzX18pCgogICAgZGVmIGNyZWF0ZV91bmJvdW5kX21ldGhvZChmdW5jLCBjbHMpOgogICAgICAgIHJldHVybiB0eXBlcy5NZXRob2RUeXBlKGZ1bmMsIE5vbmUsIGNscykKCiAgICBjbGFzcyBJdGVyYXRvcihvYmplY3QpOgoKICAgICAgICBkZWYgbmV4dChzZWxmKToKICAgICAgICAgICAgcmV0dXJuIHR5cGUoc2VsZikuX19uZXh0X18oc2VsZikKCiAgICBjYWxsYWJsZSA9IGNhbGxhYmxlCl9hZGRfZG9jKGdldF91bmJvdW5kX2Z1bmN0aW9uLAogICAgICAgICAiIiJHZXQgdGhlIGZ1bmN0aW9uIG91dCBvZiBhIHBvc3NpYmx5IHVuYm91bmQgZnVuY3Rpb24iIiIpCgoKZ2V0X21ldGhvZF9mdW5jdGlvbiA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX21ldGhfZnVuYykKZ2V0X21ldGhvZF9zZWxmID0gb3BlcmF0b3IuYXR0cmdldHRlcihfbWV0aF9zZWxmKQpnZXRfZnVuY3Rpb25fY2xvc3VyZSA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfY2xvc3VyZSkKZ2V0X2Z1bmN0aW9uX2NvZGUgPSBvcGVyYXRvci5hdHRyZ2V0dGVyKF9mdW5jX2NvZGUpCmdldF9mdW5jdGlvbl9kZWZhdWx0cyA9IG9wZXJhdG9yLmF0dHJnZXR0ZXIoX2Z1bmNfZGVmYXVsdHMpCmdldF9mdW5jdGlvbl9nbG9iYWxzID0gb3BlcmF0b3IuYXR0cmdldHRlcihfZnVuY19nbG9iYWxzKQoKCmlmIFBZMzoKICAgIGRlZiBpdGVya2V5cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLmtleXMoKiprdykpCgogICAgZGVmIGl0ZXJ2YWx1ZXMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC52YWx1ZXMoKiprdykpCgogICAgZGVmIGl0ZXJpdGVtcyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gaXRlcihkLml0ZW1zKCoqa3cpKQoKICAgIGRlZiBpdGVybGlzdHMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGl0ZXIoZC5saXN0cygqKmt3KSkKCiAgICB2aWV3a2V5cyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigia2V5cyIpCgogICAgdmlld3ZhbHVlcyA9IG9wZXJhdG9yLm1ldGhvZGNhbGxlcigidmFsdWVzIikKCiAgICB2aWV3aXRlbXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoIml0ZW1zIikKZWxzZToKICAgIGRlZiBpdGVya2V5cyhkLCAqKmt3KToKICAgICAgICByZXR1cm4gZC5pdGVya2V5cygqKmt3KQoKICAgIGRlZiBpdGVydmFsdWVzKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJ2YWx1ZXMoKiprdykKCiAgICBkZWYgaXRlcml0ZW1zKGQsICoqa3cpOgogICAgICAgIHJldHVybiBkLml0ZXJpdGVtcygqKmt3KQoKICAgIGRlZiBpdGVybGlzdHMoZCwgKiprdyk6CiAgICAgICAgcmV0dXJuIGQuaXRlcmxpc3RzKCoqa3cpCgogICAgdmlld2tleXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZpZXdrZXlzIikKCiAgICB2aWV3dmFsdWVzID0gb3BlcmF0b3IubWV0aG9kY2FsbGVyKCJ2aWV3dmFsdWVzIikKCiAgICB2aWV3aXRlbXMgPSBvcGVyYXRvci5tZXRob2RjYWxsZXIoInZpZXdpdGVtcyIpCgpfYWRkX2RvYyhpdGVya2V5cywgIlJldHVybiBhbiBpdGVyYXRvciBvdmVyIHRoZSBrZXlzIG9mIGEgZGljdGlvbmFyeS4iKQpfYWRkX2RvYyhpdGVydmFsdWVzLCAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIHZhbHVlcyBvZiBhIGRpY3Rpb25hcnkuIikKX2FkZF9kb2MoaXRlcml0ZW1zLAogICAgICAgICAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIChrZXksIHZhbHVlKSBwYWlycyBvZiBhIGRpY3Rpb25hcnkuIikKX2FkZF9kb2MoaXRlcmxpc3RzLAogICAgICAgICAiUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgdGhlIChrZXksIFt2YWx1ZXNdKSBwYWlycyBvZiBhIGRpY3Rpb25hcnkuIikKCgppZiBQWTM6CiAgICBkZWYgYihzKToKICAgICAgICByZXR1cm4gcy5lbmNvZGUoImxhdGluLTEiKQoKICAgIGRlZiB1KHMpOgogICAgICAgIHJldHVybiBzCiAgICB1bmljaHIgPSBjaHIKICAgIGltcG9ydCBzdHJ1Y3QKICAgIGludDJieXRlID0gc3RydWN0LlN0cnVjdCgiPkIiKS5wYWNrCiAgICBkZWwgc3RydWN0CiAgICBieXRlMmludCA9IG9wZXJhdG9yLml0ZW1nZXR0ZXIoMCkKICAgIGluZGV4Ynl0ZXMgPSBvcGVyYXRvci5nZXRpdGVtCiAgICBpdGVyYnl0ZXMgPSBpdGVyCiAgICBpbXBvcnQgaW8KICAgIFN0cmluZ0lPID0gaW8uU3RyaW5nSU8KICAgIEJ5dGVzSU8gPSBpby5CeXRlc0lPCiAgICBfYXNzZXJ0Q291bnRFcXVhbCA9ICJhc3NlcnRDb3VudEVxdWFsIgogICAgaWYgc3lzLnZlcnNpb25faW5mb1sxXSA8PSAxOgogICAgICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleHAiCiAgICAgICAgX2Fzc2VydFJlZ2V4ID0gImFzc2VydFJlZ2V4cE1hdGNoZXMiCiAgICBlbHNlOgogICAgICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleCIKICAgICAgICBfYXNzZXJ0UmVnZXggPSAiYXNzZXJ0UmVnZXgiCmVsc2U6CiAgICBkZWYgYihzKToKICAgICAgICByZXR1cm4gcwogICAgIyBXb3JrYXJvdW5kIGZvciBzdGFuZGFsb25lIGJhY2tzbGFzaAoKICAgIGRlZiB1KHMpOgogICAgICAgIHJldHVybiB1bmljb2RlKHMucmVwbGFjZShyJ1xcJywgcidcXFxcJyksICJ1bmljb2RlX2VzY2FwZSIpCiAgICB1bmljaHIgPSB1bmljaHIKICAgIGludDJieXRlID0gY2hyCgogICAgZGVmIGJ5dGUyaW50KGJzKToKICAgICAgICByZXR1cm4gb3JkKGJzWzBdKQoKICAgIGRlZiBpbmRleGJ5dGVzKGJ1ZiwgaSk6CiAgICAgICAgcmV0dXJuIG9yZChidWZbaV0pCiAgICBpdGVyYnl0ZXMgPSBmdW5jdG9vbHMucGFydGlhbChpdGVydG9vbHMuaW1hcCwgb3JkKQogICAgaW1wb3J0IFN0cmluZ0lPCiAgICBTdHJpbmdJTyA9IEJ5dGVzSU8gPSBTdHJpbmdJTy5TdHJpbmdJTwogICAgX2Fzc2VydENvdW50RXF1YWwgPSAiYXNzZXJ0SXRlbXNFcXVhbCIKICAgIF9hc3NlcnRSYWlzZXNSZWdleCA9ICJhc3NlcnRSYWlzZXNSZWdleHAiCiAgICBfYXNzZXJ0UmVnZXggPSAiYXNzZXJ0UmVnZXhwTWF0Y2hlcyIKX2FkZF9kb2MoYiwgIiIiQnl0ZSBsaXRlcmFsIiIiKQpfYWRkX2RvYyh1LCAiIiJUZXh0IGxpdGVyYWwiIiIpCgoKZGVmIGFzc2VydENvdW50RXF1YWwoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgIHJldHVybiBnZXRhdHRyKHNlbGYsIF9hc3NlcnRDb3VudEVxdWFsKSgqYXJncywgKiprd2FyZ3MpCgoKZGVmIGFzc2VydFJhaXNlc1JlZ2V4KHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICByZXR1cm4gZ2V0YXR0cihzZWxmLCBfYXNzZXJ0UmFpc2VzUmVnZXgpKCphcmdzLCAqKmt3YXJncykKCgpkZWYgYXNzZXJ0UmVnZXgoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgIHJldHVybiBnZXRhdHRyKHNlbGYsIF9hc3NlcnRSZWdleCkoKmFyZ3MsICoqa3dhcmdzKQoKCmlmIFBZMzoKICAgIGV4ZWNfID0gZ2V0YXR0cihtb3Zlcy5idWlsdGlucywgImV4ZWMiKQoKICAgIGRlZiByZXJhaXNlKHRwLCB2YWx1ZSwgdGI9Tm9uZSk6CiAgICAgICAgaWYgdmFsdWUgaXMgTm9uZToKICAgICAgICAgICAgdmFsdWUgPSB0cCgpCiAgICAgICAgaWYgdmFsdWUuX190cmFjZWJhY2tfXyBpcyBub3QgdGI6CiAgICAgICAgICAgIHJhaXNlIHZhbHVlLndpdGhfdHJhY2ViYWNrKHRiKQogICAgICAgIHJhaXNlIHZhbHVlCgplbHNlOgogICAgZGVmIGV4ZWNfKF9jb2RlXywgX2dsb2JzXz1Ob25lLCBfbG9jc189Tm9uZSk6CiAgICAgICAgIiIiRXhlY3V0ZSBjb2RlIGluIGEgbmFtZXNwYWNlLiIiIgogICAgICAgIGlmIF9nbG9ic18gaXMgTm9uZToKICAgICAgICAgICAgZnJhbWUgPSBzeXMuX2dldGZyYW1lKDEpCiAgICAgICAgICAgIF9nbG9ic18gPSBmcmFtZS5mX2dsb2JhbHMKICAgICAgICAgICAgaWYgX2xvY3NfIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBfbG9jc18gPSBmcmFtZS5mX2xvY2FscwogICAgICAgICAgICBkZWwgZnJhbWUKICAgICAgICBlbGlmIF9sb2NzXyBpcyBOb25lOgogICAgICAgICAgICBfbG9jc18gPSBfZ2xvYnNfCiAgICAgICAgZXhlYygiIiJleGVjIF9jb2RlXyBpbiBfZ2xvYnNfLCBfbG9jc18iIiIpCgogICAgZXhlY18oIiIiZGVmIHJlcmFpc2UodHAsIHZhbHVlLCB0Yj1Ob25lKToKICAgIHJhaXNlIHRwLCB2YWx1ZSwgdGIKIiIiKQoKCmlmIHN5cy52ZXJzaW9uX2luZm9bOjJdID09ICgzLCAyKToKICAgIGV4ZWNfKCIiImRlZiByYWlzZV9mcm9tKHZhbHVlLCBmcm9tX3ZhbHVlKToKICAgIGlmIGZyb21fdmFsdWUgaXMgTm9uZToKICAgICAgICByYWlzZSB2YWx1ZQogICAgcmFpc2UgdmFsdWUgZnJvbSBmcm9tX3ZhbHVlCiIiIikKZWxpZiBzeXMudmVyc2lvbl9pbmZvWzoyXSA+ICgzLCAyKToKICAgIGV4ZWNfKCIiImRlZiByYWlzZV9mcm9tKHZhbHVlLCBmcm9tX3ZhbHVlKToKICAgIHJhaXNlIHZhbHVlIGZyb20gZnJvbV92YWx1ZQoiIiIpCmVsc2U6CiAgICBkZWYgcmFpc2VfZnJvbSh2YWx1ZSwgZnJvbV92YWx1ZSk6CiAgICAgICAgcmFpc2UgdmFsdWUKCgpwcmludF8gPSBnZXRhdHRyKG1vdmVzLmJ1aWx0aW5zLCAicHJpbnQiLCBOb25lKQppZiBwcmludF8gaXMgTm9uZToKICAgIGRlZiBwcmludF8oKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAiIiJUaGUgbmV3LXN0eWxlIHByaW50IGZ1bmN0aW9uIGZvciBQeXRob24gMi40IGFuZCAyLjUuIiIiCiAgICAgICAgZnAgPSBrd2FyZ3MucG9wKCJmaWxlIiwgc3lzLnN0ZG91dCkKICAgICAgICBpZiBmcCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZGVmIHdyaXRlKGRhdGEpOgogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShkYXRhLCBiYXNlc3RyaW5nKToKICAgICAgICAgICAgICAgIGRhdGEgPSBzdHIoZGF0YSkKICAgICAgICAgICAgIyBJZiB0aGUgZmlsZSBoYXMgYW4gZW5jb2RpbmcsIGVuY29kZSB1bmljb2RlIHdpdGggaXQuCiAgICAgICAgICAgIGlmIChpc2luc3RhbmNlKGZwLCBmaWxlKSBhbmQKICAgICAgICAgICAgICAgICAgICBpc2luc3RhbmNlKGRhdGEsIHVuaWNvZGUpIGFuZAogICAgICAgICAgICAgICAgICAgIGZwLmVuY29kaW5nIGlzIG5vdCBOb25lKToKICAgICAgICAgICAgICAgIGVycm9ycyA9IGdldGF0dHIoZnAsICJlcnJvcnMiLCBOb25lKQogICAgICAgICAgICAgICAgaWYgZXJyb3JzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzID0gInN0cmljdCIKICAgICAgICAgICAgICAgIGRhdGEgPSBkYXRhLmVuY29kZShmcC5lbmNvZGluZywgZXJyb3JzKQogICAgICAgICAgICBmcC53cml0ZShkYXRhKQogICAgICAgIHdhbnRfdW5pY29kZSA9IEZhbHNlCiAgICAgICAgc2VwID0ga3dhcmdzLnBvcCgic2VwIiwgTm9uZSkKICAgICAgICBpZiBzZXAgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc2VwLCB1bmljb2RlKToKICAgICAgICAgICAgICAgIHdhbnRfdW5pY29kZSA9IFRydWUKICAgICAgICAgICAgZWxpZiBub3QgaXNpbnN0YW5jZShzZXAsIHN0cik6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoInNlcCBtdXN0IGJlIE5vbmUgb3IgYSBzdHJpbmciKQogICAgICAgIGVuZCA9IGt3YXJncy5wb3AoImVuZCIsIE5vbmUpCiAgICAgICAgaWYgZW5kIGlzIG5vdCBOb25lOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGVuZCwgdW5pY29kZSk6CiAgICAgICAgICAgICAgICB3YW50X3VuaWNvZGUgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2UoZW5kLCBzdHIpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJlbmQgbXVzdCBiZSBOb25lIG9yIGEgc3RyaW5nIikKICAgICAgICBpZiBrd2FyZ3M6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiaW52YWxpZCBrZXl3b3JkIGFyZ3VtZW50cyB0byBwcmludCgpIikKICAgICAgICBpZiBub3Qgd2FudF91bmljb2RlOgogICAgICAgICAgICBmb3IgYXJnIGluIGFyZ3M6CiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGFyZywgdW5pY29kZSk6CiAgICAgICAgICAgICAgICAgICAgd2FudF91bmljb2RlID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgaWYgd2FudF91bmljb2RlOgogICAgICAgICAgICBuZXdsaW5lID0gdW5pY29kZSgiXG4iKQogICAgICAgICAgICBzcGFjZSA9IHVuaWNvZGUoIiAiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG5ld2xpbmUgPSAiXG4iCiAgICAgICAgICAgIHNwYWNlID0gIiAiCiAgICAgICAgaWYgc2VwIGlzIE5vbmU6CiAgICAgICAgICAgIHNlcCA9IHNwYWNlCiAgICAgICAgaWYgZW5kIGlzIE5vbmU6CiAgICAgICAgICAgIGVuZCA9IG5ld2xpbmUKICAgICAgICBmb3IgaSwgYXJnIGluIGVudW1lcmF0ZShhcmdzKToKICAgICAgICAgICAgaWYgaToKICAgICAgICAgICAgICAgIHdyaXRlKHNlcCkKICAgICAgICAgICAgd3JpdGUoYXJnKQogICAgICAgIHdyaXRlKGVuZCkKaWYgc3lzLnZlcnNpb25faW5mb1s6Ml0gPCAoMywgMyk6CiAgICBfcHJpbnQgPSBwcmludF8KCiAgICBkZWYgcHJpbnRfKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgZnAgPSBrd2FyZ3MuZ2V0KCJmaWxlIiwgc3lzLnN0ZG91dCkKICAgICAgICBmbHVzaCA9IGt3YXJncy5wb3AoImZsdXNoIiwgRmFsc2UpCiAgICAgICAgX3ByaW50KCphcmdzLCAqKmt3YXJncykKICAgICAgICBpZiBmbHVzaCBhbmQgZnAgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGZwLmZsdXNoKCkKCl9hZGRfZG9jKHJlcmFpc2UsICIiIlJlcmFpc2UgYW4gZXhjZXB0aW9uLiIiIikKCmlmIHN5cy52ZXJzaW9uX2luZm9bMDoyXSA8ICgzLCA0KToKICAgIGRlZiB3cmFwcyh3cmFwcGVkLCBhc3NpZ25lZD1mdW5jdG9vbHMuV1JBUFBFUl9BU1NJR05NRU5UUywKICAgICAgICAgICAgICB1cGRhdGVkPWZ1bmN0b29scy5XUkFQUEVSX1VQREFURVMpOgogICAgICAgIGRlZiB3cmFwcGVyKGYpOgogICAgICAgICAgICBmID0gZnVuY3Rvb2xzLndyYXBzKHdyYXBwZWQsIGFzc2lnbmVkLCB1cGRhdGVkKShmKQogICAgICAgICAgICBmLl9fd3JhcHBlZF9fID0gd3JhcHBlZAogICAgICAgICAgICByZXR1cm4gZgogICAgICAgIHJldHVybiB3cmFwcGVyCmVsc2U6CiAgICB3cmFwcyA9IGZ1bmN0b29scy53cmFwcwoKCmRlZiB3aXRoX21ldGFjbGFzcyhtZXRhLCAqYmFzZXMpOgogICAgIiIiQ3JlYXRlIGEgYmFzZSBjbGFzcyB3aXRoIGEgbWV0YWNsYXNzLiIiIgogICAgIyBUaGlzIHJlcXVpcmVzIGEgYml0IG9mIGV4cGxhbmF0aW9uOiB0aGUgYmFzaWMgaWRlYSBpcyB0byBtYWtlIGEgZHVtbXkKICAgICMgbWV0YWNsYXNzIGZvciBvbmUgbGV2ZWwgb2YgY2xhc3MgaW5zdGFudGlhdGlvbiB0aGF0IHJlcGxhY2VzIGl0c2VsZiB3aXRoCiAgICAjIHRoZSBhY3R1YWwgbWV0YWNsYXNzLgogICAgY2xhc3MgbWV0YWNsYXNzKG1ldGEpOgoKICAgICAgICBkZWYgX19uZXdfXyhjbHMsIG5hbWUsIHRoaXNfYmFzZXMsIGQpOgogICAgICAgICAgICByZXR1cm4gbWV0YShuYW1lLCBiYXNlcywgZCkKICAgIHJldHVybiB0eXBlLl9fbmV3X18obWV0YWNsYXNzLCAndGVtcG9yYXJ5X2NsYXNzJywgKCksIHt9KQoKCmRlZiBhZGRfbWV0YWNsYXNzKG1ldGFjbGFzcyk6CiAgICAiIiJDbGFzcyBkZWNvcmF0b3IgZm9yIGNyZWF0aW5nIGEgY2xhc3Mgd2l0aCBhIG1ldGFjbGFzcy4iIiIKICAgIGRlZiB3cmFwcGVyKGNscyk6CiAgICAgICAgb3JpZ192YXJzID0gY2xzLl9fZGljdF9fLmNvcHkoKQogICAgICAgIHNsb3RzID0gb3JpZ192YXJzLmdldCgnX19zbG90c19fJykKICAgICAgICBpZiBzbG90cyBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzbG90cywgc3RyKToKICAgICAgICAgICAgICAgIHNsb3RzID0gW3Nsb3RzXQogICAgICAgICAgICBmb3Igc2xvdHNfdmFyIGluIHNsb3RzOgogICAgICAgICAgICAgICAgb3JpZ192YXJzLnBvcChzbG90c192YXIpCiAgICAgICAgb3JpZ192YXJzLnBvcCgnX19kaWN0X18nLCBOb25lKQogICAgICAgIG9yaWdfdmFycy5wb3AoJ19fd2Vha3JlZl9fJywgTm9uZSkKICAgICAgICByZXR1cm4gbWV0YWNsYXNzKGNscy5fX25hbWVfXywgY2xzLl9fYmFzZXNfXywgb3JpZ192YXJzKQogICAgcmV0dXJuIHdyYXBwZXIKCgpkZWYgcHl0aG9uXzJfdW5pY29kZV9jb21wYXRpYmxlKGtsYXNzKToKICAgICIiIgogICAgQSBkZWNvcmF0b3IgdGhhdCBkZWZpbmVzIF9fdW5pY29kZV9fIGFuZCBfX3N0cl9fIG1ldGhvZHMgdW5kZXIgUHl0aG9uIDIuCiAgICBVbmRlciBQeXRob24gMyBpdCBkb2VzIG5vdGhpbmcuCgogICAgVG8gc3VwcG9ydCBQeXRob24gMiBhbmQgMyB3aXRoIGEgc2luZ2xlIGNvZGUgYmFzZSwgZGVmaW5lIGEgX19zdHJfXyBtZXRob2QKICAgIHJldHVybmluZyB0ZXh0IGFuZCBhcHBseSB0aGlzIGRlY29yYXRvciB0byB0aGUgY2xhc3MuCiAgICAiIiIKICAgIGlmIFBZMjoKICAgICAgICBpZiAnX19zdHJfXycgbm90IGluIGtsYXNzLl9fZGljdF9fOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJAcHl0aG9uXzJfdW5pY29kZV9jb21wYXRpYmxlIGNhbm5vdCBiZSBhcHBsaWVkICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidG8gJXMgYmVjYXVzZSBpdCBkb2Vzbid0IGRlZmluZSBfX3N0cl9fKCkuIiAlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2xhc3MuX19uYW1lX18pCiAgICAgICAga2xhc3MuX191bmljb2RlX18gPSBrbGFzcy5fX3N0cl9fCiAgICAgICAga2xhc3MuX19zdHJfXyA9IGxhbWJkYSBzZWxmOiBzZWxmLl9fdW5pY29kZV9fKCkuZW5jb2RlKCd1dGYtOCcpCiAgICByZXR1cm4ga2xhc3MKCgojIENvbXBsZXRlIHRoZSBtb3ZlcyBpbXBsZW1lbnRhdGlvbi4KIyBUaGlzIGNvZGUgaXMgYXQgdGhlIGVuZCBvZiB0aGlzIG1vZHVsZSB0byBzcGVlZCB1cCBtb2R1bGUgbG9hZGluZy4KIyBUdXJuIHRoaXMgbW9kdWxlIGludG8gYSBwYWNrYWdlLgpfX3BhdGhfXyA9IFtdICAjIHJlcXVpcmVkIGZvciBQRVAgMzAyIGFuZCBQRVAgNDUxCl9fcGFja2FnZV9fID0gX19uYW1lX18gICMgc2VlIFBFUCAzNjYgQFJlc2VydmVkQXNzaWdubWVudAppZiBnbG9iYWxzKCkuZ2V0KCJfX3NwZWNfXyIpIGlzIG5vdCBOb25lOgogICAgX19zcGVjX18uc3VibW9kdWxlX3NlYXJjaF9sb2NhdGlvbnMgPSBbXSAgIyBQRVAgNDUxIEBVbmRlZmluZWRWYXJpYWJsZQojIFJlbW92ZSBvdGhlciBzaXggbWV0YSBwYXRoIGltcG9ydGVycywgc2luY2UgdGhleSBjYXVzZSBwcm9ibGVtcy4gVGhpcyBjYW4KIyBoYXBwZW4gaWYgc2l4IGlzIHJlbW92ZWQgZnJvbSBzeXMubW9kdWxlcyBhbmQgdGhlbiByZWxvYWRlZC4gKFNldHVwdG9vbHMgZG9lcwojIHRoaXMgZm9yIHNvbWUgcmVhc29uLikKaWYgc3lzLm1ldGFfcGF0aDoKICAgIGZvciBpLCBpbXBvcnRlciBpbiBlbnVtZXJhdGUoc3lzLm1ldGFfcGF0aCk6CiAgICAgICAgIyBIZXJlJ3Mgc29tZSByZWFsIG5hc3RpbmVzczogQW5vdGhlciAiaW5zdGFuY2UiIG9mIHRoZSBzaXggbW9kdWxlIG1pZ2h0CiAgICAgICAgIyBiZSBmbG9hdGluZyBhcm91bmQuIFRoZXJlZm9yZSwgd2UgY2FuJ3QgdXNlIGlzaW5zdGFuY2UoKSB0byBjaGVjayBmb3IKICAgICAgICAjIHRoZSBzaXggbWV0YSBwYXRoIGltcG9ydGVyLCBzaW5jZSB0aGUgb3RoZXIgc2l4IGluc3RhbmNlIHdpbGwgaGF2ZQogICAgICAgICMgaW5zZXJ0ZWQgYW4gaW1wb3J0ZXIgd2l0aCBkaWZmZXJlbnQgY2xhc3MuCiAgICAgICAgaWYgKHR5cGUoaW1wb3J0ZXIpLl9fbmFtZV9fID09ICJfU2l4TWV0YVBhdGhJbXBvcnRlciIgYW5kCiAgICAgICAgICAgICAgICBpbXBvcnRlci5uYW1lID09IF9fbmFtZV9fKToKICAgICAgICAgICAgZGVsIHN5cy5tZXRhX3BhdGhbaV0KICAgICAgICAgICAgYnJlYWsKICAgIGRlbCBpLCBpbXBvcnRlcgojIEZpbmFsbHksIGFkZCB0aGUgaW1wb3J0ZXIgdG8gdGhlIG1ldGEgcGF0aCBpbXBvcnQgaG9vay4Kc3lzLm1ldGFfcGF0aC5hcHBlbmQoX2ltcG9ydGVyKQpQSwECFAMUAAAAAAABvCtLj6fxUncAAAB3AAAAEwAAAAAAAAAAAAAAgAEAAAAAYW5zaWJsZS9fX2luaXRfXy5weVBLAQIUAxQAAAAAAAG8K0udxfFrSAAAAEgAAAAgAAAAAAAAAAAAAACAAagAAABhbnNpYmxlL21vZHVsZV91dGlscy9fX2luaXRfXy5weVBLAQIUAxQAAAAAAAG8K0uGZxDvZeoAAGXqAAAeAAAAAAAAAAAAAACAAS4BAABhbnNpYmxlX21vZHVsZV92bXdhcmVfZ3Vlc3QucHlQSwECFAMUAAAAAAABvCtLO985lTCKAQAwigEAHQAAAAAAAAAAAAAAgAHP6wAAYW5zaWJsZS9tb2R1bGVfdXRpbHMvYmFzaWMucHlQSwECFAMUAAAAAAABvCtLJdy0fhMQAAATEAAAIgAAAAAAAAAAAAAAgAE6dgIAYW5zaWJsZS9tb2R1bGVfdXRpbHMvcHljb21wYXQyNC5weVBLAQIUAxQAAAAAAAG8K0tdhrVvO60AADutAAAcAAAAAAAAAAAAAACAAY2GAgBhbnNpYmxlL21vZHVsZV91dGlscy91cmxzLnB5UEsBAhQDFAAAAAAAAbwrSxgXcvUBEQAAAREAACQAAAAAAAAAAAAAAIABAjQDAGFuc2libGUvbW9kdWxlX3V0aWxzL3NpeC9fX2luaXRfXy5weVBLAQIUAxQAAAAAAAG8K0vweDjF9kEAAPZBAAAeAAAAAAAAAAAAAACAAUVFAwBhbnNpYmxlL21vZHVsZV91dGlscy92bXdhcmUucHlQSwECFAMUAAAAAAABvCtLtdgEBiUwAAAlMAAAHQAAAAAAAAAAAAAAgAF3hwMAYW5zaWJsZS9tb2R1bGVfdXRpbHMvX3RleHQucHlQSwECFAMUAAAAAAABvCtLOOLH0ZF1AACRdQAAIAAAAAAAAAAAAAAAgAHXtwMAYW5zaWJsZS9tb2R1bGVfdXRpbHMvc2l4L19zaXgucHlQSwUGAAAAAAoACgD3AgAApi0EAAAA"""
def invoke_module(module, modlib_path, json_params):
    pythonpath = os.environ.get('PYTHONPATH')
    if pythonpath:
        os.environ['PYTHONPATH'] = ':'.join((modlib_path, pythonpath))
    else:
        os.environ['PYTHONPATH'] = modlib_path
    p = subprocess.Popen(['/usr/bin/python', module], env=os.environ, shell=False, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
    (stdout, stderr) = p.communicate(json_params)
    if not isinstance(stderr, (bytes, unicode)):
        stderr = stderr.read()
    if not isinstance(stdout, (bytes, unicode)):
        stdout = stdout.read()
    if PY3:
        sys.stderr.buffer.write(stderr)
        sys.stdout.buffer.write(stdout)
    else:
        sys.stderr.write(stderr)
        sys.stdout.write(stdout)
    return p.returncode
def debug(command, zipped_mod, json_params):
    basedir = os.path.join(os.path.abspath(os.path.dirname(__file__)), 'debug_dir')
    args_path = os.path.join(basedir, 'args')
    script_path = os.path.join(basedir, 'ansible_module_vmware_guest.py')
    if command == 'explode':
        z = zipfile.ZipFile(zipped_mod)
        for filename in z.namelist():
            if filename.startswith('/'):
                raise Exception('Something wrong with this module zip file: should not contain absolute paths')
            dest_filename = os.path.join(basedir, filename)
            if dest_filename.endswith(os.path.sep) and not os.path.exists(dest_filename):
                os.makedirs(dest_filename)
            else:
                directory = os.path.dirname(dest_filename)
                if not os.path.exists(directory):
                    os.makedirs(directory)
                f = open(dest_filename, 'wb')
                f.write(z.read(filename))
                f.close()
        f = open(args_path, 'wb')
        f.write(json_params)
        f.close()
        print('Module expanded into:')
        print('%s' % basedir)
        exitcode = 0
    elif command == 'execute':
        pythonpath = os.environ.get('PYTHONPATH')
        if pythonpath:
            os.environ['PYTHONPATH'] = ':'.join((basedir, pythonpath))
        else:
            os.environ['PYTHONPATH'] = basedir
        p = subprocess.Popen(['/usr/bin/python', script_path, args_path],
                env=os.environ, shell=False, stdout=subprocess.PIPE,
                stderr=subprocess.PIPE, stdin=subprocess.PIPE)
        (stdout, stderr) = p.communicate()
        if not isinstance(stderr, (bytes, unicode)):
            stderr = stderr.read()
        if not isinstance(stdout, (bytes, unicode)):
            stdout = stdout.read()
        if PY3:
            sys.stderr.buffer.write(stderr)
            sys.stdout.buffer.write(stdout)
        else:
            sys.stderr.write(stderr)
            sys.stdout.write(stdout)
        return p.returncode
    elif command == 'excommunicate':
        sys.argv = ['vmware_guest', args_path]
        sys.path.insert(0, basedir)
        from ansible_module_vmware_guest import main
        main()
        print('WARNING: Module returned to wrapper instead of exiting')
        sys.exit(1)
    else:
        print('WARNING: Unknown debug command.  Doing nothing.')
        exitcode = 0
    return exitcode
if __name__ == '__main__':
    ANSIBALLZ_PARAMS = json.dumps({"ANSIBLE_MODULE_ARGS": json.load(sys.stdin)})
    if PY3:
        ANSIBALLZ_PARAMS = ANSIBALLZ_PARAMS.encode('utf-8')
    try:
        temp_path = tempfile.mkdtemp(prefix='ansible_')
        zipped_mod = os.path.join(temp_path, 'ansible_modlib.zip')
        modlib = open(zipped_mod, 'wb')
        modlib.write(base64.b64decode(ZIPDATA))
        modlib.close()
        if len(sys.argv) == 2:
            exitcode = debug(sys.argv[1], zipped_mod, ANSIBALLZ_PARAMS)
        else:
            z = zipfile.ZipFile(zipped_mod, mode='r')
            module = os.path.join(temp_path, 'ansible_module_vmware_guest.py')
            f = open(module, 'wb')
            f.write(z.read('ansible_module_vmware_guest.py'))
            f.close()
            z = zipfile.ZipFile(zipped_mod, mode='a')
            sitecustomize = u'import sys\nsys.path.insert(0,"%s")\n' %  zipped_mod
            sitecustomize = sitecustomize.encode('utf-8')
            zinfo = zipfile.ZipInfo()
            zinfo.filename = 'sitecustomize.py'
            zinfo.date_time = ( 2017, 9, 11, 23, 32, 3)
            z.writestr(zinfo, sitecustomize)
            z.close()
            exitcode = invoke_module(module, zipped_mod, ANSIBALLZ_PARAMS)
    finally:
        try:
            shutil.rmtree(temp_path)
        except OSError:
            pass
    sys.exit(exitcode)